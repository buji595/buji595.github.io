<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>不羁</title>
  
  <subtitle>别来无恙</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://leeyj.coding.me/"/>
  <updated>2019-07-10T02:04:51.918Z</updated>
  <id>https://leeyj.coding.me/</id>
  
  <author>
    <name>Leeyj</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ELK快速入门(一)-基本部署</title>
    <link href="https://leeyj.coding.me/2019/07/05/ELK%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8(%E4%B8%80)-%E5%9F%BA%E6%9C%AC%E9%83%A8%E7%BD%B2/"/>
    <id>https://leeyj.coding.me/2019/07/05/ELK快速入门(一)-基本部署/</id>
    <published>2019-07-05T04:25:22.000Z</published>
    <updated>2019-07-10T02:04:51.918Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ELK简介"><a href="#ELK简介" class="headerlink" title="ELK简介"></a>ELK简介</h2><blockquote><p>什么是ELK？通俗来讲，ELK是由Elasticsearch、Logstash、Kibana 三个开源软件组成的一个组合体，这三个软件当中，每个软件用于完成不同的功能，ELK又称ELKstack，官网 <a href="https://www.elastic.co/" target="_blank" rel="noopener">https://www.elastic.co/</a> ， ELK主要优点有如下几个：<br>1、处理方式灵活：elasticsearch是实时全文索引，具有强大的搜索功能<br>2、配置相对简单：elasticsearch全部使用JSON接口，logstash使用模块配置，kibana的配置文件部分更简单<br>3、检索性能高：基于优秀的设计，虽然每次查询都是实时，但是也可以达到百亿级数据的查询秒级响应<br>4、集群线性扩展：elasticsearch和logstash都可以灵活线性扩展<br>5、前端操作绚丽：kibana的前端设计比较绚丽，而且操作简单</p></blockquote><h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><blockquote><p><code>elasticsearch</code>是一个高度可扩展全文搜索和分析引擎，基于<code>Apache Lucene</code> 构建，能对大容量的数据进行接近实时的存储、搜索和分析操作，可以处理大规模日志数据，比如<code>Nginx</code>、<code>Tomcat</code>、系统日志等功能。</p></blockquote><h3 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h3><blockquote><p>数据收集引擎。它支持动态的从各种数据源搜集数据，并对数据进行过滤、分析、丰富、统一格式等操作，然后存储到用户指定的位置；支持普通<code>log</code>、自定义<code>json</code>格式的日志解析。</p></blockquote><h3 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h3><blockquote><p>数据分析和可视化平台。通常与 <code>Elasticsearch</code> 配合使用，对其中数据进行搜索、分析和以统计图表的方式展示。</p></blockquote><h2 id="ELK部署环境准备"><a href="#ELK部署环境准备" class="headerlink" title="ELK部署环境准备"></a>ELK部署环境准备</h2><blockquote><p>这里实验所使用系统<code>CentOS 7.4 x86_64</code>，服务器信息如下。并关闭防火墙和<code>selinux</code>，及<code>host</code>绑定等。本文所使用所有的软件包 <a href="https://pan.baidu.com/s/1ighWPeYVqK6AGZQn55Y_pw" target="_blank" rel="noopener">下载</a>  提取码：<code>ow1b</code></p></blockquote><table><thead><tr><th>IPAddr</th><th>HostName</th><th>Mem  </th></tr></thead><tbody><tr><td>192.168.1.31</td><td>linux-elk1.exmaple.com</td><td>3G   </td></tr><tr><td>192.168.1.32</td><td>linux-elk2.exmaple.com</td><td>3G   </td></tr></tbody></table><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">epel源配置</span><br><span class="line"># wget -O <span class="regexp">/etc/yum</span>.repos.d<span class="regexp">/epel.repo http:/</span><span class="regexp">/mirrors.aliyun.com/</span>repo<span class="regexp">/epel-7.repo</span></span><br></pre></td></tr></table></figure><h2 id="Elasticsearch部署"><a href="#Elasticsearch部署" class="headerlink" title="Elasticsearch部署"></a>Elasticsearch部署</h2><blockquote><p>因为<code>elasticsearch</code>服务运行需要<code>java</code>环境，因此两台<code>elasticsearch</code>服务器需要安装<code>java</code>环境。</p></blockquote><h3 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h3><blockquote><p><code>centos7</code>默认是安装了<code>jdk</code>，如果需要安装高版本可以使用一下步骤，这里使用下面的yum安装<code>jdk 1.8.0_211</code> 。注意：两个节点都要安装。</p></blockquote><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">方法一：yum安装下载好的JDK包，将下载好的软件包上传到服务器进行安装，首先卸载自带的jdk；再进行安装。</span><br><span class="line">下载地址：https:<span class="regexp">//pan</span>.baidu.com/<span class="keyword">s</span>/<span class="number">1</span>VK1iCnvouppZ06jsVBOaRw  提取码：lofc</span><br><span class="line"></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># rpm -qa |grep jdk |xargs yum -y remove &#123;&#125;\;</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># yum -y localinstall jdk-8u211-linux-x64.rpm</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># java -version</span></span><br><span class="line">java version <span class="string">"1.8.0_211"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build <span class="number">1.8</span>.<span class="number">0_211</span>-b12)</span><br><span class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">25.211</span>-b12, mixed mode)</span><br><span class="line"></span><br><span class="line">方法二：源码安装JDK，将下载的软件包上传到服务器进行安装。</span><br><span class="line">下载地址：https:<span class="regexp">//pan</span>.baidu.com/<span class="keyword">s</span>/<span class="number">1</span>AAPyPzhdclNNCb0m6ooVYQ  提取码：x18u</span><br><span class="line"></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># ln -s /usr/local/jdk1.8.0_211 /usr/local/java</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># sed -i.ori '$a export JAVA_HOME=/usr/local/java \nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># source /etc/profile</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># java -version</span></span><br><span class="line">java version <span class="string">"1.8.0_211"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build <span class="number">1.8</span>.<span class="number">0_211</span>-b12)</span><br><span class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">25.211</span>-b12, mixed mode)</span><br></pre></td></tr></table></figure><h3 id="安装Elasticsearch"><a href="#安装Elasticsearch" class="headerlink" title="安装Elasticsearch"></a>安装Elasticsearch</h3><blockquote><p>两台节点都需要安装elasticsearch，使用yum安装会很慢，所以先下载下来传到服务器进行安装，官网下载地址：<a href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases#elasticsearch</a><br>本文所使用的包下载：<a href="https://pan.baidu.com/s/1djYOs3PQjtq16VkPMETAWg" target="_blank" rel="noopener">https://pan.baidu.com/s/1djYOs3PQjtq16VkPMETAWg</a>  提取码：b15v</p></blockquote><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">将下载的elasticsearch包上传到服务器进行安装。</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># yum -y localinstall elasticsearch-6.8.1.rpm</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># yum -y localinstall elasticsearch-6.8.1.rpm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置elasticsearch，linux-elk2配置一个相同的节点，通过组播进行通信，如果无法通过组播查询，修改成单播即可。</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># vim /etc/elasticsearch/elasticsearch.yml</span></span><br><span class="line"><span class="symbol">cluster.name:</span> ELK-Cluster    <span class="comment">#ELK的集群名称，名称相同即属于是同一个集群</span></span><br><span class="line"><span class="symbol">node.name:</span> elk-node1    <span class="comment">#本机在集群内的节点名称</span></span><br><span class="line"><span class="symbol">path.data:</span> /elk/data    <span class="comment">#数据存放目录</span></span><br><span class="line"><span class="symbol">path.logs:</span> /elk/logs    <span class="comment">#日志保存目录</span></span><br><span class="line"><span class="symbol">bootstrap.memory_lock:</span> <span class="keyword">true</span>    <span class="comment">#服务启动的时候锁定足够的内存，防止数据写入swap</span></span><br><span class="line"><span class="symbol">network.host:</span> <span class="number">192.168</span>.<span class="number">1.31</span>    <span class="comment">#监听的IP地址</span></span><br><span class="line"><span class="symbol">http.port:</span> <span class="number">9200</span>    <span class="comment">#服务监听的端口</span></span><br><span class="line"><span class="symbol">discovery.zen.ping.unicast.hosts:</span> [<span class="string">"192.168.1.31"</span>, <span class="string">"192.168.1.32"</span>]    <span class="comment">#单播配置一台即可</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改内存限制，内存锁定需要进行配置需要<span class="number">2</span>g以上内存，否则会导致无法启动elasticsearch。</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># vim /usr/lib/systemd/system/elasticsearch.service</span></span><br><span class="line"><span class="comment"># 在[Service]下加入下面这行内容</span></span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># vim /etc/elasticsearch/jvm.options</span></span><br><span class="line">-Xms2g</span><br><span class="line">-Xmx2g     <span class="comment">#最小和最大内存限制，为什么最小和最大设置一样大？参考：https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建数据目录和日志目录及权限修改</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># mkdir -p /elk/&#123;data,logs&#125;</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># chown elasticsearch.elasticsearch /elk/ -R</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动elasticsearch及检查端口是否处于监听状态</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># systemctl start elasticsearch</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># netstat -nltup |grep java</span></span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span>.<span class="number">1.31</span><span class="symbol">:</span><span class="number">9200</span>       ::<span class="symbol">:*</span>                    LISTEN      <span class="number">12887</span>/java          </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span>.<span class="number">1.31</span><span class="symbol">:</span><span class="number">9300</span>       ::<span class="symbol">:*</span>                    LISTEN      <span class="number">12887</span>/java</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">将配置文件copy到linux-elk2上面并进行修改，配置启动等。</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># scp /etc/elasticsearch/elasticsearch.yml 192.168.1.32:/etc/elasticsearch/elasticsearch.yml</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># grep ^[a-Z] /etc/elasticsearch/elasticsearch.yml </span></span><br><span class="line"><span class="symbol">cluster.name:</span> ELK-Cluster</span><br><span class="line"><span class="symbol">node.name:</span> elk-node2</span><br><span class="line"><span class="symbol">path.data:</span> /elk/data</span><br><span class="line"><span class="symbol">path.logs:</span> /elk/logs</span><br><span class="line"><span class="symbol">bootstrap.memory_lock:</span> <span class="keyword">true</span></span><br><span class="line"><span class="symbol">network.host:</span> <span class="number">192.168</span>.<span class="number">1.32</span></span><br><span class="line"><span class="symbol">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="symbol">discovery.zen.ping.unicast.hosts:</span> [<span class="string">"192.168.1.31"</span>, <span class="string">"192.168.1.32"</span>]</span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># vim /usr/lib/systemd/system/elasticsearch.service</span></span><br><span class="line"><span class="comment"># 在[Service]下加入下面这行内容</span></span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># vim /etc/elasticsearch/jvm.options</span></span><br><span class="line">-Xms2g</span><br><span class="line">-Xmx2g</span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># mkdir -p /elk/&#123;data,logs&#125;</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># chown elasticsearch.elasticsearch /elk/ -R</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># systemctl start elasticsearch</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment">#  netstat -nltup |grep java</span></span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span>.<span class="number">1.32</span><span class="symbol">:</span><span class="number">9200</span>       ::<span class="symbol">:*</span>                    LISTEN      <span class="number">18667</span>/java          </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span>.<span class="number">1.32</span><span class="symbol">:</span><span class="number">9300</span>       ::<span class="symbol">:*</span>                    LISTEN      <span class="number">18667</span>/java</span><br></pre></td></tr></table></figure><p>通过浏览器访问<code>elasticsearch</code>端口<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk01.png">-基本部署/elk01.png)<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk02.png">-基本部署/elk02.png)</p><h4 id="监控elasticsearch集群状态"><a href="#监控elasticsearch集群状态" class="headerlink" title="监控elasticsearch集群状态"></a>监控elasticsearch集群状态</h4><blockquote><p>通过shell命令获取集群状态，这里获取到的是一个json格式的返回值，例如对status进行分析，如果等于green(绿色)就是运行在正常，等于yellow(黄色)表示副本分片丢失，red(红色)表示主分片丢失。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="meta"># curl http:<span class="comment">//192.168.1.31:9200/_cluster/health?pretty=true</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"ELK-Cluster"</span>,</span><br><span class="line">  <span class="string">"status"</span> : <span class="string">"green"</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">"active_primary_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"active_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"relocating_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"initializing_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"unassigned_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"delayed_unassigned_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"number_of_pending_tasks"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"number_of_in_flight_fetch"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"active_shards_percent_as_number"</span> : <span class="number">100.0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@linux-elk1 ~]<span class="meta"># curl http:<span class="comment">//192.168.1.32:9200/_cluster/health?pretty=true</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"ELK-Cluster"</span>,</span><br><span class="line">  <span class="string">"status"</span> : <span class="string">"green"</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">"active_primary_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"active_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"relocating_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"initializing_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"unassigned_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"delayed_unassigned_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"number_of_pending_tasks"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"number_of_in_flight_fetch"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"active_shards_percent_as_number"</span> : <span class="number">100.0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="安装elasticsearch插件head"><a href="#安装elasticsearch插件head" class="headerlink" title="安装elasticsearch插件head"></a>安装elasticsearch插件head</h4><blockquote><p>我们不可能经常通过命令来查看集群的信息，所以就使用到了插件 –<code>head</code>。件是为了完成不同的功能，官方提供了一些插件但大部分是收费的，另外也有一些开发爱好者提供的插件，可以实现对<code>elasticsearch</code>集群的状态监控与管理配置等功能。<br>head：主要用来做集群管理的插件<br>下载地址：<a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="noopener">https://github.com/mobz/elasticsearch-head</a></p></blockquote><p>1）安装<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装npm和git</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># yum -y install npm git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装elasticsearch-head插件</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">[root@linux-elk1 src]<span class="comment"># git clone git://github.com/mobz/elasticsearch-head.git</span></span><br><span class="line">[root@linux-elk1 src]<span class="comment"># cd elasticsearch-head/</span></span><br><span class="line">[root@linux-elk1 elasticsearch-head]<span class="comment"># npm install grunt -save --registry=https://registry.npm.taobao.org</span></span><br><span class="line">[root@linux-elk1 elasticsearch-head]<span class="comment"># ll node_modules/grunt    #确定该目录有生成文件</span></span><br><span class="line">总用量 <span class="number">24</span></span><br><span class="line">drwxr-xr-x. <span class="number">2</span> root root   <span class="number">19</span> <span class="number">4</span>月   <span class="number">6</span> <span class="number">2016</span> bin</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">7111</span> <span class="number">4</span>月   <span class="number">6</span> <span class="number">2016</span> CHANGELOG</span><br><span class="line">drwxr-xr-x. <span class="number">4</span> root root   <span class="number">47</span> <span class="number">7</span>月   <span class="number">4</span> 09:<span class="number">21</span> lib</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">1592</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2016</span> LICENSE</span><br><span class="line">drwxr-xr-x. <span class="number">5</span> root root   <span class="number">50</span> <span class="number">7</span>月   <span class="number">4</span> 09:<span class="number">21</span> node_modules</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">4108</span> <span class="number">7</span>月   <span class="number">4</span> 09:<span class="number">21</span> package.json</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root  <span class="number">878</span> <span class="number">2</span>月  <span class="number">12</span> <span class="number">2016</span> README.md</span><br><span class="line">[root@linux-elk1 elasticsearch-head]<span class="comment"># npm install --registry=https://registry.npm.taobao.org    #执行安装</span></span><br><span class="line">[root@linux-elk1 elasticsearch-head]<span class="comment"># npm run start &amp;    #后台启动服务</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># ss -nlt |grep 9100</span></span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>          *:<span class="number">9100</span>                     *:* </span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------补充说明------------------------</span></span><br><span class="line">由于上面npm安装时候超级慢，使用taobao源同样慢，这里将已安装的打成了包，可以直接下载使用即可</span><br><span class="line">下载地址：https:<span class="regexp">//pan</span>.baidu.com/<span class="keyword">s</span>/<span class="number">16</span>zDlecKVfmkEeInPcRx9NQ   提取码：h89<span class="number">0</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># yum -y install npm</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">[root@linux-elk1 src]<span class="comment"># ls</span></span><br><span class="line">elasticsearch-head.tar.gz</span><br><span class="line">[root@linux-elk1 src]<span class="comment"># tar xvzf elasticsearch-head.tar.gz</span></span><br><span class="line">[root@linux-elk1 src]<span class="comment"># cd elasticsearch-head/</span></span><br><span class="line">[root@linux-elk1 elasticsearch-head]<span class="comment"># npm run start &amp;</span></span><br><span class="line"><span class="comment">#--------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改elasticsearch服务配置文件，开启跨域访问支持，然后重启elasticsearch服务</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># vim /etc/elasticsearch/elasticsearch.yml</span></span><br><span class="line">http.cors.enabled: true     <span class="comment">#最下方添加</span></span><br><span class="line">http.cors.allow-origin: <span class="string">"*"</span></span><br></pre></td></tr></table></figure></p><p>为了方便管理<code>elasticsearch-head</code>插件，编写一个启动脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># vim /usr/bin/elasticsearch-head</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#desc: elasticsearch-head service manager</span></span><br><span class="line"><span class="comment">#date: 2019</span></span><br><span class="line"></span><br><span class="line">data=<span class="string">"cd /usr/local/src/elasticsearch-head/; nohup npm run start &gt; /dev/null 2&gt;&amp;1 &amp; "</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">START</span></span> ()&#123;</span><br><span class="line">    <span class="built_in">eval</span> <span class="variable">$data</span> &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"elasticsearch-head start\033[32m     ok\033[0m"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">STOP</span></span> ()&#123;</span><br><span class="line">    ps -ef |grep grunt |grep -v <span class="string">"grep"</span> |awk <span class="string">'&#123;print $2&#125;'</span> |xargs <span class="built_in">kill</span> -s 9 &gt; /dev/null &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"elasticsearch-head stop\033[32m      ok\033[0m"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        START</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        STOP</span><br><span class="line">        ;;</span><br><span class="line">    restart)</span><br><span class="line">        STOP</span><br><span class="line">        sleep 3</span><br><span class="line">        START</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Usage: elasticsearch-head (start|stop|restart)"</span></span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># chmod +x /usr/bin/elasticsearch-head</span></span><br></pre></td></tr></table></figure></p><p>2）浏览器访问<code>9100端口</code>，将连接地址修改为<code>elasticsearch</code>地址。<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk03.png">-基本部署/elk03.png)<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk04.png">-基本部署/elk04.png)</p><p>3）测试提交数据<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk05.png">-基本部署/elk05.png)</p><p>4）验证索引是否存在<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk06.png">-基本部署/elk06.png)</p><p>5）查看数据<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk07.png">-基本部署/elk07.png)</p><p>6）Master和Slave的区别：</p><blockquote><p><code>Master</code>的职责：<br>统计各<code>node</code>节点状态信息、集群状态信息统计、索引的创建和删除、索引分配的管理、关闭<code>node</code>节点等<br><code>Savle</code>的职责：<br>同步数据、等待机会称为<code>Master</code></p></blockquote><h2 id="Logstash部署"><a href="#Logstash部署" class="headerlink" title="Logstash部署"></a>Logstash部署</h2><blockquote><p>Logstash 是一个开源的数据收集引擎，可以水平伸缩，而且logstash是整个ELK当中拥有最多插件的一个组件，其可以接收来自不同来源的数据并同意输出到指定的且可以是多个不同目的地。官网下载地址：<a href="https://www.elastic.co/cn/downloads/past-releases#logstash" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases#logstash</a></p></blockquote><h3 id="安装logstash"><a href="#安装logstash" class="headerlink" title="安装logstash"></a>安装logstash</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@linux</span>-elk1 ~]<span class="meta"># wget https://artifacts.elastic.co/downloads/logstash/logstash-6.8.1.rpm</span></span><br><span class="line">[root<span class="symbol">@linux</span>-elk1 ~]<span class="meta"># yum -y localinstall logstash-6.8.1.rpm</span></span><br></pre></td></tr></table></figure><h3 id="测试logstash是否正常"><a href="#测试logstash是否正常" class="headerlink" title="测试logstash是否正常"></a>测试logstash是否正常</h3><p>1）测试标准输入输出<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># /usr/share/logstash/bin/logstash -e 'input &#123; stdin &#123;&#125; &#125; output &#123; stdout &#123; codec =&gt; rubydebug&#125; &#125;'  </span></span><br><span class="line">hello world    <span class="comment">#输入</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,    <span class="comment">#事件版本号，一个事件就是一个ruby对象</span></span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2019</span><span class="number">-07</span><span class="number">-04</span>T04:<span class="number">30</span>:<span class="number">35.106</span>Z,    <span class="comment">#当前事件发生的事件</span></span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"linux-elk1.exmaple.com"</span>,    <span class="comment">#标记事件发生在哪里</span></span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"hello world"</span>    <span class="comment">#消息的具体内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2）测试输出到文件<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># /usr/share/logstash/bin/logstash   -e 'input &#123; stdin&#123;&#125; &#125; output &#123; file &#123; path =&gt; "/tmp/log-%&#123;+YYYY.MM.dd&#125;messages.gz"&#125;&#125;'</span></span><br><span class="line">hello world   <span class="comment">#输入</span></span><br><span class="line">[INFO ] <span class="number">2019</span>-<span class="number">07</span>-<span class="number">04</span> <span class="number">17</span><span class="symbol">:</span><span class="number">33</span><span class="symbol">:</span><span class="number">06</span>.<span class="number">065</span> [[main]&gt;worker<span class="number">0</span>] file - Opening file &#123;<span class="symbol">:path=&gt;<span class="string">"/tmp/log-2019.07.04messages.gz"</span></span>&#125;</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># tail /tmp/log-2019.07.04messages.gz </span></span><br><span class="line">&#123;<span class="string">"message"</span><span class="symbol">:<span class="string">"hello world"</span></span>,<span class="string">"@version"</span><span class="symbol">:<span class="string">"1"</span></span>,<span class="string">"host"</span><span class="symbol">:<span class="string">"linux-elk1.exmaple.com"</span></span>,<span class="string">"@timestamp"</span><span class="symbol">:<span class="string">"2019-07-04T09:33:05.698Z"</span></span>&#125;</span><br></pre></td></tr></table></figure></p><p>3）测试输出到elasticsearch<br><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash   -e <span class="symbol">'input</span> &#123;  stdin&#123;&#125; &#125; output &#123; elasticsearch &#123;hosts =&gt; [<span class="string">"192.168.1.31:9200"</span>] index =&gt; <span class="string">"mytest-%&#123;+YYYY.MM.dd&#125;"</span> &#125;&#125;<span class="string">'</span></span><br></pre></td></tr></table></figure></p><p>4）elasticsearch服务器验证收到数据<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># ll /elk/data/nodes/0/indices/</span></span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x.<span class="number"> 8 </span>elasticsearch elasticsearch<span class="number"> 65 </span>7月  <span class="number"> 4 </span>17:23 4jaihRq6Qu6NQWVxbuRQZg</span><br><span class="line">drwxr-xr-x.<span class="number"> 8 </span>elasticsearch elasticsearch<span class="number"> 65 </span>7月  <span class="number"> 4 </span>17:22 kkd_RCldSeaCX3y1XKzdgA</span><br></pre></td></tr></table></figure></p><p><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk08.png">-基本部署/elk08.png)</p><h2 id="kibana部署"><a href="#kibana部署" class="headerlink" title="kibana部署"></a>kibana部署</h2><blockquote><p><code>Kibana</code>是一个通过调用<code>elasticsearch</code>服务器进行图形化展示搜索结果的开源项目。官网下载地址：<a href="https://www.elastic.co/cn/downloads/past-releases#kibana" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases#kibana</a></p></blockquote><h3 id="安装kibana"><a href="#安装kibana" class="headerlink" title="安装kibana"></a>安装kibana</h3><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># wget https://artifacts.elastic.co/downloads/kibana/kibana-6.8.1-x86_64.rpm</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># yum -y localinstall kibana-6.8.1-x86_64.rpm</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># vim /etc/kibana/kibana.yml </span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># grep ^[a-Z] /etc/kibana/kibana.yml </span></span><br><span class="line">server.port: <span class="number">5601</span>    <span class="comment">#监听端口</span></span><br><span class="line">server.host: <span class="string">"192.168.1.31"</span>    <span class="comment">#监听地址</span></span><br><span class="line">elasticsearch.hosts: [<span class="string">"http://192.168.1.31:9200"</span>]    <span class="comment">#elasticsearch服务器地址</span></span><br><span class="line">i18n.locale: <span class="string">"zh-CN"</span>    <span class="comment">#修改为中文</span></span><br></pre></td></tr></table></figure><h3 id="启动kibana并验证"><a href="#启动kibana并验证" class="headerlink" title="启动kibana并验证"></a>启动kibana并验证</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># systemctl start kibana</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># systemctl enable kibana</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># ss -nlt  |grep 5601</span></span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>    <span class="number">192.168</span>.<span class="number">1.31</span><span class="symbol">:</span><span class="number">5601</span>                     *<span class="symbol">:*</span></span><br></pre></td></tr></table></figure><h3 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h3><p><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk09.png">-基本部署/elk09.png)</p><h2 id="通过logstash收集系统message日志"><a href="#通过logstash收集系统message日志" class="headerlink" title="通过logstash收集系统message日志"></a>通过logstash收集系统message日志</h2><blockquote><p>说明：通过<code>logstash</code>收集别的日志文件，前提需要<code>logstash</code>用户对被收集的日志文件有读的权限并对写入的文件有写的权限</p></blockquote><p>1）配置<code>logstash</code>配置文件<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># vim /etc/logstash/conf.d/system-log.conf</span></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        <span class="attr">path</span> =&gt; <span class="string">"/var/log/messages"</span>    <span class="comment">#日志路径</span></span><br><span class="line">        <span class="attr">type</span> =&gt; <span class="string">"systemlog"</span>            <span class="comment">#类型，自定义，在进行多个日志收集存储时可以通过该项进行判断输出</span></span><br><span class="line">        <span class="attr">start_position</span> =&gt; <span class="string">"beginning"</span>        <span class="comment">#logstash 从什么位置开始读取文件数据，默认是结束位置，也就是说 logstash 进程会以类似 tail -F 的形式运行。如果你是要导入原有数据，把这个设定改成 "beginning"，logstash 进程就从头开始读取，类似 less +F 的形式运行。</span></span><br><span class="line"><span class="attr">stat_interval</span> =&gt; <span class="string">"2"</span>    <span class="comment">#logstash 每隔多久检查一次被监听文件状态（是否有更新），默认是 1 秒</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        <span class="attr">hosts</span> =&gt; [<span class="string">"192.168.1.31:9200"</span>]        <span class="comment">#elasticsearch服务器地址</span></span><br><span class="line">        <span class="attr">index</span> =&gt; <span class="string">"logstash-%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;"</span>    <span class="comment">#索引名称</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2）检测配置文件语法是否有错误<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system-<span class="built_in">log</span>.conf -t    #检测配置文件是否有语法错误</span><br><span class="line">WARNING: Could <span class="keyword">not</span> <span class="built_in">find</span> logstash.yml which is typically located <span class="keyword">in</span> $LS_HOME/<span class="built_in">config</span> <span class="keyword">or</span> /etc/logstash. You can specify the <span class="built_in">path</span> using <span class="comment">--path.settings. Continuing using the defaults</span></span><br><span class="line">Could <span class="keyword">not</span> <span class="built_in">find</span> log4j2 configuration at <span class="built_in">path</span> /usr/share/logstash/<span class="built_in">config</span>/log4j2.properties. Using default <span class="built_in">config</span> which logs errors to the console</span><br><span class="line">[WARN ] <span class="number">2019</span><span class="number">-07</span><span class="number">-05</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">59.423</span> [LogStash::Runner] multilocal - Ignoring the <span class="string">'pipelines.yml'</span> file because modules <span class="keyword">or</span> command line options are specified</span><br><span class="line">Configuration OK</span><br><span class="line">[INFO ] <span class="number">2019</span><span class="number">-07</span><span class="number">-05</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">27.993</span> [LogStash::Runner] runner - Using <span class="built_in">config</span>.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br></pre></td></tr></table></figure></p><p>3）修改日志文件的权限并重启<code>logstash</code><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]# ll /<span class="keyword">var</span>/<span class="keyword">log</span>/messages     </span><br><span class="line">-rw-------. 1 root root 786219 7月   5 10:10 /<span class="keyword">var</span>/<span class="keyword">log</span>/messages</span><br><span class="line">#这里可以看到该日志文件是600权限，而elasticsearch是运行在elasticsearch用户下，这样elasticsearch是无法收集日志的。所以这里需要更改日志的权限，否则会报权限拒绝的错误。在日志中查看/<span class="keyword">var</span>/<span class="keyword">log</span>/logstash/logstash-plain.<span class="keyword">log</span> 是否有错误。</span><br><span class="line">[root@linux-elk1 ~]# chmod 644 /<span class="keyword">var</span>/<span class="keyword">log</span>/messages</span><br><span class="line">[root@linux-elk1 ~]# systemctl  restart logstash</span><br></pre></td></tr></table></figure></p><p>4）elasticsearch界面查看并查询<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk10.png">-基本部署/elk10.png)<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk11.png">-基本部署/elk11.png)<br>5）kibana界面创建索引并查看<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk12.png">-基本部署/elk12.png)<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk13.png">-基本部署/elk13.png)<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk14.png">-基本部署/elk14.png)<br><img src="/2019/07/05/ELK快速入门(一)-基本部署/ELK快速入门(一" alt="elk15.png">-基本部署/elk15.png)</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ELK简介&quot;&gt;&lt;a href=&quot;#ELK简介&quot; class=&quot;headerlink&quot; title=&quot;ELK简介&quot;&gt;&lt;/a&gt;ELK简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;什么是ELK？通俗来讲，ELK是由Elasticsearch、Logstash、Kiban
      
    
    </summary>
    
      <category term="ELK" scheme="https://leeyj.coding.me/categories/ELK/"/>
    
    
      <category term="ELK" scheme="https://leeyj.coding.me/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat+Nginx+Memcached综合案例</title>
    <link href="https://leeyj.coding.me/2019/06/27/Tomcat+Nginx+Memcached%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/"/>
    <id>https://leeyj.coding.me/2019/06/27/Tomcat+Nginx+Memcached综合案例/</id>
    <published>2019-06-27T09:36:22.000Z</published>
    <updated>2019-07-10T01:46:29.979Z</updated>
    
    <content type="html"><![CDATA[<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><blockquote><p>通过<code>Nginx</code>解析静态页面并将动态负载均衡调度给后面的多个<code>Tomcat</code>，<code>Tomcat</code>解析<code>java</code>动态程序。</p></blockquote><blockquote><p>由于http是无状态的协议，你访问了页面A，然后在访问B，http无法确定这2个访问来自一个人<br>，因此要用cookie或session来跟踪用户，根据授权和用户身份来显示不同的页面。<br>比如用户A登陆了，那么能看到自己的个人信息，而B没登陆，无法看到个人信息。<br>还有A可能在购物，把商品放入购物车，此时B也有这个过程，你无法确定A，B的身份和购物信息，所以需要一个session ID来维持这个过程。所以就用到了session管理。</p></blockquote><p><a href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration" target="_blank" rel="noopener">官网文档</a></p><h2 id="环境规划"><a href="#环境规划" class="headerlink" title="环境规划"></a>环境规划</h2><table><thead><tr><th>主机</th><th>hostname</th><th>环境</th><th></th></tr></thead><tbody><tr><td>192.168.1.31</td><td>nginx.cluster.com</td><td>nginx（yum安装）</td><td></td></tr><tr><td>192.168.1.32</td><td>tomcat1.cluster.com</td><td>tomcat-9.0</td><td></td></tr><tr><td>192.168.1.33</td><td>tomcat2.cluster.com</td><td>tomcat-9.0</td><td></td></tr><tr><td>192.168.1.34</td><td>memcached.cluster.com</td><td>memcached（yum安装）</td></tr></tbody></table><blockquote><p>关闭防火墙，selinux；时间同步；host绑定等基本配置 (步骤略)</p></blockquote><h2 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h2><p>本案例所使用的<code>tomcat</code>、<code>jdk</code>、和<code>tomcat-session</code>相关的jar包下载地址<br>链接：<a href="https://pan.baidu.com/s/1ESm_RSrFx77kWObmCt1DQw" target="_blank" rel="noopener">https://pan.baidu.com/s/1ESm_RSrFx77kWObmCt1DQw</a><br>提取码：f64n </p><h3 id="memcached部署"><a href="#memcached部署" class="headerlink" title="memcached部署"></a>memcached部署</h3><blockquote><p>说明：memcached这里不需要配置太多，安装即可，然后检查端口是否处于监听中。tomcat服务器能成功连接即可<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@memcached ~]# yum -y install memcached</span><br><span class="line">[root@memcached ~]# systemctl <span class="builtin-name">enable</span> memcached</span><br><span class="line">[root@memcached ~]# systemctl start memcached</span><br><span class="line"></span><br><span class="line">[root@memcached ~]# lsof -i:11211</span><br><span class="line">COMMAND    PID     <span class="built_in"> USER </span>  FD  <span class="built_in"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class="line">memcached 4419 memcached   26u  IPv4  51021      0t0  TCP *:memcache (LISTEN)</span><br><span class="line">memcached 4419 memcached   27u <span class="built_in"> IPv6 </span> 51022      0t0  TCP *:memcache (LISTEN)</span><br><span class="line">memcached 4419 memcached   28u  IPv4  51025      0t0  UDP *:memcache </span><br><span class="line">memcached 4419 memcached   29u <span class="built_in"> IPv6 </span> 51026      0t0  UDP *:memcache</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="nginx部署"><a href="#nginx部署" class="headerlink" title="nginx部署"></a>nginx部署</h3><p>1）安装nginx<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># yum -y install nginx</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># nginx -v</span></span><br><span class="line">nginx version: nginx/<span class="number">1.12</span><span class="number">.2</span></span><br></pre></td></tr></table></figure></p><p>2）配置文件配置<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个虚拟主机</span></span><br><span class="line">[root@nginx ~]<span class="comment"># vim /etc/nginx/conf.d/www.conf</span></span><br><span class="line">upstream <span class="keyword">tomcat</span> &#123;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">1.32</span>:<span class="number">8080</span> weight=<span class="number">1</span>;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">1.33</span>:<span class="number">8080</span> weight=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">    listen       <span class="number">88</span> default_server;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    <span class="literal">root</span>         /opt/<span class="literal">project</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#已jsp结尾的动态程序调度给tomcat去处理</span></span><br><span class="line">    location ~.*\.jsp$ &#123;</span><br><span class="line">        proxy_pass http://tomcat;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$remote_addr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">error_page</span> 404 /404.html;</span><br><span class="line">        location = /40x.<span class="keyword">html</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">error_page</span> 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.<span class="keyword">html</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建测试文件</span></span><br><span class="line">[root@nginx ~]<span class="comment"># mkdir /opt/project</span></span><br><span class="line">[root@nginx ~]<span class="comment"># echo "&lt;h1&gt;Nginx IP:192.168.1.31&lt;/h1&gt;" &gt;&gt; /opt/project/index.html</span></span><br></pre></td></tr></table></figure></p><h3 id="tomcat部署"><a href="#tomcat部署" class="headerlink" title="tomcat部署"></a>tomcat部署</h3><p>详细安装参考：<a href="https://www.cnblogs.com/yanjieli/p/11092350.html" target="_blank" rel="noopener">https://www.cnblogs.com/yanjieli/p/11092350.html</a><br><strong>两台tomcat服务器都要执行下面的所有操作，也可以在一台上面执行，然后copy过去。</strong><br>1）上传软件包到服务器，编写一个临时使用的安装脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat1 ~]<span class="comment"># cat install_tomcat.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#----安装java环境</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">InstallJava</span></span> ()&#123;</span><br><span class="line">    tar xf jdk-8u211-linux-x64.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line">    ln -s /usr/<span class="built_in">local</span>/jdk1.8.0_211 /usr/<span class="built_in">local</span>/java</span><br><span class="line">    sed -i.ori <span class="string">'$a export JAVA_HOME=/usr/local/java \nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar'</span> /etc/profile</span><br><span class="line">    <span class="built_in">source</span> /etc/profile</span><br><span class="line">    java -version</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#----安装tomcat环境</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">InstallTomcat</span></span> ()&#123;</span><br><span class="line">    tar xf apache-tomcat-9.0.21.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line">    ln -s /usr/<span class="built_in">local</span>/apache-tomcat-9.0.21 /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"export TOMCAT_HOME=/usr/local/tomcat"</span> &gt;&gt; /etc/profile</span><br><span class="line">    <span class="built_in">source</span> /etc/profile</span><br><span class="line">&#125;</span><br><span class="line">InstallJava</span><br><span class="line">InstallTomcat</span><br><span class="line"></span><br><span class="line">/usr/<span class="built_in">local</span>/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure></p><p>2）执行脚本<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat1 ~]# bash install_tomcat.sh </span><br><span class="line">java version <span class="string">"1.8.0_211"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_211-b12)</span><br><span class="line">Java HotSpot(TM) 64-Bit<span class="built_in"> Server </span>VM (build 25.211-b12, mixed mode)</span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/java</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line"></span><br><span class="line">[root@tomcat1 ~]# ss -nltp |grep :80</span><br><span class="line">LISTEN     0      100         :::8080                    :::*                   users:((<span class="string">"java"</span>,<span class="attribute">pid</span>=2993,fd=54))</span><br><span class="line">LISTEN     0      1         ::ffff:127.0.0.1:8005                    :::*                   users:((<span class="string">"java"</span>,<span class="attribute">pid</span>=2993,fd=74))</span><br><span class="line">LISTEN     0      100         :::8009                    :::*                   users:((<span class="string">"java"</span>,<span class="attribute">pid</span>=2993,fd=59))</span><br></pre></td></tr></table></figure></p><p>3）下载<code>memcached-session-manager</code>等相关软件包并<code>copy</code>到<code>tomcat</code>安装目录的<code>lib</code>目录中<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># mkdir tools &amp;&amp; cd tools</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget http://repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget https://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget https://repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget https://repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget https://repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget https://repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget http://repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@tomcat1</span> tools]<span class="meta"># cp ./* /usr/local/tomcat/lib/</span></span><br></pre></td></tr></table></figure></p><p>4）编辑配置文件，添加连接<code>memcached</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># No-Stick模式</span><br><span class="line">[root@tomcat1 ~]# vim /usr/local/tomcat/conf/context.xml</span><br><span class="line"># 在<span class="tag">&lt;<span class="name">Context</span>&gt;</span>和<span class="tag">&lt;/<span class="name">Context</span>&gt;</span>里面加上下面一段</span><br><span class="line"><span class="comment">&lt;!-- 这里的ip为memcached服务器的IP,如果有多个memcached服务器，用逗号隔开 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">memcachedNodes</span>=<span class="string">"n1:192.168.1.34:11211"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">lockingMode</span>=<span class="string">"auto"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">sticky</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">requestUriIgnorePattern</span>= <span class="string">".*\.(png|gif|jpg|css|js)$"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">sessionBackupAsync</span>= <span class="string">"false"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">sessionBackupTimeout</span>= <span class="string">"100"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">copyCollectionsForSerialization</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">transcoderFactoryClass</span>=<span class="string">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p><p>5）准备测试文件<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@tomcat1</span> ~]<span class="comment"># rm -rf /usr/local/tomcat/webapps/*</span></span><br><span class="line">[root<span class="meta">@tomcat1</span> ~]<span class="comment"># mkdir /usr/local/tomcat/webapps/ROOT</span></span><br><span class="line">[root<span class="meta">@tomcat1</span> ~]<span class="comment"># vim /usr/local/tomcat/webapps/ROOT/index.jsp</span></span><br><span class="line">SessionID:<span class="variable">&lt;%=session.getId()%&gt;</span> <span class="variable">&lt;BR&gt;</span></span><br><span class="line">SessionIP:<span class="variable">&lt;%=request.getServerName()%&gt;</span> <span class="variable">&lt;BR&gt;</span></span><br><span class="line">SessionPort:<span class="variable">&lt;%=request.getServerPort()%&gt;</span></span><br></pre></td></tr></table></figure></p><p>6）重启<code>tomcat</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat1 ~]# /usr/local/tomcat/bin/shutdown.sh</span><br><span class="line">[root@tomcat1 ~]# /usr/local/tomcat/bin/startup.sh</span><br><span class="line">[root@tomcat1 ~]# lsof -i:8080</span><br><span class="line">COMMAND  PID<span class="built_in"> USER </span>  FD  <span class="built_in"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class="line">java    4672 root   63u <span class="built_in"> IPv6 </span> 52084      0t0  TCP *:webcache (LISTEN)</span><br></pre></td></tr></table></figure></p><p>7）测试<br>访问tomcat1：<br><img src="/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat1.png" alt><br>访问tomcat2：<br><img src="/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat2.png" alt><br>访问nginx默认页面：<br><img src="/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat4.png" alt><br>访问jsp动态程序：<br><img src="/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat3.png" alt><br>通过上面的访问可以看出，访问静态页面时nginx自身处理，当访问jsp动态的时候会调度给tomcat去处理。并且当一个浏览器访问后，便会一直访问这一个，so，这样就达到了session会话保持。</p><hr><p><strong>补充</strong><br>memcached-session-manager 参数说明：<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">memcachedNodes 必选项，memcached的节点信息，多个memcached节点,中间需要使用空格</span><br><span class="line"></span><br><span class="line">failoverNodes=<span class="string">"n2"</span>  表示当前session保持到n1的memcached节点上</span><br><span class="line">failoverNodes  可选项，不能使用在non-sticky sessions模式。故障转移配置节点，多个使用空格或逗号分开，配置某个节点为备份节点，</span><br><span class="line">当其他节点都不可用时才会存储到备份节点，官方建议配置为和tomcat同服务器的节点。</span><br><span class="line"><span class="section">理由如下:</span></span><br><span class="line">假如有两台服务器m1,m2，其中m1部署tomcat和memcached节点n1，m2部署memcached节点n2。</span><br><span class="line">如果配置tomcat的failoverNodes值为n2或者不配置，则当服务器m1挂掉后n1和tomcat中保存的session会丢失，而n2中未保存或者只保存了部分session，</span><br><span class="line">这就造成 部分用户状态丢失。</span><br><span class="line">如果配置tomcat的failoverNodes值为n1，则当m1挂掉后因为n2中保存了所有的session，所以重启tomcat的时候用户状态不会丢失。</span><br><span class="line">为什么n2中保存了所有的session? 因为failoverNodes配置的值是n1，只有当n2节点不可用时才会把session存储到n1，所以这个时候n1中是没有保存任何session的。</span><br><span class="line">lockingMode  可选值，默认none，只对non-sticky有效。</span><br><span class="line">requestUriIgnorePattern  可选值，制定忽略那些请求的session操作，一般制定静态资源如css,js一类的。</span><br><span class="line">sessionBackupAsync    可选值，默认true，是否异步的方式存储到memcached。</span><br><span class="line">sessionBackupTimeout  可选项，默认100毫秒，异步存储session的超时时间。</span><br></pre></td></tr></table></figure></p><p>相关软件包jar包下载：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">memcached-session-manager 下载地址：<span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/msm/</span></span><br><span class="line"><span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar</span></span><br><span class="line"><span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar</span></span><br><span class="line"></span><br><span class="line">msm-kryo-serializer    下载地址：<span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/</span></span><br><span class="line"><span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar</span></span><br><span class="line"></span><br><span class="line">spymemcached    下载地址：<span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/net/spy/spymemcached/</span></span><br><span class="line"><span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar</span></span><br><span class="line"></span><br><span class="line">serializers    下载地址：<span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/kryo-serializers/</span></span><br><span class="line"><span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar</span></span><br><span class="line"></span><br><span class="line">reflectasm    下载地址：<span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/reflectasm</span></span><br><span class="line"><span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar</span></span><br><span class="line"></span><br><span class="line">minlog    下载地址：<span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/minlog</span></span><br><span class="line"><span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar</span></span><br><span class="line"></span><br><span class="line">kryo    下载地址：<span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/kryo</span></span><br><span class="line"><span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar</span></span><br><span class="line"></span><br><span class="line">asm    下载地址：<span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/org/ow2/asm/asm/</span></span><br><span class="line"><span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar     </span></span><br><span class="line"></span><br><span class="line">objenesis    下载地址：<span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/org/objenesis/objenesis/</span></span><br><span class="line"><span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;通过&lt;code&gt;Nginx&lt;/code&gt;解析静态页面并将动态负载均衡调度给后面的多个&lt;code&gt;Tomcat&lt;/c
      
    
    </summary>
    
      <category term="Tomcat" scheme="https://leeyj.coding.me/categories/Tomcat/"/>
    
    
      <category term="Tomcat" scheme="https://leeyj.coding.me/tags/Tomcat/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat安装与部署</title>
    <link href="https://leeyj.coding.me/2019/06/26/Tomcat%E5%AE%89%E8%A3%85%E4%B8%8E%E9%83%A8%E7%BD%B2/"/>
    <id>https://leeyj.coding.me/2019/06/26/Tomcat安装与部署/</id>
    <published>2019-06-26T09:36:22.000Z</published>
    <updated>2019-07-10T01:46:29.992Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Tomcat简介"><a href="#Tomcat简介" class="headerlink" title="Tomcat简介"></a>Tomcat简介</h2><p>官网：<a href="http://tomcat.apache.org/" target="_blank" rel="noopener">http://tomcat.apache.org/</a></p><blockquote><p><code>Tomcat</code>服务器是一个免费的开源代码的Web应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下使用，是开发和调试<code>JSP</code>程序的首选。<br><code>Tomcat</code>和<code>Nginx</code>、<code>Apache</code>等<code>Web</code>服务器一样，具有处理<code>HTML</code>页面的功能，另外它还是一个<code>Servlet</code>和<code>JSP</code>容器，独立的<code>Servlet</code>容器是<code>Tomcat</code>的默认模式。不过，<code>Tomcat</code>处理静态<code>HTML</code>的能力不如<code>Nginx/Apache</code>服务器。<br>一般情况下多用<code>Nginx+Tomcat</code>，<code>Nginx</code>处理静态，<code>Tomcat</code>处理动态程序</p></blockquote><h2 id="Tomcat安装"><a href="#Tomcat安装" class="headerlink" title="Tomcat安装"></a>Tomcat安装</h2><blockquote><p>软件下载：<a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">JDK下载</a>  &emsp; <a href="http://tomcat.apache.org/" target="_blank" rel="noopener">Tomcat下载</a><br>本文使用的软件包<code>jdk-8u211</code>,<code>tomcat-9.0.21</code>。 <a href="https://pan.baidu.com/s/1d0g0T75p-CW7uz3ug7I8YA" target="_blank" rel="noopener">下载链接</a> &emsp; 提取码：f0ay</p></blockquote><h3 id="部署Java环境"><a href="#部署Java环境" class="headerlink" title="部署Java环境"></a>部署Java环境</h3><p>将下载的软件包上传到服务器<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压软件包</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个软链接</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># ln -s /usr/local/jdk1.8.0_211 /usr/local/java</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加环境变量</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># sed -i.ori '$a export JAVA_HOME=/usr/local/java \nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载环境变量</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># source /etc/profile</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># env |grep JAVA</span></span><br><span class="line"><span class="keyword">JAVA_HOME=/usr/local/java</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"># </span>查看是否安装成功</span><br><span class="line">[root@tomcat ~]<span class="comment"># java -version</span></span><br><span class="line"><span class="keyword">java </span>version <span class="string">"1.8.0_211"</span></span><br><span class="line"><span class="keyword">Java(TM) </span>SE Runtime Environment (<span class="keyword">build </span><span class="number">1</span>.<span class="number">8</span>.<span class="number">0</span>_211-<span class="keyword">b12)</span></span><br><span class="line"><span class="keyword">Java </span>HotSpot(TM) <span class="number">64</span>-<span class="keyword">Bit </span>Server VM (<span class="keyword">build </span><span class="number">25</span>.<span class="number">211</span>-<span class="keyword">b12, </span>mixed mode)</span><br></pre></td></tr></table></figure></p><h3 id="部署Tomcat"><a href="#部署Tomcat" class="headerlink" title="部署Tomcat"></a>部署Tomcat</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压软件包</span></span><br><span class="line">[root@tomcat ~]# tar xf apache-tomcat-9.0.21.tar.gz -C /usr/local/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个软链接</span></span><br><span class="line">[root@tomcat ~]# ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义tomcat所需的环境变量</span></span><br><span class="line">[root@tomcat ~]# echo <span class="string">"export TOMCAT_HOME=/usr/local/tomcat"</span> &gt;&gt; /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载环境变量</span></span><br><span class="line">[root@tomcat ~]# source /etc/profile</span><br></pre></td></tr></table></figure><h2 id="Tomcat启动"><a href="#Tomcat启动" class="headerlink" title="Tomcat启动"></a>Tomcat启动</h2><p>1）默认的启动方式<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]<span class="meta"># ls /usr/local/tomcat/bin/startup.sh   #启动脚本</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/startup.sh</span><br><span class="line">[root@tomcat ~]<span class="meta"># ls /usr/local/tomcat/bin/shutdown.sh   #停止脚本</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/shutdown.sh</span><br><span class="line"></span><br><span class="line"><span class="meta"># 默认方式启动</span></span><br><span class="line">[root@tomcat ~]<span class="meta"># /usr/local/tomcat/bin/startup.sh </span></span><br><span class="line">Using CATALINA_BASE:   <span class="meta-keyword">/usr/</span>local/tomcat</span><br><span class="line">Using CATALINA_HOME:   <span class="meta-keyword">/usr/</span>local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>temp</span><br><span class="line">Using JRE_HOME:        <span class="meta-keyword">/usr/</span>local/java</span><br><span class="line">Using CLASSPATH:       <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/bootstrap.jar:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line"></span><br><span class="line"><span class="meta"># 默认方式停止</span></span><br><span class="line">[root@tomcat ~]<span class="meta"># /usr/local/tomcat/bin/shutdown.sh </span></span><br><span class="line">Using CATALINA_BASE:   <span class="meta-keyword">/usr/</span>local/tomcat</span><br><span class="line">Using CATALINA_HOME:   <span class="meta-keyword">/usr/</span>local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>temp</span><br><span class="line">Using JRE_HOME:        <span class="meta-keyword">/usr/</span>local/java</span><br><span class="line">Using CLASSPATH:       <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/bootstrap.jar:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/tomcat-juli.jar</span><br></pre></td></tr></table></figure></p><p>2）加入<code>/etc/init.d/</code>支持<code>centos6</code>的<code>service</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑/etc/init.d/tomcat脚本</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># vim /etc/init.d/tomcat</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Init file for Tomcat server daemon</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 96 14</span></span><br><span class="line"><span class="comment"># description: Tomcat server daemon</span></span><br><span class="line">JAVA_OPTS=<span class="string">'-Xms64m -Xmx128m'</span></span><br><span class="line">JAVA_HOME=/usr/<span class="built_in">local</span>/jdk1.8.0_211      <span class="comment">#指定jdk安装路径</span></span><br><span class="line">CATALINA_HOME=/usr/<span class="built_in">local</span>/tomcat     <span class="comment">#指定tomcat安装路径</span></span><br><span class="line"><span class="built_in">export</span> JAVA_OPTS JAVA_HOME CATALINA_HOME</span><br><span class="line"><span class="built_in">exec</span> <span class="variable">$CATALINA_HOME</span>/bin/catalina.sh $*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加执行权限</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># chmod +x /etc/init.d/tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动停止测试</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># service tomcat start</span></span><br><span class="line">Using CATALINA_BASE:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/<span class="built_in">local</span>/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/<span class="built_in">local</span>/jdk1.8.0_211</span><br><span class="line">Using CLASSPATH:       /usr/<span class="built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="built_in">local</span>/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line">[root@tomcat ~]<span class="comment"># </span></span><br><span class="line">[root@tomcat ~]<span class="comment"># service tomcat stop</span></span><br><span class="line">Using CATALINA_BASE:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/<span class="built_in">local</span>/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/<span class="built_in">local</span>/jdk1.8.0_211</span><br><span class="line">Using CLASSPATH:       /usr/<span class="built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="built_in">local</span>/tomcat/bin/tomcat-juli.jar</span><br></pre></td></tr></table></figure></p><p>3）加入<code>systemd</code>管理<code>tomcat</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑启动脚本</span></span><br><span class="line">[root@tomcat ~]# vim /usr/lib/systemd/system/tomcat.service</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Tomcat<span class="built_in"> server </span>daemon</span><br><span class="line"><span class="attribute">After</span>=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">Type</span>=oneshot</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/tomcat/bin/startup.sh</span><br><span class="line"><span class="attribute">ExecStop</span>=/usr/local/tomcat/bin/shutdown.sh</span><br><span class="line"><span class="attribute">ExecReload</span>=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attribute">RemainAfterExit</span>=<span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试启动和关闭</span></span><br><span class="line">[root@tomcat ~]# systemctl start tomcat</span><br><span class="line">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class="line">root       4810      1 35 12:37 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.<span class="attribute">file</span>=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.<span class="attribute">manager</span>=org.apache.juli.ClassLoaderLogManager -Djdk.tls.<span class="attribute">ephemeralDHKeySize</span>=2048 -Djava.protocol.handler.<span class="attribute">pkgs</span>=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.<span class="attribute">UMASK</span>=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.<span class="attribute">base</span>=/usr/local/tomcat -Dcatalina.<span class="attribute">home</span>=/usr/local/tomcat -Djava.io.<span class="attribute">tmpdir</span>=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class="line">root       4852   1823  0 12:37 pts/1    00:00:00 grep <span class="attribute">--color</span>=auto tomcat</span><br><span class="line">[root@tomcat ~]# </span><br><span class="line">[root@tomcat ~]# systemctl stop tomcat</span><br><span class="line">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class="line">root       4888   1823  0 12:38 pts/1    00:00:00 grep <span class="attribute">--color</span>=auto tomcat</span><br><span class="line">[root@tomcat ~]# </span><br><span class="line">[root@tomcat ~]# systemctl restart tomcat </span><br><span class="line">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class="line">root       4909      1 43 12:38 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.<span class="attribute">file</span>=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.<span class="attribute">manager</span>=org.apache.juli.ClassLoaderLogManager -Djdk.tls.<span class="attribute">ephemeralDHKeySize</span>=2048 -Djava.protocol.handler.<span class="attribute">pkgs</span>=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.<span class="attribute">UMASK</span>=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.<span class="attribute">base</span>=/usr/local/tomcat -Dcatalina.<span class="attribute">home</span>=/usr/local/tomcat -Djava.io.<span class="attribute">tmpdir</span>=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class="line">root       4959   1823  0 12:38 pts/1    00:00:00 grep <span class="attribute">--color</span>=auto tomcat</span><br><span class="line">[root@tomcat ~]#</span><br><span class="line">[root@tomcat ~]# systemctl status tomcat</span><br><span class="line">● tomcat.service - Tomcat<span class="built_in"> server </span>daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/tomcat.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (exited) since 二 2019-06-25 12:38:22 CST; 3min 53s ago</span><br><span class="line">  Process: 4895 <span class="attribute">ExecStart</span>=/usr/local/tomcat/bin/startup.sh (<span class="attribute">code</span>=exited, <span class="attribute">status</span>=0/SUCCESS)</span><br><span class="line"> Main PID: 4895 (<span class="attribute">code</span>=exited, <span class="attribute">status</span>=0/SUCCESS)</span><br><span class="line">   CGroup: /system.slice/tomcat.service</span><br><span class="line">           └─4909 /usr/bin/java -Djava.util.logging.config.<span class="attribute">file</span>=/usr/local/tomcat/conf/logging.pro...</span><br><span class="line"></span><br><span class="line">6月 25 12:38:22 tomcat systemd[1]: Starting Tomcat<span class="built_in"> server </span>daemon<span class="built_in">..</span>.</span><br><span class="line">6月 25 12:38:22 tomcat startup.sh[4895]: Tomcat started.</span><br><span class="line">6月 25 12:38:22 tomcat systemd[1]: Started Tomcat<span class="built_in"> server </span>daemon.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入开机启动</span></span><br><span class="line">[root@tomcat ~]# systemctl <span class="builtin-name">enable</span> tomcat</span><br><span class="line">[root@tomcat ~]# systemctl list-unit-files  |grep tomcat</span><br><span class="line">tomcat.service                                enabled</span><br></pre></td></tr></table></figure></p><p>tomcat启动成功后默认端口为：8080，访问地址<a href="http://ip:8080" target="_blank" rel="noopener">http://ip:8080</a><br><img src="/2019/06/26/Tomcat安装与部署/tomcat01.png" alt></p><h2 id="Tomcat目录结构"><a href="#Tomcat目录结构" class="headerlink" title="Tomcat目录结构"></a>Tomcat目录结构</h2><p><code>tomcat</code>安装主目录下的各个子目录说明：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]<span class="comment"># cd /usr/local/tomcat/</span></span><br><span class="line">[root@tomcat tomcat]<span class="comment"># tree -L 1</span></span><br><span class="line">.</span><br><span class="line">├── bin<span class="comment">#存放启动、关闭tomcat或者其它功能的脚本(.bat文件和.sh文件)</span></span><br><span class="line">├── BUILDING.txt</span><br><span class="line">├── conf        <span class="comment">#存放tomcat配置相关的文件</span></span><br><span class="line">├── CONTRIBUTING.md</span><br><span class="line">├── <span class="class"><span class="keyword">lib</span>         <span class="comment">#存放Web应用能访问的JAR包</span></span></span><br><span class="line">├── LICENSE</span><br><span class="line">├── logs        <span class="comment">#存放tomcat日志文件</span></span><br><span class="line">├── NOTICE</span><br><span class="line">├── README.md</span><br><span class="line">├── RELEASE-NOTES</span><br><span class="line">├── RUNNING.txt</span><br><span class="line">├── temp        <span class="comment">#临时文件</span></span><br><span class="line">├── webapps     <span class="comment">#Web应用程序的跟目录</span></span><br><span class="line">└── work        <span class="comment">#用以产生有JSP编译出的Servlet的.java和.class文件</span></span><br><span class="line"></span><br><span class="line"><span class="number">7</span> directories, <span class="number">7</span> files</span><br></pre></td></tr></table></figure></p><p><code>webapps</code>目录说明：</p><blockquote><p>这里几个目录对应着主界面的上面的按钮，可以直接在主界面查看帮助文档，及<code>web</code>界面直接管理。</p></blockquote><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat tomcat]<span class="comment"># cd webapps/</span></span><br><span class="line">[root@tomcat webapps]<span class="comment"># ll</span></span><br><span class="line">总用量 4</span><br><span class="line">drwxr-x---<span class="number"> 14 </span>root root<span class="number"> 4096 </span>6月 <span class="number"> 25 </span>11:39 docs          <span class="comment">#tomcat帮助文档</span></span><br><span class="line">drwxr-x--- <span class="number"> 6 </span>root root  <span class="number"> 83 </span>6月 <span class="number"> 25 </span>11:39 examples      <span class="comment">#web应用实例</span></span><br><span class="line">drwxr-x--- <span class="number"> 5 </span>root root  <span class="number"> 87 </span>6月 <span class="number"> 25 </span>11:39 host-manager  <span class="comment">#管理</span></span><br><span class="line">drwxr-x--- <span class="number"> 5 </span>root root <span class="number"> 103 </span>6月 <span class="number"> 25 </span>11:39 manager       <span class="comment">#管理</span></span><br><span class="line">drwxr-x--- <span class="number"> 3 </span>root root <span class="number"> 283 </span>6月 <span class="number"> 25 </span>11:39 ROOT          <span class="comment">#默认网站根目录</span></span><br></pre></td></tr></table></figure><h2 id="Tomcat日志文件"><a href="#Tomcat日志文件" class="headerlink" title="Tomcat日志文件"></a>Tomcat日志文件</h2><blockquote><p><code>tomcat</code>一般有几个日志文件，访问的一般放在<code>localhost</code>日志文件里面，管理的日志放在<code>manager</code>日志文件里面，实时日志一般在<code>catalina.out</code>里面</p></blockquote><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@tomcat tomcat]</span># <span class="selector-tag">cd</span> <span class="selector-tag">logs</span>/</span><br><span class="line"><span class="selector-attr">[root@tomcat logs]</span># <span class="selector-tag">ll</span></span><br><span class="line">总用量 <span class="selector-tag">180</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span> <span class="selector-tag">82372</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span> <span class="selector-tag">catalina</span><span class="selector-class">.2019-06-25</span><span class="selector-class">.log</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span> <span class="selector-tag">82574</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span> <span class="selector-tag">catalina</span><span class="selector-class">.out</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>     <span class="selector-tag">0</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">12</span><span class="selector-pseudo">:18</span> <span class="selector-tag">host-manager</span><span class="selector-class">.2019-06-25</span><span class="selector-class">.log</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>  <span class="selector-tag">6246</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span> <span class="selector-tag">localhost</span><span class="selector-class">.2019-06-25</span><span class="selector-class">.log</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>  <span class="selector-tag">3489</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">14</span><span class="selector-pseudo">:30</span> <span class="selector-tag">localhost_access_log</span><span class="selector-class">.2019-06-25</span><span class="selector-class">.txt</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>     <span class="selector-tag">0</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">12</span><span class="selector-pseudo">:18</span> <span class="selector-tag">manager</span><span class="selector-class">.2019-06-25</span><span class="selector-class">.log</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@tomcat logs]</span># <span class="selector-tag">tailf</span> <span class="selector-tag">catalina</span><span class="selector-class">.out</span> </span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:24.674</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> <span class="selector-tag">Deployment</span> <span class="selector-tag">of</span> <span class="selector-tag">web</span> <span class="selector-tag">application</span> <span class="selector-tag">directory</span> <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/docs]</span> <span class="selector-tag">has</span> <span class="selector-tag">finished</span> <span class="selector-tag">in</span> <span class="selector-attr">[27]</span> <span class="selector-tag">ms</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:24.675</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> 把<span class="selector-tag">web</span> 应用程序部署到目录 <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/examples]</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.113</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> <span class="selector-tag">Deployment</span> <span class="selector-tag">of</span> <span class="selector-tag">web</span> <span class="selector-tag">application</span> <span class="selector-tag">directory</span> <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/examples]</span> <span class="selector-tag">has</span> <span class="selector-tag">finished</span> <span class="selector-tag">in</span> <span class="selector-attr">[438]</span> <span class="selector-tag">ms</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.113</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> 把<span class="selector-tag">web</span> 应用程序部署到目录 <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/host-manager]</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.163</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> <span class="selector-tag">Deployment</span> <span class="selector-tag">of</span> <span class="selector-tag">web</span> <span class="selector-tag">application</span> <span class="selector-tag">directory</span> <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/host-manager]</span> <span class="selector-tag">has</span> <span class="selector-tag">finished</span> <span class="selector-tag">in</span> <span class="selector-attr">[50]</span> <span class="selector-tag">ms</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.163</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> 把<span class="selector-tag">web</span> 应用程序部署到目录 <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/manager]</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.220</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> <span class="selector-tag">Deployment</span> <span class="selector-tag">of</span> <span class="selector-tag">web</span> <span class="selector-tag">application</span> <span class="selector-tag">directory</span> <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/manager]</span> <span class="selector-tag">has</span> <span class="selector-tag">finished</span> <span class="selector-tag">in</span> <span class="selector-attr">[57]</span> <span class="selector-tag">ms</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.238</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.coyote</span><span class="selector-class">.AbstractProtocol</span><span class="selector-class">.start</span> 开始协议处理句柄<span class="selector-attr">["http-nio-8080"]</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.298</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.coyote</span><span class="selector-class">.AbstractProtocol</span><span class="selector-class">.start</span> 开始协议处理句柄<span class="selector-attr">["ajp-nio-8009"]</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.302</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.Catalina</span><span class="selector-class">.start</span> <span class="selector-tag">Server</span> <span class="selector-tag">startup</span> <span class="selector-tag">in</span> <span class="selector-attr">[1,290]</span> <span class="selector-tag">milliseconds</span></span><br></pre></td></tr></table></figure><h2 id="Tomcat配置文件"><a href="#Tomcat配置文件" class="headerlink" title="Tomcat配置文件"></a>Tomcat配置文件</h2><blockquote><p><code>tomcat</code>配置文件存放在安装目录下的<code>conf</code>目录下面</p></blockquote><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入到配置文件目录</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># cd /usr/local/tomcat/conf/</span></span><br><span class="line">[root@tomcat conf]<span class="comment"># ll</span></span><br><span class="line">总用量 228</span><br><span class="line">drwxr-x---<span class="number"> 3 </span>root root    <span class="number"> 23 </span>6月 <span class="number"> 25 </span>12:18 Catalina</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root <span class="number"> 12873 </span>6月  <span class="number"> 5 </span>04:23 catalina.policy</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 7243 </span>6月  <span class="number"> 5 </span>04:23 catalina.properties</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 1400 </span>6月  <span class="number"> 5 </span>04:23 context.xml</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 1149 </span>6月  <span class="number"> 5 </span>04:23 jaspic-providers.xml</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 2313 </span>6月  <span class="number"> 5 </span>04:23 jaspic-providers.xsd</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 4144 </span>6月  <span class="number"> 5 </span>04:23 logging.properties</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 7511 </span>6月  <span class="number"> 5 </span>04:23 server.xml  <span class="comment">#主配置文件</span></span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 2164 </span>6月  <span class="number"> 5 </span>04:23 tomcat-users.xml  <span class="comment">#Tomcat管理用户配置文件</span></span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 2633 </span>6月  <span class="number"> 5 </span>04:23 tomcat-users.xsd</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 171962 </span>6月  <span class="number"> 5 </span>04:23 web.xml</span><br></pre></td></tr></table></figure><h3 id="Tomcat管理"><a href="#Tomcat管理" class="headerlink" title="Tomcat管理"></a>Tomcat管理</h3><blockquote><p>配置<code>tomcat</code>的<code>web</code>界面管理功能，可以进行配置文件的管理，及部署在<code>tomcat</code>上的应用进行管理，默认情况是处于禁用状态。如果要开启这个功能，需要配置管理用户，即配置<code>tomcat-users.xml</code>文件。并且还需要修改manager项目下的<code>content.xml</code>文件，让其所有地址可访问</p></blockquote><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># vim /usr/local/tomcat/conf/tomcat-users.xml</span></span><br><span class="line">...</span><br><span class="line">&lt;role rolename=<span class="string">"manager-gui"</span>/&gt;</span><br><span class="line">&lt;role rolename=<span class="string">"admin-gui"</span>/&gt;</span><br><span class="line">&lt;user username=<span class="string">"tomcat"</span> password=<span class="string">"tomcat"</span> roles=<span class="string">"manager-gui,admin-gui"</span>/&gt;</span><br><span class="line">&lt;/tomcat-users&gt; <span class="comment">#在这行前面加入上面三行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑manager/META-INF/context.xml</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># vim /usr/local/tomcat/webapps/manager/META-INF/context.xml</span></span><br><span class="line"><span class="comment">#将</span></span><br><span class="line">allow=<span class="string">"127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1"</span> /&gt;</span><br><span class="line"><span class="comment">#改为</span></span><br><span class="line">allow=<span class="string">"\d+\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1"</span> /&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑host-manager/META-INF/context.xml</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># vim /usr/local/tomcat/webapps/host-manager/META-INF/context.xml</span></span><br><span class="line"><span class="comment">#将</span></span><br><span class="line">allow=<span class="string">"127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1"</span> /&gt;</span><br><span class="line"><span class="comment">#改为</span></span><br><span class="line">allow=<span class="string">"\d+\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1"</span> /&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启tomcat</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure><p>访问测试<br><img src="/2019/06/26/Tomcat安装与部署/tomcat02.png" alt><br>状态页面：<br><img src="/2019/06/26/Tomcat安装与部署/tomcat03.png" alt><br>Manager页面：<br><img src="/2019/06/26/Tomcat安装与部署/tomcat04.png" alt><br>Host Manager页面：<br><img src="/2019/06/26/Tomcat安装与部署/tomcat05.png" alt></p><h3 id="server-xml配置文件注释"><a href="#server-xml配置文件注释" class="headerlink" title="server.xml配置文件注释"></a>server.xml配置文件注释</h3><p>参考：<a href="https://www.cnblogs.com/sunshine-1/p/8990044.html" target="_blank" rel="noopener">https://www.cnblogs.com/sunshine-1/p/8990044.html</a><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.security.SecurityListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="attr">SSLEngine</span>=<span class="string">"on"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JasperListener"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span> </span><br><span class="line">  <span class="comment">&lt;!-- 全局命名资源，来定义一些外部访问资源，其作用是为所有引擎应用程序所引用的外部资源的定义 --!&gt; </span></span><br><span class="line"><span class="comment">    &lt;Resource name="UserDatabase" auth="Container" </span></span><br><span class="line"><span class="comment">              type="org.apache.catalina.UserDatabase" </span></span><br><span class="line"><span class="comment">              description="User database that can be updated and saved" </span></span><br><span class="line"><span class="comment">              factory="org.apache.catalina.users.MemoryUserDatabaseFactory" </span></span><br><span class="line"><span class="comment">              pathname="conf/tomcat-users.xml" /&gt; </span></span><br><span class="line"><span class="comment">  &lt;/GlobalNamingResources&gt; </span></span><br><span class="line"><span class="comment">  &lt;!-- 定义的一个名叫“UserDatabase”的认证资源，将conf/tomcat-users.xml加载至内存中，在需要认证的时候到内存中进行认证 --&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span> </span><br><span class="line">  <span class="comment">&lt;!-- # 定义Service组件，同来关联Connector和Engine，一个Engine可以对应多个Connector，每个Service中只能一个Engine --!&gt; </span></span><br><span class="line"><span class="comment">    &lt;Connector port="80" protocol="HTTP/1.1" connectionTimeout="20000" redirectPort="8443" /&gt; </span></span><br><span class="line"><span class="comment">    &lt;!-- 修改HTTP/1.1的Connector监听端口为80.客户端通过浏览器访问的请求，只能通过HTTP传递给tomcat。还可以设置server与URIEncoding参数 --&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8009"</span> <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"test.com"</span>&gt;</span> </span><br><span class="line">    <span class="comment">&lt;!-- 修改当前Engine，默认主机是，www.test.com  --&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span>/&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span> </span><br><span class="line">    # Realm组件，定义对当前容器内的应用程序访问的认证，通过外部资源UserDatabase进行认证 </span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"test.com"</span>  <span class="attr">appBase</span>=<span class="string">"/web"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span> </span><br><span class="line">      <span class="comment">&lt;!--  定义一个主机，域名为：test.com，应用程序的目录是/web，设置自动部署，自动解压    --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Alias</span>&gt;</span>www.test.com<span class="tag">&lt;/<span class="name">Alias</span>&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--    定义一个别名www.test.com，类似apache的ServerAlias --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span>=<span class="string">"www/"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> /&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--    定义该应用程序，访问路径""，即访问www.test.com即可访问，网页目录为：相对于appBase下的www/，即/web/www，并且当该应用程序下web.xml或者类等有相关变化时，自动重载当前配置，即不用重启tomcat使部署的新应用程序生效  --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">"/bbs"</span> <span class="attr">docBase</span>=<span class="string">"/web/bbs"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> /&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--  定义另外一个独立的应用程序(虚拟主机)，访问路径为：www.test.com/bbs，该应用程序网页目录为/web/bbs   --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"/web/www/logs"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"www_access."</span> <span class="attr">suffix</span>=<span class="string">".log"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--   定义一个Valve组件，用来记录tomcat的访问日志，日志存放目录为：/web/www/logs如果定义为相对路径则是相当于$CATALINA_HOME，并非相对于appBase，这个要注意。定义日志文件前缀为www_access.并以.log结尾，pattern定义日志内容格式，具体字段表示可以查看tomcat官方文档   --&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"manager.test.com"</span> <span class="attr">appBase</span>=<span class="string">"webapps"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span> </span><br><span class="line">      <span class="comment">&lt;!--   定义一个主机名为man.test.com，应用程序目录是$CATALINA_HOME/webapps,自动解压，自动部署   --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.RemoteAddrValve"</span> <span class="attr">allow</span>=<span class="string">"172.16.100.*"</span> /&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--   定义远程地址访问策略，仅允许172.16.100.*网段访问该主机，其他的将被拒绝访问  --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"/web/bbs/logs"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"bbs_access."</span> <span class="attr">suffix</span>=<span class="string">".log"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--   定义该主机的访问日志      --&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="Tomcat单实例站点部署"><a href="#Tomcat单实例站点部署" class="headerlink" title="Tomcat单实例站点部署"></a>Tomcat单实例站点部署</h2><blockquote><p>以部署<code>jspxcms</code>为例，在上面已部署的环境下继续操作。</p></blockquote><p>1）安装<code>MySQL</code>及创建库<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@tomcat ~</span>]<span class="meta"># yum -y install mariadb mariadb-server</span></span><br><span class="line">[<span class="meta">root@tomcat ~</span>]<span class="meta"># systemctl enable mariadb</span></span><br><span class="line">[<span class="meta">root@tomcat ~</span>]<span class="meta"># systemctl start mariadb</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 创建数据库并授权</span></span><br><span class="line">MariaDB [(none)]&gt; create database jspxcms_test character <span class="keyword">set</span> utf8;</span><br><span class="line">MariaDB [(none)]&gt; grant all <span class="keyword">on</span> jspxcms_test.* to <span class="string">'jspxcmsuser'</span>@<span class="string">'localhost'</span> identified <span class="keyword">by</span> <span class="string">'123'</span>;</span><br><span class="line">MariaDB [(none)]&gt; flush privileges;</span><br></pre></td></tr></table></figure></p><p>2）部署<code>jspxcms</code><br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tomcat默认的网站目录</span></span><br><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># ls /usr/local/tomcat/webapps/</span></span><br><span class="line">docs  examples  host-manager  manager  ROOT</span><br><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># ls /usr/local/tomcat/webapps/ROOT/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传jspxcms安装包并解压</span></span><br><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># mkdir tools</span></span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># ls</span></span><br><span class="line">jspxcms-<span class="number">9.5</span>.<span class="number">0</span>-release.zip</span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># unzip jspxcms-9.5.0-release.zip</span></span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># ls</span></span><br><span class="line">CHANGELOG.txt  database  jspxcms-<span class="number">9.5</span>.<span class="number">0</span>-release.zip  Jspxcms安装手册.pdf  ROOT  用户许可协议.txt</span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># rm -rf /usr/local/tomcat/webapps/*</span></span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># cp -a ROOT /usr/local/tomcat/webapps/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入sql文件</span></span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># mysql -D jspxcms_test &lt; database/mysql.sql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件配置数据库连接信息</span></span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># vim /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/application.properties</span></span><br><span class="line">spring.datasource.url=<span class="symbol">jdbc:</span><span class="symbol">mysql:</span>/<span class="regexp">/127.0.0.1:3306/jspxcms</span>_test?characterEncoding=utf8</span><br><span class="line"><span class="comment"># \u6570\u636E\u5E93\u7528\u6237\u540D</span></span><br><span class="line">spring.datasource.username=jspxcmsuser</span><br><span class="line"><span class="comment"># \u6570\u636E\u5E93\u5BC6\u7801</span></span><br><span class="line">spring.datasource.password=<span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启tomcat</span></span><br><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure></p><p>3）<code>web</code>页面访问 前台地址：<a href="http://ip:8080" target="_blank" rel="noopener">http://ip:8080</a>  &emsp;后台地址：<a href="http://ip:8080/cmscp/index.do" target="_blank" rel="noopener">http://ip:8080/cmscp/index.do</a>   &emsp; 默认账号：admin  密码为空<br><img src="/2019/06/26/Tomcat安装与部署/tomcat06.png" alt><br><img src="/2019/06/26/Tomcat安装与部署/tomcat07.png" alt></p><h2 id="Tomcat多实例站点部署"><a href="#Tomcat多实例站点部署" class="headerlink" title="Tomcat多实例站点部署"></a>Tomcat多实例站点部署</h2><blockquote><p>多实例作用运行不同的应用（类似虚拟主机）<br>多实例运行相同的应用（实现负载均衡，支持高并发处理，session问题）<br>这里基于上面已安装的tomcat环境</p></blockquote><table><thead><tr><th>环境</th><th>Web监听端口</th><th>管理实例端口</th><th>站点家目录</th></tr></thead><tbody><tr><td>tomcat9_1</td><td>8081</td><td>8091</td><td>/webapps/tomcat9_1</td></tr><tr><td>tomcat9_2</td><td>8082</td><td>8092</td><td>/webapps/tomcat9_2</td></tr></tbody></table><p>1）拷贝tomcat目录<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]<span class="comment"># cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_1</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_2</span></span><br></pre></td></tr></table></figure></p><p>2）编辑配置文件，修改监听端口和站点家目录<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]# vim /usr/local/tomcat9_1/conf/server.xml</span><br><span class="line">&lt;Server <span class="attribute">port</span>=<span class="string">"8091"</span> <span class="attribute">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span><br><span class="line">&lt;Connector <span class="attribute">port</span>=<span class="string">"8081"</span> <span class="attribute">protocol</span>=<span class="string">"HTTP/1.1"</span></span><br><span class="line">           <span class="attribute">connectionTimeout</span>=<span class="string">"20000"</span></span><br><span class="line">           <span class="attribute">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span><br><span class="line">&lt;Host <span class="attribute">name</span>=<span class="string">"localhost"</span>  <span class="attribute">appBase</span>=<span class="string">"/webapps/tomcat9_1"</span></span><br><span class="line">            <span class="attribute">unpackWARs</span>=<span class="string">"true"</span> <span class="attribute">autoDeploy</span>=<span class="string">"true"</span>&gt;</span><br><span class="line"></span><br><span class="line">[root@tomcat ~]# vim /usr/local/tomcat9_2/conf/server.xml</span><br><span class="line">&lt;Server <span class="attribute">port</span>=<span class="string">"8092"</span> <span class="attribute">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span><br><span class="line">&lt;Connector <span class="attribute">port</span>=<span class="string">"8082"</span> <span class="attribute">protocol</span>=<span class="string">"HTTP/1.1"</span></span><br><span class="line">           <span class="attribute">connectionTimeout</span>=<span class="string">"20000"</span></span><br><span class="line">           <span class="attribute">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span><br><span class="line">&lt;Host <span class="attribute">name</span>=<span class="string">"localhost"</span>  <span class="attribute">appBase</span>=<span class="string">"/webapps/tomcat9_2"</span></span><br><span class="line">            <span class="attribute">unpackWARs</span>=<span class="string">"true"</span> <span class="attribute">autoDeploy</span>=<span class="string">"true"</span>&gt;</span><br></pre></td></tr></table></figure></p><p>3）创建站点家目录，及测试页面准备<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@tomcat</span> ~]<span class="comment"># mkdir -p /webapps/tomcat9_&#123;1,2&#125;</span></span><br><span class="line">[root<span class="meta">@tomcat</span> ~]<span class="comment"># mkdir /webapps/tomcat9_&#123;1,2&#125;/ROOT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tomcat9_1测试页面准备</span></span><br><span class="line">[root<span class="meta">@tomcat</span> ~]<span class="comment"># vim /webapps/tomcat9_1/ROOT/index.jsp</span></span><br><span class="line"><span class="variable">&lt;html&gt;</span></span><br><span class="line"><span class="variable">&lt;body&gt;</span></span><br><span class="line"><span class="variable">&lt;center&gt;</span></span><br><span class="line"><span class="variable">&lt;H1&gt;</span><span class="variable">&lt;%=new java.util.Date()%&gt;</span><span class="variable">&lt;/H1&gt;</span></span><br><span class="line"><span class="variable">&lt;H2&gt;</span>tomcat9_1<span class="variable">&lt;/H2&gt;</span></span><br><span class="line"><span class="variable">&lt;/center&gt;</span></span><br><span class="line"><span class="variable">&lt;/body&gt;</span></span><br><span class="line"><span class="variable">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tomcat9_2测试页面准备</span></span><br><span class="line">[root<span class="meta">@tomcat</span> ~]<span class="comment"># vim /webapps/tomcat9_2/ROOT/index.jsp</span></span><br><span class="line"><span class="variable">&lt;html&gt;</span></span><br><span class="line"><span class="variable">&lt;body&gt;</span></span><br><span class="line"><span class="variable">&lt;center&gt;</span></span><br><span class="line"><span class="variable">&lt;H1&gt;</span><span class="variable">&lt;%=new java.util.Date()%&gt;</span><span class="variable">&lt;/H1&gt;</span></span><br><span class="line"><span class="variable">&lt;H2&gt;</span>tomcat9_2<span class="variable">&lt;/H2&gt;</span></span><br><span class="line"><span class="variable">&lt;/center&gt;</span></span><br><span class="line"><span class="variable">&lt;/body&gt;</span></span><br><span class="line"><span class="variable">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure></p><p>4）删除掉之前的站点目录里面的东西，对这里没有用了。可以直接删掉<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@tomcat</span> ~]<span class="meta"># rm -rf /usr/local/tomcat9_2/webapps/*</span></span><br><span class="line">[root<span class="symbol">@tomcat</span> ~]<span class="meta"># rm -rf /usr/local/tomcat9_1/webapps/*</span></span><br></pre></td></tr></table></figure></p><p>5）启动<code>tomcat1</code>和<code>tomcat2</code><br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># for i in &#123;1..2&#125;;do /usr/local/tomcat9_$i/bin/startup.sh; done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 端口查看</span></span><br><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># ss -tnlp |grep :80</span></span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>         ::<span class="symbol">:</span><span class="number">8080</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">27023</span>,fd=<span class="number">54</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>         ::<span class="symbol">:</span><span class="number">8081</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">28687</span>,fd=<span class="number">54</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>         ::<span class="symbol">:</span><span class="number">8082</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">28708</span>,fd=<span class="number">54</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">1</span>         ::<span class="symbol">ffff:</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:</span><span class="number">8091</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">28687</span>,fd=<span class="number">65</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">1</span>         ::<span class="symbol">ffff:</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:</span><span class="number">8092</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">28708</span>,fd=<span class="number">66</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">1</span>         ::<span class="symbol">ffff:</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:</span><span class="number">8005</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">27023</span>,fd=<span class="number">71</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>         ::<span class="symbol">:</span><span class="number">8009</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">27023</span>,fd=<span class="number">59</span>)</span><br></pre></td></tr></table></figure></p><p>6）访问测试<br><img src="/2019/06/26/Tomcat安装与部署/tomcat08.png" alt="http://192.168.1.31:8081"><br><img src="/2019/06/26/Tomcat安装与部署/tomcat09.png" alt="http://192.168.1.31:8082"></p><p><strong>补充：Tomcat多实例启动脚本</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]<span class="comment"># cat TomcatSys.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Desc：用于tomcat多实例部署启动脚本。</span></span><br><span class="line"><span class="comment">#Date：2019-6-26</span></span><br><span class="line"><span class="comment">#by：Lee-YJ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"tomcat1"</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> CATALINA_HOME=<span class="string">"/usr/local/tomcat9_1"</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"tomcat2"</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> CATALINA_HOME=<span class="string">"/usr/local/tomcat9_2"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;[tomcat1|tomcat2] start|stop|restart&#125;"</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$2</span>"</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    <span class="variable">$CATALINA_HOME</span>/bin/startup.sh</span><br><span class="line">    ;;</span><br><span class="line">stop)</span><br><span class="line">    <span class="variable">$CATALINA_HOME</span>/bin/shutdown.sh</span><br><span class="line">    ;;</span><br><span class="line">restart)</span><br><span class="line">    <span class="variable">$CATALINA_HOME</span>/bin/shutdown.sh</span><br><span class="line">    sleep 3</span><br><span class="line">    <span class="variable">$CATALINA_HOME</span>/bin/startup.sh</span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">    <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;[tomcat1|tomcat2] start|stop|restart&#125;"</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用说明：</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># ./TomcatSys.sh tomcat1 start      #启动tomcat1</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># ./TomcatSys.sh tomcat1 stop       #停止tomcat1</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># ./TomcatSys.sh tomcat2 restart    #重启tomcat2</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Tomcat简介&quot;&gt;&lt;a href=&quot;#Tomcat简介&quot; class=&quot;headerlink&quot; title=&quot;Tomcat简介&quot;&gt;&lt;/a&gt;Tomcat简介&lt;/h2&gt;&lt;p&gt;官网：&lt;a href=&quot;http://tomcat.apache.org/&quot; target=
      
    
    </summary>
    
      <category term="Tomcat" scheme="https://leeyj.coding.me/categories/Tomcat/"/>
    
    
      <category term="Tomcat" scheme="https://leeyj.coding.me/tags/Tomcat/"/>
    
  </entry>
  
  <entry>
    <title>Cobbler自动化部署</title>
    <link href="https://leeyj.coding.me/2019/06/12/Cobbler%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"/>
    <id>https://leeyj.coding.me/2019/06/12/Cobbler自动化部署/</id>
    <published>2019-06-12T02:10:22.000Z</published>
    <updated>2019-07-10T01:46:29.912Z</updated>
    
    <content type="html"><![CDATA[<h2 id="cobbler简介"><a href="#cobbler简介" class="headerlink" title="cobbler简介"></a>cobbler简介</h2><blockquote><p><code>Cobbler</code> 可以用来快速建立 <code>Linux</code> 网络安装环境，它已将<code>Linux</code>网络安装的技术门槛，从大专以上文化水平，成功降低到了初中水平，连补鞋匠都能学会。<br>网络安装服务器套件<code>Cobbler</code>（补鞋匠）从前，我们一直在装机民工这份很有前途的职业。自打若干年前<code>Red Hat</code>推出了 <code>Kickstart</code>，此后我们顿觉身价增倍。不再需要刻了光盘一台一台的安装<code>Linux</code>，只要搞定<code>PXE</code>、<code>DHCP</code>、<code>TFTP</code>，还有那满屏眼花缭乱不知所云的<code>Kickstart</code>脚本，我们就可以像哈利波特一样，轻点魔棒，瞬间安装上百台服务器。这一堆花里胡哨的东西可不是一般人能够整明白的，没有大专以上的学历，通不过英语四级，根本别想玩转。总而言之，这是一份多么有前途，多么有技术含量的工作啊。很不幸，<code>Red Ha</code>t 最新（<code>Cobbler</code>项目最初在<code>2008</code>年左右发布）发布了网络安装服务器套件<code>Cobbler</code>（补鞋匠），它已将<code>Linux</code>网络安装的技术门槛，从大专以上文化水平，成功降低到初中以下水平，连补鞋匠都能学会。</p></blockquote><blockquote><p>1、<code>Cobbler</code>是一个<code>Linux</code>服务器安装的服务，可以通过网络启动（<code>PXE</code>）的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理<code>DHCP</code>，<code>DNS</code>等。<br>2、<code>Cobbler</code>可以使用命令行方式管理，也提供了基于Web的界面管理工具（<code>cobbler-web</code>），还提供了<code>API</code>接口，可以方便二次开发使用。<br>3、<code>Cobbler</code>是较早前的<code>kickstart</code>的升级版，优点是比较容易配置，还自带web界面比较易于管理。<br>4、<code>Cobbler</code>内置了一个轻量级配置管理系统，但它也支持和其它配置管理系统集成，如<code>Puppet</code>。</p></blockquote><p><strong>参考网站</strong></p><p><a href="http://cobbler.github.io/" target="_blank" rel="noopener">cobbler官网</a></p><p><a href="https://www.linuxidc.com/Linux/2017-08/146168.htm" target="_blank" rel="noopener">Kickstart文件编写参考</a></p><h2 id="cobbler对应关系"><a href="#cobbler对应关系" class="headerlink" title="cobbler对应关系"></a>cobbler对应关系</h2><p><img src="/2019/06/12/Cobbler自动化部署/cobbler01.png" alt></p><blockquote><p><code>Cobbler</code>的配置结构基于一组注册的对象。每个对象表示一个与另一个实体相关联的实体。当一个对象指向另一个对象时，它就继承了被指向对象的数据，并可覆盖或添加更多特定信息。</p><ul><li>发行版(<code>distros</code>)： 表示一个操作系统。它承载了内核和<code>initrd</code>的信息，以及内核参数等其他数据。</li><li>配置文件(<code>profiles</code>)：包含一个发行版、一个<code>kickstart</code>文件以及可能的存储库，还包括更多特定的内核参数等其他数据。</li><li>系统(<code>systems</code>)：表示要配给的机器。它包括一个配置文件或一个镜像、<code>IP</code>和<code>MAC</code>地址、电源管理（地址、凭据、类型）以及更为专业的数据等信息。</li><li>镜像(<code>images</code>)：可以替换一个保函不屑于此类别的文件的发行版对象（例如，无法分为内核和<code>initrd</code>的对象）。</li></ul></blockquote><h2 id="cobbler集成的服务"><a href="#cobbler集成的服务" class="headerlink" title="cobbler集成的服务"></a>cobbler集成的服务</h2><ul><li>PXE服务支持</li><li>DHCP服务管理</li><li>DNS服务管理</li><li>电源管理</li><li>Kickstart服务支持</li><li>YUM仓库管理</li><li>TFTP</li><li>Apache</li></ul><h2 id="cobbler工作原理"><a href="#cobbler工作原理" class="headerlink" title="cobbler工作原理"></a>cobbler工作原理</h2><p><img src="/2019/06/12/Cobbler自动化部署/cobbler09.png" alt></p><p><strong>Server端</strong></p><ul><li>启动<code>Cobbler</code>服务</li><li>进行<code>Cobbler</code>错误检查，执行<code>cobbler check</code>命令</li><li>进行配置同步，执行<code>cobbler syn</code>c命令</li><li>复制相关启动文件到<code>TFTP</code>目录中</li><li>启动<code>DHCP</code>服务，提供地址分配</li><li><code>DHCP</code>服务分配IP地址</li><li><code>TFTP</code>传输启动文件</li><li><code>Server</code>端接收安装信息</li><li><code>Server</code>端发送<code>ISO</code>镜像与<code>Kickstart</code>文件</li></ul><p><strong>Client端</strong></p><ul><li>客户端以<code>PXE</code>模式启动</li><li>客户端获取<code>IP</code>地址</li><li>通过<code>TFTP</code>服务器获取启动文件</li><li>进入<code>Cobbler</code>安装选择界面</li><li>根据配置信息准备安装系统</li><li>加载<code>Kickstart</code>文件</li><li>传输系统安装的其它文件</li><li>进行安装系统</li></ul><h2 id="cobbler安装"><a href="#cobbler安装" class="headerlink" title="cobbler安装"></a>cobbler安装</h2><blockquote><p>说明：虚拟机网卡采用NAT模式，不要使用桥接模式，因为后面会搭建DHCP服务器，在同一个局域网多个DHCP服务会有冲突。<br>VMware的NAT模式的dhcp服务也关闭，避免干扰。<br><img src="/2019/06/12/Cobbler自动化部署/cobbler02.png" alt></p></blockquote><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 关闭防火墙、selinux等</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl stop firewalld</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl disable firewalld</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># setenforce 0</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># sed -i <span class="string">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/sysconfig/selinux</span></span><br></pre></td></tr></table></figure><h3 id="安装cobbler"><a href="#安装cobbler" class="headerlink" title="安装cobbler"></a>安装cobbler</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 配置epel源</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># yum -y install epel-release</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 安装cobbler及dhcp httpd xinetd cobbler-web</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># yum -y install cobbler cobbler-web tftp-server dhcp httpd xinetd</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 启动cobbler及httpd并加入开机启动</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl start httpd cobblerd</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl enable httpd cobblerd</span></span><br></pre></td></tr></table></figure><p>查看安装后相关文件<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="meta"># rpm -ql cobbler</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler                  <span class="meta"># 配置文件目录</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/settings         <span class="meta"># cobbler主配置文件，这个文件是YAML格式，Cobbler是python写的程序。</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/dhcp.template    <span class="meta"># DHCP服务的配置模板</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/tftpd.template   <span class="meta"># tftp服务的配置模板</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/rsync.template   <span class="meta"># rsync服务的配置模板</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/iso              <span class="meta"># iso模板配置文件目录</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/pxe              <span class="meta"># pxe模板文件目录</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/power            <span class="meta"># 电源的配置文件目录</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/users.conf       <span class="meta"># Web服务授权配置文件</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/users.digest     <span class="meta"># 用于web访问的用户名密码配置文件</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/dnsmasq.template <span class="meta"># DNS服务的配置模板</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/modules.conf     <span class="meta"># Cobbler模块配置文件</span></span><br><span class="line"><span class="meta-keyword">/var/</span>lib/cobbler              <span class="meta"># Cobbler数据目录</span></span><br><span class="line"><span class="meta-keyword">/var/</span>lib<span class="meta-keyword">/cobbler/</span>config       <span class="meta"># 配置文件</span></span><br><span class="line"><span class="meta-keyword">/var/</span>lib<span class="meta-keyword">/cobbler/</span>kickstarts   <span class="meta"># 默认存放kickstart文件</span></span><br><span class="line"><span class="meta-keyword">/var/</span>lib<span class="meta-keyword">/cobbler/</span>loaders      <span class="meta"># 存放的各种引导程序</span></span><br><span class="line"><span class="meta-keyword">/var/</span>www/cobbler              <span class="meta"># 系统安装镜像目录</span></span><br><span class="line"><span class="meta-keyword">/var/</span>www<span class="meta-keyword">/cobbler/</span>ks_mirror    <span class="meta"># 导入的系统镜像列表</span></span><br><span class="line"><span class="meta-keyword">/var/</span>www<span class="meta-keyword">/cobbler/</span>images       <span class="meta"># 导入的系统镜像启动文件</span></span><br><span class="line"><span class="meta-keyword">/var/</span>www<span class="meta-keyword">/cobbler/</span>repo_mirror  <span class="meta"># yum源存储目录</span></span><br><span class="line"><span class="meta-keyword">/var/</span>log/cobbler              <span class="meta"># 日志目录</span></span><br><span class="line"><span class="meta-keyword">/var/</span>log<span class="meta-keyword">/cobbler/</span>install.log  <span class="meta"># 客户端系统安装日志</span></span><br><span class="line"><span class="meta-keyword">/var/</span>log<span class="meta-keyword">/cobbler/</span>cobbler.log  <span class="meta"># cobbler日志</span></span><br></pre></td></tr></table></figure></p><h3 id="配置cobbler"><a href="#配置cobbler" class="headerlink" title="配置cobbler"></a>配置cobbler</h3><blockquote><p>检查<code>Cobbler</code>的配置，如果看不到下面的结果，再次重启<code>cobbler</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="comment"># cobbler check</span></span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line"></span><br><span class="line">1 : The 'server' field in /etc/cobbler/settings must be <span class="keyword">set</span> <span class="keyword">to</span> something other <span class="keyword">than</span> localhost, <span class="keyword">or</span> kickstarting features will <span class="keyword">not</span> work.  This should be a resolvable hostname <span class="keyword">or</span> IP <span class="keyword">for</span> the boot <span class="keyword">server</span> <span class="keyword">as</span> reachable <span class="keyword">by</span> <span class="keyword">all</span> machines that will <span class="keyword">use</span> it.</span><br><span class="line"><span class="number">2</span> : <span class="keyword">For</span> PXE <span class="keyword">to</span> be functional, the <span class="string">'next_server'</span> <span class="keyword">field</span> <span class="keyword">in</span> /etc/cobbler/<span class="keyword">settings</span> must be <span class="keyword">set</span> <span class="keyword">to</span> something other <span class="keyword">than</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>, <span class="keyword">and</span> should <span class="keyword">match</span> the IP <span class="keyword">of</span> the boot <span class="keyword">server</span> <span class="keyword">on</span> the PXE network.</span><br><span class="line"><span class="number">3</span> : <span class="keyword">change</span> <span class="string">'disable'</span> <span class="keyword">to</span> <span class="string">'no'</span> <span class="keyword">in</span> /etc/xinetd.d/tftp</span><br><span class="line"><span class="number">4</span> : <span class="keyword">Some</span> network boot-loaders <span class="keyword">are</span> <span class="keyword">missing</span> <span class="keyword">from</span> /<span class="keyword">var</span>/lib/cobbler/loaders, you may run <span class="string">'cobbler get-loaders'</span> <span class="keyword">to</span> download them, <span class="keyword">or</span>, <span class="keyword">if</span> you <span class="keyword">only</span> want <span class="keyword">to</span> handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* <span class="keyword">version</span> <span class="keyword">of</span> the syslinux <span class="keyword">package</span> installed <span class="keyword">and</span> can <span class="keyword">ignore</span> this message entirely.  Files <span class="keyword">in</span> this <span class="keyword">directory</span>, should you want <span class="keyword">to</span> support <span class="keyword">all</span> architectures, should <span class="keyword">include</span> pxelinux<span class="number">.0</span>, menu.c32, elilo.efi, <span class="keyword">and</span> yaboot. The <span class="string">'cobbler get-loaders'</span> command <span class="keyword">is</span> the easiest way <span class="keyword">to</span> resolve these requirements.</span><br><span class="line"><span class="number">5</span> : <span class="keyword">enable</span> <span class="keyword">and</span> <span class="keyword">start</span> rsyncd.service <span class="keyword">with</span> systemctl</span><br><span class="line"><span class="number">6</span> : debmirror <span class="keyword">package</span> <span class="keyword">is</span> <span class="keyword">not</span> installed, it will be <span class="keyword">required</span> <span class="keyword">to</span> manage debian deployments <span class="keyword">and</span> repositories</span><br><span class="line"><span class="number">7</span> : ksvalidator was <span class="keyword">not</span> <span class="keyword">found</span>, <span class="keyword">install</span> pykickstart</span><br><span class="line"><span class="number">8</span> : The <span class="keyword">default</span> <span class="keyword">password</span> used <span class="keyword">by</span> the <span class="keyword">sample</span> templates <span class="keyword">for</span> newly installed machines (default_password_crypted <span class="keyword">in</span> /etc/cobbler/<span class="keyword">settings</span>) <span class="keyword">is</span> still <span class="keyword">set</span> <span class="keyword">to</span> <span class="string">'cobbler'</span> <span class="keyword">and</span> should be <span class="keyword">changed</span>, try: <span class="string">"openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'"</span> <span class="keyword">to</span> generate <span class="keyword">new</span> one</span><br><span class="line"><span class="number">9</span> : fencing tools were <span class="keyword">not</span> <span class="keyword">found</span>, <span class="keyword">and</span> <span class="keyword">are</span> <span class="keyword">required</span> <span class="keyword">to</span> <span class="keyword">use</span> the (optional) <span class="keyword">power</span> <span class="keyword">management</span> features. <span class="keyword">install</span> cman <span class="keyword">or</span> fence-agents <span class="keyword">to</span> <span class="keyword">use</span> them</span><br><span class="line"></span><br><span class="line">Restart cobblerd <span class="keyword">and</span> <span class="keyword">then</span> run <span class="string">'cobbler sync'</span> <span class="keyword">to</span> <span class="keyword">apply</span> changes.</span><br></pre></td></tr></table></figure><blockquote><p>看到上面出现的问题，然后一个一个的进行解决，先进行设置为可以动态配置，也可以直接更改配置文件。</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 设置可以动态修改配置文件</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># sed -ri <span class="string">'/allow_dynamic_settings:/c\allow_dynamic_settings: 1'</span> /etc/cobbler/settings</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># grep allow_dynamic_settings /etc/cobbler/settings </span></span><br><span class="line">allow_dynamic_settings: <span class="number">1</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl restart cobblerd</span></span><br></pre></td></tr></table></figure><p>逐个解决上面的问题<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> server</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler setting edit --name=server --value=192.168.2.128</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> next_server</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler setting edit --name=next_server --value=192.168.2.128</span></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> tftp_server</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># sed -ri <span class="string">'/disable/c\disable = no'</span> /etc/xinetd.d/tftp</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl enable xinetd</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl restart xinetd</span></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> boot-loaders</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler get-loaders</span></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> rsyncd</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl start rsyncd</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl enable rsyncd</span></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span> debmirror [optional]</span><br><span class="line"><span class="meta"># 这个是可选项的，可以忽略。这里就忽略了</span></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span> pykickstart</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># yum -y install pykickstart</span></span><br><span class="line"></span><br><span class="line"><span class="number">8.</span> default_password_crypted  <span class="meta">#注意：这里设置的密码，也就是后面安装完系统的初始化登录密码</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># openssl passwd -1 -salt `openssl rand -hex 4` <span class="string">'admin'</span></span></span><br><span class="line">$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler setting edit --name=default_password_crypted --value=<span class="string">'$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0'</span></span></span><br><span class="line"></span><br><span class="line"><span class="number">9.</span> fencing tools [optional]</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># yum -y install fence-agents</span></span><br></pre></td></tr></table></figure></p><p>解决完成再次查看<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="comment"># cobbler check</span></span><br><span class="line">The following are potential configuration items <span class="literal">that</span> you may want <span class="keyword">to</span> fix:</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> : debmirror package <span class="keyword">is</span> <span class="keyword">not</span> installed, <span class="literal">it</span> will be required <span class="keyword">to</span> manage debian deployments <span class="keyword">and</span> repositories</span><br><span class="line"></span><br><span class="line">Restart cobblerd <span class="keyword">and</span> <span class="keyword">then</span> run <span class="string">'cobbler sync'</span> <span class="keyword">to</span> apply changes.</span><br></pre></td></tr></table></figure></p><h3 id="配置DHCP"><a href="#配置DHCP" class="headerlink" title="配置DHCP"></a>配置DHCP</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler setting edit --name=manage_dhcp --value=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"># 修改cobbler的dhcp模块，不要直接修改dhcp本身的配置文件，因为cobbler会覆盖</span><br><span class="line">[root@cobbler ~]# vim /etc/cobbler/dhcp.template</span><br><span class="line">...</span><br><span class="line">subnet <span class="number">192.168</span><span class="number">.2</span><span class="number">.0</span> netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> &#123; #这里改为分配的网段和掩码</span><br><span class="line">     #option routers             <span class="number">192.168</span><span class="number">.1</span><span class="number">.5</span>; #如果有网关，这里改为网关地址</span><br><span class="line">     #option domain-name-servers <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>; #如果有DNS，这里改为DNS地址</span><br><span class="line">     option subnet-mask         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>; #改为分配的IP的掩码</span><br><span class="line">     range dynamic-bootp        <span class="number">192.168</span><span class="number">.2</span><span class="number">.100</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.254</span>; #改为分配的IP的范围</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="同步cobbler配置"><a href="#同步cobbler配置" class="headerlink" title="同步cobbler配置"></a>同步cobbler配置</h3><blockquote><p>同步cobbler配置，它会根据配置自动修改dhcp等服务。</p></blockquote><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="comment"># cobbler rsync </span></span><br><span class="line">No such <span class="symbol">command:</span> rsync</span><br><span class="line">[root@cobbler ~]<span class="comment"># cobbler sync</span></span><br><span class="line">task <span class="symbol">started:</span> <span class="number">2019</span>-<span class="number">0</span>6-<span class="number">12_15262</span>3_sync</span><br><span class="line">task started (id=Sync, time=Wed Jun <span class="number">12</span> <span class="number">15</span>:<span class="number">26</span>:<span class="number">23</span> <span class="number">2019</span>)</span><br><span class="line">running pre-sync triggers</span><br><span class="line">cleaning trees</span><br><span class="line"><span class="symbol">removing:</span> /var/www/cobbler/images/centos6.<span class="number">9</span>-x86_64</span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">pxelinux</span>.<span class="title">cfg</span>/<span class="title">default</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">images</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">grub</span>-<span class="title">x86</span>.<span class="title">efi</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">grub</span>-<span class="title">x86_64</span>.<span class="title">efi</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">efidefault</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">images</span>/<span class="title">centos6</span>.9-<span class="title">x86_64</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">s390x</span>/<span class="title">profile_list</span></span></span><br><span class="line">copying bootloaders</span><br><span class="line">trying hardlink /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">loaders</span>/<span class="title">grub</span>-<span class="title">x86</span>.<span class="title">efi</span> -&gt; /<span class="title">var</span>/<span class="title">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">grub</span>-<span class="title">x86</span>.<span class="title">efi</span></span></span><br><span class="line">trying hardlink /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">loaders</span>/<span class="title">grub</span>-<span class="title">x86_64</span>.<span class="title">efi</span> -&gt; /<span class="title">var</span>/<span class="title">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">grub</span>-<span class="title">x86_64</span>.<span class="title">efi</span></span></span><br><span class="line">copying distros to tftpboot</span><br><span class="line">copying files <span class="keyword">for</span> <span class="symbol">distro:</span> centos6.<span class="number">9</span>-x86_64</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/vmlinuz -&gt; <span class="regexp">/var/lib</span><span class="regexp">/tftpboot/images</span><span class="regexp">/centos6.9-x86_64/vmlinuz</span></span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/initrd.img -&gt; <span class="regexp">/var/lib</span><span class="regexp">/tftpboot/images</span><span class="regexp">/centos6.9-x86_64/initrd</span>.img</span><br><span class="line">copying images</span><br><span class="line">generating PXE configuration files</span><br><span class="line">generating PXE menu structure</span><br><span class="line">copying files <span class="keyword">for</span> <span class="symbol">distro:</span> centos6.<span class="number">9</span>-x86_64</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/vmlinuz -&gt; <span class="regexp">/var/www</span><span class="regexp">/cobbler/images</span><span class="regexp">/centos6.9-x86_64/vmlinuz</span></span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/initrd.img -&gt; <span class="regexp">/var/www</span><span class="regexp">/cobbler/images</span><span class="regexp">/centos6.9-x86_64/initrd</span>.img</span><br><span class="line">Writing template files <span class="keyword">for</span> centos6.<span class="number">9</span>-x86_64</span><br><span class="line">rendering DHCP files</span><br><span class="line">generating /etc/dhcp/dhcpd.conf</span><br><span class="line">rendering TFTPD files</span><br><span class="line">generating /etc/xinetd.d/tftp</span><br><span class="line">processing boot_files <span class="keyword">for</span> <span class="symbol">distro:</span> centos6.<span class="number">9</span>-x86_64</span><br><span class="line">cleaning link caches</span><br><span class="line">running post-sync triggers</span><br><span class="line">running python triggers from /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">triggers</span>/<span class="title">sync</span>/<span class="title">post</span>/*</span></span><br><span class="line">running python trigger cobbler.modules.sync_post_restart_services</span><br><span class="line"><span class="symbol">running:</span> dhcpd -t -q</span><br><span class="line">received on <span class="symbol">stdout:</span> </span><br><span class="line">received on <span class="symbol">stderr:</span> </span><br><span class="line"><span class="symbol">running:</span> service dhcpd restart</span><br><span class="line">received on <span class="symbol">stdout:</span> </span><br><span class="line">received on <span class="symbol">stderr:</span> Redirecting to /bin/systemctl restart dhcpd.service</span><br><span class="line"></span><br><span class="line">running shell triggers from /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">triggers</span>/<span class="title">sync</span>/<span class="title">post</span>/*</span></span><br><span class="line">running python triggers from /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">triggers</span>/<span class="title">change</span>/*</span></span><br><span class="line">running python trigger cobbler.modules.manage_genders</span><br><span class="line">running python trigger cobbler.modules.scm_track</span><br><span class="line">running shell triggers from /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">triggers</span>/<span class="title">change</span>/*</span></span><br><span class="line">*** TASK COMPLETE ***</span><br></pre></td></tr></table></figure><p>这时候创建一个新虚拟机可以获取到如下信息，没有镜像选择，只能从本地启动<br><img src="/2019/06/12/Cobbler自动化部署/cobbler03.png" alt></p><h3 id="cobbler命令帮助"><a href="#cobbler命令帮助" class="headerlink" title="cobbler命令帮助"></a>cobbler命令帮助</h3><table><thead><tr><th>命令</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>cobbler check</td><td style="text-align:left">核对当前设置是否有问题</td></tr><tr><td>cobbler list</td><td style="text-align:left">列出所有的cobbler元素</td></tr><tr><td>cobbler report</td><td style="text-align:left">列出元素的详细信息</td></tr><tr><td>cobbler sync</td><td style="text-align:left">同步配置到数据目录，更改配置最好都执行一下</td></tr><tr><td>cobbler reposync</td><td style="text-align:left">同步yum仓库</td></tr><tr><td>cobbler distro</td><td style="text-align:left">查看导入的发行版系统信息</td></tr><tr><td>cobbler system</td><td style="text-align:left">查看添加的系统信息</td></tr><tr><td>cobbler profile</td><td style="text-align:left">查看配置信息</td></tr></tbody></table><h2 id="cobbler配置安装centos6-x"><a href="#cobbler配置安装centos6-x" class="headerlink" title="cobbler配置安装centos6.x"></a>cobbler配置安装centos6.x</h2><blockquote><p>由于我这里实在<code>centos7</code>系统上面配置的<code>cobbler</code>，所以上传了一个<code>centos6</code>的镜像并进行挂载。</p></blockquote><p>1）创建挂载点，并进行挂载<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># mkdir /centos6</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># mount -o loop CentOS-6.9-x86_64-bin-DVD1.iso /centos6</span></span><br></pre></td></tr></table></figure></p><p>2）查看挂载后的目录<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="meta"># ls /centos6/</span></span><br><span class="line">CentOS_BuildTag  images                    repodata                       RPM-GPG-<span class="keyword">KEY</span>-CentOS-Testing<span class="number">-6</span></span><br><span class="line">EFI              isolinux                  RPM-GPG-<span class="keyword">KEY</span>-CentOS<span class="number">-6</span>           TRANS.TBL</span><br><span class="line">EULA             Packages                  RPM-GPG-<span class="keyword">KEY</span>-CentOS-Debug<span class="number">-6</span></span><br><span class="line">GPL              RELEASE-NOTES-en-US.html  RPM-GPG-<span class="keyword">KEY</span>-CentOS-Security<span class="number">-6</span></span><br></pre></td></tr></table></figure></p><p>3）导入镜像<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler import <span class="attribute">--path</span>=/centos6 <span class="attribute">--name</span>=centos6.9 <span class="attribute">--arch</span>=x86_64</span><br><span class="line"><span class="comment"># --path 镜像路径</span></span><br><span class="line"><span class="comment"># --name 为安装源定义一个名字</span></span><br><span class="line"><span class="comment"># --arch 指定安装源是32位、64位、ia64, 目前支持的选项有: x86│x86_64│ia64</span></span><br><span class="line"><span class="comment"># 安装源的唯一标示就是根据name参数来定义，本例导入成功后，安装源的唯一标示就是：centos6.9，如果重复，系统会提示导入失败。</span></span><br></pre></td></tr></table></figure></p><p>4）查看导入后镜像信息<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler distro report <span class="comment">--name=centos6.9-x86_64</span></span><br><span class="line">Name                           : <span class="type">centos6.9</span>-x86_64</span><br><span class="line">Architecture                   : <span class="type">x86_64</span></span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Breed                          : <span class="type">redhat</span></span><br><span class="line">Comment                        : </span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Initrd                         : /<span class="type">var</span>/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/initrd.img</span><br><span class="line">Kernel                         : /<span class="type">var</span>/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/vmlinuz</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart Metadata             : &#123;'<span class="type">tree</span>': <span class="symbol">'http</span>://@@http_server@@/cblr/links/centos6.<span class="number">9</span>-x86_64'&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">OS Version                     : <span class="type">rhel6</span></span><br><span class="line">Owners                         : ['<span class="type">admin</span>']</span><br><span class="line">Red Hat Management Key         : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br></pre></td></tr></table></figure></p><p>5）查看<code>profile</code>信息<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler profile report <span class="comment">--name=centos6.9-x86_64</span></span><br><span class="line">Name                           : <span class="type">centos6.9</span>-x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        : </span><br><span class="line">DHCP Tag                       : <span class="type">default</span></span><br><span class="line">Distribution                   : <span class="type">centos6.9</span>-x86_64</span><br><span class="line">Enable gPXE?                   : 0</span><br><span class="line">Enable PXE Menu?               : 1</span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart                      : /<span class="type">var</span>/lib/cobbler/kickstarts/sample_end.ks</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">Management Parameters          : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Owners                         : ['<span class="type">admin</span>']</span><br><span class="line">Parent Profile                 : </span><br><span class="line">Internal proxy                 : </span><br><span class="line">Red Hat Management Key         : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Repos                          : []</span><br><span class="line">Server Override                : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line">Virt Auto Boot                 : 1</span><br><span class="line">Virt Bridge                    : <span class="type">xenbr0</span></span><br><span class="line">Virt CPUs                      : 1</span><br><span class="line">Virt Disk Driver <span class="keyword">Type</span>          <span class="type">: </span>raw</span><br><span class="line">Virt File Size(GB)             : 5</span><br><span class="line">Virt Path                      : </span><br><span class="line">Virt RAM (MB)                  : 512</span><br><span class="line">Virt <span class="keyword">Type</span>                      <span class="type">: </span>kvm</span><br></pre></td></tr></table></figure></p><p>6）<code>copy</code>一份<code>profile</code>文件(<code>ks</code>)，进行修改<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="comment"># cd /var/lib/cobbler/kickstarts/</span></span><br><span class="line">[root@cobbler kickstarts]<span class="comment"># ls</span></span><br><span class="line">default.ks    install_profiles  sample_autoyast.xml  sample_esxi4.ks  sample.ks</span><br><span class="line">esxi4-ks.cfg  legacy.ks         sample_end.ks        sample_esxi5.ks  sample_old.seed</span><br><span class="line">esxi5-ks.cfg  pxerescue.ks      sample_esx4.ks       sample_esxi6.ks  sample.seed</span><br><span class="line">[root@cobbler kickstarts]<span class="comment"># cp sample_end.ks centos6.ks</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑centos6的kickstart文件</span></span><br><span class="line">[root@cobbler kickstarts]<span class="comment"># vim centos6.ks </span></span><br><span class="line"><span class="comment"># This kickstart file should only be used with EL &gt; 5 and/or Fedora &gt; 7.</span></span><br><span class="line"><span class="comment"># For older versions please use the sample.ks kickstart file.</span></span><br><span class="line"><span class="comment"># Install OS instead of upgrade</span></span><br><span class="line">install</span><br><span class="line"><span class="comment"># Use text mode install</span></span><br><span class="line">text</span><br><span class="line"><span class="comment"># System keyboard</span></span><br><span class="line">keyboard us</span><br><span class="line"><span class="comment"># System language</span></span><br><span class="line">lang en_US</span><br><span class="line"><span class="comment"># System timezone</span></span><br><span class="line">timezone  Asia/ShangHai</span><br><span class="line"><span class="comment">#Root password</span></span><br><span class="line">rootpw --iscrypted $default_password_crypted</span><br><span class="line"><span class="comment"># System authorization information</span></span><br><span class="line">auth  --useshadow  --enablemd5</span><br><span class="line"><span class="comment"># Firewall configuration</span></span><br><span class="line">firewall --disabled</span><br><span class="line"><span class="comment"># SELinux configuration</span></span><br><span class="line">selinux --disabled</span><br><span class="line"><span class="comment"># Use network installation</span></span><br><span class="line">url --url=$tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clear the Master Boot Record</span></span><br><span class="line">zerombr</span><br><span class="line"><span class="comment"># System bootloader configuration</span></span><br><span class="line">bootloader --location=mbr</span><br><span class="line"><span class="comment"># Partition clearing information</span></span><br><span class="line">clearpart --all --initlabel</span><br><span class="line">part /boot --fstype=ext4 --size=<span class="number">500</span></span><br><span class="line">part swap --fstype=swap --size=<span class="number">2048</span></span><br><span class="line">part / --fstype=ext4 --grow --size=<span class="number">200</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># If any cobbler repo definitions were referenced in the kickstart profile, include them here.</span></span><br><span class="line">$yum_repo_stanza</span><br><span class="line"><span class="comment"># Network information</span></span><br><span class="line">$SNIPPET(<span class="string">'network_config'</span>)</span><br><span class="line"><span class="comment"># Do not configure the X Window System</span></span><br><span class="line">skipx</span><br><span class="line"><span class="comment"># Run the Setup Agent on first boot</span></span><br><span class="line">firstboot --disable</span><br><span class="line"><span class="comment"># Reboot after installation</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%pre</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_pre'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'kickstart_start'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'pre_install_network_config'</span>)</span><br><span class="line"><span class="comment"># Enable installation monitoring</span></span><br><span class="line">$SNIPPET(<span class="string">'pre_anamon'</span>)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">$SNIPPET(<span class="string">'func_install_if_enabled'</span>)</span><br><span class="line">@core</span><br><span class="line">@base</span><br><span class="line">tree</span><br><span class="line">nmap</span><br><span class="line">wget</span><br><span class="line">lftp</span><br><span class="line">lrzsz</span><br><span class="line">telnet</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post --nochroot</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_post_nochroot'</span>)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_post'</span>)</span><br><span class="line"><span class="comment"># Start yum configuration</span></span><br><span class="line">$yum_config_stanza</span><br><span class="line"><span class="comment"># End yum configuration</span></span><br><span class="line">$SNIPPET(<span class="string">'post_install_kernel_options'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'post_install_network_config'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'func_register_if_enabled'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'download_config_files'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'koan_environment'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'redhat_register'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'cobbler_register'</span>)</span><br><span class="line"><span class="comment"># Enable post-install boot notification</span></span><br><span class="line">$SNIPPET(<span class="string">'post_anamon'</span>)</span><br><span class="line"><span class="comment"># Start final steps</span></span><br><span class="line">$SNIPPET(<span class="string">'kickstart_done'</span>)</span><br><span class="line"><span class="comment"># End final steps</span></span><br><span class="line"></span><br><span class="line">sed -ri <span class="string">"/^#UseDNS/c\UseDNS no"</span> /etc/ssh/sshd_config</span><br><span class="line">sed -ri <span class="string">"/^GSSAPIAuthentication/c\GSSAPIAuthentication no"</span> /etc/ssh/sshd_config</span><br><span class="line">%end</span><br></pre></td></tr></table></figure></p><p>7）编辑<code>centos6</code>镜像所使用的<code>kickstart</code>文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 动态编辑指定使用新的kickstart文件</span></span><br><span class="line">[root@cobbler ~]# cobbler<span class="built_in"> profile </span><span class="builtin-name">edit</span> <span class="attribute">--name</span>=centos6.9-x86_64 <span class="attribute">--kickstart</span>=/var/lib/cobbler/kickstarts/centos6.ks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证是否更改成功</span></span><br><span class="line">[root@cobbler ~]# cobbler<span class="built_in"> profile </span>report <span class="attribute">--name</span>=centos6.9-x86_64 |grep Kickstart</span><br><span class="line">Kickstart                      : /var/lib/cobbler/kickstarts/centos6.ks</span><br></pre></td></tr></table></figure></p><p>8）再次同步<code>cobbler</code>配置<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler sync</span></span><br></pre></td></tr></table></figure></p><p>9）新建虚拟机进行测试<br><img src="/2019/06/12/Cobbler自动化部署/cobbler04.png" alt><br>选择<code>centos6.9</code>进行安装，会按照<code>kickstart</code>文件安装并启动<br><img src="/2019/06/12/Cobbler自动化部署/cobbler05.png" alt></p><h2 id="cobbler配置安装centos7-x"><a href="#cobbler配置安装centos7-x" class="headerlink" title="cobbler配置安装centos7.x"></a>cobbler配置安装centos7.x</h2><blockquote><p>我这里cobbler服务器就是7的系统，所以直接挂载/dev/cdrom即可</p></blockquote><p>1）创建挂载点，并进行挂载<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># mkdir /centos7</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># mount -o loop /dev/cdrom /centos7</span></span><br></pre></td></tr></table></figure></p><p>2）查看挂载后的目录<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="meta"># ls /centos7/</span></span><br><span class="line">CentOS_BuildTag  EULA  images    LiveOS    repodata              RPM-GPG-<span class="keyword">KEY</span>-CentOS-Testing<span class="number">-7</span></span><br><span class="line">EFI              GPL   isolinux  Packages  RPM-GPG-<span class="keyword">KEY</span>-CentOS<span class="number">-7</span>  TRANS.TBL</span><br></pre></td></tr></table></figure></p><p>3）导入镜像<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@cobbler</span> ~]<span class="comment"># cobbler import --path=/centos7 --name=centos7.4 --arch=x86_64</span></span><br><span class="line">task <span class="symbol">started:</span> <span class="number">2019</span>-<span class="number">06</span>-<span class="number">12_165812_</span><span class="keyword">import</span></span><br><span class="line">task started (id=Media <span class="keyword">import</span>, time=Wed Jun <span class="number">12</span> <span class="number">16</span><span class="symbol">:</span><span class="number">58</span><span class="symbol">:</span><span class="number">12</span> <span class="number">2019</span>)</span><br><span class="line">Found a candidate <span class="symbol">signature:</span> breed=redhat, version=rhel6</span><br><span class="line">Found a candidate <span class="symbol">signature:</span> breed=redhat, version=rhel7</span><br><span class="line">Found a matching <span class="symbol">signature:</span> breed=redhat, version=rhel7</span><br><span class="line">Adding distros from path /var/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-<span class="symbol">x86_64:</span></span><br><span class="line">creating new <span class="symbol">distro:</span> centos7.<span class="number">4</span>-x86_64</span><br><span class="line">trying <span class="symbol">symlink:</span> /var/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64 -&gt; /var/www/cobbler/links/centos7.<span class="number">4</span>-x86_64</span><br><span class="line">creating new <span class="symbol">profile:</span> centos7.<span class="number">4</span>-x86_64</span><br><span class="line">associating repos</span><br><span class="line">checking <span class="keyword">for</span> rsync repo(s)</span><br><span class="line">checking <span class="keyword">for</span> rhn repo(s)</span><br><span class="line">checking <span class="keyword">for</span> yum repo(s)</span><br><span class="line">starting descent into /var/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64 <span class="keyword">for</span> centos7.<span class="number">4</span>-x86_64</span><br><span class="line">processing repo at : <span class="regexp">/var/www</span><span class="regexp">/cobbler/ks</span>_mirror/centos7.<span class="number">4</span>-x86_64</span><br><span class="line">need to process repo/<span class="symbol">comps:</span> /var/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64</span><br><span class="line">looking <span class="keyword">for</span> /var/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64/repodata/*comps*.xml</span><br><span class="line">Keeping repodata as-is <span class="symbol">:/var/www/cobbler/ks_mirror/centos7</span>.<span class="number">4</span>-x86_64/repodata</span><br><span class="line">*** TASK COMPLETE ***</span><br></pre></td></tr></table></figure></p><p>4）查看导入后镜像信息<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler distro report <span class="comment">--name=centos7.4-x86_64</span></span><br><span class="line">Name                           : <span class="type">centos7.4</span>-x86_64</span><br><span class="line">Architecture                   : <span class="type">x86_64</span></span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Breed                          : <span class="type">redhat</span></span><br><span class="line">Comment                        : </span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Initrd                         : /<span class="type">var</span>/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64/images/pxeboot/initrd.img</span><br><span class="line">Kernel                         : /<span class="type">var</span>/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64/images/pxeboot/vmlinuz</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart Metadata             : &#123;'<span class="type">tree</span>': <span class="symbol">'http</span>://@@http_server@@/cblr/links/centos7.<span class="number">4</span>-x86_64'&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">OS Version                     : <span class="type">rhel7</span></span><br><span class="line">Owners                         : ['<span class="type">admin</span>']</span><br><span class="line">Red Hat Management Key         : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br></pre></td></tr></table></figure></p><p>5）查看<code>profile</code>信息<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler profile report <span class="comment">--name=centos7.4-x86_64</span></span><br><span class="line">Name                           : <span class="type">centos7.4</span>-x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        : </span><br><span class="line">DHCP Tag                       : <span class="type">default</span></span><br><span class="line">Distribution                   : <span class="type">centos7.4</span>-x86_64</span><br><span class="line">Enable gPXE?                   : 0</span><br><span class="line">Enable PXE Menu?               : 1</span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart                      : /<span class="type">var</span>/lib/cobbler/kickstarts/sample_end.ks</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">Management Parameters          : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Owners                         : ['<span class="type">admin</span>']</span><br><span class="line">Parent Profile                 : </span><br><span class="line">Internal proxy                 : </span><br><span class="line">Red Hat Management Key         : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Repos                          : []</span><br><span class="line">Server Override                : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line">Virt Auto Boot                 : 1</span><br><span class="line">Virt Bridge                    : <span class="type">xenbr0</span></span><br><span class="line">Virt CPUs                      : 1</span><br><span class="line">Virt Disk Driver <span class="keyword">Type</span>          <span class="type">: </span>raw</span><br><span class="line">Virt File Size(GB)             : 5</span><br><span class="line">Virt Path                      : </span><br><span class="line">Virt RAM (MB)                  : 512</span><br><span class="line">Virt <span class="keyword">Type</span>                      <span class="type">: </span>kvm</span><br></pre></td></tr></table></figure></p><p>7）<code>copy</code>一份<code>profile</code>文件( <code>ks</code> )，进行修改,这里直接copy上面6的了，然后修改修改即可<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="comment"># cd /var/lib/cobbler/kickstarts/</span></span><br><span class="line">[root@cobbler kickstarts]<span class="comment"># cp centos6.ks centos7.ks</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑centos7的kickstart文件</span></span><br><span class="line">[root@cobbler kickstarts]<span class="comment"># vim centos7.ks</span></span><br><span class="line"><span class="comment"># This kickstart file should only be used with EL &gt; 5 and/or Fedora &gt; 7.</span></span><br><span class="line"><span class="comment"># For older versions please use the sample.ks kickstart file.</span></span><br><span class="line"><span class="comment"># Install OS instead of upgrade</span></span><br><span class="line">install</span><br><span class="line"><span class="comment"># Use text mode install</span></span><br><span class="line">text</span><br><span class="line"><span class="comment"># System keyboard</span></span><br><span class="line">keyboard us</span><br><span class="line"><span class="comment"># System language</span></span><br><span class="line">lang en_US</span><br><span class="line"><span class="comment"># System timezone</span></span><br><span class="line">timezone  Asia/ShangHai</span><br><span class="line"><span class="comment">#Root password</span></span><br><span class="line">rootpw --iscrypted $default_password_crypted</span><br><span class="line"><span class="comment"># System authorization information</span></span><br><span class="line">auth  --useshadow  --enablemd5</span><br><span class="line"><span class="comment"># Firewall configuration</span></span><br><span class="line">firewall --disabled</span><br><span class="line"><span class="comment"># SELinux configuration</span></span><br><span class="line">selinux --disabled</span><br><span class="line"><span class="comment"># Use network installation</span></span><br><span class="line">url --url=$tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clear the Master Boot Record</span></span><br><span class="line">zerombr</span><br><span class="line"><span class="comment"># System bootloader configuration</span></span><br><span class="line">bootloader --location=mbr</span><br><span class="line"><span class="comment"># Partition clearing information</span></span><br><span class="line">clearpart --all --initlabel</span><br><span class="line">part /boot --fstype=xfs --size=<span class="number">500</span></span><br><span class="line">part swap --fstype=swap --size=<span class="number">2048</span></span><br><span class="line">part / --fstype=xfs --grow --size=<span class="number">200</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># If any cobbler repo definitions were referenced in the kickstart profile, include them here.</span></span><br><span class="line">$yum_repo_stanza</span><br><span class="line"><span class="comment"># Network information</span></span><br><span class="line">$SNIPPET(<span class="string">'network_config'</span>)</span><br><span class="line"><span class="comment"># Do not configure the X Window System</span></span><br><span class="line">skipx</span><br><span class="line"><span class="comment"># Run the Setup Agent on first boot</span></span><br><span class="line">firstboot --disable</span><br><span class="line"><span class="comment"># Reboot after installation</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%pre</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_pre'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'kickstart_start'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'pre_install_network_config'</span>)</span><br><span class="line"><span class="comment"># Enable installation monitoring</span></span><br><span class="line">$SNIPPET(<span class="string">'pre_anamon'</span>)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">$SNIPPET(<span class="string">'func_install_if_enabled'</span>)</span><br><span class="line">@core</span><br><span class="line">@base</span><br><span class="line">tree</span><br><span class="line">nmap</span><br><span class="line">wget</span><br><span class="line">lftp</span><br><span class="line">lrzsz</span><br><span class="line">telnet</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post --nochroot</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_post_nochroot'</span>)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_post'</span>)</span><br><span class="line"><span class="comment"># Start yum configuration</span></span><br><span class="line">$yum_config_stanza</span><br><span class="line"><span class="comment"># End yum configuration</span></span><br><span class="line">$SNIPPET(<span class="string">'post_install_kernel_options'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'post_install_network_config'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'func_register_if_enabled'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'download_config_files'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'koan_environment'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'redhat_register'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'cobbler_register'</span>)</span><br><span class="line"><span class="comment"># Enable post-install boot notification</span></span><br><span class="line">$SNIPPET(<span class="string">'post_anamon'</span>)</span><br><span class="line"><span class="comment"># Start final steps</span></span><br><span class="line">$SNIPPET(<span class="string">'kickstart_done'</span>)</span><br><span class="line"><span class="comment"># End final steps</span></span><br><span class="line"></span><br><span class="line">sed -ri <span class="string">"/^#UseDNS/c\UseDNS no"</span> /etc/ssh/sshd_config</span><br><span class="line">sed -ri <span class="string">"/^GSSAPIAuthentication/c\GSSAPIAuthentication no"</span> /etc/ssh/sshd_config</span><br><span class="line">%end</span><br></pre></td></tr></table></figure></p><p>7）编辑<code>centos7</code>镜像所使用的<code>kickstart</code>文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 动态编辑指定使用新的kickstart文件</span></span><br><span class="line">[root@cobbler ~]# cobbler<span class="built_in"> profile </span><span class="builtin-name">edit</span> <span class="attribute">--name</span>=centos7.4-x86_64 <span class="attribute">--kickstart</span>=/var/lib/cobbler/kickstarts/centos7.ks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证是否更改成功</span></span><br><span class="line">[root@cobbler ~]# cobbler<span class="built_in"> profile </span>report <span class="attribute">--name</span>=centos7.4-x86_64 |grep Kickstart</span><br><span class="line">Kickstart                      : /var/lib/cobbler/kickstarts/centos7.ks</span><br></pre></td></tr></table></figure></p><p>8）再次同步<code>cobbler</code>配置<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler sync</span></span><br></pre></td></tr></table></figure></p><p>9）新建虚拟机进行测试<br><img src="/2019/06/12/Cobbler自动化部署/cobbler06.png" alt><br>选择<code>centos7.4</code>进行安装即可<br><img src="/2019/06/12/Cobbler自动化部署/cobbler07.png" alt></p><blockquote><p>说明：在<code>client</code>端系统安装时，可以在<code>cobbler</code>服务端上查看日志<code>/var/log/messages</code>，观察安装的每一个<code>cobbler</code>流程</p></blockquote><h2 id="cobbler-Web管理界面配置"><a href="#cobbler-Web管理界面配置" class="headerlink" title="cobbler Web管理界面配置"></a>cobbler Web管理界面配置</h2><blockquote><p><code>web</code>界面有很多功能，包括上传镜像、编辑<code>kickstart</code>、等等很多在命令行操作的都可以在<code>web</code>界面直接操作。<br>在上面已经安装了<code>cobbler-web</code>软件，访问地址：<a href="https://IP/cobbler_web" target="_blank" rel="noopener">https://IP/cobbler_web</a> 即可。默认账号为<code>cobbler</code>，密码也为<code>cobbler</code></p></blockquote><p><img src="/2019/06/12/Cobbler自动化部署/cobbler08.png" alt></p><p><strong>修改密码</strong><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/etc/cobbler/users.conf     <span class="meta">#Web服务授权配置文件</span></span><br><span class="line">/etc/cobbler/users.digest   <span class="meta">#用于web访问的用户名密码</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cat /etc/cobbler/users.digest </span></span><br><span class="line">cobbler:Cobbler:a2d6bae81669d707b72c0bd9806e01f3</span><br><span class="line"></span><br><span class="line"><span class="meta"># 设置密码，在Cobbler组添加cobbler用户，输入2遍密码确</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># htdigest /etc/cobbler/users.digest <span class="string">"Cobbler"</span> cobbler</span></span><br><span class="line">Changing password <span class="keyword">for</span> user cobbler <span class="keyword">in</span> realm Cobbler</span><br><span class="line">New password: superman</span><br><span class="line">Re-type new password: superman</span><br><span class="line"></span><br><span class="line"><span class="meta"># 同步配置并重启httpd、cobbler</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler sync</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl restart httpd</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl restart cobblerd</span></span><br></pre></td></tr></table></figure></p><p>再次登录即使用新设置的密码登录即可。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;cobbler简介&quot;&gt;&lt;a href=&quot;#cobbler简介&quot; class=&quot;headerlink&quot; title=&quot;cobbler简介&quot;&gt;&lt;/a&gt;cobbler简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;Cobbler&lt;/code&gt; 可以用来快速建立
      
    
    </summary>
    
      <category term="Cobbler" scheme="https://leeyj.coding.me/categories/Cobbler/"/>
    
    
      <category term="Cobbler" scheme="https://leeyj.coding.me/tags/Cobbler/"/>
    
  </entry>
  
  <entry>
    <title>Ansible项目实战lnmp</title>
    <link href="https://leeyj.coding.me/2019/06/05/Ansible%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98lnmp/"/>
    <id>https://leeyj.coding.me/2019/06/05/Ansible项目实战lnmp/</id>
    <published>2019-06-05T04:10:22.000Z</published>
    <updated>2019-07-10T01:46:29.906Z</updated>
    
    <content type="html"><![CDATA[<h2 id="项目规划"><a href="#项目规划" class="headerlink" title="项目规划"></a>项目规划</h2><blockquote><p>通过<code>ansible roles</code>配置<code>lnmp</code>环境，<code>nginx</code>通过源码编译安装，<code>php</code>通过源码编译安装，<code>mysql</code>通过<code>yum</code>安装（<code>mysql</code>源码编译超级慢）支持系统（<code>centos6.x</code>和<code>centos7.x</code>系列）</p></blockquote><blockquote><p><strong>说明:</strong>将nginx和php源码包放到对应的角色文件下的files目录下，通过vars/main.yml控制安装的版本和路径。如下：</p></blockquote><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible roles]<span class="meta"># cat nginx/vars/main.yml </span></span><br><span class="line"><span class="symbol">DOWNLOAD_DIR:</span> <span class="string">"/usr/local/src/"</span>  <span class="meta">#软件包拷贝到目标主机的存放路径</span></span><br><span class="line"><span class="symbol">INSTALL_DIR:</span> <span class="string">"/usr/local/"</span>       <span class="meta">#安装路径</span></span><br><span class="line"><span class="symbol">NGINX_VERSION:</span> <span class="string">"1.12.2"</span>          <span class="meta">#软件包版本</span></span><br><span class="line"><span class="symbol">USER:</span> <span class="string">"nginx"</span>                    <span class="meta">#运行的用户</span></span><br><span class="line"><span class="symbol">GROUP:</span> <span class="string">"nginx"</span>                   <span class="meta">#运行的组</span></span><br></pre></td></tr></table></figure><p><a href="https://buji595.github.io/2019/05/26/Ansible%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" target="_blank" rel="noopener">环境配置参考</a></p><h2 id="角色编写"><a href="#角色编写" class="headerlink" title="角色编写"></a>角色编写</h2><blockquote><p>这里角色都统一放在了<code>/etc/ansible/roles</code>下</p></blockquote><p>安装编译时所需要用到的依赖包<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible roles]# cat init_pkg.yml </span><br><span class="line">#安装源码编译php、nginx时所需要用到的依赖包</span><br><span class="line">-<span class="ruby">--</span></span><br><span class="line"><span class="ruby">- <span class="symbol">hosts:</span> all </span></span><br><span class="line"><span class="ruby">  <span class="symbol">remote_user:</span> root</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">  <span class="symbol">tasks:</span></span></span><br><span class="line"><span class="ruby">    - <span class="symbol">name:</span> Install Package</span></span><br><span class="line"><span class="ruby">      <span class="symbol">yum:</span> name=&#123;&#123; item &#125;&#125; state=installed</span></span><br><span class="line"><span class="ruby">      <span class="symbol">with_items:</span></span></span><br><span class="line"><span class="ruby">        - gcc-c++</span></span><br><span class="line"><span class="ruby">        - glibc</span></span><br><span class="line"><span class="ruby">        - glibc-devel</span></span><br><span class="line"><span class="ruby">        - glib2</span></span><br><span class="line"><span class="ruby">        - glib2-devel</span></span><br><span class="line"><span class="ruby">        - pcre</span></span><br><span class="line"><span class="ruby">        - pcre-devel</span></span><br><span class="line"><span class="ruby">        - zlib</span></span><br><span class="line"><span class="ruby">        - zlib-devel</span></span><br><span class="line"><span class="ruby">        - openssl</span></span><br><span class="line"><span class="ruby">        - openssl-devel</span></span><br><span class="line"><span class="ruby">        - libpng</span></span><br><span class="line"><span class="ruby">        - libpng-devel</span></span><br><span class="line"><span class="ruby">        - freetype</span></span><br><span class="line"><span class="ruby">        - freetype-devel</span></span><br><span class="line"><span class="ruby">        - libxml2</span></span><br><span class="line"><span class="ruby">        - libxml2-devel</span></span><br><span class="line"><span class="ruby">        - bzip2</span></span><br><span class="line"><span class="ruby">        - bzip2-devel</span></span><br><span class="line"><span class="ruby">        - ncurses</span></span><br><span class="line"><span class="ruby">        - curl</span></span><br><span class="line"><span class="ruby">        - gdbm-devel</span></span><br><span class="line"><span class="ruby">        - libXpm-devel</span></span><br><span class="line"><span class="ruby">        - libX11-devel</span></span><br><span class="line"><span class="ruby">        - gd-devel</span></span><br><span class="line"><span class="ruby">        - gmp-devel</span></span><br><span class="line"><span class="ruby">        - readline-devel</span></span><br><span class="line"><span class="ruby">        - libxslt-devel</span></span><br><span class="line"><span class="ruby">        - expat-devel</span></span><br><span class="line"><span class="ruby">        - xmlrpc-c</span></span><br><span class="line"><span class="ruby">        - libcurl-devel</span></span><br></pre></td></tr></table></figure></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># cd /etc/ansible/roles/</span></span><br></pre></td></tr></table></figure><h3 id="nginx-roles"><a href="#nginx-roles" class="headerlink" title="nginx roles"></a>nginx roles</h3><p>1）创建相应文件夹<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># mkdir -p nginx/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p><p>2）最终编写效果<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">tree</span> <span class="selector-tag">nginx</span></span><br><span class="line"><span class="selector-tag">nginx</span></span><br><span class="line">├── <span class="selector-tag">files</span></span><br><span class="line">│   ├── <span class="selector-tag">nginx-1</span><span class="selector-class">.12</span><span class="selector-class">.2</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">│   └── <span class="selector-tag">nginx-1</span><span class="selector-class">.16</span><span class="selector-class">.0</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">├── <span class="selector-tag">handlers</span></span><br><span class="line">│   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">tasks</span></span><br><span class="line">│   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">copypkg</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">group</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">│   └── <span class="selector-tag">user</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">templates</span></span><br><span class="line">│   ├── <span class="selector-tag">nginx</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">│   ├── <span class="selector-tag">nginx_init</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">nginx</span><span class="selector-class">.service</span><span class="selector-class">.j2</span></span><br><span class="line">└── <span class="selector-tag">vars</span></span><br><span class="line">    └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line"></span><br><span class="line">5 <span class="selector-tag">directories</span>, 14 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure></p><h3 id="php-roles"><a href="#php-roles" class="headerlink" title="php roles"></a>php roles</h3><p>1）创建相应文件夹<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># mkdir -p php/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p><p>2）最终编写效果<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">tree</span> <span class="selector-tag">php</span></span><br><span class="line"><span class="selector-tag">php</span></span><br><span class="line">├── <span class="selector-tag">files</span></span><br><span class="line">│   └── <span class="selector-tag">php-5</span><span class="selector-class">.6</span><span class="selector-class">.40</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">├── <span class="selector-tag">handlers</span></span><br><span class="line">│   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">tasks</span></span><br><span class="line">│   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">copypkg</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">group</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">│   └── <span class="selector-tag">user</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">templates</span></span><br><span class="line">│   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">│   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.init</span><span class="selector-class">.j2</span></span><br><span class="line">│   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.service</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">php</span><span class="selector-class">.ini</span><span class="selector-class">.j2</span></span><br><span class="line">└── <span class="selector-tag">vars</span></span><br><span class="line">    └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line"></span><br><span class="line">5 <span class="selector-tag">directories</span>, 14 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure></p><h3 id="mysql-roles"><a href="#mysql-roles" class="headerlink" title="mysql roles"></a>mysql roles</h3><p>1）创建相应文件夹<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># mkdir -p mysql/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p><p>2）最终编写效果<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">tree</span> <span class="selector-tag">mysql</span></span><br><span class="line"><span class="selector-tag">mysql</span></span><br><span class="line">├── <span class="selector-tag">files</span></span><br><span class="line">├── <span class="selector-tag">handlers</span></span><br><span class="line">│   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">tasks</span></span><br><span class="line">│   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   └── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">templates</span></span><br><span class="line">│   ├── <span class="selector-tag">my</span><span class="selector-class">.cnf6</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">my</span><span class="selector-class">.cnf7</span><span class="selector-class">.j2</span></span><br><span class="line">└── <span class="selector-tag">vars</span></span><br><span class="line"></span><br><span class="line">5 <span class="selector-tag">directories</span>, 7 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure></p><h3 id="角色执行playbook文件编写"><a href="#角色执行playbook文件编写" class="headerlink" title="角色执行playbook文件编写"></a>角色执行playbook文件编写</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">cat</span> <span class="string">nginx_roles.yml</span> </span><br><span class="line"><span class="comment">#源码编译安装nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">cat</span> <span class="string">php_roles.yml</span> </span><br><span class="line"><span class="comment">#源码编译安装nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">cat</span> <span class="string">mysql_roles.yml</span> </span><br><span class="line"><span class="comment">#yum安装MySQL</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">mysql</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">cat</span> <span class="string">lnmp.yml</span> </span><br><span class="line"><span class="comment">#配置lnmp,创建虚拟主机</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">php</span> </span><br><span class="line"><span class="attr">    - role:</span> <span class="string">mysql</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    PORT:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">    WEBDIR:</span> <span class="string">"/opt/www"</span></span><br><span class="line"><span class="attr">    CONFIGDIR:</span> <span class="string">"/usr/local/nginx/conf/conf.d"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">vhost</span> <span class="string">dir</span></span><br><span class="line"><span class="attr">      file:</span> <span class="string">name=&#123;&#123;</span> <span class="string">WEBDIR</span> <span class="string">&#125;&#125;</span> <span class="string">state=directory</span> <span class="string">owner=www</span> <span class="string">group=www</span> <span class="string">mode=755</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">vhost</span> <span class="string">conf</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=vhost.conf.j2</span> <span class="string">dest=&#123;&#123;</span> <span class="string">CONFIGDIR</span> <span class="string">&#125;&#125;/vhost.conf</span></span><br><span class="line"><span class="attr">      notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">index.php</span></span><br><span class="line"><span class="attr">      shell:</span> <span class="string">"echo '&lt;?php phpinfo(); ?&gt;' &gt; <span class="template-variable">&#123;&#123; WEBDIR &#125;&#125;</span>/index.php"</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># hostslist文件准备，这样方便执行，可以在执行playbook时指定某台机器上运行</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">cat</span> <span class="string">hostlist</span> </span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.36</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#所有文件查看</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">ll</span> </span><br><span class="line"><span class="string">总用量</span> <span class="number">28</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">53</span> <span class="number">6</span><span class="string">月</span>   <span class="number">4</span> <span class="number">22</span><span class="string">:37</span> <span class="string">hostlist</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">824</span> <span class="number">6</span><span class="string">月</span>   <span class="number">5</span> <span class="number">10</span><span class="string">:53</span> <span class="string">init_pkg.yml</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">646</span> <span class="number">6</span><span class="string">月</span>   <span class="number">5</span> <span class="number">12</span><span class="string">:05</span> <span class="string">lnmp.yml</span></span><br><span class="line"><span class="string">drwxr-xr-x.</span> <span class="number">7</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">77</span> <span class="number">6</span><span class="string">月</span>   <span class="number">5</span> <span class="number">10</span><span class="string">:44</span> <span class="string">mysql</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">81</span> <span class="number">6</span><span class="string">月</span>   <span class="number">5</span> <span class="number">10</span><span class="string">:06</span> <span class="string">mysql_roles.yml</span></span><br><span class="line"><span class="string">drwxr-xr-x.</span> <span class="number">7</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">77</span> <span class="number">6</span><span class="string">月</span>   <span class="number">4</span> <span class="number">15</span><span class="string">:37</span> <span class="string">nginx</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">89</span> <span class="number">6</span><span class="string">月</span>   <span class="number">4</span> <span class="number">17</span><span class="string">:10</span> <span class="string">nginx_roles.yml</span></span><br><span class="line"><span class="string">drwxr-xr-x.</span> <span class="number">7</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">77</span> <span class="number">6</span><span class="string">月</span>   <span class="number">4</span> <span class="number">17</span><span class="string">:18</span> <span class="string">php</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">87</span> <span class="number">6</span><span class="string">月</span>   <span class="number">4</span> <span class="number">17</span><span class="string">:37</span> <span class="string">php_roles.yml</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">811</span> <span class="number">6</span><span class="string">月</span>   <span class="number">5</span> <span class="number">11</span><span class="string">:53</span> <span class="string">vhost.conf.j2</span></span><br></pre></td></tr></table></figure><h2 id="所有文件查看"><a href="#所有文件查看" class="headerlink" title="所有文件查看"></a>所有文件查看</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">tree</span> </span><br><span class="line">.</span><br><span class="line">├── <span class="selector-tag">hostlist</span></span><br><span class="line">├── <span class="selector-tag">init_pkg</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">lnmp</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">mysql</span></span><br><span class="line">│   ├── <span class="selector-tag">files</span></span><br><span class="line">│   ├── <span class="selector-tag">handlers</span></span><br><span class="line">│   │   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">tasks</span></span><br><span class="line">│   │   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   └── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">templates</span></span><br><span class="line">│   │   ├── <span class="selector-tag">my</span><span class="selector-class">.cnf6</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   └── <span class="selector-tag">my</span><span class="selector-class">.cnf7</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">vars</span></span><br><span class="line">├── <span class="selector-tag">mysql_roles</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">nginx</span></span><br><span class="line">│   ├── <span class="selector-tag">files</span></span><br><span class="line">│   │   ├── <span class="selector-tag">nginx-1</span><span class="selector-class">.12</span><span class="selector-class">.2</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">│   │   └── <span class="selector-tag">nginx-1</span><span class="selector-class">.16</span><span class="selector-class">.0</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">│   ├── <span class="selector-tag">handlers</span></span><br><span class="line">│   │   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">tasks</span></span><br><span class="line">│   │   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">copypkg</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">group</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   └── <span class="selector-tag">user</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">templates</span></span><br><span class="line">│   │   ├── <span class="selector-tag">nginx</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   ├── <span class="selector-tag">nginx_init</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   └── <span class="selector-tag">nginx</span><span class="selector-class">.service</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">vars</span></span><br><span class="line">│       └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">nginx_roles</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">php</span></span><br><span class="line">│   ├── <span class="selector-tag">files</span></span><br><span class="line">│   │   └── <span class="selector-tag">php-5</span><span class="selector-class">.6</span><span class="selector-class">.40</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">│   ├── <span class="selector-tag">handlers</span></span><br><span class="line">│   │   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">tasks</span></span><br><span class="line">│   │   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">copypkg</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">group</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   └── <span class="selector-tag">user</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">templates</span></span><br><span class="line">│   │   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.init</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.service</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   └── <span class="selector-tag">php</span><span class="selector-class">.ini</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">vars</span></span><br><span class="line">│       └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">php_roles</span><span class="selector-class">.yml</span></span><br><span class="line">└── <span class="selector-tag">vhost</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line"></span><br><span class="line">18 <span class="selector-tag">directories</span>, 42 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure><h2 id="执行说明"><a href="#执行说明" class="headerlink" title="执行说明"></a>执行说明</h2><p>1）单独某一台机器安装nginx<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">ansible-playbook</span> <span class="selector-tag">-i</span> <span class="selector-tag">hostlist</span> <span class="selector-tag">nginx_roles</span><span class="selector-class">.yml</span> <span class="selector-tag">--limit</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.31</span></span><br></pre></td></tr></table></figure></p><p>2）单独某一台机器安装php<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">ansible-playbook</span> <span class="selector-tag">-i</span> <span class="selector-tag">hostlist</span> <span class="selector-tag">php_roles</span><span class="selector-class">.yml</span> <span class="selector-tag">--limit</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.31</span></span><br></pre></td></tr></table></figure></p><p>3）单独某一台机器安装mysql<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">ansible-playbook</span> <span class="selector-tag">-i</span> <span class="selector-tag">hostlist</span> <span class="selector-tag">mysql_roles</span><span class="selector-class">.yml</span> <span class="selector-tag">--limit</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.31</span></span><br></pre></td></tr></table></figure></p><p>4）单独某一台机器部署lnmp<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">ansible-playbook</span> <span class="selector-tag">-i</span> <span class="selector-tag">hostlist</span> <span class="selector-tag">lnmp</span><span class="selector-class">.yml</span> <span class="selector-tag">--limit</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.31</span></span><br></pre></td></tr></table></figure></p><p>5）所有机器部署php<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># ansible-playbook php_roles.yml</span></span><br></pre></td></tr></table></figure></p><p>6）所有机器部署nginx<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># ansible-playbook nginx_roles.yml</span></span><br></pre></td></tr></table></figure></p><p>7）所有机器部署mysql<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># ansible-playbook mysql_roles.yml</span></span><br></pre></td></tr></table></figure></p><p>8）所有机器部署lnmp<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># ansible-playbook lnmp.yml</span></span><br></pre></td></tr></table></figure></p><p><img src="/2019/06/05/Ansible项目实战lnmp/01.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;项目规划&quot;&gt;&lt;a href=&quot;#项目规划&quot; class=&quot;headerlink&quot; title=&quot;项目规划&quot;&gt;&lt;/a&gt;项目规划&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;通过&lt;code&gt;ansible roles&lt;/code&gt;配置&lt;code&gt;lnmp&lt;/code&gt;环境
      
    
    </summary>
    
      <category term="Ansible" scheme="https://leeyj.coding.me/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://leeyj.coding.me/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible之Roles</title>
    <link href="https://leeyj.coding.me/2019/06/03/Ansible%E4%B9%8BRoles/"/>
    <id>https://leeyj.coding.me/2019/06/03/Ansible之Roles/</id>
    <published>2019-06-03T02:35:22.000Z</published>
    <updated>2019-07-10T01:46:29.892Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Roles介绍"><a href="#Roles介绍" class="headerlink" title="Roles介绍"></a>Roles介绍</h2><blockquote><p><code>ansible</code>自<code>1.2</code>版本引入的新特性，用于层次性、结构化地组织<code>playbook</code>。<code>roles</code>能够根据层次型结构自动装载变量文件、<code>tasks</code>以及<code>handlers</code>等。要使用<code>roles</code>只需要在<code>playbook</code>中使用<code>include</code>指令引入即可。简单来讲，<code>roles</code>就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷的<code>include</code>它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。主要使用场景代码复用度较高的情况下。</p></blockquote><h2 id="Roles目录结构"><a href="#Roles目录结构" class="headerlink" title="Roles目录结构"></a>Roles目录结构</h2><p><img src="/2019/06/03/Ansible之Roles/rolesdir.png" alt="rolesdir.png"></p><p><strong>各目录含义解释</strong><br><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">roles</span>:          &lt;--所有的角色必须放在roles目录下，这个目录可以自定义位置，默认的位置在/etc/ansible/roles</span><br><span class="line">  project:      &lt;-<span class="comment">--具体的角色项目名称，比如nginx、tomcat、php</span></span><br><span class="line">    files：     &lt;--用来存放由copy模块或script模块调用的文件。</span><br><span class="line">    templates：&lt;--用来存放jinjia2模板，template模块会自动在此目录中寻找jinjia2模板文件。</span><br><span class="line">    tasks：     &lt;--此目录应当包含一个main.yml文件，用于定义此角色的任务列表，此文件可以使用include包含其它的位于此目录的task文件。</span><br><span class="line">  main.yml</span><br><span class="line">    handlers：&lt;--此目录应当包含一个main.yml文件，用于定义此角色中触发条件时执行的动作。</span><br><span class="line">  main.yml</span><br><span class="line">    vars： &lt;--此目录应当包含一个main.yml文件，用于定义此角色用到的变量。</span><br><span class="line">  main.yml</span><br><span class="line">    defaults：&lt;--此目录应当包含一个main.yml文件，用于为当前角色设定默认变量。</span><br><span class="line">  main.yml</span><br><span class="line">    meta：&lt;--此目录应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系。</span><br><span class="line">  main.yml</span><br></pre></td></tr></table></figure></p><h2 id="Roles示例"><a href="#Roles示例" class="headerlink" title="Roles示例"></a>Roles示例</h2><blockquote><p>通过<code>ansible roles</code>安装配置<code>httpd</code>服务，此处的<code>roles</code>使用默认的路径<code>/etc/ansible/roles</code></p></blockquote><p>1）创建目录<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># cd /etc/ansible/roles/</span></span><br><span class="line"><span class="meta"># 创建需要用到的目录</span></span><br><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># mkdir -p httpd/&#123;handlers,tasks,templates,vars&#125;</span></span><br><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># cd httpd/</span></span><br><span class="line">[root<span class="symbol">@ansible</span> httpd]<span class="meta"># tree .</span></span><br><span class="line">.</span><br><span class="line">├── handlers</span><br><span class="line">├── tasks</span><br><span class="line">├── templates</span><br><span class="line">└── vars</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> directories, <span class="number">0</span> file</span><br></pre></td></tr></table></figure></p><p>2）变量文件准备<code>vars/main.yml</code><br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible httpd]<span class="meta"># vim vars/main.yml</span></span><br><span class="line"><span class="symbol">PORT:</span> <span class="number">8088</span>        <span class="meta">#指定httpd监听的端口</span></span><br><span class="line"><span class="symbol">USERNAME:</span> www     <span class="meta">#指定httpd运行用户</span></span><br><span class="line"><span class="symbol">GROUPNAME:</span> www    <span class="meta">#指定httpd运行组</span></span><br></pre></td></tr></table></figure></p><p>3）配置文件模板准备<code>templates/httpd.conf.j2</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># copy一个本地的配置文件放在templates/下并已j2为后缀</span></span><br><span class="line">[root@ansible httpd]# cp /etc/httpd/conf/httpd.conf templates/httpd.conf.j2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行一些修改，调用上面定义的变量</span></span><br><span class="line">[root@ansible httpd]# vim templates/httpd.conf.j2</span><br><span class="line">Listen &#123;&#123;<span class="built_in"> PORT </span>&#125;&#125; </span><br><span class="line">User &#123;&#123; USERNAME &#125;&#125;</span><br><span class="line">Group &#123;&#123; GROUPNAME &#125;&#125;</span><br></pre></td></tr></table></figure></p><p>4）任务剧本编写，创建用户、创建组、安装软件、配置、启动等<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建组的task</span></span><br><span class="line">[root@ansible httpd]# vim tasks/group.yml</span><br><span class="line">- name: Create a Startup Group</span><br><span class="line">  group: <span class="attribute">name</span>=www <span class="attribute">gid</span>=60 <span class="attribute">system</span>=<span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户的task</span></span><br><span class="line">[root@ansible httpd]# vim tasks/user.yml</span><br><span class="line">- name: Create Startup Users</span><br><span class="line">  user: <span class="attribute">name</span>=www <span class="attribute">uid</span>=60 <span class="attribute">system</span>=<span class="literal">yes</span> <span class="attribute">shell</span>=/sbin/nologin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装软件的task</span></span><br><span class="line">[root@ansible httpd]# vim tasks/install.yml</span><br><span class="line">- name: Install Package Httpd</span><br><span class="line">  yum: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=installed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置软件的task</span></span><br><span class="line">[root@ansible httpd]# vim tasks/config.yml</span><br><span class="line">- name: Copy Httpd Template File</span><br><span class="line">  template: <span class="attribute">src</span>=httpd.conf.j2 <span class="attribute">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class="line">  notify: Restart Httpd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动软件的task</span></span><br><span class="line">[root@ansible httpd]# vim tasks/start.yml</span><br><span class="line">- name: Start Httpd Service</span><br><span class="line">  service: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=started <span class="attribute">enabled</span>=<span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写main.yml，将上面的这些task引入进来</span></span><br><span class="line">[root@ansible httpd]# vim tasks/main.yml</span><br><span class="line">- include: group.yml</span><br><span class="line">- include: user.yml</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: config.yml</span><br><span class="line">- include: start.ym</span><br></pre></td></tr></table></figure></p><p>5）编写重启httpd的<code>handlers</code>，<code>handlers/main.yml</code><br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible httpd]<span class="comment"># vim handlers/main.yml</span></span><br><span class="line"><span class="comment"># 这里的名字需要和task中的notify保持一致</span></span><br><span class="line">- name: Restart Httpd</span><br><span class="line">  service: name=httpd <span class="keyword">state</span>=restarted</span><br></pre></td></tr></table></figure></p><p>6）编写主的<code>httpd_roles.yml</code>文件调用httpd角色<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">httpd]#</span> <span class="string">cd</span> <span class="string">..</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">vim</span> <span class="string">httpd_roles.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">httpd</span>        <span class="comment">#指定角色名称</span></span><br></pre></td></tr></table></figure></p><p>7）整体的一个目录结构查看<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">tree</span> .</span><br><span class="line">.</span><br><span class="line">├── <span class="selector-tag">httpd</span></span><br><span class="line">│   ├── <span class="selector-tag">handlers</span></span><br><span class="line">│   │   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">tasks</span></span><br><span class="line">│   │   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">group</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">start</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   └── <span class="selector-tag">user</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">templates</span></span><br><span class="line">│   │   └── <span class="selector-tag">httpd</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">vars</span></span><br><span class="line">│       └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">└── <span class="selector-tag">httpd_roles</span><span class="selector-class">.yml</span></span><br><span class="line"></span><br><span class="line">5 <span class="selector-tag">directories</span>, 10 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure></p><p>8）测试<code>playbook</code>语法是否正确<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible roles]# ansible-playbook -C httpd_roles.yml </span><br><span class="line"></span><br><span class="line">PLAY [all] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create a Startup Group] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create Startup Users] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Install Package Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Copy Httpd Template File] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Start Httpd Service] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [httpd : Restart Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><p>9）上面的测试没有问题，正式执行<code>playbook</code><br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible roles]# ansible-playbook -C httpd_roles.yml </span><br><span class="line"></span><br><span class="line">PLAY [all] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create a Startup Group] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create Startup Users] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Install Package Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Copy Httpd Template File] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Start Httpd Service] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [httpd : Restart Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br><span class="line">[root@ansible roles]# ansible-playbook httpd_roles.yml </span><br><span class="line"></span><br><span class="line">PLAY [all] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create a Startup Group] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create Startup Users] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Install Package Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Copy Httpd Template File] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Start Httpd Service] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">fatal: [192.168.1.36]: FAILED! =&gt; &#123;"changed": false, "msg": "httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\n"&#125;</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [httpd : Restart Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.36               : ok=5    changed=4    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><p>这里有看到报错，其原因是因为<code>192.168.1.36</code>这台机器是<code>centos6</code>系统，别的都是<code>centos7</code>系统，两个系统安装的<code>httpd</code>默认版本是不一样的，所以报错。如果需要优化。<a href="https://buji595.github.io/2019/05/29/Ansible%E4%B9%8BPlaybook/#template%E4%B9%8Bwhen" target="_blank" rel="noopener">参考这里</a></p><h2 id="ansible-roles总结"><a href="#ansible-roles总结" class="headerlink" title="ansible roles总结"></a>ansible roles总结</h2><blockquote><p>1、编写任务(<code>task</code>)的时候，里面不需要写需要执行的主机，单纯的写某个任务是干什么的即可，装软件的就是装软件的，启动的就是启动的。单独做某一件事即可，最后通过<code>main.yml</code>将这些单独的任务安装执行顺序<code>include</code>进来即可，这样方便维护且一目了然。<br>2、定义变量时候直接安装<code>k:v</code>格式将变量写在<code>vars/main.yml</code>文件即可，然后<code>task</code>或者<code>template</code>直接调用即可，会自动去<code>vars/main.yml</code>文件里面去找。<br>3、定义<code>handlers</code>时候，直接在<code>handlers/main.yml</code>文件中写需要做什么事情即可，多可的话可以全部写在该文件里面，也可以像<code>task</code>那样分开来写，通过<code>include</code>引入一样的可以。在<code>task</code>调用<code>notify</code>时直接写与<code>handlers</code>名字对应即可(二者必须高度一直)。<br>4、模板文件一样放在<code>templates</code>目录下即可，task调用的时后直接写文件名字即可，会自动去到<code>templates</code>里面找。注意：如果是一个角色调用另外一个角色的单个<code>task</code>时后，那么<code>task</code>中如果有些模板或者文件，就得写绝对路径了。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Roles介绍&quot;&gt;&lt;a href=&quot;#Roles介绍&quot; class=&quot;headerlink&quot; title=&quot;Roles介绍&quot;&gt;&lt;/a&gt;Roles介绍&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;ansible&lt;/code&gt;自&lt;code&gt;1.2&lt;/code&gt;
      
    
    </summary>
    
      <category term="Ansible" scheme="https://leeyj.coding.me/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://leeyj.coding.me/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible之Playbook</title>
    <link href="https://leeyj.coding.me/2019/05/29/Ansible%E4%B9%8BPlaybook/"/>
    <id>https://leeyj.coding.me/2019/05/29/Ansible之Playbook/</id>
    <published>2019-05-29T07:35:22.000Z</published>
    <updated>2019-07-10T01:46:29.882Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Playbook介绍"><a href="#Playbook介绍" class="headerlink" title="Playbook介绍"></a>Playbook介绍</h2><p><a href="https://ansible-tran.readthedocs.io/en/latest/docs/playbooks.html" target="_blank" rel="noopener">playbook参考文档</a></p><blockquote><p><code>Playbook</code>与<code>ad-hoc</code>相比,是一种完全不同的运用ansible的方式，类似与<code>saltstack</code>的<code>state</code>状态文件。<code>ad-hoc</code>无法持久使用，<code>playbook</code>可以持久使用。<br><code>playbook</code>是由一个或多个<code>play</code>组成的列表，<code>play</code>的主要功能在于将事先归并为一组的主机装扮成事先通过<code>ansible</code>中的<code>task</code>定义好的角色。从根本上来讲，所谓的<code>task</code>无非是调用<code>ansible</code>的一个<code>module</code>。将多个<code>play</code>组织在一个<code>playbook</code>中，即可以让它们联合起来按事先编排的机制完成某一任务</p></blockquote><h2 id="Playbook核心元素"><a href="#Playbook核心元素" class="headerlink" title="Playbook核心元素"></a>Playbook核心元素</h2><blockquote><ul><li>Hosts  执行的远程主机列表</li><li>Tasks  任务集</li><li>Varniables 内置变量或自定义变量在playbook中调用</li><li>Templates 模板，即使用模板语法的文件，比如配置文件等</li><li>Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li><li>tags 标签，指定某条任务执行，用于选择运行playbook中的部分代码。</li></ul></blockquote><h2 id="Playbook语法"><a href="#Playbook语法" class="headerlink" title="Playbook语法"></a>Playbook语法</h2><blockquote><p><code>playbook</code>使用<code>yaml</code>语法格式，后缀可以是<code>yaml</code>,也可以是<code>yml</code>。</p><ul><li>在单一一个<code>playbook</code>文件中，可以连续三个连子号(<code>---</code>)区分多个<code>play</code>。还有选择性的连续三个点好(<code>...</code>)用来表示<code>play</code>的结尾，也可省略。</li><li>次行开始正常写<code>playbook</code>的内容，一般都会写上描述该<code>playbook</code>的功能。</li><li>使用#号注释代码。</li><li>缩进必须统一，不能空格和<code>tab</code>混用。</li><li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行实现的。</li><li><code>YAML</code>文件内容和<code>Linux</code>系统大小写判断方式保持一致，是区分大小写的，<code>k/v</code>的值均需大小写敏感</li><li><code>k/v</code>的值可同行写也可以换行写。同行使用:分隔。</li><li><code>v</code>可以是个字符串，也可以是一个列表</li><li>一个完整的代码块功能需要最少元素包括 <code>name: task</code></li></ul></blockquote><h3 id="一个简单的示例"><a href="#一个简单的示例" class="headerlink" title="一个简单的示例"></a>一个简单的示例</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 创建playbook文件</span></span><br><span class="line">[root@ansible ~]# cat playbook01.yml</span><br><span class="line">---                       #固定格式</span><br><span class="line"><span class="bullet">- </span>hosts: 192.168.1.31     #定义需要执行主机</span><br><span class="line">  remote_user: root       #远程用户</span><br><span class="line">  vars:                   #定义变量</span><br><span class="line"><span class="code">    http_port: 8088       #变量</span></span><br><span class="line"></span><br><span class="line">  tasks:                             #定义一个任务的开始</span><br><span class="line"><span class="code">    - name: create new file          #定义任务的名称</span></span><br><span class="line"><span class="code">      file: name=/tmp/playtest.txt state=touch   #调用模块，具体要做的事情</span></span><br><span class="line"><span class="code">    - name: create new user</span></span><br><span class="line"><span class="code">      user: name=test02 system=yes shell=/sbin/nologin</span></span><br><span class="line"><span class="code">    - name: install package</span></span><br><span class="line"><span class="code">      yum: name=httpd</span></span><br><span class="line"><span class="code">    - name: config httpd</span></span><br><span class="line"><span class="code">      template: src=./httpd.conf dest=/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="code">      notify:                 #定义执行一个动作(action)让handlers来引用执行，与handlers配合使用</span></span><br><span class="line"><span class="code">        - restart apache      #notify要执行的动作，这里必须与handlers中的name定义内容一致</span></span><br><span class="line"><span class="code">    - name: copy index.html</span></span><br><span class="line"><span class="code">      copy: src=/var/www/html/index.html dest=/var/www/html/index.html</span></span><br><span class="line"><span class="code">    - name: start httpd</span></span><br><span class="line"><span class="code">      service: name=httpd state=started</span></span><br><span class="line">  handlers:                                    #处理器：更加tasks中notify定义的action触发执行相应的处理动作</span><br><span class="line"><span class="code">    - name: restart apache                     #要与notify定义的内容相同</span></span><br><span class="line"><span class="code">      service: name=httpd state=restarted      #触发要执行的动作</span></span><br><span class="line"></span><br><span class="line"><span class="section">#测试页面准备</span></span><br><span class="line">[root@ansible ~]# echo "<span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span>playbook test file<span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>" &gt;&gt;/var/www/html/index.html</span><br><span class="line"><span class="section">#配置文件准备</span></span><br><span class="line">[root@ansible ~]# cat httpd.conf |grep ^Listen</span><br><span class="line">Listen &#123;&#123; http_port &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">#执行playbook， 第一次执行可以加-C选项，检查写的playbook是否ok</span></span><br><span class="line">[root@ansible ~]# ansible-playbook playbook01.yml</span><br><span class="line">PLAY [192.168.1.31] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">TASK [create new file] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">TASK [create new user] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">TASK [install package] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">TASK [config httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">TASK [copy index.html] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">TASK [start httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section"># 验证上面playbook执行的结果</span></span><br><span class="line">[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'ls /tmp/playtest.txt &amp;&amp; id test02'</span><br><span class="line">192.168.1.31 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/tmp/playtest.txt</span><br><span class="line">uid=990(test02) gid=985(test02) 组=985(test02)</span><br><span class="line"></span><br><span class="line">[root@ansible ~]# curl 192.168.1.31:8088</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span>playbook test file<span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="Playbook的运行方式"><a href="#Playbook的运行方式" class="headerlink" title="Playbook的运行方式"></a>Playbook的运行方式</h2><blockquote><p>通过<code>ansible-playbook</code>命令运行<br>格式：<code>ansible-playbook &lt;filename.yml&gt; ... [options]</code><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# ansible-playbook -h</span><br><span class="line">#ansible-playbook常用选项：</span><br><span class="line">-<span class="ruby">-check  <span class="keyword">or</span> -C    <span class="comment">#只检测可能会发生的改变，但不真正执行操作</span></span></span><br><span class="line"><span class="ruby">--list-hosts      <span class="comment">#列出运行任务的主机</span></span></span><br><span class="line"><span class="ruby">--list-tags       <span class="comment">#列出playbook文件中定义所有的tags</span></span></span><br><span class="line"><span class="ruby">--list-tasks      <span class="comment">#列出playbook文件中定义的所以任务集</span></span></span><br><span class="line"><span class="ruby">--limit           <span class="comment">#主机列表 只针对主机列表中的某个主机或者某个组执行</span></span></span><br><span class="line"><span class="ruby">-f                <span class="comment">#指定并发数，默认为5个</span></span></span><br><span class="line"><span class="ruby">-t                <span class="comment">#指定tags运行，运行某一个或者多个tags。（前提playbook中有定义tags）</span></span></span><br><span class="line"><span class="ruby">-v                <span class="comment">#显示过程  -vv  -vvv更详细</span></span></span><br></pre></td></tr></table></figure></p></blockquote><h2 id="Playbook中元素属性"><a href="#Playbook中元素属性" class="headerlink" title="Playbook中元素属性"></a>Playbook中元素属性</h2><h3 id="主机与用户"><a href="#主机与用户" class="headerlink" title="主机与用户"></a>主机与用户</h3><blockquote><p>在一个<code>playbook</code>开始时，最先定义的是要操作的主机和用户</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure><blockquote><p>除了上面的定义外，还可以在某一个<code>tasks</code>中定义要执行该任务的远程用户</p></blockquote><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tasks: </span><br><span class="line">  - name: <span class="keyword">run</span> df -<span class="built_in">h</span></span><br><span class="line">    remote_user: <span class="keyword">test</span></span><br><span class="line">    <span class="keyword">shell</span>: name=df -<span class="built_in">h</span></span><br></pre></td></tr></table></figure><blockquote><p>还可以定义使用<code>sudo</code>授权用户执行该任务</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span> </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">run</span> <span class="string">df</span> <span class="bullet">-h</span></span><br><span class="line"><span class="attr">    sudo_user:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">name=df</span> <span class="bullet">-h</span></span><br></pre></td></tr></table></figure><h3 id="tasks任务列表"><a href="#tasks任务列表" class="headerlink" title="tasks任务列表"></a>tasks任务列表</h3><blockquote><p>每一个<code>task</code>必须有一个名称<code>name</code>,这样在运行<code>playbook</code>时，从其输出的任务执行信息中可以很清楚的辨别是属于哪一个<code>task</code>的，如果没有定义 <code>name</code>，<code>action</code>的值将会用作输出信息中标记特定的<code>task</code>。<br>每一个<code>playbook</code>中可以包含一个或者多个<code>tasks</code>任务列表，每一个<code>tasks</code>完成具体的一件事，（任务模块）比如创建一个用户或者安装一个软件等，在<code>hosts</code>中定义的主机或者主机组都将会执行这个被定义的<code>tasks</code>。</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - name: create new file</span><br><span class="line">    file: <span class="attribute">path</span>=/tmp/test01.txt <span class="attribute">state</span>=touch</span><br><span class="line">  - name: create new user</span><br><span class="line">    user: <span class="attribute">name</span>=test001 <span class="attribute">state</span>=present</span><br></pre></td></tr></table></figure><h3 id="Handlers与Notify"><a href="#Handlers与Notify" class="headerlink" title="Handlers与Notify"></a>Handlers与Notify</h3><blockquote><p>很多时候当我们某一个配置发生改变，我们需要重启服务，（比如httpd配置文件文件发生改变了）这时候就可以用到<code>handlers</code>和<code>notify</code>了；<br>(当发生改动时)<code>notify actions</code>会在<code>playbook</code>的每一个task结束时被触发，而且即使有多个不同task通知改动的发生，<code>notify actions</code>知会被触发一次；比如多个<code>resources</code>指出因为一个配置文件被改动，所以<code>apache</code>需要重启，但是重新启动的操作知会被执行一次。</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# cat httpd.yml </span><br><span class="line"><span class="comment">#用于安装httpd并配置启动</span></span><br><span class="line">---</span><br><span class="line">- hosts: 192.168.1.31</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">  - name: install httpd</span><br><span class="line">    yum: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=installed</span><br><span class="line">  - name:<span class="built_in"> config </span>httpd</span><br><span class="line">    template: <span class="attribute">src</span>=/root/httpd.conf <span class="attribute">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class="line">    notify:</span><br><span class="line">      - restart httpd</span><br><span class="line">  - name: start httpd</span><br><span class="line">    service: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=started</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart httpd</span><br><span class="line">      service: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=restarted</span><br><span class="line"></span><br><span class="line"><span class="comment">#这里只要对httpd.conf配置文件作出了修改，修改后需要重启生效，在tasks中定义了restart httpd这个action，然后在handlers中引用上面tasks中定义的notify。</span></span><br></pre></td></tr></table></figure><h2 id="Playbook中变量的使用"><a href="#Playbook中变量的使用" class="headerlink" title="Playbook中变量的使用"></a>Playbook中变量的使用</h2><p><strong>环境说明</strong>：这里配置了两个组，一个apache组和一个nginx组<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible PlayBook]</span># cat /etc/ansible/hosts</span><br><span class="line"><span class="string">[apache]</span></span><br><span class="line"><span class="number">192.168.1.36</span></span><br><span class="line"><span class="number">192.168.1.33</span></span><br><span class="line"></span><br><span class="line"><span class="string">[nginx]</span></span><br><span class="line"><span class="number">192.168.1.3</span><span class="string">[1:2]</span></span><br></pre></td></tr></table></figure></p><h3 id="命令行指定变量"><a href="#命令行指定变量" class="headerlink" title="命令行指定变量"></a>命令行指定变量</h3><blockquote><p>执行<code>playbook</code>时候通过参数<code>-e</code>传入变量，这样传入的变量在整个<code>playbook</code>中都可以被调用，属于全局变量</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">variables.yml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">install</span> <span class="string">pkg</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkg</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行playbook 指定pkg</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span> <span class="bullet">-e</span> <span class="string">"pkg=httpd"</span> <span class="string">variables.yml</span></span><br></pre></td></tr></table></figure><h3 id="hosts文件中定义变量"><a href="#hosts文件中定义变量" class="headerlink" title="hosts文件中定义变量"></a>hosts文件中定义变量</h3><blockquote><p>在<code>/etc/ansible/hosts</code>文件中定义变量，可以针对每个主机定义不同的变量，也可以定义一个组的变量，然后直接在<code>playbook</code>中直接调用。注意，组中定义的变量没有单个主机中的优先级高。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑hosts文件定义变量</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">vim</span> <span class="string">/etc/ansible/hosts</span></span><br><span class="line"><span class="string">[apache]</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.36</span> <span class="string">webdir=/opt/test</span>     <span class="comment">#定义单个主机的变量</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span></span><br><span class="line"><span class="string">[apache:vars]</span>      <span class="comment">#定义整个组的统一变量</span></span><br><span class="line"><span class="string">webdir=/web/test</span></span><br><span class="line"></span><br><span class="line"><span class="string">[nginx]</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span><span class="string">[1:2]</span></span><br><span class="line"><span class="string">[nginx:vars]</span></span><br><span class="line"><span class="string">webdir=/opt/web</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑playbook文件</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">variables.yml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">webdir</span></span><br><span class="line"><span class="attr">      file:</span> <span class="string">name=&#123;&#123;</span> <span class="string">webdir</span> <span class="string">&#125;&#125;</span> <span class="string">state=directory</span>   <span class="comment">#引用变量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span> <span class="string">variables.yml</span></span><br></pre></td></tr></table></figure><h3 id="playbook文件中定义变量"><a href="#playbook文件中定义变量" class="headerlink" title="playbook文件中定义变量"></a>playbook文件中定义变量</h3><blockquote><p>编写<code>playbook</code>时，直接在里面定义变量，然后直接引用，可以定义多个变量；注意：如果在执行<code>playbook</code>时，又通过<code>-e</code>参数指定变量的值，那么会以<code>-e</code>参数指定的为准。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">variables.yml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span>                <span class="comment">#定义变量</span></span><br><span class="line"><span class="attr">    pkg:</span> <span class="string">nginx</span>         <span class="comment">#变量1</span></span><br><span class="line"><span class="attr">    dir:</span> <span class="string">/tmp/test1</span>    <span class="comment">#变量2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">install</span> <span class="string">pkg</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkg</span> <span class="string">&#125;&#125;</span> <span class="string">state=installed</span>    <span class="comment">#引用变量</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">new</span> <span class="string">dir</span></span><br><span class="line"><span class="attr">      file:</span> <span class="string">name=&#123;&#123;</span> <span class="string">dir</span> <span class="string">&#125;&#125;</span> <span class="string">state=directory</span>   <span class="comment">#引用变量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span> <span class="string">variables.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果执行时候又重新指定了变量的值，那么会已重新指定的为准</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span> <span class="bullet">-e</span> <span class="string">"dir=/tmp/test2"</span> <span class="string">variables.yml</span></span><br></pre></td></tr></table></figure><h3 id="调用setup模块获取变量"><a href="#调用setup模块获取变量" class="headerlink" title="调用setup模块获取变量"></a>调用setup模块获取变量</h3><blockquote><p><code>setup</code>模块默认是获取主机信息的，有时候在<code>playbook</code>中需要用到，所以可以直接调用。常用的参数<a href="https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup" target="_blank" rel="noopener">参考</a></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑playbook文件</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">variables.yml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">file</span></span><br><span class="line"><span class="attr">      file:</span> <span class="string">name=&#123;&#123;</span> <span class="string">ansible_fqdn</span> <span class="string">&#125;&#125;.log</span> <span class="string">state=touch</span>   <span class="comment">#引用setup中的ansible_fqdn</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span> <span class="string">variables.yml</span></span><br></pre></td></tr></table></figure><h3 id="独立的变量YAML文件中定义"><a href="#独立的变量YAML文件中定义" class="headerlink" title="独立的变量YAML文件中定义"></a>独立的变量YAML文件中定义</h3><blockquote><p>为了方便管理将所有的变量统一放在一个独立的变量<code>YAML</code>文件中，<code>laybook</code>文件直接引用文件调用变量即可。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义存放变量的文件</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">var.yml</span> </span><br><span class="line"><span class="attr">var1:</span> <span class="string">vsftpd</span></span><br><span class="line"><span class="attr">var2:</span> <span class="string">httpd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">variables.yml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars_files:</span>    <span class="comment">#引用变量文件</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">./var.yml</span>   <span class="comment">#指定变量文件的path（这里可以是绝对路径，也可以是相对路径）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">var1</span> <span class="string">&#125;&#125;</span>   <span class="comment">#引用变量</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">file</span></span><br><span class="line"><span class="attr">      file:</span> <span class="string">name=/tmp/&#123;&#123;</span> <span class="string">var2</span> <span class="string">&#125;&#125;.log</span> <span class="string">state=touch</span>   <span class="comment">#引用变量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span>  <span class="string">variables.yml</span></span><br></pre></td></tr></table></figure><h2 id="Playbook中标签的使用"><a href="#Playbook中标签的使用" class="headerlink" title="Playbook中标签的使用"></a>Playbook中标签的使用</h2><blockquote><p>一个<code>playbook</code>文件中，执行时如果想执行某一个任务，那么可以给每个任务集进行打标签，这样在执行的时候可以通过<code>-t</code>选择指定标签执行，还可以通过<code>--skip-tags</code>选择除了某个标签外全部执行等。</p></blockquote><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 编辑playbook</span></span><br><span class="line">[root@ansible PlayBook]# cat httpd.yml </span><br><span class="line">---</span><br><span class="line"><span class="bullet">- </span>hosts: 192.168.1.31</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line"><span class="code">    - name: install httpd</span></span><br><span class="line"><span class="code">      yum: name=httpd state=installed</span></span><br><span class="line"><span class="code">      tags: inhttpd</span></span><br><span class="line"></span><br><span class="line"><span class="code">    - name: start httpd</span></span><br><span class="line"><span class="code">      service: name=httpd state=started</span></span><br><span class="line"><span class="code">      tags: sthttpd</span></span><br><span class="line"></span><br><span class="line"><span class="code">    - name: restart httpd</span></span><br><span class="line"><span class="code">      service: name=httpd state=restarted</span></span><br><span class="line"><span class="code">      tags: </span></span><br><span class="line"><span class="code">        - rshttpd</span></span><br><span class="line"><span class="code">        - rs_httpd</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 正常执行的结果</span></span><br><span class="line">[root@ansible PlayBook]# ansible-playbook httpd.yml </span><br><span class="line"></span><br><span class="line">PLAY [192.168.1.31] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [install httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [start httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [restart httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">192.168.1.31               : ok=4    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><p>1）通过<code>-t</code>选项指定<code>tags</code>进行执行<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 通过-t指定tags名称，多个tags用逗号隔开</span></span><br><span class="line">[root@ansible PlayBook]# ansible-playbook -t rshttpd httpd.yml </span><br><span class="line"></span><br><span class="line">PLAY [192.168.1.31] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [restart httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">192.168.1.31               : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><p>2）通过<code>--skip-tags</code>选项排除不执行的<code>tags</code><br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# ansible-playbook --skip-tags inhttpd httpd.yml </span><br><span class="line"></span><br><span class="line">PLAY [192.168.1.31] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [start httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [restart httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">192.168.1.31               : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><h2 id="Playbook中模板的使用"><a href="#Playbook中模板的使用" class="headerlink" title="Playbook中模板的使用"></a>Playbook中模板的使用</h2><blockquote><p><code>template</code>模板为我们提供了动态配置服务，使用<code>jinja2</code>语言，里面支持多种条件判断、循环、逻辑运算、比较操作等。其实说白了也就是一个文件，和之前配置文件使用<code>copy</code>一样，只是使用<code>copy</code>，不能根据服务器配置不一样进行不同动态的配置。这样就不利于管理。<br>说明：<br>1、多数情况下都将<code>template</code>文件放在和<code>playbook</code>文件同级的<code>templates</code>目录下（手动创建），这样<code>playbook</code>文件中可以直接引用，会自动去找这个文件。如果放在别的地方，也可以通过绝对路径去指定。<br>2、模板文件后缀名为<code>.j2</code>。</p></blockquote><p><a href="http://www.ansible.com.cn/docs/playbooks_loops.html#standard-loops" target="_blank" rel="noopener">循环参考</a><br><strong>示例：通过template安装httpd</strong><br>1）<code>playbook</code>文件编写<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">testtmp.yml</span> </span><br><span class="line"><span class="comment">#模板示例</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    - listen_port:</span> <span class="number">88</span>    <span class="comment">#定义变量</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=httpd</span> <span class="string">state=installed</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Config</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=httpd.conf.j2</span> <span class="string">dest=/etc/httpd/conf/httpd.conf</span>    <span class="comment">#使用模板</span></span><br><span class="line"><span class="attr">      notify:</span> <span class="string">Restart</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Start</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Restart</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure></p><p>2）模板文件准备，<code>httpd</code>配置文件准备，这里配置文件端口使用了变量<br><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# cat templates/httpd.conf.j2 |grep ^<span class="keyword">Listen</span></span><br><span class="line"><span class="keyword">Listen</span> &#123;&#123; listen_port &#125;&#125;</span><br></pre></td></tr></table></figure></p><p>3）查看目录结构<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 目录结构</span><br><span class="line"><span class="selector-attr">[root@ansible PlayBook]</span># <span class="selector-tag">tree</span> .</span><br><span class="line">.</span><br><span class="line">├── <span class="selector-tag">templates</span></span><br><span class="line">│   └── <span class="selector-tag">httpd</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">└── <span class="selector-tag">testtmp</span><span class="selector-class">.yml</span></span><br><span class="line"></span><br><span class="line">1 <span class="selector-tag">directory</span>, 2 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure></p><p>4）执行<code>playbook</code>，由于<code>192.168.1.36</code>那台机器是<code>6</code>的系统，模板文件里面的配置文件是<code>7</code>上面默认的<code>httpd</code>配置文件，<code>httpd</code>版本不一样(<code>6默认版本为2.2.15，7默认版本为2.4.6</code>)，所以拷贝过去后启动报错。下面使用<code>playbook</code>中的判断语句进行处理；此处先略过<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# ansible-playbook testtmp.yml </span><br><span class="line"></span><br><span class="line">PLAY [all] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [Install Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [Config Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [Start Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">fatal: [192.168.1.36]: FAILED! =&gt; &#123;"changed": false, "msg": "httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\n"&#125;</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [Restart Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">192.168.1.31               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.32               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.33               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.36               : ok=3    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><h3 id="template之when"><a href="#template之when" class="headerlink" title="template之when"></a>template之when</h3><p><a href="http://www.ansible.com.cn/docs/playbooks_conditionals.html#when" target="_blank" rel="noopener">when语句参考</a></p><blockquote><p>条件测试：如果需要根据变量、<code>facts</code>或此前任务的执行结果来做为某<code>task</code>执行与否的前提时要用到条件测试，通过<code>when</code>语句执行，在<code>task</code>中使用<code>jinja2</code>的语法格式、<br>when语句：<br>在<code>task</code>后添加<code>when</code>子句即可使用条件测试；<code>when</code>语句支持<code>jinja2</code>表达式语法。</p></blockquote><p>类似这样：<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - <span class="keyword">command</span>: /<span class="title">bin</span>/<span class="title">false</span></span><br><span class="line">    register: <span class="built_in">result</span></span><br><span class="line">    ignore_errors: True</span><br><span class="line">  - <span class="keyword">command</span>: /<span class="title">bin</span>/<span class="title">something</span></span><br><span class="line">    when: <span class="built_in">result</span>|failed</span><br><span class="line">  - <span class="keyword">command</span>: /<span class="title">bin</span>/<span class="title">something_else</span></span><br><span class="line">    when: <span class="built_in">result</span>|success</span><br><span class="line">  - <span class="keyword">command</span>: /<span class="title">bin</span>/<span class="title">still</span>/<span class="title">something_else</span></span><br><span class="line">    when: <span class="built_in">result</span>|skipped</span><br></pre></td></tr></table></figure></p><p><strong>示例：通过when语句完善上面的httpd配置</strong><br>1）准备两个配置文件，一个<code>centos6</code>系统<code>httpd</code>配置文件，一个<code>centos7</code>系统httpd配置文件。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# tree templates/</span><br><span class="line">templates/</span><br><span class="line">├── httpd6.conf.j2     #<span class="number">6</span>系统<span class="number">2.2</span><span class="number">.15</span>版本httpd配置文件</span><br><span class="line">└── httpd7.conf.j2     #<span class="number">7</span>系统<span class="number">2.4</span><span class="number">.6</span>版本httpd配置文件</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> directories, <span class="number">2</span> files</span><br></pre></td></tr></table></figure></p><p>2）修改<code>playbook</code>文件，通过setup模块获取系统版本去判断。<a href="https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup" target="_blank" rel="noopener">setup常用模块</a><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# cat testtmp.yml </span><br><span class="line"><span class="comment">#when示例</span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    - listen_port: 88</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Httpd</span><br><span class="line">      yum: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=installed</span><br><span class="line">    - name:<span class="built_in"> Config </span>System6 Httpd</span><br><span class="line">      template: <span class="attribute">src</span>=httpd6.conf.j2 <span class="attribute">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class="line">      when: ansible_distribution_major_version == <span class="string">"6"</span>   #判断系统版本，为6便执行上面的template配置6的配置文件</span><br><span class="line">      notify: Restart Httpd</span><br><span class="line">    - name:<span class="built_in"> Config </span>System7 Httpd</span><br><span class="line">      template: <span class="attribute">src</span>=httpd7.conf.j2 <span class="attribute">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class="line">      when: ansible_distribution_major_version == <span class="string">"7"</span>   #判断系统版本，为7便执行上面的template配置7的配置文件</span><br><span class="line">      notify: Restart Httpd</span><br><span class="line">    - name: Start Httpd</span><br><span class="line">      service: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=started</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: Restart Httpd</span><br><span class="line">      service: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=restarted</span><br></pre></td></tr></table></figure></p><p>3）执行playbook<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# ansible-playbook testtmp.yml</span><br><span class="line"></span><br><span class="line">PLAY [all] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [Install Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [Config System6 Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">skipping: [192.168.1.33]</span><br><span class="line">skipping: [192.168.1.31]</span><br><span class="line">skipping: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [Config System7 Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">skipping: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line"></span><br><span class="line">TASK [Start Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [Restart Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">192.168.1.31               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">192.168.1.32               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">192.168.1.33               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">192.168.1.36               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><h3 id="template之with-items"><a href="#template之with-items" class="headerlink" title="template之with_items"></a>template之with_items</h3><blockquote><p><code>with_items</code>迭代，当有需要重复性执行的任务时，可以使用迭代机制。<br>对迭代项的引用，固定变量名为<code>“item”</code>，要在task中使用with_items给定要迭代的元素列表。<br>列表格式：<br>&emsp;&ensp;字符串<br>&emsp;&ensp;字典</p></blockquote><p><strong>示例1：通过with_items安装多个不同软件</strong><br>编写<code>playbook</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">testwith.yml</span> </span><br><span class="line"><span class="comment"># 示例with_items</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Package</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=installed</span>   <span class="comment">#引用item获取值</span></span><br><span class="line"><span class="attr">      with_items:</span>     <span class="comment">#定义with_items</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">httpd</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">vsftpd</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure></p><p>上面<code>tasks</code>写法等同于：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=httpd</span> <span class="string">state=installed</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Vsftpd</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=vsftpd</span> <span class="string">state=installed</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=nginx</span> <span class="string">state=installed</span></span><br></pre></td></tr></table></figure></p><p><strong>示例2：通过嵌套子变量创建用户并加入不同的组</strong><br>1）编写<code>playbook</code><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]<span class="comment"># cat testwith01.yml </span></span><br><span class="line"><span class="comment"># 示例with_items嵌套子变量</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: <span class="keyword">Create</span> <span class="keyword">New</span> <span class="keyword">Group</span></span><br><span class="line">      <span class="keyword">group</span>: <span class="keyword">name</span>=&#123;&#123; item &#125;&#125; state=<span class="keyword">present</span></span><br><span class="line">      with_items: </span><br><span class="line">        - group1</span><br><span class="line">        - group2</span><br><span class="line">        - group3 </span><br><span class="line"></span><br><span class="line">    - <span class="keyword">name</span>: <span class="keyword">Create</span> <span class="keyword">New</span> <span class="keyword">User</span></span><br><span class="line">      <span class="keyword">user</span>: <span class="keyword">name</span>=&#123;&#123; item.name &#125;&#125; <span class="keyword">group</span>=&#123;&#123; item.group &#125;&#125; state=<span class="keyword">present</span></span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; <span class="keyword">name</span>: <span class="string">'user1'</span>, <span class="keyword">group</span>: <span class="string">'group1'</span> &#125; </span><br><span class="line">        - &#123; <span class="keyword">name</span>: <span class="string">'user2'</span>, <span class="keyword">group</span>: <span class="string">'group2'</span> &#125; </span><br><span class="line">        - &#123; <span class="keyword">name</span>: <span class="string">'user3'</span>, <span class="keyword">group</span>: <span class="string">'group3'</span> &#125;</span><br></pre></td></tr></table></figure></p><p>2）执行<code>playbook</code>并验证<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行playbook</span></span><br><span class="line">[root@ansible PlayBook]<span class="comment"># ansible-playbook testwith01.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证是否成功创建用户及组</span></span><br><span class="line">[root@ansible PlayBook]<span class="comment"># ansible all -m shell -a 'tail -3 /etc/passwd'</span></span><br><span class="line"><span class="meta">192.168.1.36 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">user1:</span><span class="symbol">x:</span><span class="number">500</span><span class="symbol">:</span><span class="number">500</span><span class="symbol">:</span><span class="symbol">:/home/user1</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user2:</span><span class="symbol">x:</span><span class="number">501</span><span class="symbol">:</span><span class="number">501</span><span class="symbol">:</span><span class="symbol">:/home/user2</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user3:</span><span class="symbol">x:</span><span class="number">502</span><span class="symbol">:</span><span class="number">502</span><span class="symbol">:</span><span class="symbol">:/home/user3</span><span class="symbol">:/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">192.168.1.32 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">user1:</span><span class="symbol">x:</span><span class="number">1001</span><span class="symbol">:</span><span class="number">1001</span><span class="symbol">:</span><span class="symbol">:/home/user1</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user2:</span><span class="symbol">x:</span><span class="number">1002</span><span class="symbol">:</span><span class="number">1002</span><span class="symbol">:</span><span class="symbol">:/home/user2</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user3:</span><span class="symbol">x:</span><span class="number">1003</span><span class="symbol">:</span><span class="number">1003</span><span class="symbol">:</span><span class="symbol">:/home/user3</span><span class="symbol">:/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">user1:</span><span class="symbol">x:</span><span class="number">1002</span><span class="symbol">:</span><span class="number">1003</span><span class="symbol">:</span><span class="symbol">:/home/user1</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user2:</span><span class="symbol">x:</span><span class="number">1003</span><span class="symbol">:</span><span class="number">1004</span><span class="symbol">:</span><span class="symbol">:/home/user2</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user3:</span><span class="symbol">x:</span><span class="number">1004</span><span class="symbol">:</span><span class="number">1005</span><span class="symbol">:</span><span class="symbol">:/home/user3</span><span class="symbol">:/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">192.168.1.33 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">user1:</span><span class="symbol">x:</span><span class="number">1001</span><span class="symbol">:</span><span class="number">1001</span><span class="symbol">:</span><span class="symbol">:/home/user1</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user2:</span><span class="symbol">x:</span><span class="number">1002</span><span class="symbol">:</span><span class="number">1002</span><span class="symbol">:</span><span class="symbol">:/home/user2</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user3:</span><span class="symbol">x:</span><span class="number">1003</span><span class="symbol">:</span><span class="number">1003</span><span class="symbol">:</span><span class="symbol">:/home/user3</span><span class="symbol">:/bin/bash</span></span><br></pre></td></tr></table></figure></p><h3 id="template之for-if"><a href="#template之for-if" class="headerlink" title="template之for if"></a>template之for if</h3><blockquote><p>通过使用<code>for</code>，<code>if</code>可以更加灵活的生成配置文件等需求，还可以在里面根据各种条件进行判断，然后生成不同的配置文件、或者服务器配置相关等。</p></blockquote><p><strong>示例1</strong><br>1）编写<code>playbook</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">testfor01.yml</span> </span><br><span class="line"><span class="comment"># template for 示例</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    nginx_vhost_port:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">81</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">82</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">83</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Templage</span> <span class="string">Nginx</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/tmp/nginx_test.conf</span></span><br></pre></td></tr></table></figure></p><p>2）模板文件编写<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 循环playbook文件中定义的变量，依次赋值给port</span></span><br><span class="line">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span><br><span class="line">&#123;% <span class="keyword">for</span><span class="built_in"> port </span><span class="keyword">in</span> nginx_vhost_port %&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     listen: &#123;&#123;<span class="built_in"> port </span>&#125;&#125;;</span><br><span class="line">     server_name: localhost;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure></p><p>3）执行<code>playbook</code>并查看生成结果<br><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]<span class="comment"># ansible-playbook testfor01.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class="line">[root@linux ~]<span class="comment"># cat /tmp/nginx_test.conf </span></span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>: 81;</span><br><span class="line">     <span class="attribute">server_name</span>: localhost;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>: 82;</span><br><span class="line">     <span class="attribute">server_name</span>: localhost;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>: 83;</span><br><span class="line">     <span class="attribute">server_name</span>: localhost;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>示例2</strong><br>1）编写<code>playbook</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">testfor02.yml</span> </span><br><span class="line"><span class="comment"># template for 示例</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    nginx_vhosts:</span></span><br><span class="line"><span class="attr">      - web1:</span></span><br><span class="line"><span class="attr">        listen:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">        server_name:</span> <span class="string">"web1.example.com"</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web1"</span></span><br><span class="line"><span class="attr">      - web2:</span></span><br><span class="line"><span class="attr">        listen:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">        server_name:</span> <span class="string">"web2.example.com"</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web2"</span></span><br><span class="line"><span class="attr">      - web3:</span></span><br><span class="line"><span class="attr">        listen:</span> <span class="number">8083</span></span><br><span class="line"><span class="attr">        server_name:</span> <span class="string">"web3.example.com"</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Templage</span> <span class="string">Nginx</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/tmp/nginx_vhost.conf</span></span><br></pre></td></tr></table></figure></p><p>2）模板文件编写<br><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> vhost <span class="keyword">in</span> nginx_vhosts %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">server&#123;</span></span><br><span class="line"><span class="xml">     listen:    </span><span class="template-variable">&#123;&#123; vhost.listen &#125;&#125;</span><span class="xml">;</span></span><br><span class="line"><span class="xml">     server_name:    </span><span class="template-variable">&#123;&#123; vhost.server_name &#125;&#125;</span><span class="xml">;</span></span><br><span class="line"><span class="xml">     root:   </span><span class="template-variable">&#123;&#123; vhost.root &#125;&#125;</span><span class="xml">; </span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure></p><p>3）执行<code>playbook</code>并查看生成结果<br><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]<span class="comment"># ansible-playbook testfor02.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class="line">[root@linux ~]<span class="comment"># cat /tmp/nginx_vhost.conf </span></span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>:    8081;</span><br><span class="line">     <span class="attribute">server_name</span>:    web1<span class="variable">.example</span><span class="variable">.com</span>;</span><br><span class="line">     <span class="attribute">root</span>:   /var/www/nginx/web1; </span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>:    8082;</span><br><span class="line">     <span class="attribute">server_name</span>:    web2<span class="variable">.example</span><span class="variable">.com</span>;</span><br><span class="line">     <span class="attribute">root</span>:   /var/www/nginx/web2; </span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>:    8083;</span><br><span class="line">     <span class="attribute">server_name</span>:    web3<span class="variable">.example</span><span class="variable">.com</span>;</span><br><span class="line">     <span class="attribute">root</span>:   /var/www/nginx/web3; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>示例3</strong><br>在for循环中再嵌套if判断，让生成的配置文件更加灵活<br>1）编写<code>playbook</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">testfor03.yml</span> </span><br><span class="line"><span class="comment"># template for 示例</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    nginx_vhosts:</span></span><br><span class="line"><span class="attr">      - web1:</span></span><br><span class="line"><span class="attr">        listen:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web1"</span></span><br><span class="line"><span class="attr">      - web2:</span></span><br><span class="line"><span class="attr">        server_name:</span> <span class="string">"web2.example.com"</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web2"</span></span><br><span class="line"><span class="attr">      - web3:</span></span><br><span class="line"><span class="attr">        listen:</span> <span class="number">8083</span></span><br><span class="line"><span class="attr">        server_name:</span> <span class="string">"web3.example.com"</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Templage</span> <span class="string">Nginx</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/tmp/nginx_vhost.conf</span></span><br></pre></td></tr></table></figure></p><p>2）模板文件编写<br><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"># 说明：这里添加了判断，如果listen没有定义的话，默认端口使用8888，如果server_name有定义，那么生成的配置文件中才有这一项。</span></span><br><span class="line"><span class="xml">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> vhost <span class="keyword">in</span> nginx_vhosts %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">server&#123;</span></span><br><span class="line"><span class="xml">     </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> vhost.listen is defined %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">     listen:    </span><span class="template-variable">&#123;&#123; vhost.listen &#125;&#125;</span><span class="xml">;</span></span><br><span class="line"><span class="xml">     </span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">     listen: 8888;</span></span><br><span class="line"><span class="xml">     </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">     </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> vhost.server_name is defined %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">     server_name:    </span><span class="template-variable">&#123;&#123; vhost.server_name &#125;&#125;</span><span class="xml">;</span></span><br><span class="line"><span class="xml">     </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">     root:   </span><span class="template-variable">&#123;&#123; vhost.root &#125;&#125;</span><span class="xml">; </span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure></p><p>3）执行<code>playbook</code>并查看生成结果<br><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]<span class="comment"># ansible-playbook testfor03.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class="line">[root@linux ~]<span class="comment"># cat /tmp/nginx_vhost.conf </span></span><br><span class="line">server&#123;</span><br><span class="line">          <span class="attribute">listen</span>:    8081;</span><br><span class="line">          <span class="attribute">root</span>:   /var/www/nginx/web1; </span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">          <span class="attribute">listen</span>: 8888;</span><br><span class="line">          <span class="attribute">server_name</span>:    web2<span class="variable">.example</span><span class="variable">.com</span>;</span><br><span class="line">          <span class="attribute">root</span>:   /var/www/nginx/web2; </span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">          <span class="attribute">listen</span>:    8083;</span><br><span class="line">          <span class="attribute">server_name</span>:    web3<span class="variable">.example</span><span class="variable">.com</span>;</span><br><span class="line">          <span class="attribute">root</span>:   /var/www/nginx/web3; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>上面三个示例的图片展示效果</strong><br><div class="tabs" id><ul class="nav-tabs"><li class="tab active"><a href="#-1">示例1</a></li><li class="tab"><a href="#-2">示例2</a></li><li class="tab"><a href="#-3">示例3</a></li></ul><div class="tab-content"><div class="tab-pane active" id="-1"><p><img src="/2019/05/29/Ansible之Playbook/shili01.png" alt></p></div><div class="tab-pane" id="-2"><p><img src="/2019/05/29/Ansible之Playbook/shili02.png" alt></p></div><div class="tab-pane" id="-3"><p><img src="/2019/05/29/Ansible之Playbook/shili03.png" alt></p></div></div></div></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Playbook介绍&quot;&gt;&lt;a href=&quot;#Playbook介绍&quot; class=&quot;headerlink&quot; title=&quot;Playbook介绍&quot;&gt;&lt;/a&gt;Playbook介绍&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://ansible-tran.readthed
      
    
    </summary>
    
      <category term="Ansible" scheme="https://leeyj.coding.me/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://leeyj.coding.me/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible  Module</title>
    <link href="https://leeyj.coding.me/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/"/>
    <id>https://leeyj.coding.me/2019/05/27/Ansible Ad-hoc常用Module/</id>
    <published>2019-05-27T15:25:22.000Z</published>
    <updated>2019-07-10T01:46:29.880Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Ansible-Ad-hoc模式常用模块"><a href="#Ansible-Ad-hoc模式常用模块" class="headerlink" title="Ansible Ad-hoc模式常用模块"></a>Ansible Ad-hoc模式常用模块</h2><p>ansible-doc 常用命令<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ansible-doc -h</span></span><br><span class="line"><span class="symbol">Usage:</span> ansible-doc [-l<span class="params">|-F|</span>-s] [options] [-t &lt;plugin type&gt; ] [plugin]</span><br><span class="line">-j  以json格式显示所有模块信息</span><br><span class="line">-l  列出所有的模块</span><br><span class="line">-s  查看模块常用参数</span><br><span class="line"><span class="comment"># 直接跟模块名，显示模块所有信息</span></span><br><span class="line"></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -j</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -l</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -l |wc -l   #统计所有模块个数，ansible2.8共计2834个模块</span></span><br><span class="line"><span class="number">2834</span></span><br></pre></td></tr></table></figure></p><h3 id="命令相关的模块"><a href="#命令相关的模块" class="headerlink" title="命令相关的模块"></a>命令相关的模块</h3><h4 id="command"><a href="#command" class="headerlink" title="command"></a>command</h4><blockquote><p><code>ansible</code>默认的模块,执行命令，注意：shell中的<code>&quot;&lt;&quot;</code>, <code>&quot;&gt;&quot;</code>, <code>&quot;|&quot;</code>, <code>&quot;;&quot;</code>, <code>&quot;&amp;&quot;</code>,<code>&quot;$&quot;</code>等特殊字符不能在<code>command</code>模块中使用，如果需要使用，则用<code>shell</code>模块</p></blockquote><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 查看模块参数</span><br><span class="line">[root@ansible ~]# ansible-doc -s command</span><br><span class="line"></span><br><span class="line"># 在<span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span>服务器上面执行ls命令，默认是在当前用户的家目录/root</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'ls'</span><br><span class="line"></span><br><span class="line"># chdir  先切换工作目录，再执行后面的命令，一般情况下在编译时候使用</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'chdir=/tmp pwd'</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | CHANGED | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">/tmp</span><br><span class="line"></span><br><span class="line"># creates  如果creates的文件存在，则执行后面的操作</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'creates=/tmp ls /etc/passwd'    #tmp目录存在，则不执行后面的ls命令</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">skipped, since /tmp exists</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'creates=/tmp11 ls /etc/passwd'    # tmp11文件不存在，则执行后面的ls命令</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | CHANGED | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">/etc/passwd</span><br><span class="line"></span><br><span class="line"># removes  和creates相反，如果removes的文件存在，才执行后面的操作</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'removes=/tmp ls /etc/passwd'    #tmp文件存在，则执行了后面的ls命令</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | CHANGED | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">/etc/passwd</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'removes=/tmp11 ls /etc/passwd'  #tmp11文件不存在，则没有执行后面的ls命令</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">skipped, since /tmp11 does not exist</span><br></pre></td></tr></table></figure><h4 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h4><blockquote><p>专门用来执行<code>shell</code>命令的模块，和<code>command</code>模块一样，参数基本一样，都有<code>chdir,creates,removes</code>等参数</p></blockquote><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 查看模块参数</span><br><span class="line">[root@ansible ~]# ansible-doc -s shell</span><br><span class="line"></span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -m shell -a 'mkdir /tmp/test'</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -m shell -a 'ls /tmp' </span><br><span class="line"></span><br><span class="line">#执行下面这条命令，每次执行都会更新文件的时间戳</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -m shell -a 'cd /tmp/test &amp;&amp; <span class="section">touch</span> <span class="number">1.</span>txt &amp;&amp; ls' </span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | CHANGED | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line"><span class="number">1.</span>txt</span><br><span class="line"></span><br><span class="line"># 由于有时候不想更新文件的创建时间戳，则如果存在就不执行creates</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -m shell -a 'creates=/tmp/test/<span class="number">1.</span>txt cd /tmp/test &amp;&amp; <span class="section">touch</span> <span class="number">1.</span>txt &amp;&amp; ls'</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">skipped, since /tmp/test/<span class="number">1.</span>txt exists</span><br></pre></td></tr></table></figure><h4 id="script"><a href="#script" class="headerlink" title="script"></a>script</h4><blockquote><p>用于在被管理机器上面执行<code>shell</code>脚本的模块，脚本无需在被管理机器上面存在</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s script</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写shell脚本</span></span><br><span class="line">[root@ansible ~]<span class="comment"># vim ansible_test.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> `hostname`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在所有被管理机器上执行该脚本</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible all -m script -a '/root/ansible_test.sh'</span></span><br><span class="line">192.168.1.32 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"rc"</span>: 0, </span><br><span class="line">    <span class="string">"stderr"</span>: <span class="string">"Shared connection to 192.168.1.32 closed.\r\n"</span>, </span><br><span class="line">    <span class="string">"stderr_lines"</span>: [</span><br><span class="line">        <span class="string">"Shared connection to 192.168.1.32 closed."</span></span><br><span class="line">    ], </span><br><span class="line">    <span class="string">"stdout"</span>: <span class="string">"linux.node02.com\r\n"</span>, </span><br><span class="line">    <span class="string">"stdout_lines"</span>: [</span><br><span class="line">        <span class="string">"linux.node02.com"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h3 id="文件相关的模块"><a href="#文件相关的模块" class="headerlink" title="文件相关的模块"></a>文件相关的模块</h3><h4 id="file"><a href="#file" class="headerlink" title="file"></a>file</h4><blockquote><p>用于对文件的处理，创建，删除，权限控制等</p></blockquote><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s file</span></span><br><span class="line">path     <span class="comment">#要管理的文件路径</span></span><br><span class="line">recurse  <span class="comment">#递归</span></span><br><span class="line"><span class="keyword">state</span>：</span><br><span class="line">     directory  <span class="comment">#创建目录，如果目标不存在则创建目录及其子目录</span></span><br><span class="line">     touch      <span class="comment">#创建文件，如果文件存在，则修改文件 属性</span></span><br><span class="line">     </span><br><span class="line">     absent     <span class="comment">#删除文件或目录</span></span><br><span class="line">     mode       <span class="comment">#设置文件或目录权限</span></span><br><span class="line">     owner      <span class="comment">#设置文件或目录属主信息</span></span><br><span class="line">     group      <span class="comment">#设置文件或目录属组信息</span></span><br><span class="line">     <span class="keyword">link</span>       <span class="comment">#创建软连接，需要和src配合使用</span></span><br><span class="line">     hard       <span class="comment">#创建硬连接，需要和src配合使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m file -a 'path=/tmp/test1 state=directory'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建文件</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=touch'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立软链接（src表示源文件，path表示目标文件）</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m file -a 'src=/tmp/test1 path=/tmp/test3 state=link'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除文件</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=absent'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建文件时同时设置权限等信息</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m file -a 'path=/tmp/test4 state=directory mode=775 owner=root group=root'</span></span><br></pre></td></tr></table></figure><h4 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h4><blockquote><p>用于管理端复制文件到远程主机，并可以设置权限，属组，属主等</p></blockquote><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s copy</span></span><br><span class="line">src      <span class="comment">#需要copy的文件的源路径</span></span><br><span class="line">dest     <span class="comment">#需要copy的文件的目标路径</span></span><br><span class="line">backup   <span class="comment">#对copy的文件进行备份</span></span><br><span class="line">content  <span class="comment">#直接在远程主机被管理文件中添加内容，会覆盖原文件内容</span></span><br><span class="line">mode     <span class="comment">#对copy到远端的文件设置权限</span></span><br><span class="line">owner    <span class="comment">#对copy到远端的文件设置属主</span></span><br><span class="line">group    <span class="comment">#对copy到远端文件设置属组</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件到远程主机并改名</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件到远程主机，并备份远程文件,安装时间信息备份文件（当更新文件内容后，重新copy时用到）</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh backup=yes'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接在远程主机a.sh中添加内容</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh content="#!/bin/bash\n echo `uptime`"'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件到远程主机，并设置权限及属主与属组</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/passwd src=/etc/passwd mode=700 owner=root group=root'</span></span><br></pre></td></tr></table></figure><h4 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h4><blockquote><p>用于从被管理机器上面拉取文件，拉取下来的内容会保留目录结构，一般情况用在收集被管理机器的日志文件等</p></blockquote><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s fetch</span></span><br><span class="line">src      <span class="comment">#指定需要从远端机器拉取的文件路径</span></span><br><span class="line">dest     <span class="comment">#指定从远端机器拉取下来的文件存放路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从被管理机器上拉取cron日志文件，默认会已管理节点地址创建一个目录，并存放在内</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m fetch -a 'dest=/tmp src=/var/log/cron'</span></span><br><span class="line"></span><br><span class="line">[root@ansible ~]<span class="comment"># tree /tmp/192.168.1.31/</span></span><br><span class="line"><span class="regexp">/tmp/192.168.1.31/</span></span><br><span class="line">└── <span class="keyword">var</span></span><br><span class="line">    └── log</span><br><span class="line">        └── cron</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> directories, <span class="number">1</span> file</span><br></pre></td></tr></table></figure><h3 id="用户相关的模块"><a href="#用户相关的模块" class="headerlink" title="用户相关的模块"></a>用户相关的模块</h3><h4 id="user"><a href="#user" class="headerlink" title="user"></a>user</h4><blockquote><p>用于对系统用户的管理，用户的创建、删除、家目录、属组等设置</p></blockquote><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s user</span></span><br><span class="line">name        <span class="comment">#指定用户的名字</span></span><br><span class="line">home        <span class="comment">#指定用户的家目录</span></span><br><span class="line">uid         <span class="comment">#指定用户的uid</span></span><br><span class="line">group       <span class="comment">#指定用户的用户组</span></span><br><span class="line">groups      <span class="comment">#指定用户的附加组</span></span><br><span class="line">password    <span class="comment">#指定用户的密码</span></span><br><span class="line">shell       <span class="comment">#指定用户的登录shell</span></span><br><span class="line">create_home <span class="comment">#是否创建用户家目录，默认是yes</span></span><br><span class="line">remove      <span class="comment">#删除用户时，指定是否删除家目录</span></span><br><span class="line">state：</span><br><span class="line">      absent    <span class="comment">#删除用户</span></span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户名指定家目录，指定uid及组</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m user -a 'name=mysql home=/opt/mysql uid=1002 group=root'</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m shell  -a 'id mysql &amp;&amp; ls -l /opt'</span></span><br><span class="line"><span class="meta">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line">uid=<span class="number">1002</span>(mysql) gid=<span class="number">0</span>(root) 组=<span class="number">0</span>(root)</span><br><span class="line">总用量 <span class="number">0</span></span><br><span class="line">drwx------  <span class="number">3</span> mysql root <span class="number">78</span> <span class="number">5</span>月  <span class="number">27</span> <span class="number">18</span><span class="symbol">:</span><span class="number">13</span> mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户，不创建家目录，并且不能登录</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m user -a 'name=apache shell=/bin/nologin uid=1003 create_home=no'</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m shell  -a 'id apache &amp;&amp; tail -1 /etc/passwd'</span></span><br><span class="line"><span class="meta">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line">uid=<span class="number">1003</span>(apache) gid=<span class="number">1003</span>(apache) 组=<span class="number">1003</span>(apache)</span><br><span class="line"><span class="symbol">apache:</span><span class="symbol">x:</span><span class="number">1003</span><span class="symbol">:</span><span class="number">1003</span><span class="symbol">:</span><span class="symbol">:/home/apache</span><span class="symbol">:/bin/nologin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除用户</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m user -a 'name=apache state=absent'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除用户并删除家目录</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m user -a 'name=mysql state=absent remove=yes'</span></span><br></pre></td></tr></table></figure><h4 id="group"><a href="#group" class="headerlink" title="group"></a>group</h4><blockquote><p>用于创建组，当创建用户时如果需要指定组，组不存在的话就可以通过<code>group</code>先创建组</p></blockquote><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s group</span></span><br><span class="line">name     <span class="comment">#指定组的名字</span></span><br><span class="line">gid      <span class="comment">#指定组的gid</span></span><br><span class="line"><span class="keyword">state</span>：</span><br><span class="line">     absent   <span class="comment">#删除组</span></span><br><span class="line">     present  <span class="comment">#创建组（默认的状态）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建组</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m group -a 'name=www'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建组并指定gid</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m group -a 'name=www1 gid=1005'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除组</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m group -a 'name=www1 state=absent'</span></span><br></pre></td></tr></table></figure><h3 id="软件包相关的模块"><a href="#软件包相关的模块" class="headerlink" title="软件包相关的模块"></a>软件包相关的模块</h3><h4 id="yum"><a href="#yum" class="headerlink" title="yum"></a>yum</h4><blockquote><p>用于对软件包的管理，下载、安装、卸载、升级等操作</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 查看模块参数</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible-doc -s yum</span></span><br><span class="line">name            <span class="meta">#指定要操作的软件包名字</span></span><br><span class="line">download_dir    <span class="meta">#指定下载软件包的存放路径，需要配合download_only一起使用</span></span><br><span class="line">download_only   <span class="meta">#只下载软件包，而不进行安装，和yum --downloadonly一样</span></span><br><span class="line">list:</span><br><span class="line">    installed   <span class="meta">#列出所有已安装的软件包</span></span><br><span class="line">    updates     <span class="meta">#列出所有可以更新的软件包</span></span><br><span class="line">    repos       <span class="meta">#列出所有的yum仓库</span></span><br><span class="line">state:   </span><br><span class="line">    installed, present   <span class="meta">#安装软件包(两者任选其一都可以)</span></span><br><span class="line">    removed, absent      <span class="meta">#卸载软件包</span></span><br><span class="line">    latest      <span class="meta">#安装最新软件包</span></span><br><span class="line">    </span><br><span class="line"><span class="meta"># 列出所有已安装的软件包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'list=installed'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 列出所有可更新的软件包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'list=updates'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#列出所有的yum仓库</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'list=repos'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#只下载软件包并到指定目录下</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'name=httpd download_only=yes download_dir=/tmp'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#安装软件包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'name=httpd state=installed'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#卸载软件包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'name=httpd state=removed'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#安装包组，类似yum groupinstall <span class="string">'Development Tools'</span></span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'name="@Development Tools" state=installed'</span></span></span><br></pre></td></tr></table></figure><h4 id="pip"><a href="#pip" class="headerlink" title="pip"></a>pip</h4><blockquote><p>用于安装python中的包</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 查看模块参数</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible-doc -s pip</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 使用pip时，需要保证被管理机器上有python-pip软件包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'name=python-pip'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 安装pip包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m pip -a <span class="string">'name=flask'</span></span></span><br></pre></td></tr></table></figure><h4 id="service"><a href="#service" class="headerlink" title="service"></a>service</h4><blockquote><p>服务模块，用于对服务进行管理，服务的启动、关闭、开机自启等</p></blockquote><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s service</span></span><br><span class="line">name       <span class="comment">#指定需要管理的服务名</span></span><br><span class="line">enabled    <span class="comment">#指定是否开机自启动</span></span><br><span class="line"><span class="keyword">state</span>:     <span class="comment">#指定服务状态</span></span><br><span class="line">    started    <span class="comment">#启动服务</span></span><br><span class="line">    stopped    <span class="comment">#停止服务</span></span><br><span class="line">    restarted  <span class="comment">#重启服务</span></span><br><span class="line">    reloaded   <span class="comment">#重载服务</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务，并设置开机自启动 </span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m service -a 'name=crond state=started enabled=yes'</span></span><br></pre></td></tr></table></figure><h3 id="计划任务相关的模块"><a href="#计划任务相关的模块" class="headerlink" title="计划任务相关的模块"></a>计划任务相关的模块</h3><h4 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h4><blockquote><p>用于指定计划任务，和<code>crontab -e</code>一样</p></blockquote><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s cron</span></span><br><span class="line">job     <span class="comment">#指定需要执行的任务</span></span><br><span class="line">minute   <span class="comment">#分钟</span></span><br><span class="line">hour     <span class="comment">#小时</span></span><br><span class="line">day      <span class="comment">#天</span></span><br><span class="line">month    <span class="comment">#月</span></span><br><span class="line">weekday  <span class="comment">#周</span></span><br><span class="line">name     <span class="comment">#对计划任务进行描述</span></span><br><span class="line"><span class="symbol">state:</span></span><br><span class="line">    absetn   <span class="comment">#删除计划任务</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个计划任务，并描述是干嘛用的</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m cron -a "name='这是一个测试的计划任务' minute=* hour=* day=* month=* weekday=* job='/bin/bash /root/test.sh'"</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m shell -a 'crontab -l'</span></span><br><span class="line"><span class="meta">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="comment">#Ansible: 这是一个测试的计划任务</span></span><br><span class="line">* * * * * <span class="regexp">/bin/bash</span> /root/test.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个没有带描述的计划任务</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m cron -a "job='/bin/sh /root/test.sh'"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除计划任务</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m cron -a "name='None' job='/bin/sh /root/test.sh' state=absent"</span></span><br></pre></td></tr></table></figure><h3 id="系统信息相关的模块"><a href="#系统信息相关的模块" class="headerlink" title="系统信息相关的模块"></a>系统信息相关的模块</h3><h4 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h4><blockquote><p>用于获取系统信息的一个模块</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 查看模块参数</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible-doc -s setup</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看系统所有信息</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m setup</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># filter 对系统信息进行过滤</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m setup -a <span class="string">'filter=ansible_all_ipv4_addresses'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 常用的过滤选项</span></span><br><span class="line">ansible_all_ipv4_addresses         所有的ipv4地址</span><br><span class="line">ansible_all_ipv6_addresses         所有的ipv6地址</span><br><span class="line">ansible_architecture               系统的架构</span><br><span class="line">ansible_date_time                  系统时间</span><br><span class="line">ansible_default_ipv4               系统的默认ipv4地址</span><br><span class="line">ansible_distribution               系统名称</span><br><span class="line">ansible_distribution_file_variety  系统的家族</span><br><span class="line">ansible_distribution_major_version 系统的版本</span><br><span class="line">ansible_domain                     系统所在的域</span><br><span class="line">ansible_fqdn                       系统的主机名</span><br><span class="line">ansible_hostname                   系统的主机名,简写</span><br><span class="line">ansible_os_family                  系统的家族</span><br><span class="line">ansible_processor_cores            cpu的核数</span><br><span class="line">ansible_processor_count            cpu的颗数</span><br><span class="line">ansible_processor_vcpus            cpu的个数</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Ansible-Ad-hoc模式常用模块&quot;&gt;&lt;a href=&quot;#Ansible-Ad-hoc模式常用模块&quot; class=&quot;headerlink&quot; title=&quot;Ansible Ad-hoc模式常用模块&quot;&gt;&lt;/a&gt;Ansible Ad-hoc模式常用模块&lt;/h2&gt;&lt;
      
    
    </summary>
    
      <category term="Ansible" scheme="https://leeyj.coding.me/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://leeyj.coding.me/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible快速入门</title>
    <link href="https://leeyj.coding.me/2019/05/26/Ansible%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>https://leeyj.coding.me/2019/05/26/Ansible快速入门/</id>
    <published>2019-05-26T14:35:22.000Z</published>
    <updated>2019-07-10T01:46:29.899Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote><p><code>Ansible</code>是一款简单的运维自动化工具，只需要使用<code>ssh</code>协议连接就可以来进行系统管理，自动化执行命令，部署等任务。</p></blockquote><p><strong>Ansible的特点</strong></p><blockquote><p>1、ansible不需要单独安装客户端，也不需要启动任何服务<br>2、ansible是python中的一套完整的自动化执行任务模块<br>3、ansible playbook 采用yaml配置，对于自动化任务执行过一目了然</p></blockquote><p><strong>Ansible组成结构</strong></p><ul><li>Ansible<br>是<code>Ansible</code>的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。</li><li>Ansible Playbook<br>任务剧本（又称任务集），编排定义<code>Ansible</code>任务集的配置文件，由<code>Ansible</code>顺序依次执行，<code>yaml</code>格式。</li><li>Inventory<br><code>Ansible</code>管理主机的清单，默认是<code>/etc/ansible/hosts</code>文件。</li><li>Modules<br><code>Ansible</code>执行命令的功能模块，<code>Ansible2.3</code>版本为止，共有<code>1039</code>个模块。还可以自定义模块。</li><li>Plugins<br>插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。</li><li>API<br>提供给第三方程序调用的应用程序编程接口。</li></ul><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><table><thead><tr><th style="text-align:center">IP</th><th style="text-align:center">系统</th><th style="text-align:center">主机名</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">192.168.1.30</td><td style="text-align:center">CentOS7</td><td style="text-align:center">ansible</td><td style="text-align:center">ansible管理节点</td></tr><tr><td style="text-align:center">192.168.1.31</td><td style="text-align:center">CentOS7</td><td style="text-align:center">linux.node01.com</td><td style="text-align:center">被管理节点1</td></tr><tr><td style="text-align:center">192.168.1.32</td><td style="text-align:center">CentOS7</td><td style="text-align:center">linux.node02.com</td><td style="text-align:center">被管理节点2</td></tr><tr><td style="text-align:center">192.168.1.33</td><td style="text-align:center">CentOS7</td><td style="text-align:center">linux.node03.com</td><td style="text-align:center">被管理节点3</td></tr><tr><td style="text-align:center">192.168.1.36</td><td style="text-align:center">CentOS6</td><td style="text-align:center">linux.node06.com</td><td style="text-align:center">被管理节点6</td></tr></tbody></table><h2 id="Ansible安装"><a href="#Ansible安装" class="headerlink" title="Ansible安装"></a>Ansible安装</h2><p>1）配置<code>epel</code>源<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># yum clean all</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># yum makecache</span></span><br></pre></td></tr></table></figure></p><p>2）安装<code>ansible</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># yum -y install ansible</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ansible版本</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible --version</span></span><br><span class="line">ansible <span class="number">2.8</span><span class="number">.0</span></span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [<span class="string">u'/root/.ansible/plugins/modules'</span>, <span class="string">u'/usr/share/ansible/plugins/modules'</span>]</span><br><span class="line">  ansible python module location = /usr/lib/python2<span class="number">.7</span>/site-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = <span class="number">2.7</span><span class="number">.5</span> (default, Aug  <span class="number">4</span> <span class="number">2017</span>, <span class="number">00</span>:<span class="number">39</span>:<span class="number">18</span>) [GCC <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-16</span>)]</span><br></pre></td></tr></table></figure></p><h2 id="Ansible-Inventory文件"><a href="#Ansible-Inventory文件" class="headerlink" title="Ansible Inventory文件"></a>Ansible Inventory文件</h2><p><a href="http://www.ansible.com.cn/docs/intro_inventory.html" target="_blank" rel="noopener">Inventory中文文档</a></p><blockquote><p><code>Inventory</code>文件通常用于定义要管理的主机的认证信息，例如<code>ssh</code>登录用户名、密码以及<code>key</code>相关信息。可以同时操作一个组的多台主机，组与主机组之间的关系都是通过<code>inventory</code>文件配置。配置文件路径为：<code>/etc/ansible/hosts</code></p></blockquote><h3 id="基于密码连接"><a href="#基于密码连接" class="headerlink" title="基于密码连接"></a>基于密码连接</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class="line"><span class="comment"># 方法一 主机+端口+密码</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.31 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line">192.168.1.32 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line">192.168.1.33 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line">192.168.1.36 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二 主机+端口+密码</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.3[1:3] <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二 主机+端口+密码</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.3[1:3]</span><br><span class="line">[webserver:vars]</span><br><span class="line"><span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br></pre></td></tr></table></figure><h3 id="基于秘钥连接"><a href="#基于秘钥连接" class="headerlink" title="基于秘钥连接"></a>基于秘钥连接</h3><blockquote><p>基于秘钥连接需要先创建公钥和私钥，并发送给被管理机器</p></blockquote><p>1）生成公私钥<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# ssh-keygen</span><br><span class="line">[root@ansible ~]# for i in &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>&#125;; do ssh-copy-id -i <span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span>$i ; done</span><br></pre></td></tr></table></figure></p><p>2）配置连接<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class="line"><span class="comment"># 方法一 主机+端口+密钥</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.31:22</span><br><span class="line">192.168.1.32</span><br><span class="line">192.168.1.33</span><br><span class="line">192.168.1.36</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法一 别名主机+端口+密钥</span></span><br><span class="line">[webserver]</span><br><span class="line">node1 <span class="attribute">ansible_ssh_host</span>=192.168.1.31 <span class="attribute">ansible_ssh_port</span>=22</span><br><span class="line">node2 <span class="attribute">ansible_ssh_host</span>=192.168.1.32 <span class="attribute">ansible_ssh_port</span>=22</span><br><span class="line">node3 <span class="attribute">ansible_ssh_host</span>=192.168.1.33 <span class="attribute">ansible_ssh_port</span>=22</span><br><span class="line">node6 <span class="attribute">ansible_ssh_host</span>=192.168.1.36 <span class="attribute">ansible_ssh_port</span>=22</span><br></pre></td></tr></table></figure></p><h3 id="主机组的使用"><a href="#主机组的使用" class="headerlink" title="主机组的使用"></a>主机组的使用</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 主机组变量名+主机+密码</span></span><br><span class="line">[<span class="meta">apache</span>]</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.36</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span></span><br><span class="line">[<span class="meta">apache.vars</span>]</span><br><span class="line">ansible_ssh_pass=<span class="string">'123456'</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 主机组变量名+主机+密钥</span></span><br><span class="line">[<span class="meta">nginx</span>]</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span>[<span class="number">1</span>:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta"># 定义多个组，把一个组当另外一个组的组员</span></span><br><span class="line">[<span class="meta">webserver:children</span>]  <span class="meta">#webserver组包括两个子组：apache nginx</span></span><br><span class="line">apache</span><br><span class="line">nginx</span><br></pre></td></tr></table></figure><h3 id="临时指定inventory"><a href="#临时指定inventory" class="headerlink" title="临时指定inventory"></a>临时指定inventory</h3><p>1）先编辑一个主机定义清单<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# vim /etc/dockers</span><br><span class="line">[dockers]</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> ansible_ssh_pass='<span class="number">123456</span>'</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span></span><br></pre></td></tr></table></figure></p><p>2）在执行命令是指定<code>inventory</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# ansible dockers -m<span class="built_in"> ping </span>-i /etc/dockers -o </span><br><span class="line">192.168.1.33 | SUCCESS =&gt; &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: <span class="literal">false</span>, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line">192.168.1.32 | SUCCESS =&gt; &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: <span class="literal">false</span>, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line">192.168.1.31 | SUCCESS =&gt; &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: <span class="literal">false</span>, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br></pre></td></tr></table></figure></p><h3 id="Inventory内置参数"><a href="#Inventory内置参数" class="headerlink" title="Inventory内置参数"></a>Inventory内置参数</h3><p><img src="/2019/05/26/Ansible快速入门/ansible01.png" alt="ansible inventory内置参数"></p><h2 id="Ansible-Ad-Hoc"><a href="#Ansible-Ad-Hoc" class="headerlink" title="Ansible Ad-Hoc"></a>Ansible Ad-Hoc</h2><p><a href="http://www.ansible.com.cn/docs/intro_adhoc.html" target="_blank" rel="noopener">Ad-Hoc中文文档</a></p><blockquote><p>ad hoc —— 临时的，在<code>ansible</code>中是指需要快速执行，并且不需要保存的命令。说白了就是执行简单的命令——一条命令。对于复杂的命令则为<code>playbook</code>，类似于<code>saltstack</code>的<code>state sls</code>状态文件。</p></blockquote><h3 id="ansible命令格式"><a href="#ansible命令格式" class="headerlink" title="ansible命令格式"></a>ansible命令格式</h3><p>1）常用命令参数<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# ansible -h</span><br><span class="line">Usage: ansible &lt;host-pattern&gt; [options]</span><br><span class="line">-<span class="ruby">a MODULE_ARGS   <span class="comment">#模块参数</span></span></span><br><span class="line"><span class="ruby">-C, --check  <span class="comment">#检查语法</span></span></span><br><span class="line"><span class="ruby">-f FORKS <span class="comment">#并发</span></span></span><br><span class="line"><span class="ruby">--list-hosts <span class="comment">#列出主机列表</span></span></span><br><span class="line"><span class="ruby">-m MODULE_NAME <span class="comment">#模块名字</span></span></span><br><span class="line"><span class="ruby">-o 使用精简的输出</span></span><br></pre></td></tr></table></figure></p><p>2）示例<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@ansible</span> ~]<span class="comment"># ansible webserver -m shell -a 'uptime' -o</span></span><br><span class="line">192.168.1.36 |<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  13:46:14 up 1 day,  9:20,  4 users,  load average: 0.00, 0.00, 0.00</span></span><br><span class="line"><span class="string">192.168.1.33 </span>|<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  21:26:33 up 1 day,  8:51,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class="line"><span class="string">192.168.1.31 </span>|<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  21:26:33 up 1 day,  8:50,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class="line"><span class="string">192.168.1.32 </span>|<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  21:26:33 up 1 day,  8:59,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br></pre></td></tr></table></figure></p><p>3）命令说明<br><img src="/2019/05/26/Ansible快速入门/ansible02.png" alt="ansible command"></p><h3 id="host-pattern格式"><a href="#host-pattern格式" class="headerlink" title="host-pattern格式"></a>host-pattern格式</h3><p>目标<code>target</code>主机，主机组匹配方式</p><h4 id="主机的匹配"><a href="#主机的匹配" class="headerlink" title="主机的匹配"></a>主机的匹配</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  一台目标主机</span></span><br><span class="line">[root@ansible ~]# ansible 192.168.1.31 -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多台目标主机</span></span><br><span class="line">[root@ansible ~]# ansible 192.168.1.31,192.168.1.32 -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有目标主机</span></span><br><span class="line">[root@ansible ~]# ansible all -m ping</span><br></pre></td></tr></table></figure><h4 id="组的匹配"><a href="#组的匹配" class="headerlink" title="组的匹配"></a>组的匹配</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 组的配置信息如下：这里定义了一个nginx组和一个apache组</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible nginx --list</span></span><br><span class="line">  hosts (<span class="number">2</span>)<span class="symbol">:</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.31</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.32</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible apache --list</span></span><br><span class="line">  hosts (<span class="number">3</span>)<span class="symbol">:</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.36</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.33</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.32</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一个组的所有主机匹配</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible apache -m ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配apache组中有，但是nginx组中没有的所有主机</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 'apache:!nginx' -m ping -o</span></span><br><span class="line"><span class="meta">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配apache组和nginx组中都有的机器（并集）</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 'apache:&amp;nginx' -m ping -o</span></span><br><span class="line"><span class="meta">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配apache组nginx组两个组所有的机器（并集）；等于ansible apache,nginx -m ping</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 'apache:nginx' -m ping -o</span></span><br><span class="line"><span class="meta">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.31 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;Ansible&lt;/code&gt;是一款简单的运维自动化工具，只需要使用&lt;code&gt;ssh&lt;/code&gt;协议
      
    
    </summary>
    
      <category term="Ansible" scheme="https://leeyj.coding.me/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://leeyj.coding.me/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>linux保存history到日志文件</title>
    <link href="https://leeyj.coding.me/2019/05/22/linux%E4%BF%9D%E5%AD%98history%E5%88%B0%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6/"/>
    <id>https://leeyj.coding.me/2019/05/22/linux保存history到日志文件/</id>
    <published>2019-05-22T08:30:09.000Z</published>
    <updated>2019-07-10T01:46:30.040Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑<code>/etc/bashrc</code>文件记录历史命令到日志文件下面，并已登录来源<code>IP</code>，登录用户名，登录时间命名日志文件名字</p></blockquote><h5 id="查看默认的history"><a href="#查看默认的history" class="headerlink" title="查看默认的history"></a>查看默认的history</h5><p><img src="https://upload-images.jianshu.io/upload_images/11763553-a2f73d6c0783224d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="默认的history"></p><h5 id="编辑-etc-bashrc"><a href="#编辑-etc-bashrc" class="headerlink" title="编辑/etc/bashrc"></a>编辑/etc/bashrc</h5><p>编辑<code>/etc/bashrc</code>文件，加入以下内容，也可以放在<code>/etc/profile</code>文件里<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/bashrc</span></span><br><span class="line">USER_IP=$(<span class="built_in">echo</span> -e <span class="string">"\033[31m\033[1m`who -u am i 2&gt;/dev/null| awk '&#123;print <span class="variable">$NF</span>&#125;'|sed -e 's/[()]//g'`\033[0m"</span>)</span><br><span class="line">IP=$(who -u am i 2&gt;/dev/null| awk <span class="string">'&#123;print $NF&#125;'</span>|sed -e <span class="string">'s/[()]//g'</span>)</span><br><span class="line">USER=$(whoami)</span><br><span class="line">USER_NAME=`<span class="built_in">echo</span> -e <span class="string">"\033[36m\033[1m<span class="variable">$(whoami)</span> \033[0m"</span>`</span><br><span class="line">HISTFILESIZE=100000</span><br><span class="line">HISTSIZE=4096</span><br><span class="line">HISTTIMEFORMAT=<span class="string">"%F %T  <span class="variable">$USER_IP</span>  <span class="variable">$USER_NAME</span>  "</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$USER_IP</span>"</span> = <span class="string">""</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   USER_IP=`hostname`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d /var/<span class="built_in">log</span>/<span class="built_in">history</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   mkdir /var/<span class="built_in">log</span>/<span class="built_in">history</span></span><br><span class="line">   chmod 777 /var/<span class="built_in">log</span>/<span class="built_in">history</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    mkdir /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span></span><br><span class="line">    chmod 300 /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">DT=`date <span class="string">"+%Y%m%d_%H%M"</span>`</span><br><span class="line"><span class="built_in">export</span> HISTFILE=<span class="string">"/var/log/history/<span class="variable">$&#123;LOGNAME&#125;</span>/<span class="variable">$&#123;DT&#125;</span>_<span class="variable">$&#123;USER&#125;</span>_<span class="variable">$&#123;IP&#125;</span>"</span></span><br><span class="line">chmod 600 /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span>/* 2&gt;/dev/null</span><br></pre></td></tr></table></figure></p><p>退出重新登录再次查看<br><img src="https://upload-images.jianshu.io/upload_images/11763553-dad4faed53395912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>查看前面保留的历史记录日志<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# <span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/</span><br><span class="line">总用量 <span class="number">0</span></span><br><span class="line">d-wx------. <span class="number">2</span> root root <span class="number">6</span> <span class="number">5</span>月  <span class="number">22</span> <span class="number">14</span>:<span class="number">27</span> root</span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# <span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/root/</span><br><span class="line">总用量 <span class="number">4</span></span><br><span class="line">-rw-------. <span class="number">1</span> root root <span class="number">123</span> <span class="number">5</span>月  <span class="number">22</span> <span class="number">14</span>:<span class="number">29</span> <span class="number">20190522</span>_1427_root_192.<span class="number">168.1</span>.<span class="number">123</span></span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/root/<span class="number">20190522</span>_1427_root_192.<span class="number">168.1</span>.<span class="number">123</span> </span><br><span class="line">#<span class="number">1558506461</span></span><br><span class="line"><span class="keyword">ls</span></span><br><span class="line">#<span class="number">1558506467</span></span><br><span class="line"><span class="keyword">history</span></span><br><span class="line">#<span class="number">1558506519</span></span><br><span class="line"><span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/</span><br><span class="line">#<span class="number">1558506571</span></span><br><span class="line"><span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/root/</span><br><span class="line">#<span class="number">1558506574</span></span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑&lt;code&gt;/etc/bashrc&lt;/code&gt;文件记录历史命令到日志文件下面，并已登录来源&lt;code&gt;IP&lt;/
      
    
    </summary>
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/categories/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/tags/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>saltstack项目实战</title>
    <link href="https://leeyj.coding.me/2019/05/21/saltstack%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/"/>
    <id>https://leeyj.coding.me/2019/05/21/saltstack项目实战/</id>
    <published>2019-05-21T07:43:05.000Z</published>
    <updated>2019-07-10T01:46:30.094Z</updated>
    
    <content type="html"><![CDATA[<h2 id="项目架构规划"><a href="#项目架构规划" class="headerlink" title="项目架构规划"></a>项目架构规划</h2><blockquote><p>后端web服务器使用<code>Nginx+Php</code>作为站点，通过<code>HAproxy</code>做负载均衡，<code>Keepalived</code>做高可用</p></blockquote><p><img src="/2019/05/21/saltstack项目实战/01.png" alt="架构规划图"></p><h2 id="项目环境准备"><a href="#项目环境准备" class="headerlink" title="项目环境准备"></a>项目环境准备</h2><p><img src="/2019/05/21/saltstack项目实战/02.png" alt="环境准备"></p><p><strong>说明：</strong> 关闭防火墙、<code>selinux</code>、时间同步等<br><code>host</code>绑定<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /etc/hosts</span><br><span class="line"><span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>salt-master</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.31</span>salt-minion01</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.32</span>salt-minion02</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.33</span>salt-minion03</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.34</span>salt-minion04</span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# for i <span class="keyword">in</span> <span class="string">`seq 4`</span><span class="comment">; do scp /etc/hosts 192.168.1.3$i:/etc/hosts ; done</span></span><br></pre></td></tr></table></figure></p><h3 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h3><p><a href="https://www.cnblogs.com/yanjieli/p/10864648.html" target="_blank" rel="noopener">参考地址</a><br>1）<code>Master</code>上软件安装<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class="number">2</span>.el7.noarch.rpm</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# sed</span> -i <span class="string">"s/repo.saltstack.com/mirrors.aliyun.com\/saltstack/g"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> enable salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> <span class="literal">start</span> salt-<span class="literal">master</span></span><br></pre></td></tr></table></figure></p><p>2）<code>Minion</code>上软件安装并配置<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm</span></span><br><span class="line"><span class="meta"># yum -y install salt-minion</span></span><br><span class="line"><span class="meta"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class="line"><span class="meta"># sed -i '/#master: /c\master: salt-master' /etc/salt/minion</span></span><br><span class="line"><span class="meta"># systemctl enable salt-minion</span></span><br><span class="line"><span class="meta"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p><h3 id="Master上认证"><a href="#Master上认证" class="headerlink" title="Master上认证"></a>Master上认证</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -L </span><br><span class="line">Accepted Keys:</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">salt-minion02</span><br><span class="line">salt-minion03</span><br><span class="line">salt-minion04</span><br><span class="line">Rejected Keys:</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -A -y</span><br><span class="line">The following keys are going to be accepted:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">salt-minion02</span><br><span class="line">salt-minion03</span><br><span class="line">salt-minion04</span><br><span class="line">Key for minion salt-minion01 accepted.</span><br><span class="line">Key for minion salt-minion02 accepted.</span><br><span class="line">Key for minion salt-minion03 accepted.</span><br><span class="line">Key for minion salt-minion04 accepted.</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -L </span><br><span class="line">Accepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">salt-minion02</span><br><span class="line">salt-minion03</span><br><span class="line">salt-minion04</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">Rejected Keys:</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' test.ping</span><br><span class="line">salt-minion01:</span><br><span class="line">    <span class="literal">True</span></span><br><span class="line">salt-minion02:</span><br><span class="line">    <span class="literal">True</span></span><br><span class="line">salt-minion03:</span><br><span class="line">    <span class="literal">True</span></span><br><span class="line">salt-minion04:</span><br><span class="line">    <span class="literal">True</span></span><br></pre></td></tr></table></figure><h2 id="Master上state编写"><a href="#Master上state编写" class="headerlink" title="Master上state编写"></a>Master上state编写</h2><h3 id="state环境设置"><a href="#state环境设置" class="headerlink" title="state环境设置"></a>state环境设置</h3><blockquote><p>说明：该案例在<code>prod</code>环境下配置，在<code>prod</code>下面创建了一个<code>modules</code>的目录，所有的安装配置都放在这个目录下面了，里面分别又对应创建了对应的软件目录，每个软件目录下面的<code>files</code>目录用来存放的是软件包或者配置文件模板<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">file_roots:</span><br><span class="line">  base:</span><br><span class="line">    - /srv/salt/base</span><br><span class="line">  test:</span><br><span class="line">    - /srv/salt/test</span><br><span class="line">  prod:</span><br><span class="line">    - /srv/salt/prod</span><br><span class="line">  dev:</span><br><span class="line">    - /srv/salt/dev</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/&#123;base,test,prod,dev&#125;</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/prod/modules/&#123;nginx,php,mysql,haproxy,keepalived,lnmp&#125;/files</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> /srv/salt/prod/modules/user</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# tree</span> /srv/salt/prod/modules/</span><br><span class="line">/srv/salt/prod/modules/</span><br><span class="line">├── haproxy</span><br><span class="line">│   └── files</span><br><span class="line">├── keepalived</span><br><span class="line">│   └── files</span><br><span class="line">├── lnmp</span><br><span class="line">│   └── files</span><br><span class="line">├── mysql</span><br><span class="line">│   └── files</span><br><span class="line">├── nginx</span><br><span class="line">│   └── files</span><br><span class="line">├── php</span><br><span class="line">│   └── files</span><br><span class="line">└── user</span><br><span class="line"></span><br><span class="line"><span class="number">13</span> directories, <span class="number">0</span> files</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="sls文件编写"><a href="#sls文件编写" class="headerlink" title="sls文件编写"></a>sls文件编写</h3><h4 id="pkg基础包"><a href="#pkg基础包" class="headerlink" title="pkg基础包"></a>pkg基础包</h4><p>安装源码编译所需要用到的基础软件包<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /srv/salt/prod/modules/pkg.sls </span><br><span class="line">pkg-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    -<span class="ruby"> <span class="symbol">pkgs:</span></span></span><br><span class="line"><span class="ruby">      - gcc</span></span><br><span class="line"><span class="ruby">      - gcc-c++</span></span><br><span class="line"><span class="ruby">      - make</span></span><br><span class="line"><span class="ruby">      - autoconf</span></span><br><span class="line"><span class="ruby">      - glibc</span></span><br><span class="line"><span class="ruby">      - glibc-devel</span></span><br><span class="line"><span class="ruby">      - glib2</span></span><br><span class="line"><span class="ruby">      - glib2-devel</span></span><br><span class="line"><span class="ruby">      - pcre</span></span><br><span class="line"><span class="ruby">      - pcre-devel</span></span><br><span class="line"><span class="ruby">      - zlib</span></span><br><span class="line"><span class="ruby">      - zlib-devel</span></span><br><span class="line"><span class="ruby">      - openssl</span></span><br><span class="line"><span class="ruby">      - openssl-devel</span></span><br><span class="line"><span class="ruby">      - libpng</span></span><br><span class="line"><span class="ruby">      - libpng-devel</span></span><br><span class="line"><span class="ruby">      - freetype</span></span><br><span class="line"><span class="ruby">      - freetype-devel</span></span><br><span class="line"><span class="ruby">      - libxml2</span></span><br><span class="line"><span class="ruby">      - libxml2-devel</span></span><br><span class="line"><span class="ruby">      - bzip2</span></span><br><span class="line"><span class="ruby">      - bzip2-devel</span></span><br><span class="line"><span class="ruby">      - ncurses</span></span><br><span class="line"><span class="ruby">      - curl</span></span><br><span class="line"><span class="ruby">      - gdbm-devel</span></span><br><span class="line"><span class="ruby">      - libXpm-devel</span></span><br><span class="line"><span class="ruby">      - libX11-devel</span></span><br><span class="line"><span class="ruby">      - gd-devel</span></span><br><span class="line"><span class="ruby">      - gmp-devel</span></span><br><span class="line"><span class="ruby">      - readline-devel</span></span><br><span class="line"><span class="ruby">      - libxslt-devel</span></span><br><span class="line"><span class="ruby">      - expat-devel</span></span><br><span class="line"><span class="ruby">      - xmlrpc-c</span></span><br><span class="line"><span class="ruby">      - xmlrpc-c-devel</span></span><br></pre></td></tr></table></figure></p><h4 id="useradd"><a href="#useradd" class="headerlink" title="useradd"></a>useradd</h4><p>创建网站运行用户<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/modules/user/www.sls</span> </span><br><span class="line"><span class="attr">www-user-group:</span></span><br><span class="line">  <span class="string">group.present:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - gid:</span> <span class="number">2000</span></span><br><span class="line"></span><br><span class="line">  <span class="string">user.present:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - fullname:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - shell:</span> <span class="string">/sbin/nologin</span></span><br><span class="line"><span class="attr">    - uid:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">    - gid:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">id</span> <span class="string">www</span></span><br></pre></td></tr></table></figure></p><h4 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/nginx/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">nginx</span>]<span class="comment"># tree </span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── nginx-<span class="number">1.12</span>.<span class="number">2</span>.tar.gz</span><br><span class="line">│   ├── nginx-<span class="number">1.16</span>.<span class="number">0</span>.tar.gz</span><br><span class="line">│   ├── nginx.conf.template</span><br><span class="line">│   └── nginx.service.template</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">6</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master nginx]<span class="comment"># cat install.sls </span></span><br><span class="line">&#123;% <span class="keyword">set</span> nginx_<span class="keyword">version</span> = <span class="string">"1.16.0"</span>%&#125;</span><br><span class="line">include:</span><br><span class="line">  - modules.pkg</span><br><span class="line">  - modules.user.www</span><br><span class="line"></span><br><span class="line">nginx-install:</span><br><span class="line">  file.managed:</span><br><span class="line">    - name: <span class="string">/usr/local/src/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - source: salt:<span class="string">//modules/nginx/files/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - mode: 644</span><br><span class="line"></span><br><span class="line">  cmd.run:</span><br><span class="line">    - name: <span class="keyword">cd</span> <span class="string">/usr/local/src/</span> &amp;&amp; tar xf nginx-&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span> &amp;&amp; <span class="keyword">cd</span> nginx-&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; &amp;&amp; <span class="string">./configure</span> <span class="params">--prefix=/usr/local/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; <span class="params">--user=root</span> <span class="params">--group=root</span> <span class="params">--with-http_ssl_module</span> <span class="params">--with-stream</span> <span class="params">--with-http_stub_status_module</span> <span class="params">--with-file-aio</span> <span class="params">--with-http_gzip_static_module</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class="string">/usr/local/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; <span class="string">/usr/local/nginx</span></span><br><span class="line">    - unless: test -d <span class="string">/usr/local/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; &amp;&amp; test -L <span class="string">/usr/local/nginx</span></span><br><span class="line">    - require:</span><br><span class="line">      - file: nginx-install</span><br><span class="line">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">nginx]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入nginx安装sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.nginx.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#添加systemctl</span></span><br><span class="line"><span class="attr">nginx-init:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/lib/systemd/system/nginx.service</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/nginx/files/nginx.service.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">test</span> <span class="bullet">-f</span> <span class="string">/usr/lib/systemd/system/nginx.service</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">nginx-init</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件</span></span><br><span class="line"><span class="string">/usr/local/nginx/conf/nginx.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/nginx/files/nginx.conf.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动nginx</span></span><br><span class="line"><span class="attr">nginx-service:</span></span><br><span class="line">  <span class="string">file.directory:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/nginx/conf/conf.d</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">nginx-install</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - reload:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">nginx-init</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">/usr/local/nginx/conf/nginx.conf</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">nginx-service</span></span><br></pre></td></tr></table></figure></p><h4 id="php"><a href="#php" class="headerlink" title="php"></a>php</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/php/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">php</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── php-<span class="number">5.6</span>.<span class="number">40</span>.tar.gz</span><br><span class="line">│   ├── php-fpm.conf.template</span><br><span class="line">│   ├── php-fpm.service.template</span><br><span class="line">│   ├── php-fpm.template</span><br><span class="line">│   └── php.ini.template</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">7</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master php]<span class="comment"># cat install.sls </span></span><br><span class="line">&#123;% <span class="keyword">set</span> php_<span class="keyword">version</span> = <span class="string">"5.6.40"</span> %&#125;</span><br><span class="line">include:</span><br><span class="line">  - modules.pkg</span><br><span class="line"></span><br><span class="line">php-install:</span><br><span class="line">  file.managed:</span><br><span class="line">    - name: <span class="string">/usr/local/src/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - source: salt:<span class="string">//modules/php/files/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - mode: 644</span><br><span class="line"></span><br><span class="line">  cmd.run:</span><br><span class="line">    - name: <span class="keyword">cd</span> <span class="string">/usr/local/src/</span> &amp;&amp; tar xf php-&#123;&#123; php_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span> &amp;&amp; <span class="keyword">cd</span> php-&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; &amp;&amp; <span class="string">./configure</span> <span class="params">--prefix=/usr/local/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; <span class="params">--with-curl</span> <span class="params">--with-freetype-dir</span> <span class="params">--with-gd</span> <span class="params">--with-gettext</span> <span class="params">--with-iconv-dir</span> <span class="params">--with-jpeg-dir</span> <span class="params">--with-kerberos</span> <span class="params">--with-libdir=lib64</span> <span class="params">--with-libxml-dir</span> <span class="params">--with-mysql</span> <span class="params">--with-mysqli</span> <span class="params">--with-openssl</span> <span class="params">--with-pcre-regex</span> <span class="params">--with-pdo-mysql</span> <span class="params">--with-dpo-sqlite</span> <span class="params">--with-pear</span> <span class="params">--with-png-dir</span> <span class="params">--with-openssl</span> <span class="params">--with-xmlrpc</span> <span class="params">--with-xsl</span> <span class="params">--with-zlib</span> <span class="params">--enable-fpm</span> <span class="params">--enable-bcmath</span> <span class="params">--enable-libxml</span> <span class="params">--enable-inline-optimization</span> <span class="params">--enable-gd-native-ttf</span> <span class="params">--enable-mbregex</span> <span class="params">--enable-mbstring</span> <span class="params">--enable-opcache</span> <span class="params">--enable-pcntl</span> <span class="params">--enable-shmop</span> <span class="params">--enable-soap</span> <span class="params">--enable-sockets</span> <span class="params">--enable-sysvsem</span> <span class="params">--enable-xml</span> <span class="params">--enable-zip</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class="string">/usr/local/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; <span class="string">/usr/local/php</span></span><br><span class="line">    - unless: test -d <span class="string">/usr/local/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; &amp;&amp; test -L <span class="string">/usr/local/php</span></span><br><span class="line">    - require:</span><br><span class="line">      - file: php-install</span><br><span class="line">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">php]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入php安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.php.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#php-ini配置文件配置</span></span><br><span class="line"><span class="attr">php-ini:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/php/etc/php.ini</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php.ini.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ln</span> <span class="bullet">-s</span> <span class="string">/usr/local/php/etc/php.ini</span> <span class="string">/etc/php.ini</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">test</span> <span class="bullet">-L</span> <span class="string">/etc/php.ini</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-ini</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#php-fpm配置文件配置</span></span><br><span class="line"><span class="attr">php-fpm:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/php/etc/php-fpm.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php-fpm.conf.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ln</span> <span class="bullet">-s</span> <span class="string">/usr/local/php/etc/php-fpm.conf</span> <span class="string">/etc/php-fpm.conf</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">test</span> <span class="bullet">-L</span> <span class="string">/etc/php-fpm.conf</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-fpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#加入system启动</span></span><br><span class="line"><span class="attr">php-systemd:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/lib/systemd/system/php-fpm.service</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php-fpm.service.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#加入/etc/init.d/启动</span></span><br><span class="line"><span class="attr">php-init:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/init.d/php-fpm</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php-fpm.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动php-fpm</span></span><br><span class="line"><span class="attr">php-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-systemd</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-ini</span></span><br></pre></td></tr></table></figure></p><h4 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h4><p>1）配置文件模板准备<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/mysql/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">mysql</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   └── my.cnf</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">mysql</span>]<span class="comment"># cat install.sls </span></span><br><span class="line">mariadb-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - pkgs:</span><br><span class="line">      - mariadb-server</span><br><span class="line">      - mariadb</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">mysql]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入mysql安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.mysql.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#my.cnf配置文件</span></span><br><span class="line"><span class="attr">mariadb-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/my.cnf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/mysql/files/my.cnf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">mariadb-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动mariadb</span></span><br><span class="line"><span class="attr">mariadb-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">mariadb</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">mariadb-config</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">mariadb-install</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">mariadb-config</span></span><br></pre></td></tr></table></figure></p><h4 id="lnmp"><a href="#lnmp" class="headerlink" title="lnmp"></a>lnmp</h4><p>1）准备测试文件<code>php info</code> 和<code>nginx</code>虚拟主机配置文件<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/lnmp/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">lnmp</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── index.php</span><br><span class="line">│   └── www.conf</span><br><span class="line">└── www.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>www.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">lnmp]#</span> <span class="string">cat</span> <span class="string">www.sls</span> </span><br><span class="line"><span class="comment">#引入nginx、php、mysql的安装</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.nginx.service</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.php.service</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.mysql.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#虚拟主机web站点目录创建</span></span><br><span class="line"><span class="attr">web-www:</span></span><br><span class="line">  <span class="string">file.directory:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/opt/www</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#虚拟主机配置文件配置</span></span><br><span class="line"><span class="attr">web-www-conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/nginx/conf/conf.d/www.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/lnmp/files/www.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">web-www</span></span><br><span class="line"><span class="attr">    - watch_in:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="attr">      PORT:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      IPADDR:</span> <span class="string">&#123;&#123;</span> <span class="string">grains['fqdn_ip4'][0]</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#phpinfo测试文件准备</span></span><br><span class="line"><span class="attr">web-index:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/opt/www/index.php</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/lnmp/files/index.php</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br></pre></td></tr></table></figure></p><h4 id="测试lnmp是否OK"><a href="#测试lnmp是否OK" class="headerlink" title="测试lnmp是否OK"></a>测试lnmp是否OK</h4><p>1）<code>Top file</code>编写<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/top.sls </span><br><span class="line">prod:</span><br><span class="line">  <span class="string">"salt-minion0[3-4]"</span>:</span><br><span class="line">    - modules.lnmp.www</span><br></pre></td></tr></table></figure></p><p>2）执行高级状态<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><p>3）访问测试<br><img src="/2019/05/21/saltstack项目实战/03.png" alt="http://192.168.1.31"><br><img src="/2019/05/21/saltstack项目实战/04.png" alt="http://192.168.1.32"></p><h4 id="haproxy"><a href="#haproxy" class="headerlink" title="haproxy"></a>haproxy</h4><p>1）配置文件准备<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/haproxy/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">haproxy</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   └── haproxy.cfg</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">haproxy</span>]<span class="comment"># cat install.sls </span></span><br><span class="line">haproxy-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - name: haproxy</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">haproxy]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入haproxy安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.haproxy.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件</span></span><br><span class="line"><span class="attr">haproxy-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/haproxy/files/haproxy.cfg</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">haproxy-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动haproxy</span></span><br><span class="line"><span class="attr">haproxy-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">haproxy</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">haproxy-install</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">haproxy-config</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">haproxy-config</span></span><br></pre></td></tr></table></figure></p><h4 id="keepalived"><a href="#keepalived" class="headerlink" title="keepalived"></a>keepalived</h4><p>1）配置文件准备<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/keepalived/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   └── keepalived.conf</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment"># cat install.sls </span></span><br><span class="line">keepalived-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - name: keepalived</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">keepalived]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入keepalived安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.keepalived.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#keepalived配置文件</span></span><br><span class="line"><span class="attr">keepalived-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/keepalived/keepalived.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/keepalived/files/keepalived.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">keepalived-install</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">if</span> <span class="string">grains['fqdn']</span> <span class="string">==</span> <span class="string">"salt-minion01"</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="attr">      ROUTER_ID:</span> <span class="string">saltstack01</span></span><br><span class="line"><span class="attr">      STATE:</span> <span class="string">MASTER</span></span><br><span class="line"><span class="attr">      PRIORITY:</span> <span class="number">150</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">elif</span> <span class="string">grains['fqdn']</span> <span class="string">==</span> <span class="string">"salt-minion02"</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="attr">      ROUTER_ID:</span> <span class="string">saltstack02</span></span><br><span class="line"><span class="attr">      STATE:</span> <span class="string">BACKUP</span></span><br><span class="line"><span class="attr">      PRIORITY:</span> <span class="number">100</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">endif</span> <span class="string">%&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动keepalived</span></span><br><span class="line"><span class="attr">keepalived-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">keepalived</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">keepalived-install</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">keepalived-config</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">keepalived-config</span></span><br></pre></td></tr></table></figure></p><h3 id="整体部署"><a href="#整体部署" class="headerlink" title="整体部署"></a>整体部署</h3><p>1）top file 编写<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/top.sls </span><br><span class="line">prod:</span><br><span class="line">  <span class="string">"salt-minion0[3-4]"</span>:</span><br><span class="line">    - modules.lnmp.www</span><br><span class="line"></span><br><span class="line">  <span class="string">"salt-minion0[1-2]"</span>:</span><br><span class="line">    - modules.haproxy.service</span><br><span class="line">    - modules.keepalived.service</span><br></pre></td></tr></table></figure></p><p>2）高级状态执行<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><p>3）测试<br>访问<code>192.168.1.31</code>和<code>192.168.1.32</code>的状态页<br><img src="/2019/05/21/saltstack项目实战/05.png" alt="http://192.168.1.31:1314/status"><br><img src="/2019/05/21/saltstack项目实战/06.png" alt="http://192.168.1.32:1314/status"><br>访问VIP<code>192.168.1.100</code><br><img src="/2019/05/21/saltstack项目实战/07.png" alt="http://192.168.1.100"></p><p>通过上面测试可看到可以成功访问<code>lnmp</code>站点，并且<code>haproxy</code>也<code>ok</code>。访问所有四台服务器都可以得到<code>phpinfo</code>页面，而在生产环境中，我们只是对外提供<code>vip</code>即可。</p><h2 id="项目总结"><a href="#项目总结" class="headerlink" title="项目总结"></a>项目总结</h2><p>1）整体环境查看<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# tree /srv/salt/prod/modules/</span><br><span class="line">/srv/salt/prod/modules/</span><br><span class="line">├── haproxy</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   └── haproxy.cfg</span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── keepalived</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   └── keepalived.<span class="keyword">conf</span></span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── lnmp</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   ├── <span class="built_in">index</span>.php</span><br><span class="line">│   │   └── www.<span class="keyword">conf</span></span><br><span class="line">│   └── www.sls</span><br><span class="line">├── mysql</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   └── my.<span class="keyword">cnf</span></span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── nginx</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   ├── nginx-<span class="number">1.12</span>.<span class="number">2</span>.tar.gz</span><br><span class="line">│   │   ├── nginx-<span class="number">1.16</span>.<span class="number">0</span>.tar.gz</span><br><span class="line">│   │   ├── nginx.<span class="keyword">conf</span>.template</span><br><span class="line">│   │   └── nginx.service.template</span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── php</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   ├── php-<span class="number">5.6</span>.<span class="number">40</span>.tar.gz</span><br><span class="line">│   │   ├── php-fpm.<span class="keyword">conf</span>.template</span><br><span class="line">│   │   ├── php-fpm.service.template</span><br><span class="line">│   │   ├── php-fpm.template</span><br><span class="line">│   │   └── php.ini.template</span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── pkg.sls</span><br><span class="line">└── user</span><br><span class="line">    └── www.sls</span><br><span class="line"></span><br><span class="line"><span class="number">13</span> directories, <span class="number">27</span> <span class="keyword">files</span></span><br></pre></td></tr></table></figure></p><p>2）如果需要在某台服务器上面单独部署某一部分，参考以下写法：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># cat /srv/salt/base/top.sls </span></span><br><span class="line"><span class="meta">#部署lnmp及haproxy+keepalived</span></span><br><span class="line"><span class="symbol">prod:</span></span><br><span class="line">  <span class="string">"salt-minion0[3-4]"</span>:</span><br><span class="line">    - modules.lnmp.www</span><br><span class="line"></span><br><span class="line">  <span class="string">"salt-minion0[1-2]"</span>:</span><br><span class="line">    - modules.haproxy.service</span><br><span class="line">    - modules.keepalived.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#单实例操作说明：</span></span><br><span class="line"><span class="symbol">prod:</span></span><br><span class="line">  <span class="string">"salt-minion04"</span>:</span><br><span class="line">    - modules.nginx.service<span class="meta">#单独安装nginx时</span></span><br><span class="line">    - modules.mysql.service     <span class="meta">#单独安装mysql时</span></span><br><span class="line">    - modules.php.service       <span class="meta">#单独安装php时</span></span><br><span class="line">    - modules.keepalived.service  <span class="meta">#单独安装keepalived时</span></span><br><span class="line">    - modules.haproxy.service   <span class="meta">#单独安装haproxy时</span></span><br><span class="line"></span><br><span class="line">  <span class="string">"salt-minion03"</span>:</span><br><span class="line">    - modules.lnmp.www     <span class="meta">#单独部署lnmp环境时</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;项目架构规划&quot;&gt;&lt;a href=&quot;#项目架构规划&quot; class=&quot;headerlink&quot; title=&quot;项目架构规划&quot;&gt;&lt;/a&gt;项目架构规划&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;后端web服务器使用&lt;code&gt;Nginx+Php&lt;/code&gt;作为站点，通过&lt;c
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack接口salt-api</title>
    <link href="https://leeyj.coding.me/2019/05/20/saltstack%E6%8E%A5%E5%8F%A3salt-api/"/>
    <id>https://leeyj.coding.me/2019/05/20/saltstack接口salt-api/</id>
    <published>2019-05-20T14:04:05.000Z</published>
    <updated>2019-07-10T01:46:30.069Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><a href="https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html" target="_blank" rel="noopener">参考官档</a><br><a href="https://www.unixhot.com/docs/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html#a-rest-api-for-salt" target="_blank" rel="noopener">参考官档</a></p><blockquote><p><code>SaltStack</code>官方提供有<code>REST API</code>格式的<code>salt-api</code>项目，将使<code>salt</code>与第三方系统集成变得更加简单。</p></blockquote><h2 id="salt-api安装配置"><a href="#salt-api安装配置" class="headerlink" title="salt-api安装配置"></a>salt-api安装配置</h2><p>1）在<code>salt-master</code>上进行安装<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install salt-api</span><br></pre></td></tr></table></figure></p><p>2）自签名证书，生产环境可以购买（说明：如果没有<code>salt-call</code>命令，装上<code>salt-minion</code>即可，依赖于该包）<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt-call --local tls.create_self_signed_cert</span></span><br><span class="line"><span class="keyword">local</span>:</span><br><span class="line">    Created Private Key: <span class="string">"/etc/pki/tls/certs/localhost.key."</span> Created Certificate: <span class="string">"/etc/pki/tls/certs/localhost.crt."</span></span><br></pre></td></tr></table></figure></p><p>3）打开<code>include</code>加载子配置文件，方便管理<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">default_include: <span class="literal">master</span>.d/*.conf</span><br></pre></td></tr></table></figure></p><p>4）配置<code>api</code>配置文件，将上面生成的证书写到配置文件<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># vim /etc/salt/master.d/api.conf</span></span><br><span class="line"><span class="symbol">rest_cherrypy:</span></span><br><span class="line"><span class="symbol">  host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.30</span></span><br><span class="line"><span class="symbol">  port:</span> <span class="number">8000</span></span><br><span class="line"><span class="symbol">  ssl_crt:</span> <span class="meta-keyword">/etc/</span>pki<span class="meta-keyword">/tls/</span>certs/localhost.crt</span><br><span class="line"><span class="symbol">  ssl_key:</span> <span class="meta-keyword">/etc/</span>pki<span class="meta-keyword">/tls/</span>certs/localhost.key</span><br></pre></td></tr></table></figure></p><p>5）创建认证用户，并设置密码<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# useradd</span> -M -s /sbin/nologin saltapi</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# echo</span> 'saltapi' | passwd --stdin saltapi</span><br></pre></td></tr></table></figure></p><p>6）创建认证配置文件<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# vim /etc/salt/master.d/auth.conf</span><br><span class="line">external_auth:</span><br><span class="line">  pam:</span><br><span class="line">    saltapi:</span><br><span class="line">      -<span class="ruby"> .*</span></span><br><span class="line"><span class="ruby">      - <span class="string">'@wheel'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'@runner'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'@jobs'</span></span></span><br></pre></td></tr></table></figure></p><p>7）重启<code>salt-master</code>和启动<code>salt-api</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> <span class="literal">start</span> salt-api</span><br></pre></td></tr></table></figure></p><p>8）查看<code>salt-api</code>监听端口<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# netstat -anlutp |grep <span class="number">8000</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>:<span class="number">8000</span>       <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*               LISTEN      <span class="number">10904</span>/python        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>:<span class="number">53414</span>      <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>:<span class="number">8000</span>       TIME_WAIT   -</span><br></pre></td></tr></table></figure></p><p>9）验证<code>login</code>登录，获取<code>token</code>字符串<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="comment"># curl -sSk https://192.168.1.30:8000/login \</span></span><br><span class="line">&gt;     -H <span class="string">'Accept: application/x-yaml'</span> <span class="string">\</span></span><br><span class="line">&gt;     -d username=saltapi <span class="string">\</span></span><br><span class="line">&gt;     -d password=saltapi <span class="string">\</span></span><br><span class="line">&gt;     -d eauth=pam</span><br><span class="line">return:</span><br><span class="line">- eauth: pam</span><br><span class="line">  expire: <span class="number">1558663247.869537</span></span><br><span class="line">  perms:</span><br><span class="line">  - .*</span><br><span class="line">  - <span class="string">'@wheel'</span></span><br><span class="line">  - <span class="string">'@runner'</span></span><br><span class="line">  - <span class="string">'@jobs'</span></span><br><span class="line">  start: <span class="number">1558620047.869536</span></span><br><span class="line">  token: e8330f642a3addd853c723d63844d29a12de9484</span><br><span class="line">  user: saltapi</span><br></pre></td></tr></table></figure></p><p>10）通过<code>api</code>执行<code>test.ping</code>测试连通性<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>salt-master ~]# curl -sSk https:<span class="comment">//192.168.1.30:8000 \</span></span><br><span class="line">&gt;     -H <span class="string">'Accept: application/x-yaml'</span> \</span><br><span class="line">&gt;     -H <span class="string">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\</span><br><span class="line">&gt;     -d client=local \</span><br><span class="line">&gt;     -d tgt=<span class="string">'*'</span> \</span><br><span class="line">&gt;     -d <span class="function"><span class="keyword">fun</span>=test.ping</span></span><br><span class="line"><span class="keyword">return</span>:</span><br><span class="line">- salt-minion01: <span class="literal">true</span></span><br><span class="line">  salt-minion02: <span class="literal">true</span></span><br><span class="line">  salt-minion03: <span class="literal">true</span></span><br><span class="line">  salt-minion04: <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><p>11）通过<code>api</code>执行<code>cmd.run</code><br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>salt-master ~]# curl -sSk https:<span class="comment">//192.168.1.30:8000 \</span></span><br><span class="line">&gt;     -H <span class="string">'Accept: application/x-yaml'</span> \</span><br><span class="line">&gt;     -H <span class="string">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\</span><br><span class="line">&gt;     -d client=local \</span><br><span class="line">&gt;     -d tgt=<span class="string">'*'</span> \</span><br><span class="line">&gt;     -d <span class="function"><span class="keyword">fun</span>='cmd.run' -d arg='uptime'</span></span><br><span class="line"><span class="keyword">return</span>:</span><br><span class="line">- salt-minion01: <span class="string">' 22:10:25 up 46 min,  1 user,  load average: 0.00, 0.01, 0.05'</span></span><br><span class="line">  salt-minion02: <span class="string">' 22:10:25 up 7 min,  0 users,  load average: 0.00, 0.18, 0.15'</span></span><br><span class="line">  salt-minion03: <span class="string">' 22:10:25 up 7 min,  0 users,  load average: 0.06, 0.33, 0.26'</span></span><br><span class="line">  salt-minion04: <span class="string">' 22:10:25 up 7 min,  0 users,  load average: 0.01, 0.21, 0.16'</span></span><br></pre></td></tr></table></figure></p><p>12）通过<code>api</code>获取<code>grains</code>信息`<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master <span class="symbol">~]# curl -sSk https</span>:<span class="comment">//192.168.1.30:8000/minions/salt-minion01 \</span></span><br><span class="line">&gt;     -H 'Accept: application/x-yaml' \</span><br><span class="line">&gt;     -H 'X-Auth-Token: e<span class="number">8330</span>f642a3addd853c723d<span class="number">6384</span>4d29a12de<span class="number">9484</span>'</span><br><span class="line">return:</span><br><span class="line">- salt-minion01:</span><br><span class="line">    SSDs: []</span><br><span class="line">    biosreleasedate: <span class="number">05</span>/<span class="number">19</span>/<span class="number">2017</span></span><br><span class="line">    biosversion: '6.00'</span><br><span class="line">    cpu_flags:</span><br><span class="line">    - fpu</span><br><span class="line">    - vme</span><br><span class="line">    - de</span><br><span class="line">    - pse</span><br><span class="line">    - tsc</span><br><span class="line">.....</span><br></pre></td></tr></table></figure></p><p>13）使用<code>json</code>格式<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# curl -sSk https://<span class="number">192.168</span><span class="number">.1</span><span class="number">.30</span>:<span class="number">8000</span>/minions/salt-minion01 \</span><br><span class="line">&gt;     -<span class="symbol">H</span> <span class="string">'Accept: application/json'</span> \</span><br><span class="line">&gt;     -<span class="symbol">H</span> <span class="string">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span></span><br><span class="line">&#123;<span class="string">"return"</span>: [&#123;<span class="string">"salt-minion01"</span>: &#123;<span class="string">"biosversion"</span>: <span class="string">"6.00"</span>, <span class="string">"kernel"</span>: <span class="string">"Linux"</span>, <span class="string">"domain"</span>: <span class="string">""</span>, <span class="string">"uid"</span>: <span class="number">0</span>, <span class="string">"zmqversion"</span>: <span class="string">"4.1.4"</span>, <span class="string">"kernelrelease"</span>: <span class="string">"3.10.0-693.el7.x86_64"</span>, <span class="string">"selinux"</span>: &#123;<span class="string">"enforced"</span>: <span class="string">"Disabled"</span>, <span class="string">"enabled"</span>: false&#125;, <span class="string">"serialnumber"</span>: <span class="string">"VMware-56 4d 9e a0 21 56 90 87-cd 89 69 32 13 94 17 44"</span>, <span class="string">"pid"</span>: <span class="number">1449</span>, <span class="string">"fqdns"</span>: [], <span class="string">"ip_interfaces"</span>: &#123;<span class="string">"lo"</span>: [<span class="string">"127.0.0.1"</span>, <span class="string">"::1"</span>], <span class="string">"virbr0"</span>: [<span class="string">"192.168.122.1"</span>], <span class="string">"virbr0-nic"</span>: [], <span class="string">"ens33"</span>: [<span class="string">"192.168.1.31"</span>, <span class="string">"192.168.1.100"</span>, <span class="string">"fe80::20c:29ff:fe94:1744"</span>]&#125;, <span class="string">"groupname"</span>: <span class="string">"root"</span>, <span class="string">"fqdn_ip6"</span>: [<span class="string">"fe80::20c:29ff:fe94:1744"</span>],</span><br><span class="line">.......</span><br></pre></td></tr></table></figure></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p><code>salt-api</code>必须使用<code>https</code>，生产环境建议使用可信证书<br>当<code>salt-api</code>服务重启后原<code>token</code>失效</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://docs.saltstack.com/en/latest/ref/netapi/all/salt.neta
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack使用salt-ssh</title>
    <link href="https://leeyj.coding.me/2019/05/20/saltstack%E4%BD%BF%E7%94%A8salt-ssh/"/>
    <id>https://leeyj.coding.me/2019/05/20/saltstack使用salt-ssh/</id>
    <published>2019-05-20T01:43:05.000Z</published>
    <updated>2019-07-10T01:46:30.058Z</updated>
    
    <content type="html"><![CDATA[<h2 id="salt-ssh-介绍"><a href="#salt-ssh-介绍" class="headerlink" title="salt-ssh 介绍"></a>salt-ssh 介绍</h2><p><a href="https://docs.saltstack.com/en/latest/topics/ssh/index.html" target="_blank" rel="noopener">参考官档</a></p><blockquote><p><code>salt-ssh</code>是 <code>0.17.0</code> 新引入的一个功能，不需要minion对客户端进行管理，也可以不需要<code>master</code>；<code>salt-ssh</code>也支持<code>salt</code>大部分的功能：比如<code>grains</code>,<code>modules</code>,<code>state</code>等；<code>salt-ssh</code>没有使用<code>ZeroMQ</code>的通信架构，执行是串行模式</p></blockquote><h2 id="salt-ssh执行原理"><a href="#salt-ssh执行原理" class="headerlink" title="salt-ssh执行原理"></a>salt-ssh执行原理</h2><blockquote><ul><li><code>salt-ssh</code>是在<code>salt</code>基础上打了一个<code>python</code>包上传到客户端的默认<code>tmp</code>目录下, 在客户端上面解压并执行返回结果,最后删除<code>tmp</code>上传的临时文件。</li><li><code>salt-minion</code>方法是<code>salt-mater</code>先执行语法验证，验证通过后发送到<code>minion</code>，<code>minion</code>收到<code>Msater</code>的状态文件默认保存在<code>/var/cache/salt/minion</code></li><li><code>salt-ssh</code>和<code>salt-minion</code>可以共存，<code>salt-minion</code>不依赖于<code>ssh</code>服务</li></ul></blockquote><h2 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h2><p>1）安装<code>salt-ssh</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install salt-ssh</span><br></pre></td></tr></table></figure></p><p>2）修改<code>roster</code>文件，配置需要管理的机器<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">/etc/salt/roster</span></span><br><span class="line"><span class="attr">salt-minion01:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  passwd:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">22</span></span><br><span class="line"></span><br><span class="line"><span class="attr">salt-minion02:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  passwd:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">22</span></span><br></pre></td></tr></table></figure></p><p>3）管理测试 (说明，如果第一次需要输入<code>yes或no</code>进行<code>ssh</code>认证，可以加<code>-i</code>参数自动认证)<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">salt-ssh</span> <span class="string">'*'</span> <span class="string">test.ping</span> <span class="bullet">-i</span></span><br><span class="line"><span class="attr">salt-minion01:</span></span><br><span class="line">    <span class="literal">True</span></span><br><span class="line"><span class="attr">salt-minion02:</span></span><br><span class="line">    <span class="literal">True</span></span><br></pre></td></tr></table></figure></p><p>4）<code>salt-ssh</code>命令参数<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-r, –raw, –raw-shell <span class="comment"># 直接使用shell命令</span></span><br><span class="line">–priv <span class="comment">#指定SSH私有密钥文件</span></span><br><span class="line">–roster <span class="comment">#定义使用哪个roster系统，如果定义了一个后端数据库，扫描方式，或者用户自定义的的roster系统，默认的就是/etc/salt/roster文件</span></span><br><span class="line">–roster-file <span class="comment">#指定roster文件</span></span><br><span class="line">–refresh, –refresh-<span class="keyword">cache</span> <span class="comment">#刷新cache，如果target的grains改变会自动刷新</span></span><br><span class="line">–<span class="keyword">max</span>-procs <span class="comment">#指定进程数，默认为25</span></span><br><span class="line">-i, –<span class="keyword">ignore</span>-host-<span class="keyword">keys</span> <span class="comment">#当ssh连接时，忽略keys</span></span><br><span class="line">–passwd <span class="comment">#指定默认密码</span></span><br><span class="line">–<span class="keyword">key</span>-deploy <span class="comment">#配置keys 设置这个参数对于所有minions用来部署ssh-key认证，</span></span><br><span class="line"> 这个参和–passwd结合起来使用会使初始化部署很快很方便。当调用<span class="keyword">master</span>模块时，并加上参数 –<span class="keyword">key</span>-deploy 即可在minions生成<span class="keyword">keys</span>，下次开始就不使用密码</span><br></pre></td></tr></table></figure></p><p>5）<code>salt-ssh</code>执行命令<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">salt-ssh</span> <span class="string">'*'</span> <span class="bullet">-r</span> <span class="string">"uptime"</span></span><br><span class="line"><span class="attr">salt-minion01:</span></span><br><span class="line"><span class="bullet">    -</span><span class="bullet">---------</span></span><br><span class="line"><span class="attr">    retcode:</span></span><br><span class="line">        <span class="number">0</span></span><br><span class="line"><span class="attr">    stderr:</span></span><br><span class="line"><span class="attr">    stdout:</span></span><br><span class="line">        <span class="string">root@192.168.1.31's</span> <span class="attr">password:</span> </span><br><span class="line">         <span class="number">10</span><span class="string">:06:08</span> <span class="string">up</span> <span class="number">1</span> <span class="string">day,</span> <span class="number">17</span><span class="string">:05,</span>  <span class="number">2</span> <span class="string">users,</span>  <span class="string">load</span> <span class="attr">average:</span> <span class="number">0.00</span><span class="string">,</span> <span class="number">0.01</span><span class="string">,</span> <span class="number">0.05</span></span><br><span class="line"><span class="attr">salt-minion02:</span></span><br><span class="line"><span class="bullet">    -</span><span class="bullet">---------</span></span><br><span class="line"><span class="attr">    retcode:</span></span><br><span class="line">        <span class="number">0</span></span><br><span class="line"><span class="attr">    stderr:</span></span><br><span class="line"><span class="attr">    stdout:</span></span><br><span class="line">        <span class="string">root@192.168.1.32's</span> <span class="attr">password:</span> </span><br><span class="line">         <span class="number">10</span><span class="string">:06:08</span> <span class="string">up</span> <span class="number">1</span> <span class="string">day,</span> <span class="number">17</span><span class="string">:16,</span>  <span class="number">2</span> <span class="string">users,</span>  <span class="string">load</span> <span class="attr">average:</span> <span class="number">0.03</span><span class="string">,</span> <span class="number">0.06</span><span class="string">,</span> <span class="number">0.06</span></span><br></pre></td></tr></table></figure></p><p>6）<code>salt-ssh</code>执行状态模块<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# salt-ssh <span class="emphasis">'*'</span> state.sls modules.haproxy.service saltenv=prod</span><br><span class="line">salt-minion02:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-install</span></span><br><span class="line"><span class="code">    Function: pkg.installed</span></span><br><span class="line"><span class="code">        Name: haproxy</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: All specified packages are already installed</span></span><br><span class="line"><span class="code">     Started: 10:09:48.541019</span></span><br><span class="line"><span class="code">    Duration: 10161.705 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-config</span></span><br><span class="line"><span class="code">    Function: file.managed</span></span><br><span class="line"><span class="code">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class="line"><span class="code">     Started: 10:09:59.020659</span></span><br><span class="line"><span class="code">    Duration: 54.263 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-service</span></span><br><span class="line"><span class="code">    Function: service.running</span></span><br><span class="line"><span class="code">        Name: haproxy</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: The service haproxy is already running</span></span><br><span class="line"><span class="code">     Started: 10:09:59.079110</span></span><br><span class="line"><span class="code">    Duration: 128.052 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion02</span><br><span class="line">------------</span><br><span class="line">Succeeded: 3</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     3</span><br><span class="line">Total run time:  10.344 s</span><br><span class="line">salt-minion01:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-install</span></span><br><span class="line"><span class="code">    Function: pkg.installed</span></span><br><span class="line"><span class="code">        Name: haproxy</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: All specified packages are already installed</span></span><br><span class="line"><span class="code">     Started: 10:10:00.561015</span></span><br><span class="line"><span class="code">    Duration: 2862.018 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-config</span></span><br><span class="line"><span class="code">    Function: file.managed</span></span><br><span class="line"><span class="code">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class="line"><span class="code">     Started: 10:10:03.905713</span></span><br><span class="line"><span class="code">    Duration: 220.443 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-service</span></span><br><span class="line"><span class="code">    Function: service.running</span></span><br><span class="line"><span class="code">        Name: haproxy</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: The service haproxy is already running</span></span><br><span class="line"><span class="code">     Started: 10:10:04.135607</span></span><br><span class="line"><span class="code">    Duration: 230.231 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 3</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     3</span><br><span class="line">Total run time:   3.313 s</span><br></pre></td></tr></table></figure></p><h2 id="Roster说明"><a href="#Roster说明" class="headerlink" title="Roster说明"></a>Roster说明</h2><blockquote><p><code>salt-ssh</code>需要一个名单系统来确定哪些执行目标，<code>Salt</code>的<code>0.17.0</code>版本中<code>salt-ssh</code>引入<code>roste</code>r系统<br><code>roster</code>系统编译成了一个数据结构，包含了<code>targets</code>，这些<code>targets</code>是一个目标系统主机列表和或如连接到这些<code>targets</code>。</p></blockquote><p>配置文件说明：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># target的信息</span></span><br><span class="line"><span class="symbol">    host:</span>        <span class="meta"># 远端主机的ip地址或者dns域名</span></span><br><span class="line"><span class="symbol">    user:</span>        <span class="meta"># 登录的用户</span></span><br><span class="line"><span class="symbol">    passwd:</span>      <span class="meta"># 用户密码,如果不使用此选项，则默认使用秘钥方式</span></span><br><span class="line"><span class="meta"># 可选的部分</span></span><br><span class="line"><span class="symbol">    port:</span>        <span class="meta">#ssh端口</span></span><br><span class="line"><span class="symbol">    sudo:</span>        <span class="meta">#可以通过sudo</span></span><br><span class="line"><span class="symbol">    tty:</span>         <span class="meta"># 如果设置了sudo，设置这个参数为true</span></span><br><span class="line"><span class="symbol">    priv:</span>        <span class="meta"># ssh秘钥的文件路径</span></span><br><span class="line"><span class="symbol">    timeout:</span>     <span class="meta"># 当建立链接时等待响应时间的秒数</span></span><br><span class="line"><span class="symbol">    minion_opts:</span> <span class="meta"># minion的位置路径</span></span><br><span class="line"><span class="symbol">    thin_dir:</span>    <span class="meta"># target系统的存储目录，默认是/tmp/salt-&lt;hash&gt;</span></span><br><span class="line"><span class="symbol">    cmd_umask:</span>   <span class="meta"># 使用salt-call命令的umask值</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;salt-ssh-介绍&quot;&gt;&lt;a href=&quot;#salt-ssh-介绍&quot; class=&quot;headerlink&quot; title=&quot;salt-ssh 介绍&quot;&gt;&lt;/a&gt;salt-ssh 介绍&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://docs.saltstack.co
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack数据系统</title>
    <link href="https://leeyj.coding.me/2019/05/17/saltstack%E6%95%B0%E6%8D%AE%E7%B3%BB%E7%BB%9F/"/>
    <id>https://leeyj.coding.me/2019/05/17/saltstack数据系统/</id>
    <published>2019-05-17T09:31:05.000Z</published>
    <updated>2019-07-10T01:46:30.071Z</updated>
    
    <content type="html"><![CDATA[<h2 id="数据系统Grains"><a href="#数据系统Grains" class="headerlink" title="数据系统Grains"></a>数据系统Grains</h2><blockquote><p>1、<code>Grains</code>是<code>SaltStack</code>收集的有关底层管理系统的静态信息。包括操作系统版本、域名、IP地址、内存、内核、CPU、操作系统类型以及许多其他系统属性。<code>Minion</code> 收集的信息，可以作为<code>Master</code>端匹配目标。<br>2、如果需要自定义<code>grains</code>，需要添加到<code>Salt Minion</code>的<code>/etc/salt/grains</code>文件中（配置文件中定义的默认路径），也可以直接写在配置文件<code>/etc/salt/minion</code>中</p></blockquote><p><a href="https://docs.saltstack.com/en/latest/topics/grains/" target="_blank" rel="noopener">Grains官方文档</a><br>1）资产管理，信息查询<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#列出所有可用的grains状态模块</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> grains.ls</span></span><br><span class="line"><span class="meta">#打印所有状态信息</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> grains.items</span></span><br><span class="line"><span class="meta">#列出每台minion的本地IP地址</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> grains.item fqdn_ip4</span></span><br><span class="line"><span class="meta">#列出每台minion的操作系统</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> grains.item os</span></span><br></pre></td></tr></table></figure></p><p>2）用于匹配<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -G <span class="string">'os:CentOS'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -G <span class="string">'localhost:salt-minion01'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><p>3）<code>minion</code>自定义<code>grains</code><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#1.修改配置文件，自定义grains</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># vim /etc/salt/minion</span></span><br><span class="line">grains:</span><br><span class="line">  roles:</span><br><span class="line">    - webserver</span><br><span class="line">    - memcache</span><br><span class="line">  ipaddr:</span><br><span class="line">    - <span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#2.重启minion</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># systemctl restart salt-minion</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#3.master上测试</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -G <span class="string">'ipaddr:192.168.1.32'</span> test.ping </span></span><br><span class="line">salt-minion01:</span><br><span class="line">    <span class="literal">True</span></span><br></pre></td></tr></table></figure></p><p>4）<code>Grains</code>优先级问题<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、Grains默认核心信息</span><br><span class="line"><span class="number">2</span>、自定义写在/etc/salt/grains文件中的</span><br><span class="line"><span class="number">3</span>、自定义写在/etc/salt/minion文件中的</span><br></pre></td></tr></table></figure></p><h2 id="数据系统Pillar"><a href="#数据系统Pillar" class="headerlink" title="数据系统Pillar"></a>数据系统Pillar</h2><blockquote><p><code>Pillar</code>是动态的，<code>Pillar</code>存储在<code>master</code>上，提供给<code>minion</code>。<br><code>Pillar</code>主要记录一些加密信息，可以确保这些敏感数据不被其他<code>minion</code>看到。比如：软件版本号、用户名密码等。存储格式都是<code>YAML</code>格式</p></blockquote><p>1）在<code>Master</code>端定义<code>Pillar</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">pillar_roots:</span><br><span class="line">  base:</span><br><span class="line">    - /srv/pillar</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> /srv/pillar</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/pillar/zabbix.sls </span><br><span class="line">Zabbix_Server: <span class="number">192.168</span>.<span class="number">1.11</span></span><br><span class="line">Zabbix_Name: zabbix.examp.com</span><br></pre></td></tr></table></figure></p><p>2）编写<code>TopFile</code>指定<code>Minion</code>端可以使用<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@salt-master ~</span>]<span class="meta"># cat /srv/pillar/top.sls </span></span><br><span class="line"><span class="keyword">base</span>:</span><br><span class="line">  <span class="string">'salt-minion01'</span>:</span><br><span class="line">    - zabbix</span><br></pre></td></tr></table></figure></p><p>3）刷新<code>Pillar</code><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> saltutil.refresh_pillar</span></span><br></pre></td></tr></table></figure></p><p>4）获取对应<code>pillar</code>值<br><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> pillar.items</span><br><span class="line">salt-<span class="name">minion01</span>:</span><br><span class="line">    <span class="comment">----------</span></span><br><span class="line">    <span class="name">Zabbix_Name</span>:</span><br><span class="line">        zabbix.examp.com</span><br><span class="line">    <span class="name">Zabbix_Server</span>:</span><br><span class="line">        <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span></span><br><span class="line">salt-<span class="name">minion03</span>:</span><br><span class="line">    <span class="comment">----------</span></span><br><span class="line">salt-<span class="name">minion02</span>:</span><br><span class="line">    <span class="comment">----------</span></span><br><span class="line"></span><br><span class="line">#获取指定的key</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'salt-minion01'</span> pillar.item Zabbix_Server</span><br><span class="line">salt-<span class="name">minion01</span>:</span><br><span class="line">    <span class="comment">----------</span></span><br><span class="line">    <span class="name">Zabbix_Server</span>:</span><br><span class="line">        <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span></span><br></pre></td></tr></table></figure></p><blockquote><p>说明：如果<code>Master</code>更新了新的数值，需要刷新<code>Pillar</code>到<code>Minion</code>才可以获取</p></blockquote><blockquote><p><code>Pirrar</code>与<code>Grains</code>对比<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">类型     数据采集方式   应用场景                   定义位置</span><br><span class="line">Grains   静态         minion启动时收集  数据查询  目标选择  配置管理   minion</span><br><span class="line">Pillar   动态         <span class="literal">master</span>进行自定义  目标选择  配置管理  敏感数据   <span class="literal">master</span></span><br></pre></td></tr></table></figure></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;数据系统Grains&quot;&gt;&lt;a href=&quot;#数据系统Grains&quot; class=&quot;headerlink&quot; title=&quot;数据系统Grains&quot;&gt;&lt;/a&gt;数据系统Grains&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;1、&lt;code&gt;Grains&lt;/code&gt;是&lt;co
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack状态判断unless与onlyif</title>
    <link href="https://leeyj.coding.me/2019/05/17/saltstack%E7%8A%B6%E6%80%81%E5%88%A4%E6%96%ADunless%E4%B8%8Eonlyif/"/>
    <id>https://leeyj.coding.me/2019/05/17/saltstack状态判断unless与onlyif/</id>
    <published>2019-05-17T07:43:05.000Z</published>
    <updated>2019-07-10T01:46:30.072Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>很多时候我们在编写<code>state</code> 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的<code>unless</code>和<code>onlyif</code>。</p></blockquote><h2 id="unless"><a href="#unless" class="headerlink" title="unless"></a>unless</h2><p><code>unless</code>示例：需求创建<code>/tmp/unless.txt</code>文件，存在则不创建，不存在则创建<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /srv/salt/prod/unless.sls </span><br><span class="line">test-unless:</span><br><span class="line"><span class="code">  cmd.run:</span></span><br><span class="line"><span class="code">    - name: touch /tmp/unless.txt</span></span><br><span class="line"><span class="code">    - unless: test -f /tmp/unless.txt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# salt <span class="emphasis">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class="line">salt-minion01:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: test-unless</span></span><br><span class="line"><span class="code">    Function: cmd.run</span></span><br><span class="line"><span class="code">        Name: touch /tmp/unless.txt</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: Command "touch /tmp/unless.txt" run</span></span><br><span class="line"><span class="code">     Started: 15:10:51.522319</span></span><br><span class="line"><span class="code">    Duration: 31.822 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"><span class="code">              ----------</span></span><br><span class="line"><span class="code">              pid:</span></span><br><span class="line"><span class="code">                  6538</span></span><br><span class="line"><span class="code">              retcode:</span></span><br><span class="line"><span class="code">                  0</span></span><br><span class="line"><span class="code">              stderr:</span></span><br><span class="line"><span class="code">              stdout:</span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 1 (changed=1)</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     1</span><br><span class="line">Total run time:  31.822 ms</span><br><span class="line">#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# salt <span class="emphasis">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class="line">salt-minion01:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: test-unless</span></span><br><span class="line"><span class="code">    Function: cmd.run</span></span><br><span class="line"><span class="code">        Name: touch /tmp/unless.txt</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: unless condition is true</span></span><br><span class="line"><span class="code">     Started: 15:11:40.819789</span></span><br><span class="line"><span class="code">    Duration: 10.477 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 1</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     1</span><br><span class="line">Total run time:  10.477 ms</span><br><span class="line">#第二次执行，可以看到该文件已经存在，并没有再次创建</span><br></pre></td></tr></table></figure></p><blockquote><p>通过上面的小案例可以看出，当<code>unless</code>返回为真则不执行，当<code>unless</code>返回为假才执行。</p></blockquote><h2 id="onlyif"><a href="#onlyif" class="headerlink" title="onlyif"></a>onlyif</h2><blockquote><p><code>onlyif</code>正好和<code>unless</code>相反，当<code>onlyif</code>返回为真执行，当<code>onlyif</code>返回为假不执行</p></blockquote><p><code>onlyif</code>示例：需求，当<code>/tmp/onlyif.txt</code>文件存在，则创建<code>/tmp/onlyif</code>目录，不存在，则不创建<code>/tmp/onlyif</code>目录<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls </span><br><span class="line">test-onlyif:</span><br><span class="line"><span class="code">  cmd.run:</span></span><br><span class="line"><span class="code">    - name: mkdir /tmp/onlyif</span></span><br><span class="line"><span class="code">    - onlyif: test -f /tmp/onlyif.txt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# salt <span class="emphasis">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class="line">salt-minion01:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: test-onlyif</span></span><br><span class="line"><span class="code">    Function: cmd.run</span></span><br><span class="line"><span class="code">        Name: mkdir /tmp/onlyif</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: onlyif condition is false</span></span><br><span class="line"><span class="code">     Started: 15:34:56.460583</span></span><br><span class="line"><span class="code">    Duration: 9.612 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 1</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     1</span><br><span class="line">Total run time:   9.612 ms</span><br><span class="line"></span><br><span class="line">#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行</span><br><span class="line">[root@salt-master ~]# salt <span class="emphasis">'salt-minion01'</span> cmd.run "touch /tmp/onlyif.txt"</span><br><span class="line">salt-minion01:</span><br><span class="line">[root@salt-master ~]# salt <span class="emphasis">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class="line">salt-minion01:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: test-onlyif</span></span><br><span class="line"><span class="code">    Function: cmd.run</span></span><br><span class="line"><span class="code">        Name: mkdir /tmp/onlyif</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: Command "mkdir /tmp/onlyif" run</span></span><br><span class="line"><span class="code">     Started: 15:38:07.712492</span></span><br><span class="line"><span class="code">    Duration: 14.646 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"><span class="code">              ----------</span></span><br><span class="line"><span class="code">              pid:</span></span><br><span class="line"><span class="code">                  6871</span></span><br><span class="line"><span class="code">              retcode:</span></span><br><span class="line"><span class="code">                  0</span></span><br><span class="line"><span class="code">              stderr:</span></span><br><span class="line"><span class="code">              stdout:</span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 1 (changed=1)</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     1</span><br><span class="line">Total run time:  14.646 ms</span><br><span class="line"></span><br><span class="line">#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录</span><br></pre></td></tr></table></figure></p><h2 id="Redis主从架构案例"><a href="#Redis主从架构案例" class="headerlink" title="Redis主从架构案例"></a>Redis主从架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br><img src="/2019/05/17/saltstack状态判断unless与onlyif/01.png" alt="redis主从环境"></p><p>1）环境准备，定义<code>file_roots</code>环境<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># vim /etc/salt/master</span></span><br><span class="line"><span class="symbol">file_roots:</span></span><br><span class="line"><span class="symbol">  base:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/base</span><br><span class="line"><span class="symbol">  dev:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/dev</span><br><span class="line"><span class="symbol">  prod:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p><p>2）创建对应环境目录<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/prod/redis/files/</span><br></pre></td></tr></table></figure></p><p>3）编写<code>state sls</code>状态文件<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#初始化redis（安装和基本配置）</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/redis/init.sls</span> </span><br><span class="line"><span class="attr">redis-install:</span></span><br><span class="line">  <span class="string">pkg.installed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line"><span class="attr">redis-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/redis.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://redis/files/redis.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="attr">      BIND:</span> <span class="string">&#123;&#123;</span> <span class="string">grains['fqdn_ip4'][0]</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">      PORT:</span> <span class="number">6379</span></span><br><span class="line"><span class="attr">      DAEMONIZA:</span> <span class="string">'yes'</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">redis-install</span></span><br><span class="line"></span><br><span class="line"><span class="attr">redis-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">redis-config</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#master直接引入 init</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/redis/master.sls</span> </span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">redis.init</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#slave引入init 并配置主从信息</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/redis/slave.sls</span> </span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">redis.init</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置主从</span></span><br><span class="line"><span class="attr">slave-config:</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">redis-cli</span> <span class="bullet">-h</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.34</span> <span class="string">slaveof</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span> <span class="number">6379</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">redis-cli</span> <span class="bullet">-h</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.34</span> <span class="string">info</span> <span class="string">|grep</span> <span class="attr">role:slave</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">redis-service</span></span><br><span class="line"></span><br><span class="line"><span class="string">说明：</span></span><br><span class="line"><span class="string">unless：返回为真则不执行，反之为假则执行</span></span><br></pre></td></tr></table></figure></p><p>4）配置文件准备<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# <span class="keyword">grep</span> <span class="string">"^[a-Z]"</span> /etc/redis.<span class="keyword">conf</span>  &gt;&gt;/srv/salt/prod/redis/<span class="keyword">files</span>/redis.<span class="keyword">conf</span></span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/prod/redis/<span class="keyword">files</span>/redis.<span class="keyword">conf</span> </span><br><span class="line">#这里使用jinja</span><br><span class="line">bind &#123;&#123; BIND &#125;&#125;</span><br><span class="line">protected-<span class="keyword">mode</span> yes</span><br><span class="line">#这里使用jinja</span><br><span class="line">port &#123;&#123; PORT &#125;&#125;</span><br><span class="line">tcp-backlog <span class="number">511</span></span><br><span class="line">timeout <span class="number">0</span></span><br><span class="line">tcp-keepalive <span class="number">300</span></span><br><span class="line">#这里使用jinja</span><br><span class="line">daemonize &#123;&#123; DAEMONIZA &#125;&#125;</span><br><span class="line">supervised <span class="keyword">no</span></span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis.<span class="built_in">log</span></span><br><span class="line">databases <span class="number">16</span></span><br><span class="line">save <span class="number">900</span> <span class="number">1</span></span><br><span class="line">save <span class="number">300</span> <span class="number">10</span></span><br><span class="line">save <span class="number">60</span> <span class="number">10000</span></span><br><span class="line"><span class="keyword">stop</span>-writes-<span class="keyword">on</span>-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /var/lib/redis</span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line">slave-<span class="keyword">read</span>-<span class="keyword">only</span> yes</span><br><span class="line">repl-diskless-<span class="keyword">sync</span> <span class="keyword">no</span></span><br><span class="line">repl-diskless-<span class="keyword">sync</span>-delay <span class="number">5</span></span><br><span class="line">repl-disable-tcp-nodelay <span class="keyword">no</span></span><br><span class="line">slave-priority <span class="number">100</span></span><br><span class="line">appendonly <span class="keyword">no</span></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="keyword">no</span>-appendfsync-<span class="keyword">on</span>-rewrite <span class="keyword">no</span></span><br><span class="line">auto-aof-rewrite-percentage <span class="number">100</span></span><br><span class="line">auto-aof-rewrite-<span class="built_in">min</span>-size <span class="number">64</span>mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line"><span class="keyword">lua</span>-time-limit <span class="number">5000</span></span><br><span class="line">slowlog-<span class="built_in">log</span>-slower-than <span class="number">10000</span></span><br><span class="line">slowlog-<span class="built_in">max</span>-<span class="built_in">len</span> <span class="number">128</span></span><br><span class="line">latency-monitor-threshold <span class="number">0</span></span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br><span class="line">hash-<span class="built_in">max</span>-ziplist-entries <span class="number">512</span></span><br><span class="line">hash-<span class="built_in">max</span>-ziplist-value <span class="number">64</span></span><br><span class="line"><span class="keyword">list</span>-<span class="built_in">max</span>-ziplist-size -<span class="number">2</span></span><br><span class="line"><span class="keyword">list</span>-compress-depth <span class="number">0</span></span><br><span class="line"><span class="keyword">set</span>-<span class="built_in">max</span>-intset-entries <span class="number">512</span></span><br><span class="line">zset-<span class="built_in">max</span>-ziplist-entries <span class="number">128</span></span><br><span class="line">zset-<span class="built_in">max</span>-ziplist-value <span class="number">64</span></span><br><span class="line">hll-sparse-<span class="built_in">max</span>-bytes <span class="number">3000</span></span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-<span class="keyword">buffer</span>-limit <span class="keyword">normal</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">client-output-<span class="keyword">buffer</span>-limit slave <span class="number">256</span>mb <span class="number">64</span>mb <span class="number">60</span></span><br><span class="line">client-output-<span class="keyword">buffer</span>-limit pubsub <span class="number">32</span>mb <span class="number">8</span>mb <span class="number">60</span></span><br><span class="line">hz <span class="number">10</span></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure></p><p>5）<code>top file</code>文件编写<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/top.sls </span><br><span class="line">prod:</span><br><span class="line">  'salt-minion02':</span><br><span class="line">    - redis.<span class="literal">master</span></span><br><span class="line">  'salt-minion03':</span><br><span class="line">    - redis.<span class="literal">slave</span></span><br></pre></td></tr></table></figure></p><p>6）整体<code>state</code>文件查看<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# tree</span> /srv/salt/prod/redis/</span><br><span class="line">/srv/salt/prod/redis/</span><br><span class="line">├── files</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── init.sls</span><br><span class="line">├── <span class="literal">master</span>.sls</span><br><span class="line">└── <span class="literal">slave</span>.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">4</span> files</span><br></pre></td></tr></table></figure></p><p>7）<code>top file</code>高级状态执行<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先测试下看下状态文件是否编写正确，再正式执行</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' state.highstate <span class="attr">test=</span><span class="literal">True</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' state.highstate</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;很多时候我们在编写&lt;code&gt;state&lt;/code&gt; 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的&lt;code&gt;unless&lt;/code&gt;和&lt;cod
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack配置管理</title>
    <link href="https://leeyj.coding.me/2019/05/15/saltstack%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/"/>
    <id>https://leeyj.coding.me/2019/05/15/saltstack配置管理/</id>
    <published>2019-05-15T15:42:05.000Z</published>
    <updated>2019-07-10T01:46:30.088Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Saltstack状态模块"><a href="#Saltstack状态模块" class="headerlink" title="Saltstack状态模块"></a>Saltstack状态模块</h2><blockquote><p>远程执行模块的执行是过程式，而状态是对<code>minion</code>的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述<code>minion</code>的状态描述。<br>它的和兴是写<code>sls(Salt State file)</code>文件，<code>sls</code>文件默认格式为<code>YAML</code>格式，并默认使用<code>jinja</code>模板，<code>jinja</code>是根据<code>django</code>的模板语言发展而来的语言，简单并强大，支持<code>for if</code>等循环语句。<code>salt state</code>主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql-<span class="keyword">install</span>:   <span class="comment">#ID声明，必须唯一</span></span><br><span class="line">  pkg.installed:   <span class="comment">#state状态声明</span></span><br><span class="line">    - pkgs:   <span class="comment">#选项声明</span></span><br><span class="line">      - mariadb:   <span class="comment">#选项列表</span></span><br><span class="line">      - mariadb-<span class="keyword">server</span></span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line">一个<span class="keyword">ID</span>只能出现一次</span><br><span class="line">一个<span class="keyword">ID</span>下相同模块只能使用一次</span><br><span class="line">一个<span class="keyword">ID</span>下不可以使用多个不同模块</span><br></pre></td></tr></table></figure><p>模块帮助手册<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#列出所有状态模块</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> sys.list_modules</span></span><br><span class="line"><span class="meta">#查看指定模块的所有方法</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> sys.list_state_functions pkg</span></span><br><span class="line"><span class="meta">#查看指定模块的使用方法</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> sys.state_doc pkg</span></span><br><span class="line"><span class="meta">#查看指定模块的指定方法的用法</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> sys.state_doc pkg.installed</span></span><br></pre></td></tr></table></figure></p><h3 id="pkg软件模块"><a href="#pkg软件模块" class="headerlink" title="pkg软件模块"></a>pkg软件模块</h3><p><a href="https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html" target="_blank" rel="noopener">pkg模块官档</a><br><code>pkg.installed</code> 软件安装<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">php-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    -<span class="ruby"> <span class="symbol">pkgs:</span></span></span><br><span class="line"><span class="ruby">      - php</span></span><br><span class="line"><span class="ruby">      - php-<span class="symbol">mysql:</span> <span class="string">"&gt;=5.4.16"</span>    <span class="comment">#指定安装版本</span></span></span><br><span class="line"><span class="ruby">      - php-pdo</span></span><br><span class="line"><span class="ruby">      - php-cli</span></span><br></pre></td></tr></table></figure></p><p>指定安装最新版本的软件<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">php-install:</span><br><span class="line">  pkg.latest:</span><br><span class="line">    -<span class="ruby"> <span class="symbol">pkgs:</span></span></span><br><span class="line"><span class="ruby">      - php</span></span><br><span class="line"><span class="ruby">      - php-mysql</span></span><br><span class="line"><span class="ruby">      - php-pdo</span></span><br><span class="line"><span class="ruby">      - php-cli</span></span><br></pre></td></tr></table></figure></p><h3 id="file文件模块"><a href="#file文件模块" class="headerlink" title="file文件模块"></a>file文件模块</h3><p><a href="https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html" target="_blank" rel="noopener">file模块官档</a><br><code>file.managed</code> 下发文件，确保文件存在<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# <span class="built_in">mkdir</span> /srv/salt/base/<span class="keyword">files</span></span><br><span class="line">[root@salt-master ~]# <span class="keyword">cp</span> /etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span> /srv/salt/base/<span class="keyword">files</span>/</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class="line">apache-confi<span class="variable">g:</span></span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - name: /etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - <span class="keyword">mode</span>: <span class="number">644</span></span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line">- name: 表示存放目的地址</span><br><span class="line">- <span class="keyword">source</span>: 表示这个文件来自哪里（说明这个文件得提前准备）</span><br><span class="line"></span><br><span class="line">或者这样写，直接已目的地址命令ID，这样ID也表示目的地址</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class="line">/etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span>:</span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - <span class="keyword">mode</span>: <span class="number">644</span></span><br></pre></td></tr></table></figure></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">小示例：</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/test.sls</span><br><span class="line">/tmp/passwd_back:</span><br><span class="line">  file.managed:</span><br><span class="line">    - source: salt://files/passwd</span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - mode: <span class="number">644</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cp</span> /etc/passwd /srv/salt/base/files/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' state.sls test</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' cmd.run <span class="string">"ls -l /tmp/passwd_back"</span></span><br><span class="line">salt-minion03:</span><br><span class="line">    -rw-r--r-- <span class="number">1</span> root root <span class="number">2098</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">21</span> /tmp/passwd_back</span><br><span class="line">salt-minion02:</span><br><span class="line">    -rw-r--r-- <span class="number">1</span> root root <span class="number">2098</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">21</span> /tmp/passwd_back</span><br><span class="line">salt-minion01:</span><br><span class="line">    -rw-r--r-- <span class="number">1</span> root root <span class="number">2098</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">21</span> /tmp/passwd_back</span><br></pre></td></tr></table></figure><p><code>file.directory</code> 建立目录<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/directory.sls</span><br><span class="line">/tmp/saltdir:</span><br><span class="line">  file.directory:</span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - mode: <span class="number">755</span></span><br><span class="line">    - makedirs: <span class="literal">True</span>   <span class="comment">#如果上一级目录不存在自动创建；类似（mkdir -p）</span></span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' state.sls directory</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' cmd.run <span class="string">"ls -d /tmp/saltdir"</span></span><br><span class="line">salt-minion03:</span><br><span class="line">    /tmp/saltdir</span><br><span class="line">salt-minion02:</span><br><span class="line">    /tmp/saltdir</span><br><span class="line">salt-minion01:</span><br><span class="line">    /tmp/saltdir</span><br></pre></td></tr></table></figure></p><p><code>file.recurse</code> 下发整个目录<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/base/httpd_conf_dir.sls</span></span><br><span class="line"><span class="attr">httpd_conf_dir:</span></span><br><span class="line">  <span class="string">file.recurse:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/httpd/conf.d</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/conf.d</span></span><br><span class="line"><span class="attr">    - file_mode:</span> <span class="number">600</span>    <span class="comment">#文件权限</span></span><br><span class="line"><span class="attr">    - dir_mode:</span> <span class="number">755</span>    <span class="comment">#目录权限</span></span><br><span class="line"><span class="attr">    - include_empty:</span> <span class="literal">True</span>   <span class="comment">#同步空目录</span></span><br><span class="line"><span class="attr">    - clean:</span> <span class="literal">True</span>    <span class="comment">#使用后minion与master保持一致</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">rsync</span> <span class="bullet">-avh</span> <span class="string">/etc/httpd/conf.d</span> <span class="string">/srv/salt/base/files/</span></span><br></pre></td></tr></table></figure></p><p><code>file.symlink</code> 建立软链接<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># cat /srv/salt/base/target_link.sls</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>grub.cfg:</span><br><span class="line">  file.symlink:</span><br><span class="line">    - target: <span class="meta-keyword">/etc/</span>grub2.cfg</span><br><span class="line"></span><br><span class="line">[root@salt-master ~]<span class="meta"># salt <span class="string">'*'</span> state.sls target_link</span></span><br><span class="line">[root@salt-master ~]<span class="meta"># salt <span class="string">'*'</span> cmd.run <span class="string">"ls -l /etc/grub.cfg"</span></span></span><br><span class="line">salt-minion03:</span><br><span class="line">    lrwxrwxrwx <span class="number">1</span> root root <span class="number">14</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">42</span> <span class="meta-keyword">/etc/</span>grub.cfg -&gt; <span class="meta-keyword">/etc/</span>grub2.cfg</span><br><span class="line">salt-minion01:</span><br><span class="line">    lrwxrwxrwx <span class="number">1</span> root root <span class="number">14</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">42</span> <span class="meta-keyword">/etc/</span>grub.cfg -&gt; <span class="meta-keyword">/etc/</span>grub2.cfg</span><br><span class="line">salt-minion02:</span><br><span class="line">    lrwxrwxrwx <span class="number">1</span> root root <span class="number">14</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">42</span> <span class="meta-keyword">/etc/</span>grub.cfg -&gt; <span class="meta-keyword">/etc/</span>grub2.cfg</span><br></pre></td></tr></table></figure></p><h3 id="service服务模块"><a href="#service服务模块" class="headerlink" title="service服务模块"></a>service服务模块</h3><p><a href="https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html" target="_blank" rel="noopener">service模块官档</a><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/base/service_httpd.sls</span></span><br><span class="line"><span class="attr">httpd:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">httpd</span>   <span class="comment">#服务名称</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span>    <span class="comment">#开机自启动</span></span><br><span class="line"><span class="attr">    - reload:</span> <span class="literal">True</span>    <span class="comment">#允许重载配置文件，不写则是restart</span></span><br><span class="line"></span><br><span class="line"><span class="string">或者这样写</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/base/service_httpd.sls</span></span><br><span class="line"><span class="attr">httpd:</span>   <span class="comment">#即表示ID，又表示服务名</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - reload:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure></p><h2 id="高级状态模块"><a href="#高级状态模块" class="headerlink" title="高级状态模块"></a>高级状态模块</h2><blockquote><p>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 <code>top file</code><br>来进行管理。可以通过正则，<code>grain</code>模块，或分组名，来进行匹配，再下一级是要执行的<code>state</code>文件</p></blockquote><p>可以将我们的配置需求转换为<code>YAML</code>并在<code>Top file</code>文件中表示：<br><img src="/2019/05/15/saltstack配置管理/01.png" alt></p><p><code>Top file</code>示例<br><figure class="highlight rsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">base:</span><br><span class="line">  <span class="string">'*'</span>: <span class="meta">#通过正则去匹配所有minion</span></span><br><span class="line">    - app.nginx</span><br><span class="line"></span><br><span class="line">  webserver: <span class="meta">#定义的分组名称</span></span><br><span class="line">    - <span class="built_in">match</span>: nodegroup</span><br><span class="line">    - app.cron</span><br><span class="line"></span><br><span class="line">  <span class="string">'os:centos'</span>:  <span class="meta">#通过grains模块匹配</span></span><br><span class="line">    - <span class="built_in">match</span>: grains</span><br><span class="line">    - nginx</span><br></pre></td></tr></table></figure></p><p><code>Top file</code> 高级状态的执行<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><h2 id="LAMP架构案例"><a href="#LAMP架构案例" class="headerlink" title="LAMP架构案例"></a>LAMP架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br>1）环境准备，定义<code>file_roots</code>环境<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># vim /etc/salt/master</span></span><br><span class="line"><span class="symbol">file_roots:</span></span><br><span class="line"><span class="symbol">  base:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/base</span><br><span class="line"><span class="symbol">  dev:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/dev</span><br><span class="line"><span class="symbol">  prod:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p><p>2）创建对应环境目录<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> /srv/salt/prod/&#123;httpd,php,mysql,files&#125;</span><br></pre></td></tr></table></figure></p><p>3）配置文件准备及测试文件准备<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cp</span> /etc/my.cnf /srv/salt/prod/files/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cp</span> /etc/httpd/conf/httpd.conf /srv/salt/prod/files/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cp</span> /etc/php.ini  /srv/salt/prod/files/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# echo</span> <span class="string">"&lt;h1&gt;LAMP html&lt;/h1&gt;"</span> &gt;&gt;/srv/salt/prod/files/index.html</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# echo</span> <span class="string">"&lt;?php phpinfo(); ?&gt;"</span> &gt;&gt; /srv/salt/prod/files/index.php</span><br></pre></td></tr></table></figure></p><p>4）编写<code>state sls</code>状态文件<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">#httpd</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/prod/httpd/init.sls</span><br><span class="line">apache-instal<span class="variable">l:</span></span><br><span class="line">  pkg.installed:</span><br><span class="line">    - pkg<span class="variable">s:</span></span><br><span class="line">      - httpd</span><br><span class="line">      - httpd-tools</span><br><span class="line"></span><br><span class="line">apache-confi<span class="variable">g:</span></span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - name: /etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - <span class="keyword">mode</span>: <span class="number">644</span></span><br><span class="line"></span><br><span class="line">apache-service:</span><br><span class="line">  service.runnin<span class="variable">g:</span></span><br><span class="line">    - name: httpd</span><br><span class="line">    - enable: True</span><br><span class="line"></span><br><span class="line">#php</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/prod/php/init.sls</span><br><span class="line">php-instal<span class="variable">l:</span></span><br><span class="line">  pkg.installed:</span><br><span class="line">    - pkg<span class="variable">s:</span></span><br><span class="line">      - php</span><br><span class="line">      - php-mysql</span><br><span class="line">      - php-pdo</span><br><span class="line">      - php-cli</span><br><span class="line"></span><br><span class="line">php-confi<span class="variable">g:</span></span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - name: /etc/php.ini</span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/php.ini</span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - <span class="keyword">mode</span>: <span class="number">644</span></span><br><span class="line"></span><br><span class="line">#mysql</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/prod/mysql/init.sls</span><br><span class="line">mariadb-instal<span class="variable">l:</span></span><br><span class="line">  pkg.installed:</span><br><span class="line">    - pkg<span class="variable">s:</span></span><br><span class="line">      - mariadb-server</span><br><span class="line">      - mariadb</span><br><span class="line"></span><br><span class="line">mariadb-confi<span class="variable">g:</span></span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - name: /etc/my.<span class="keyword">cnf</span></span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/my.<span class="keyword">cnf</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - <span class="keyword">mode</span>: <span class="number">644</span></span><br><span class="line"></span><br><span class="line">mariadb-service:</span><br><span class="line">  service.runnin<span class="variable">g:</span></span><br><span class="line">    - name: mariadb</span><br><span class="line">    - enable: True</span><br><span class="line"></span><br><span class="line">#测试文件</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/prod/testfile.sls</span><br><span class="line">/var/www/html/<span class="built_in">index</span>.htm<span class="variable">l:</span></span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/<span class="built_in">index</span>.html</span><br><span class="line"></span><br><span class="line">/var/www/html/<span class="built_in">index</span>.php:</span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/<span class="built_in">index</span>.php</span><br></pre></td></tr></table></figure></p><p>6）<code>topfile</code>文件编写<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class="line">prod:</span><br><span class="line">  <span class="string">'salt-minion*'</span>:</span><br><span class="line">    - httpd.<span class="keyword">init</span></span><br><span class="line">    - php.<span class="keyword">init</span></span><br><span class="line">    - mysql.<span class="keyword">init</span></span><br><span class="line">    - testfile</span><br></pre></td></tr></table></figure></p><p>7）部署<code>LAMP</code>整体<code>state</code>文件查看<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# tree /srv/salt/</span><br><span class="line">/srv/salt/</span><br><span class="line">├── base</span><br><span class="line">│   └── top.sls</span><br><span class="line">├── dev</span><br><span class="line">└── prod</span><br><span class="line">    ├── <span class="keyword">files</span></span><br><span class="line">    │   ├── httpd.<span class="keyword">conf</span></span><br><span class="line">    │   ├── <span class="built_in">index</span>.html</span><br><span class="line">    │   ├── <span class="built_in">index</span>.php</span><br><span class="line">    │   ├── my.<span class="keyword">cnf</span></span><br><span class="line">    │   └── php.ini</span><br><span class="line">    ├── httpd</span><br><span class="line">    │   └── init.sls</span><br><span class="line">    ├── mysql</span><br><span class="line">    │   └── init.sls</span><br><span class="line">    ├── php</span><br><span class="line">    │   └── init.sls</span><br><span class="line">    └── testfile.sls</span><br></pre></td></tr></table></figure></p><p>8）执行<code>topfile</code><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><h2 id="States状态依赖"><a href="#States状态依赖" class="headerlink" title="States状态依赖"></a>States状态依赖</h2><p>通过上面的<code>lamp</code>可以看出已经可以使用<code>state</code>模块来定义<code>minion</code>的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用<code>requisites</code>来进行控制</p><blockquote><p>关系说明：<br>1、<code>require</code> 我依赖某个状态，我依赖谁<br>2、<code>require_in</code> 我被某个状态依赖，谁依赖我<br>3、<code>watch</code> 我关注某个状态，当状态发生改变，进行<code>restart</code>或者<code>reload</code>操作<br>4、<code>watch_in</code> 我被某个状态关注<br>5、<code>include</code> 我引用谁</p></blockquote><p>1）修改上面<code>lamp</code>状态间依赖关系<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#httpd</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/httpd/init.sls</span></span><br><span class="line"><span class="attr">apache-install:</span></span><br><span class="line">  <span class="string">pkg.installed:</span></span><br><span class="line"><span class="attr">    - pkgs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd-tools</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apache-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/httpd.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">apache-install</span>   <span class="comment">#表示上面apache-install执行成功，才能执行apache-config</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apache-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">apache-config</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">apache-config</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#php</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/php/init.sls</span></span><br><span class="line"><span class="attr">php-install:</span></span><br><span class="line">  <span class="string">pkg.installed:</span></span><br><span class="line"><span class="attr">    - pkgs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-mysql</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-pdo</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-cli</span></span><br><span class="line"><span class="attr">    - reqiure_in:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-config</span></span><br><span class="line"></span><br><span class="line"><span class="attr">php-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/php.ini</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/php.ini</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mysql</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/mysql/init.sls</span></span><br><span class="line"><span class="attr">mariadb-install:</span></span><br><span class="line">  <span class="string">pkg.installed:</span></span><br><span class="line"><span class="attr">    - pkgs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">mariadb-server</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">mariadb</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mariadb-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/my.cnf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/my.cnf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">mariadb-install</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mariadb-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">mariadb</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - reload:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">mariadb-config</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">mariadb-config</span></span><br></pre></td></tr></table></figure></p><p>2）修改引用关系后<code>include</code><br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>salt-master ~]# tree /srv/salt/</span><br><span class="line">/srv/salt/</span><br><span class="line">├── base</span><br><span class="line">│   └── top.sls</span><br><span class="line">├── dev</span><br><span class="line">└── prod</span><br><span class="line">    ├── files</span><br><span class="line">    │   ├── httpd.conf</span><br><span class="line">    │   ├── index.html</span><br><span class="line">    │   ├── index.php</span><br><span class="line">    │   ├── my.cnf</span><br><span class="line">    │   └── php.ini</span><br><span class="line">    ├── httpd</span><br><span class="line">    │   └── <span class="keyword">init</span>.sls</span><br><span class="line">    ├── lamp.sls</span><br><span class="line">    ├── mysql</span><br><span class="line">    │   └── <span class="keyword">init</span>.sls</span><br><span class="line">    ├── php</span><br><span class="line">    │   └── <span class="keyword">init</span>.sls</span><br><span class="line">    └── testfile.sls</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>salt-master ~]# cat /srv/salt/prod/lamp.sls</span><br><span class="line">include:</span><br><span class="line">  - httpd.<span class="keyword">init</span></span><br><span class="line">  - php.<span class="keyword">init</span></span><br><span class="line">  - mysql.<span class="keyword">init</span></span><br><span class="line">  - testfile</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class="line">prod:</span><br><span class="line">  <span class="string">'salt-minion*'</span>:</span><br><span class="line">    - lamp</span><br></pre></td></tr></table></figure></p><p>3）编写<code>SLS</code>技巧</p><blockquote><p>1、按照状态分类，如果单独使用，清晰明了<br>2、按照服务分类，可以被其它<code>SLS</code>引用</p></blockquote><h2 id="Jinja模板使用"><a href="#Jinja模板使用" class="headerlink" title="Jinja模板使用"></a>Jinja模板使用</h2><blockquote><p>配置文件一般灵活多变，比如配置<code>apache</code>的<code>IP</code>地址或者端口<code>PORT</code>等，则可以动态传值。<br><a href="http://docs.jinkan.org/docs/jinja2/" target="_blank" rel="noopener">Jinja官档</a><br><a href="https://docs.saltstack.com/en/latest/topics/jinja/index.html" target="_blank" rel="noopener">salt jinja官档</a></p></blockquote><p><code>Jinja2</code> 模板包含变量和表达式，变量用 &#123;&#123; … &#125;&#125; 包围，表达式用 &#123;&#37; … &#37;&#125; 包围。变量使用示例：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /srv/salt/base/var.sls </span><br><span class="line">&#123;% set var= <span class="emphasis">'hello world!'</span> %&#125;</span><br><span class="line">test<span class="emphasis">_var:</span></span><br><span class="line"><span class="emphasis">  cmd.run:</span></span><br><span class="line"><span class="emphasis">    - name: echo "测试变量 &#123;&#123; var &#125;&#125;"</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">[root@salt-master ~]# salt 'salt-minion01' state.sls var</span></span><br><span class="line"><span class="emphasis">salt-minion01:</span></span><br><span class="line"><span class="emphasis">----------</span></span><br><span class="line"><span class="emphasis">          ID: test_</span>var</span><br><span class="line"><span class="code">    Function: cmd.run</span></span><br><span class="line"><span class="code">        Name: echo "测试变量 hello world!"</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: Command "echo "测试变量 hello world!"" run</span></span><br><span class="line"><span class="code">     Started: 14:50:58.302424</span></span><br><span class="line"><span class="code">    Duration: 12.358 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"><span class="code">              ----------</span></span><br><span class="line"><span class="code">              pid:</span></span><br><span class="line"><span class="code">                  22510</span></span><br><span class="line"><span class="code">              retcode:</span></span><br><span class="line"><span class="code">                  0</span></span><br><span class="line"><span class="code">              stderr:</span></span><br><span class="line"><span class="code">              stdout:</span></span><br><span class="line"><span class="code">                  测试变量 hello world!</span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 1 (changed=1)</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     1</span><br><span class="line">Total run time:  12.358 ms</span><br></pre></td></tr></table></figure></p><p><code>jinja2</code> 常用变量<br>1、字符串类型<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">set</span> <span class="keyword">var</span> = <span class="string">'test'</span> %&#125;  <span class="meta">#定义变量</span></span><br><span class="line">&#123;&#123; <span class="keyword">var</span> &#125;&#125;  <span class="meta">#调用变量</span></span><br></pre></td></tr></table></figure></p><p>2、列表类型<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set <span class="keyword">list</span> = [<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>] %&#125;</span><br><span class="line">&#123;&#123; <span class="keyword">list</span>[<span class="number">1</span>] &#125;&#125;  <span class="comment">#获取变量的第一个值</span></span><br></pre></td></tr></table></figure></p><p>3、字典类型<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">set</span> dict <span class="comment">= &#123;</span><span class="comment">'key1'</span><span class="comment">:</span><span class="comment">'value1'</span><span class="comment">,</span> <span class="comment">'key2'</span><span class="comment">:</span><span class="comment">'value2'</span><span class="comment">&#125; %&#125;</span></span><br><span class="line">&#123;&#123; dict[<span class="string">'key1'</span>] &#125;&#125;  #获取<span class="string">'key1'</span>的值</span><br></pre></td></tr></table></figure></p><p>示例1：<code>Saltstack</code>使用<code>jinja</code>模块配置<code>apache</code>监听端口<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.告诉file状态模块，需要使用jinja</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="comment">#2.列出参数列表</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="attr">      PORT:</span> <span class="number">8000</span></span><br><span class="line"><span class="comment">#3.配置文件引用jinja模板</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">PORT</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置示例</span></span><br><span class="line"><span class="attr">apache-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/httpd.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="attr">      PORT:</span> <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改httpd.conf配置文件引用变量</span></span><br><span class="line"><span class="string">Listen</span> <span class="string">&#123;&#123;</span> <span class="string">PORT</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p><p>示例2：使用<code>grinas</code> 方式进行赋值<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置示例</span></span><br><span class="line"><span class="attr">apache-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/httpd.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="attr">      PORT:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">      IPADDR:</span> <span class="string">&#123;&#123;</span> <span class="string">grains['fqdn_ip4'][0]</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改httpd.conf配置文件引用变量</span></span><br><span class="line"><span class="string">Listen</span> <span class="string">&#123;&#123;</span> <span class="string">IPADDR</span> <span class="string">&#125;&#125;:&#123;&#123;</span> <span class="string">PORT</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p><p>示例3：通过<code>jinja+grains</code>根据系统不同安装<code>apache</code><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="comment"># cat /srv/salt/base/httpd.sls</span></span><br><span class="line"><span class="comment">#根据grains获取的值判别系统后安装软件</span></span><br><span class="line">httpd-<span class="keyword">install</span>:</span><br><span class="line">  pkg.installed:</span><br><span class="line">&#123;% <span class="keyword">if</span> grains[<span class="string">'os'</span>] == <span class="string">'CentOS'</span> %&#125;</span><br><span class="line">    - <span class="keyword">name</span>: httpd</span><br><span class="line">&#123;% elif grains[<span class="string">'OS'</span>] == <span class="string">'Debin'</span> %&#125;</span><br><span class="line">    - <span class="keyword">name</span>: apache2</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Saltstack状态模块&quot;&gt;&lt;a href=&quot;#Saltstack状态模块&quot; class=&quot;headerlink&quot; title=&quot;Saltstack状态模块&quot;&gt;&lt;/a&gt;Saltstack状态模块&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;远程执行模块的执行是过程式
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack远程执行</title>
    <link href="https://leeyj.coding.me/2019/05/14/saltstack%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C/"/>
    <id>https://leeyj.coding.me/2019/05/14/saltstack远程执行/</id>
    <published>2019-05-14T09:47:05.000Z</published>
    <updated>2019-07-10T01:46:30.078Z</updated>
    
    <content type="html"><![CDATA[<p>安装完<code>Saltstack</code>后可以立即执行<code>shell</code>命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：<a href="http://docs.saltstack.cn/topics/tutorials/modules.html" target="_blank" rel="noopener">http://docs.saltstack.cn/topics/tutorials/modules.html</a><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="comment"># salt '*' cmd.run "uptime"</span></span><br><span class="line">salt-minion01:</span><br><span class="line">     15:23:08 up 1 day, 58 min,  2 users,  <span class="keyword">load</span> average: <span class="number">0.00</span>, <span class="number">0.03</span>, <span class="number">0.08</span></span><br><span class="line"><span class="keyword">salt</span>-minion02:</span><br><span class="line">     <span class="number">15</span>:<span class="number">23</span>:<span class="number">08</span> up <span class="number">21</span>:<span class="number">38</span>,  <span class="number">2</span> <span class="keyword">users</span>,  <span class="keyword">load</span> average: <span class="number">0.00</span>, <span class="number">0.04</span>, <span class="number">0.10</span></span><br><span class="line"><span class="keyword">salt</span>-minion03:</span><br><span class="line">     <span class="number">15</span>:<span class="number">23</span>:<span class="number">08</span> up <span class="number">21</span>:<span class="number">36</span>,  <span class="number">2</span> <span class="keyword">users</span>,  <span class="keyword">load</span> average: <span class="number">0.00</span>, <span class="number">0.04</span>, <span class="number">0.10</span></span><br></pre></td></tr></table></figure></p><h2 id="Salt命令的结构语法"><a href="#Salt命令的结构语法" class="headerlink" title="Salt命令的结构语法"></a>Salt命令的结构语法</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'&lt;target&gt;'</span> &lt;<span class="function"><span class="keyword">function</span>&gt; <span class="params">[arguments]</span></span></span><br></pre></td></tr></table></figure><p><img src="/2019/05/14/saltstack远程执行/01.png" alt></p><h2 id="目标主机Target"><a href="#目标主机Target" class="headerlink" title="目标主机Target"></a>目标主机Target</h2><p><img src="/2019/05/14/saltstack远程执行/02.png" alt><br>1、通配符匹配<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'salt-minion01'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*01'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'salt-minion0[1|2]'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'salt-minion0[!1|2]'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'salt-minion0?'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><p>2、列表匹配<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -L <span class="string">'salt-minion01,salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><p>3、正则匹配<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -E <span class="string">'^salt'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -E <span class="string">'^salt.*2$'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><p>4、IP匹配<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# salt -S '<span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span>' test.ping</span><br><span class="line">[root@salt-master ~]# salt -S '<span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>' test.ping</span><br></pre></td></tr></table></figure></p><p>5、复合匹配<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> -C 'G@os:CentOS <span class="keyword">and</span> S@<span class="number">192.168</span>.<span class="number">1.32</span>' test.ping</span><br></pre></td></tr></table></figure></p><p>6、分组匹配<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">nodegroups:</span><br><span class="line">  webserver: 'salt-minion01,salt-minion02'</span><br><span class="line">  dbserver: 'salt-minion03</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> -N 'webserver' test.ping</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> -N 'dbserver' test.ping</span><br></pre></td></tr></table></figure></p><p>7、Grains匹配<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -G <span class="string">'os:CentOS'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -G <span class="string">'localhost:salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><blockquote><p>说明：上面这些匹配方式在<code>top.sls</code>文件中同样适用。</p></blockquote><h2 id="模块Module"><a href="#模块Module" class="headerlink" title="模块Module"></a>模块Module</h2><p><img src="/2019/05/14/saltstack远程执行/03.png" alt></p><blockquote><p><code>test</code>模块多用于测试<br><code>user</code>模块用于用户管理<br><code>cmd</code>模块可以执行任意<code>shell</code>命令<br><code>pkg</code>模块用于软件包管理<br><code>file</code>模块多用于配置<br><code>service</code>模块用于服务管理</p></blockquote><p><a href="http://docs.saltstack.cn/ref/modules/all/index.html" target="_blank" rel="noopener">所有模块列表</a></p><p><strong>test模块</strong><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">模块名：test</span><br><span class="line">功能：用于测试</span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><p><strong>user模块</strong><br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">参考：http://docs.saltstack.<span class="keyword">cn</span>/ref/modules/<span class="keyword">all</span>/salt.modules.useradd.html#module-salt.modules.useradd</span><br><span class="line"># salt <span class="string">'*'</span> user.<span class="built_in">add</span> name <span class="symbol">&lt;uid&gt;</span> <span class="symbol">&lt;gid&gt;</span> <span class="symbol">&lt;groups&gt;</span> <span class="symbol">&lt;home&gt;</span> <span class="symbol">&lt;shell&gt;</span></span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> user.<span class="built_in">add</span> testuser</span><br></pre></td></tr></table></figure></p><p><strong>cmd模块</strong><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">模块名：cmd</span><br><span class="line">功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）</span><br><span class="line"><span class="meta">#查看所有minion内存和磁盘使用情况</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> cmd.run <span class="string">"free -m"</span></span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> cmd.run <span class="string">"df -h"</span></span></span><br></pre></td></tr></table></figure></p><p><strong>pkg模块</strong><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">模块名：pkg</span><br><span class="line">功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）</span><br><span class="line"></span><br><span class="line"><span class="meta">#安装</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> pkg.install <span class="string">"vsftpd"</span> </span></span><br><span class="line"><span class="meta">#卸载</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> pkg.remove <span class="string">"vsftpd"</span></span></span><br><span class="line"><span class="meta">#安装最新版本</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> pkg.latest_version <span class="string">"vsftpd"</span></span></span><br><span class="line"><span class="meta">#更新软件包</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> pkg.upgrade <span class="string">"vsftpd"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#查看帮助手册</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> pkg</span></span><br></pre></td></tr></table></figure></p><p><strong>file模块</strong><br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">模块名：<span class="keyword">file</span></span><br><span class="line">功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验</span><br><span class="line"></span><br><span class="line">#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.get_sum <span class="regexp">/etc/</span>passwd md5</span><br><span class="line"></span><br><span class="line">#修改所有minion主机<span class="regexp">/etc/</span>passwd文件的属组、用户权限、等价于chown root:root <span class="regexp">/etc/</span>passwd</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.chown <span class="regexp">/etc/</span>passwd root root</span><br><span class="line"></span><br><span class="line">#获取所有minion主机<span class="regexp">/etc/</span>passwd的stats信息</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.stats <span class="regexp">/etc/</span>passwd</span><br><span class="line"></span><br><span class="line">#获取所有minion主机<span class="regexp">/etc/</span>passwd的权限mode,如<span class="number">755</span>,<span class="number">644</span></span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.get_mode <span class="regexp">/etc/</span>passwd</span><br><span class="line"></span><br><span class="line">#修改所有minion主机<span class="regexp">/etc/</span>passwd的权限mode为<span class="number">0644</span></span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.set_mode <span class="regexp">/etc/</span>passwd <span class="number">0644</span></span><br><span class="line"></span><br><span class="line">#在所有minion主机创建<span class="regexp">/opt/</span>test目录</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.mkdir <span class="regexp">/opt/</span>test</span><br><span class="line"></span><br><span class="line">#在所有minion主机穿件<span class="regexp">/tmp/</span>test.conf文件</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.touch <span class="regexp">/tmp/</span>test.conf</span><br><span class="line"></span><br><span class="line">#将所有minion主机<span class="regexp">/tmp/</span>test.conf文件追加内容<span class="string">'maxclient 100'</span></span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.<span class="keyword">append</span> <span class="regexp">/tmp/</span>test.conf <span class="string">'maxclient 100'</span></span><br><span class="line"></span><br><span class="line">#删除所有minion主机的<span class="regexp">/tmp/</span>test.conf文件</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.remove <span class="regexp">/tmp/</span>test.conf</span><br></pre></td></tr></table></figure></p><p><strong>service模块</strong><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">模块名：service</span><br><span class="line">功能：被控主机程序包服务管理</span><br><span class="line"></span><br><span class="line">#开启（enable）禁用（disable）</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.enable</span> &lt;service name&gt;</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.disabled</span> &lt;service name&gt;</span><br><span class="line"></span><br><span class="line">#reload、restart、start、stop、status操作</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.reload</span> &lt;service name&gt;</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.restart</span> &lt;service name&gt;</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.start</span> &lt;service name&gt;</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.stop</span> &lt;service name&gt;</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.status</span> &lt;service name&gt;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;安装完&lt;code&gt;Saltstack&lt;/code&gt;后可以立即执行&lt;code&gt;shell&lt;/code&gt;命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：&lt;a href=&quot;http://docs.saltstack.cn/top
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack基本入门</title>
    <link href="https://leeyj.coding.me/2019/05/13/saltstack%E5%9F%BA%E6%9C%AC%E5%85%A5%E9%97%A8/"/>
    <id>https://leeyj.coding.me/2019/05/13/saltstack基本入门/</id>
    <published>2019-05-13T07:47:05.000Z</published>
    <updated>2019-07-10T01:46:30.059Z</updated>
    
    <content type="html"><![CDATA[<h2 id="saltstack介绍"><a href="#saltstack介绍" class="headerlink" title="saltstack介绍"></a>saltstack介绍</h2><div class="note success"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div><p><strong>主要功能</strong><br>远程执行<br>配置管理<br><a href="http://docs.saltstack.cn/" target="_blank" rel="noopener">Stalstack官方文档</a></p><h2 id="Saltstack原理"><a href="#Saltstack原理" class="headerlink" title="Saltstack原理"></a>Saltstack原理</h2><blockquote><p><code>Salt</code>使用<code>server-agent</code>通信模型，服务端组件被称为<code>Salt master</code>，<code>agent</code>被称为<code>Salt minion</code><br><code>Salt master</code>主要负责向<code>Salt minions</code>发送命令，然后聚合并显示这些命令的结果。一个<code>Salt master</code>可以管理多个<code>minion</code>系统<br><code>Salt server</code>与<code>Salt minion</code>通信的连接由<code>Salt minion</code>发起，这也意味着<code>Salt minion</code>上不需要打开任何传入端口（从而减少攻击）。<code>Salt server</code>使用端口<code>4505</code>和<code>4506</code>，必须打开端口才能接收到访问连接</p></blockquote><p><img src="/2019/05/13/saltstack基本入门/01.png" alt="通信示例图"></p><ul><li><strong>Publisher</strong> （端口4505）所有<code>Salt minions</code>都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。</li><li><strong>Request Server</strong> （端口4506）<code>Salt minios</code>根据需要连接到请求服务器，将结果发送给<code>Salt master</code>，并安全地获取请求的文件或特定<code>minion</code>相关的数据值（称为<code>Salt pillar</code>）。连接到这个端口的连接在<code>Salt master</code>和<code>Salt minion</code>之间是1:1（不是异步）。</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# lsof -i:4505</span><br><span class="line">COMMAND     PID<span class="built_in"> USER </span>  FD  <span class="built_in"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class="line">salt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)</span><br><span class="line">salt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505-&gt;salt-minion03:37240 (ESTABLISHED)</span><br><span class="line">salt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505-&gt;salt-minion01:47804 (ESTABLISHED)</span><br><span class="line">salt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505-&gt;salt-minion02:58594 (ESTABLISHED)</span><br></pre></td></tr></table></figure><h2 id="快速安装"><a href="#快速安装" class="headerlink" title="快速安装"></a>快速安装</h2><p>1.1 配置 yum 仓库<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用官方自带yum</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm</span><br><span class="line"><span class="comment"># 或者使用阿里云的yum（建议使用阿里云的，速度快一点）</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class="number">2</span>.el7.noarch.rpm</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# sed</span> -i <span class="string">"s/repo.saltstack.com/mirrors.aliyun.com\/saltstack/g"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> clean all</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> makecache</span><br></pre></td></tr></table></figure></p><p>1.2 安装Master，并启动服务<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> enable salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> <span class="literal">start</span> salt-<span class="literal">master</span></span><br></pre></td></tr></table></figure></p><p>1.3 安装 Salt-Minion 指向 Salt-Master 网络地址<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># yum -y install salt-minion</span></span><br><span class="line"><span class="meta"># 可以使用主机名，也可以使用IP地址</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># sed -i <span class="string">'/#master: /c\master: salt-master'</span> /etc/salt/minion</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># systemctl enable salt-minion</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p><h2 id="SaltStack认证方式"><a href="#SaltStack认证方式" class="headerlink" title="SaltStack认证方式"></a>SaltStack认证方式</h2><p><img src="/2019/05/13/saltstack基本入门/02.png" alt="master与minion之间的架构关系图"></p><div class="note success"><p> <code>Salt</code> 的数据传输是通过 <code>AES</code> 加密，<code>Master</code> 和 <code>Minion</code> 之前在通信之前，需要进行认证。<br><code>Salt</code> 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class="note success"><p>1.  <code>minion</code> 在第一次启动时候，会在 <code>/etc/salt/pki/minion/</code> 下自动生成 <code>minion.pem(private key)</code> 和 <code>minion.pub(public key)</code>, 然后将 <code>minion.pub</code> 发送给 <code>master</code><br>2. <code>master</code> 在第一次启动时，会在 <code>/etc/salt/pki/master/</code> 下自动生成 <code>master.pem</code> 和 <code>master.pub</code> ；并且会接收到 <code>minion</code> 的 <code>public key</code> , 通过 <code>salt-key</code> 命令接收 <code>minion public key</code>， 会在 <code>master</code> 的 <code>/etc/salt/pki/master/minions</code> 目录下存放以 <code>minion id</code> 命令的 <code>public key</code> ；验证成功后同时 <code>minion</code> 会保存一份 <code>master public key</code> 在 minion的 <code>/etc/salt/pki/minion/minion_master.pub</code>里。</p></div><p><strong>Salt认证原理总结</strong></p><blockquote><p><code>minion</code>将自己的公钥发送给<code>master</code><br><code>master</code>认证后再将自己的公钥也发送给<code>minion</code>端</p></blockquote><p><strong>Master端认证示例</strong><br>根据上面提到的认证原理，先看下未认证前的<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master上查看</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# tree</span> /etc/salt/pki/</span><br><span class="line">/etc/salt/pki/</span><br><span class="line">├── <span class="literal">master</span></span><br><span class="line">│   ├── <span class="literal">master</span>.pem</span><br><span class="line">│   ├── <span class="literal">master</span>.pub</span><br><span class="line">│   ├── minions</span><br><span class="line">│   ├── minions_autosign</span><br><span class="line">│   ├── minions_denied</span><br><span class="line">│   ├── minions_pre</span><br><span class="line">│   │   └── salt-minion01</span><br><span class="line">│   └── minions_rejected</span><br><span class="line">└── minion</span><br><span class="line"></span><br><span class="line"><span class="comment"># minion上查看</span></span><br><span class="line">[root@salt-minion01 ~]<span class="comment"># tree /etc/salt/pki/</span></span><br><span class="line">/etc/salt/pki/</span><br><span class="line">├── <span class="literal">master</span></span><br><span class="line">└── minion</span><br><span class="line">    ├── minion.pem</span><br><span class="line">    └── minion.pub</span><br></pre></td></tr></table></figure></p><p><code>salt-key</code>命令解释：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">salt-key</span> <span class="bullet">-L</span> </span><br><span class="line"><span class="string">Accepted</span> <span class="attr">Keys:</span>        <span class="comment">#已经接受的key</span></span><br><span class="line"><span class="string">Denied</span> <span class="attr">Keys:</span>          <span class="comment">#拒绝的key</span></span><br><span class="line"><span class="string">Unaccepted</span> <span class="attr">Keys:</span>      <span class="comment">#未加入的key</span></span><br><span class="line"><span class="string">Rejected</span> <span class="attr">Keys:</span>        <span class="comment">#吊销的key</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#常用参数</span></span><br><span class="line"><span class="bullet">-</span><span class="string">L</span>  <span class="comment">#查看KEY状态</span></span><br><span class="line"><span class="bullet">-</span><span class="string">A</span>  <span class="comment">#允许所有</span></span><br><span class="line"><span class="bullet">-</span><span class="string">D</span>  <span class="comment">#删除所有</span></span><br><span class="line"><span class="bullet">-</span><span class="string">a</span>  <span class="comment">#认证指定的key</span></span><br><span class="line"><span class="bullet">-</span><span class="string">d</span>  <span class="comment">#删除指定的key</span></span><br><span class="line"><span class="bullet">-</span><span class="string">r</span>  <span class="comment">#注销掉指定key（该状态为未被认证）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置master自动接受请求认证(master上配置 /etc/salt/master)</span></span><br><span class="line"><span class="attr">auto_accept:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure></p><p><code>salt-key</code>认证<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列出当前所有的key</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -L </span><br><span class="line">Accepted Keys:</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">Rejected Keys:</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加指定minion的key</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -a salt-minion01 -y</span><br><span class="line">The following keys are going to be accepted:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">Key for minion salt-minion01 accepted.</span><br><span class="line"><span class="comment">#添加所有minion的key</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -A -y</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -L </span><br><span class="line">Accepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">Rejected Keys:</span><br></pre></td></tr></table></figure></p><p>上面认证完成后再次查看<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master上</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# tree</span> /etc/salt/pki/</span><br><span class="line">/etc/salt/pki/</span><br><span class="line">├── <span class="literal">master</span></span><br><span class="line">│   ├── <span class="literal">master</span>.pem</span><br><span class="line">│   ├── <span class="literal">master</span>.pub</span><br><span class="line">│   ├── minions</span><br><span class="line">│   │   └── salt-minion01</span><br><span class="line">│   ├── minions_autosign</span><br><span class="line">│   ├── minions_denied</span><br><span class="line">│   ├── minions_pre</span><br><span class="line">│   └── minions_rejected</span><br><span class="line">└── minion</span><br><span class="line"></span><br><span class="line"><span class="comment"># minion上</span></span><br><span class="line">[root@salt-minion01 ~]<span class="comment"># tree /etc/salt/pki/</span></span><br><span class="line">/etc/salt/pki/</span><br><span class="line">├── <span class="literal">master</span></span><br><span class="line">└── minion</span><br><span class="line">    ├── minion_master.pub</span><br><span class="line">    ├── minion.pem</span><br><span class="line">    └── minion.pub</span><br></pre></td></tr></table></figure></p><h2 id="Saltstack远程执行"><a href="#Saltstack远程执行" class="headerlink" title="Saltstack远程执行"></a>Saltstack远程执行</h2><blockquote><p>远程执行是 <code>Saltstack</code> 的核心功能之一。主要使用 <code>salt</code> 模块批量给选定的 <code>minion</code> 端执行相应的命令，并获得返回结果。</p></blockquote><p>1、判断 <code>salt</code> 的 <code>minion</code> 主机是否存活<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">salt</span> <span class="string">'*'</span> <span class="string">test.ping</span></span><br><span class="line"><span class="attr">salt-minion02:</span></span><br><span class="line">    <span class="literal">True</span></span><br><span class="line"><span class="attr">salt-minion03:</span></span><br><span class="line">    <span class="literal">True</span></span><br><span class="line"><span class="attr">salt-minion01:</span></span><br><span class="line">    <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># salt saltstack自带的一个命令</span></span><br><span class="line"><span class="comment"># * 表示目标主机，这里表示所有目标主机</span></span><br><span class="line"><span class="comment"># test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法</span></span><br></pre></td></tr></table></figure></p><p>2、<code>saltstack</code>使用 <code>cmd.run</code>模块远程执行shell命令<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#在指定目标minion节点运行uptime命令</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'salt-minion02'</span> cmd.run <span class="string">'uptime'</span></span></span><br><span class="line">salt-minion02:</span><br><span class="line">     <span class="number">18</span>:<span class="number">13</span>:<span class="number">08</span> up <span class="number">28</span> min,  <span class="number">2</span> users,  load average: <span class="number">0.00</span>, <span class="number">0.04</span>, <span class="number">0.13</span></span><br></pre></td></tr></table></figure></p><h2 id="Saltstack配置管理"><a href="#Saltstack配置管理" class="headerlink" title="Saltstack配置管理"></a>Saltstack配置管理</h2><p><div class="note success"><p><code>Salt</code> 通过<code>State</code>模块来进行文件的管理；通过<code>YAML</code>语法来描述，后缀是<code>.sls</code>的文件</p></div>1、了解 <code>YAML</code> 参考：<a href="http://docs.saltstack.cn/topics/yaml/index.html" target="_blank" rel="noopener">http://docs.saltstack.cn/topics/yaml/index.html</a><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">remove <span class="string">vim:</span></span><br><span class="line">  pkg.<span class="string">removed:</span></span><br><span class="line">    - <span class="string">name:</span> vim</span><br></pre></td></tr></table></figure></p><ul><li>带有ID和每个函数调用的行都以冒号（:)结束。</li><li>每个函数调用在ID下面缩进两个空格。</li><li>参数作为列表传递给每个函数。</li><li>每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。</li><li>如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。</li><li>如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格</li></ul><p>2、配置<code>sals</code> ,定义环境   <a href="https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md" target="_blank" rel="noopener">参考文档</a><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义环境目录</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">file_roots:</span><br><span class="line">  base:</span><br><span class="line">    - /srv/salt/base</span><br><span class="line">  dev:</span><br><span class="line">    - /srv/salt/dev</span><br><span class="line">  prod:</span><br><span class="line">    - /srv/salt/prod</span><br><span class="line"><span class="comment"># 创建上面定义的目录</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br></pre></td></tr></table></figure></p><p>3、编写第一个<code>sls</code>文件<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在base环境下编写第一个安装apache的sls文件</span></span><br><span class="line">[root@salt-master ~]<span class="comment"># cd /srv/salt/base/</span></span><br><span class="line">[root@salt-master base]<span class="comment"># cat apache.sls </span></span><br><span class="line">apache-<span class="keyword">install</span>:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - <span class="keyword">name</span>: httpd</span><br><span class="line"></span><br><span class="line">apache-service:</span><br><span class="line">  service.running:</span><br><span class="line">    - <span class="keyword">name</span>: httpd</span><br><span class="line">    - <span class="keyword">enable</span>: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在dev环境下编写一个安装ftp的sls文件</span></span><br><span class="line">[root@<span class="keyword">salt</span>-<span class="keyword">master</span> base]<span class="comment"># cd /srv/salt/dev/</span></span><br><span class="line">[root@<span class="keyword">salt</span>-<span class="keyword">master</span> dev]<span class="comment"># cat vsftpd.sls </span></span><br><span class="line">vsftpd-<span class="keyword">install</span>:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - <span class="keyword">name</span>: vsftpd</span><br><span class="line"></span><br><span class="line">vsftpd-service:</span><br><span class="line">  service.running:</span><br><span class="line">    - <span class="keyword">name</span>: vsftpd</span><br><span class="line">    - <span class="keyword">enable</span>: <span class="literal">True</span></span><br></pre></td></tr></table></figure></p><p>4、使用<code>salt</code>命令的<code>state</code>状态模块让<code>minion</code>应用配置<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.sls apache</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 让所有的minion都安装vsftpd（saltenv指定环境）</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.sls vsftpd saltenv=dev</span></span><br></pre></td></tr></table></figure></p><p>5、使用<code>salt</code>的高级状态使不同主机应用不同的配置<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># topfile入口文件只能放在base环境</span></span><br><span class="line">[<span class="meta">root@salt-master ~</span>]<span class="meta"># cat /srv/salt/base/top.sls </span></span><br><span class="line"><span class="keyword">base</span>:</span><br><span class="line">  <span class="string">'salt-minion01'</span>:</span><br><span class="line">    - apache</span><br><span class="line">  <span class="string">'salt-minion03'</span>:</span><br><span class="line">    - apache</span><br><span class="line">dev:</span><br><span class="line">  <span class="string">'salt-minion02'</span>:</span><br><span class="line">    - vsftpd</span><br><span class="line">  <span class="string">'salt-minion03'</span>:</span><br><span class="line">    - vsftpd</span><br></pre></td></tr></table></figure></p><p>6、使用<code>salt</code>命令执行高级状态，会将<code>top.sls</code>当做入口文件，进行调用<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 将高级状态应用到所有主机</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><h2 id="Saltstack常用配置"><a href="#Saltstack常用配置" class="headerlink" title="Saltstack常用配置"></a>Saltstack常用配置</h2><p>1、<strong>Salt Master配置</strong><br><code>Salt Master</code>端的配置文件<code>/etc/salt/master</code>，常用配置如下：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">interface</span>: <span class="comment">//指定bind 的地址(默认为0.0.0.0)</span></span><br><span class="line"><span class="attribute">publish_port</span>: <span class="comment">//指定发布端口(默认为4505)</span></span><br><span class="line"><span class="attribute">ret_port</span>: <span class="comment">//指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)</span></span><br><span class="line"><span class="attribute">user</span>: <span class="comment">//指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)</span></span><br><span class="line"><span class="attribute">timeout</span>: <span class="comment">//指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)</span></span><br><span class="line"><span class="attribute">keep_jobs</span>: <span class="comment">//minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)</span></span><br><span class="line"><span class="attribute">job_cache</span>: <span class="comment">//master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)</span></span><br><span class="line"><span class="attribute">file_recv </span>: <span class="comment">//是否允许minion传送文件到master 上(默认是Flase)</span></span><br><span class="line"><span class="attribute">file_roots</span>: <span class="comment">//指定file server目录,  默认为:</span></span><br><span class="line">    <span class="attribute">file_roots</span>:    </span><br><span class="line">       <span class="attribute">base</span>:    </span><br><span class="line">        - /srv/salt     </span><br><span class="line"><span class="attribute">pillar_roots </span>: <span class="comment">//指定pillar 目录,  默认为:</span></span><br><span class="line">    <span class="attribute">pillar_roots</span>:     </span><br><span class="line">      <span class="attribute">base</span>:     </span><br><span class="line">        - /srv/pillar     </span><br><span class="line"><span class="attribute">log_level</span>: <span class="comment">//日志级别</span></span><br><span class="line">支持的日志级别有<span class="string">'garbage'</span>, <span class="string">'trace'</span>, <span class="string">'debug'</span>, info<span class="string">', '</span>warning<span class="string">', '</span>error', ‘critical ’ ( 默认为’warning’)</span><br></pre></td></tr></table></figure></p><p>2、<code>Salt Minion</code>端的配置文件<code>/etc/salt/minion</code>，常用配置如下：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">master:</span> <span class="comment">//指定master 主机(默认为salt)</span></span><br><span class="line"><span class="string">master_port:</span> <span class="comment">//指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)</span></span><br><span class="line"><span class="string">id:</span> <span class="comment">//指定本minion的标识, salt内部使用id作为标识(默认为主机名)</span></span><br><span class="line"><span class="string">user:</span> <span class="comment">//指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)</span></span><br><span class="line"><span class="string">cache_jobs :</span> <span class="comment">//minion是否缓存执行结果(默认为False)</span></span><br><span class="line"><span class="string">backup_mode:</span> <span class="comment">//在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效</span></span><br><span class="line"><span class="string">providers :</span> <span class="comment">//指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5</span></span><br><span class="line"><span class="string">renderer:</span> <span class="comment">//指定配置管理系统中的渲染器(默认值为:yaml_jinja )</span></span><br><span class="line"><span class="string">file_client :</span> <span class="comment">//指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)</span></span><br><span class="line"><span class="string">loglevel:</span> <span class="comment">//指定日志级别(默认为warning)</span></span><br><span class="line"><span class="string">tcp_keepalive :</span> <span class="comment">//minion 是否与master 保持keepalive 检查, zeromq3(默认为True)</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;saltstack介绍&quot;&gt;&lt;a href=&quot;#saltstack介绍&quot; class=&quot;headerlink&quot; title=&quot;saltstack介绍&quot;&gt;&lt;/a&gt;saltstack介绍&lt;/h2&gt;&lt;div class=&quot;note success&quot;&gt;&lt;p&gt;Salt，,一种
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>linux下解压windows上压缩rar包</title>
    <link href="https://leeyj.coding.me/2019/04/30/linux%E4%B8%8B%E8%A7%A3%E5%8E%8Bwindows%E4%B8%8A%E5%8E%8B%E7%BC%A9rar%E5%8C%85/"/>
    <id>https://leeyj.coding.me/2019/04/30/linux下解压windows上压缩rar包/</id>
    <published>2019-04-30T05:48:55.000Z</published>
    <updated>2019-07-10T01:46:30.039Z</updated>
    
    <content type="html"><![CDATA[<h5 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h5><p><code># wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz</code></p><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># tar xvzf rarlinux-3.8.0.tar.gz</span></span><br><span class="line"><span class="meta"># cd rar</span></span><br><span class="line"><span class="meta"># make </span></span><br><span class="line"><span class="meta"># make install</span></span><br></pre></td></tr></table></figure><h5 id="rar命令语法"><a href="#rar命令语法" class="headerlink" title="rar命令语法"></a>rar命令语法</h5><p>将 /etc 目录压缩为 etc.rar 命令为：\<br><code># rar a etc.rar /etc</code>\<br>将 etc.rar 解压 命令为：\<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">rar</span> <span class="selector-tag">x</span> <span class="selector-tag">etc</span><span class="selector-class">.rar</span></span><br><span class="line"><span class="selector-tag">unrar</span> <span class="selector-tag">-e</span> <span class="selector-tag">etc</span><span class="selector-class">.rar</span></span><br></pre></td></tr></table></figure></p><h5 id="rar帮助手册"><a href="#rar帮助手册" class="headerlink" title="rar帮助手册"></a>rar帮助手册</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># rar</span></span><br><span class="line"></span><br><span class="line">RAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008</span><br><span class="line">Shareware version         Type RAR -? for help</span><br><span class="line"></span><br><span class="line">Usage:     rar <span class="xml"><span class="tag">&lt;<span class="name">command</span>&gt;</span></span> -<span class="xml"><span class="tag">&lt;<span class="name">switch</span> <span class="attr">1</span>&gt;</span></span> -<span class="xml"><span class="tag">&lt;<span class="name">switch</span> <span class="attr">N</span>&gt;</span></span> <span class="xml"><span class="tag">&lt;<span class="name">archive</span>&gt;</span></span> <span class="xml"><span class="tag">&lt;<span class="name">files...</span>&gt;</span></span></span><br><span class="line"><span class="code">               &lt;@listfiles...&gt; &lt;path_to_extract\&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">Commands</span>&gt;</span></span></span><br><span class="line">  a             Add files to archive</span><br><span class="line">  c             Add archive comment</span><br><span class="line">  cf            Add files comment</span><br><span class="line">  ch            Change archive parameters</span><br><span class="line">  cw            Write archive comment to file</span><br><span class="line">  d             Delete files from archive</span><br><span class="line">  e             Extract files to current directory</span><br><span class="line">  f             Freshen files in archive</span><br><span class="line">  i[par]=<span class="xml"><span class="tag">&lt;<span class="name">str</span>&gt;</span></span>  Find string in archives</span><br><span class="line">  k             Lock archive</span><br><span class="line">  l[t,b]        List archive [technical, bare]</span><br><span class="line">  m[f]          Move to archive [files only]</span><br><span class="line">  p             Print file to stdout</span><br><span class="line">  r             Repair archive</span><br><span class="line">  rc            Reconstruct missing volumes</span><br><span class="line">  rn            Rename archived files</span><br><span class="line">  rr[N]         Add data recovery record</span><br><span class="line">  rv[N]         Create recovery volumes</span><br><span class="line">  s[name|-]     Convert archive to or from SFX</span><br><span class="line">  t             Test archive files</span><br><span class="line">  u             Update files in archive</span><br><span class="line">  v[t,b]        Verbosely list archive [technical,bare]</span><br><span class="line">  x             Extract files with full path</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">Switches</span>&gt;</span></span></span><br><span class="line">  -             Stop switches scanning</span><br><span class="line">  ad            Append archive name to destination path</span><br><span class="line">  ag[format]    Generate archive name using the current date</span><br><span class="line">  ap<span class="xml"><span class="tag">&lt;<span class="name">path</span>&gt;</span></span>      Set path inside archive</span><br><span class="line">  as            Synchronize archive contents</span><br><span class="line">  av            Put authenticity verification (registered versions only)</span><br><span class="line">  av-           Disable authenticity verification check</span><br><span class="line">  c-            Disable comments show</span><br><span class="line">  cfg-          Disable read configuration</span><br><span class="line">  cl            Convert names to lower case</span><br><span class="line">  cu            Convert names to upper case</span><br><span class="line">  df            Delete files after archiving</span><br><span class="line">  dh            Open shared files</span><br><span class="line">  ds            Disable name sort for solid archive</span><br><span class="line">  dw            Wipe files after archiving</span><br><span class="line">  e[+]<span class="xml"><span class="tag">&lt;<span class="name">attr</span>&gt;</span></span>    Set file exclude and include attributes</span><br><span class="line">  ed            Do not add empty directories</span><br><span class="line">  en            Do not put 'end of archive' block</span><br><span class="line">  ep            Exclude paths from names</span><br><span class="line">  ep1           Exclude base directory from names</span><br><span class="line">  ep3           Expand paths to full including the drive letter</span><br><span class="line">  f             Freshen files</span><br><span class="line">  hp[password]  Encrypt both file data and headers</span><br><span class="line">  id[c,d,p,q]   Disable messages</span><br><span class="line">  ierr          Send all messages to stderr</span><br><span class="line">  ilog[name]    Log errors to file (registered versions only)</span><br><span class="line">  inul          Disable all messages</span><br><span class="line">  isnd          Enable sound</span><br><span class="line">  k             Lock archive</span><br><span class="line">  kb            Keep broken extracted files</span><br><span class="line">  m<span class="xml"><span class="tag">&lt;<span class="name">0..5</span>&gt;</span></span>       Set compression level (0-store...3-default...5-maximal)</span><br><span class="line">  mc<span class="xml"><span class="tag">&lt;<span class="name">par</span>&gt;</span></span>       Set advanced compression parameters</span><br><span class="line">  md<span class="xml"><span class="tag">&lt;<span class="name">size</span>&gt;</span></span>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)</span><br><span class="line">  ms[ext;ext]   Specify file types to store</span><br><span class="line">  n<span class="xml"><span class="tag">&lt;<span class="name">file</span>&gt;</span></span>       Include only specified file</span><br><span class="line">  n@            Read file names to include from stdin</span><br><span class="line">  n@<span class="xml"><span class="tag">&lt;<span class="name">list</span>&gt;</span></span>      Include files in specified list file</span><br><span class="line">  o[+|-]        Set the overwrite mode</span><br><span class="line">  ol            Save symbolic links as the link instead of the file</span><br><span class="line">  or            Rename files automatically</span><br><span class="line">  ow            Save or restore file owner and group</span><br><span class="line">  p[password]   Set password</span><br><span class="line">  p-            Do not query password</span><br><span class="line">  r             Recurse subdirectories</span><br><span class="line">  r0            Recurse subdirectories for wildcard names only</span><br><span class="line">  rr[N]         Add data recovery record</span><br><span class="line">  rv[N]         Create recovery volumes</span><br><span class="line">  s[<span class="xml"><span class="tag">&lt;<span class="name">N</span>&gt;</span></span>,v[-],e] Create solid archive</span><br><span class="line">  s-            Disable solid archiving</span><br><span class="line">  sc<span class="xml"><span class="tag">&lt;<span class="name">chr</span>&gt;</span></span>[obj]  Specify the character set</span><br><span class="line">  sfx[name]     Create SFX archive</span><br><span class="line">  si[name]      Read data from standard input (stdin)</span><br><span class="line">  sl<span class="xml"><span class="tag">&lt;<span class="name">size</span>&gt;</span></span>      Process files with size less than specified</span><br><span class="line">  sm<span class="xml"><span class="tag">&lt;<span class="name">size</span>&gt;</span></span>      Process files with size more than specified</span><br><span class="line">  t             Test files after archiving</span><br><span class="line">  ta<span class="xml"><span class="tag">&lt;<span class="name">date</span>&gt;</span></span>      Process files modified after <span class="xml"><span class="tag">&lt;<span class="name">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class="line">  tb<span class="xml"><span class="tag">&lt;<span class="name">date</span>&gt;</span></span>      Process files modified before <span class="xml"><span class="tag">&lt;<span class="name">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class="line">  tk            Keep original archive time</span><br><span class="line">  tl            Set archive time to latest file</span><br><span class="line">  tn<span class="xml"><span class="tag">&lt;<span class="name">time</span>&gt;</span></span>      Process files newer than <span class="xml"><span class="tag">&lt;<span class="name">time</span>&gt;</span></span></span><br><span class="line">  to<span class="xml"><span class="tag">&lt;<span class="name">time</span>&gt;</span></span>      Process files older than <span class="xml"><span class="tag">&lt;<span class="name">time</span>&gt;</span></span></span><br><span class="line">  ts<span class="xml"><span class="tag">&lt;<span class="name">m,c,a</span>&gt;</span></span>[N]  Save or restore file time (modification, creation, access)</span><br><span class="line">  u             Update files</span><br><span class="line">  v             Create volumes with size autodetection or list all volumes</span><br><span class="line">  v<span class="xml"><span class="tag">&lt;<span class="name">size</span>&gt;</span></span>[k,b]  Create volumes with size=<span class="xml"><span class="tag">&lt;<span class="name">size</span>&gt;</span></span><span class="emphasis">*1000 [*</span>1024, *1]</span><br><span class="line">  ver[n]        File version control</span><br><span class="line">  vn            Use the old style volume naming scheme</span><br><span class="line">  vp            Pause before each volume</span><br><span class="line">  w<span class="xml"><span class="tag">&lt;<span class="name">path</span>&gt;</span></span>       Assign work directory</span><br><span class="line">  x<span class="xml"><span class="tag">&lt;<span class="name">file</span>&gt;</span></span>       Exclude specified file</span><br><span class="line">  x@            Read file names to exclude from stdin</span><br><span class="line">  x@<span class="xml"><span class="tag">&lt;<span class="name">list</span>&gt;</span></span>      Exclude files in specified list file</span><br><span class="line">  y             Assume Yes on all queries</span><br><span class="line">  z[file]       Read archive comment from file</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h5 id=&quot;下载&quot;&gt;&lt;a href=&quot;#下载&quot; class=&quot;headerlink&quot; title=&quot;下载&quot;&gt;&lt;/a&gt;下载&lt;/h5&gt;&lt;p&gt;&lt;code&gt;# wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz&lt;/code&gt;&lt;/
      
    
    </summary>
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/categories/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/tags/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>phpRedisAdmin搭建</title>
    <link href="https://leeyj.coding.me/2019/04/26/phpRedisAdmin%E6%90%AD%E5%BB%BA/"/>
    <id>https://leeyj.coding.me/2019/04/26/phpRedisAdmin搭建/</id>
    <published>2019-04-26T08:30:09.000Z</published>
    <updated>2019-07-10T01:46:30.056Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在已有的<code>lnmp</code> 环境下搭建 <code>phpRedisAdmin</code> 由于服务器做了限制，隧道端口转发等都不能使用，导致 <code>RedisDesktopManager</code> 管理工具不能使用，只能通过 <code>phpRedisAdmin</code>来进行管理了。</p></blockquote><p>1）下载软件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/ErikDubbelboer/phpRedisAdmin.git</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> phpRedisAdmin</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/nrk/predis.git vendor</span></span><br></pre></td></tr></table></figure></p><p>2）放置到<code>web</code>站点目录<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># cd ..</span></span><br><span class="line"><span class="meta"># mv phpRedisAdmin /opt/</span></span><br><span class="line"><span class="meta"># chown apache.apache phpRedisAdmin/ -R</span></span><br></pre></td></tr></table></figure></p><p>3）编辑<code>nginx</code>配置文件<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim phpRedisAdmin.conf</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  www.redis.com;</span><br><span class="line">    <span class="attribute">autoindex</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">error_log</span>  logs/redis_error.log <span class="literal">error</span>;</span><br><span class="line">    <span class="attribute">access_log</span> logs/redis_access.log main;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> /opt/phpRedisAdmin;</span><br><span class="line">        <span class="attribute">index</span>  index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">fastcgi_intercept_errors</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">error_page</span>  <span class="number">404</span>             /<span class="number">404</span>.html;</span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="attribute">root</span>           html;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span>   <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">        <span class="attribute">fastcgi_index</span>  index.php;</span><br><span class="line">        <span class="attribute">fastcgi_param</span>  SCRIPT_FILENAME  /opt/phpRedisAdmin<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="attribute">include</span>        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /\.</span> &#123;</span><br><span class="line">        <span class="attribute">deny</span> all;</span><br><span class="line">        <span class="attribute">error_page</span>  <span class="number">403</span>             /<span class="number">404</span>.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>4）配置连接管理，默认连接的是<code>6379</code>端口<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /opt/phpRedisAdmin/includes/config.sample.inc.php</span></span><br><span class="line">$config = <span class="keyword">array</span>(</span><br><span class="line">  <span class="string">'servers'</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">    <span class="keyword">array</span>(</span><br><span class="line">      <span class="string">'name'</span>   =&gt; <span class="string">'local server'</span>, <span class="comment">// Optional name.</span></span><br><span class="line">      <span class="string">'host'</span>   =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">      <span class="string">'port'</span>   =&gt; <span class="number">6395</span>,</span><br><span class="line">      <span class="string">'filter'</span> =&gt; <span class="string">'*'</span>,</span><br><span class="line">      <span class="string">'scheme'</span> =&gt; <span class="string">'tcp'</span>, <span class="comment">// Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket</span></span><br><span class="line">      <span class="string">'path'</span>   =&gt; <span class="string">''</span>, <span class="comment">// Optional. Path to unix domain socket. Uses only if 'scheme' =&gt; 'unix'. Example: '/var/run/redis/redis.sock'</span></span><br><span class="line">      <span class="string">'auth'</span> =&gt; <span class="string">'jieg6uy5Dach0yooxo1l'</span> <span class="comment">// Warning: The password is sent in plain-text to the Redis server.</span></span><br><span class="line">    ),</span><br></pre></td></tr></table></figure></p><p>5）<code>windows</code>添加<code>host</code>然后访问 <code>http://www.redis.com</code><br><img src="https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;在已有的&lt;code&gt;lnmp&lt;/code&gt; 环境下搭建 &lt;code&gt;phpRedisAdmin&lt;/code&gt; 由于服务器做了限制，隧道端口转发等都不能使用，导致 &lt;code&gt;RedisDesktopManager&lt;/code&gt; 管理工具不能使用，只
      
    
    </summary>
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/categories/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/tags/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
</feed>
