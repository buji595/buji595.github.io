<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>不羁</title>
  
  <subtitle>别来无恙</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://leeyj.coding.me/"/>
  <updated>2019-10-24T09:19:42.484Z</updated>
  <id>https://leeyj.coding.me/</id>
  
  <author>
    <name>Leeyj</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Kubernetes 系统基础</title>
    <link href="https://leeyj.coding.me/2019/10/24/(%E4%B8%80)Kubernetes%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/"/>
    <id>https://leeyj.coding.me/2019/10/24/(一)Kubernetes系统基础/</id>
    <published>2019-10-24T09:20:22.000Z</published>
    <updated>2019-10-24T09:19:42.484Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Kubernetes介绍"><a href="#Kubernetes介绍" class="headerlink" title="Kubernetes介绍"></a>Kubernetes介绍</h1><h2 id="什么是Kubernetes？"><a href="#什么是Kubernetes？" class="headerlink" title="什么是Kubernetes？"></a>什么是Kubernetes？</h2><blockquote><p><code>Kubernetes</code>是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。</p><p>使用<code>Kubernetes</code>可以：</p><ul><li>自动化容器的部署和复制</li><li>随时扩展或收缩容器规模</li><li>将容器组织成组，并且提供容器间的负载均衡</li><li>很容易地升级应用程序容器的新版本</li><li>节省资源，优化硬件资源的使用</li><li>提供容器弹性，如果容器失效就替换它，等等…</li></ul></blockquote><h2 id="Kubernetes特点"><a href="#Kubernetes特点" class="headerlink" title="Kubernetes特点"></a>Kubernetes特点</h2><blockquote><ul><li><strong>便携性</strong>：支持公有云、私有云、混合云、多重云(multi-cloud)</li><li><strong>可扩展</strong>：模块化、插件化、可组合、可挂载</li><li><strong>自修复</strong>：自动部署，自动重启，自动复制，自动伸缩扩展</li></ul></blockquote><p>##Kubernetes特性</p><blockquote><p>Kubernetes是一种用于在一组主机上运行和协同容器化应用程序的系统，旨在提供可预测性、可扩展性与高可用的性的方法来完全管理容器化应用程序和服务的生命周期的平台。</p><p>它具有以下几个重要的特性：</p><ol><li><strong>自动装箱</strong>：构建于容器之上，基于资源依赖及其他约束自动完成容器部署且不影响其可用性，并通过调度机制混合关键型应用和非关键型应用的工作负载于同一节点以提升资源利用率。</li><li><strong>自我修复</strong>：支持容器故障后自动重启、节点故障候重行调度容器，以及其他可用节点、健康状态检查失败后关闭容器并重新创建等自我修复机制。</li><li><strong>水平扩展</strong>：支持通过简单命令或UI手动水平扩展，以及基于CPU等资源负载率的自动水平扩展机制。</li><li><strong>服务器发现和负载均衡</strong>：Kubernetes通过其附加组件之一的KubeDNS（或CoreDNS）为系统内置了服务发现功能，它会为每个Service配置DNS名称，并允许集群内的客户端直接使用此名称发出访问请求，而Service则通过iptables或ipvs内建了负载均衡机制。</li><li><strong>自动发布和回滚</strong>：Kubernetes支持“灰度”更新应用程序或其配置信息，它会监控更新过程中应用程序的健康状态，以确保它不会在同一时刻杀掉所有的实例，而此过程中一旦有故障发生，就会立即自动执行回滚操作。</li><li><strong>秘钥和配置管理</strong>：Kubernetes允许存储和管理敏感信息，例如密码，Oauth令牌和ssh秘钥。可以部署和更新密码和应用程序配置，而无需重建容器，也不会再堆栈配置中暴露机密。</li><li><strong>存储编排</strong>：Kubernetes支持Pod对象按需自动挂载不同类型的存储系统，这包括节点本地存储、公有云服务商的云存储（如AWS和GCP等），以及网络存储系统（例如，NFS、ISCSI、GlusterFS、Ceph、Cinder和Flocker等）</li><li><strong>批量处理执行</strong>：除了服务型应用，Kubernetes还支持批处理作业及CI（持续集成），如果需要，一样可以实现容器故障后修复。</li></ol></blockquote><h1 id="Kubernetes概述和术语"><a href="#Kubernetes概述和术语" class="headerlink" title="Kubernetes概述和术语"></a>Kubernetes概述和术语</h1><blockquote><p>Kubernetes使用共享网络将多个物理机或虚拟机汇集到一个集群中，在各服务器之间进行通信，该集群是配置Kubernetes的所有组件、功能和工作负载的物理平台。集群中一台服务器（或高可用部署中的一组服务器）用作Master，负责管理整个集群，余下的其他机器用作Worker Node,它们是使用本地和外部资源接收和运行工作负载的服务器。集群中的这些主机可以是物理服务器，也可以是虚拟机（包括IaaS云端的VPS）</p></blockquote><p><img src="/2019/10/24/(一)Kubernetes系统基础/(一" alt>Kubernetes系统基础/kubernetescluster.png)</p><p><strong>Master</strong></p><blockquote><p>Master是集群的网关和中枢，负责诸如为用户和客户端暴露API、跟踪其它服务器的健康状态、以最优方式调度工作负载，以及编排其他组件之间的通信等任务，它是用户或客户端与集群之间的核心联络点，并负责Kubernetes系统的大多数集中式管控逻辑。单个Master节点即可完成其所有的功能，但出于冗余及负载均衡等目的，生产环境中通常需要协同部署多个此类主机。Master节点类似于蜂群中的蜂王。</p></blockquote><p><strong>Node</strong></p><blockquote><p>Node是Kubernetes集群的工作节点，负责接收来自Master的工作指令并根据指令相应的创建或删除Pod对象，以及调整网络规则以合理地路由和转发流量等。理论上讲，Node可以是任何形式的计算设备，不过Master会统一将其抽象为Node对象进行管理。Node类似于蜂群中的工蜂，生产环境中，它们通常数量众多。</p></blockquote><hr><blockquote><p>Kubernetes将所有Node的资源集结于一处形成一台更强大的“服务器”，如下图，在用户将应用部署于其上时，Master会使用调度算法将其自动指派某个特定的Node运行，在Node加入集群或从集群中移除时，Master也会按需重行编排影响到的Pod（容器）。于是，用户无需关心其应用究竟运行于何处。</p></blockquote><p><img src="/2019/10/24/(一)Kubernetes系统基础/(一" alt>Kubernetes系统基础/cluster.png)</p><blockquote><p>从抽象的角度来讲，Kubernetes还有着众多的组件来支撑其内部的业务逻辑，包括运行应用、应用编排、服务暴露、应用恢复等，它们在Kubernetes中被抽象为Pod、Service、Controller等资源类型。</p></blockquote><h2 id="常用的资源对象"><a href="#常用的资源对象" class="headerlink" title="常用的资源对象"></a>常用的资源对象</h2><p><a href="http://www.dockone.io/article/932" target="_blank" rel="noopener">十分钟带你理解Kubernetes核心概念</a></p><p>（1）Pod</p><blockquote><p>Kubernetes并不直接运行容器，而是使用一个抽象的资源对象来封装一个或者多个容器，这个抽象即为Pod，它是Kubernetes的最小调度单元。同一Pod中的容器共享网络名称空间和存储资源，这些容器可经由本地回环接口lo直接通信，但彼此之间又在Mount、User及PID等名称空间上保持了隔离。尽管Pod中可以包含多个容器，但是作为最小调度单元，它应该尽可能地保持“小”，即通常只应该包含一个主容器，以及必要的辅助型容器（sidecar）</p></blockquote><p><img src="/2019/10/24/(一)Kubernetes系统基础/(一" alt>Kubernetes系统基础/pod.png)</p><p>（2）资源标签</p><blockquote><p>标签（Label）是将资源进行分类的标识符，资源标签其实就是一个键值型（key/values）数据。标签旨在指定对象（如Pod等）辨识性的属性，这些属性仅对用户存在特定的意义，对Kubernetes集群来说并不直接表达核心系统语意。标签可以在对象创建时附加其上，并能够在创建后的任意时间进行添加和修改。一个对象可以拥有多个标签，一个标签也可以附加于多个对象（通常是同一类对象）之上。</p></blockquote><p><img src="/2019/10/24/(一)Kubernetes系统基础/(一" alt>Kubernetes系统基础/label.png)</p><p>（3）标签选择器</p><blockquote><p>标签选择器（Selector）全称为”Label Selector“，它是一种根据Label来过滤符合条件的资源对象的机制。例如，将附有标签”role：backend“的所有Pod对象挑选出来归为一组就是标签选择器的一种应用，如下图所示，通常使用标签对资源对象进行分类，而后使用标签选择器挑选出它们，例如将其创建未某Service的端点。</p></blockquote><p><img src="/2019/10/24/(一)Kubernetes系统基础/(一" alt>Kubernetes系统基础/labels.png)</p><p>（4）Pod控制器</p><blockquote><p>尽管Pod是kubernetes的最小调度单元，但用户通常并不会直接部署及管理Pod对象，而是要借助于另一类抽象——控制器（Controller）对其进行管理。用于工作负载的控制器是一种管理Pod生命周期的资源抽象，它们是kubernetes上的一类对象，而非单个资源对象，包括ReplicationController，ReplicaSet、Deployment、StatefulSet、Job等。已下图所示的Deployment控制器为例，它负责确保指定的Pod对象的副本数量精确符合定义，否则“多退少补”。使用控制器之后就不再需要手动管理Pod对象了，只需要声明应用的期望状态，控制器就会自动对其进行进程管理。    </p></blockquote><p><img src="/2019/10/24/(一)Kubernetes系统基础/(一" alt>Kubernetes系统基础/deployment.png)</p><p>（5）服务资源（Service）</p><blockquote><p>Service是建立在一组Pod对象之上的资源抽象，它通过标签选择器选定一组Pod对象，并为这组Pod对象定义一个统一的固定访问入口（通常是一个IP地址），若Kubernetes集群存在DNS附件，它就会在Service创建时为其自动配置一个DNS名称以便客户端进行服务发现。到达Service IP的请求将被负载均衡至其后的端点——各个Pod对象之上，因此Service从本质上来讲是一个四层代理服务。另外，service还可以将集群外部流量引入到集群中来。</p></blockquote><p>（6）存储卷</p><blockquote><p>存储卷（Volume）是独立于容器文件系统之外的存储空间，常用于扩展容器的存储空间并为它提供持久存储能力。Kubernetes集群上的存储卷大体可以分为临时卷、本地卷和网络卷。临时卷和本地卷都位于Node本地，一旦Pod被调度至其他Node，此种类型的存储卷将无法访问到，因此临时卷和本地卷通常用于数据缓存，持久化的数据则需要放置于持久卷（persistent volume）之上。</p></blockquote><p>（7）Name和Namespace</p><blockquote><p>名称（Name）是Kubernetes集群中资源对象的标识符，它们的作用域通常是名称空间（Namespace），因此名称空间是名称的额外的限定机制。在同一名称空间中，同一类型资源对象的名称必须具有唯一性。名称空间通常用于实现租户或项目的资源隔离，从而形成逻辑分组，如下图所示，创建的Pod和Service等资源对象都属于名称空间级别，未指定时，他们都属于默认的名称空间“default”。</p></blockquote><p><img src="/2019/10/24/(一)Kubernetes系统基础/(一" alt>Kubernetes系统基础/namespace.png)</p><p>（8）Annotation</p><blockquote><p>Annotation（注释）是另一种附加在对象之上的键值类型的数据，但它拥有更大的数据容量。Annotation常用于将各种非标识型元数据（metadata）附加到对象上，但它不能用于标识和选择对象，通常也不会被Kubernetes直接使用，其主要目的是方便工具或用户的阅读和查找等。</p></blockquote><p>（9）Ingress</p><blockquote><p>Kubernetes将Pod对象和外部网络环境进行了隔离，Pod和Service等对象间的通信都使用其内部专用地址进行，如若需要开放某些Pod对象提供给外部用户访问，则需要为其请求流量打开一个通往Kubernetes集群内部的通道，除了Service之外，Ingress也是这类通道的实现方式之一。</p></blockquote><h1 id="Kubernetes集群组件"><a href="#Kubernetes集群组件" class="headerlink" title="Kubernetes集群组件"></a>Kubernetes集群组件</h1><p><img src="/2019/10/24/(一)Kubernetes系统基础/(一" alt>Kubernetes系统基础/system.png)</p><h2 id="Master组件"><a href="#Master组件" class="headerlink" title="Master组件"></a>Master组件</h2><blockquote><p>Kubernetes的集群控制平面由多个组件组成，这些组件可统一运行于单一Master节点，也可以以多副本的方式同时运行于多个节点，以为Master提供高可用功能，甚至还可以运行于Kubernetes集群自身之上。Master主要包括以下几个组件。</p></blockquote><p>（1）API Server</p><blockquote><p>Api Server负责输出RESTful风格的Kubernetes API，它是发往集群的所有REST操作命令的接入点，并负责接收、校验并响应所有的REST请求，结果状态被持久存储于etcd中。因此，API Server是整个集群的网关。</p></blockquote><p>（2）ETCD</p><blockquote><p>Kubernetes集群的所有状态信息都需要持久存储于存储系统etcd中，不过，etcd是由CoreOS基于Raft协议开发的分布式键值存储，可用于服务发现、共享配置以及一致性保障（例如数据库主节点选择、分布式锁等）。因此，etcd是独立的服务组件，并不隶属于Kubernetes集群自身。生产环境中应该以etcd集群的方式运行以确保其服务可用性。</p><p>etcd不仅能够提供键值数据存储，而且还为其提供了监听（watch）机制，用于监听和推送变更。Kubernetes集群系统中，etcd中的键值发生变化时会通知到API Server，并由其通过watch API向客户端输出。基于watch机制，Kubernetes集群的各组件实现了高效协同。</p></blockquote><p>（3）Controller Manager</p><blockquote><p>Kubernetes中，集群级别的大多数功能都是由几个被称为控制器的进程执行实现的，这几个进程被集成与kube-controller-manager守护进程中。由控制器完成的功能主要包括生命周期功能和API业务逻辑，具体如下</p><ul><li>生命周期功能：包括Namespace创建和生命周期、Event垃圾回收、Pod终止相关的垃圾回收、级联垃圾回收及Node垃圾回收等。</li><li>API业务逻辑：例如，由ReplicaSet执行的Pod扩展等。</li></ul></blockquote><p>（4）Scheduler</p><blockquote><p>Kubernetes是用于部署和管理大规模容器应用的平台，根据集群规模的不同，其托管运行的容器很可能会数以千计甚至更多。API Server确认Pod对象的创建请求之后，便需要由Scheduler根据集群内各节点的可用资源状态，以及要运行的容器的资源需求做出调度决策，如下图所示。另外，Kubernetes还支持用户自定义调度器。</p></blockquote><p><img src="/2019/10/24/(一)Kubernetes系统基础/(一" alt>Kubernetes系统基础/scheduler.png)</p><h2 id="Node组件"><a href="#Node组件" class="headerlink" title="Node组件"></a>Node组件</h2><blockquote><p>Node负责提供运行容器的各种依赖环境，并接收Master的管理。每个Node主要由以下几个组件构成。</p></blockquote><p>（1）kubelet</p><blockquote><p>kubelet是运行于工作节点之上的守护进程，它从API Server接收关于Pod对象的配置信息并确保它们处于期望的状态（desired state，也可以说目标状态）kubelet会在API Server上注册当前工作节点，定期向Master汇报节点资源使用情况，并通过cAdvisor监控容器和节点的资源占用情况。</p></blockquote><p>（2）kube-proxy</p><blockquote><p>每个工作节点都需要运行一个kube-proxy守护进程，它能够按需为Service资源对象生成iptables或ipvs规则，从而捕获访问当前Service的ClusterIP的流量并将其转发至正确的后端Pod对象。</p></blockquote><p>（3）docker</p><blockquote><p>docker用于运行容器</p></blockquote><h2 id="核心附件"><a href="#核心附件" class="headerlink" title="核心附件"></a>核心附件</h2><blockquote><p>Kubernetes集群还依赖于一组称为”附件”(add-ons)的组件以提供完整的功能，它们通常是由第三方提供的特定应用程序，且托管运行于Kubernetes集群之上，如上图所示。</p></blockquote><ul><li><p>KubeDNS</p><blockquote><p>在Kubernetes集群中调度运行提供DNS服务的Pod，同一集群中的其他pod可使用此DNS服务解决主机名。Kubernetes从1.11版本开始默认使用CoreDNS项目为集群提供服务注册和服务发现的动态名称解析服务，之前的版本中用到的是kube-dns项目，而SKyDNS则是更早一代的项目。</p></blockquote></li><li><p>Kubernetes Dashboard</p><blockquote><p>Kubernetes集群的全部功能都要基于Web的UI，来管理集群中应用甚至是集群自身。</p></blockquote></li><li><p>Heapster</p><blockquote><p>容器和节点的性能监控与分析系统，它收集并解析多种指标数据，如资源利用率、生命周期事件等。新版本的Kubernetes中，其功能会逐渐由Prometheus结合其他组件所取代。</p></blockquote></li><li><p>Ingress Controller</p><blockquote><p>Service是一种工作于传输层的负载均衡器，而Ingress是在应用层实现的HTTP(s)负载均衡机制。不过，Ingress资源自身不能进行“流量穿透”，它仅是一组路由规则的集合，这些规则需要通过Ingress控制器（Ingress Controller）发挥作用。目前，此类的可用项目有Nginx、Traefik、Envoy及HAProxy等。</p></blockquote></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Kubernetes介绍&quot;&gt;&lt;a href=&quot;#Kubernetes介绍&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes介绍&quot;&gt;&lt;/a&gt;Kubernetes介绍&lt;/h1&gt;&lt;h2 id=&quot;什么是Kubernetes？&quot;&gt;&lt;a href=&quot;
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://leeyj.coding.me/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://leeyj.coding.me/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>网络RAID技术DRBD</title>
    <link href="https://leeyj.coding.me/2019/08/08/%E7%BD%91%E7%BB%9CRAID%E6%8A%80%E6%9C%AFDRBD/"/>
    <id>https://leeyj.coding.me/2019/08/08/网络RAID技术DRBD/</id>
    <published>2019-08-08T07:00:35.000Z</published>
    <updated>2019-10-24T09:12:16.899Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DRBD简介"><a href="#DRBD简介" class="headerlink" title="DRBD简介"></a>DRBD简介</h1><p><a href="https://docs.linbit.com/docs/users-guide-8.4/" target="_blank" rel="noopener">官方文档</a></p><blockquote><p>DRBD的全称为：<code>Distributed Replicated Block Device(DRBD)</code>分布式块设备复制，<code>DRBD</code>是由内核模块和相关脚本构成，用以构建高可用的集群。其实现方式是通过网络来镜像整个设备。可以把它看作是一种网络<code>RAID</code>。它允许用户在远程机器上建立一个本地块设备的实时镜像。</p></blockquote><h2 id="DRBD是如何工作的"><a href="#DRBD是如何工作的" class="headerlink" title="DRBD是如何工作的"></a>DRBD是如何工作的</h2><blockquote><p><code>（DRBD Primary）</code>负责接收数据，把数据写到本地磁盘并发送给另一台主机<code>（DRBD Secondary）</code>。另一个主机再将数据存到自己的磁盘中。目前，<code>DRBD</code>每次只允许对一个节点进行读写访问，但这对于通常的故障切换高可用集群来说已经足够用了，有可能以后的版本支持两个节点进行读写存取。<br><code>DRBD</code>协议说明<br>1）数据一旦写入磁盘并发送到网络中就认为完成了写入操作。<br>2）收到接收确认就认为完成了写入操作。<br>3）收到写入确认就认为完成了写入操作。</p></blockquote><h2 id="DRBD与HA的关系"><a href="#DRBD与HA的关系" class="headerlink" title="DRBD与HA的关系"></a>DRBD与HA的关系</h2><blockquote><p>一个<code>DRBD</code>系统由两个节点构成，与<code>HA</code>集群类似，也有主节点和备用节点之分，在带有主要设备的节点上，应用程序和操作系统可以运行和访问<code>DRBD</code>设备<code>（/dev/drbd*）</code>。在主节点写入的数据通过<code>DRBD</code>设备存储到主节点的设备写入到备用节点的磁盘中。现在大部分的高可用性集群都会使用共享存储，而<code>DRBD</code>也可以作为一个共享存储设备，使用<code>DRBD</code>不需要太多的硬件的设备。因为它在<code>TCP/IP</code>网络中运行，所以，利用<code>DRBD</code>作为共享存储设备，节约很多成本，因为价格要比专用的存储网络便宜很多；其性能与稳定性方面也不错。</p></blockquote><h1 id="DRBD工作原理"><a href="#DRBD工作原理" class="headerlink" title="DRBD工作原理"></a>DRBD工作原理</h1><blockquote><p><code>DRBD</code>是<code>linux</code>的内核的存储层中的一个分布式存储系统，可用使用<code>DRBD</code>在两台<code>Linux</code>服务器之间共享块设备，共享文件系统和数据。类似网络<code>RAID-1</code>，其工作的原理架构图如下：</p></blockquote><p><img src="/2019/08/08/网络RAID技术DRBD/01.jpg" alt="image.png"></p><h1 id="DRBD的特性"><a href="#DRBD的特性" class="headerlink" title="DRBD的特性"></a>DRBD的特性</h1><blockquote><p>分布式复制块设备（<code>DRBD</code>技术）是一种基于软件的，无共享，复制的存储解决方案，在服务器之间的对块设备（硬盘、分区、逻辑卷等）进行镜像。<br><code>DRBD</code>镜像数据的特性：<br>1）实时性：当某个应用程序完成对数据的修改时，复制功能立即发生<br>2）透明性：应用程序的数据存储在镜像块设备上是独立透明的，他们的数据在两个节点上都保存一份，因此，无论哪一台服务器宕机，都不会影响应用程序读取数据的操作，所以说是透明的。<br>3）同步镜像和异步镜像：同步镜像表示当应用程序提交本地的写操作后，数据会同步写到两个节点上去；异步镜像表示当应用程序提交写操作后，只有当本地的节点上完成写操作后，另一个节点才可以完成写操作。</p></blockquote><h1 id="DRBD的模式"><a href="#DRBD的模式" class="headerlink" title="DRBD的模式"></a>DRBD的模式</h1><blockquote><p><code>DRBD</code>共有2种模式，一种是<code>DRBD的主从模式</code>，另一种是<code>DRBD的双主模式</code><br><strong>1）DRBD的主从模式：</strong><br>  这种模式下，其中一个节点作为主节点，另一个节点作为从节点。其中主节点可以执行读、写操作；从节点不可以挂载文件系统，因此也不可以执行读写操作。在这种模式下，资源在任何时间只能存储在主节点上。这种模式可用在任何的文件系统（<code>ext3、ext4、xfs</code>）等。默认这种模式下，一旦主节点发生故障，从节点需要手工将资源进行转移，且主节点变成从节点和从节点变成主节点需要手动进行切换。不能自动进行转移，因此比较麻烦。<br>为了解决手动将资源和节点进行转移，可以将<code>DRBD</code>做成高可用集群的资源代理<code>（RA）</code>，这样一旦其中的一个节点宕机，资源就会自动转移到另一个节点，从而保证服务的连续性。<br><strong>2）DRBD的双主模式:</strong><br>这是<code>DRBD8.0</code>之后的新特性，在双主模式下，任何资源在任何特定的时间都存在两个主节点。这种模式需要一个共享的集群文件系统，利用分布式的锁机制进行管理，如<code>GFS</code>和<code>OCFS2</code>。部署双主模式时，<code>DRBD</code>可以是负载均衡的集群，这就需要从两个并发的主节点中选取一个首选的访问数据。这种模式默认是禁用的，如果要是用的话必须在配置文件中进行申明。</p></blockquote><h1 id="DRBD的复制模式"><a href="#DRBD的复制模式" class="headerlink" title="DRBD的复制模式"></a>DRBD的复制模式</h1><blockquote><p><code>DRBD</code>的复制功能就是将应用程序提交的数据一份保存在本地节点，一份复制传输保存在另一份节点上。但是<code>DRBD</code>需要对传输的数据进行确认以便保证另一个节点的写操作完成，就需要用到<code>DRBD</code>的复制模式，<code>DRBD</code>有三种复制模式：</p></blockquote><p><strong>1）协议A：异步复制协议</strong></p><blockquote><p>一旦本地磁盘写入已经完成，数据包已在发送队列中，则写被认为是完成的。在一个节点上发生故障时，可能发生数据丢失，因为被写入到远程节点上的数据可能仍在发送队列。尽管，在故障转移节点上的数据是一致的，但没有及时更新。这通常是用于地理上分开的节点。</p></blockquote><p><strong>2）协议B：内存同步（半同步）复制协议</strong></p><blockquote><p>一旦本地磁盘写入已完成且复制数据包达到了对等节点则认为写在主节点上被认为是完成的。数据丢失可能发生在参加的两个节点同时故障的情况下，因为在传输中的数据可能不会被提交到磁盘。</p></blockquote><p><strong>3）协议C：同步复制协议</strong></p><blockquote><p>只有在本地和远程节点的磁盘已经确认了写操作完成，写才被认为完成。没有任何数据丢失，所以这是一个集群节点的流行模式，但<code>I/O</code>吞吐量依赖于网络带宽。一般使用<code>协议C</code>，但选择<code>C协议</code>将影响流量，从而影响网络延迟。为了数据可靠性，我们在生产环境使用时须慎重选择使用哪一种协议。</p></blockquote><h1 id="DRBD配置文件说明"><a href="#DRBD配置文件说明" class="headerlink" title="DRBD配置文件说明"></a>DRBD配置文件说明</h1><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">DRBD的主配置文件为/etc/drbd.<span class="keyword">conf</span>；为了管理的便捷性，</span><br><span class="line">目前通常会将配置文件分成多个部分，且都保存至/etc/drbd.<span class="keyword">d</span>目录中，主配置文件中仅使用<span class="string">"include"</span>指令将这些配置文件片断整合起来。通常，/etc/drbd.<span class="keyword">d</span>目录中的配置文件</span><br><span class="line">为global_common.<span class="keyword">conf</span>和所有以.res结尾的文件。其中global_common.<span class="keyword">conf</span>中主要定义<span class="keyword">global</span>段和common段，而每一个.res的文件用于定义一个资源。</span><br><span class="line">  </span><br><span class="line">在配置文件中，<span class="keyword">global</span>段仅能出现一次，且如果所有的配置信息都保存至同一个配置文件中而不分开为多个文件的话，<span class="keyword">global</span>段必须位于配置文件的最开始处。目前<span class="keyword">global</span>段中</span><br><span class="line">可以定义的参数仅有minor-<span class="keyword">count</span>, dialog-refresh, disable-ip-verification和usage-<span class="keyword">count</span>。</span><br><span class="line">  </span><br><span class="line">common段则用于定义被每一个资源默认继承的参数，可以在资源定义中使用的参数都可以在common段中定义。实际应用中，common段并非必须，但建议将多个资源共享的参数定</span><br><span class="line">义为common段中的参数以降低配置文件的复杂度。</span><br><span class="line">  </span><br><span class="line">resource段则用于定义DRBD资源，每个资源通常定义在一个单独的位于/etc/drbd.<span class="keyword">d</span>目录中的以.res结尾的文件中。资源在定义时必须为其命名，名字可以由非空白的ASCII字符</span><br><span class="line">组成。每一个资源段的定义中至少要包含两个host子段，以定义此资源关联至的节点，其它参数均可以从common段或DRBD的默认中进行继承而无须定义。</span><br><span class="line">  </span><br><span class="line">DRBD配置文件</span><br><span class="line">[root@drbd1 ~]# <span class="keyword">cat</span> /etc/drbd.<span class="keyword">d</span>/global_common.<span class="keyword">conf</span></span><br><span class="line"><span class="keyword">global</span> &#123;</span><br><span class="line"> usage-<span class="keyword">count</span> yes;         <span class="comment">//是否参加DRBD使用者统计，默认是参加</span></span><br><span class="line"> # minor-<span class="keyword">count</span> dialog-refresh disable-ip-verification  <span class="comment">//这里是global可以使用的参数</span></span><br><span class="line"> #minor-<span class="keyword">count</span>：32         <span class="comment">//从（设备）个数，取值范围1~255，默认值为32。该选项设定了允许定义的resource个数，当要定义的resource超过了此选项的设定时，需要重新载入DRBD内核模块。</span></span><br><span class="line"> #disable-ip-verification：<span class="keyword">no</span>   <span class="comment">//是否禁用ip检查</span></span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line">common &#123;</span><br><span class="line"> protocol C;      <span class="comment">//指定复制协议,复制协议共有三种，为协议A，B，C，默认协议为协议C</span></span><br><span class="line"> handlers &#123;       <span class="comment">//该配置段用来定义一系列处理器，用来回应特定事件。</span></span><br><span class="line">  # These are EXAMPLE handlers only.</span><br><span class="line">  # They may have severe implications,</span><br><span class="line">  # like hard resetting the node under certain circumstances.</span><br><span class="line">  # Be careful when chosing your poison.</span><br><span class="line">  # pri-<span class="keyword">on</span>-incon-degr <span class="string">"/usr/lib/DRBD/notify-pri-on-incon-degr.sh; /usr/lib/DRBD/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f"</span>;</span><br><span class="line">  # pri-lost-after-sb <span class="string">"/usr/lib/DRBD/notify-pri-lost-after-sb.sh; /usr/lib/DRBD/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f"</span>;</span><br><span class="line">  # <span class="keyword">local</span>-io-<span class="keyword">error</span> <span class="string">"/usr/lib/DRBD/notify-io-error.sh; /usr/lib/DRBD/notify-emergency-shutdown.sh; echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">  # fence-peer <span class="string">"/usr/lib/DRBD/crm-fence-peer.sh"</span>;</span><br><span class="line">  # <span class="keyword">split</span>-brain <span class="string">"/usr/lib/DRBD/notify-split-brain.sh root"</span>;</span><br><span class="line">  # <span class="keyword">out</span>-of-sync <span class="string">"/usr/lib/DRBD/notify-out-of-sync.sh root"</span>;</span><br><span class="line">  # before-resync-target <span class="string">"/usr/lib/DRBD/snapshot-resync-target-lvm.sh -p 15 -- -c 16k"</span>;</span><br><span class="line">  # after-resync-target /usr/lib/DRBD/unsnapshot-resync-target-lvm.<span class="keyword">sh</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> startup &#123;    <span class="comment">//#DRBD同步时使用的验证方式和密码。该配置段用来更加精细地调节DRBD属性，它作用于配置节点在启动或重启时。常用选项有：</span></span><br><span class="line">  # wfc-timeout degr-wfc-timeout outdated-wfc-timeout wait-after-sb</span><br><span class="line">  wfc-timeout：  <span class="comment">//该选项设定一个时间值，单位是秒。在启用DRBD块时，初始化脚本DRBD会阻塞启动进程的运行，直到对等节点的出现。该选项就是用来限制这个等待时间的，默认为0，即不限制，永远等待。</span></span><br><span class="line">  degr-wfc-timeout：  <span class="comment">//该选项也设定一个时间值，单位为秒。也是用于限制等待时间，只是作用的情形不同：它作用于一个降级集群（即那些只剩下一个节点的集群）在重启时的等待时间。</span></span><br><span class="line">  outdated-wfc-timeout：  <span class="comment">//同上，也是用来设定等待时间，单位为秒。它用于设定等待过期节点的时间</span></span><br><span class="line"> &#125;</span><br><span class="line"> disk &#123;</span><br><span class="line">  # <span class="keyword">on</span>-io-<span class="keyword">error</span> fencing <span class="keyword">use</span>-bmbv <span class="keyword">no</span>-disk-barrier <span class="keyword">no</span>-disk-flushes   <span class="comment">//这里是disk段内可以定义的参数</span></span><br><span class="line">  # <span class="keyword">no</span>-disk-drain <span class="keyword">no</span>-md-flushes max-bio-bvecs                      <span class="comment">//这里是disk段内可以定义的参数</span></span><br><span class="line">  <span class="keyword">on</span>-io-<span class="keyword">error</span>： detach      <span class="comment">//选项：此选项设定了一个策略，如果底层设备向上层设备报告发生I/O错误，将按照该策略进行处理。有效的策略包括：</span></span><br><span class="line">    detach      <span class="comment">//发生I/O错误的节点将放弃底层设备，以diskless mode继续工作。在diskless mode下，只要还有网络连接，DRBD将从secondary node读写数据，而不需要failover（故障转移）。该策略会导致一定的损失，但好处也很明显，DRBD服务不会中断。官方推荐和默认策略。</span></span><br><span class="line">    pass_on       <span class="comment">//把I/O错误报告给上层设备。如果错误发生在primary节点，把它报告给文件系统，由上层设备处理这些错误（例如，它会导致文件系统以只读方式重新挂载），它可能会导致DRBD停止提供服务；如果发生在secondary节点，则忽略该错误（因为secondary节点没有上层设备可以报告）。该策略曾经是默认策略，但现在已被detach所取代。</span></span><br><span class="line">    call-<span class="keyword">local</span>-io-<span class="keyword">error</span>   <span class="comment">//调用预定义的本地local-io-error脚本进行处理。该策略需要在resource（或common）配置段的handlers部分，预定义一个相应的local-io-error命令调用。该策略完全由管理员通过local-io-error命令（或脚本）调用来控制如何处理I/O错误。</span></span><br><span class="line">  fencing：               <span class="comment">//该选项设定一个策略来避免split brain的状况。有效的策略包括：</span></span><br><span class="line">    dont-care：  <span class="comment">//默认策略。不采取任何隔离措施。</span></span><br><span class="line">    resource-only：   <span class="comment">//在此策略下，如果一个节点处于split brain状态，它将尝试隔离对端节点的磁盘。这个操作通过调用fence-peer处理器来实现。fence-peer处理器将通过其它通信路径到达对等节点，并在这个对等节点上调用DRBDadm outdate res命令</span></span><br><span class="line">    resource-and-stonith：   <span class="comment">//在此策略下，如果一个节点处于split brain状态，它将停止I/O操作，并调用fence-peer处理器。处理器通过其它通信路径到达对等节点，并在这个对等节点上调用DRBDadm outdate res命令。如果无法到达对等节点，它将向对等端发送关机命令。一旦问题解决，I/O操作将重新进行。如果处理器失败，你可以使用resume-io命令来重新开始I/O操作。</span></span><br><span class="line">    </span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">net</span> &#123;        <span class="comment">//该配置段用来精细地调节DRBD的属性，网络相关的属性。常用的选项有：</span></span><br><span class="line">  # sndbuf-size rcvbuf-size timeout connect-int ping-int ping-timeout max-buffers     <span class="comment">//这里是net段内可以定义的参数</span></span><br><span class="line">  # max-epoch-size ko-<span class="keyword">count</span> allow-<span class="keyword">two</span>-primaries cram-hmac-alg shared-secret      <span class="comment">//这里是net段内可以定义的参数</span></span><br><span class="line">  # after-sb-0pri after-sb-1pri after-sb-2pri data-integrity-alg <span class="keyword">no</span>-tcp-cork      <span class="comment">//这里是net段内可以定义的参数</span></span><br><span class="line">  sndbuf-size：     <span class="comment">//该选项用来调节TCP send buffer的大小，DRBD 8.2.7以前的版本，默认值为0，意味着自动调节大小；新版本的DRBD的默认值为128KiB。高吞吐量的网络（例如专用的千兆网卡，或负载均衡中绑定的连接）中，增加到512K比较合适，或者可以更高，但是最好不要超过2M。</span></span><br><span class="line">  timeout：        <span class="comment">//该选项设定一个时间值，单位为0.1秒。如果搭档节点没有在此时间内发来应答包，那么就认为搭档节点已经死亡，因此将断开这次TCP/IP连接。默认值为60，即6秒。该选项的值必须小于connect-int和ping-int的值。</span></span><br><span class="line">  connect-int：     <span class="comment">//如果无法立即连接上远程DRBD设备，系统将断续尝试连接。该选项设定的就是两次尝试间隔时间。单位为秒，默认值为10秒。</span></span><br><span class="line">  ping-timeout：    <span class="comment">//该选项设定一个时间值，单位是0.1秒。如果对端节点没有在此时间内应答keep-alive包，它将被认为已经死亡。默认值是500ms。</span></span><br><span class="line">  max-buffers：     <span class="comment">//该选项设定一个由DRBD分配的最大请求数，单位是页面大小（PAGE_SIZE），大多数系统中，页面大小为4KB。这些buffer用来存储那些即将写入磁盘的数据。最小值为32（即128KB）。这个值大一点好。</span></span><br><span class="line">  max-epoch-size：    <span class="comment">//该选项设定了两次write barriers之间最大的数据块数。如果选项的值小于10，将影响系统性能。大一点好</span></span><br><span class="line">  ko-<span class="keyword">count</span>：     <span class="comment">//该选项设定一个值，把该选项设定的值 乘以 timeout设定的值，得到一个数字N，如果secondary节点没有在此时间内完成单次写请求，它将从集群中被移除（即，primary node进入StandAlong模式）。取值范围0~200，默认值为0，即禁用该功能。</span></span><br><span class="line">  allow-<span class="keyword">two</span>-primaries：   <span class="comment">//这个是DRBD8.0及以后版本才支持的新特性，允许一个集群中有两个primary node。该模式需要特定文件系统的支撑，目前只有OCFS2和GFS可以，传统的ext3、ext4、xfs等都不行！</span></span><br><span class="line">  cram-hmac-alg：    <span class="comment">//该选项可以用来指定HMAC算法来启用对端节点授权。DRBD强烈建议启用对端点授权机制。可以指定/proc/crypto文件中识别的任一算法。必须在此指定算法，以明确启用对端节点授权机制，实现数据加密传输。</span></span><br><span class="line">  shared-secret：    <span class="comment">//该选项用来设定在对端节点授权中使用的密码，最长64个字符。</span></span><br><span class="line">  data-integrity-alg：   <span class="comment">//该选项设定内核支持的一个算法，用于网络上的用户数据的一致性校验。通常的数据一致性校验，由TCP/IP头中所包含的16位校验和来进行，而该选项可以使用内核所支持的任一算法。该功能默认关闭。</span></span><br><span class="line"> &#125;</span><br><span class="line"> syncer &#123;       <span class="comment">//该配置段用来更加精细地调节服务的同步进程。常用选项有</span></span><br><span class="line">  # rate after al-extents <span class="keyword">use</span>-rle cpu-mask verify-alg csums-alg</span><br><span class="line">  rate：    <span class="comment">//设置同步时的速率，默认为250KB。默认的单位是KB/sec，也允许使用K、M和G，如40M。注意：syncer中的速率是以bytes，而不是bits来设定的。配置文件中的这个选项设置的速率是永久性的，但可使用下列命令临时地改变rate的值：DRBDsetup /dev/DRBDN syncer -r 100M。如果想重新恢复成drbd.conf配置文件中设定的速率，执行如下命令： DRBDadm adjust resource</span></span><br><span class="line">  verify-alg：    <span class="comment">//该选项指定一个用于在线校验的算法，内核一般都会支持md5、sha1和crc32c校验算法。在线校验默认关闭，必须在此选项设定参数，以明确启用在线设备校验。DRBD支持在线设备校验，它以一种高效的方式对不同节点的数据进行一致性校验。在线校验会影响CPU负载和使用，但影响比较轻微。DRBD 8.2.5及以后版本支持此功能。一旦启用了该功能，你就可以使用下列命令进行一个在线校验： DRBDadm verify resource。该命令对指定的resource进行检验，如果检测到有数据块没有同步，它会标记这些块，并往内核日志中写入一条信息。这个过程不会影响正在使用该设备的程序。</span></span><br><span class="line">                    如果检测到未同步的块，当检验结束后，你就可以如下命令重新同步它们：DRBDadm disconnect resource   or   DRBDadm connetc resource</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">common段是用来定义共享的资源参数，以减少资源定义的重复性。common段是非必须的。resource段一般为DRBD上每一个节点来定义其资源参数的。</span><br><span class="line">资源配置文件详解 </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">[root@drbd1 ~]# <span class="keyword">cat</span> /etc/drbd.<span class="keyword">d</span>/web.res</span><br><span class="line">resource web &#123;       <span class="comment">//web为资源名称</span></span><br><span class="line"> <span class="keyword">on</span> ha1.xsl.com &#123;                       <span class="comment">//on后面为节点的名称,有几个节点就有几个on段，这里是定义节点ha1.xsl.com上的资源</span></span><br><span class="line">  device   /dev/DRBD0;       <span class="comment">//定义DRBD虚拟块设备，这个设备事先不要格式化。</span></span><br><span class="line">  disk /dev/sda6;        <span class="comment">//定义存储磁盘为/dev/sda6,该分区创建完成之后就行了，不要进行格式化操作</span></span><br><span class="line">  address 192.168.108.199:7789;      <span class="comment">//定义DRBD监听的地址和端口，以便和对端进行通信</span></span><br><span class="line">  meta-disk  internal;       <span class="comment">//该参数有2个选项：internal和externally，其中internal表示将元数据和数据存储在同一个磁盘上；而externally表示将元数据和数据分开存储，元数据被放在另一个磁盘上。</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">on</span> ha2.xsl.com &#123;        <span class="comment">//这里是定义节点ha2.xsl.com上的资源</span></span><br><span class="line">  device /dev/DRBD0;</span><br><span class="line">  disk /dev/sda6;</span><br><span class="line">  address 192.168.108.201:7789;</span><br><span class="line">  meta-disk internal;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="DRBD安装配置（主从模式）"><a href="#DRBD安装配置（主从模式）" class="headerlink" title="DRBD安装配置（主从模式）"></a>DRBD安装配置（主从模式）</h1><p><strong>环境说明</strong></p><blockquote><p>这里使用所用环境为<code>centos7.4</code>操作系统<br>在下面的操作步骤中<code># command</code>的命令表示主从节点服务器都需要执行。</p></blockquote><table><thead><tr><th>IP</th><th>主机名</th><th>角色说明</th></tr></thead><tbody><tr><td>192.168.1.31</td><td>drbd1.cluster.com</td><td>主服务器</td></tr><tr><td>192.168.1.32</td><td>drbd2.cluster.com</td><td>从服务器</td></tr></tbody></table><h2 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h2><p>1）两台机器上添加<code>DRBD</code>磁盘，进行分区，不做格式化，并在本地系统创建<code>/data</code>目录，不做挂载操作<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">在drbd1服务器上操作</span><br><span class="line">[root@drbd1 ~]# lsblk </span><br><span class="line">......</span><br><span class="line">sdb               8:16   0   10G  0 disk</span><br><span class="line">[root@drbd1 ~]# fdisk /dev/sdb</span><br><span class="line">依次输入"n-&gt;p-&gt;1-&gt;回车-&gt;回车-w"</span><br><span class="line"></span><br><span class="line">在drbd2服务器上操作</span><br><span class="line">[root@drbd2 ~]# lsblk </span><br><span class="line">......</span><br><span class="line">sdb               8:16   0   10G  0 disk</span><br><span class="line">[root@drbd2 ~]# fdisk /dev/sdb</span><br><span class="line">依次输入"n-&gt;p-&gt;1-&gt;回车-&gt;回车-w"</span><br></pre></td></tr></table></figure></p><p>2）两台服务器之间的防火墙要允许互相访问，这里测试关闭<code>selinux</code>和防火墙(两台服务器同样操作)<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># systemctl stop firewalld</span></span><br><span class="line"><span class="meta"># setenforce 0     //临时性关闭；永久关闭需修改/etc/sysconfig/selinux的SELINUX为disable</span></span><br></pre></td></tr></table></figure></p><p>3）<code>hosts</code>绑定（两台服务器同样操作）<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/hosts</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span>    drbd1.cluster.com</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span>    drbd2.cluster.com</span><br></pre></td></tr></table></figure></p><p>4）两台服务器进行时间同步（两台服务器同样操作）<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># yum -y install ntpdate</span></span><br><span class="line"><span class="meta"># ntpdate -u asia.pool.ntp.org</span></span><br></pre></td></tr></table></figure></p><p>5）<code>DRBD</code>安装配置（两台服务器同样操作）<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">这里使用yum方式安装</span><br><span class="line"><span class="meta"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span><br><span class="line"><span class="meta"># yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span></span><br><span class="line"><span class="meta"># yum -y install kmod-drbd84 drbd86-utils </span></span><br><span class="line"></span><br><span class="line">因为在执行yum -y install kmod-drbd84 drbd86-utils时，对内核kernel进行了update，要重新启动服务器，更新后的内核才会生效。</span><br><span class="line">加载模块：</span><br><span class="line"><span class="meta"># reboot</span></span><br><span class="line"><span class="meta"># modprobe drbd</span></span><br><span class="line">查看模块是否已添加上</span><br><span class="line"><span class="meta"># lsmod |grep drbd</span></span><br><span class="line">drbd                  <span class="number">397041</span>  <span class="number">0</span> </span><br><span class="line">libcrc32c              <span class="number">12644</span>  <span class="number">4</span> xfs,drbd,nf_nat,nf_conntrack</span><br></pre></td></tr></table></figure></p><p>6）<code>DRBD</code>配置（两台服务器上同样操作）<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/drbd.conf     //主配置文件</span></span><br><span class="line"><span class="comment"># You can find an example in  /usr/share/doc/drbd.../drbd.conf.example</span></span><br><span class="line"></span><br><span class="line">include <span class="string">"drbd.d/global_common.conf"</span>;</span><br><span class="line">include <span class="string">"drbd.d/*.res"</span>;</span><br><span class="line"></span><br><span class="line">备份配置文件</span><br><span class="line"><span class="comment"># cp /etc/drbd.d/global_common.conf&#123;,.bak&#125; </span></span><br><span class="line"><span class="comment"># vim /etc/drbd.d/global_common.conf    //全局配置文件</span></span><br><span class="line">global &#123;</span><br><span class="line">usage-count <span class="literal">no</span>;     #是否参加DRBD使用统计，默认为<span class="literal">yes</span>。官方统计drbd的装机量</span><br><span class="line">&#125;</span><br><span class="line">common &#123;</span><br><span class="line">    protocol C;    #使用DRBD的同步协议</span><br><span class="line">handlers &#123;</span><br><span class="line">&#125;</span><br><span class="line">startup &#123;</span><br><span class="line">&#125;</span><br><span class="line">options &#123;</span><br><span class="line">&#125;</span><br><span class="line">disk &#123;</span><br><span class="line">                on-io-<span class="builtin-name">error</span> detach;    #配置I/O错误处理策略为分离</span><br><span class="line">&#125;</span><br><span class="line">net &#123;</span><br><span class="line">&#125;</span><br><span class="line">    syncer &#123;</span><br><span class="line">                rate 30M;     #设置主备节点同步时的网络速率</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># vim /etc/drbd.d/r0.res    #创建资源</span></span><br><span class="line">resource r0 &#123;</span><br><span class="line">    on drbd1.cluster.com &#123;</span><br><span class="line">        device    /dev/drbd0;    #drbd1服务器上的DRBD虚拟块设备，事先不要格式化</span><br><span class="line">        disk      /dev/sdb1;</span><br><span class="line">       <span class="built_in"> address </span>  192.168.1.31:7789;    #DRBD监听的地址和端口，端口可以自定义。</span><br><span class="line">        meta-disk internal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    on drbd2.cluster.com &#123;</span><br><span class="line">        device    /dev/drbd0;    #drbd2服务器上的DRBD虚拟块设备，事先不要格式化</span><br><span class="line">        disk      /dev/sdb1;</span><br><span class="line">       <span class="built_in"> address </span>  192.168.1.32:7789;</span><br><span class="line">        meta-disk internal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>7）在两台服务器上分别启用<code>r0</code>资源（两台服务器上同样操作）<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">drbdadm</span> <span class="selector-tag">create-md</span> <span class="selector-tag">r0</span></span><br><span class="line"><span class="selector-tag">initializing</span> <span class="selector-tag">activity</span> <span class="selector-tag">log</span></span><br><span class="line"><span class="selector-tag">initializing</span> <span class="selector-tag">bitmap</span> (<span class="number">320</span> KB) <span class="selector-tag">to</span> <span class="keyword">all</span> <span class="selector-tag">zero</span></span><br><span class="line"><span class="selector-tag">Writing</span> <span class="selector-tag">meta</span> <span class="selector-tag">data</span>...</span><br><span class="line"><span class="selector-tag">New</span> <span class="selector-tag">drbd</span> <span class="selector-tag">meta</span> <span class="selector-tag">data</span> <span class="selector-tag">block</span> <span class="selector-tag">successfully</span> <span class="selector-tag">created</span>.</span><br><span class="line"></span><br><span class="line"># 启动<span class="selector-tag">drbd</span>(注意：需要两边服务器同时启动方能生效)</span><br><span class="line"><span class="selector-attr">[root@drbd1 ~]</span># <span class="selector-tag">systemctl</span> <span class="selector-tag">start</span> <span class="selector-tag">drbd</span></span><br><span class="line"><span class="selector-attr">[root@drbd2 ~]</span># <span class="selector-tag">systemctl</span> <span class="selector-tag">start</span> <span class="selector-tag">drbd</span></span><br><span class="line"></span><br><span class="line"># 查看状态（两台机器上都执行查看）</span><br><span class="line"># <span class="selector-tag">cat</span> /<span class="selector-tag">proc</span>/<span class="selector-tag">drbd</span></span><br><span class="line"><span class="selector-tag">version</span>: <span class="selector-tag">8</span><span class="selector-class">.4</span><span class="selector-class">.11-1</span> (<span class="attribute">api</span>:<span class="number">1</span>/<span class="attribute">proto</span>:<span class="number">86</span>-<span class="number">101</span>)</span><br><span class="line"><span class="selector-tag">GIT-hash</span>: <span class="selector-tag">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class="selector-tag">build</span> <span class="selector-tag">by</span> <span class="selector-tag">mockbuild</span>@, <span class="selector-tag">2018-11-03</span> <span class="selector-tag">01</span><span class="selector-pseudo">:26</span><span class="selector-pseudo">:55</span></span><br><span class="line"> <span class="selector-tag">0</span>: <span class="selector-tag">cs</span><span class="selector-pseudo">:Connected</span> <span class="selector-tag">ro</span><span class="selector-pseudo">:Secondary</span>/<span class="selector-tag">Secondary</span> <span class="selector-tag">ds</span><span class="selector-pseudo">:Inconsistent</span>/<span class="selector-tag">Inconsistent</span> <span class="selector-tag">C</span> <span class="selector-tag">r-----</span></span><br><span class="line">    <span class="selector-tag">ns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">nr</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dw</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dr</span><span class="selector-pseudo">:0</span> <span class="selector-tag">al</span><span class="selector-pseudo">:8</span> <span class="selector-tag">bm</span><span class="selector-pseudo">:0</span> <span class="selector-tag">lo</span><span class="selector-pseudo">:0</span> <span class="selector-tag">pe</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ua</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ap</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ep</span><span class="selector-pseudo">:1</span> <span class="selector-tag">wo</span><span class="selector-pseudo">:f</span> <span class="selector-tag">oos</span><span class="selector-pseudo">:10484380</span></span><br><span class="line"></span><br><span class="line">#由上面两台主机的<span class="selector-tag">DRBD</span>状态查看结果里的<span class="selector-tag">ro</span><span class="selector-pseudo">:Secondary</span>/<span class="selector-tag">Secondary</span>表示两台主机的状态都是备机状态，<span class="selector-tag">ds</span>是磁盘状态，</span><br></pre></td></tr></table></figure></p><p>8）将<code>drbd1</code>服务器配置为<code>DRBD</code>的主节点，进行初始化设备同步<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@drbd1</span> <span class="string">~]#</span> <span class="string">drbdsetup</span> <span class="string">/dev/drbd0</span> <span class="string">primary</span> <span class="bullet">--force</span></span><br><span class="line"><span class="string">[root@drbd1</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/proc/drbd</span> </span><br><span class="line"><span class="attr">version:</span> <span class="number">8.4</span><span class="number">.11</span><span class="bullet">-1</span> <span class="string">(api:1/proto:86-101)</span></span><br><span class="line"><span class="attr">GIT-hash:</span> <span class="number">66145</span><span class="string">a308421e9c124ec391a7848ac20203bb03c</span> <span class="string">build</span> <span class="string">by</span> <span class="string">mockbuild@,</span> <span class="number">2018</span><span class="bullet">-11</span><span class="bullet">-03</span> <span class="number">01</span><span class="string">:26:55</span></span><br><span class="line"> <span class="number">0</span><span class="string">:</span> <span class="attr">cs:SyncSource</span> <span class="attr">ro:Primary/Secondary</span> <span class="attr">ds:UpToDate/Inconsistent</span> <span class="string">C</span> <span class="string">r-----</span></span><br><span class="line"><span class="attr">    ns:</span><span class="number">2418688</span> <span class="attr">nr:0</span> <span class="attr">dw:0</span> <span class="attr">dr:2420808</span> <span class="attr">al:8</span> <span class="attr">bm:0</span> <span class="attr">lo:0</span> <span class="attr">pe:1</span> <span class="attr">ua:0</span> <span class="attr">ap:0</span> <span class="attr">ep:1</span> <span class="attr">wo:f</span> <span class="attr">oos:8066716</span></span><br><span class="line"><span class="string">[===&gt;................]</span> <span class="string">sync'ed:</span> <span class="number">23.1</span><span class="string">%</span> <span class="string">(7876/10236)M</span></span><br><span class="line"><span class="attr">finish:</span> <span class="number">0</span><span class="string">:03:08</span> <span class="attr">speed:</span> <span class="number">42</span><span class="string">,792</span> <span class="string">(37,776)</span> <span class="string">K/sec</span></span><br><span class="line"><span class="comment">###同步完成时状态如下</span></span><br><span class="line"><span class="string">[root@drbd1</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/proc/drbd</span>     <span class="comment">#drbd1上查看</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">8.4</span><span class="number">.11</span><span class="bullet">-1</span> <span class="string">(api:1/proto:86-101)</span></span><br><span class="line"><span class="attr">GIT-hash:</span> <span class="number">66145</span><span class="string">a308421e9c124ec391a7848ac20203bb03c</span> <span class="string">build</span> <span class="string">by</span> <span class="string">mockbuild@,</span> <span class="number">2018</span><span class="bullet">-11</span><span class="bullet">-03</span> <span class="number">01</span><span class="string">:26:55</span></span><br><span class="line"> <span class="number">0</span><span class="string">:</span> <span class="attr">cs:Connected</span> <span class="attr">ro:Primary/Secondary</span> <span class="attr">ds:UpToDate/UpToDate</span> <span class="string">C</span> <span class="string">r-----</span></span><br><span class="line"><span class="attr">    ns:</span><span class="number">10484380</span> <span class="attr">nr:0</span> <span class="attr">dw:0</span> <span class="attr">dr:10486500</span> <span class="attr">al:8</span> <span class="attr">bm:0</span> <span class="attr">lo:0</span> <span class="attr">pe:0</span> <span class="attr">ua:0</span> <span class="attr">ap:0</span> <span class="attr">ep:1</span> <span class="attr">wo:f</span> <span class="attr">oos:0</span></span><br><span class="line"><span class="string">[root@drbd2</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/proc/drbd</span>     <span class="comment">#drbd2上查看</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">8.4</span><span class="number">.11</span><span class="bullet">-1</span> <span class="string">(api:1/proto:86-101)</span></span><br><span class="line"><span class="attr">GIT-hash:</span> <span class="number">66145</span><span class="string">a308421e9c124ec391a7848ac20203bb03c</span> <span class="string">build</span> <span class="string">by</span> <span class="string">mockbuild@,</span> <span class="number">2018</span><span class="bullet">-11</span><span class="bullet">-03</span> <span class="number">01</span><span class="string">:26:55</span></span><br><span class="line"> <span class="number">0</span><span class="string">:</span> <span class="attr">cs:Connected</span> <span class="attr">ro:Secondary/Primary</span> <span class="attr">ds:UpToDate/UpToDate</span> <span class="string">C</span> <span class="string">r-----</span></span><br><span class="line"><span class="attr">    ns:</span><span class="number">0</span> <span class="attr">nr:10484380</span> <span class="attr">dw:10484380</span> <span class="attr">dr:0</span> <span class="attr">al:8</span> <span class="attr">bm:0</span> <span class="attr">lo:0</span> <span class="attr">pe:0</span> <span class="attr">ua:0</span> <span class="attr">ap:0</span> <span class="attr">ep:1</span> <span class="attr">wo:f</span> <span class="attr">oos:0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#说明：</span></span><br><span class="line"><span class="string">ro在主从服务器上分别显示</span> <span class="string">Primary/Secondary和Secondary/Primary</span></span><br><span class="line"><span class="string">ds显示UpToDate/UpToDate</span> <span class="string">表示主从配置成功</span></span><br></pre></td></tr></table></figure></p><p>9）挂载<code>DRBD</code>（<code>drbd1</code>主节点服务器上操作）<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#先格式化/dev/drbd0</span><br><span class="line">[root@drbd1 ~]# mkfs.ext4 /dev/drbd0</span><br><span class="line"></span><br><span class="line">#创建挂载目录，然后进行挂载</span><br><span class="line">[root@drbd1 ~]# mkdir /data</span><br><span class="line">[root@drbd1 ~]# mount /dev/drbd0 /data</span><br><span class="line">[root@drbd1 ~]# df -h</span><br><span class="line">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class="line">/dev/mapper/centos-root   <span class="number">20</span>G  <span class="number">3.7</span>G   <span class="number">16</span>G   <span class="number">20</span>% /</span><br><span class="line">devtmpfs                 <span class="number">471</span>M     <span class="number">0</span>  <span class="number">471</span>M    <span class="number">0</span>% /dev</span><br><span class="line">tmpfs                    <span class="number">487</span>M     <span class="number">0</span>  <span class="number">487</span>M    <span class="number">0</span>% /dev/shm</span><br><span class="line">tmpfs                    <span class="number">487</span>M  <span class="number">7.1</span>M  <span class="number">480</span>M    <span class="number">2</span>% /run</span><br><span class="line">tmpfs                    <span class="number">487</span>M     <span class="number">0</span>  <span class="number">487</span>M    <span class="number">0</span>% /sys/fs/cgroup</span><br><span class="line">/dev/sda1                <span class="number">497</span>M  <span class="number">193</span>M  <span class="number">305</span>M   <span class="number">39</span>% /boot</span><br><span class="line">tmpfs                     <span class="number">98</span>M     <span class="number">0</span>   <span class="number">98</span>M    <span class="number">0</span>% /run/user/<span class="number">0</span></span><br><span class="line">/dev/drbd0               <span class="number">9.8</span>G   <span class="number">37</span>M  <span class="number">9.2</span>G    <span class="number">1</span>% /data</span><br><span class="line"></span><br><span class="line">特别注意：</span><br><span class="line">从节点(Secondary)上不允许对DRBD设备进行任何操作，包括只读，所有的读写操作只能在主节点(Primary)上进行。</span><br><span class="line">只有当主节点(Primary)挂掉时，从节点(Secondary)才能提示为主节点(Primary)。</span><br></pre></td></tr></table></figure></p><h2 id="DRBD主备故障切换测试"><a href="#DRBD主备故障切换测试" class="headerlink" title="DRBD主备故障切换测试"></a>DRBD主备故障切换测试</h2><blockquote><p>模拟主节点(<code>drbd1.cluster.com</code>）发生故障，从节点（<code>drbd2.cluster.com</code>）接管并提升为主节点。</p></blockquote><p>1）主节点上操作<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 创建测试文件并取消挂载</span><br><span class="line"><span class="selector-attr">[root@drbd1 ~]</span># <span class="selector-tag">cd</span> /<span class="selector-tag">data</span>/</span><br><span class="line"><span class="selector-attr">[root@drbd1 data]</span># <span class="selector-tag">touch</span> <span class="selector-tag">test01</span> <span class="selector-tag">test02</span> <span class="selector-tag">test03</span></span><br><span class="line"><span class="selector-attr">[root@drbd1 data]</span># <span class="selector-tag">cd</span> </span><br><span class="line"><span class="selector-attr">[root@drbd1 ~]</span># <span class="selector-tag">umount</span> /<span class="selector-tag">data</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@drbd1 ~]</span># <span class="selector-tag">drbdsetup</span> /<span class="selector-tag">dev</span>/<span class="selector-tag">drbd0</span> <span class="selector-tag">secondary</span>        <span class="comment">//将主节点设置为DRBD的备节点。在实际生产环境中，直接在(Secondary）节点上提权（即设置为主节点）即可。</span></span><br><span class="line"><span class="selector-attr">[root@drbd1 ~]</span># <span class="selector-tag">cat</span> /<span class="selector-tag">proc</span>/<span class="selector-tag">drbd</span> </span><br><span class="line"><span class="selector-tag">version</span>: <span class="selector-tag">8</span><span class="selector-class">.4</span><span class="selector-class">.11-1</span> (<span class="attribute">api</span>:<span class="number">1</span>/<span class="attribute">proto</span>:<span class="number">86</span>-<span class="number">101</span>)</span><br><span class="line"><span class="selector-tag">GIT-hash</span>: <span class="selector-tag">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class="selector-tag">build</span> <span class="selector-tag">by</span> <span class="selector-tag">mockbuild</span>@, <span class="selector-tag">2018-11-03</span> <span class="selector-tag">01</span><span class="selector-pseudo">:26</span><span class="selector-pseudo">:55</span></span><br><span class="line"> <span class="selector-tag">0</span>: <span class="selector-tag">cs</span><span class="selector-pseudo">:Connected</span> <span class="selector-tag">ro</span><span class="selector-pseudo">:Secondary</span>/<span class="selector-tag">Secondary</span> <span class="selector-tag">ds</span><span class="selector-pseudo">:UpToDate</span>/<span class="selector-tag">UpToDate</span> <span class="selector-tag">C</span> <span class="selector-tag">r-----</span></span><br><span class="line">    <span class="selector-tag">ns</span><span class="selector-pseudo">:10783808</span> <span class="selector-tag">nr</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dw</span><span class="selector-pseudo">:299428</span> <span class="selector-tag">dr</span><span class="selector-pseudo">:10488701</span> <span class="selector-tag">al</span><span class="selector-pseudo">:82</span> <span class="selector-tag">bm</span><span class="selector-pseudo">:0</span> <span class="selector-tag">lo</span><span class="selector-pseudo">:0</span> <span class="selector-tag">pe</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ua</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ap</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ep</span><span class="selector-pseudo">:1</span> <span class="selector-tag">wo</span><span class="selector-pseudo">:f</span> <span class="selector-tag">oos</span><span class="selector-pseudo">:0</span></span><br><span class="line"></span><br><span class="line">注意：这里实际生产环境若<span class="selector-tag">Primary</span>主节点宕机，在<span class="selector-tag">Secondary</span>状态信息中<span class="selector-tag">ro</span>的值会显示为<span class="selector-tag">Secondary</span>/<span class="selector-tag">Unknown</span>,只需要进行<span class="selector-tag">DRBD</span>提权操作即可。</span><br></pre></td></tr></table></figure></p><p>2）备节点上操作<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@drbd2 ~]</span># <span class="selector-tag">drbdsetup</span> /<span class="selector-tag">dev</span>/<span class="selector-tag">drbd0</span> <span class="selector-tag">primary</span></span><br><span class="line"><span class="selector-attr">[root@drbd2 ~]</span># <span class="selector-tag">cat</span> /<span class="selector-tag">proc</span>/<span class="selector-tag">drbd</span> </span><br><span class="line"><span class="selector-tag">version</span>: <span class="selector-tag">8</span><span class="selector-class">.4</span><span class="selector-class">.11-1</span> (<span class="attribute">api</span>:<span class="number">1</span>/<span class="attribute">proto</span>:<span class="number">86</span>-<span class="number">101</span>)</span><br><span class="line"><span class="selector-tag">GIT-hash</span>: <span class="selector-tag">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class="selector-tag">build</span> <span class="selector-tag">by</span> <span class="selector-tag">mockbuild</span>@, <span class="selector-tag">2018-11-03</span> <span class="selector-tag">01</span><span class="selector-pseudo">:26</span><span class="selector-pseudo">:55</span></span><br><span class="line"> <span class="selector-tag">0</span>: <span class="selector-tag">cs</span><span class="selector-pseudo">:Connected</span> <span class="selector-tag">ro</span><span class="selector-pseudo">:Primary</span>/<span class="selector-tag">Secondary</span> <span class="selector-tag">ds</span><span class="selector-pseudo">:UpToDate</span>/<span class="selector-tag">UpToDate</span> <span class="selector-tag">C</span> <span class="selector-tag">r-----</span></span><br><span class="line">    <span class="selector-tag">ns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">nr</span><span class="selector-pseudo">:10783808</span> <span class="selector-tag">dw</span><span class="selector-pseudo">:10783808</span> <span class="selector-tag">dr</span><span class="selector-pseudo">:2120</span> <span class="selector-tag">al</span><span class="selector-pseudo">:8</span> <span class="selector-tag">bm</span><span class="selector-pseudo">:0</span> <span class="selector-tag">lo</span><span class="selector-pseudo">:0</span> <span class="selector-tag">pe</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ua</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ap</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ep</span><span class="selector-pseudo">:1</span> <span class="selector-tag">wo</span><span class="selector-pseudo">:f</span> <span class="selector-tag">oos</span><span class="selector-pseudo">:0</span></span><br><span class="line"></span><br><span class="line">#挂载验证数据</span><br><span class="line"><span class="selector-attr">[root@drbd2 ~]</span># <span class="selector-tag">mkdir</span> /<span class="selector-tag">data</span></span><br><span class="line"><span class="selector-attr">[root@drbd2 ~]</span># <span class="selector-tag">mount</span> /<span class="selector-tag">dev</span>/<span class="selector-tag">drbd0</span> /<span class="selector-tag">data</span></span><br><span class="line"><span class="selector-attr">[root@drbd2 ~]</span># <span class="selector-tag">df</span> <span class="selector-tag">-h</span></span><br><span class="line">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class="line">/<span class="selector-tag">dev</span>/<span class="selector-tag">mapper</span>/<span class="selector-tag">centos-root</span>   <span class="selector-tag">20G</span>  <span class="selector-tag">3</span><span class="selector-class">.7G</span>   <span class="selector-tag">16G</span>   <span class="selector-tag">20%</span> /</span><br><span class="line"><span class="selector-tag">devtmpfs</span>                 <span class="selector-tag">471M</span>     <span class="selector-tag">0</span>  <span class="selector-tag">471M</span>    <span class="selector-tag">0%</span> /<span class="selector-tag">dev</span></span><br><span class="line"><span class="selector-tag">tmpfs</span>                    <span class="selector-tag">487M</span>     <span class="selector-tag">0</span>  <span class="selector-tag">487M</span>    <span class="selector-tag">0%</span> /<span class="selector-tag">dev</span>/<span class="selector-tag">shm</span></span><br><span class="line"><span class="selector-tag">tmpfs</span>                    <span class="selector-tag">487M</span>  <span class="selector-tag">7</span><span class="selector-class">.1M</span>  <span class="selector-tag">480M</span>    <span class="selector-tag">2%</span> /<span class="selector-tag">run</span></span><br><span class="line"><span class="selector-tag">tmpfs</span>                    <span class="selector-tag">487M</span>     <span class="selector-tag">0</span>  <span class="selector-tag">487M</span>    <span class="selector-tag">0%</span> /<span class="selector-tag">sys</span>/<span class="selector-tag">fs</span>/<span class="selector-tag">cgroup</span></span><br><span class="line">/<span class="selector-tag">dev</span>/<span class="selector-tag">sda1</span>                <span class="selector-tag">497M</span>  <span class="selector-tag">193M</span>  <span class="selector-tag">305M</span>   <span class="selector-tag">39%</span> /<span class="selector-tag">boot</span></span><br><span class="line"><span class="selector-tag">tmpfs</span>                     <span class="selector-tag">98M</span>     <span class="selector-tag">0</span>   <span class="selector-tag">98M</span>    <span class="selector-tag">0%</span> /<span class="selector-tag">run</span>/<span class="selector-tag">user</span>/<span class="selector-tag">0</span></span><br><span class="line">/<span class="selector-tag">dev</span>/<span class="selector-tag">drbd0</span>               <span class="selector-tag">9</span><span class="selector-class">.8G</span>   <span class="selector-tag">37M</span>  <span class="selector-tag">9</span><span class="selector-class">.2G</span>    <span class="selector-tag">1%</span> /<span class="selector-tag">data</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@drbd2 ~]</span># <span class="selector-tag">cd</span> /<span class="selector-tag">data</span>/</span><br><span class="line"><span class="selector-attr">[root@drbd2 data]</span># <span class="selector-tag">ls</span></span><br><span class="line"><span class="selector-tag">test01</span>  <span class="selector-tag">test02</span>  <span class="selector-tag">test03</span></span><br></pre></td></tr></table></figure></p><p>到此，<code>DRBD</code>的主从环境的部署工作已经完成。不过上面是记录的是主备手动切换，至于保证<code>DRBD</code>主从结构的智能切换，实现高可用，还需里用到<code>Keepalived</code>或<code>Heartbeat</code>来实现了（会在<code>DRBD</code>主端挂掉的情况下，自动切换从端为主端并自动挂载<code>/data</code>分区）</p><h1 id="相关配置操作"><a href="#相关配置操作" class="headerlink" title="相关配置操作"></a>相关配置操作</h1><h2 id="资源的连接状态详细介绍"><a href="#资源的连接状态详细介绍" class="headerlink" title="资源的连接状态详细介绍"></a>资源的连接状态详细介绍</h2><p>如何查看资源连接状态？<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@drbd1</span> ~]<span class="meta"># drbdadm cstate r0    #r0为资源名称</span></span><br><span class="line">Connected</span><br></pre></td></tr></table></figure></p><p>资源的连接状态；一个资源可能有一下连接状态的一种<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">StandAlone 独立的：网络配置不可用；资源还没有被连接或是被管理断开（使用 drbdadm <span class="keyword">disconnect </span>命令），或是由于出现认证失败或是脑裂的情况 </span><br><span class="line"><span class="keyword">Disconnecting </span>断开：断开只是临时状态，下一个状态是StandAlone独立的 modprobe drbd</span><br><span class="line">Unconnected 悬空：是尝试连接前的临时状态，可能下一个状态为WFconnection和WFReportParams </span><br><span class="line">Timeout 超时：与对等节点连接超时，也是临时状态，下一个状态为Unconected悬空 </span><br><span class="line"><span class="keyword">BrokerPipe：与对等节点连接丢失，也是临时状态，下一个状态为Unconected悬空 </span></span><br><span class="line">NetworkFailure：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空 </span><br><span class="line">ProtocolError：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空 </span><br><span class="line">TearDown 拆解：临时状态，对等节点关闭，下一个状态为Unconected悬空 </span><br><span class="line">WFConnection：等待和对等节点建立网络连接 </span><br><span class="line">WFReportParams：已经建立TCP连接，本节点等待从对等节点传来的第一个网络包 </span><br><span class="line">Connected 连接：DRBD已经建立连接，数据镜像现在可用，节点处于正常状态 </span><br><span class="line">StartingSyncS：完全同步，有管理员发起的刚刚开始同步，未来可能的状态为<span class="keyword">SyncSource或PausedSyncS </span></span><br><span class="line">StartingSyncT：完全同步，有管理员发起的刚刚开始同步，下一状态为WFSyncUUID </span><br><span class="line">WFBitMapS：部分同步刚刚开始，下一步可能的状态为<span class="keyword">SyncSource或PausedSyncS </span></span><br><span class="line">WFBitMapT：部分同步刚刚开始，下一步可能的状态为WFSyncUUID </span><br><span class="line">WFSyncUUID：同步即将开始，下一步可能的状态为<span class="keyword">SyncTarget或PausedSyncT </span></span><br><span class="line"><span class="keyword">SyncSource：以本节点为同步源的同步正在进行 </span></span><br><span class="line"><span class="keyword">SyncTarget：以本节点为同步目标的同步正在进行 </span></span><br><span class="line"><span class="keyword">PausedSyncS：以本地节点是一个持续同步的源，但是目前同步已经暂停，可能是因为另外一个同步正在进行或是使用命令(drbdadm </span><span class="keyword">pause-sync)暂停了同步 </span></span><br><span class="line"><span class="keyword">PausedSyncT：以本地节点为持续同步的目标，但是目前同步已经暂停，这可以是因为另外一个同步正在进行或是使用命令(drbdadm </span><span class="keyword">pause-sync)暂停了同步 </span></span><br><span class="line">VerifyS：以本地节点为验证源的线上设备验证正在执行 </span><br><span class="line">VerifyT：以本地节点为验证目标的线上设备验证正在执行</span><br></pre></td></tr></table></figure></p><h2 id="资源角色"><a href="#资源角色" class="headerlink" title="资源角色"></a>资源角色</h2><p>查看资源角色命令<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@drbd1 ~]</span># <span class="selector-tag">drbdadm</span> <span class="selector-tag">role</span> <span class="selector-tag">r0</span></span><br><span class="line"><span class="selector-tag">Secondary</span>/<span class="selector-tag">Primary</span></span><br><span class="line"><span class="selector-attr">[root@drbd1 ~]</span># <span class="selector-tag">cat</span> /<span class="selector-tag">proc</span>/<span class="selector-tag">drbd</span> </span><br><span class="line"><span class="selector-tag">version</span>: <span class="selector-tag">8</span><span class="selector-class">.4</span><span class="selector-class">.11-1</span> (<span class="attribute">api</span>:<span class="number">1</span>/<span class="attribute">proto</span>:<span class="number">86</span>-<span class="number">101</span>)</span><br><span class="line"><span class="selector-tag">GIT-hash</span>: <span class="selector-tag">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class="selector-tag">build</span> <span class="selector-tag">by</span> <span class="selector-tag">mockbuild</span>@, <span class="selector-tag">2018-11-03</span> <span class="selector-tag">01</span><span class="selector-pseudo">:26</span><span class="selector-pseudo">:55</span></span><br><span class="line"> <span class="selector-tag">0</span>: <span class="selector-tag">cs</span><span class="selector-pseudo">:Connected</span> <span class="selector-tag">ro</span><span class="selector-pseudo">:Secondary</span>/<span class="selector-tag">Primary</span> <span class="selector-tag">ds</span><span class="selector-pseudo">:UpToDate</span>/<span class="selector-tag">UpToDate</span> <span class="selector-tag">C</span> <span class="selector-tag">r-----</span></span><br><span class="line">    <span class="selector-tag">ns</span><span class="selector-pseudo">:10783808</span> <span class="selector-tag">nr</span><span class="selector-pseudo">:24</span> <span class="selector-tag">dw</span><span class="selector-pseudo">:299452</span> <span class="selector-tag">dr</span><span class="selector-pseudo">:10488701</span> <span class="selector-tag">al</span><span class="selector-pseudo">:82</span> <span class="selector-tag">bm</span><span class="selector-pseudo">:0</span> <span class="selector-tag">lo</span><span class="selector-pseudo">:0</span> <span class="selector-tag">pe</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ua</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ap</span><span class="selector-pseudo">:0</span> <span class="selector-tag">ep</span><span class="selector-pseudo">:1</span> <span class="selector-tag">wo</span><span class="selector-pseudo">:f</span> <span class="selector-tag">oos</span><span class="selector-pseudo">:0</span></span><br><span class="line"></span><br><span class="line">注释：</span><br><span class="line"><span class="selector-tag">Parimary</span> 主：资源目前为主，并且可能正在被读取或写入，如果不是双主只会出现在两个节点中的其中一个节点上 </span><br><span class="line"><span class="selector-tag">Secondary</span> 次：资源目前为次，正常接收对等节点的更新 </span><br><span class="line"><span class="selector-tag">Unknown</span> 未知：资源角色目前未知，本地的资源不会出现这种状态</span><br></pre></td></tr></table></figure></p><h2 id="硬盘数据状态"><a href="#硬盘数据状态" class="headerlink" title="硬盘数据状态"></a>硬盘数据状态</h2><p>查看硬盘状态命令<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@drbd1</span> ~]<span class="meta"># drbdadm dstate r0</span></span><br><span class="line">UpToDate/UpToDate</span><br></pre></td></tr></table></figure></p><p>本地和对等节点的硬盘有可能为下列状态之一：<br><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Diskless 无盘：本地没有块设备分配给DRBD使用，这表示没有可用的设备，或者使用drbdadm命令手工分离或是底层的<span class="keyword">I</span>/<span class="keyword">O</span>错误导致自动分离 </span><br><span class="line">Attaching：读取无数据时候的瞬间状态 </span><br><span class="line">Failed 失败：本地块设备报告<span class="keyword">I</span>/<span class="keyword">O</span>错误的下一个状态，其下一个状态为Diskless无盘 </span><br><span class="line">Negotiating：在已经连接的DRBD设置进行Attach读取无数据前的瞬间状态 </span><br><span class="line">Inconsistent：数据是不一致的，在两个节点上（初始的完全同步前）这种状态出现后立即创建一个新的资源。此外，在同步期间（同步目标）在一个节点上出现这种状态 </span><br><span class="line">Outdated：数据资源是一致的，但是已经过时 </span><br><span class="line">DUnknown：当对等节点网络连接不可用时出现这种状态 </span><br><span class="line">Consistent：一个没有连接的节点数据一致，当建立连接时，它决定数据是UpToDate或是Outdated </span><br><span class="line">UpToDate：一致的最新的数据状态，这个状态为正常状态</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;DRBD简介&quot;&gt;&lt;a href=&quot;#DRBD简介&quot; class=&quot;headerlink&quot; title=&quot;DRBD简介&quot;&gt;&lt;/a&gt;DRBD简介&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://docs.linbit.com/docs/users-guide-8.4/
      
    
    </summary>
    
      <category term="Storage" scheme="https://leeyj.coding.me/categories/Storage/"/>
    
    
      <category term="Storage" scheme="https://leeyj.coding.me/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>存储服务之NFS</title>
    <link href="https://leeyj.coding.me/2019/08/08/%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1%E4%B9%8BNFS/"/>
    <id>https://leeyj.coding.me/2019/08/08/存储服务之NFS/</id>
    <published>2019-08-08T07:00:35.000Z</published>
    <updated>2019-10-24T09:12:16.897Z</updated>
    
    <content type="html"><![CDATA[<h2 id="NFS介绍"><a href="#NFS介绍" class="headerlink" title="NFS介绍"></a>NFS介绍</h2><p><a href="http://nfs.sourceforge.net/nfs-howto/" target="_blank" rel="noopener">官方文档</a></p><blockquote><p><code>NFS（Network File System）</code>即网络文件系统，它最大的功能就是通过<code>TCP/IP</code>网络共享资源。在<code>NFS</code>的应用中，本地<code>NFS</code>的客户端应用可以透明地读写位于远端<code>NFS</code>服务器上的文件，就像访问本地文件一样。</p></blockquote><blockquote><p><code>NFS</code>客户端一般是应用服务器（比如<code>web</code>，负载均衡等），可以通过挂载的方式将<code>NFS</code>服务器端共享的目录挂载到<code>NFS</code>客户端本地的目录下。</p></blockquote><blockquote><p>因为<code>NFS</code>支持的功能相当的多，而不同的功能都会使用不同的程序来启动，每启动一个功能就会启用一些端口来传输数据，因此，<code>NFS</code>的功能所对应的端口才没有固定住，而是随机取用一些未被使用的小于<code>1024</code>的端口来作为传输之用。但如此一来又造成了客户端想要连上服务器时的困扰，因为客户端得要知道服务器端的相关端口才能够进行连接。</p></blockquote><blockquote><p>因此就需要远程过程调用<code>(RPC)</code>的服务，<code>RPC</code>最主要的功能就是在指定每个<code>NFS</code>功能所对应的<code>port number</code>，并且回报给客户端，让客户端可以连接正确的端口上去。那<code>RPC</code>又是如何知道每个<code>NFS</code>的端口呢？这是因为当服务器在启动<code>NFS</code>时会随机取用数个端口，并主动的想<code>RPC</code>注册，因此<code>RPC</code>可以知道每个端口对应的<code>NFS</code>功能，然后<code>RPC</code>又是固定使用<code>port 111</code>来监听客户端的需求并回报给客户端正确的端口，所以当然可以让<code>NFS</code>的启动更为轻松愉快了。</p></blockquote><blockquote><p><code>NFS</code>在文件传送过程中依赖与<code>RPC</code>（远程过程调用）协议。<code>NFS</code>本身是没有提供信息传送的协议和功能的，但是能够用过网络进行图片，视频，附件等分享功能。只要用到NFS的地方都需要启动<code>RPC</code>服务，不论是<code>NFS</code>的服务端还是客户端。</p></blockquote><blockquote><p><code>NFS</code>和<code>RPC</code>的关系：可以理解为<code>NFS</code>是一个网络文件系统（比喻为租房的房主），而<code>RPC</code>是负责信息的传输（中介），客户端（相当于租房的租客）。</p></blockquote><h3 id="NFS网络文件系统存在的意义"><a href="#NFS网络文件系统存在的意义" class="headerlink" title="NFS网络文件系统存在的意义"></a>NFS网络文件系统存在的意义</h3><p>实现数据共享，数据保持一致。如图所示：<br><img src="/2019/08/08/存储服务之NFS/01.png" alt="image.png"></p><h3 id="NFS网络文件系统工作方式"><a href="#NFS网络文件系统工作方式" class="headerlink" title="NFS网络文件系统工作方式"></a>NFS网络文件系统工作方式</h3><blockquote><p>1、在<code>nfs</code>服务器端创建共享目录<br>2、通过<code>mount</code>网络挂载，将<code>NFS</code>服务端共享目录挂载到<code>NFS</code>客户端本地目录<br>3、<code>NFS</code>客户端在挂载目录上创建、删除、查看数据等操作，等价于在服务端进行的创建、删除、查看数据等操作。</p></blockquote><p><img src="/2019/08/08/存储服务之NFS/02.png" alt="01.png"><br>如上图所示，在<code>NFS</code>服务器端设置一个共享目录<code>/web</code>后，其他有权限访问<code>NFS</code>服务器端的客户端都可以将这个共享目录<code>/web</code>挂载到客户端本地的某个挂载点（其实就是一个目录，这个挂载点可以自己随意指定），不同的客户端的挂载点可以不相同。<br>客户端正确挂载完毕后，就可以通过<code>NFS</code>客户端的挂载点所在的<code>/opt/www</code>目录查看到<code>NFS</code>服务端<code>/web</code>共享出来的目录下的所有数据。在客户端查看时，<code>NFS</code>服务端的<code>/web</code>目录就相当于客户端本地的磁盘分区或目录，几乎感觉不到使用上的区别，根据<code>NFS</code>服务器端授予的<code>NFS</code>共享权限以及共享目录的本地系统权限，只要在指定的<code>NFS</code>客户端操作挂载的<code>/opt/www</code>目录，就可以将数据轻松的存取到<code>NFS</code>服务器端上的<code>/web</code>目录中了。</p><h3 id="NFS工作流程"><a href="#NFS工作流程" class="headerlink" title="NFS工作流程"></a>NFS工作流程</h3><p><img src="/2019/08/08/存储服务之NFS/03.png" alt="02.png"></p><h3 id="RPC服务工作原理"><a href="#RPC服务工作原理" class="headerlink" title="RPC服务工作原理"></a>RPC服务工作原理</h3><p><img src="/2019/08/08/存储服务之NFS/04.png" alt="image.png"></p><h2 id="NFS部署示例"><a href="#NFS部署示例" class="headerlink" title="NFS部署示例"></a>NFS部署示例</h2><h3 id="环境规划"><a href="#环境规划" class="headerlink" title="环境规划"></a>环境规划</h3><table><thead><tr><th>操作系统</th><th>角色</th><th>IP</th><th>HOST</th></tr></thead><tbody><tr><td>CentOS release 7.4</td><td>NFS Server</td><td>192.168.1.31</td><td>nfs-server.com</td></tr><tr><td>CentOS release 7.4</td><td>NFS Client1 (web server1)</td><td>192.168.1.32</td><td>nfs-client1.com</td></tr><tr><td>CentOS release 7.4</td><td>NFS Client2 (web server2)</td><td>192.168.1.33</td><td>nfs-client2.com</td></tr></tbody></table><blockquote><p>这里<code>NFS</code>客户端是<code>web</code>服务器，站点目录挂载<code>NFS</code>服务端。<br>实验环境关闭防火墙、selinux、时间同步等</p></blockquote><h3 id="具体操作步骤"><a href="#具体操作步骤" class="headerlink" title="具体操作步骤"></a>具体操作步骤</h3><p><strong>服务端安装配置</strong><br>1）检查是否安装<code>NFS、RPC</code>服务<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs-server ~]# rpm -aq |egrep <span class="string">"nfs-utils|rpcbind"</span></span><br><span class="line">rpcbind<span class="number">-0.2</span><span class="number">.0</span><span class="number">-42.</span>el7.x86_64</span><br><span class="line">nfs-utils<span class="number">-1.3</span><span class="number">.0</span><span class="number">-0.48</span>.el7.x86_64</span><br><span class="line"></span><br><span class="line"># 如果没有安装则进行安装</span><br><span class="line"># yum -y install nfs-utils rpcbind</span><br></pre></td></tr></table></figure></p><p>2）启动<code>rpc</code>和<code>nfs</code>服务<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nfs</span>-server ~]<span class="meta"># systemctl start rpcbind</span></span><br><span class="line">[root<span class="symbol">@nfs</span>-server ~]<span class="meta"># systemctl enable rpcbind</span></span><br><span class="line">[root<span class="symbol">@nfs</span>-server ~]<span class="meta"># systemctl start nfs</span></span><br></pre></td></tr></table></figure></p><p>3）可以通过<code>rpcinfo -p localhost</code>可以查看到绑定了<code>nfs</code><br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs-server ~]<span class="comment"># rpcinfo -p localhost</span></span><br><span class="line">   program vers proto   port  service</span><br><span class="line">   <span class="number"> 100000 </span>  <span class="number"> 4 </span>  tcp   <span class="number"> 111 </span> portmapper</span><br><span class="line">   <span class="number"> 100000 </span>  <span class="number"> 3 </span>  tcp   <span class="number"> 111 </span> portmapper</span><br><span class="line">   <span class="number"> 100000 </span>  <span class="number"> 2 </span>  tcp   <span class="number"> 111 </span> portmapper</span><br><span class="line">   <span class="number"> 100000 </span>  <span class="number"> 4 </span>  udp   <span class="number"> 111 </span> portmapper</span><br><span class="line">   <span class="number"> 100000 </span>  <span class="number"> 3 </span>  udp   <span class="number"> 111 </span> portmapper</span><br><span class="line">   <span class="number"> 100000 </span>  <span class="number"> 2 </span>  udp   <span class="number"> 111 </span> portmapper</span><br><span class="line">   <span class="number"> 100005 </span>  <span class="number"> 1 </span>  udp <span class="number"> 20048 </span> mountd</span><br><span class="line">   <span class="number"> 100005 </span>  <span class="number"> 1 </span>  tcp <span class="number"> 20048 </span> mountd</span><br><span class="line">   <span class="number"> 100005 </span>  <span class="number"> 2 </span>  udp <span class="number"> 20048 </span> mountd</span><br><span class="line">   <span class="number"> 100005 </span>  <span class="number"> 2 </span>  tcp <span class="number"> 20048 </span> mountd</span><br><span class="line">   <span class="number"> 100005 </span>  <span class="number"> 3 </span>  udp <span class="number"> 20048 </span> mountd</span><br><span class="line">   <span class="number"> 100005 </span>  <span class="number"> 3 </span>  tcp <span class="number"> 20048 </span> mountd</span><br><span class="line">   <span class="number"> 100024 </span>  <span class="number"> 1 </span>  udp <span class="number"> 60358 </span> status</span><br><span class="line">   <span class="number"> 100024 </span>  <span class="number"> 1 </span>  tcp <span class="number"> 34912 </span> status</span><br><span class="line">   <span class="number"> 100003 </span>  <span class="number"> 3 </span>  tcp  <span class="number"> 2049 </span> nfs</span><br><span class="line">   <span class="number"> 100003 </span>  <span class="number"> 4 </span>  tcp  <span class="number"> 2049 </span> nfs</span><br><span class="line">   <span class="number"> 100227 </span>  <span class="number"> 3 </span>  tcp  <span class="number"> 2049 </span> nfs_acl</span><br><span class="line">   <span class="number"> 100003 </span>  <span class="number"> 3 </span>  udp  <span class="number"> 2049 </span> nfs</span><br><span class="line">   <span class="number"> 100003 </span>  <span class="number"> 4 </span>  udp  <span class="number"> 2049 </span> nfs</span><br><span class="line">   <span class="number"> 100227 </span>  <span class="number"> 3 </span>  udp  <span class="number"> 2049 </span> nfs_acl</span><br><span class="line">   <span class="number"> 100021 </span>  <span class="number"> 1 </span>  udp <span class="number"> 38577 </span> nlockmgr</span><br><span class="line">   <span class="number"> 100021 </span>  <span class="number"> 3 </span>  udp <span class="number"> 38577 </span> nlockmgr</span><br><span class="line">   <span class="number"> 100021 </span>  <span class="number"> 4 </span>  udp <span class="number"> 38577 </span> nlockmgr</span><br><span class="line">   <span class="number"> 100021 </span>  <span class="number"> 1 </span>  tcp <span class="number"> 42193 </span> nlockmgr</span><br><span class="line">   <span class="number"> 100021 </span>  <span class="number"> 3 </span>  tcp <span class="number"> 42193 </span> nlockmgr</span><br><span class="line">   <span class="number"> 100021 </span>  <span class="number"> 4 </span>  tcp <span class="number"> 42193 </span> nlockmgr</span><br></pre></td></tr></table></figure></p><p>4）配置共享目录并重启<code>nfs</code><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nfs</span>-server ~]<span class="meta"># mkdir /web</span></span><br><span class="line">[root<span class="symbol">@nfs</span>-server ~]<span class="meta"># vim /etc/exports</span></span><br><span class="line">/web    <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>(rw,sync,no_root_squash)  <span class="meta">#不压制root(当client端使用root挂载时，也有root权限)</span></span><br><span class="line">[root<span class="symbol">@nfs</span>-server ~]<span class="meta"># systemctl restart nfs</span></span><br><span class="line">[root<span class="symbol">@nfs</span>-server ~]<span class="meta"># exportfs -v</span></span><br><span class="line">/web          <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)</span><br></pre></td></tr></table></figure></p><p><strong>客户端挂载测试</strong><br>1）创建挂载目录并进行挂载<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs-client1 ~]<span class="comment"># mkdir /opt/www</span></span><br><span class="line">[root@nfs-client1 ~]<span class="comment"># showmount -e 192.168.1.31    #查看服务器共享目录</span></span><br><span class="line">Export list <span class="keyword">for</span> <span class="number">192.168</span>.<span class="number">1.31</span>:</span><br><span class="line">/web <span class="number">192.168</span>.<span class="number">1.0</span>/<span class="number">24</span></span><br><span class="line">[root@nfs-client1 ~]<span class="comment"># mount -t nfs 192.168.1.31:/web /opt/www/</span></span><br><span class="line">[root@nfs-client1 ~]<span class="comment"># df -h</span></span><br><span class="line">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class="line">/dev/mapper/centos-root   <span class="number">20</span>G  <span class="number">3.6</span>G   <span class="number">16</span>G   <span class="number">19</span>% <span class="regexp">/</span></span><br><span class="line"><span class="regexp">devtmpfs                 473M     0  473M    0% /dev</span></span><br><span class="line">tmpfs                    <span class="number">489</span>M     <span class="number">0</span>  <span class="number">489</span>M    <span class="number">0</span>% <span class="regexp">/dev/shm</span></span><br><span class="line">tmpfs                    <span class="number">489</span>M   <span class="number">14</span>M  <span class="number">475</span>M    <span class="number">3</span>% <span class="regexp">/run</span></span><br><span class="line"><span class="regexp">tmpfs                    489M     0  489M    0% /sys</span><span class="regexp">/fs/cgroup</span></span><br><span class="line">/dev/sda1                <span class="number">497</span>M  <span class="number">154</span>M  <span class="number">344</span>M   <span class="number">31</span>% <span class="regexp">/boot</span></span><br><span class="line"><span class="regexp">tmpfs                     98M     0   98M    0% /run</span><span class="regexp">/user/</span><span class="number">0</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.31</span>:<span class="regexp">/web         20G  3.6G   16G   19% /opt</span><span class="regexp">/www</span></span><br></pre></td></tr></table></figure></p><p>2）在<code>client1</code>上的<code>/opt/www</code>创建一个测试文件<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nfs</span>-client1 ~]<span class="meta"># echo <span class="string">"client1 create test file"</span> &gt;&gt; /opt/www/client1.txt</span></span><br></pre></td></tr></table></figure></p><p>3）回到<code>nfs</code>上进行查看<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs-server ~]<span class="comment"># ll /web/</span></span><br><span class="line">总用量 4</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 25 </span>8月  <span class="number"> 9 </span>14:41 client1.txt</span><br></pre></td></tr></table></figure></p><p>4）安装<code>nginx</code>并配置站点目录为<code>/opt/www</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs-client1 ~]# yum -y install nginx</span><br><span class="line">[root@nfs-client1 ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /opt/www;</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">[root@nfs-client1 ~]# systemctl start nginx</span><br></pre></td></tr></table></figure></p><p>上面的步骤同样在<code>client2</code>上面操作。</p><p><strong>在nfs服务端创建站点首页，访问client客户端测试</strong><br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs-server ~]<span class="comment"># ll /web/</span></span><br><span class="line">总用量 8</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 25 </span>8月  <span class="number"> 9 </span>14:41 client1.txt</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 25 </span>8月  <span class="number"> 9 </span>15:37 client2.txt</span><br><span class="line"></span><br><span class="line">[root@nfs-server ~]<span class="comment"># echo "&lt;h1&gt;NFS server&lt;/h1&gt;" &gt;&gt; /web/index.html    #nfs服务端共享目录创建首页文件</span></span><br><span class="line">[root@nfs-server ~]<span class="comment"># curl 192.168.1.32</span></span><br><span class="line">&lt;h1&gt;NFS server&lt;/h1&gt;</span><br><span class="line">[root@nfs-server ~]<span class="comment"># </span></span><br><span class="line">[root@nfs-server ~]<span class="comment"># curl 192.168.1.33</span></span><br><span class="line">&lt;h1&gt;NFS server&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@nfs-client1 ~]<span class="comment"># ll /opt/www/    #nfs客户端1上查看</span></span><br><span class="line">总用量 12</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 25 </span>8月  <span class="number"> 9 </span>14:41 client1.txt</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 25 </span>8月  <span class="number"> 9 </span>15:37 client2.txt</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 20 </span>8月  <span class="number"> 9 </span>15:41 index.html</span><br><span class="line"></span><br><span class="line">[root@nfs-client2 ~]<span class="comment"># ll /opt/www/    #nfs客户端2上查看</span></span><br><span class="line">总用量 12</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 25 </span>8月  <span class="number"> 9 </span>14:41 client1.txt</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 25 </span>8月  <span class="number"> 9 </span>15:37 client2.txt</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 20 </span>8月  <span class="number"> 9 </span>15:41 index.html</span><br></pre></td></tr></table></figure></p><p>通过测试可以看出，客户端挂载后，就完全相当于自己的一个目录或者文件，在负载均衡架构中一般通过这种方式做共享存储。</p><h3 id="NFS配置参数说明"><a href="#NFS配置参数说明" class="headerlink" title="NFS配置参数说明"></a>NFS配置参数说明</h3><h4 id="nfs共享参数及作用"><a href="#nfs共享参数及作用" class="headerlink" title="nfs共享参数及作用"></a>nfs共享参数及作用</h4><p>通过 <code>man exports</code>可以查看帮助手册</p><table><thead><tr><th style="text-align:right">共享参数</th><th style="text-align:left">作用</th></tr></thead><tbody><tr><td style="text-align:right">rw*</td><td style="text-align:left">读写权限</td></tr><tr><td style="text-align:right">ro</td><td style="text-align:left">只读权限</td></tr><tr><td style="text-align:right">root_squash</td><td style="text-align:left">当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)</td></tr><tr><td style="text-align:right">no_root_squash</td><td style="text-align:left">当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(常用)</td></tr><tr><td style="text-align:right">all_squash</td><td style="text-align:left">无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户(常用)</td></tr><tr><td style="text-align:right">no_all_squash</td><td style="text-align:left">无论NFS客户端使用什么账户访问，都不进行压缩</td></tr><tr><td style="text-align:right">sync*</td><td style="text-align:left">同时将数据写入到内存与硬盘中，保证不丢失数据</td></tr><tr><td style="text-align:right">async</td><td style="text-align:left">优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据</td></tr><tr><td style="text-align:right">anonuid*</td><td style="text-align:left">配置all_squash使用,指定NFS的用户UID,必须存在系统</td></tr><tr><td style="text-align:right">anongid*</td><td style="text-align:left">配置all_squash使用,指定NFS的用户GID,必须存在系统</td></tr></tbody></table><h4 id="配置实例说明"><a href="#配置实例说明" class="headerlink" title="配置实例说明"></a>配置实例说明</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs-server ~]# cat /etc/exports</span><br><span class="line">#/web    <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>(rw,sync,no_root_squash)  #不压制root(当client端使用root挂载时，也有root权限)</span><br><span class="line">/web    <span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span>(rw,sync,no_root_squash) <span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span>(rw,sync,all_squash,anonuid=<span class="number">2000</span>,anongid=<span class="number">2000</span>)</span><br></pre></td></tr></table></figure><blockquote><p>#[共享目录]&emsp;  [客户端地址1(权限)]&emsp;  [客户端地址2(权限)]<br>1、共享目录：每一行最前面是共享出来的目录，比如上面我要共享<code>/web</code>目录，那么此选项就可以直接写<code>/web</code>目录，这个目录可以依照不同的权限共享给不同的目录。<br>2、客户端地址：客户端地址能够设置一个网络，也可以是单个主机。参数：如上面的读写权限<code>rw</code>，同步更新<code>sync</code>等待。</p><blockquote><p>1、客户端地址可以使用完整的IP或者网络号，例如<code>192.168.1.33</code>或<code>192.168.1.0/24</code><br>2、同样可以使用主机名，但是这个主机名必须要在<code>/etc/hosts</code>中存在，或者可以通过<code>DNS</code>找到才行。</p></blockquote></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;NFS介绍&quot;&gt;&lt;a href=&quot;#NFS介绍&quot; class=&quot;headerlink&quot; title=&quot;NFS介绍&quot;&gt;&lt;/a&gt;NFS介绍&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;http://nfs.sourceforge.net/nfs-howto/&quot; target=&quot;_b
      
    
    </summary>
    
      <category term="Storage" scheme="https://leeyj.coding.me/categories/Storage/"/>
    
    
      <category term="Storage" scheme="https://leeyj.coding.me/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>PHP配合inotify实现光闸ftp功能</title>
    <link href="https://leeyj.coding.me/2019/08/06/PHP%E9%85%8D%E5%90%88inotify%E5%AE%9E%E7%8E%B0%E5%85%89%E9%97%B8ftp%E5%8A%9F%E8%83%BD/"/>
    <id>https://leeyj.coding.me/2019/08/06/PHP配合inotify实现光闸ftp功能/</id>
    <published>2019-08-06T04:13:22.000Z</published>
    <updated>2019-10-24T09:12:16.888Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PHP配合inotify实现光闸ftp功能"><a href="#PHP配合inotify实现光闸ftp功能" class="headerlink" title="PHP配合inotify实现光闸ftp功能"></a>PHP配合inotify实现光闸ftp功能</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><blockquote><p>由于业务需要，内外网的数据需要进行实时交互同步，由于环境因素，只能通过<code>ftp</code>进行文件的交互传输。且没有硬件设备（光闸）；鉴于这种情况下，首先考虑到的是通过<code>shell</code>脚本进行自动上传下载文件。然而在实施部署过程中发现，通过<code>shell</code>脚本方式进行文件的上传下载每一个文件都会建立一次连接。（由于环境因素，ftp通过网闸再通过<code>vpn</code>建立一次连接巨慢，大概需要几十秒。）可是项目站点必须是实时进行文件的传输，且每次可能是多个文件，多者甚至上百个。经过探讨考虑到使用<code>rsync+inotify</code>，通过rsync的守护进程模式进行文件的传输。可是这种项目迟早得换成光闸走<code>ftp</code>进行文件的传输。而后又考虑直接在代码里面实现建立<code>ftp</code>的长连接进行文件传输（建立一次连接，然后一直处于监听模式，发现有文件就及时进行传送）,这样一来又考虑到目录的监听情况，开始准备使用<code>inotify-tools</code>进行监听然后调用<code>php</code>代码里面的<code>ftp</code>长连接进程，随后又在<code>php</code>官方发现<code>php</code>也有一个<code>inotify</code>可以用来进行目录的监听，然后触发动作。<br>于是，最终方案就是在内外网两台服务器上面搭建<code>ftp</code>服务，然后通过<code>php</code>脚本进行目录的监听并上传到<code>ftp</code>服务器。</p></blockquote><blockquote><p>具体实现流程说明<br>1、内外网的服务器均安装<code>ftp</code>。<br>2、内外网的服务器均安装<code>php</code>及<code>php</code>的<code>inotify</code>插件。<br>3、内外网的服务器均安装<code>redis</code>。（<code>php</code>分为两个文件，一个为文件(<code>listen.php</code>)用于监听，一个文件(<code>upFile.php</code>)用于上传文件，由于开始没有存入<code>redis</code>，导致文件堆积，然后一直阻塞。故最终方案通过监听文件将监听到发生变化的文件路径存入到<code>redis</code>里，然后通过<code>upfile</code>脚本将文件上传到<code>ftp</code>）</p></blockquote><h3 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h3><table><thead><tr><th style="text-align:center">IP</th><th style="text-align:center">主机名</th><th style="text-align:center">系统版本</th><th style="text-align:center">网络说明</th></tr></thead><tbody><tr><td style="text-align:center">192.168.1.32</td><td style="text-align:center">internet.example.com</td><td style="text-align:center">CenTOS7.4</td><td style="text-align:center">模拟外网</td></tr><tr><td style="text-align:center">192.168.1.33</td><td style="text-align:center">lan.example.com</td><td style="text-align:center">CenTOS7.4</td><td style="text-align:center">模拟内网</td></tr></tbody></table><blockquote><p>1、这里是通过两台虚拟机进行模拟内外网。且上面真实项目操作系统为<code>CenTOS6.5</code>；这里使用<code>CenTOS7.5</code>模拟。<br>2、两台服务器需要安装软件有：<code>vsftpd</code>、<code>php</code>、<code>php</code>插件<code>inotify</code><br>3、外网的<code>/opt/ftp/out</code>目录只要有新的文件产生就会自动触发监听然后传送至内网的<code>/opt/ftp/come</code>目录。<br>4、反之一样，内网的<code>/opt/ftp/out</code>目录只要有新的文件产生就会自动触发监听然后传送至外网的<code>/opt/ftp/come</code>目录。</p></blockquote><h3 id="项目结构图"><a href="#项目结构图" class="headerlink" title="项目结构图"></a>项目结构图</h3><p><img src="/2019/08/06/PHP配合inotify实现光闸ftp功能/01.png" alt="image.png"></p><h2 id="具体实验步骤"><a href="#具体实验步骤" class="headerlink" title="具体实验步骤"></a>具体实验步骤</h2><h3 id="安装配置vsftpd"><a href="#安装配置vsftpd" class="headerlink" title="安装配置vsftpd"></a>安装配置vsftpd</h3><blockquote><p>说明：内外网都需要配置<code>vsftpd</code>，配置<code>vsftpd</code>虚拟用户可参考 <a href="https://www.cnblogs.com/yanjieli/p/10723108.html" target="_blank" rel="noopener">https://www.cnblogs.com/yanjieli/p/10723108.html</a></p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /opt/ftp/&#123;come,out&#125;    #创建对应的数据目录</span></span><br><span class="line"><span class="comment"># yum -y install vsftpd    #安装vsftpd</span></span><br><span class="line"><span class="comment"># useradd -s /sbin/nologin apache    #由于项目站点所使用的apache用户，所以这里为了防止权限问题，这里也是用apache用户作为虚拟用户</span></span><br><span class="line"><span class="comment"># chown apache.apache /opt/ftp/ -R    #将数据目录权限改为apache用户</span></span><br><span class="line"><span class="comment"># cat &gt;/etc/vsftpd/logins.txt&lt;&lt;-EOF    #创建ftp虚拟账号和密码，一行账号一行密码</span></span><br><span class="line">ftp_come_user</span><br><span class="line">Ftp_come_password@Qaz123</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># db_load -T -t hash -f /etc/vsftpd/logins.txt /etc/vsftpd/login.db    #将密码文件转换成db格式</span></span><br><span class="line"><span class="comment"># chmod 600 /etc/vsftpd/login.db    #更改db文件的权限</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat &gt;/etc/pam.d/ftp&lt;&lt;-EOF    #定义pam认证文件</span></span><br><span class="line">auth  required  /lib64/security/pam_userdb.so  <span class="attribute">db</span>=/etc/vsftpd/login</span><br><span class="line">account  required  /lib64/security/pam_userdb.so  <span class="attribute">db</span>=/etc/vsftpd/login</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp /etc/vsftpd/vsftpd.conf&#123;,.back&#125;    #备份配置文件</span></span><br><span class="line"><span class="comment"># vim /etc/vsftpd/vsftpd.conf    #编辑vsftpd主配置文件</span></span><br><span class="line"><span class="attribute">anonymous_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="attribute">local_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attribute">write_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="attribute">anon_upload_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="attribute">anon_mkdir_write_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="attribute">anon_other_write_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="attribute">chroot_local_user</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attribute">allow_writeable_chroot</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attribute">guest_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attribute">guest_username</span>=apache</span><br><span class="line"><span class="attribute">listen</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attribute">listen_port</span>=21</span><br><span class="line"><span class="attribute">pasv_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attribute">pasv_address</span>=192.168.1.32    #内网的那台改成对应内网的IP地址</span><br><span class="line"><span class="attribute">pasv_min_port</span>=10000</span><br><span class="line"><span class="attribute">pasv_max_port</span>=10088</span><br><span class="line"><span class="attribute">anon_world_readable_only</span>=<span class="literal">NO</span></span><br><span class="line"><span class="attribute">user_config_dir</span>=/etc/vsftpd/user_conf</span><br><span class="line"><span class="attribute">tcp_wrappers</span>=<span class="literal">YES</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vim /etc/vsftpd/user_conf/ftp_come_user    #编辑虚拟用户的子配置文件</span></span><br><span class="line"><span class="attribute">write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attribute">anon_world_readable_only</span>=<span class="literal">no</span></span><br><span class="line"><span class="attribute">anon_upload_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attribute">anon_mkdir_write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attribute">anon_other_write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attribute">anon_umask</span>=022</span><br><span class="line"><span class="attribute">local_root</span>=/opt/ftp/come</span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl start vsftpd    #启动ftp</span></span><br></pre></td></tr></table></figure><h3 id="测试ftp"><a href="#测试ftp" class="headerlink" title="测试ftp"></a>测试ftp</h3><p>1）在外网（<code>192.168.1.32</code>）上访问内网（<code>192.168.1.33</code>）的<code>ftp</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@internet ~]# dd <span class="attribute">if</span>=/dev/zero <span class="attribute">of</span>=testfile <span class="attribute">bs</span>=1M <span class="attribute">count</span>=100    #创建一个测试文件用于测试上传</span><br><span class="line">[root@internet ~]# lftp ftp_come_user:Ftp_come_password@Qaz123@192.168.1.33    #通过lftp工具连接ftp</span><br><span class="line">lftp ftp_come_user@192.168.1.33:~&gt; lcd</span><br><span class="line">lcd 成功, 本地目录=/root</span><br><span class="line">lftp ftp_come_user@192.168.1.33:~&gt; put testfile</span><br><span class="line">104857600 bytes transferred <span class="keyword">in</span> 2 seconds (55.59M/s)</span><br><span class="line">lftp ftp_come_user@192.168.1.33:/&gt; ls</span><br><span class="line">-rw-r--r--    1 1001     1001     104857600 Aug 05 12:41 testfile</span><br></pre></td></tr></table></figure></p><p>2）在内网（<code>192.168.1.33</code>）上访问外网（<code>192.168.1.32</code>）的<code>ftp</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@lan ~]<span class="comment"># dd if=/dev/zero of=testfile1 bs=1M count=100    #同样创建一个测试文件</span></span><br><span class="line">[root@lan ~]<span class="comment"># lftp ftp_come_user:Ftp_come_password<span class="doctag">@Qaz</span>123@192.168.1.32</span></span><br><span class="line">lftp ftp_come_user@192.<span class="number">168.1</span>.<span class="number">32</span><span class="symbol">:~&gt;</span> put testfile1</span><br><span class="line"><span class="number">104857600</span> bytes transferred <span class="keyword">in</span> <span class="number">3</span> seconds (<span class="number">31.87</span>M/s)              </span><br><span class="line">lftp ftp_come_user@192.<span class="number">168.1</span>.<span class="number">32</span><span class="symbol">:/&gt;</span></span><br><span class="line">lftp ftp_come_user@192.<span class="number">168.1</span>.<span class="number">32</span><span class="symbol">:/&gt;</span> ls</span><br><span class="line">-rw-r--r--    <span class="number">1</span> <span class="number">1001</span>     <span class="number">1001</span>     <span class="number">104857600</span> Aug <span class="number">05</span> <span class="number">12</span><span class="symbol">:</span><span class="number">45</span> testfile1</span><br></pre></td></tr></table></figure></p><p>3）在内网的<code>/opt/ftp/come</code>目录验证是否存在<code>testfile</code>文件<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@lan ~]<span class="comment"># ll /opt/ftp/come/</span></span><br><span class="line">总用量 102400</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 104857600 </span>8月  <span class="number"> 5 </span>20:41 testfile</span><br></pre></td></tr></table></figure></p><p>4）在外网的<code>/opt/ftp/come</code>目录验证是否存在<code>testfile1</code>文件<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@internet ~]<span class="comment"># ll /opt/ftp/come/</span></span><br><span class="line">总用量 102400</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 104857600 </span>8月  <span class="number"> 5 </span>20:45 testfile1</span><br></pre></td></tr></table></figure></p><p>通过测试<code>ftp</code>已经<code>ok</code></p><h3 id="安装配置redis"><a href="#安装配置redis" class="headerlink" title="安装配置redis"></a>安装配置redis</h3><blockquote><p>生产环境<code>redis</code>可能端口不一样，然后根据不同的进行配置即可。同时设置连接密码，（这里只是测试，所以两边的配置一样）</p></blockquote><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># yum -y install redis    #安装redis</span><br><span class="line"># cp /etc/redis.conf&#123;,.back&#125;    #拷贝redis配置文件</span><br><span class="line"># vim /etc/redis.conf    #编辑redis配置文件</span><br><span class="line">daemonize yes    #开启后台常驻进程</span><br><span class="line">requirepass obohna7Fogai9ahnahth    #设置redis连接密码</span><br><span class="line"># systemctl start redis    #启动redis</span><br><span class="line"># netstat -nlutp |grep <span class="number">6379</span>    #检查端口是否打开</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>          <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">7139</span>/redis-server <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="安装php及inotify插件"><a href="#安装php及inotify插件" class="headerlink" title="安装php及inotify插件"></a>安装php及inotify插件</h3><p>1）<code>yum</code>安装<code>php</code><br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line"><span class="meta"># rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm</span></span><br><span class="line"><span class="meta"># yum install --enablerepo=remi,remi-php56 php php-opcache php-pecl-apcu php-devel php-mbstring php-mcrypt php-mysqlnd php-phpunit-PHPUnit php-pecl-xdebug php-pecl-xhprof php-pdo php-pear php-fpm php-cli php-xml php-bcmath php-process php-gd php-common php-memcache php-redis php-pspell  php-fpm  php-mysql php-common php-mssql</span></span><br></pre></td></tr></table></figure></p><p>2）安装<code>php</code>插件<code>inotify</code><br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># wget http://pecl.php.net/get/inotify-0.1.6.tgz    #下载软件包</span></span><br><span class="line"><span class="meta"># tar xf inotify-0.1.6.tgz    #解压软件包</span></span><br><span class="line"><span class="meta"># yum install gcc gcc-c++ make    #安装编译工具</span></span><br><span class="line"><span class="meta"># tar xf inotify-0.1.6.tgz</span></span><br><span class="line"><span class="meta"># cd inotify-0.1.6/</span></span><br><span class="line"><span class="meta"># phpize</span></span><br><span class="line"><span class="meta"># ./configure --with-php-config=/usr/bin/php-config --enable-inotify</span></span><br><span class="line"><span class="meta"># make &amp;&amp; make install</span></span><br><span class="line"><span class="meta"># echo "extension = inotify.so" &gt;&gt; /etc/php.d/inotify.ini</span></span><br><span class="line"><span class="meta"># php -i|grep inotify</span></span><br><span class="line"><span class="meta"># systemctl start php-fpm</span></span><br></pre></td></tr></table></figure></p><h3 id="编写PHP脚本"><a href="#编写PHP脚本" class="headerlink" title="编写PHP脚本"></a>编写PHP脚本</h3><blockquote><p>内外网其实一样，只是配置的连接信息不一样。</p></blockquote><p>1）监听脚本(<code>listen.php</code>)<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line">[root@internet ~]<span class="comment"># mkdir /home/script</span></span><br><span class="line">[root@internet ~]<span class="comment"># vim /home/script/listen.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: ADMIN</span></span><br><span class="line"><span class="comment"> * Date: 2019/7/31</span></span><br><span class="line"><span class="comment"> * Time: 19:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">'REDIS_HOST'</span>,<span class="string">'127.0.0.1'</span>); <span class="comment">//redis连接主机</span></span><br><span class="line">define(<span class="string">'REDIS_PASSWORD'</span>,<span class="string">'obohna7Fogai9ahnahth'</span>);  <span class="comment">//redis连接密码</span></span><br><span class="line">define(<span class="string">'REDIS_PORT'</span>,<span class="string">'6379'</span>);  <span class="comment">//redis端口</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">'__LISTEN_DIR__'</span>,<span class="string">"/opt/ftp/out"</span>);  <span class="comment">//本地监听目录</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monitor</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $dir = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件新增事件回调</span></span><br><span class="line">    <span class="keyword">private</span> $onfileAdd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $timeout = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($dir,$onfileAdd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!extension_loaded(<span class="string">'inotify'</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'请安装inotify扩展'</span>, PHP_EOL;</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;dir = $dir;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;onfileAdd = $onfileAdd;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对目录进行监控</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $dirs = <span class="keyword">$this</span>-&gt;getDirs(<span class="keyword">$this</span>-&gt;dir);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($dirs)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $fd = inotify_init();</span><br><span class="line">        <span class="comment">//设置为非阻塞模式</span></span><br><span class="line">        stream_set_blocking($fd, <span class="number">0</span>);</span><br><span class="line">        $watcher = [];</span><br><span class="line">        <span class="keyword">foreach</span> ($dirs <span class="keyword">as</span> $dir) &#123;</span><br><span class="line">            $watch = inotify_add_watch($fd, $dir, IN_MODIFY | IN_CREATE | IN_DELETE | IN_DELETE_SELF | IN_CLOSE_WRITE);</span><br><span class="line">            <span class="keyword">if</span> (!$watch) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&#123;$dir&#125; 添加监控错误"</span>, PHP_EOL;</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $watcher[$watch] = $dir;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            $reads = [$fd];</span><br><span class="line">            $write = [];</span><br><span class="line">            $except = [];</span><br><span class="line">            <span class="keyword">if</span> (stream_select($reads, $write, $except, <span class="keyword">$this</span>-&gt;timeout) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">empty</span>($reads)) &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> ($reads <span class="keyword">as</span> $read) &#123;</span><br><span class="line">                        <span class="comment">//从可读流中读取数据</span></span><br><span class="line">                        $events = inotify_read($read);</span><br><span class="line">                        $fileName = <span class="string">''</span>;</span><br><span class="line">                        <span class="keyword">foreach</span> ($events <span class="keyword">as</span> $event) &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">//文件改变</span></span><br><span class="line">                            $fileChg = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="comment">//目录改变</span></span><br><span class="line">                            $dirChg = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                            $fileName = $event[<span class="string">'name'</span>];</span><br><span class="line">                            <span class="keyword">switch</span> ($event[<span class="string">'mask'</span>]) &#123;</span><br><span class="line">                                <span class="keyword">case</span> IN_CREATE:     <span class="comment">//创建   IN_CLOSE_WRITE  写入结束</span></span><br><span class="line">                                <span class="keyword">case</span> IN_DELETE:</span><br><span class="line">                                    $fileChg = <span class="keyword">true</span>;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                <span class="keyword">case</span> <span class="number">1073742080</span>:</span><br><span class="line">                                <span class="keyword">case</span> <span class="number">1073742336</span>:</span><br><span class="line">                                    $dirChg = <span class="keyword">true</span>;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> ($fileChg) &#123;</span><br><span class="line">                                $filepath = $watcher[$event[<span class="string">'wd'</span>]] . <span class="string">'/'</span> . $fileName;</span><br><span class="line">                                <span class="keyword">if</span>($watcher[$event[<span class="string">'wd'</span>]] == <span class="keyword">$this</span>-&gt;dir)&#123;</span><br><span class="line">                                    $newfile = $fileName;</span><br><span class="line">                                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                    $newfile = str_replace(<span class="keyword">$this</span>-&gt;dir,<span class="string">'.'</span>,$filepath);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | 事件目录："</span> . $filepath .  <span class="string">"，事件出现：&#123;$event['mask']&#125; ，文件/目录 &#123;$fileName&#125; 发生改变"</span> . PHP_EOL;</span><br><span class="line">                                <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | "</span> . $newfile . PHP_EOL;</span><br><span class="line"><span class="comment">//                                echo "文件 &#123;$fileName&#125; 发生改变", PHP_EOL;</span></span><br><span class="line"><span class="comment">//                            echo shell_exec($this-&gt;cmd), PHP_EOL;</span></span><br><span class="line"><span class="comment">//                                SysutilLogger::instance()-&gt;fileAdd("事件目录：" . $watcher[$event['wd']] . "，事件出现：&#123;$event['mask']&#125; ，文件/目录 &#123;$fileName&#125; 发生改变");</span></span><br><span class="line">                                call_user_func_array(<span class="keyword">$this</span>-&gt;onfileAdd,[$filepath,$newfile]);</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> ($dirChg) &#123;</span><br><span class="line"><span class="comment">//                                echo "目录 &#123;$fileName&#125; 发生改变", PHP_EOL;</span></span><br><span class="line"><span class="comment">//                            echo shell_exec($this-&gt;cmd), PHP_EOL;</span></span><br><span class="line">                                <span class="comment">//目录发生改变时  重新监听</span></span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//递归的获取当前目录下所有子目录路径</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDirs</span><span class="params">($dir)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $dir = realpath($dir);</span><br><span class="line">        $dh = opendir($dir);</span><br><span class="line">        <span class="keyword">if</span> (!$dh) &#123;</span><br><span class="line">            <span class="keyword">return</span> [];</span><br><span class="line">        &#125;</span><br><span class="line">        $dirs = [];</span><br><span class="line">        $dirs[] = $dir;</span><br><span class="line">        <span class="keyword">while</span> (($file = readdir($dh)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($file == <span class="string">'.'</span> || $file == <span class="string">'..'</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $full = $dir . DIRECTORY_SEPARATOR . $file;</span><br><span class="line">            <span class="keyword">if</span> (is_dir($full)) &#123;</span><br><span class="line">                $dirs = array_merge($dirs, <span class="keyword">$this</span>-&gt;getDirs($full));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        closedir($dh);</span><br><span class="line">        <span class="keyword">return</span> $dirs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SysutilRedis</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $_instance;</span><br><span class="line">    <span class="keyword">private</span> $m_redis = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> $mid_redis = <span class="keyword">null</span>;      <span class="comment">//律师中心redis实例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SysutilRedis|Redis</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( ! <span class="keyword">isset</span>(SysutilRedis::$_instance))</span><br><span class="line">        &#123;</span><br><span class="line">            SysutilRedis::$_instance = <span class="keyword">new</span> SysutilRedis();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> SysutilRedis::$_instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> null|Redis</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRedis</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>( !<span class="keyword">$this</span>-&gt;m_redis )&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;m_redis = <span class="keyword">new</span> Redis();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;m_redis-&gt;connect(REDIS_HOST,REDIS_PORT,<span class="number">10</span>); <span class="comment">//php客户端设置的ip及端口</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;m_redis-&gt;auth(REDIS_PASSWORD);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;m_redis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close_redis</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;m_redis) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;m_redis-&gt;close();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;m_redis = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;mid_redis) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mid_redis-&gt;close();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mid_redis = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;close_redis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Listenner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        $callBack = [<span class="keyword">$this</span>,<span class="string">"toRedis"</span>];</span><br><span class="line"></span><br><span class="line">        $listen_dir = __LISTEN_DIR__;</span><br><span class="line"></span><br><span class="line">        $monitor = <span class="keyword">new</span> Monitor($listen_dir,$callBack);</span><br><span class="line"></span><br><span class="line">        $monitor-&gt;run();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@describe</span> 文件回调</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> zhouyong</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toRedis</span><span class="params">($filename,$newfile)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        $redis = SysutilRedis::instance()-&gt;getRedis();</span><br><span class="line">        $redis-&gt;select(<span class="number">9</span>);</span><br><span class="line">        $cache_id = <span class="string">'upload_file_list'</span>;</span><br><span class="line">        $data = [</span><br><span class="line">            <span class="string">'local'</span> =&gt; $filename,</span><br><span class="line">            <span class="string">'remote'</span> =&gt; $newfile</span><br><span class="line">        ];</span><br><span class="line">        $redis-&gt;rpush($cache_id, json_encode($data));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$listenner = <span class="keyword">new</span> Listenner();</span><br><span class="line"></span><br><span class="line">$listenner-&gt;run();</span><br></pre></td></tr></table></figure></p><p>2）上传文件脚本(<code>upFile.php</code>)<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line">[root@internet ~]<span class="comment"># vim /home/script/upFile.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: ADMIN</span></span><br><span class="line"><span class="comment"> * Date: 2019/7/31</span></span><br><span class="line"><span class="comment"> * Time: 19:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">'REDIS_HOST'</span>,<span class="string">'127.0.0.1'</span>); <span class="comment">//redis连接主机</span></span><br><span class="line">define(<span class="string">'REDIS_PASSWORD'</span>,<span class="string">'obohna7Fogai9ahnahth'</span>);  <span class="comment">//redis连接密码</span></span><br><span class="line">define(<span class="string">'REDIS_PORT'</span>,<span class="string">'6379'</span>);  <span class="comment">//redis端口</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">define(<span class="string">'FTP_HOST'</span>,<span class="string">'192.168.1.33'</span>);  <span class="comment">//内网ftp服务器</span></span><br><span class="line">define(<span class="string">'FTP_PORT'</span>,<span class="number">21</span>); <span class="comment">//ftp端口</span></span><br><span class="line">define(<span class="string">'FTP_USER'</span>,<span class="string">'ftp_come_user'</span>);  <span class="comment">//ftp连接账号</span></span><br><span class="line">define(<span class="string">'FTP_PASS'</span>,<span class="string">'Ftp_come_password@Qaz123'</span>);  <span class="comment">//ftp连接密码</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SysutilFtp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $instance;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $off; <span class="comment">// 返回操作状态(成功/失败)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $conn_id; <span class="comment">// FTP连接</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法：FTP连接</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@FTP</span>_HOST -- FTP主机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@FTP</span>_PORT -- 端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@FTP</span>_USER -- 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@FTP</span>_PASS -- 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($FTP_HOST,$FTP_PORT,$FTP_USER,$FTP_PASS)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;conn_id = @ftp_connect($FTP_HOST,$FTP_PORT) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"FTP服务器连接失败"</span>);</span><br><span class="line">        @ftp_login(<span class="keyword">$this</span>-&gt;conn_id,$FTP_USER,$FTP_PASS) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"FTP服务器登陆失败"</span>);</span><br><span class="line">        @ftp_pasv(<span class="keyword">$this</span>-&gt;conn_id,<span class="number">1</span>); <span class="comment">// 打开被动模拟</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@describe</span> 获取ftp实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">self</span>::$instance)&#123;</span><br><span class="line">            <span class="keyword">self</span>::$instance = <span class="keyword">new</span> <span class="keyword">self</span>(FTP_HOST,FTP_PORT,FTP_USER,FTP_PASS);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">self</span>::$instance)&#123;</span><br><span class="line">                <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | connected !"</span> . PHP_EOL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@describe</span> 重连</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> zhouyong</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">reConnect</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | closing connection ......"</span> . PHP_EOL;</span><br><span class="line">        <span class="comment">//关闭当前链接</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;close();</span><br><span class="line">        <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | reconnecting...."</span> . PHP_EOL;</span><br><span class="line">        <span class="comment">//开辟新连接</span></span><br><span class="line">        <span class="keyword">self</span>::$instance = <span class="keyword">new</span> <span class="keyword">self</span>(FTP_HOST,FTP_PORT,FTP_USER,FTP_PASS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | connected !"</span> . PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法：上传文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@path</span> -- 本地路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@newpath</span> -- 上传路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type</span> -- 若目标目录不存在则新建</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">up_file</span><span class="params">($path,$newpath,$type=true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($type) <span class="keyword">$this</span>-&gt;dir_mkdirs($newpath);</span><br><span class="line">        <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | 当前目录"</span> . ftp_pwd(<span class="keyword">$this</span>-&gt;conn_id) . PHP_EOL;</span><br><span class="line">        $newpath = ltrim($newpath,<span class="string">'.'</span>);</span><br><span class="line">        <span class="keyword">echo</span> $newpath . PHP_EOL;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;off = @ftp_put(<span class="keyword">$this</span>-&gt;conn_id,$newpath,$path,FTP_BINARY);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;off)&#123;</span><br><span class="line"><span class="comment">//            echo "文件上传失败，请检查权限及路径是否正确！";</span></span><br><span class="line"><span class="comment">//            echo "文件上传失败，正在发起重连.....";</span></span><br><span class="line"><span class="comment">//            $this-&gt;reConnect();</span></span><br><span class="line"><span class="comment">//            echo date('Y-m-d H:i:s') . " | re-uploading file &#123;$path&#125; to &#123;$newpath&#125; ...." . PHP_EOL;</span></span><br><span class="line"><span class="comment">//            $this-&gt;up_file($path,$newpath,$type=true);</span></span><br><span class="line">            <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | 上传失败"</span> . PHP_EOL;</span><br><span class="line"><span class="comment">//            exit;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | upload success !"</span> . PHP_EOL;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法：移动文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@path</span> -- 原路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@newpath</span> -- 新路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type</span> -- 若目标目录不存在则新建</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">move_file</span><span class="params">($path,$newpath,$type=true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($type) <span class="keyword">$this</span>-&gt;dir_mkdirs($newpath);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;off = @ftp_rename(<span class="keyword">$this</span>-&gt;conn_id,$path,$newpath);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;off) <span class="keyword">echo</span> <span class="string">"文件移动失败，请检查权限及原路径是否正确！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法：复制文件</span></span><br><span class="line"><span class="comment">     * 说明：由于FTP无复制命令,本方法变通操作为：下载后再上传到新的路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@path</span> -- 原路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@newpath</span> -- 新路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type</span> -- 若目标目录不存在则新建</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">copy_file</span><span class="params">($path,$newpath,$type=true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $downpath = <span class="string">"c:/tmp.dat"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;off = @ftp_get(<span class="keyword">$this</span>-&gt;conn_id,$downpath,$path,FTP_BINARY);<span class="comment">// 下载</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;off) <span class="keyword">echo</span> <span class="string">"文件复制失败，请检查权限及原路径是否正确！"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;up_file($downpath,$newpath,$type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法：删除文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@path</span> -- 路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">del_file</span><span class="params">($path)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;off = @ftp_delete(<span class="keyword">$this</span>-&gt;conn_id,$path);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;off) <span class="keyword">echo</span> <span class="string">"文件删除失败，请检查权限及路径是否正确！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法：生成目录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@path</span> -- 路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dir_mkdirs</span><span class="params">($path)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $path_arr = explode(<span class="string">'/'</span>,$path); <span class="comment">// 取目录数组</span></span><br><span class="line">        $file_name = array_pop($path_arr); <span class="comment">// 弹出文件名</span></span><br><span class="line">        $path_div = count($path_arr); <span class="comment">// 取层数</span></span><br><span class="line">        print_r($path_arr);</span><br><span class="line">        <span class="keyword">foreach</span>($path_arr <span class="keyword">as</span> $val) <span class="comment">// 创建目录</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(@ftp_chdir(<span class="keyword">$this</span>-&gt;conn_id,$val) == <span class="keyword">FALSE</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                $tmp = @ftp_mkdir(<span class="keyword">$this</span>-&gt;conn_id,$val);</span><br><span class="line">                <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | 创建目录&#123;$val&#125;"</span> . PHP_EOL;</span><br><span class="line">                <span class="keyword">if</span>($tmp == <span class="keyword">FALSE</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | 目录创建失败，请检查权限及路径是否正确！"</span> . PHP_EOL;</span><br><span class="line">                    <span class="keyword">exit</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                @ftp_chdir(<span class="keyword">$this</span>-&gt;conn_id,$val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | 创建目录成功"</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | 当前目录"</span> . ftp_pwd(<span class="keyword">$this</span>-&gt;conn_id) . PHP_EOL;</span><br><span class="line">        <span class="keyword">for</span>($i=<span class="number">1</span>;$i&lt;$path_div;$i++) <span class="comment">// 回退到根</span></span><br><span class="line">        &#123;</span><br><span class="line">            @ftp_cdup(<span class="keyword">$this</span>-&gt;conn_id);</span><br><span class="line">            <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | 当前目录"</span> . ftp_pwd(<span class="keyword">$this</span>-&gt;conn_id) . PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ping</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> date(<span class="string">"Y-m-d H:i:s"</span>) . <span class="string">" |  发送心跳数据 "</span> . PHP_EOL;</span><br><span class="line">        @ftp_raw(<span class="keyword">$this</span>-&gt;conn_id,<span class="string">'pingpong'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法：关闭FTP连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        @ftp_close(<span class="keyword">$this</span>-&gt;conn_id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">// class class_ftp end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SysutilRedis</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $_instance;</span><br><span class="line">    <span class="keyword">private</span> $m_redis = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> $mid_redis = <span class="keyword">null</span>;      <span class="comment">//律师中心redis实例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SysutilRedis</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">instance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( ! <span class="keyword">isset</span>(SysutilRedis::$_instance))</span><br><span class="line">        &#123;</span><br><span class="line">            SysutilRedis::$_instance = <span class="keyword">new</span> SysutilRedis();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> SysutilRedis::$_instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> null|Redis</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRedis</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>( !<span class="keyword">$this</span>-&gt;m_redis )&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;m_redis = <span class="keyword">new</span> Redis();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;m_redis-&gt;connect(REDIS_HOST,REDIS_PORT,<span class="number">10</span>); <span class="comment">//php客户端设置的ip及端口</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;m_redis-&gt;auth(REDIS_PASSWORD);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;m_redis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close_redis</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;m_redis) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;m_redis-&gt;close();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;m_redis = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;mid_redis) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mid_redis-&gt;close();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mid_redis = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;close_redis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$redis = SysutilRedis::instance()-&gt;getRedis();</span><br><span class="line">$redis-&gt;select(<span class="number">9</span>);</span><br><span class="line">$cache_id = <span class="string">'upload_file_list'</span>;</span><br><span class="line"></span><br><span class="line">$no_data_time = <span class="number">0</span>;</span><br><span class="line">$ping = <span class="number">3</span>;      <span class="comment">//心跳时间   每 x 秒发送一次心跳数据</span></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">    $data = $redis-&gt;lRange($cache_id, <span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($data)) &#123;</span><br><span class="line">        $no_data_time = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            $v = json_decode($value, <span class="keyword">true</span>);</span><br><span class="line">            $result = up_file($v[<span class="string">'local'</span>],$v[<span class="string">'remote'</span>]);</span><br><span class="line">            <span class="keyword">if</span>($result)&#123;</span><br><span class="line">                $redis-&gt;select(<span class="number">9</span>);</span><br><span class="line">                $redis-&gt;lPop($cache_id);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> date(<span class="string">"Y-m-d H:i:s"</span>) . <span class="string">"| 退出脚本"</span>;</span><br><span class="line">                <span class="keyword">exit</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($no_data_time &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//查看没有事件的时间</span></span><br><span class="line">            $time = time();</span><br><span class="line">            <span class="keyword">if</span>(($time - $no_data_time) &gt; $ping)&#123;</span><br><span class="line">                <span class="comment">//发送心跳  并重置时间</span></span><br><span class="line">                ping_ftp();</span><br><span class="line">                $no_data_time = $time;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $no_data_time = time();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">up_file</span><span class="params">($filename,$newfile)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" | $filename ,  $newfile"</span> . PHP_EOL;</span><br><span class="line">    $ftp = SysutilFtp::getInstance();</span><br><span class="line">    <span class="keyword">return</span> $ftp-&gt;up_file($filename,$newfile);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ping_ftp</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $ftp = SysutilFtp::getInstance();</span><br><span class="line">    $ftp-&gt;ping();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3）启动脚本并测试<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#在一个终端启动listen.php脚本</span><br><span class="line">[root@internet ~]# php -f /home/script/listen.php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#在另外一个终端启动upFile.php脚本</span><br><span class="line">[root@internet ~]# php -f /home/script/upFile.php </span><br><span class="line">2019<span class="string">-08</span><span class="string">-06</span> 11:24:11 | connected !</span><br><span class="line">2019<span class="string">-08</span><span class="string">-06</span> 11:24:11 |  发送心跳数据</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#在第三个终端往监听目录/opt/ftp/out目录新建一个文件或目录进行测试</span><br><span class="line">[root@internet ~]# echo "test" &gt;&gt; /opt/ftp/out/file1</span><br><span class="line"></span><br><span class="line">#分别可以在上面第一个终端和第二个终端看到日志信息</span><br><span class="line">终端一的信息：</span><br><span class="line">2019<span class="string">-08</span><span class="string">-06</span> 11:36:26 | 事件目录：/opt/ftp/out/file1，事件出现：256 ，文件/目录 file1 发生改变</span><br><span class="line">2019<span class="string">-08</span><span class="string">-06</span> 11:36:26 | file1</span><br><span class="line"></span><br><span class="line">终端二的信息：</span><br><span class="line">2019<span class="string">-08</span><span class="string">-06</span> 11:36:26 | /opt/ftp/out/file1 ,  file1</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">)</span><br><span class="line">2019<span class="string">-08</span><span class="string">-06</span> 11:36:26 | 创建目录成功</span><br><span class="line">2019<span class="string">-08</span><span class="string">-06</span> 11:36:26 | 当前目录/</span><br><span class="line">2019<span class="string">-08</span><span class="string">-06</span> 11:36:26 | 当前目录/</span><br><span class="line">file1</span><br><span class="line">2019<span class="string">-08</span><span class="string">-06</span> 11:36:26 | upload success !</span><br></pre></td></tr></table></figure></p><h3 id="管理两个脚本"><a href="#管理两个脚本" class="headerlink" title="管理两个脚本"></a>管理两个脚本</h3><p>1）编写监控脚本，当进程挂掉便重启<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /home/script/process_alive.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#用来监听listen脚本和upFile脚本</span></span><br><span class="line"></span><br><span class="line">DATE=[`date <span class="string">"+%Y-%m-%d %H:%M:%S"</span>`]</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> phpScriptAlive &#123;</span><br><span class="line">    script_dir=/home/script/</span><br><span class="line">    ps aux |grep -v grep |grep <span class="variable">$1</span> &gt;&gt; /dev/null</span><br><span class="line">    <span class="keyword">if</span> [[ $? != 0 ]]; <span class="keyword">then</span></span><br><span class="line">        nohup php -f <span class="variable">$&#123;script_dir&#125;</span>/<span class="variable">$1</span> &gt;&gt; /var/<span class="built_in">log</span>/<span class="variable">$2</span> &amp;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;DATE&#125;</span> 重启php脚本 <span class="variable">$1</span>"</span> &gt;&gt; /var/<span class="built_in">log</span>/php_script_restart.log</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">phpScriptAlive listen.php php_listen.log</span><br><span class="line">phpScriptAlive upFile.php php_upfile.log</span><br></pre></td></tr></table></figure></p><p>2）添加到计划任务<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># chmod +x /home/script/process_alive.sh </span></span><br><span class="line"><span class="section"># 监听php脚本进程</span></span><br><span class="line"><span class="bullet">* </span><span class="bullet">* *</span> <span class="bullet">* *</span> /bin/bash /home/script/process_alive.sh</span><br></pre></td></tr></table></figure></p><p>3）查看日志；由于上面脚本里面写了将所有输出都记录到日志里面，所以后续直接查看日志即可<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@internet ~]</span># <span class="selector-tag">tailf</span> /<span class="selector-tag">var</span>/<span class="selector-tag">log</span>/<span class="selector-tag">php</span></span><br><span class="line"><span class="selector-tag">php-fpm</span>/                <span class="selector-tag">php_listen</span><span class="selector-class">.log</span>          <span class="selector-tag">php_script_restart</span><span class="selector-class">.log</span>  <span class="selector-tag">php_upfile</span><span class="selector-class">.log</span></span><br><span class="line"><span class="selector-attr">[root@internet ~]</span># <span class="selector-tag">tailf</span> /<span class="selector-tag">var</span>/<span class="selector-tag">log</span>/<span class="selector-tag">php_listen</span><span class="selector-class">.log</span> </span><br><span class="line">^<span class="selector-tag">C</span></span><br><span class="line"><span class="selector-attr">[root@internet ~]</span># <span class="selector-tag">tailf</span> /<span class="selector-tag">var</span>/<span class="selector-tag">log</span>/<span class="selector-tag">php_upfile</span><span class="selector-class">.log</span> </span><br><span class="line"><span class="selector-tag">2019-08-06</span> <span class="selector-tag">12</span><span class="selector-pseudo">:01</span><span class="selector-pseudo">:18</span> |  发送心跳数据 </span><br><span class="line"><span class="selector-tag">2019-08-06</span> <span class="selector-tag">12</span><span class="selector-pseudo">:01</span><span class="selector-pseudo">:22</span> |  发送心跳数据 </span><br><span class="line"><span class="selector-tag">2019-08-06</span> <span class="selector-tag">12</span><span class="selector-pseudo">:01</span><span class="selector-pseudo">:26</span> |  发送心跳数据 </span><br><span class="line"><span class="selector-tag">2019-08-06</span> <span class="selector-tag">12</span><span class="selector-pseudo">:01</span><span class="selector-pseudo">:30</span> |  发送心跳数据</span><br></pre></td></tr></table></figure></p><p>4）再次往<code>/opt/ftp/out/</code>目录丢文件，便会自动同步到内网或者外网的<code>/opt/ftp/come</code>目录。<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@internet ~]<span class="comment"># echo "sjdklf" &gt;&gt; /opt/ftp/out/file111</span></span><br><span class="line">[root@internet ~]<span class="comment"># for i in `seq 10`; do echo "sjdlfjskldjf" &gt;&gt; /opt/ftp/out/txt$i ; don</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#内网查看</span></span><br><span class="line">[root@lan ~]<span class="comment"># ll /opt/ftp/come/</span></span><br><span class="line">总用量 48</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache <span class="number"> 5 </span>8月  <span class="number"> 6 </span>11:36 file1</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache <span class="number"> 7 </span>8月  <span class="number"> 6 </span>12:06 file111</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 13 </span>8月  <span class="number"> 6 </span>12:07 txt1</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 13 </span>8月  <span class="number"> 6 </span>12:07 txt10</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 13 </span>8月  <span class="number"> 6 </span>12:07 txt2</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 13 </span>8月  <span class="number"> 6 </span>12:07 txt3</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 13 </span>8月  <span class="number"> 6 </span>12:07 txt4</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 13 </span>8月  <span class="number"> 6 </span>12:07 txt5</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 13 </span>8月  <span class="number"> 6 </span>12:07 txt6</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 13 </span>8月  <span class="number"> 6 </span>12:07 txt7</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 13 </span>8月  <span class="number"> 6 </span>12:07 txt8</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>apache apache<span class="number"> 13 </span>8月  <span class="number"> 6 </span>12:07 txt9</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PHP配合inotify实现光闸ftp功能&quot;&gt;&lt;a href=&quot;#PHP配合inotify实现光闸ftp功能&quot; class=&quot;headerlink&quot; title=&quot;PHP配合inotify实现光闸ftp功能&quot;&gt;&lt;/a&gt;PHP配合inotify实现光闸ftp功能&lt;/
      
    
    </summary>
    
      <category term="Linux" scheme="https://leeyj.coding.me/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://leeyj.coding.me/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>ELK快速入门五-配置nginx代理kibana</title>
    <link href="https://leeyj.coding.me/2019/07/05/ELK%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E4%BA%94-%E9%85%8D%E7%BD%AEnginx%E4%BB%A3%E7%90%86kibana/"/>
    <id>https://leeyj.coding.me/2019/07/05/ELK快速入门五-配置nginx代理kibana/</id>
    <published>2019-07-05T09:30:35.000Z</published>
    <updated>2019-10-24T09:12:16.884Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>由于<code>kibana</code>界面默认没有安全认证界面，为了保证安全，通过<code>nginx</code>进行代理并设置访问认证。</p></blockquote><h2 id="配置kibana"><a href="#配置kibana" class="headerlink" title="配置kibana"></a>配置kibana</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># vim /etc/kibana/kibana.yml</span></span><br><span class="line"><span class="symbol">server.host:</span> <span class="string">"127.0.0.1"</span>    <span class="comment">#将监听地址更改为127.0.0.1</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># systemctl restart kibana</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># netstat -nlutp |grep 5601</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:</span><span class="number">5601</span>          <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:*</span>               LISTEN      <span class="number">72068</span>/node</span><br></pre></td></tr></table></figure><h2 id="部署nginx"><a href="#部署nginx" class="headerlink" title="部署nginx"></a>部署nginx</h2><p>1）安装<code>nginx</code><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@linux</span>-elk1 ~]<span class="meta"># yum -y install nginx httpd-tools</span></span><br></pre></td></tr></table></figure></p><p>2）配置<code>nginx</code><br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># vim /etc/nginx/conf.d/kibana.conf</span></span><br><span class="line">upstream kibana_server &#123;</span><br><span class="line">    server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">5601</span> weight=<span class="number">1</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">60</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line">    server_name www.kibana.com;</span><br><span class="line">    auth_basic <span class="string">"Restricted Access"</span>;</span><br><span class="line">    auth_basic_user_file /etc/nginx/conf.d/htpasswd.users;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http:<span class="regexp">//kibana</span>_server;</span><br><span class="line">        proxy_http_version <span class="number">1.1</span>;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection <span class="string">'upgrade'</span>;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_cache_bypass $http_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># htpasswd -bc /etc/nginx/conf.d/htpasswd.users admin 123456</span></span><br><span class="line">Adding password <span class="keyword">for</span> user admin</span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># cat /etc/nginx/conf.d/htpasswd.users</span></span><br><span class="line">admin:$apr1$ro5tQZp9$grhByziZtm3ZpZCsSFzsQ1</span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># systemctl start nginx</span></span><br></pre></td></tr></table></figure></p><p>3）<code>windows</code>上添加<code>hosts</code>, 路径<code>C:\Windows\System32\drivers\etc\hosts</code><br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.31</span><span class="selector-tag">www</span><span class="selector-class">.kibana</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure></p><p>4）测试验证<br><img src="/2019/07/05/ELK快速入门五-配置nginx代理kibana/nginx01.png" alt="nginx01.png"><br><img src="/2019/07/05/ELK快速入门五-配置nginx代理kibana/nginx02.png" alt="nginx02.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;由于&lt;code&gt;kibana&lt;/code&gt;界面默认没有安全认证界面，为了保证安全，通过&lt;code&gt;nginx&lt;/code&gt;进行代理并设置访问认证。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;配置kibana&quot;&gt;&lt;a href=&quot;#配置ki
      
    
    </summary>
    
      <category term="ELK" scheme="https://leeyj.coding.me/categories/ELK/"/>
    
    
      <category term="ELK" scheme="https://leeyj.coding.me/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>ELK快速入门四-filebeat替代logstash收集日志</title>
    <link href="https://leeyj.coding.me/2019/07/05/ELK%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%9B%9B-filebeat%E6%9B%BF%E4%BB%A3logstash%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97/"/>
    <id>https://leeyj.coding.me/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/</id>
    <published>2019-07-05T08:30:35.000Z</published>
    <updated>2019-10-24T09:12:16.885Z</updated>
    
    <content type="html"><![CDATA[<h2 id="filebeat简介"><a href="#filebeat简介" class="headerlink" title="filebeat简介"></a>filebeat简介</h2><blockquote><p><code>Filebeat</code>是轻量级单用途的日志收集工具，用于在没有安装java的服务器上专门收集日志，可以将日志转发到<code>logstash</code>、<code>elasticsearch</code>或<code>redis</code>等场景中进行下一步处理。<br>官网下载地址：<a href="https://www.elastic.co/cn/downloads/past-releases#filebeat" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases#filebeat</a><br>官方文档：<a href="https://www.elastic.co/guide/en/beats/filebeat/current/configuring-howto-filebeat.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/configuring-howto-filebeat.html</a></p></blockquote><h2 id="filebeat安装配置"><a href="#filebeat安装配置" class="headerlink" title="filebeat安装配置"></a>filebeat安装配置</h2><p>1）下载<code>filebeat</code><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 这里是在logstash服务器上面做的，为了测试，所以先将logstash停止。</span></span><br><span class="line">[root<span class="symbol">@logstash</span> ~]<span class="meta"># systemctl stop logstash</span></span><br><span class="line">[root<span class="symbol">@logstash</span> ~]<span class="meta"># wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.8.1-x86_64.rpm</span></span><br></pre></td></tr></table></figure></p><p>2）安装<code>filebeat</code><br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@logstash ~]</span># <span class="selector-tag">yum</span> <span class="selector-tag">-y</span> <span class="selector-tag">localinstall</span> <span class="selector-tag">filebeat-6</span><span class="selector-class">.8</span><span class="selector-class">.1-x86_64</span><span class="selector-class">.rpm</span></span><br></pre></td></tr></table></figure></p><h3 id="配置filebeat收集系统日志输出到文件"><a href="#配置filebeat收集系统日志输出到文件" class="headerlink" title="配置filebeat收集系统日志输出到文件"></a>配置filebeat收集系统日志输出到文件</h3><p>1）编辑<code>filebeat</code>配置文件<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@logstash ~]# <span class="keyword">cp</span> /etc/filebeat/filebeat.yml&#123;,.bak&#125;</span><br><span class="line">[root@logstash ~]# <span class="keyword">grep</span> -v <span class="string">"#"</span> /etc/filebeat/filebeat.yml |<span class="keyword">grep</span> -v <span class="string">"^$"</span></span><br><span class="line">filebeat.<span class="built_in">input</span><span class="variable">s:</span></span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span>    # 默认值 <span class="built_in">log</span> ，表示一个日志读取源</span><br><span class="line">  enabled: true    # 该配置是否生效，如果设置为 false 将不会收集该配置的日志</span><br><span class="line">  path<span class="variable">s:</span></span><br><span class="line">    - /var/<span class="built_in">log</span>/<span class="keyword">messages</span>   # 要抓取的日志路径，写绝对路径,可以多个</span><br><span class="line">    - /var/<span class="built_in">log</span>/*.<span class="built_in">log</span></span><br><span class="line">filebeat.config.module<span class="variable">s:</span></span><br><span class="line">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class="line">  reload.enabled: false</span><br><span class="line">setup.template.setting<span class="variable">s:</span></span><br><span class="line">  <span class="built_in">index</span>.number_of_shard<span class="variable">s:</span> <span class="number">3</span></span><br><span class="line">setup.kiban<span class="variable">a:</span></span><br><span class="line">output.<span class="keyword">file</span>:</span><br><span class="line">  path: <span class="string">"/tmp"</span></span><br><span class="line">  filename: <span class="string">"filebeat.txt"</span></span><br><span class="line">processor<span class="variable">s:</span></span><br><span class="line">  - add_host_metadat<span class="variable">a:</span> ~</span><br><span class="line">  - add_cloud_metadat<span class="variable">a:</span> ~</span><br><span class="line"></span><br><span class="line">[root@logstash ~]# systemctl start filebeat</span><br></pre></td></tr></table></figure></p><p>2）测试验证数据<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@logstash ~]<span class="comment"># echo "test" &gt;&gt; /var/log/messages</span></span><br><span class="line"></span><br><span class="line">[root@logstash ~]<span class="comment"># tail /tmp/filebeat.txt </span></span><br><span class="line">&#123;<span class="string">"@timestamp"</span>:<span class="string">"2019-07-11T02:18:10.331Z"</span>,<span class="string">"@metadata"</span>:&#123;<span class="string">"beat"</span>:<span class="string">"filebeat"</span>,<span class="string">"type"</span>:<span class="string">"doc"</span>,<span class="string">"version"</span>:<span class="string">"6.8.1"</span>&#125;,<span class="string">"prospector"</span>:&#123;<span class="string">"type"</span>:<span class="string">"log"</span>&#125;,<span class="string">"input"</span>:&#123;<span class="string">"type"</span>:<span class="string">"log"</span>&#125;,<span class="string">"beat"</span>:&#123;<span class="string">"name"</span>:<span class="string">"logstash"</span>,<span class="string">"hostname"</span>:<span class="string">"logstash"</span>,<span class="string">"version"</span>:<span class="string">"6.8.1"</span>&#125;,<span class="string">"host"</span>:&#123;<span class="string">"architecture"</span>:<span class="string">"x86_64"</span>,<span class="string">"os"</span>:&#123;<span class="string">"platform"</span>:<span class="string">"centos"</span>,<span class="string">"version"</span>:<span class="string">"7 (Core)"</span>,<span class="string">"family"</span>:<span class="string">"redhat"</span>,<span class="string">"name"</span>:<span class="string">"CentOS Linux"</span>,<span class="string">"codename"</span>:<span class="string">"Core"</span>&#125;,<span class="string">"id"</span>:<span class="string">"12bcfdc379904e4eb20173a568ecd7df"</span>,<span class="string">"containerized"</span>:false,<span class="string">"name"</span>:<span class="string">"logstash"</span>&#125;,<span class="string">"source"</span>:<span class="string">"/var/log/messages"</span>,<span class="string">"offset"</span>:<span class="number">53643</span>,<span class="string">"log"</span>:&#123;<span class="string">"file"</span>:&#123;<span class="string">"path"</span>:<span class="string">"/var/log/messages"</span>&#125;&#125;,<span class="string">"message"</span>:<span class="string">"Jul 11 10:18:10 node01 systemd: Stopping Filebeat sends log files to Logstash or directly to Elasticsearch...."</span>&#125;</span><br><span class="line">&#123;<span class="string">"@timestamp"</span>:<span class="string">"2019-07-11T02:18:13.324Z"</span>,<span class="string">"@metadata"</span>:&#123;<span class="string">"beat"</span>:<span class="string">"filebeat"</span>,<span class="string">"type"</span>:<span class="string">"doc"</span>,<span class="string">"version"</span>:<span class="string">"6.8.1"</span>&#125;,<span class="string">"prospector"</span>:&#123;<span class="string">"type"</span>:<span class="string">"log"</span>&#125;,<span class="string">"beat"</span>:&#123;<span class="string">"version"</span>:<span class="string">"6.8.1"</span>,<span class="string">"name"</span>:<span class="string">"logstash"</span>,<span class="string">"hostname"</span>:<span class="string">"logstash"</span>&#125;,<span class="string">"host"</span>:&#123;<span class="string">"name"</span>:<span class="string">"logstash"</span>,<span class="string">"architecture"</span>:<span class="string">"x86_64"</span>,<span class="string">"os"</span>:&#123;<span class="string">"family"</span>:<span class="string">"redhat"</span>,<span class="string">"name"</span>:<span class="string">"CentOS Linux"</span>,<span class="string">"codename"</span>:<span class="string">"Core"</span>,<span class="string">"platform"</span>:<span class="string">"centos"</span>,<span class="string">"version"</span>:<span class="string">"7 (Core)"</span>&#125;,<span class="string">"id"</span>:<span class="string">"12bcfdc379904e4eb20173a568ecd7df"</span>,<span class="string">"containerized"</span>:false&#125;,<span class="string">"log"</span>:&#123;<span class="string">"file"</span>:&#123;<span class="string">"path"</span>:<span class="string">"/var/log/messages"</span>&#125;&#125;,<span class="string">"message"</span>:<span class="string">"Jul 11 10:18:10 node01 systemd: Started Filebeat sends log files to Logstash or directly to Elasticsearch.."</span>,<span class="string">"source"</span>:<span class="string">"/var/log/messages"</span>,<span class="string">"offset"</span>:<span class="number">53754</span>,<span class="string">"input"</span>:&#123;<span class="string">"type"</span>:<span class="string">"log"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"@timestamp"</span>:<span class="string">"2019-07-11T02:18:13.324Z"</span>,<span class="string">"@metadata"</span>:&#123;<span class="string">"beat"</span>:<span class="string">"filebeat"</span>,<span class="string">"type"</span>:<span class="string">"doc"</span>,<span class="string">"version"</span>:<span class="string">"6.8.1"</span>&#125;,<span class="string">"host"</span>:&#123;<span class="string">"architecture"</span>:<span class="string">"x86_64"</span>,<span class="string">"name"</span>:<span class="string">"logstash"</span>,<span class="string">"os"</span>:&#123;<span class="string">"codename"</span>:<span class="string">"Core"</span>,<span class="string">"platform"</span>:<span class="string">"centos"</span>,<span class="string">"version"</span>:<span class="string">"7 (Core)"</span>,<span class="string">"family"</span>:<span class="string">"redhat"</span>,<span class="string">"name"</span>:<span class="string">"CentOS Linux"</span>&#125;,<span class="string">"id"</span>:<span class="string">"12bcfdc379904e4eb20173a568ecd7df"</span>,<span class="string">"containerized"</span>:false&#125;,<span class="string">"source"</span>:<span class="string">"/var/log/messages"</span>,<span class="string">"offset"</span>:<span class="number">53862</span>,<span class="string">"log"</span>:&#123;<span class="string">"file"</span>:&#123;<span class="string">"path"</span>:<span class="string">"/var/log/messages"</span>&#125;&#125;,<span class="string">"message"</span>:<span class="string">"Jul 11 10:18:10 node01 systemd: Starting Filebeat sends log files to Logstash or directly to Elasticsearch...."</span>,<span class="string">"prospector"</span>:&#123;<span class="string">"type"</span>:<span class="string">"log"</span>&#125;,<span class="string">"input"</span>:&#123;<span class="string">"type"</span>:<span class="string">"log"</span>&#125;,<span class="string">"beat"</span>:&#123;<span class="string">"name"</span>:<span class="string">"logstash"</span>,<span class="string">"hostname"</span>:<span class="string">"logstash"</span>,<span class="string">"version"</span>:<span class="string">"6.8.1"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"@timestamp"</span>:<span class="string">"2019-07-11T02:18:48.328Z"</span>,<span class="string">"@metadata"</span>:&#123;<span class="string">"beat"</span>:<span class="string">"filebeat"</span>,<span class="string">"type"</span>:<span class="string">"doc"</span>,<span class="string">"version"</span>:<span class="string">"6.8.1"</span>&#125;,<span class="string">"offset"</span>:<span class="number">53973</span>,<span class="string">"log"</span>:&#123;<span class="string">"file"</span>:&#123;<span class="string">"path"</span>:<span class="string">"/var/log/messages"</span>&#125;&#125;,<span class="string">"message"</span>:<span class="string">"test"</span>,<span class="string">"input"</span>:&#123;<span class="string">"type"</span>:<span class="string">"log"</span>&#125;,<span class="string">"prospector"</span>:&#123;<span class="string">"type"</span>:<span class="string">"log"</span>&#125;,<span class="string">"beat"</span>:&#123;<span class="string">"name"</span>:<span class="string">"logstash"</span>,<span class="string">"hostname"</span>:<span class="string">"logstash"</span>,<span class="string">"version"</span>:<span class="string">"6.8.1"</span>&#125;,<span class="string">"host"</span>:&#123;<span class="string">"name"</span>:<span class="string">"logstash"</span>,<span class="string">"os"</span>:&#123;<span class="string">"version"</span>:<span class="string">"7 (Core)"</span>,<span class="string">"family"</span>:<span class="string">"redhat"</span>,<span class="string">"name"</span>:<span class="string">"CentOS Linux"</span>,<span class="string">"codename"</span>:<span class="string">"Core"</span>,<span class="string">"platform"</span>:<span class="string">"centos"</span>&#125;,<span class="string">"id"</span>:<span class="string">"12bcfdc379904e4eb20173a568ecd7df"</span>,<span class="string">"containerized"</span>:false,<span class="string">"architecture"</span>:<span class="string">"x86_64"</span>&#125;,<span class="string">"source"</span>:<span class="string">"/var/log/messages"</span>&#125;</span><br></pre></td></tr></table></figure></p><h3 id="配置filebeat收集系统日志输出redis"><a href="#配置filebeat收集系统日志输出redis" class="headerlink" title="配置filebeat收集系统日志输出redis"></a>配置filebeat收集系统日志输出redis</h3><p>1）编辑<code>filebeat</code>配置文件，修改输出<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@logstash ~]# <span class="keyword">grep</span> -v <span class="string">"#"</span> /etc/filebeat/filebeat.yml |<span class="keyword">grep</span> -v <span class="string">"^$"</span></span><br><span class="line">filebeat.<span class="built_in">input</span><span class="variable">s:</span></span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  enabled: true</span><br><span class="line">  path<span class="variable">s:</span></span><br><span class="line">    - /var/<span class="built_in">log</span>/<span class="keyword">messages</span></span><br><span class="line">    - /var/<span class="built_in">log</span>/*.<span class="built_in">log</span></span><br><span class="line">filebeat.config.module<span class="variable">s:</span></span><br><span class="line">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class="line">  reload.enabled: false</span><br><span class="line">setup.template.setting<span class="variable">s:</span></span><br><span class="line">  <span class="built_in">index</span>.number_of_shard<span class="variable">s:</span> <span class="number">3</span></span><br><span class="line">setup.kiban<span class="variable">a:</span></span><br><span class="line">output.<span class="keyword">redi</span><span class="variable">s:</span></span><br><span class="line">  host<span class="variable">s:</span> [<span class="string">"192.168.1.30:6379"</span>]    #redis服务器及端口</span><br><span class="line">  key: <span class="string">"system-log-33"</span>    #这里自定义key的名称，为了后期处理</span><br><span class="line">  d<span class="variable">b:</span> <span class="number">1</span>    #使用第几个库</span><br><span class="line">  timeou<span class="variable">t:</span> <span class="number">5</span>    #超时时间</span><br><span class="line">  password: <span class="number">123321</span>    #redis 密码</span><br><span class="line">processor<span class="variable">s:</span></span><br><span class="line">  - add_host_metadat<span class="variable">a:</span> ~</span><br><span class="line">  - add_cloud_metadat<span class="variable">a:</span> ~</span><br><span class="line"></span><br><span class="line">[root@logstash ~]# systemctl restart filebeat</span><br></pre></td></tr></table></figure></p><p>2）验证<code>redis</code>中是否有数据<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@linux-redis ~]</span># <span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">AUTH</span> 123321</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">SELECT</span> 1</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[1]</span>&gt; <span class="selector-tag">KEYS</span> *</span><br><span class="line">1) "<span class="selector-tag">system-log-33</span>"</span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[1]</span>&gt; <span class="selector-tag">LLEN</span> <span class="selector-tag">system-log-33</span></span><br><span class="line">(<span class="selector-tag">integer</span>) 3</span><br></pre></td></tr></table></figure></p><p>3）<code>logstash</code>服务器上面配置从<code>redis</code>服务器中取数据<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># cat /etc/logstash/conf.d/redis-filebeat.conf </span></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">    redis &#123;</span><br><span class="line">        <span class="attr">data_type</span> =&gt; <span class="string">"list"</span></span><br><span class="line">        <span class="attr">host</span> =&gt; <span class="string">"192.168.1.30"</span></span><br><span class="line">        <span class="attr">password</span> =&gt; <span class="string">"123321"</span></span><br><span class="line">        <span class="attr">port</span> =&gt; <span class="string">"6379"</span></span><br><span class="line">        <span class="attr">db</span> =&gt; <span class="string">"1"</span></span><br><span class="line">        <span class="attr">key</span> =&gt; <span class="string">"system-log-33"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        <span class="attr">hosts</span> =&gt; [<span class="string">"192.168.1.31:9200"</span>]</span><br><span class="line">        <span class="attr">index</span> =&gt; <span class="string">"file-systemlog-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>4）输入测试数据到日志文件里<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@logstash ~]# <span class="keyword">echo</span> <span class="string">"11111111111111"</span> &gt;&gt; /var/<span class="built_in">log</span>/<span class="keyword">messages</span></span><br><span class="line">[root@logstash ~]# <span class="keyword">echo</span> <span class="string">"2222222222"</span> &gt;&gt; /var/<span class="built_in">log</span>/<span class="keyword">messages</span></span><br><span class="line">[root@logstash ~]# <span class="keyword">echo</span> <span class="string">"33333333"</span> &gt;&gt; /var/<span class="built_in">log</span>/<span class="keyword">messages</span></span><br></pre></td></tr></table></figure></p><p>5）<code>kibana</code>界面创建索引模式<br><img src="/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file01.png" alt><br><img src="/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file02.png" alt="file02.png"><br>6）验证数据<br><img src="/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file03.png" alt="file03.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;filebeat简介&quot;&gt;&lt;a href=&quot;#filebeat简介&quot; class=&quot;headerlink&quot; title=&quot;filebeat简介&quot;&gt;&lt;/a&gt;filebeat简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;Filebeat&lt;/code&gt;是轻量级
      
    
    </summary>
    
      <category term="ELK" scheme="https://leeyj.coding.me/categories/ELK/"/>
    
    
      <category term="ELK" scheme="https://leeyj.coding.me/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>ELK快速入门三-logstash收集日志写入redis</title>
    <link href="https://leeyj.coding.me/2019/07/05/ELK%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E4%B8%89-logstash%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97%E5%86%99%E5%85%A5redis/"/>
    <id>https://leeyj.coding.me/2019/07/05/ELK快速入门三-logstash收集日志写入redis/</id>
    <published>2019-07-05T07:30:35.000Z</published>
    <updated>2019-10-24T09:12:16.857Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>用一台服务器部署<code>redis</code>服务，专门用于日志缓存使用，一般用于<code>web</code>服务器产生大量日志的场景。</p><p>这里是使用一台专门用于部署<code>redis</code> ，一台专门部署了<code>logstash</code>，在<code>linux-elk1</code>ELK集群上面进行日志收集存到了<code>redis</code>服务器上面，然后通过专门的<code>logstash</code>服务器去<code>redis</code>服务器里面取出数据在放到<code>kibana</code>上面进行展示</p></blockquote><h2 id="部署redis"><a href="#部署redis" class="headerlink" title="部署redis"></a>部署redis</h2><h3 id="下载安装redis"><a href="#下载安装redis" class="headerlink" title="下载安装redis"></a>下载安装redis</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@linux</span>-redis ~]<span class="comment"># wget http://download.redis.io/releases/redis-5.0.0.tar.gz</span></span><br><span class="line">[root<span class="variable">@linux</span>-redis ~]<span class="comment"># tar -xvzf redis-5.0.0.tar.gz</span></span><br><span class="line">[root<span class="variable">@linux</span>-redis ~]<span class="comment"># mv redis-5.0.0 /usr/local/src/</span></span><br><span class="line">[root<span class="variable">@linux</span>-redis ~]<span class="comment"># ln -sv /usr/local/src/redis-5.0.0 /usr/local/redis</span></span><br><span class="line"><span class="string">"/usr/local/redis"</span> -&gt; <span class="string">"/usr/local/src/redis-5.0.0"</span></span><br><span class="line">[root<span class="variable">@linux</span>-redis ~]<span class="comment"># cd /usr/local/redis/</span></span><br><span class="line">[root<span class="variable">@linux</span>-redis ~]<span class="comment"># make distclean</span></span><br><span class="line">[root<span class="variable">@linux</span>-redis ~]<span class="comment"># make</span></span><br></pre></td></tr></table></figure><h3 id="配置redis"><a href="#配置redis" class="headerlink" title="配置redis"></a>配置redis</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@linux</span>-redis redis]<span class="comment"># vim redis.conf</span></span><br><span class="line">daemonize yes</span><br><span class="line">bind <span class="number">192.168</span>.<span class="number">1.30</span></span><br><span class="line">requirepass <span class="number">123321</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@linux</span>-redis redis]<span class="comment"># cp /usr/local/redis/src/redis-server /usr/bin/</span></span><br><span class="line">[root<span class="variable">@linux</span>-redis redis]<span class="comment"># cp /usr/local/redis/src/redis-cli /usr/bin/</span></span><br><span class="line">[root<span class="variable">@linux</span>-redis redis]<span class="comment"># redis-server /usr/local/redis/redis.conf </span></span><br><span class="line"><span class="number">4007</span><span class="symbol">:C</span> <span class="number">10</span> Jul <span class="number">2019</span> <span class="number">12</span><span class="symbol">:</span><span class="number">24</span><span class="symbol">:</span><span class="number">30.367</span> <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line"><span class="number">4007</span><span class="symbol">:C</span> <span class="number">10</span> Jul <span class="number">2019</span> <span class="number">12</span><span class="symbol">:</span><span class="number">24</span><span class="symbol">:</span><span class="number">30.367</span> <span class="comment"># Redis version=5.0.0, bits=64, commit=00000000, modified=0, pid=4007, just started</span></span><br><span class="line"><span class="number">4007</span><span class="symbol">:C</span> <span class="number">10</span> Jul <span class="number">2019</span> <span class="number">12</span><span class="symbol">:</span><span class="number">24</span><span class="symbol">:</span><span class="number">30.367</span> <span class="comment"># Configuration loaded</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@linux</span>-redis redis]<span class="comment"># netstat -nlutp |grep 6379</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span>.<span class="number">1.30</span><span class="symbol">:</span><span class="number">6379</span>       <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:*</span>               LISTEN      <span class="number">4008</span>/redis-server <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="测试redis"><a href="#测试redis" class="headerlink" title="测试redis"></a>测试redis</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@linux-redis redis]</span># <span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">AUTH</span> 123321</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">ping</span></span><br><span class="line"><span class="selector-tag">PONG</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">KEYS</span> *</span><br><span class="line">(<span class="selector-tag">empty</span> <span class="selector-tag">list</span> <span class="selector-tag">or</span> <span class="selector-tag">set</span>)</span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">quit</span></span><br></pre></td></tr></table></figure><h2 id="配置logstash将日志写入redis"><a href="#配置logstash将日志写入redis" class="headerlink" title="配置logstash将日志写入redis"></a>配置logstash将日志写入redis</h2><blockquote><p>将系统日志的通过<code>logstash</code>收集之后写入<code>redis</code>，然后通过另外的<code>logstash</code>将<code>redis</code>服务器的数据取出来。</p></blockquote><h3 id="配置logstash的配置文件"><a href="#配置logstash的配置文件" class="headerlink" title="配置logstash的配置文件"></a>配置logstash的配置文件</h3><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># vim /etc/logstash/conf.d/system.conf</span></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        <span class="attr">path</span> =&gt; <span class="string">"/var/log/messages"</span></span><br><span class="line">        <span class="attr">type</span> =&gt; <span class="string">"systemlog"</span></span><br><span class="line">        <span class="attr">start_position</span> =&gt; <span class="string">"beginning"</span></span><br><span class="line">        <span class="attr">stat_interval</span> =&gt; <span class="string">"2"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"systemlog"</span> &#123;</span><br><span class="line">        redis &#123;</span><br><span class="line">            <span class="attr">data_type</span> =&gt; <span class="string">"list"</span></span><br><span class="line">            <span class="attr">host</span> =&gt; <span class="string">"192.168.1.30"</span></span><br><span class="line">            <span class="attr">password</span> =&gt; <span class="string">"123321"</span></span><br><span class="line">            <span class="attr">port</span> =&gt; <span class="string">"6379"</span></span><br><span class="line">            <span class="attr">db</span> =&gt; <span class="string">"0"</span></span><br><span class="line">            <span class="attr">key</span> =&gt; <span class="string">"systemlog"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="检查logstash配置语法是否正确"><a href="#检查logstash配置语法是否正确" class="headerlink" title="检查logstash配置语法是否正确"></a>检查logstash配置语法是否正确</h3><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf -t</span><br><span class="line"><span class="literal">WARNING</span>: Could <span class="keyword">not</span> find logstash.yml which <span class="keyword">is</span> typically located <span class="keyword">in</span> $LS_HOME/config <span class="keyword">or</span> /etc/logstash. You can specify the path using <span class="comment">--path.settings. Continuing using the defaults</span></span><br><span class="line">Could <span class="keyword">not</span> find log4j2 <span class="keyword">configuration</span> at path /usr/share/logstash/config/log4j2.properties. Using <span class="keyword">default</span> config which logs errors <span class="keyword">to</span> the console</span><br><span class="line">[WARN ] <span class="number">2019</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">46.324</span> [LogStash::Runner] multilocal - Ignoring the <span class="symbol">'pipelines</span>.yml' <span class="keyword">file</span> because modules <span class="keyword">or</span> command <span class="literal">line</span> options are specified</span><br><span class="line"><span class="keyword">Configuration</span> OK</span><br><span class="line"></span><br><span class="line">[root@linux-elk1 ~]# systemctl restart logstash</span><br></pre></td></tr></table></figure><h3 id="写入messages日志测试"><a href="#写入messages日志测试" class="headerlink" title="写入messages日志测试"></a>写入messages日志测试</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]# <span class="keyword">echo</span> <span class="string">"redis-test"</span> &gt;&gt; /var/<span class="built_in">log</span>/<span class="keyword">messages</span></span><br><span class="line">[root@linux-elk1 ~]# <span class="keyword">echo</span> <span class="string">"systemlog"</span> &gt;&gt; /var/<span class="built_in">log</span>/<span class="keyword">messages</span></span><br></pre></td></tr></table></figure><h3 id="登录redis进行查看"><a href="#登录redis进行查看" class="headerlink" title="登录redis进行查看"></a>登录redis进行查看</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@linux-redis ~]</span># <span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">AUTH</span> 123321</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">SELECT</span> 0</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">KEYS</span> *</span><br><span class="line">1) "<span class="selector-tag">systemlog</span>"</span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">LLEN</span> <span class="selector-tag">systemlog</span></span><br><span class="line">(<span class="selector-tag">integer</span>) 126</span><br></pre></td></tr></table></figure><h2 id="配置logstash从redis中取出数据到elasticsearch"><a href="#配置logstash从redis中取出数据到elasticsearch" class="headerlink" title="配置logstash从redis中取出数据到elasticsearch"></a>配置logstash从redis中取出数据到elasticsearch</h2><blockquote><p>配置专门<code>logstash</code>服务器从<code>redis</code>服务器读取指定的<code>key</code>的数据，并写入到<code>elasticsearch</code></p></blockquote><h3 id="编辑logstash配置文件"><a href="#编辑logstash配置文件" class="headerlink" title="编辑logstash配置文件"></a>编辑logstash配置文件</h3><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@logstash ~]<span class="comment"># vim /etc/logstash/conf.d/redis-read.conf</span></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">    redis &#123;</span><br><span class="line">        <span class="attr">data_type</span> =&gt; <span class="string">"list"</span></span><br><span class="line">        <span class="attr">host</span> =&gt; <span class="string">"192.168.1.30"</span></span><br><span class="line">        <span class="attr">password</span> =&gt; <span class="string">"123321"</span></span><br><span class="line">        <span class="attr">port</span> =&gt; <span class="string">"6379"</span></span><br><span class="line">        <span class="attr">db</span> =&gt; <span class="string">"0"</span></span><br><span class="line">        <span class="attr">key</span> =&gt; <span class="string">"systemlog"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        <span class="attr">hosts</span> =&gt; [<span class="string">"192.168.1.31:9200"</span>]</span><br><span class="line">        <span class="attr">index</span> =&gt; <span class="string">"redis-systemlog-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试logstash配置是否正确"><a href="#测试logstash配置是否正确" class="headerlink" title="测试logstash配置是否正确"></a>测试logstash配置是否正确</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@logstash</span> ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-read.conf -t</span></span><br><span class="line">OpenJDK <span class="number">64</span>-Bit Server VM <span class="symbol">warning:</span> If the number of processors is expected to increase from one, <span class="keyword">then</span> you should configure the number of parallel GC threads appropriately using -<span class="symbol">XX:</span>ParallelGCThreads=N</span><br><span class="line"><span class="symbol">WARNING:</span> Could <span class="keyword">not</span> find logstash.yml which is typically located <span class="keyword">in</span> <span class="variable">$LS_HOME</span>/config <span class="keyword">or</span> /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could <span class="keyword">not</span> find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class="line">[INFO ] <span class="number">2019</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">16</span><span class="symbol">:</span><span class="number">41</span><span class="symbol">:</span><span class="number">50.576</span> [main] writabledirectory - Creating directory &#123;<span class="symbol">:setting=&gt;<span class="string">"path.queue"</span></span>, <span class="symbol">:path=&gt;<span class="string">"/usr/share/logstash/data/queue"</span></span>&#125;</span><br><span class="line">[INFO ] <span class="number">2019</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">16</span><span class="symbol">:</span><span class="number">41</span><span class="symbol">:</span><span class="number">50.649</span> [main] writabledirectory - Creating directory &#123;<span class="symbol">:setting=&gt;<span class="string">"path.dead_letter_queue"</span></span>, <span class="symbol">:path=&gt;<span class="string">"/usr/share/logstash/data/dead_letter_queue"</span></span>&#125;</span><br><span class="line">[WARN ] <span class="number">2019</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">16</span><span class="symbol">:</span><span class="number">41</span><span class="symbol">:</span><span class="number">51.498</span> [LogStash::Runner] multilocal - Ignoring the <span class="string">'pipelines.yml'</span> file because modules <span class="keyword">or</span> command line options are specified</span><br><span class="line">Configuration OK</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@logstash</span> ~]<span class="comment"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure><h3 id="验证redis的数据是否被取出"><a href="#验证redis的数据是否被取出" class="headerlink" title="验证redis的数据是否被取出"></a>验证redis的数据是否被取出</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@linux-redis ~]</span># <span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">AUTH</span> 123321</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">SELECT</span> 0</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">KEYS</span> *</span><br><span class="line">(<span class="selector-tag">empty</span> <span class="selector-tag">list</span> <span class="selector-tag">or</span> <span class="selector-tag">set</span>)     #这里数据已经为空</span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">SELECT</span> 1</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.30</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[1]</span>&gt; <span class="selector-tag">KEYS</span> *</span><br><span class="line">(<span class="selector-tag">empty</span> <span class="selector-tag">list</span> <span class="selector-tag">or</span> <span class="selector-tag">set</span>)     #这里数据已经为空</span><br></pre></td></tr></table></figure><h3 id="head插件上验证数据"><a href="#head插件上验证数据" class="headerlink" title="head插件上验证数据"></a>head插件上验证数据</h3><p><img src="/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis01.png" alt="redis01.png"></p><h3 id="kibana界面创建索引模式并查看数据"><a href="#kibana界面创建索引模式并查看数据" class="headerlink" title="kibana界面创建索引模式并查看数据"></a>kibana界面创建索引模式并查看数据</h3><p><img src="/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis02.png" alt="redis02.png"><br><img src="/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis03.png" alt="redis03.png"><br><img src="/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis04.png" alt="redis04.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;用一台服务器部署&lt;code&gt;redis&lt;/code&gt;服务，专门用于日志缓存使用，一般用于&lt;code&gt;web&lt;/code&gt;服务器产生大量日志的场景。&lt;/p&gt;
&lt;p&gt;这里是使用一台专门用于部署&lt;code&gt;redis&lt;/code&gt; ，一台专门部署了&lt;co
      
    
    </summary>
    
      <category term="ELK" scheme="https://leeyj.coding.me/categories/ELK/"/>
    
    
      <category term="ELK" scheme="https://leeyj.coding.me/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>ELK快速入门二-通过logstash收集日志</title>
    <link href="https://leeyj.coding.me/2019/07/05/ELK%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E4%BA%8C-%E9%80%9A%E8%BF%87logstash%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97/"/>
    <id>https://leeyj.coding.me/2019/07/05/ELK快速入门二-通过logstash收集日志/</id>
    <published>2019-07-05T06:30:35.000Z</published>
    <updated>2019-10-24T09:12:16.862Z</updated>
    
    <content type="html"><![CDATA[<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><blockquote><p>这里的环境接着上面的ELK快速入门-基本部署文章继续下面的操作。</p></blockquote><h2 id="收集多个日志文件"><a href="#收集多个日志文件" class="headerlink" title="收集多个日志文件"></a>收集多个日志文件</h2><p>1）<code>logstash</code>配置文件编写<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># vim /etc/logstash/conf.d/system-log.conf</span></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        <span class="attr">path</span> =&gt; <span class="string">"/var/log/messages"</span></span><br><span class="line">        <span class="attr">type</span> =&gt; <span class="string">"systemlog"</span></span><br><span class="line">        <span class="attr">start_position</span> =&gt; <span class="string">"beginning"</span></span><br><span class="line">        <span class="attr">stat_interval</span> =&gt; <span class="string">"3"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">file</span> &#123;</span><br><span class="line">        <span class="attr">path</span> =&gt; <span class="string">"/var/log/secure"</span></span><br><span class="line">        <span class="attr">type</span> =&gt; <span class="string">"securelog"</span></span><br><span class="line">        <span class="attr">start_position</span> =&gt; <span class="string">"beginning"</span></span><br><span class="line">        <span class="attr">stat_interval</span> =&gt; <span class="string">"3"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"systemlog"</span> &#123; </span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            <span class="attr">hosts</span> =&gt; [<span class="string">"192.168.1.31:9200"</span>]</span><br><span class="line">            <span class="attr">index</span> =&gt; <span class="string">"system-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if [type] == <span class="string">"securelog"</span> &#123; </span><br><span class="line">        <span class="keyword">elasticsearch</span> &#123;</span><br><span class="line">            <span class="attr">hosts</span> =&gt; [<span class="string">"192.168.1.31:9200"</span>]</span><br><span class="line">            <span class="attr">index</span> =&gt; <span class="string">"secure-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2）给日志文件赋予可读权限并重启<code>logstash</code><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@linux</span>-elk1 ~]<span class="meta"># chmod 644 /var/log/secure </span></span><br><span class="line">[root<span class="symbol">@linux</span>-elk1 ~]<span class="meta"># chmod 644 /var/log/messages</span></span><br><span class="line">[root<span class="symbol">@linux</span>-elk1 ~]<span class="meta"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>3）向被收集的文件中写入数据；是为了马上能在<code>elasticsearch</code>的<code>web</code>界面和<code>klbana</code>的<code>web</code>界面里面查看到数据。<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]# <span class="keyword">echo</span> <span class="string">"test"</span> &gt;&gt; /var/<span class="built_in">log</span>/secure </span><br><span class="line">[root@linux-elk1 ~]# <span class="keyword">echo</span> <span class="string">"test"</span> &gt;&gt; /var/<span class="built_in">log</span>/<span class="keyword">messages</span></span><br></pre></td></tr></table></figure></p><p>4）在<code>kibana</code>界面添加<code>system-log</code>索引模式<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log01.png" alt="log01.png"><br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log02.png" alt="log02.png"><br>5）在<code>kibana</code>界面添加<code>secure-log</code>索引模式<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log03.png" alt="log03.png"><br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log04.png" alt="log04.png"><br>6）<code>kibana</code>查看日志<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log05.png" alt="log05.png"></p><h2 id="收集tomcat和java日志"><a href="#收集tomcat和java日志" class="headerlink" title="收集tomcat和java日志"></a>收集tomcat和java日志</h2><blockquote><p>收集<code>Tomcat</code>服务器的访问日志以及<code>Tomcat</code>错误日志进行实时统计，在<code>kibana</code>页面进行搜索展示，每台<code>Tomcat</code>服务器需要安装<code>logstash</code>负责收集日志，然后将日志发给<code>elasticsearch</code>进行分析，在通过<code>kibana</code>在前端展示。</p></blockquote><h3 id="部署tomcat服务"><a href="#部署tomcat服务" class="headerlink" title="部署tomcat服务"></a>部署tomcat服务</h3><blockquote><p>说明，我这里在<code>linux-elk2</code>节点上面装<code>tomcat</code></p></blockquote><p>1）下载并安装<code>tomcat</code><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@linux</span>-elk2 ~]<span class="meta"># cd /usr/local/</span></span><br><span class="line">[root<span class="symbol">@linux</span>-elk2 <span class="keyword">local</span>]<span class="meta"># wget http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-9/v9.0.21/bin/apache-tomcat-9.0.21.tar.gz</span></span><br><span class="line">[root<span class="symbol">@linux</span>-elk2 <span class="keyword">local</span>]<span class="meta"># tar xvzf apache-tomcat-9.0.21.tar.gz</span></span><br><span class="line">[root<span class="symbol">@linux</span>-elk2 <span class="keyword">local</span>]<span class="meta"># ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat</span></span><br></pre></td></tr></table></figure></p><p>2）测试页面准备<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@linux</span>-elk2 <span class="keyword">local</span>]<span class="meta"># cd /usr/local/tomcat/webapps/</span></span><br><span class="line">[root<span class="symbol">@linux</span>-elk2 webapps]<span class="meta"># mkdir webdir</span></span><br><span class="line">[root<span class="symbol">@linux</span>-elk2 webapps]<span class="meta"># echo <span class="string">"&lt;h1&gt;Welcome to Tomcat&lt;/h1&gt;"</span>  &gt; /usr/local/tomcat/webapps/webdir/index.html</span></span><br></pre></td></tr></table></figure></p><p>3）<code>tomcat</code>日志转<code>json</code><br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk2 tomcat]<span class="meta"># vim /usr/local/tomcat/conf/server.xml</span></span><br><span class="line">        <span class="params">&lt;Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"</span></span><br><span class="line"><span class="params">               prefix="localhost_access_log" suffix=".txt"</span></span><br><span class="line"><span class="params">               pattern="&#123;<span class="variable">&amp;quot</span>;clientip<span class="variable">&amp;quot</span>;:<span class="variable">&amp;quot</span>;%h<span class="variable">&amp;quot</span>;,<span class="variable">&amp;quot</span>;ClientUser<span class="variable">&amp;quot</span>;:<span class="variable">&amp;quot</span>;%l<span class="variable">&amp;quot</span>;,<span class="variable">&amp;quot</span>;authenticated<span class="variable">&amp;quot</span>;:<span class="variable">&amp;quot</span>;%u<span class="variable">&amp;quot</span>;,<span class="variable">&amp;quot</span>;AccessTime<span class="variable">&amp;quot</span>;:<span class="variable">&amp;quot</span>;%t<span class="variable">&amp;quot</span>;,<span class="variable">&amp;quot</span>;method<span class="variable">&amp;quot</span>;:<span class="variable">&amp;quot</span>;%r<span class="variable">&amp;quot</span>;,<span class="variable">&amp;quot</span>;status<span class="variable">&amp;quot</span>;:<span class="variable">&amp;quot</span>;%s<span class="variable">&amp;quot</span>;,<span class="variable">&amp;quot</span>;SendBytes<span class="variable">&amp;quot</span>;:<span class="variable">&amp;quot</span>;%b<span class="variable">&amp;quot</span>;,<span class="variable">&amp;quot</span>;Query?string<span class="variable">&amp;quot</span>;:<span class="variable">&amp;quot</span>;%q<span class="variable">&amp;quot</span>;,<span class="variable">&amp;quot</span>;partner<span class="variable">&amp;quot</span>;:<span class="variable">&amp;quot</span>;%&#123;Referer&#125;i<span class="variable">&amp;quot</span>;,<span class="variable">&amp;quot</span>;AgentVersion<span class="variable">&amp;quot</span>;:<span class="variable">&amp;quot</span>;%&#123;User-Agent&#125;i<span class="variable">&amp;quot</span>;&#125;"/&gt;</span></span><br></pre></td></tr></table></figure></p><p>4）启动<code>tomcat</code>，并进行访问测试生成日志<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@linux-elk2 tomcat]</span># /usr/local/tomcat/bin/startup.sh</span><br><span class="line"><span class="string">[root@linux-elk2 tomcat]</span># ss -nlt |grep <span class="number">8080</span></span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>         :::<span class="number">8080</span>                    :::*</span><br><span class="line"><span class="string">[root@linux-elk2 tomcat]</span># ab -n100 -c100 http://<span class="number">192.168.1.32:8080</span>/webdir/</span><br><span class="line"></span><br><span class="line"><span class="string">[root@linux-elk2 ~]</span># tailf /usr/local/tomcat/logs/localhost_access_log.<span class="number">2019</span>-<span class="number">07</span>-<span class="number">05</span>.log </span><br><span class="line">&#123;<span class="string">"clientip"</span>:<span class="string">"192.168.1.32"</span>,<span class="string">"ClientUser"</span>:<span class="string">"-"</span>,<span class="string">"authenticated"</span>:<span class="string">"-"</span>,<span class="string">"AccessTime"</span>:<span class="string">"[05/Jul/2019:16:39:18 +0800]"</span>,<span class="string">"method"</span>:<span class="string">"<span class="keyword">GET</span> /webdir/ HTTP/1.0"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>,<span class="string">"SendBytes"</span>:<span class="string">"27"</span>,<span class="string">"Query?string"</span>:<span class="string">""</span>,<span class="string">"partner"</span>:<span class="string">"-"</span>,<span class="string">"AgentVersion"</span>:<span class="string">"ApacheBench/2.3"</span>&#125;</span><br><span class="line">&#123;<span class="string">"clientip"</span>:<span class="string">"192.168.1.32"</span>,<span class="string">"ClientUser"</span>:<span class="string">"-"</span>,<span class="string">"authenticated"</span>:<span class="string">"-"</span>,<span class="string">"AccessTime"</span>:<span class="string">"[05/Jul/2019:16:39:18 +0800]"</span>,<span class="string">"method"</span>:<span class="string">"<span class="keyword">GET</span> /webdir/ HTTP/1.0"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>,<span class="string">"SendBytes"</span>:<span class="string">"27"</span>,<span class="string">"Query?string"</span>:<span class="string">""</span>,<span class="string">"partner"</span>:<span class="string">"-"</span>,<span class="string">"AgentVersion"</span>:<span class="string">"ApacheBench/2.3"</span>&#125;</span><br><span class="line">&#123;<span class="string">"clientip"</span>:<span class="string">"192.168.1.32"</span>,<span class="string">"ClientUser"</span>:<span class="string">"-"</span>,<span class="string">"authenticated"</span>:<span class="string">"-"</span>,<span class="string">"AccessTime"</span>:<span class="string">"[05/Jul/2019:16:39:18 +0800]"</span>,<span class="string">"method"</span>:<span class="string">"<span class="keyword">GET</span> /webdir/ HTTP/1.0"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>,<span class="string">"SendBytes"</span>:<span class="string">"27"</span>,<span class="string">"Query?string"</span>:<span class="string">""</span>,<span class="string">"partner"</span>:<span class="string">"-"</span>,<span class="string">"AgentVersion"</span>:<span class="string">"ApacheBench/2.3"</span>&#125;</span><br><span class="line">&#123;<span class="string">"clientip"</span>:<span class="string">"192.168.1.32"</span>,<span class="string">"ClientUser"</span>:<span class="string">"-"</span>,<span class="string">"authenticated"</span>:<span class="string">"-"</span>,<span class="string">"AccessTime"</span>:<span class="string">"[05/Jul/2019:16:39:18 +0800]"</span>,<span class="string">"method"</span>:<span class="string">"<span class="keyword">GET</span> /webdir/ HTTP/1.0"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>,<span class="string">"SendBytes"</span>:<span class="string">"27"</span>,<span class="string">"Query?string"</span>:<span class="string">""</span>,<span class="string">"partner"</span>:<span class="string">"-"</span>,<span class="string">"AgentVersion"</span>:<span class="string">"ApacheBench/2.3"</span>&#125;</span><br><span class="line">&#123;<span class="string">"clientip"</span>:<span class="string">"192.168.1.32"</span>,<span class="string">"ClientUser"</span>:<span class="string">"-"</span>,<span class="string">"authenticated"</span>:<span class="string">"-"</span>,<span class="string">"AccessTime"</span>:<span class="string">"[05/Jul/2019:16:39:18 +0800]"</span>,<span class="string">"method"</span>:<span class="string">"<span class="keyword">GET</span> /webdir/ HTTP/1.0"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>,<span class="string">"SendBytes"</span>:<span class="string">"27"</span>,<span class="string">"Query?string"</span>:<span class="string">""</span>,<span class="string">"partner"</span>:<span class="string">"-"</span>,<span class="string">"AgentVersion"</span>:<span class="string">"ApacheBench/2.3"</span>&#125;</span><br><span class="line">&#123;<span class="string">"clientip"</span>:<span class="string">"192.168.1.32"</span>,<span class="string">"ClientUser"</span>:<span class="string">"-"</span>,<span class="string">"authenticated"</span>:<span class="string">"-"</span>,<span class="string">"AccessTime"</span>:<span class="string">"[05/Jul/2019:16:39:18 +0800]"</span>,<span class="string">"method"</span>:<span class="string">"<span class="keyword">GET</span> /webdir/ HTTP/1.0"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>,<span class="string">"SendBytes"</span>:<span class="string">"27"</span>,<span class="string">"Query?string"</span>:<span class="string">""</span>,<span class="string">"partner"</span>:<span class="string">"-"</span>,<span class="string">"AgentVersion"</span>:<span class="string">"ApacheBench/2.3"</span>&#125;</span><br><span class="line">&#123;<span class="string">"clientip"</span>:<span class="string">"192.168.1.32"</span>,<span class="string">"ClientUser"</span>:<span class="string">"-"</span>,<span class="string">"authenticated"</span>:<span class="string">"-"</span>,<span class="string">"AccessTime"</span>:<span class="string">"[05/Jul/2019:16:39:18 +0800]"</span>,<span class="string">"method"</span>:<span class="string">"<span class="keyword">GET</span> /webdir/ HTTP/1.0"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>,<span class="string">"SendBytes"</span>:<span class="string">"27"</span>,<span class="string">"Query?string"</span>:<span class="string">""</span>,<span class="string">"partner"</span>:<span class="string">"-"</span>,<span class="string">"AgentVersion"</span>:<span class="string">"ApacheBench/2.3"</span>&#125;</span><br><span class="line">&#123;<span class="string">"clientip"</span>:<span class="string">"192.168.1.32"</span>,<span class="string">"ClientUser"</span>:<span class="string">"-"</span>,<span class="string">"authenticated"</span>:<span class="string">"-"</span>,<span class="string">"AccessTime"</span>:<span class="string">"[05/Jul/2019:16:39:18 +0800]"</span>,<span class="string">"method"</span>:<span class="string">"<span class="keyword">GET</span> /webdir/ HTTP/1.0"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>,<span class="string">"SendBytes"</span>:<span class="string">"27"</span>,<span class="string">"Query?string"</span>:<span class="string">""</span>,<span class="string">"partner"</span>:<span class="string">"-"</span>,<span class="string">"AgentVersion"</span>:<span class="string">"ApacheBench/2.3"</span>&#125;</span><br></pre></td></tr></table></figure></p><p>5）验证日志是否为<code>json</code>格式，<a href="http://www.kjson.com/" target="_blank" rel="noopener">http://www.kjson.com/</a><br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log06.png" alt="log06.png"></p><h3 id="配置logstash收集tomcat日志"><a href="#配置logstash收集tomcat日志" class="headerlink" title="配置logstash收集tomcat日志"></a>配置logstash收集tomcat日志</h3><blockquote><p>说明：如果是需要收集别的服务器上面的<code>tomcat</code>日志，那么在所需要收集的服务器上面都得安装<code>logstash</code>。此处是在<code>linux-elk2</code>节点上面部署的<code>tomcat</code>，之前安装过<code>logstash</code>。</p></blockquote><p>1）配置<code>logstash</code><br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk2 ~]<span class="comment"># vim /etc/logstash/conf.d/tomcat.conf</span></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        <span class="attr">path</span> =&gt; <span class="string">"/usr/local/tomcat/logs/localhost_access_log.*.log"</span></span><br><span class="line">        <span class="attr">type</span> =&gt; <span class="string">"tomcat-access-log"</span></span><br><span class="line">        <span class="attr">start_position</span> =&gt; <span class="string">"beginning"</span></span><br><span class="line">        <span class="attr">stat_interval</span> =&gt; <span class="string">"2"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        <span class="attr">hosts</span> =&gt; [<span class="string">"192.168.1.31:9200"</span>]</span><br><span class="line">        <span class="attr">index</span> =&gt; <span class="string">"logstash-tomcat-132-accesslog-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">file</span> &#123;</span><br><span class="line">        <span class="attr">path</span> =&gt; <span class="string">"/tmp/logstash-tomcat-132-accesslog-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2）检测配置文件语法，并重启<code>logstash</code><br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tomcat.conf -tWARNING: Could <span class="keyword">not</span> <span class="built_in">find</span> logstash.yml which is typically located in $LS_HOME/<span class="built_in">config</span> <span class="keyword">or</span> /etc/logstash. You can specify the path <span class="keyword">using</span> --path.settings. Continuing <span class="keyword">using</span> the defaults</span><br><span class="line">Could <span class="keyword">not</span> <span class="built_in">find</span> log4j2 configuration at path /usr/share/logstash/<span class="built_in">config</span>/log4j2.properties. Using <span class="built_in">default</span> <span class="built_in">config</span> which logs errors to the console</span><br><span class="line">[WARN ] <span class="number">2019</span><span class="number">-07</span><span class="number">-05</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">34.583</span> [LogStash::Runner] multilocal - Ignoring the <span class="string">'pipelines.yml'</span> file because modules <span class="keyword">or</span> command <span class="built_in">line</span> options are specified</span><br><span class="line">Configuration OK</span><br><span class="line"></span><br><span class="line">[root@linux-elk2 ~]# /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd</span><br><span class="line">[root@linux-elk2 ~]<span class="meta"># systemctl start logstash</span></span><br></pre></td></tr></table></figure></p><p>3）权限修改，不然<code>elasticsearch</code>界面和<code>kibana</code>界面是无法查看到的<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk2 ~]<span class="comment"># ll /usr/local/tomcat/logs/ -d</span></span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 197 </span>7月  <span class="number"> 5 </span>16:36 /usr/local/tomcat/logs/</span><br><span class="line">[root@linux-elk2 ~]<span class="comment"># ll /usr/local/tomcat/logs/</span></span><br><span class="line">总用量 64</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>root root<span class="number"> 14228 </span>7月  <span class="number"> 5 </span>16:36 catalina.2019-07-05.log</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>root root<span class="number"> 14228 </span>7月  <span class="number"> 5 </span>16:36 catalina.out</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>root root    <span class="number"> 0 </span>7月  <span class="number"> 5 </span>16:25 host-manager.2019-07-05.log</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>root root <span class="number"> 1074 </span>7月  <span class="number"> 5 </span>16:36 localhost.2019-07-05.log</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>root root<span class="number"> 26762 </span>7月  <span class="number"> 5 </span>17:23 localhost_access_log.2019-07-05.log</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>root root    <span class="number"> 0 </span>7月  <span class="number"> 5 </span>16:25 manager.2019-07-05.log</span><br><span class="line">[root@linux-elk2 ~]<span class="comment"># chown logstash.logstash /usr/local/tomcat/logs/ -R</span></span><br><span class="line">[root@linux-elk2 ~]<span class="comment"># ll /usr/local/tomcat/logs/</span></span><br><span class="line">总用量 64</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>logstash logstash<span class="number"> 14228 </span>7月  <span class="number"> 5 </span>16:36 catalina.2019-07-05.log</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>logstash logstash<span class="number"> 14228 </span>7月  <span class="number"> 5 </span>16:36 catalina.out</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>logstash logstash    <span class="number"> 0 </span>7月  <span class="number"> 5 </span>16:25 host-manager.2019-07-05.log</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>logstash logstash <span class="number"> 1074 </span>7月  <span class="number"> 5 </span>16:36 localhost.2019-07-05.log</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>logstash logstash<span class="number"> 26762 </span>7月  <span class="number"> 5 </span>17:23 localhost_access_log.2019-07-05.log</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>logstash logstash    <span class="number"> 0 </span>7月  <span class="number"> 5 </span>16:25 manager.2019-07-05.log</span><br></pre></td></tr></table></figure></p><p>4）访问<code>elasticsearch</code>界面验证插件<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log07.png" alt="log07.png"><br>数据浏览<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log08.png" alt="log08.png"></p><p>5）在<code>kibana</code>上添加索引模式<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log09.png" alt="log09.png"><br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log10.png" alt="log10.png"><br>6）<code>kibana</code>验证数据<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log11.png" alt="log11.png"></p><h3 id="配置logstash收集java日志"><a href="#配置logstash收集java日志" class="headerlink" title="配置logstash收集java日志"></a>配置logstash收集java日志</h3><blockquote><p>使用codec的multiline插件实现多行匹配，这是一个可以将多行进行合并的插件，而且可以使用what指定将匹配到的行与前面的行合并还是和后面的行合并，<a href="https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html</a></p></blockquote><p>语法格式：<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">    stdin &#123;</span><br><span class="line">        <span class="attr">codec</span> =&gt; multiline &#123;</span><br><span class="line">            <span class="attr">pattern</span> =&gt; <span class="string">"^\["</span>    <span class="comment">#当遇到[开头的行时候将多行进行合并</span></span><br><span class="line">            <span class="attr">negate</span> =&gt; <span class="keyword">true</span>      <span class="comment">#true为匹配成功进行操作，false为不成功进行操</span></span><br><span class="line">            <span class="attr">what</span> =&gt; <span class="string">"previous"</span>  <span class="comment">#与上面的行合并，如果是下面的行合并就是</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>命令行测试输入输出：<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -e 'input &#123; stdin &#123; codec =&gt; multiline &#123; <span class="built_in">pattern</span> =&gt; <span class="string">"^\["</span> negate =&gt; true what =&gt; <span class="string">"previous"</span> &#125; &#125; &#125; output &#123; stdout &#123; codec =&gt; rubydebug &#125;&#125;'</span><br><span class="line">WARNING: Could not find logstash.yml which is typically located <span class="built_in">in</span> $LS_HOME/config or /etc/logstash. You can specify the path <span class="built_in">using</span> --path.settings. Continuing <span class="built_in">using</span> the defaults</span><br><span class="line">Could not find log4j2 configuration <span class="built_in">at</span> path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class="line">[WARN ] <span class="number">2019</span><span class="number">-07</span><span class="number">-08</span> <span class="number">15</span>:<span class="number">28</span>:<span class="number">04.938</span> [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified</span><br><span class="line">[INFO ] <span class="number">2019</span><span class="number">-07</span><span class="number">-08</span> <span class="number">15</span>:<span class="number">28</span>:<span class="number">04.968</span> [LogStash::Runner] runner - Starting Logstash &#123;<span class="string">"logstash.version"</span>=&gt;<span class="string">"6.8.1"</span>&#125;</span><br><span class="line">[INFO ] <span class="number">2019</span><span class="number">-07</span><span class="number">-08</span> <span class="number">15</span>:<span class="number">28</span>:<span class="number">19.167</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Starting pipeline &#123;:pipeline_id=&gt;<span class="string">"main"</span>, <span class="string">"pipeline.workers"</span>=&gt;<span class="number">1</span>, <span class="string">"pipeline.batch.size"</span>=&gt;<span class="number">125</span>, <span class="string">"pipeline.batch.delay"</span>=&gt;<span class="number">50</span>&#125;</span><br><span class="line">[INFO ] <span class="number">2019</span><span class="number">-07</span><span class="number">-08</span> <span class="number">15</span>:<span class="number">28</span>:<span class="number">19.918</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Pipeline started successfully &#123;:pipeline_id=&gt;<span class="string">"main"</span>, :thread=&gt;<span class="string">"#&lt;Thread:0xc8dd9a1 run&gt;"</span>&#125;</span><br><span class="line">The stdin plugin is now waiting <span class="keyword">for</span> input:</span><br><span class="line"><span class="number">111111</span></span><br><span class="line"><span class="number">222222</span></span><br><span class="line">aaaaaa</span><br><span class="line">[<span class="number">44444</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2019</span><span class="number">-07</span><span class="number">-08</span>T07:<span class="number">34</span>:<span class="number">48.063</span>Z,</span><br><span class="line">          <span class="string">"tags"</span> =&gt; [</span><br><span class="line">        [<span class="number">0</span>] <span class="string">"multiline"</span></span><br><span class="line">    ],</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"[12\n111111\n222222\naaaaaa"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"linux-elk2.exmaple.com"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">444444</span></span><br><span class="line">aaaaaa</span><br><span class="line">[<span class="number">77777</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2019</span><span class="number">-07</span><span class="number">-08</span>T07:<span class="number">35</span>:<span class="number">51.522</span>Z,</span><br><span class="line">          <span class="string">"tags"</span> =&gt; [</span><br><span class="line">        [<span class="number">0</span>] <span class="string">"multiline"</span></span><br><span class="line">    ],</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"[44444\n444444\naaaaaa"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"linux-elk2.exmaple.com"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>示例：收集ELK集群日志</strong><br>1）观察日志文件，<code>elk</code>集群日志都是以<code>&quot;[&quot;</code>开头并且每一个信息都是如此。<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk2 ~]# tailf /elk/logs/ELK-Cluster.log </span><br><span class="line">[<span class="string">2019-07-08T11:26:37,774</span>][<span class="symbol">INFO </span>][<span class="string">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class="emphasis">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class="line">[<span class="string">2019-07-08T11:26:47,664</span>][<span class="symbol">INFO </span>][<span class="string">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class="emphasis">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class="line">[<span class="string">2019-07-08T11:33:55,150</span>][<span class="symbol">INFO </span>][<span class="string">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class="emphasis">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class="line">[<span class="string">2019-07-08T11:33:55,197</span>][<span class="symbol">INFO </span>][<span class="string">o.e.c.m.MetaDataMappingService</span>] [elk-node2] [.kibana<span class="emphasis">_1/yRee-8HYS8KiVwnuADXAbA] update_</span>mapping [doc]</span><br><span class="line">[<span class="string">2019-07-08T11:33:55,822</span>][<span class="symbol">INFO </span>][<span class="string">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class="emphasis">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class="line">[<span class="string">2019-07-08T11:33:55,905</span>][<span class="symbol">INFO </span>][<span class="string">o.e.c.m.MetaDataMappingService</span>] [elk-node2] [.kibana<span class="emphasis">_1/yRee-8HYS8KiVwnuADXAbA] update_</span>mapping [doc]</span><br><span class="line">[<span class="string">2019-07-08T11:33:57,026</span>][<span class="symbol">INFO </span>][<span class="string">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class="emphasis">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class="line">[<span class="string">2019-07-08T11:43:20,262</span>][<span class="symbol">WARN </span>][<span class="string">o.e.m.j.JvmGcMonitorService</span>] [<span class="string">elk-node2</span>] [<span class="string">gc</span>][<span class="symbol">young</span>][<span class="string">8759</span>][<span class="symbol">66</span>] duration [1.3s], collections [1]/[1.7s], total [1.3s]/[4s], memory [176mb]-&gt;[111.6mb]/[1.9gb], all_pools &#123;[young] [64.8mb]-&gt;[706.4kb]/[66.5mb]&#125;&#123;[survivor] [3.3mb]-&gt;[3mb]/[8.3mb]&#125;&#123;[old] [107.8mb]-&gt;[107.8mb]/[1.9gb]&#125;</span><br><span class="line">[<span class="string">2019-07-08T11:43:20,388</span>][<span class="symbol">WARN </span>][<span class="string">o.e.m.j.JvmGcMonitorService</span>] [<span class="string">elk-node2</span>] [<span class="string">gc</span>][<span class="symbol">8759</span>] overhead, spent [1.3s] collecting in the last [1.7s]</span><br><span class="line">[<span class="string">2019-07-08T11:44:42,955</span>][<span class="symbol">INFO </span>][<span class="string">o.e.x.m.p.NativeController</span>] [elk-node2] Native controller process has stopped - no new native processes can be started</span><br></pre></td></tr></table></figure></p><p>2）配置<code>logstash</code><br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk2 ~]<span class="comment"># vim /etc/logstash/conf.d/java.conf</span></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        <span class="attr">path</span> =&gt; <span class="string">"/elk/logs/ELK-Cluster.log"</span></span><br><span class="line">        <span class="attr">type</span> =&gt; <span class="string">"java-elk-cluster-log"</span></span><br><span class="line">        <span class="attr">start_position</span> =&gt; <span class="string">"beginning"</span></span><br><span class="line">        <span class="attr">stat_interval</span> =&gt; <span class="string">"2"</span></span><br><span class="line">        <span class="attr">code</span> =&gt; multiline &#123;</span><br><span class="line">            <span class="attr">pattern</span> =&gt; <span class="string">"^\["</span>    <span class="comment">#以"["开头进行正则匹配，匹配规则</span></span><br><span class="line">            <span class="attr">negate</span> =&gt; <span class="string">"true"</span>  <span class="comment">#正则匹配成功，false匹配不成功</span></span><br><span class="line">            <span class="attr">what</span> =&gt; <span class="string">"previous"</span>  <span class="comment">#和前面的内容进行合并,如果是和下面的合并就是next</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"java-elk-cluster-log"</span> &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            <span class="attr">hosts</span> =&gt; [<span class="string">"192.168.1.31:9200"</span>]</span><br><span class="line">            <span class="attr">index</span> =&gt; <span class="string">"java-elk-cluster-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3）检查配置文件语法是否有误并重启<code>logstash</code><br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/java.conf -t</span><br><span class="line">WARNING: Could <span class="keyword">not</span> <span class="built_in">find</span> logstash.yml which is typically located in $LS_HOME/<span class="built_in">config</span> <span class="keyword">or</span> /etc/logstash. You can specify the path <span class="keyword">using</span> --path.settings. Continuing <span class="keyword">using</span> the defaults</span><br><span class="line">Could <span class="keyword">not</span> <span class="built_in">find</span> log4j2 configuration at path /usr/share/logstash/<span class="built_in">config</span>/log4j2.properties. Using <span class="built_in">default</span> <span class="built_in">config</span> which logs errors to the console</span><br><span class="line">[WARN ] <span class="number">2019</span><span class="number">-07</span><span class="number">-08</span> <span class="number">15</span>:<span class="number">49</span>:<span class="number">51.996</span> [LogStash::Runner] multilocal - Ignoring the <span class="string">'pipelines.yml'</span> file because modules <span class="keyword">or</span> command <span class="built_in">line</span> options are specified</span><br><span class="line">Configuration OK</span><br><span class="line">[INFO ] <span class="number">2019</span><span class="number">-07</span><span class="number">-08</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">04.438</span> [LogStash::Runner] runner - Using <span class="built_in">config</span>.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br><span class="line"></span><br><span class="line">[root@linux-elk2 ~]<span class="meta"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>4）访问<code>elasticsearch</code>界面验证数据<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log12.png" alt="log12.png"><br>5）在<code>kibana</code>上添加索引验证模式<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log13.png" alt="log13.png"><br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log14.png" alt="log14.png"><br>6）<code>kibana</code>验证数据<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log15.png" alt="log15.png"></p><h2 id="收集Nginx访问日志"><a href="#收集Nginx访问日志" class="headerlink" title="收集Nginx访问日志"></a>收集Nginx访问日志</h2><blockquote><p>收集<code>nginx</code>的<code>json</code>访问日志，这里为了测试，是在一台新的服务器上面安装了<code>nginx</code>和<code>logstash</code></p></blockquote><p>1）安装nginx并准备一个测试页面<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@node01</span> ~]<span class="meta"># yum -y install nginx</span></span><br><span class="line">[root<span class="symbol">@node01</span> ~]<span class="meta"># echo <span class="string">"&lt;h1&gt;whelcom to nginx server&lt;/h1&gt;"</span> &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line">[root<span class="symbol">@node01</span> ~]<span class="meta"># systemctl start nginx </span></span><br><span class="line">[root<span class="symbol">@node01</span> ~]<span class="meta"># curl localhost</span></span><br><span class="line">&lt;h1&gt;whelcom <span class="keyword">to</span> nginx server&lt;/h1&gt;</span><br></pre></td></tr></table></figure></p><p>2）将nginx日志转换成json格式<br><figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@node01</span> ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">    log_format access_json '&#123;<span class="string">"@timestamp"</span>:<span class="string">"<span class="variable">$time_iso8601</span>"</span>,'</span><br><span class="line">                           '<span class="string">"host"</span>:<span class="string">"<span class="variable">$server_addr</span>"</span>,'</span><br><span class="line">                           '<span class="string">"clientip"</span>:<span class="string">"<span class="variable">$remote_addr</span>"</span>,'</span><br><span class="line">                           '<span class="string">"size"</span>:$body_bytes_sent,'</span><br><span class="line">                           '<span class="string">"responsetime"</span>:$request_time,'</span><br><span class="line">                           '<span class="string">"upstreamtime"</span>:<span class="string">"<span class="variable">$upstream_response_time</span>"</span>,'</span><br><span class="line">                           '<span class="string">"upstreamhost"</span>:<span class="string">"<span class="variable">$upstream_addr</span>"</span>,'</span><br><span class="line">                           '<span class="string">"http_host"</span>:<span class="string">"<span class="variable">$host</span>"</span>,'</span><br><span class="line">                           '<span class="string">"url"</span>:<span class="string">"<span class="variable">$uri</span>"</span>,'</span><br><span class="line">                           '<span class="string">"domain"</span>:<span class="string">"<span class="variable">$host</span>"</span>,'</span><br><span class="line">                           '<span class="string">"xff"</span>:<span class="string">"<span class="variable">$http_x_forwarded_for</span>"</span>,'</span><br><span class="line">                           '<span class="string">"referer"</span>:<span class="string">"<span class="variable">$http_referer</span>"</span>,'</span><br><span class="line">                           '<span class="string">"status"</span>:<span class="string">"<span class="variable">$status</span>"</span>&#125;';</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  access_json;</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@node01</span> ~]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root<span class="meta">@node01</span> ~]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure></p><p>3）访问一次，确认日志为<code>json</code>格式<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log16.png" alt="log16.png"></p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# tail /var/<span class="keyword">log</span>/nginx/access.<span class="keyword">log</span></span><br><span class="line">&#123;<span class="string">"@timestamp"</span>:<span class="string">"2019-07-09T11:21:28+08:00"</span>,<span class="string">"host"</span>:<span class="string">"192.168.1.30"</span>,<span class="string">"clientip"</span>:<span class="string">"192.168.1.144"</span>,<span class="string">"size"</span>:<span class="number">33</span>,<span class="string">"responsetime"</span>:<span class="number">0.000</span>,<span class="string">"upstreamtime"</span>:<span class="string">"-"</span>,<span class="string">"upstreamhost"</span>:<span class="string">"-"</span>,<span class="string">"http_host"</span>:<span class="string">"192.168.1.30"</span>,<span class="string">"url"</span>:<span class="string">"/index.html"</span>,<span class="string">"domain"</span>:<span class="string">"192.168.1.30"</span>,<span class="string">"xff"</span>:<span class="string">"-"</span>,<span class="string">"referer"</span>:<span class="string">"-"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>&#125;</span><br></pre></td></tr></table></figure><p>4）安装<code>logstash</code>并配置收集<code>nginx</code>日志<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将logstash软件包copy到nginx服务器上</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># scp logstash-6.8.1.rpm 192.168.1.30:/root/</span></span><br><span class="line"><span class="comment">#安装logstash</span></span><br><span class="line">[root@node01 ~]<span class="comment"># yum -y localinstall logstash-6.8.1.rpm</span></span><br><span class="line"><span class="comment">#生成logstash.service启动文件</span></span><br><span class="line">[root@node01 ~]<span class="comment"># /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd</span></span><br><span class="line"><span class="comment">#将logstash启动用户更改为root，不然可能会导致收集不到日志</span></span><br><span class="line">[root@node01 ~]<span class="comment"># vim /etc/systemd/system/logstash.service</span></span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">[root@node01 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line"></span><br><span class="line">[root@node01 ~]<span class="comment"># vim /etc/logstash/conf.d/nginx.conf</span></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        <span class="attr">path</span> =&gt; <span class="string">"/var/log/nginx/access.log"</span></span><br><span class="line">        <span class="attr">type</span> =&gt; <span class="string">"nginx-accesslog"</span></span><br><span class="line">        <span class="attr">start_position</span> =&gt; <span class="string">"beginning"</span></span><br><span class="line">        <span class="attr">stat_interval</span> =&gt; <span class="string">"2"</span></span><br><span class="line">        <span class="attr">codec</span> =&gt; json</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"nginx-accesslog"</span> &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">        <span class="attr">hosts</span> =&gt; [<span class="string">"192.168.1.31:9200"</span>]</span><br><span class="line">        <span class="attr">index</span> =&gt; <span class="string">"logstash-nginx-accesslog-30-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>5）检查配置文件语法是否有误并重启<code>logstash</code><br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf -t</span><br><span class="line">WARNING: Could <span class="keyword">not</span> <span class="built_in">find</span> logstash.yml which is typically located in $LS_HOME/<span class="built_in">config</span> <span class="keyword">or</span> /etc/logstash. You can specify the path <span class="keyword">using</span> --path.settings. Continuing <span class="keyword">using</span> the defaults</span><br><span class="line">Could <span class="keyword">not</span> <span class="built_in">find</span> log4j2 configuration at path /usr/share/logstash/<span class="built_in">config</span>/log4j2.properties. Using <span class="built_in">default</span> <span class="built_in">config</span> which logs errors to the console</span><br><span class="line">[WARN ] <span class="number">2019</span><span class="number">-07</span><span class="number">-09</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">04.277</span> [LogStash::Runner] multilocal - Ignoring the <span class="string">'pipelines.yml'</span> file because modules <span class="keyword">or</span> command <span class="built_in">line</span> options are specified</span><br><span class="line">Configuration OK</span><br><span class="line">[INFO ] <span class="number">2019</span><span class="number">-07</span><span class="number">-09</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">09.055</span> [LogStash::Runner] runner - Using <span class="built_in">config</span>.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br><span class="line"></span><br><span class="line">[root@node01 ~]<span class="meta"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>6）在<code>kibana</code>上添加索引验证模式<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log17.png" alt="log17.png"><br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log18.png" alt="log18.png"></p><p>7）在<code>kibana</code>上验证数据,可以通过添加筛选，让日志更加了然名目<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log19.png" alt="log19.png"></p><h2 id="收集TCP-UDP日志"><a href="#收集TCP-UDP日志" class="headerlink" title="收集TCP/UDP日志"></a>收集TCP/UDP日志</h2><blockquote><p>通过<code>logstash</code>的<code>tcp/udp</code>插件收集日志，通常用于在向<code>elasticsearch</code>日志补录丢失的部分日志，可以将丢失的日志通过一个<code>TCP</code>端口直接写入到<code>elasticsearch</code>服务器。</p></blockquote><h3 id="进行收集测试"><a href="#进行收集测试" class="headerlink" title="进行收集测试"></a>进行收集测试</h3><p>1）logstash配置<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class="line">input &#123;</span><br><span class="line">    tcp &#123;</span><br><span class="line">       <span class="built_in"> port </span>=&gt; 9889</span><br><span class="line">       <span class="built_in"> type </span>=&gt; <span class="string">"tcplog"</span></span><br><span class="line">        mode =&gt; <span class="string">"server"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;</span><br><span class="line">        codec =&gt; rubydebug</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2）验证端口是否启动成功<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcp.conf </span></span><br><span class="line"><span class="symbol">WARNING:</span> Could <span class="keyword">not</span> find logstash.yml which is typically located <span class="keyword">in</span> <span class="variable">$LS_HOME</span>/config <span class="keyword">or</span> /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could <span class="keyword">not</span> find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class="line">[WARN ] <span class="number">2019</span>-<span class="number">07</span>-09 <span class="number">18</span><span class="symbol">:</span><span class="number">12</span><span class="symbol">:</span><span class="number">07</span>.<span class="number">538</span> [LogStash::Runner] multilocal - Ignoring the <span class="string">'pipelines.yml'</span> file because modules <span class="keyword">or</span> command line options are specified</span><br><span class="line">[INFO ] <span class="number">2019</span>-<span class="number">07</span>-09 <span class="number">18</span><span class="symbol">:</span><span class="number">12</span><span class="symbol">:</span><span class="number">07</span>.<span class="number">551</span> [LogStash::Runner] runner - Starting Logstash &#123;<span class="string">"logstash.version"</span>=&gt;<span class="string">"6.8.1"</span>&#125;</span><br><span class="line">[INFO ] <span class="number">2019</span>-<span class="number">07</span>-09 <span class="number">18</span><span class="symbol">:</span><span class="number">12</span><span class="symbol">:</span><span class="number">14.416</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Starting pipeline &#123;<span class="symbol">:pipeline_id=&gt;<span class="string">"main"</span></span>, <span class="string">"pipeline.workers"</span>=&gt;<span class="number">2</span>, <span class="string">"pipeline.batch.size"</span>=&gt;<span class="number">125</span>, <span class="string">"pipeline.batch.delay"</span>=&gt;<span class="number">50</span>&#125;</span><br><span class="line">[INFO ] <span class="number">2019</span>-<span class="number">07</span>-09 <span class="number">18</span><span class="symbol">:</span><span class="number">12</span><span class="symbol">:</span><span class="number">14.885</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Pipeline started successfully &#123;<span class="symbol">:pipeline_id=&gt;<span class="string">"main"</span></span>, <span class="symbol">:thread=&gt;<span class="string">"#&lt;Thread:0x240c27a6 sleep&gt;"</span></span>&#125;</span><br><span class="line">[INFO ] <span class="number">2019</span>-<span class="number">07</span>-09 <span class="number">18</span><span class="symbol">:</span><span class="number">12</span><span class="symbol">:</span><span class="number">14.911</span> [[main]&lt;tcp] tcp - Starting tcp input listener &#123;<span class="symbol">:address=&gt;<span class="string">"0.0.0.0:9889"</span></span>, <span class="symbol">:ssl_enable=&gt;<span class="string">"false"</span></span>&#125;</span><br><span class="line">[INFO ] <span class="number">2019</span>-<span class="number">07</span>-09 <span class="number">18</span><span class="symbol">:</span><span class="number">12</span><span class="symbol">:</span><span class="number">14.953</span> [Ruby-<span class="number">0</span>-Thread-<span class="number">1</span>: <span class="regexp">/usr/share</span><span class="regexp">/logstash/lib</span><span class="regexp">/bootstrap/environment</span>.<span class="symbol">rb:</span><span class="number">6</span>] agent - Pipelines running &#123;<span class="symbol">:count=&gt;</span><span class="number">1</span>, <span class="symbol">:running_pipelines=&gt;</span>[<span class="symbol">:main</span>], <span class="symbol">:non_running_pipelines=&gt;[]</span>&#125;</span><br><span class="line">[INFO ] <span class="number">2019</span>-<span class="number">07</span>-09 <span class="number">18</span><span class="symbol">:</span><span class="number">12</span><span class="symbol">:</span><span class="number">15.223</span> [Api Webserver] agent - Successfully started Logstash API endpoint &#123;<span class="symbol">:port=&gt;</span><span class="number">9600</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新开一个终端验证端口</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># netstat -nlutp |grep 9889</span></span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> ::<span class="symbol">:</span><span class="number">9889</span>                 ::<span class="symbol">:*</span>                    LISTEN      <span class="number">112455</span>/java</span><br></pre></td></tr></table></figure></p><p>3）在别的服务器通过nc命令进行测试，查看logstash是否收到数据<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># echo <span class="string">"nc test"</span> | <span class="type">nc</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> <span class="number">9889</span>    #在另外一台服务器上执行</span><br><span class="line"></span><br><span class="line"># 在上面启动logstash的那个终端查看</span><br><span class="line">&#123;</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"nc test"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"192.168.1.30"</span>,</span><br><span class="line">          <span class="string">"type"</span> =&gt; <span class="string">"tcplog"</span>,</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2019</span><span class="number">-07</span><span class="number">-09</span>T10:<span class="number">16</span>:<span class="number">48.139</span>Z,</span><br><span class="line">          <span class="string">"port"</span> =&gt; <span class="number">37102</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>4）通过nc命令发送一个文件，查看logstash收到的数据<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nc 192.168.1.31 9889 &lt; /etc/passwd    #同样在上面执行nc那台服务器上执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同样还是在上面启动logstash的那个终端查看</span></span><br><span class="line">&#123;</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"mysql:x:27:27:MariaDB Server:/var/lib/mysql:/sbin/nologin"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"192.168.1.30"</span>,</span><br><span class="line">          <span class="string">"type"</span> =&gt; <span class="string">"tcplog"</span>,</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2019</span><span class="number">-07</span><span class="number">-09</span>T10:<span class="number">18</span>:<span class="number">29.186</span>Z,</span><br><span class="line">          <span class="string">"port"</span> =&gt; <span class="number">37104</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"logstash:x:989:984:logstash:/usr/share/logstash:/sbin/nologin"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"192.168.1.30"</span>,</span><br><span class="line">          <span class="string">"type"</span> =&gt; <span class="string">"tcplog"</span>,</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2019</span><span class="number">-07</span><span class="number">-09</span>T10:<span class="number">18</span>:<span class="number">29.187</span>Z,</span><br><span class="line">          <span class="string">"port"</span> =&gt; <span class="number">37104</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>5）通过伪设备的方式发送消息：<br>在类Unix操作系统中，设备节点并不一定要对应物理设备。没有这种对应关系的设备是伪设备。操作系统运用了它们提供的多种功能，tcp只是dev下面众多伪设备当中的一种设备。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo "伪设备" &gt;/dev/tcp/192.168.1.31/9889    #同样在上面执行nc那台服务器上执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同样还是在上面启动logstash的那个终端查看</span></span><br><span class="line">&#123;</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"伪设备"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"192.168.1.30"</span>,</span><br><span class="line">          <span class="string">"type"</span> =&gt; <span class="string">"tcplog"</span>,</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2019</span><span class="number">-07</span><span class="number">-09</span>T10:<span class="number">21</span>:<span class="number">32.487</span>Z,</span><br><span class="line">          <span class="string">"port"</span> =&gt; <span class="number">37106</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>6）将输出更改到elasticsearch<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class="line">input &#123;</span><br><span class="line">    tcp &#123;</span><br><span class="line">       <span class="built_in"> port </span>=&gt; 9889</span><br><span class="line">       <span class="built_in"> type </span>=&gt; <span class="string">"tcplog"</span></span><br><span class="line">        mode =&gt; <span class="string">"server"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [<span class="string">"192.168.1.31:9200"</span>]</span><br><span class="line">        index =&gt; <span class="string">"logstash-tcp-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>7）通过nc命令或伪设备输入日志<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># echo <span class="string">"伪设备 1"</span> &gt;/dev/tcp/<span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span>/<span class="number">9889</span></span><br><span class="line"># echo <span class="string">"伪设备 2"</span> &gt;/dev/tcp/<span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span>/<span class="number">9889</span></span><br></pre></td></tr></table></figure></p><p>8）在kibana界面创建索引模式<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log20.png" alt="log20.png"><br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log21.png" alt="log21.png"><br>9）验证数据<br><img src="/2019/07/05/ELK快速入门二-通过logstash收集日志/log22.png" alt="log22.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;这里的环境接着上面的ELK快速入门-基本部署文章继续下面的操作。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id
      
    
    </summary>
    
      <category term="ELK" scheme="https://leeyj.coding.me/categories/ELK/"/>
    
    
      <category term="ELK" scheme="https://leeyj.coding.me/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>ELK快速入门一-基本部署</title>
    <link href="https://leeyj.coding.me/2019/07/05/ELK%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E4%B8%80-%E5%9F%BA%E6%9C%AC%E9%83%A8%E7%BD%B2/"/>
    <id>https://leeyj.coding.me/2019/07/05/ELK快速入门一-基本部署/</id>
    <published>2019-07-05T04:25:22.000Z</published>
    <updated>2019-10-24T09:12:16.845Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ELK简介"><a href="#ELK简介" class="headerlink" title="ELK简介"></a>ELK简介</h2><blockquote><p>什么是ELK？通俗来讲，ELK是由Elasticsearch、Logstash、Kibana 三个开源软件组成的一个组合体，这三个软件当中，每个软件用于完成不同的功能，ELK又称ELKstack，官网 <a href="https://www.elastic.co/" target="_blank" rel="noopener">https://www.elastic.co/</a> ， ELK主要优点有如下几个：<br>1、处理方式灵活：elasticsearch是实时全文索引，具有强大的搜索功能<br>2、配置相对简单：elasticsearch全部使用JSON接口，logstash使用模块配置，kibana的配置文件部分更简单<br>3、检索性能高：基于优秀的设计，虽然每次查询都是实时，但是也可以达到百亿级数据的查询秒级响应<br>4、集群线性扩展：elasticsearch和logstash都可以灵活线性扩展<br>5、前端操作绚丽：kibana的前端设计比较绚丽，而且操作简单</p></blockquote><h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><blockquote><p><code>elasticsearch</code>是一个高度可扩展全文搜索和分析引擎，基于<code>Apache Lucene</code> 构建，能对大容量的数据进行接近实时的存储、搜索和分析操作，可以处理大规模日志数据，比如<code>Nginx</code>、<code>Tomcat</code>、系统日志等功能。</p></blockquote><h3 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h3><blockquote><p>数据收集引擎。它支持动态的从各种数据源搜集数据，并对数据进行过滤、分析、丰富、统一格式等操作，然后存储到用户指定的位置；支持普通<code>log</code>、自定义<code>json</code>格式的日志解析。</p></blockquote><h3 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h3><blockquote><p>数据分析和可视化平台。通常与 <code>Elasticsearch</code> 配合使用，对其中数据进行搜索、分析和以统计图表的方式展示。</p></blockquote><h2 id="ELK部署环境准备"><a href="#ELK部署环境准备" class="headerlink" title="ELK部署环境准备"></a>ELK部署环境准备</h2><blockquote><p>这里实验所使用系统<code>CentOS 7.4 x86_64</code>，服务器信息如下。并关闭防火墙和<code>selinux</code>，及<code>host</code>绑定等。本文所使用所有的软件包 <a href="https://pan.baidu.com/s/1ighWPeYVqK6AGZQn55Y_pw" target="_blank" rel="noopener">下载</a>  提取码：<code>ow1b</code></p></blockquote><table><thead><tr><th>IPAddr</th><th>HostName</th><th>Mem  </th></tr></thead><tbody><tr><td>192.168.1.31</td><td>linux-elk1.exmaple.com</td><td>3G   </td></tr><tr><td>192.168.1.32</td><td>linux-elk2.exmaple.com</td><td>3G   </td></tr></tbody></table><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">epel源配置</span><br><span class="line"># wget -O <span class="regexp">/etc/yum</span>.repos.d<span class="regexp">/epel.repo http:/</span><span class="regexp">/mirrors.aliyun.com/</span>repo<span class="regexp">/epel-7.repo</span></span><br></pre></td></tr></table></figure><h2 id="Elasticsearch部署"><a href="#Elasticsearch部署" class="headerlink" title="Elasticsearch部署"></a>Elasticsearch部署</h2><blockquote><p>因为<code>elasticsearch</code>服务运行需要<code>java</code>环境，因此两台<code>elasticsearch</code>服务器需要安装<code>java</code>环境。</p></blockquote><h3 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h3><blockquote><p><code>centos7</code>默认是安装了<code>jdk</code>，如果需要安装高版本可以使用一下步骤，这里使用下面的yum安装<code>jdk 1.8.0_211</code> 。注意：两个节点都要安装。</p></blockquote><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">方法一：yum安装下载好的JDK包，将下载好的软件包上传到服务器进行安装，首先卸载自带的jdk；再进行安装。</span><br><span class="line">下载地址：https:<span class="regexp">//pan</span>.baidu.com/<span class="keyword">s</span>/<span class="number">1</span>VK1iCnvouppZ06jsVBOaRw  提取码：lofc</span><br><span class="line"></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># rpm -qa |grep jdk |xargs yum -y remove &#123;&#125;\;</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># yum -y localinstall jdk-8u211-linux-x64.rpm</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># java -version</span></span><br><span class="line">java version <span class="string">"1.8.0_211"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build <span class="number">1.8</span>.<span class="number">0_211</span>-b12)</span><br><span class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">25.211</span>-b12, mixed mode)</span><br><span class="line"></span><br><span class="line">方法二：源码安装JDK，将下载的软件包上传到服务器进行安装。</span><br><span class="line">下载地址：https:<span class="regexp">//pan</span>.baidu.com/<span class="keyword">s</span>/<span class="number">1</span>AAPyPzhdclNNCb0m6ooVYQ  提取码：x18u</span><br><span class="line"></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># ln -s /usr/local/jdk1.8.0_211 /usr/local/java</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># sed -i.ori '$a export JAVA_HOME=/usr/local/java \nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># source /etc/profile</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># java -version</span></span><br><span class="line">java version <span class="string">"1.8.0_211"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build <span class="number">1.8</span>.<span class="number">0_211</span>-b12)</span><br><span class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">25.211</span>-b12, mixed mode)</span><br></pre></td></tr></table></figure><h3 id="安装Elasticsearch"><a href="#安装Elasticsearch" class="headerlink" title="安装Elasticsearch"></a>安装Elasticsearch</h3><blockquote><p>两台节点都需要安装elasticsearch，使用yum安装会很慢，所以先下载下来传到服务器进行安装，官网下载地址：<a href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases#elasticsearch</a><br>本文所使用的包下载：<a href="https://pan.baidu.com/s/1djYOs3PQjtq16VkPMETAWg" target="_blank" rel="noopener">https://pan.baidu.com/s/1djYOs3PQjtq16VkPMETAWg</a>  提取码：b15v</p></blockquote><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">将下载的elasticsearch包上传到服务器进行安装。</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># yum -y localinstall elasticsearch-6.8.1.rpm</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># yum -y localinstall elasticsearch-6.8.1.rpm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置elasticsearch，linux-elk2配置一个相同的节点，通过组播进行通信，如果无法通过组播查询，修改成单播即可。</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># vim /etc/elasticsearch/elasticsearch.yml</span></span><br><span class="line"><span class="symbol">cluster.name:</span> ELK-Cluster    <span class="comment">#ELK的集群名称，名称相同即属于是同一个集群</span></span><br><span class="line"><span class="symbol">node.name:</span> elk-node1    <span class="comment">#本机在集群内的节点名称</span></span><br><span class="line"><span class="symbol">path.data:</span> /elk/data    <span class="comment">#数据存放目录</span></span><br><span class="line"><span class="symbol">path.logs:</span> /elk/logs    <span class="comment">#日志保存目录</span></span><br><span class="line"><span class="symbol">bootstrap.memory_lock:</span> <span class="keyword">true</span>    <span class="comment">#服务启动的时候锁定足够的内存，防止数据写入swap</span></span><br><span class="line"><span class="symbol">network.host:</span> <span class="number">192.168</span>.<span class="number">1.31</span>    <span class="comment">#监听的IP地址</span></span><br><span class="line"><span class="symbol">http.port:</span> <span class="number">9200</span>    <span class="comment">#服务监听的端口</span></span><br><span class="line"><span class="symbol">discovery.zen.ping.unicast.hosts:</span> [<span class="string">"192.168.1.31"</span>, <span class="string">"192.168.1.32"</span>]    <span class="comment">#单播配置一台即可</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改内存限制，内存锁定需要进行配置需要<span class="number">2</span>g以上内存，否则会导致无法启动elasticsearch。</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># vim /usr/lib/systemd/system/elasticsearch.service</span></span><br><span class="line"><span class="comment"># 在[Service]下加入下面这行内容</span></span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># vim /etc/elasticsearch/jvm.options</span></span><br><span class="line">-Xms2g</span><br><span class="line">-Xmx2g     <span class="comment">#最小和最大内存限制，为什么最小和最大设置一样大？参考：https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建数据目录和日志目录及权限修改</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># mkdir -p /elk/&#123;data,logs&#125;</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># chown elasticsearch.elasticsearch /elk/ -R</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动elasticsearch及检查端口是否处于监听状态</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># systemctl start elasticsearch</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># netstat -nltup |grep java</span></span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span>.<span class="number">1.31</span><span class="symbol">:</span><span class="number">9200</span>       ::<span class="symbol">:*</span>                    LISTEN      <span class="number">12887</span>/java          </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span>.<span class="number">1.31</span><span class="symbol">:</span><span class="number">9300</span>       ::<span class="symbol">:*</span>                    LISTEN      <span class="number">12887</span>/java</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">将配置文件copy到linux-elk2上面并进行修改，配置启动等。</span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># scp /etc/elasticsearch/elasticsearch.yml 192.168.1.32:/etc/elasticsearch/elasticsearch.yml</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># grep ^[a-Z] /etc/elasticsearch/elasticsearch.yml </span></span><br><span class="line"><span class="symbol">cluster.name:</span> ELK-Cluster</span><br><span class="line"><span class="symbol">node.name:</span> elk-node2</span><br><span class="line"><span class="symbol">path.data:</span> /elk/data</span><br><span class="line"><span class="symbol">path.logs:</span> /elk/logs</span><br><span class="line"><span class="symbol">bootstrap.memory_lock:</span> <span class="keyword">true</span></span><br><span class="line"><span class="symbol">network.host:</span> <span class="number">192.168</span>.<span class="number">1.32</span></span><br><span class="line"><span class="symbol">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="symbol">discovery.zen.ping.unicast.hosts:</span> [<span class="string">"192.168.1.31"</span>, <span class="string">"192.168.1.32"</span>]</span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># vim /usr/lib/systemd/system/elasticsearch.service</span></span><br><span class="line"><span class="comment"># 在[Service]下加入下面这行内容</span></span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># vim /etc/elasticsearch/jvm.options</span></span><br><span class="line">-Xms2g</span><br><span class="line">-Xmx2g</span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># mkdir -p /elk/&#123;data,logs&#125;</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># chown elasticsearch.elasticsearch /elk/ -R</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment"># systemctl start elasticsearch</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk2 ~]<span class="comment">#  netstat -nltup |grep java</span></span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span>.<span class="number">1.32</span><span class="symbol">:</span><span class="number">9200</span>       ::<span class="symbol">:*</span>                    LISTEN      <span class="number">18667</span>/java          </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span>.<span class="number">1.32</span><span class="symbol">:</span><span class="number">9300</span>       ::<span class="symbol">:*</span>                    LISTEN      <span class="number">18667</span>/java</span><br></pre></td></tr></table></figure><p>通过浏览器访问<code>elasticsearch</code>端口<br><img src="/2019/07/05/ELK快速入门一-基本部署/elk01.png" alt="elk01.png"><br><img src="/2019/07/05/ELK快速入门一-基本部署/elk02.png" alt="elk02.png"></p><h4 id="监控elasticsearch集群状态"><a href="#监控elasticsearch集群状态" class="headerlink" title="监控elasticsearch集群状态"></a>监控elasticsearch集群状态</h4><blockquote><p>通过shell命令获取集群状态，这里获取到的是一个json格式的返回值，例如对status进行分析，如果等于green(绿色)就是运行在正常，等于yellow(黄色)表示副本分片丢失，red(红色)表示主分片丢失。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="meta"># curl http:<span class="comment">//192.168.1.31:9200/_cluster/health?pretty=true</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"ELK-Cluster"</span>,</span><br><span class="line">  <span class="string">"status"</span> : <span class="string">"green"</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">"active_primary_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"active_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"relocating_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"initializing_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"unassigned_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"delayed_unassigned_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"number_of_pending_tasks"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"number_of_in_flight_fetch"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"active_shards_percent_as_number"</span> : <span class="number">100.0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@linux-elk1 ~]<span class="meta"># curl http:<span class="comment">//192.168.1.32:9200/_cluster/health?pretty=true</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"ELK-Cluster"</span>,</span><br><span class="line">  <span class="string">"status"</span> : <span class="string">"green"</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">"active_primary_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"active_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"relocating_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"initializing_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"unassigned_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"delayed_unassigned_shards"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"number_of_pending_tasks"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"number_of_in_flight_fetch"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="string">"active_shards_percent_as_number"</span> : <span class="number">100.0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="安装elasticsearch插件head"><a href="#安装elasticsearch插件head" class="headerlink" title="安装elasticsearch插件head"></a>安装elasticsearch插件head</h4><blockquote><p>我们不可能经常通过命令来查看集群的信息，所以就使用到了插件 –<code>head</code>。件是为了完成不同的功能，官方提供了一些插件但大部分是收费的，另外也有一些开发爱好者提供的插件，可以实现对<code>elasticsearch</code>集群的状态监控与管理配置等功能。<br>head：主要用来做集群管理的插件<br>下载地址：<a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="noopener">https://github.com/mobz/elasticsearch-head</a></p></blockquote><p>1）安装<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装npm和git</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># yum -y install npm git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装elasticsearch-head插件</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">[root@linux-elk1 src]<span class="comment"># git clone git://github.com/mobz/elasticsearch-head.git</span></span><br><span class="line">[root@linux-elk1 src]<span class="comment"># cd elasticsearch-head/</span></span><br><span class="line">[root@linux-elk1 elasticsearch-head]<span class="comment"># npm install grunt -save --registry=https://registry.npm.taobao.org</span></span><br><span class="line">[root@linux-elk1 elasticsearch-head]<span class="comment"># ll node_modules/grunt    #确定该目录有生成文件</span></span><br><span class="line">总用量 <span class="number">24</span></span><br><span class="line">drwxr-xr-x. <span class="number">2</span> root root   <span class="number">19</span> <span class="number">4</span>月   <span class="number">6</span> <span class="number">2016</span> bin</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">7111</span> <span class="number">4</span>月   <span class="number">6</span> <span class="number">2016</span> CHANGELOG</span><br><span class="line">drwxr-xr-x. <span class="number">4</span> root root   <span class="number">47</span> <span class="number">7</span>月   <span class="number">4</span> 09:<span class="number">21</span> lib</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">1592</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2016</span> LICENSE</span><br><span class="line">drwxr-xr-x. <span class="number">5</span> root root   <span class="number">50</span> <span class="number">7</span>月   <span class="number">4</span> 09:<span class="number">21</span> node_modules</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">4108</span> <span class="number">7</span>月   <span class="number">4</span> 09:<span class="number">21</span> package.json</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root  <span class="number">878</span> <span class="number">2</span>月  <span class="number">12</span> <span class="number">2016</span> README.md</span><br><span class="line">[root@linux-elk1 elasticsearch-head]<span class="comment"># npm install --registry=https://registry.npm.taobao.org    #执行安装</span></span><br><span class="line">[root@linux-elk1 elasticsearch-head]<span class="comment"># npm run start &amp;    #后台启动服务</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># ss -nlt |grep 9100</span></span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>          *:<span class="number">9100</span>                     *:* </span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------补充说明------------------------</span></span><br><span class="line">由于上面npm安装时候超级慢，使用taobao源同样慢，这里将已安装的打成了包，可以直接下载使用即可</span><br><span class="line">下载地址：https:<span class="regexp">//pan</span>.baidu.com/<span class="keyword">s</span>/<span class="number">16</span>zDlecKVfmkEeInPcRx9NQ   提取码：h89<span class="number">0</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># yum -y install npm</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">[root@linux-elk1 src]<span class="comment"># ls</span></span><br><span class="line">elasticsearch-head.tar.gz</span><br><span class="line">[root@linux-elk1 src]<span class="comment"># tar xvzf elasticsearch-head.tar.gz</span></span><br><span class="line">[root@linux-elk1 src]<span class="comment"># cd elasticsearch-head/</span></span><br><span class="line">[root@linux-elk1 elasticsearch-head]<span class="comment"># npm run start &amp;</span></span><br><span class="line"><span class="comment">#--------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改elasticsearch服务配置文件，开启跨域访问支持，然后重启elasticsearch服务</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># vim /etc/elasticsearch/elasticsearch.yml</span></span><br><span class="line">http.cors.enabled: true     <span class="comment">#最下方添加</span></span><br><span class="line">http.cors.allow-origin: <span class="string">"*"</span></span><br></pre></td></tr></table></figure></p><p>为了方便管理<code>elasticsearch-head</code>插件，编写一个启动脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># vim /usr/bin/elasticsearch-head</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#desc: elasticsearch-head service manager</span></span><br><span class="line"><span class="comment">#date: 2019</span></span><br><span class="line"></span><br><span class="line">data=<span class="string">"cd /usr/local/src/elasticsearch-head/; nohup npm run start &gt; /dev/null 2&gt;&amp;1 &amp; "</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">START</span></span> ()&#123;</span><br><span class="line">    <span class="built_in">eval</span> <span class="variable">$data</span> &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"elasticsearch-head start\033[32m     ok\033[0m"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">STOP</span></span> ()&#123;</span><br><span class="line">    ps -ef |grep grunt |grep -v <span class="string">"grep"</span> |awk <span class="string">'&#123;print $2&#125;'</span> |xargs <span class="built_in">kill</span> -s 9 &gt; /dev/null &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"elasticsearch-head stop\033[32m      ok\033[0m"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        START</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        STOP</span><br><span class="line">        ;;</span><br><span class="line">    restart)</span><br><span class="line">        STOP</span><br><span class="line">        sleep 3</span><br><span class="line">        START</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Usage: elasticsearch-head (start|stop|restart)"</span></span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># chmod +x /usr/bin/elasticsearch-head</span></span><br></pre></td></tr></table></figure></p><p>2）浏览器访问<code>9100端口</code>，将连接地址修改为<code>elasticsearch</code>地址。<br><img src="/2019/07/05/ELK快速入门一-基本部署/elk03.png" alt="elk03.png"><br><img src="/2019/07/05/ELK快速入门一-基本部署/elk04.png" alt="elk04.png"></p><p>3）测试提交数据<br><img src="/2019/07/05/ELK快速入门一-基本部署/elk05.png" alt="elk05.png"></p><p>4）验证索引是否存在<br><img src="/2019/07/05/ELK快速入门一-基本部署/elk06.png" alt="elk06.png"></p><p>5）查看数据<br><img src="/2019/07/05/ELK快速入门一-基本部署/elk07.png" alt="elk07.png"></p><p>6）Master和Slave的区别：</p><blockquote><p><code>Master</code>的职责：<br>统计各<code>node</code>节点状态信息、集群状态信息统计、索引的创建和删除、索引分配的管理、关闭<code>node</code>节点等<br><code>Savle</code>的职责：<br>同步数据、等待机会称为<code>Master</code></p></blockquote><h2 id="Logstash部署"><a href="#Logstash部署" class="headerlink" title="Logstash部署"></a>Logstash部署</h2><blockquote><p>Logstash 是一个开源的数据收集引擎，可以水平伸缩，而且logstash是整个ELK当中拥有最多插件的一个组件，其可以接收来自不同来源的数据并同意输出到指定的且可以是多个不同目的地。官网下载地址：<a href="https://www.elastic.co/cn/downloads/past-releases#logstash" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases#logstash</a></p></blockquote><h3 id="安装logstash"><a href="#安装logstash" class="headerlink" title="安装logstash"></a>安装logstash</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@linux</span>-elk1 ~]<span class="meta"># wget https://artifacts.elastic.co/downloads/logstash/logstash-6.8.1.rpm</span></span><br><span class="line">[root<span class="symbol">@linux</span>-elk1 ~]<span class="meta"># yum -y localinstall logstash-6.8.1.rpm</span></span><br></pre></td></tr></table></figure><h3 id="测试logstash是否正常"><a href="#测试logstash是否正常" class="headerlink" title="测试logstash是否正常"></a>测试logstash是否正常</h3><p>1）测试标准输入输出<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># /usr/share/logstash/bin/logstash -e 'input &#123; stdin &#123;&#125; &#125; output &#123; stdout &#123; codec =&gt; rubydebug&#125; &#125;'  </span></span><br><span class="line">hello world    <span class="comment">#输入</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,    <span class="comment">#事件版本号，一个事件就是一个ruby对象</span></span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2019</span><span class="number">-07</span><span class="number">-04</span>T04:<span class="number">30</span>:<span class="number">35.106</span>Z,    <span class="comment">#当前事件发生的事件</span></span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"linux-elk1.exmaple.com"</span>,    <span class="comment">#标记事件发生在哪里</span></span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"hello world"</span>    <span class="comment">#消息的具体内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2）测试输出到文件<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># /usr/share/logstash/bin/logstash   -e 'input &#123; stdin&#123;&#125; &#125; output &#123; file &#123; path =&gt; "/tmp/log-%&#123;+YYYY.MM.dd&#125;messages.gz"&#125;&#125;'</span></span><br><span class="line">hello world   <span class="comment">#输入</span></span><br><span class="line">[INFO ] <span class="number">2019</span>-<span class="number">07</span>-<span class="number">04</span> <span class="number">17</span><span class="symbol">:</span><span class="number">33</span><span class="symbol">:</span><span class="number">06</span>.<span class="number">065</span> [[main]&gt;worker<span class="number">0</span>] file - Opening file &#123;<span class="symbol">:path=&gt;<span class="string">"/tmp/log-2019.07.04messages.gz"</span></span>&#125;</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># tail /tmp/log-2019.07.04messages.gz </span></span><br><span class="line">&#123;<span class="string">"message"</span><span class="symbol">:<span class="string">"hello world"</span></span>,<span class="string">"@version"</span><span class="symbol">:<span class="string">"1"</span></span>,<span class="string">"host"</span><span class="symbol">:<span class="string">"linux-elk1.exmaple.com"</span></span>,<span class="string">"@timestamp"</span><span class="symbol">:<span class="string">"2019-07-04T09:33:05.698Z"</span></span>&#125;</span><br></pre></td></tr></table></figure></p><p>3）测试输出到elasticsearch<br><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash   -e <span class="symbol">'input</span> &#123;  stdin&#123;&#125; &#125; output &#123; elasticsearch &#123;hosts =&gt; [<span class="string">"192.168.1.31:9200"</span>] index =&gt; <span class="string">"mytest-%&#123;+YYYY.MM.dd&#125;"</span> &#125;&#125;<span class="string">'</span></span><br></pre></td></tr></table></figure></p><p>4）elasticsearch服务器验证收到数据<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># ll /elk/data/nodes/0/indices/</span></span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x.<span class="number"> 8 </span>elasticsearch elasticsearch<span class="number"> 65 </span>7月  <span class="number"> 4 </span>17:23 4jaihRq6Qu6NQWVxbuRQZg</span><br><span class="line">drwxr-xr-x.<span class="number"> 8 </span>elasticsearch elasticsearch<span class="number"> 65 </span>7月  <span class="number"> 4 </span>17:22 kkd_RCldSeaCX3y1XKzdgA</span><br></pre></td></tr></table></figure></p><p><img src="/2019/07/05/ELK快速入门一-基本部署/elk08.png" alt="elk08.png"></p><h2 id="kibana部署"><a href="#kibana部署" class="headerlink" title="kibana部署"></a>kibana部署</h2><blockquote><p><code>Kibana</code>是一个通过调用<code>elasticsearch</code>服务器进行图形化展示搜索结果的开源项目。官网下载地址：<a href="https://www.elastic.co/cn/downloads/past-releases#kibana" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases#kibana</a></p></blockquote><h3 id="安装kibana"><a href="#安装kibana" class="headerlink" title="安装kibana"></a>安装kibana</h3><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># wget https://artifacts.elastic.co/downloads/kibana/kibana-6.8.1-x86_64.rpm</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># yum -y localinstall kibana-6.8.1-x86_64.rpm</span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># vim /etc/kibana/kibana.yml </span></span><br><span class="line">[root@linux-elk1 ~]<span class="comment"># grep ^[a-Z] /etc/kibana/kibana.yml </span></span><br><span class="line">server.port: <span class="number">5601</span>    <span class="comment">#监听端口</span></span><br><span class="line">server.host: <span class="string">"192.168.1.31"</span>    <span class="comment">#监听地址</span></span><br><span class="line">elasticsearch.hosts: [<span class="string">"http://192.168.1.31:9200"</span>]    <span class="comment">#elasticsearch服务器地址</span></span><br><span class="line">i18n.locale: <span class="string">"zh-CN"</span>    <span class="comment">#修改为中文</span></span><br></pre></td></tr></table></figure><h3 id="启动kibana并验证"><a href="#启动kibana并验证" class="headerlink" title="启动kibana并验证"></a>启动kibana并验证</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># systemctl start kibana</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># systemctl enable kibana</span></span><br><span class="line">[root<span class="variable">@linux</span>-elk1 ~]<span class="comment"># ss -nlt  |grep 5601</span></span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>    <span class="number">192.168</span>.<span class="number">1.31</span><span class="symbol">:</span><span class="number">5601</span>                     *<span class="symbol">:*</span></span><br></pre></td></tr></table></figure><h3 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h3><p><img src="/2019/07/05/ELK快速入门一-基本部署/elk09.png" alt="elk09.png"></p><h2 id="通过logstash收集系统message日志"><a href="#通过logstash收集系统message日志" class="headerlink" title="通过logstash收集系统message日志"></a>通过logstash收集系统message日志</h2><blockquote><p>说明：通过<code>logstash</code>收集别的日志文件，前提需要<code>logstash</code>用户对被收集的日志文件有读的权限并对写入的文件有写的权限</p></blockquote><p>1）配置<code>logstash</code>配置文件<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]<span class="comment"># vim /etc/logstash/conf.d/system-log.conf</span></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        <span class="attr">path</span> =&gt; <span class="string">"/var/log/messages"</span>    <span class="comment">#日志路径</span></span><br><span class="line">        <span class="attr">type</span> =&gt; <span class="string">"systemlog"</span>            <span class="comment">#类型，自定义，在进行多个日志收集存储时可以通过该项进行判断输出</span></span><br><span class="line">        <span class="attr">start_position</span> =&gt; <span class="string">"beginning"</span>        <span class="comment">#logstash 从什么位置开始读取文件数据，默认是结束位置，也就是说 logstash 进程会以类似 tail -F 的形式运行。如果你是要导入原有数据，把这个设定改成 "beginning"，logstash 进程就从头开始读取，类似 less +F 的形式运行。</span></span><br><span class="line"><span class="attr">stat_interval</span> =&gt; <span class="string">"2"</span>    <span class="comment">#logstash 每隔多久检查一次被监听文件状态（是否有更新），默认是 1 秒</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        <span class="attr">hosts</span> =&gt; [<span class="string">"192.168.1.31:9200"</span>]        <span class="comment">#elasticsearch服务器地址</span></span><br><span class="line">        <span class="attr">index</span> =&gt; <span class="string">"logstash-%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;"</span>    <span class="comment">#索引名称</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2）检测配置文件语法是否有错误<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system-<span class="built_in">log</span>.conf -t    #检测配置文件是否有语法错误</span><br><span class="line">WARNING: Could <span class="keyword">not</span> <span class="built_in">find</span> logstash.yml which is typically located <span class="keyword">in</span> $LS_HOME/<span class="built_in">config</span> <span class="keyword">or</span> /etc/logstash. You can specify the <span class="built_in">path</span> using <span class="comment">--path.settings. Continuing using the defaults</span></span><br><span class="line">Could <span class="keyword">not</span> <span class="built_in">find</span> log4j2 configuration at <span class="built_in">path</span> /usr/share/logstash/<span class="built_in">config</span>/log4j2.properties. Using default <span class="built_in">config</span> which logs errors to the console</span><br><span class="line">[WARN ] <span class="number">2019</span><span class="number">-07</span><span class="number">-05</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">59.423</span> [LogStash::Runner] multilocal - Ignoring the <span class="string">'pipelines.yml'</span> file because modules <span class="keyword">or</span> command line options are specified</span><br><span class="line">Configuration OK</span><br><span class="line">[INFO ] <span class="number">2019</span><span class="number">-07</span><span class="number">-05</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">27.993</span> [LogStash::Runner] runner - Using <span class="built_in">config</span>.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br></pre></td></tr></table></figure></p><p>3）修改日志文件的权限并重启<code>logstash</code><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-elk1 ~]# ll /<span class="keyword">var</span>/<span class="keyword">log</span>/messages     </span><br><span class="line">-rw-------. 1 root root 786219 7月   5 10:10 /<span class="keyword">var</span>/<span class="keyword">log</span>/messages</span><br><span class="line">#这里可以看到该日志文件是600权限，而elasticsearch是运行在elasticsearch用户下，这样elasticsearch是无法收集日志的。所以这里需要更改日志的权限，否则会报权限拒绝的错误。在日志中查看/<span class="keyword">var</span>/<span class="keyword">log</span>/logstash/logstash-plain.<span class="keyword">log</span> 是否有错误。</span><br><span class="line">[root@linux-elk1 ~]# chmod 644 /<span class="keyword">var</span>/<span class="keyword">log</span>/messages</span><br><span class="line">[root@linux-elk1 ~]# systemctl  restart logstash</span><br></pre></td></tr></table></figure></p><p>4）elasticsearch界面查看并查询<br><img src="/2019/07/05/ELK快速入门一-基本部署/elk10.png" alt="elk10.png"><br><img src="/2019/07/05/ELK快速入门一-基本部署/elk11.png" alt="elk11.png"><br>5）kibana界面创建索引并查看<br><img src="/2019/07/05/ELK快速入门一-基本部署/elk12.png" alt="elk12.png"><br><img src="/2019/07/05/ELK快速入门一-基本部署/elk13.png" alt="elk13.png"><br><img src="/2019/07/05/ELK快速入门一-基本部署/elk14.png" alt="elk14.png"><br><img src="/2019/07/05/ELK快速入门一-基本部署/elk15.png" alt="elk15.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ELK简介&quot;&gt;&lt;a href=&quot;#ELK简介&quot; class=&quot;headerlink&quot; title=&quot;ELK简介&quot;&gt;&lt;/a&gt;ELK简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;什么是ELK？通俗来讲，ELK是由Elasticsearch、Logstash、Kiban
      
    
    </summary>
    
      <category term="ELK" scheme="https://leeyj.coding.me/categories/ELK/"/>
    
    
      <category term="ELK" scheme="https://leeyj.coding.me/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat+Nginx+Memcached综合案例</title>
    <link href="https://leeyj.coding.me/2019/06/27/Tomcat+Nginx+Memcached%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/"/>
    <id>https://leeyj.coding.me/2019/06/27/Tomcat+Nginx+Memcached综合案例/</id>
    <published>2019-06-27T09:36:22.000Z</published>
    <updated>2019-07-10T01:46:29.979Z</updated>
    
    <content type="html"><![CDATA[<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><blockquote><p>通过<code>Nginx</code>解析静态页面并将动态负载均衡调度给后面的多个<code>Tomcat</code>，<code>Tomcat</code>解析<code>java</code>动态程序。</p></blockquote><blockquote><p>由于http是无状态的协议，你访问了页面A，然后在访问B，http无法确定这2个访问来自一个人<br>，因此要用cookie或session来跟踪用户，根据授权和用户身份来显示不同的页面。<br>比如用户A登陆了，那么能看到自己的个人信息，而B没登陆，无法看到个人信息。<br>还有A可能在购物，把商品放入购物车，此时B也有这个过程，你无法确定A，B的身份和购物信息，所以需要一个session ID来维持这个过程。所以就用到了session管理。</p></blockquote><p><a href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration" target="_blank" rel="noopener">官网文档</a></p><h2 id="环境规划"><a href="#环境规划" class="headerlink" title="环境规划"></a>环境规划</h2><table><thead><tr><th>主机</th><th>hostname</th><th>环境</th><th></th></tr></thead><tbody><tr><td>192.168.1.31</td><td>nginx.cluster.com</td><td>nginx（yum安装）</td><td></td></tr><tr><td>192.168.1.32</td><td>tomcat1.cluster.com</td><td>tomcat-9.0</td><td></td></tr><tr><td>192.168.1.33</td><td>tomcat2.cluster.com</td><td>tomcat-9.0</td><td></td></tr><tr><td>192.168.1.34</td><td>memcached.cluster.com</td><td>memcached（yum安装）</td></tr></tbody></table><blockquote><p>关闭防火墙，selinux；时间同步；host绑定等基本配置 (步骤略)</p></blockquote><h2 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h2><p>本案例所使用的<code>tomcat</code>、<code>jdk</code>、和<code>tomcat-session</code>相关的jar包下载地址<br>链接：<a href="https://pan.baidu.com/s/1ESm_RSrFx77kWObmCt1DQw" target="_blank" rel="noopener">https://pan.baidu.com/s/1ESm_RSrFx77kWObmCt1DQw</a><br>提取码：f64n </p><h3 id="memcached部署"><a href="#memcached部署" class="headerlink" title="memcached部署"></a>memcached部署</h3><blockquote><p>说明：memcached这里不需要配置太多，安装即可，然后检查端口是否处于监听中。tomcat服务器能成功连接即可<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@memcached ~]# yum -y install memcached</span><br><span class="line">[root@memcached ~]# systemctl <span class="builtin-name">enable</span> memcached</span><br><span class="line">[root@memcached ~]# systemctl start memcached</span><br><span class="line"></span><br><span class="line">[root@memcached ~]# lsof -i:11211</span><br><span class="line">COMMAND    PID     <span class="built_in"> USER </span>  FD  <span class="built_in"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class="line">memcached 4419 memcached   26u  IPv4  51021      0t0  TCP *:memcache (LISTEN)</span><br><span class="line">memcached 4419 memcached   27u <span class="built_in"> IPv6 </span> 51022      0t0  TCP *:memcache (LISTEN)</span><br><span class="line">memcached 4419 memcached   28u  IPv4  51025      0t0  UDP *:memcache </span><br><span class="line">memcached 4419 memcached   29u <span class="built_in"> IPv6 </span> 51026      0t0  UDP *:memcache</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="nginx部署"><a href="#nginx部署" class="headerlink" title="nginx部署"></a>nginx部署</h3><p>1）安装nginx<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># yum -y install nginx</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># nginx -v</span></span><br><span class="line">nginx version: nginx/<span class="number">1.12</span><span class="number">.2</span></span><br></pre></td></tr></table></figure></p><p>2）配置文件配置<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个虚拟主机</span></span><br><span class="line">[root@nginx ~]<span class="comment"># vim /etc/nginx/conf.d/www.conf</span></span><br><span class="line">upstream <span class="keyword">tomcat</span> &#123;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">1.32</span>:<span class="number">8080</span> weight=<span class="number">1</span>;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">1.33</span>:<span class="number">8080</span> weight=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">    listen       <span class="number">88</span> default_server;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    <span class="literal">root</span>         /opt/<span class="literal">project</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#已jsp结尾的动态程序调度给tomcat去处理</span></span><br><span class="line">    location ~.*\.jsp$ &#123;</span><br><span class="line">        proxy_pass http://tomcat;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$remote_addr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">error_page</span> 404 /404.html;</span><br><span class="line">        location = /40x.<span class="keyword">html</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">error_page</span> 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.<span class="keyword">html</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建测试文件</span></span><br><span class="line">[root@nginx ~]<span class="comment"># mkdir /opt/project</span></span><br><span class="line">[root@nginx ~]<span class="comment"># echo "&lt;h1&gt;Nginx IP:192.168.1.31&lt;/h1&gt;" &gt;&gt; /opt/project/index.html</span></span><br></pre></td></tr></table></figure></p><h3 id="tomcat部署"><a href="#tomcat部署" class="headerlink" title="tomcat部署"></a>tomcat部署</h3><p>详细安装参考：<a href="https://www.cnblogs.com/yanjieli/p/11092350.html" target="_blank" rel="noopener">https://www.cnblogs.com/yanjieli/p/11092350.html</a><br><strong>两台tomcat服务器都要执行下面的所有操作，也可以在一台上面执行，然后copy过去。</strong><br>1）上传软件包到服务器，编写一个临时使用的安装脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat1 ~]<span class="comment"># cat install_tomcat.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#----安装java环境</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">InstallJava</span></span> ()&#123;</span><br><span class="line">    tar xf jdk-8u211-linux-x64.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line">    ln -s /usr/<span class="built_in">local</span>/jdk1.8.0_211 /usr/<span class="built_in">local</span>/java</span><br><span class="line">    sed -i.ori <span class="string">'$a export JAVA_HOME=/usr/local/java \nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar'</span> /etc/profile</span><br><span class="line">    <span class="built_in">source</span> /etc/profile</span><br><span class="line">    java -version</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#----安装tomcat环境</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">InstallTomcat</span></span> ()&#123;</span><br><span class="line">    tar xf apache-tomcat-9.0.21.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line">    ln -s /usr/<span class="built_in">local</span>/apache-tomcat-9.0.21 /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"export TOMCAT_HOME=/usr/local/tomcat"</span> &gt;&gt; /etc/profile</span><br><span class="line">    <span class="built_in">source</span> /etc/profile</span><br><span class="line">&#125;</span><br><span class="line">InstallJava</span><br><span class="line">InstallTomcat</span><br><span class="line"></span><br><span class="line">/usr/<span class="built_in">local</span>/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure></p><p>2）执行脚本<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat1 ~]# bash install_tomcat.sh </span><br><span class="line">java version <span class="string">"1.8.0_211"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_211-b12)</span><br><span class="line">Java HotSpot(TM) 64-Bit<span class="built_in"> Server </span>VM (build 25.211-b12, mixed mode)</span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/java</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line"></span><br><span class="line">[root@tomcat1 ~]# ss -nltp |grep :80</span><br><span class="line">LISTEN     0      100         :::8080                    :::*                   users:((<span class="string">"java"</span>,<span class="attribute">pid</span>=2993,fd=54))</span><br><span class="line">LISTEN     0      1         ::ffff:127.0.0.1:8005                    :::*                   users:((<span class="string">"java"</span>,<span class="attribute">pid</span>=2993,fd=74))</span><br><span class="line">LISTEN     0      100         :::8009                    :::*                   users:((<span class="string">"java"</span>,<span class="attribute">pid</span>=2993,fd=59))</span><br></pre></td></tr></table></figure></p><p>3）下载<code>memcached-session-manager</code>等相关软件包并<code>copy</code>到<code>tomcat</code>安装目录的<code>lib</code>目录中<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># mkdir tools &amp;&amp; cd tools</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget http://repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget https://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget https://repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget https://repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget https://repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget https://repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar</span></span><br><span class="line">[root<span class="symbol">@tomcat1</span> ~]<span class="meta"># wget http://repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@tomcat1</span> tools]<span class="meta"># cp ./* /usr/local/tomcat/lib/</span></span><br></pre></td></tr></table></figure></p><p>4）编辑配置文件，添加连接<code>memcached</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># No-Stick模式</span><br><span class="line">[root@tomcat1 ~]# vim /usr/local/tomcat/conf/context.xml</span><br><span class="line"># 在<span class="tag">&lt;<span class="name">Context</span>&gt;</span>和<span class="tag">&lt;/<span class="name">Context</span>&gt;</span>里面加上下面一段</span><br><span class="line"><span class="comment">&lt;!-- 这里的ip为memcached服务器的IP,如果有多个memcached服务器，用逗号隔开 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">memcachedNodes</span>=<span class="string">"n1:192.168.1.34:11211"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">lockingMode</span>=<span class="string">"auto"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">sticky</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">requestUriIgnorePattern</span>= <span class="string">".*\.(png|gif|jpg|css|js)$"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">sessionBackupAsync</span>= <span class="string">"false"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">sessionBackupTimeout</span>= <span class="string">"100"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">copyCollectionsForSerialization</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">transcoderFactoryClass</span>=<span class="string">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p><p>5）准备测试文件<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@tomcat1</span> ~]<span class="comment"># rm -rf /usr/local/tomcat/webapps/*</span></span><br><span class="line">[root<span class="meta">@tomcat1</span> ~]<span class="comment"># mkdir /usr/local/tomcat/webapps/ROOT</span></span><br><span class="line">[root<span class="meta">@tomcat1</span> ~]<span class="comment"># vim /usr/local/tomcat/webapps/ROOT/index.jsp</span></span><br><span class="line">SessionID:<span class="variable">&lt;%=session.getId()%&gt;</span> <span class="variable">&lt;BR&gt;</span></span><br><span class="line">SessionIP:<span class="variable">&lt;%=request.getServerName()%&gt;</span> <span class="variable">&lt;BR&gt;</span></span><br><span class="line">SessionPort:<span class="variable">&lt;%=request.getServerPort()%&gt;</span></span><br></pre></td></tr></table></figure></p><p>6）重启<code>tomcat</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat1 ~]# /usr/local/tomcat/bin/shutdown.sh</span><br><span class="line">[root@tomcat1 ~]# /usr/local/tomcat/bin/startup.sh</span><br><span class="line">[root@tomcat1 ~]# lsof -i:8080</span><br><span class="line">COMMAND  PID<span class="built_in"> USER </span>  FD  <span class="built_in"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class="line">java    4672 root   63u <span class="built_in"> IPv6 </span> 52084      0t0  TCP *:webcache (LISTEN)</span><br></pre></td></tr></table></figure></p><p>7）测试<br>访问tomcat1：<br><img src="/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat1.png" alt><br>访问tomcat2：<br><img src="/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat2.png" alt><br>访问nginx默认页面：<br><img src="/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat4.png" alt><br>访问jsp动态程序：<br><img src="/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat3.png" alt><br>通过上面的访问可以看出，访问静态页面时nginx自身处理，当访问jsp动态的时候会调度给tomcat去处理。并且当一个浏览器访问后，便会一直访问这一个，so，这样就达到了session会话保持。</p><hr><p><strong>补充</strong><br>memcached-session-manager 参数说明：<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">memcachedNodes 必选项，memcached的节点信息，多个memcached节点,中间需要使用空格</span><br><span class="line"></span><br><span class="line">failoverNodes=<span class="string">"n2"</span>  表示当前session保持到n1的memcached节点上</span><br><span class="line">failoverNodes  可选项，不能使用在non-sticky sessions模式。故障转移配置节点，多个使用空格或逗号分开，配置某个节点为备份节点，</span><br><span class="line">当其他节点都不可用时才会存储到备份节点，官方建议配置为和tomcat同服务器的节点。</span><br><span class="line"><span class="section">理由如下:</span></span><br><span class="line">假如有两台服务器m1,m2，其中m1部署tomcat和memcached节点n1，m2部署memcached节点n2。</span><br><span class="line">如果配置tomcat的failoverNodes值为n2或者不配置，则当服务器m1挂掉后n1和tomcat中保存的session会丢失，而n2中未保存或者只保存了部分session，</span><br><span class="line">这就造成 部分用户状态丢失。</span><br><span class="line">如果配置tomcat的failoverNodes值为n1，则当m1挂掉后因为n2中保存了所有的session，所以重启tomcat的时候用户状态不会丢失。</span><br><span class="line">为什么n2中保存了所有的session? 因为failoverNodes配置的值是n1，只有当n2节点不可用时才会把session存储到n1，所以这个时候n1中是没有保存任何session的。</span><br><span class="line">lockingMode  可选值，默认none，只对non-sticky有效。</span><br><span class="line">requestUriIgnorePattern  可选值，制定忽略那些请求的session操作，一般制定静态资源如css,js一类的。</span><br><span class="line">sessionBackupAsync    可选值，默认true，是否异步的方式存储到memcached。</span><br><span class="line">sessionBackupTimeout  可选项，默认100毫秒，异步存储session的超时时间。</span><br></pre></td></tr></table></figure></p><p>相关软件包jar包下载：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">memcached-session-manager 下载地址：<span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/msm/</span></span><br><span class="line"><span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar</span></span><br><span class="line"><span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar</span></span><br><span class="line"></span><br><span class="line">msm-kryo-serializer    下载地址：<span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/</span></span><br><span class="line"><span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar</span></span><br><span class="line"></span><br><span class="line">spymemcached    下载地址：<span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/net/spy/spymemcached/</span></span><br><span class="line"><span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar</span></span><br><span class="line"></span><br><span class="line">serializers    下载地址：<span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/kryo-serializers/</span></span><br><span class="line"><span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar</span></span><br><span class="line"></span><br><span class="line">reflectasm    下载地址：<span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/reflectasm</span></span><br><span class="line"><span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar</span></span><br><span class="line"></span><br><span class="line">minlog    下载地址：<span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/minlog</span></span><br><span class="line"><span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar</span></span><br><span class="line"></span><br><span class="line">kryo    下载地址：<span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/kryo</span></span><br><span class="line"><span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar</span></span><br><span class="line"></span><br><span class="line">asm    下载地址：<span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/org/ow2/asm/asm/</span></span><br><span class="line"><span class="string">https:</span><span class="comment">//repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar     </span></span><br><span class="line"></span><br><span class="line">objenesis    下载地址：<span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/org/objenesis/objenesis/</span></span><br><span class="line"><span class="string">http:</span><span class="comment">//repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;通过&lt;code&gt;Nginx&lt;/code&gt;解析静态页面并将动态负载均衡调度给后面的多个&lt;code&gt;Tomcat&lt;/c
      
    
    </summary>
    
      <category term="Tomcat" scheme="https://leeyj.coding.me/categories/Tomcat/"/>
    
    
      <category term="Tomcat" scheme="https://leeyj.coding.me/tags/Tomcat/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat安装与部署</title>
    <link href="https://leeyj.coding.me/2019/06/26/Tomcat%E5%AE%89%E8%A3%85%E4%B8%8E%E9%83%A8%E7%BD%B2/"/>
    <id>https://leeyj.coding.me/2019/06/26/Tomcat安装与部署/</id>
    <published>2019-06-26T09:36:22.000Z</published>
    <updated>2019-07-10T01:46:29.992Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Tomcat简介"><a href="#Tomcat简介" class="headerlink" title="Tomcat简介"></a>Tomcat简介</h2><p>官网：<a href="http://tomcat.apache.org/" target="_blank" rel="noopener">http://tomcat.apache.org/</a></p><blockquote><p><code>Tomcat</code>服务器是一个免费的开源代码的Web应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下使用，是开发和调试<code>JSP</code>程序的首选。<br><code>Tomcat</code>和<code>Nginx</code>、<code>Apache</code>等<code>Web</code>服务器一样，具有处理<code>HTML</code>页面的功能，另外它还是一个<code>Servlet</code>和<code>JSP</code>容器，独立的<code>Servlet</code>容器是<code>Tomcat</code>的默认模式。不过，<code>Tomcat</code>处理静态<code>HTML</code>的能力不如<code>Nginx/Apache</code>服务器。<br>一般情况下多用<code>Nginx+Tomcat</code>，<code>Nginx</code>处理静态，<code>Tomcat</code>处理动态程序</p></blockquote><h2 id="Tomcat安装"><a href="#Tomcat安装" class="headerlink" title="Tomcat安装"></a>Tomcat安装</h2><blockquote><p>软件下载：<a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">JDK下载</a>  &emsp; <a href="http://tomcat.apache.org/" target="_blank" rel="noopener">Tomcat下载</a><br>本文使用的软件包<code>jdk-8u211</code>,<code>tomcat-9.0.21</code>。 <a href="https://pan.baidu.com/s/1d0g0T75p-CW7uz3ug7I8YA" target="_blank" rel="noopener">下载链接</a> &emsp; 提取码：f0ay</p></blockquote><h3 id="部署Java环境"><a href="#部署Java环境" class="headerlink" title="部署Java环境"></a>部署Java环境</h3><p>将下载的软件包上传到服务器<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压软件包</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个软链接</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># ln -s /usr/local/jdk1.8.0_211 /usr/local/java</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加环境变量</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># sed -i.ori '$a export JAVA_HOME=/usr/local/java \nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载环境变量</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># source /etc/profile</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># env |grep JAVA</span></span><br><span class="line"><span class="keyword">JAVA_HOME=/usr/local/java</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"># </span>查看是否安装成功</span><br><span class="line">[root@tomcat ~]<span class="comment"># java -version</span></span><br><span class="line"><span class="keyword">java </span>version <span class="string">"1.8.0_211"</span></span><br><span class="line"><span class="keyword">Java(TM) </span>SE Runtime Environment (<span class="keyword">build </span><span class="number">1</span>.<span class="number">8</span>.<span class="number">0</span>_211-<span class="keyword">b12)</span></span><br><span class="line"><span class="keyword">Java </span>HotSpot(TM) <span class="number">64</span>-<span class="keyword">Bit </span>Server VM (<span class="keyword">build </span><span class="number">25</span>.<span class="number">211</span>-<span class="keyword">b12, </span>mixed mode)</span><br></pre></td></tr></table></figure></p><h3 id="部署Tomcat"><a href="#部署Tomcat" class="headerlink" title="部署Tomcat"></a>部署Tomcat</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压软件包</span></span><br><span class="line">[root@tomcat ~]# tar xf apache-tomcat-9.0.21.tar.gz -C /usr/local/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个软链接</span></span><br><span class="line">[root@tomcat ~]# ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义tomcat所需的环境变量</span></span><br><span class="line">[root@tomcat ~]# echo <span class="string">"export TOMCAT_HOME=/usr/local/tomcat"</span> &gt;&gt; /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载环境变量</span></span><br><span class="line">[root@tomcat ~]# source /etc/profile</span><br></pre></td></tr></table></figure><h2 id="Tomcat启动"><a href="#Tomcat启动" class="headerlink" title="Tomcat启动"></a>Tomcat启动</h2><p>1）默认的启动方式<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]<span class="meta"># ls /usr/local/tomcat/bin/startup.sh   #启动脚本</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/startup.sh</span><br><span class="line">[root@tomcat ~]<span class="meta"># ls /usr/local/tomcat/bin/shutdown.sh   #停止脚本</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/shutdown.sh</span><br><span class="line"></span><br><span class="line"><span class="meta"># 默认方式启动</span></span><br><span class="line">[root@tomcat ~]<span class="meta"># /usr/local/tomcat/bin/startup.sh </span></span><br><span class="line">Using CATALINA_BASE:   <span class="meta-keyword">/usr/</span>local/tomcat</span><br><span class="line">Using CATALINA_HOME:   <span class="meta-keyword">/usr/</span>local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>temp</span><br><span class="line">Using JRE_HOME:        <span class="meta-keyword">/usr/</span>local/java</span><br><span class="line">Using CLASSPATH:       <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/bootstrap.jar:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line"></span><br><span class="line"><span class="meta"># 默认方式停止</span></span><br><span class="line">[root@tomcat ~]<span class="meta"># /usr/local/tomcat/bin/shutdown.sh </span></span><br><span class="line">Using CATALINA_BASE:   <span class="meta-keyword">/usr/</span>local/tomcat</span><br><span class="line">Using CATALINA_HOME:   <span class="meta-keyword">/usr/</span>local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>temp</span><br><span class="line">Using JRE_HOME:        <span class="meta-keyword">/usr/</span>local/java</span><br><span class="line">Using CLASSPATH:       <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/bootstrap.jar:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/tomcat/</span>bin/tomcat-juli.jar</span><br></pre></td></tr></table></figure></p><p>2）加入<code>/etc/init.d/</code>支持<code>centos6</code>的<code>service</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑/etc/init.d/tomcat脚本</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># vim /etc/init.d/tomcat</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Init file for Tomcat server daemon</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 96 14</span></span><br><span class="line"><span class="comment"># description: Tomcat server daemon</span></span><br><span class="line">JAVA_OPTS=<span class="string">'-Xms64m -Xmx128m'</span></span><br><span class="line">JAVA_HOME=/usr/<span class="built_in">local</span>/jdk1.8.0_211      <span class="comment">#指定jdk安装路径</span></span><br><span class="line">CATALINA_HOME=/usr/<span class="built_in">local</span>/tomcat     <span class="comment">#指定tomcat安装路径</span></span><br><span class="line"><span class="built_in">export</span> JAVA_OPTS JAVA_HOME CATALINA_HOME</span><br><span class="line"><span class="built_in">exec</span> <span class="variable">$CATALINA_HOME</span>/bin/catalina.sh $*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加执行权限</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># chmod +x /etc/init.d/tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动停止测试</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># service tomcat start</span></span><br><span class="line">Using CATALINA_BASE:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/<span class="built_in">local</span>/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/<span class="built_in">local</span>/jdk1.8.0_211</span><br><span class="line">Using CLASSPATH:       /usr/<span class="built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="built_in">local</span>/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line">[root@tomcat ~]<span class="comment"># </span></span><br><span class="line">[root@tomcat ~]<span class="comment"># service tomcat stop</span></span><br><span class="line">Using CATALINA_BASE:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/<span class="built_in">local</span>/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/<span class="built_in">local</span>/jdk1.8.0_211</span><br><span class="line">Using CLASSPATH:       /usr/<span class="built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="built_in">local</span>/tomcat/bin/tomcat-juli.jar</span><br></pre></td></tr></table></figure></p><p>3）加入<code>systemd</code>管理<code>tomcat</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑启动脚本</span></span><br><span class="line">[root@tomcat ~]# vim /usr/lib/systemd/system/tomcat.service</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Tomcat<span class="built_in"> server </span>daemon</span><br><span class="line"><span class="attribute">After</span>=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">Type</span>=oneshot</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/tomcat/bin/startup.sh</span><br><span class="line"><span class="attribute">ExecStop</span>=/usr/local/tomcat/bin/shutdown.sh</span><br><span class="line"><span class="attribute">ExecReload</span>=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attribute">RemainAfterExit</span>=<span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试启动和关闭</span></span><br><span class="line">[root@tomcat ~]# systemctl start tomcat</span><br><span class="line">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class="line">root       4810      1 35 12:37 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.<span class="attribute">file</span>=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.<span class="attribute">manager</span>=org.apache.juli.ClassLoaderLogManager -Djdk.tls.<span class="attribute">ephemeralDHKeySize</span>=2048 -Djava.protocol.handler.<span class="attribute">pkgs</span>=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.<span class="attribute">UMASK</span>=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.<span class="attribute">base</span>=/usr/local/tomcat -Dcatalina.<span class="attribute">home</span>=/usr/local/tomcat -Djava.io.<span class="attribute">tmpdir</span>=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class="line">root       4852   1823  0 12:37 pts/1    00:00:00 grep <span class="attribute">--color</span>=auto tomcat</span><br><span class="line">[root@tomcat ~]# </span><br><span class="line">[root@tomcat ~]# systemctl stop tomcat</span><br><span class="line">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class="line">root       4888   1823  0 12:38 pts/1    00:00:00 grep <span class="attribute">--color</span>=auto tomcat</span><br><span class="line">[root@tomcat ~]# </span><br><span class="line">[root@tomcat ~]# systemctl restart tomcat </span><br><span class="line">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class="line">root       4909      1 43 12:38 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.<span class="attribute">file</span>=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.<span class="attribute">manager</span>=org.apache.juli.ClassLoaderLogManager -Djdk.tls.<span class="attribute">ephemeralDHKeySize</span>=2048 -Djava.protocol.handler.<span class="attribute">pkgs</span>=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.<span class="attribute">UMASK</span>=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.<span class="attribute">base</span>=/usr/local/tomcat -Dcatalina.<span class="attribute">home</span>=/usr/local/tomcat -Djava.io.<span class="attribute">tmpdir</span>=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class="line">root       4959   1823  0 12:38 pts/1    00:00:00 grep <span class="attribute">--color</span>=auto tomcat</span><br><span class="line">[root@tomcat ~]#</span><br><span class="line">[root@tomcat ~]# systemctl status tomcat</span><br><span class="line">● tomcat.service - Tomcat<span class="built_in"> server </span>daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/tomcat.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (exited) since 二 2019-06-25 12:38:22 CST; 3min 53s ago</span><br><span class="line">  Process: 4895 <span class="attribute">ExecStart</span>=/usr/local/tomcat/bin/startup.sh (<span class="attribute">code</span>=exited, <span class="attribute">status</span>=0/SUCCESS)</span><br><span class="line"> Main PID: 4895 (<span class="attribute">code</span>=exited, <span class="attribute">status</span>=0/SUCCESS)</span><br><span class="line">   CGroup: /system.slice/tomcat.service</span><br><span class="line">           └─4909 /usr/bin/java -Djava.util.logging.config.<span class="attribute">file</span>=/usr/local/tomcat/conf/logging.pro...</span><br><span class="line"></span><br><span class="line">6月 25 12:38:22 tomcat systemd[1]: Starting Tomcat<span class="built_in"> server </span>daemon<span class="built_in">..</span>.</span><br><span class="line">6月 25 12:38:22 tomcat startup.sh[4895]: Tomcat started.</span><br><span class="line">6月 25 12:38:22 tomcat systemd[1]: Started Tomcat<span class="built_in"> server </span>daemon.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入开机启动</span></span><br><span class="line">[root@tomcat ~]# systemctl <span class="builtin-name">enable</span> tomcat</span><br><span class="line">[root@tomcat ~]# systemctl list-unit-files  |grep tomcat</span><br><span class="line">tomcat.service                                enabled</span><br></pre></td></tr></table></figure></p><p>tomcat启动成功后默认端口为：8080，访问地址<a href="http://ip:8080" target="_blank" rel="noopener">http://ip:8080</a><br><img src="/2019/06/26/Tomcat安装与部署/tomcat01.png" alt></p><h2 id="Tomcat目录结构"><a href="#Tomcat目录结构" class="headerlink" title="Tomcat目录结构"></a>Tomcat目录结构</h2><p><code>tomcat</code>安装主目录下的各个子目录说明：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]<span class="comment"># cd /usr/local/tomcat/</span></span><br><span class="line">[root@tomcat tomcat]<span class="comment"># tree -L 1</span></span><br><span class="line">.</span><br><span class="line">├── bin<span class="comment">#存放启动、关闭tomcat或者其它功能的脚本(.bat文件和.sh文件)</span></span><br><span class="line">├── BUILDING.txt</span><br><span class="line">├── conf        <span class="comment">#存放tomcat配置相关的文件</span></span><br><span class="line">├── CONTRIBUTING.md</span><br><span class="line">├── <span class="class"><span class="keyword">lib</span>         <span class="comment">#存放Web应用能访问的JAR包</span></span></span><br><span class="line">├── LICENSE</span><br><span class="line">├── logs        <span class="comment">#存放tomcat日志文件</span></span><br><span class="line">├── NOTICE</span><br><span class="line">├── README.md</span><br><span class="line">├── RELEASE-NOTES</span><br><span class="line">├── RUNNING.txt</span><br><span class="line">├── temp        <span class="comment">#临时文件</span></span><br><span class="line">├── webapps     <span class="comment">#Web应用程序的跟目录</span></span><br><span class="line">└── work        <span class="comment">#用以产生有JSP编译出的Servlet的.java和.class文件</span></span><br><span class="line"></span><br><span class="line"><span class="number">7</span> directories, <span class="number">7</span> files</span><br></pre></td></tr></table></figure></p><p><code>webapps</code>目录说明：</p><blockquote><p>这里几个目录对应着主界面的上面的按钮，可以直接在主界面查看帮助文档，及<code>web</code>界面直接管理。</p></blockquote><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat tomcat]<span class="comment"># cd webapps/</span></span><br><span class="line">[root@tomcat webapps]<span class="comment"># ll</span></span><br><span class="line">总用量 4</span><br><span class="line">drwxr-x---<span class="number"> 14 </span>root root<span class="number"> 4096 </span>6月 <span class="number"> 25 </span>11:39 docs          <span class="comment">#tomcat帮助文档</span></span><br><span class="line">drwxr-x--- <span class="number"> 6 </span>root root  <span class="number"> 83 </span>6月 <span class="number"> 25 </span>11:39 examples      <span class="comment">#web应用实例</span></span><br><span class="line">drwxr-x--- <span class="number"> 5 </span>root root  <span class="number"> 87 </span>6月 <span class="number"> 25 </span>11:39 host-manager  <span class="comment">#管理</span></span><br><span class="line">drwxr-x--- <span class="number"> 5 </span>root root <span class="number"> 103 </span>6月 <span class="number"> 25 </span>11:39 manager       <span class="comment">#管理</span></span><br><span class="line">drwxr-x--- <span class="number"> 3 </span>root root <span class="number"> 283 </span>6月 <span class="number"> 25 </span>11:39 ROOT          <span class="comment">#默认网站根目录</span></span><br></pre></td></tr></table></figure><h2 id="Tomcat日志文件"><a href="#Tomcat日志文件" class="headerlink" title="Tomcat日志文件"></a>Tomcat日志文件</h2><blockquote><p><code>tomcat</code>一般有几个日志文件，访问的一般放在<code>localhost</code>日志文件里面，管理的日志放在<code>manager</code>日志文件里面，实时日志一般在<code>catalina.out</code>里面</p></blockquote><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@tomcat tomcat]</span># <span class="selector-tag">cd</span> <span class="selector-tag">logs</span>/</span><br><span class="line"><span class="selector-attr">[root@tomcat logs]</span># <span class="selector-tag">ll</span></span><br><span class="line">总用量 <span class="selector-tag">180</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span> <span class="selector-tag">82372</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span> <span class="selector-tag">catalina</span><span class="selector-class">.2019-06-25</span><span class="selector-class">.log</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span> <span class="selector-tag">82574</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span> <span class="selector-tag">catalina</span><span class="selector-class">.out</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>     <span class="selector-tag">0</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">12</span><span class="selector-pseudo">:18</span> <span class="selector-tag">host-manager</span><span class="selector-class">.2019-06-25</span><span class="selector-class">.log</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>  <span class="selector-tag">6246</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span> <span class="selector-tag">localhost</span><span class="selector-class">.2019-06-25</span><span class="selector-class">.log</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>  <span class="selector-tag">3489</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">14</span><span class="selector-pseudo">:30</span> <span class="selector-tag">localhost_access_log</span><span class="selector-class">.2019-06-25</span><span class="selector-class">.txt</span></span><br><span class="line"><span class="selector-tag">-rw-r-----</span> <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>     <span class="selector-tag">0</span> <span class="selector-tag">6</span>月  <span class="selector-tag">25</span> <span class="selector-tag">12</span><span class="selector-pseudo">:18</span> <span class="selector-tag">manager</span><span class="selector-class">.2019-06-25</span><span class="selector-class">.log</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@tomcat logs]</span># <span class="selector-tag">tailf</span> <span class="selector-tag">catalina</span><span class="selector-class">.out</span> </span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:24.674</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> <span class="selector-tag">Deployment</span> <span class="selector-tag">of</span> <span class="selector-tag">web</span> <span class="selector-tag">application</span> <span class="selector-tag">directory</span> <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/docs]</span> <span class="selector-tag">has</span> <span class="selector-tag">finished</span> <span class="selector-tag">in</span> <span class="selector-attr">[27]</span> <span class="selector-tag">ms</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:24.675</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> 把<span class="selector-tag">web</span> 应用程序部署到目录 <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/examples]</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.113</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> <span class="selector-tag">Deployment</span> <span class="selector-tag">of</span> <span class="selector-tag">web</span> <span class="selector-tag">application</span> <span class="selector-tag">directory</span> <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/examples]</span> <span class="selector-tag">has</span> <span class="selector-tag">finished</span> <span class="selector-tag">in</span> <span class="selector-attr">[438]</span> <span class="selector-tag">ms</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.113</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> 把<span class="selector-tag">web</span> 应用程序部署到目录 <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/host-manager]</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.163</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> <span class="selector-tag">Deployment</span> <span class="selector-tag">of</span> <span class="selector-tag">web</span> <span class="selector-tag">application</span> <span class="selector-tag">directory</span> <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/host-manager]</span> <span class="selector-tag">has</span> <span class="selector-tag">finished</span> <span class="selector-tag">in</span> <span class="selector-attr">[50]</span> <span class="selector-tag">ms</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.163</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> 把<span class="selector-tag">web</span> 应用程序部署到目录 <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/manager]</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.220</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> <span class="selector-tag">Deployment</span> <span class="selector-tag">of</span> <span class="selector-tag">web</span> <span class="selector-tag">application</span> <span class="selector-tag">directory</span> <span class="selector-attr">[/usr/local/apache-tomcat-9.0.21/webapps/manager]</span> <span class="selector-tag">has</span> <span class="selector-tag">finished</span> <span class="selector-tag">in</span> <span class="selector-attr">[57]</span> <span class="selector-tag">ms</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.238</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.coyote</span><span class="selector-class">.AbstractProtocol</span><span class="selector-class">.start</span> 开始协议处理句柄<span class="selector-attr">["http-nio-8080"]</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.298</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.coyote</span><span class="selector-class">.AbstractProtocol</span><span class="selector-class">.start</span> 开始协议处理句柄<span class="selector-attr">["ajp-nio-8009"]</span></span><br><span class="line"><span class="selector-tag">25-Jun-2019</span> <span class="selector-tag">12</span><span class="selector-pseudo">:38</span><span class="selector-pseudo">:25.302</span> 信息 <span class="selector-attr">[main]</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.Catalina</span><span class="selector-class">.start</span> <span class="selector-tag">Server</span> <span class="selector-tag">startup</span> <span class="selector-tag">in</span> <span class="selector-attr">[1,290]</span> <span class="selector-tag">milliseconds</span></span><br></pre></td></tr></table></figure><h2 id="Tomcat配置文件"><a href="#Tomcat配置文件" class="headerlink" title="Tomcat配置文件"></a>Tomcat配置文件</h2><blockquote><p><code>tomcat</code>配置文件存放在安装目录下的<code>conf</code>目录下面</p></blockquote><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入到配置文件目录</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># cd /usr/local/tomcat/conf/</span></span><br><span class="line">[root@tomcat conf]<span class="comment"># ll</span></span><br><span class="line">总用量 228</span><br><span class="line">drwxr-x---<span class="number"> 3 </span>root root    <span class="number"> 23 </span>6月 <span class="number"> 25 </span>12:18 Catalina</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root <span class="number"> 12873 </span>6月  <span class="number"> 5 </span>04:23 catalina.policy</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 7243 </span>6月  <span class="number"> 5 </span>04:23 catalina.properties</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 1400 </span>6月  <span class="number"> 5 </span>04:23 context.xml</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 1149 </span>6月  <span class="number"> 5 </span>04:23 jaspic-providers.xml</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 2313 </span>6月  <span class="number"> 5 </span>04:23 jaspic-providers.xsd</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 4144 </span>6月  <span class="number"> 5 </span>04:23 logging.properties</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 7511 </span>6月  <span class="number"> 5 </span>04:23 server.xml  <span class="comment">#主配置文件</span></span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 2164 </span>6月  <span class="number"> 5 </span>04:23 tomcat-users.xml  <span class="comment">#Tomcat管理用户配置文件</span></span><br><span class="line">-rw-------<span class="number"> 1 </span>root root  <span class="number"> 2633 </span>6月  <span class="number"> 5 </span>04:23 tomcat-users.xsd</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 171962 </span>6月  <span class="number"> 5 </span>04:23 web.xml</span><br></pre></td></tr></table></figure><h3 id="Tomcat管理"><a href="#Tomcat管理" class="headerlink" title="Tomcat管理"></a>Tomcat管理</h3><blockquote><p>配置<code>tomcat</code>的<code>web</code>界面管理功能，可以进行配置文件的管理，及部署在<code>tomcat</code>上的应用进行管理，默认情况是处于禁用状态。如果要开启这个功能，需要配置管理用户，即配置<code>tomcat-users.xml</code>文件。并且还需要修改manager项目下的<code>content.xml</code>文件，让其所有地址可访问</p></blockquote><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># vim /usr/local/tomcat/conf/tomcat-users.xml</span></span><br><span class="line">...</span><br><span class="line">&lt;role rolename=<span class="string">"manager-gui"</span>/&gt;</span><br><span class="line">&lt;role rolename=<span class="string">"admin-gui"</span>/&gt;</span><br><span class="line">&lt;user username=<span class="string">"tomcat"</span> password=<span class="string">"tomcat"</span> roles=<span class="string">"manager-gui,admin-gui"</span>/&gt;</span><br><span class="line">&lt;/tomcat-users&gt; <span class="comment">#在这行前面加入上面三行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑manager/META-INF/context.xml</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># vim /usr/local/tomcat/webapps/manager/META-INF/context.xml</span></span><br><span class="line"><span class="comment">#将</span></span><br><span class="line">allow=<span class="string">"127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1"</span> /&gt;</span><br><span class="line"><span class="comment">#改为</span></span><br><span class="line">allow=<span class="string">"\d+\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1"</span> /&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑host-manager/META-INF/context.xml</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># vim /usr/local/tomcat/webapps/host-manager/META-INF/context.xml</span></span><br><span class="line"><span class="comment">#将</span></span><br><span class="line">allow=<span class="string">"127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1"</span> /&gt;</span><br><span class="line"><span class="comment">#改为</span></span><br><span class="line">allow=<span class="string">"\d+\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1"</span> /&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启tomcat</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure><p>访问测试<br><img src="/2019/06/26/Tomcat安装与部署/tomcat02.png" alt><br>状态页面：<br><img src="/2019/06/26/Tomcat安装与部署/tomcat03.png" alt><br>Manager页面：<br><img src="/2019/06/26/Tomcat安装与部署/tomcat04.png" alt><br>Host Manager页面：<br><img src="/2019/06/26/Tomcat安装与部署/tomcat05.png" alt></p><h3 id="server-xml配置文件注释"><a href="#server-xml配置文件注释" class="headerlink" title="server.xml配置文件注释"></a>server.xml配置文件注释</h3><p>参考：<a href="https://www.cnblogs.com/sunshine-1/p/8990044.html" target="_blank" rel="noopener">https://www.cnblogs.com/sunshine-1/p/8990044.html</a><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.security.SecurityListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="attr">SSLEngine</span>=<span class="string">"on"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JasperListener"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span> </span><br><span class="line">  <span class="comment">&lt;!-- 全局命名资源，来定义一些外部访问资源，其作用是为所有引擎应用程序所引用的外部资源的定义 --!&gt; </span></span><br><span class="line"><span class="comment">    &lt;Resource name="UserDatabase" auth="Container" </span></span><br><span class="line"><span class="comment">              type="org.apache.catalina.UserDatabase" </span></span><br><span class="line"><span class="comment">              description="User database that can be updated and saved" </span></span><br><span class="line"><span class="comment">              factory="org.apache.catalina.users.MemoryUserDatabaseFactory" </span></span><br><span class="line"><span class="comment">              pathname="conf/tomcat-users.xml" /&gt; </span></span><br><span class="line"><span class="comment">  &lt;/GlobalNamingResources&gt; </span></span><br><span class="line"><span class="comment">  &lt;!-- 定义的一个名叫“UserDatabase”的认证资源，将conf/tomcat-users.xml加载至内存中，在需要认证的时候到内存中进行认证 --&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span> </span><br><span class="line">  <span class="comment">&lt;!-- # 定义Service组件，同来关联Connector和Engine，一个Engine可以对应多个Connector，每个Service中只能一个Engine --!&gt; </span></span><br><span class="line"><span class="comment">    &lt;Connector port="80" protocol="HTTP/1.1" connectionTimeout="20000" redirectPort="8443" /&gt; </span></span><br><span class="line"><span class="comment">    &lt;!-- 修改HTTP/1.1的Connector监听端口为80.客户端通过浏览器访问的请求，只能通过HTTP传递给tomcat。还可以设置server与URIEncoding参数 --&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8009"</span> <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"test.com"</span>&gt;</span> </span><br><span class="line">    <span class="comment">&lt;!-- 修改当前Engine，默认主机是，www.test.com  --&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span>/&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span> </span><br><span class="line">    # Realm组件，定义对当前容器内的应用程序访问的认证，通过外部资源UserDatabase进行认证 </span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"test.com"</span>  <span class="attr">appBase</span>=<span class="string">"/web"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span> </span><br><span class="line">      <span class="comment">&lt;!--  定义一个主机，域名为：test.com，应用程序的目录是/web，设置自动部署，自动解压    --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Alias</span>&gt;</span>www.test.com<span class="tag">&lt;/<span class="name">Alias</span>&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--    定义一个别名www.test.com，类似apache的ServerAlias --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span>=<span class="string">"www/"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> /&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--    定义该应用程序，访问路径""，即访问www.test.com即可访问，网页目录为：相对于appBase下的www/，即/web/www，并且当该应用程序下web.xml或者类等有相关变化时，自动重载当前配置，即不用重启tomcat使部署的新应用程序生效  --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">"/bbs"</span> <span class="attr">docBase</span>=<span class="string">"/web/bbs"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> /&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--  定义另外一个独立的应用程序(虚拟主机)，访问路径为：www.test.com/bbs，该应用程序网页目录为/web/bbs   --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"/web/www/logs"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"www_access."</span> <span class="attr">suffix</span>=<span class="string">".log"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--   定义一个Valve组件，用来记录tomcat的访问日志，日志存放目录为：/web/www/logs如果定义为相对路径则是相当于$CATALINA_HOME，并非相对于appBase，这个要注意。定义日志文件前缀为www_access.并以.log结尾，pattern定义日志内容格式，具体字段表示可以查看tomcat官方文档   --&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"manager.test.com"</span> <span class="attr">appBase</span>=<span class="string">"webapps"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span> </span><br><span class="line">      <span class="comment">&lt;!--   定义一个主机名为man.test.com，应用程序目录是$CATALINA_HOME/webapps,自动解压，自动部署   --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.RemoteAddrValve"</span> <span class="attr">allow</span>=<span class="string">"172.16.100.*"</span> /&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--   定义远程地址访问策略，仅允许172.16.100.*网段访问该主机，其他的将被拒绝访问  --&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"/web/bbs/logs"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"bbs_access."</span> <span class="attr">suffix</span>=<span class="string">".log"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--   定义该主机的访问日志      --&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="Tomcat单实例站点部署"><a href="#Tomcat单实例站点部署" class="headerlink" title="Tomcat单实例站点部署"></a>Tomcat单实例站点部署</h2><blockquote><p>以部署<code>jspxcms</code>为例，在上面已部署的环境下继续操作。</p></blockquote><p>1）安装<code>MySQL</code>及创建库<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@tomcat ~</span>]<span class="meta"># yum -y install mariadb mariadb-server</span></span><br><span class="line">[<span class="meta">root@tomcat ~</span>]<span class="meta"># systemctl enable mariadb</span></span><br><span class="line">[<span class="meta">root@tomcat ~</span>]<span class="meta"># systemctl start mariadb</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 创建数据库并授权</span></span><br><span class="line">MariaDB [(none)]&gt; create database jspxcms_test character <span class="keyword">set</span> utf8;</span><br><span class="line">MariaDB [(none)]&gt; grant all <span class="keyword">on</span> jspxcms_test.* to <span class="string">'jspxcmsuser'</span>@<span class="string">'localhost'</span> identified <span class="keyword">by</span> <span class="string">'123'</span>;</span><br><span class="line">MariaDB [(none)]&gt; flush privileges;</span><br></pre></td></tr></table></figure></p><p>2）部署<code>jspxcms</code><br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tomcat默认的网站目录</span></span><br><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># ls /usr/local/tomcat/webapps/</span></span><br><span class="line">docs  examples  host-manager  manager  ROOT</span><br><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># ls /usr/local/tomcat/webapps/ROOT/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传jspxcms安装包并解压</span></span><br><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># mkdir tools</span></span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># ls</span></span><br><span class="line">jspxcms-<span class="number">9.5</span>.<span class="number">0</span>-release.zip</span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># unzip jspxcms-9.5.0-release.zip</span></span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># ls</span></span><br><span class="line">CHANGELOG.txt  database  jspxcms-<span class="number">9.5</span>.<span class="number">0</span>-release.zip  Jspxcms安装手册.pdf  ROOT  用户许可协议.txt</span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># rm -rf /usr/local/tomcat/webapps/*</span></span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># cp -a ROOT /usr/local/tomcat/webapps/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入sql文件</span></span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># mysql -D jspxcms_test &lt; database/mysql.sql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件配置数据库连接信息</span></span><br><span class="line">[root<span class="variable">@tomcat</span> tools]<span class="comment"># vim /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/application.properties</span></span><br><span class="line">spring.datasource.url=<span class="symbol">jdbc:</span><span class="symbol">mysql:</span>/<span class="regexp">/127.0.0.1:3306/jspxcms</span>_test?characterEncoding=utf8</span><br><span class="line"><span class="comment"># \u6570\u636E\u5E93\u7528\u6237\u540D</span></span><br><span class="line">spring.datasource.username=jspxcmsuser</span><br><span class="line"><span class="comment"># \u6570\u636E\u5E93\u5BC6\u7801</span></span><br><span class="line">spring.datasource.password=<span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启tomcat</span></span><br><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure></p><p>3）<code>web</code>页面访问 前台地址：<a href="http://ip:8080" target="_blank" rel="noopener">http://ip:8080</a>  &emsp;后台地址：<a href="http://ip:8080/cmscp/index.do" target="_blank" rel="noopener">http://ip:8080/cmscp/index.do</a>   &emsp; 默认账号：admin  密码为空<br><img src="/2019/06/26/Tomcat安装与部署/tomcat06.png" alt><br><img src="/2019/06/26/Tomcat安装与部署/tomcat07.png" alt></p><h2 id="Tomcat多实例站点部署"><a href="#Tomcat多实例站点部署" class="headerlink" title="Tomcat多实例站点部署"></a>Tomcat多实例站点部署</h2><blockquote><p>多实例作用运行不同的应用（类似虚拟主机）<br>多实例运行相同的应用（实现负载均衡，支持高并发处理，session问题）<br>这里基于上面已安装的tomcat环境</p></blockquote><table><thead><tr><th>环境</th><th>Web监听端口</th><th>管理实例端口</th><th>站点家目录</th></tr></thead><tbody><tr><td>tomcat9_1</td><td>8081</td><td>8091</td><td>/webapps/tomcat9_1</td></tr><tr><td>tomcat9_2</td><td>8082</td><td>8092</td><td>/webapps/tomcat9_2</td></tr></tbody></table><p>1）拷贝tomcat目录<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]<span class="comment"># cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_1</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_2</span></span><br></pre></td></tr></table></figure></p><p>2）编辑配置文件，修改监听端口和站点家目录<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]# vim /usr/local/tomcat9_1/conf/server.xml</span><br><span class="line">&lt;Server <span class="attribute">port</span>=<span class="string">"8091"</span> <span class="attribute">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span><br><span class="line">&lt;Connector <span class="attribute">port</span>=<span class="string">"8081"</span> <span class="attribute">protocol</span>=<span class="string">"HTTP/1.1"</span></span><br><span class="line">           <span class="attribute">connectionTimeout</span>=<span class="string">"20000"</span></span><br><span class="line">           <span class="attribute">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span><br><span class="line">&lt;Host <span class="attribute">name</span>=<span class="string">"localhost"</span>  <span class="attribute">appBase</span>=<span class="string">"/webapps/tomcat9_1"</span></span><br><span class="line">            <span class="attribute">unpackWARs</span>=<span class="string">"true"</span> <span class="attribute">autoDeploy</span>=<span class="string">"true"</span>&gt;</span><br><span class="line"></span><br><span class="line">[root@tomcat ~]# vim /usr/local/tomcat9_2/conf/server.xml</span><br><span class="line">&lt;Server <span class="attribute">port</span>=<span class="string">"8092"</span> <span class="attribute">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span><br><span class="line">&lt;Connector <span class="attribute">port</span>=<span class="string">"8082"</span> <span class="attribute">protocol</span>=<span class="string">"HTTP/1.1"</span></span><br><span class="line">           <span class="attribute">connectionTimeout</span>=<span class="string">"20000"</span></span><br><span class="line">           <span class="attribute">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span><br><span class="line">&lt;Host <span class="attribute">name</span>=<span class="string">"localhost"</span>  <span class="attribute">appBase</span>=<span class="string">"/webapps/tomcat9_2"</span></span><br><span class="line">            <span class="attribute">unpackWARs</span>=<span class="string">"true"</span> <span class="attribute">autoDeploy</span>=<span class="string">"true"</span>&gt;</span><br></pre></td></tr></table></figure></p><p>3）创建站点家目录，及测试页面准备<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@tomcat</span> ~]<span class="comment"># mkdir -p /webapps/tomcat9_&#123;1,2&#125;</span></span><br><span class="line">[root<span class="meta">@tomcat</span> ~]<span class="comment"># mkdir /webapps/tomcat9_&#123;1,2&#125;/ROOT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tomcat9_1测试页面准备</span></span><br><span class="line">[root<span class="meta">@tomcat</span> ~]<span class="comment"># vim /webapps/tomcat9_1/ROOT/index.jsp</span></span><br><span class="line"><span class="variable">&lt;html&gt;</span></span><br><span class="line"><span class="variable">&lt;body&gt;</span></span><br><span class="line"><span class="variable">&lt;center&gt;</span></span><br><span class="line"><span class="variable">&lt;H1&gt;</span><span class="variable">&lt;%=new java.util.Date()%&gt;</span><span class="variable">&lt;/H1&gt;</span></span><br><span class="line"><span class="variable">&lt;H2&gt;</span>tomcat9_1<span class="variable">&lt;/H2&gt;</span></span><br><span class="line"><span class="variable">&lt;/center&gt;</span></span><br><span class="line"><span class="variable">&lt;/body&gt;</span></span><br><span class="line"><span class="variable">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tomcat9_2测试页面准备</span></span><br><span class="line">[root<span class="meta">@tomcat</span> ~]<span class="comment"># vim /webapps/tomcat9_2/ROOT/index.jsp</span></span><br><span class="line"><span class="variable">&lt;html&gt;</span></span><br><span class="line"><span class="variable">&lt;body&gt;</span></span><br><span class="line"><span class="variable">&lt;center&gt;</span></span><br><span class="line"><span class="variable">&lt;H1&gt;</span><span class="variable">&lt;%=new java.util.Date()%&gt;</span><span class="variable">&lt;/H1&gt;</span></span><br><span class="line"><span class="variable">&lt;H2&gt;</span>tomcat9_2<span class="variable">&lt;/H2&gt;</span></span><br><span class="line"><span class="variable">&lt;/center&gt;</span></span><br><span class="line"><span class="variable">&lt;/body&gt;</span></span><br><span class="line"><span class="variable">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure></p><p>4）删除掉之前的站点目录里面的东西，对这里没有用了。可以直接删掉<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@tomcat</span> ~]<span class="meta"># rm -rf /usr/local/tomcat9_2/webapps/*</span></span><br><span class="line">[root<span class="symbol">@tomcat</span> ~]<span class="meta"># rm -rf /usr/local/tomcat9_1/webapps/*</span></span><br></pre></td></tr></table></figure></p><p>5）启动<code>tomcat1</code>和<code>tomcat2</code><br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># for i in &#123;1..2&#125;;do /usr/local/tomcat9_$i/bin/startup.sh; done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 端口查看</span></span><br><span class="line">[root<span class="variable">@tomcat</span> ~]<span class="comment"># ss -tnlp |grep :80</span></span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>         ::<span class="symbol">:</span><span class="number">8080</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">27023</span>,fd=<span class="number">54</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>         ::<span class="symbol">:</span><span class="number">8081</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">28687</span>,fd=<span class="number">54</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>         ::<span class="symbol">:</span><span class="number">8082</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">28708</span>,fd=<span class="number">54</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">1</span>         ::<span class="symbol">ffff:</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:</span><span class="number">8091</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">28687</span>,fd=<span class="number">65</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">1</span>         ::<span class="symbol">ffff:</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:</span><span class="number">8092</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">28708</span>,fd=<span class="number">66</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">1</span>         ::<span class="symbol">ffff:</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:</span><span class="number">8005</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">27023</span>,fd=<span class="number">71</span>))</span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>         ::<span class="symbol">:</span><span class="number">8009</span>                    ::<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">"java"</span>,pid=<span class="number">27023</span>,fd=<span class="number">59</span>)</span><br></pre></td></tr></table></figure></p><p>6）访问测试<br><img src="/2019/06/26/Tomcat安装与部署/tomcat08.png" alt="http://192.168.1.31:8081"><br><img src="/2019/06/26/Tomcat安装与部署/tomcat09.png" alt="http://192.168.1.31:8082"></p><p><strong>补充：Tomcat多实例启动脚本</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]<span class="comment"># cat TomcatSys.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Desc：用于tomcat多实例部署启动脚本。</span></span><br><span class="line"><span class="comment">#Date：2019-6-26</span></span><br><span class="line"><span class="comment">#by：Lee-YJ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"tomcat1"</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> CATALINA_HOME=<span class="string">"/usr/local/tomcat9_1"</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"tomcat2"</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> CATALINA_HOME=<span class="string">"/usr/local/tomcat9_2"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;[tomcat1|tomcat2] start|stop|restart&#125;"</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$2</span>"</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    <span class="variable">$CATALINA_HOME</span>/bin/startup.sh</span><br><span class="line">    ;;</span><br><span class="line">stop)</span><br><span class="line">    <span class="variable">$CATALINA_HOME</span>/bin/shutdown.sh</span><br><span class="line">    ;;</span><br><span class="line">restart)</span><br><span class="line">    <span class="variable">$CATALINA_HOME</span>/bin/shutdown.sh</span><br><span class="line">    sleep 3</span><br><span class="line">    <span class="variable">$CATALINA_HOME</span>/bin/startup.sh</span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">    <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;[tomcat1|tomcat2] start|stop|restart&#125;"</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用说明：</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># ./TomcatSys.sh tomcat1 start      #启动tomcat1</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># ./TomcatSys.sh tomcat1 stop       #停止tomcat1</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># ./TomcatSys.sh tomcat2 restart    #重启tomcat2</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Tomcat简介&quot;&gt;&lt;a href=&quot;#Tomcat简介&quot; class=&quot;headerlink&quot; title=&quot;Tomcat简介&quot;&gt;&lt;/a&gt;Tomcat简介&lt;/h2&gt;&lt;p&gt;官网：&lt;a href=&quot;http://tomcat.apache.org/&quot; target=
      
    
    </summary>
    
      <category term="Tomcat" scheme="https://leeyj.coding.me/categories/Tomcat/"/>
    
    
      <category term="Tomcat" scheme="https://leeyj.coding.me/tags/Tomcat/"/>
    
  </entry>
  
  <entry>
    <title>Cobbler自动化部署</title>
    <link href="https://leeyj.coding.me/2019/06/12/Cobbler%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"/>
    <id>https://leeyj.coding.me/2019/06/12/Cobbler自动化部署/</id>
    <published>2019-06-12T02:10:22.000Z</published>
    <updated>2019-07-10T01:46:29.912Z</updated>
    
    <content type="html"><![CDATA[<h2 id="cobbler简介"><a href="#cobbler简介" class="headerlink" title="cobbler简介"></a>cobbler简介</h2><blockquote><p><code>Cobbler</code> 可以用来快速建立 <code>Linux</code> 网络安装环境，它已将<code>Linux</code>网络安装的技术门槛，从大专以上文化水平，成功降低到了初中水平，连补鞋匠都能学会。<br>网络安装服务器套件<code>Cobbler</code>（补鞋匠）从前，我们一直在装机民工这份很有前途的职业。自打若干年前<code>Red Hat</code>推出了 <code>Kickstart</code>，此后我们顿觉身价增倍。不再需要刻了光盘一台一台的安装<code>Linux</code>，只要搞定<code>PXE</code>、<code>DHCP</code>、<code>TFTP</code>，还有那满屏眼花缭乱不知所云的<code>Kickstart</code>脚本，我们就可以像哈利波特一样，轻点魔棒，瞬间安装上百台服务器。这一堆花里胡哨的东西可不是一般人能够整明白的，没有大专以上的学历，通不过英语四级，根本别想玩转。总而言之，这是一份多么有前途，多么有技术含量的工作啊。很不幸，<code>Red Ha</code>t 最新（<code>Cobbler</code>项目最初在<code>2008</code>年左右发布）发布了网络安装服务器套件<code>Cobbler</code>（补鞋匠），它已将<code>Linux</code>网络安装的技术门槛，从大专以上文化水平，成功降低到初中以下水平，连补鞋匠都能学会。</p></blockquote><blockquote><p>1、<code>Cobbler</code>是一个<code>Linux</code>服务器安装的服务，可以通过网络启动（<code>PXE</code>）的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理<code>DHCP</code>，<code>DNS</code>等。<br>2、<code>Cobbler</code>可以使用命令行方式管理，也提供了基于Web的界面管理工具（<code>cobbler-web</code>），还提供了<code>API</code>接口，可以方便二次开发使用。<br>3、<code>Cobbler</code>是较早前的<code>kickstart</code>的升级版，优点是比较容易配置，还自带web界面比较易于管理。<br>4、<code>Cobbler</code>内置了一个轻量级配置管理系统，但它也支持和其它配置管理系统集成，如<code>Puppet</code>。</p></blockquote><p><strong>参考网站</strong></p><p><a href="http://cobbler.github.io/" target="_blank" rel="noopener">cobbler官网</a></p><p><a href="https://www.linuxidc.com/Linux/2017-08/146168.htm" target="_blank" rel="noopener">Kickstart文件编写参考</a></p><h2 id="cobbler对应关系"><a href="#cobbler对应关系" class="headerlink" title="cobbler对应关系"></a>cobbler对应关系</h2><p><img src="/2019/06/12/Cobbler自动化部署/cobbler01.png" alt></p><blockquote><p><code>Cobbler</code>的配置结构基于一组注册的对象。每个对象表示一个与另一个实体相关联的实体。当一个对象指向另一个对象时，它就继承了被指向对象的数据，并可覆盖或添加更多特定信息。</p><ul><li>发行版(<code>distros</code>)： 表示一个操作系统。它承载了内核和<code>initrd</code>的信息，以及内核参数等其他数据。</li><li>配置文件(<code>profiles</code>)：包含一个发行版、一个<code>kickstart</code>文件以及可能的存储库，还包括更多特定的内核参数等其他数据。</li><li>系统(<code>systems</code>)：表示要配给的机器。它包括一个配置文件或一个镜像、<code>IP</code>和<code>MAC</code>地址、电源管理（地址、凭据、类型）以及更为专业的数据等信息。</li><li>镜像(<code>images</code>)：可以替换一个保函不屑于此类别的文件的发行版对象（例如，无法分为内核和<code>initrd</code>的对象）。</li></ul></blockquote><h2 id="cobbler集成的服务"><a href="#cobbler集成的服务" class="headerlink" title="cobbler集成的服务"></a>cobbler集成的服务</h2><ul><li>PXE服务支持</li><li>DHCP服务管理</li><li>DNS服务管理</li><li>电源管理</li><li>Kickstart服务支持</li><li>YUM仓库管理</li><li>TFTP</li><li>Apache</li></ul><h2 id="cobbler工作原理"><a href="#cobbler工作原理" class="headerlink" title="cobbler工作原理"></a>cobbler工作原理</h2><p><img src="/2019/06/12/Cobbler自动化部署/cobbler09.png" alt></p><p><strong>Server端</strong></p><ul><li>启动<code>Cobbler</code>服务</li><li>进行<code>Cobbler</code>错误检查，执行<code>cobbler check</code>命令</li><li>进行配置同步，执行<code>cobbler syn</code>c命令</li><li>复制相关启动文件到<code>TFTP</code>目录中</li><li>启动<code>DHCP</code>服务，提供地址分配</li><li><code>DHCP</code>服务分配IP地址</li><li><code>TFTP</code>传输启动文件</li><li><code>Server</code>端接收安装信息</li><li><code>Server</code>端发送<code>ISO</code>镜像与<code>Kickstart</code>文件</li></ul><p><strong>Client端</strong></p><ul><li>客户端以<code>PXE</code>模式启动</li><li>客户端获取<code>IP</code>地址</li><li>通过<code>TFTP</code>服务器获取启动文件</li><li>进入<code>Cobbler</code>安装选择界面</li><li>根据配置信息准备安装系统</li><li>加载<code>Kickstart</code>文件</li><li>传输系统安装的其它文件</li><li>进行安装系统</li></ul><h2 id="cobbler安装"><a href="#cobbler安装" class="headerlink" title="cobbler安装"></a>cobbler安装</h2><blockquote><p>说明：虚拟机网卡采用NAT模式，不要使用桥接模式，因为后面会搭建DHCP服务器，在同一个局域网多个DHCP服务会有冲突。<br>VMware的NAT模式的dhcp服务也关闭，避免干扰。<br><img src="/2019/06/12/Cobbler自动化部署/cobbler02.png" alt></p></blockquote><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 关闭防火墙、selinux等</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl stop firewalld</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl disable firewalld</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># setenforce 0</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># sed -i <span class="string">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/sysconfig/selinux</span></span><br></pre></td></tr></table></figure><h3 id="安装cobbler"><a href="#安装cobbler" class="headerlink" title="安装cobbler"></a>安装cobbler</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 配置epel源</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># yum -y install epel-release</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 安装cobbler及dhcp httpd xinetd cobbler-web</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># yum -y install cobbler cobbler-web tftp-server dhcp httpd xinetd</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 启动cobbler及httpd并加入开机启动</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl start httpd cobblerd</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl enable httpd cobblerd</span></span><br></pre></td></tr></table></figure><p>查看安装后相关文件<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="meta"># rpm -ql cobbler</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler                  <span class="meta"># 配置文件目录</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/settings         <span class="meta"># cobbler主配置文件，这个文件是YAML格式，Cobbler是python写的程序。</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/dhcp.template    <span class="meta"># DHCP服务的配置模板</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/tftpd.template   <span class="meta"># tftp服务的配置模板</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/rsync.template   <span class="meta"># rsync服务的配置模板</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/iso              <span class="meta"># iso模板配置文件目录</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/pxe              <span class="meta"># pxe模板文件目录</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/power            <span class="meta"># 电源的配置文件目录</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/users.conf       <span class="meta"># Web服务授权配置文件</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/users.digest     <span class="meta"># 用于web访问的用户名密码配置文件</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/dnsmasq.template <span class="meta"># DNS服务的配置模板</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>cobbler/modules.conf     <span class="meta"># Cobbler模块配置文件</span></span><br><span class="line"><span class="meta-keyword">/var/</span>lib/cobbler              <span class="meta"># Cobbler数据目录</span></span><br><span class="line"><span class="meta-keyword">/var/</span>lib<span class="meta-keyword">/cobbler/</span>config       <span class="meta"># 配置文件</span></span><br><span class="line"><span class="meta-keyword">/var/</span>lib<span class="meta-keyword">/cobbler/</span>kickstarts   <span class="meta"># 默认存放kickstart文件</span></span><br><span class="line"><span class="meta-keyword">/var/</span>lib<span class="meta-keyword">/cobbler/</span>loaders      <span class="meta"># 存放的各种引导程序</span></span><br><span class="line"><span class="meta-keyword">/var/</span>www/cobbler              <span class="meta"># 系统安装镜像目录</span></span><br><span class="line"><span class="meta-keyword">/var/</span>www<span class="meta-keyword">/cobbler/</span>ks_mirror    <span class="meta"># 导入的系统镜像列表</span></span><br><span class="line"><span class="meta-keyword">/var/</span>www<span class="meta-keyword">/cobbler/</span>images       <span class="meta"># 导入的系统镜像启动文件</span></span><br><span class="line"><span class="meta-keyword">/var/</span>www<span class="meta-keyword">/cobbler/</span>repo_mirror  <span class="meta"># yum源存储目录</span></span><br><span class="line"><span class="meta-keyword">/var/</span>log/cobbler              <span class="meta"># 日志目录</span></span><br><span class="line"><span class="meta-keyword">/var/</span>log<span class="meta-keyword">/cobbler/</span>install.log  <span class="meta"># 客户端系统安装日志</span></span><br><span class="line"><span class="meta-keyword">/var/</span>log<span class="meta-keyword">/cobbler/</span>cobbler.log  <span class="meta"># cobbler日志</span></span><br></pre></td></tr></table></figure></p><h3 id="配置cobbler"><a href="#配置cobbler" class="headerlink" title="配置cobbler"></a>配置cobbler</h3><blockquote><p>检查<code>Cobbler</code>的配置，如果看不到下面的结果，再次重启<code>cobbler</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="comment"># cobbler check</span></span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line"></span><br><span class="line">1 : The 'server' field in /etc/cobbler/settings must be <span class="keyword">set</span> <span class="keyword">to</span> something other <span class="keyword">than</span> localhost, <span class="keyword">or</span> kickstarting features will <span class="keyword">not</span> work.  This should be a resolvable hostname <span class="keyword">or</span> IP <span class="keyword">for</span> the boot <span class="keyword">server</span> <span class="keyword">as</span> reachable <span class="keyword">by</span> <span class="keyword">all</span> machines that will <span class="keyword">use</span> it.</span><br><span class="line"><span class="number">2</span> : <span class="keyword">For</span> PXE <span class="keyword">to</span> be functional, the <span class="string">'next_server'</span> <span class="keyword">field</span> <span class="keyword">in</span> /etc/cobbler/<span class="keyword">settings</span> must be <span class="keyword">set</span> <span class="keyword">to</span> something other <span class="keyword">than</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>, <span class="keyword">and</span> should <span class="keyword">match</span> the IP <span class="keyword">of</span> the boot <span class="keyword">server</span> <span class="keyword">on</span> the PXE network.</span><br><span class="line"><span class="number">3</span> : <span class="keyword">change</span> <span class="string">'disable'</span> <span class="keyword">to</span> <span class="string">'no'</span> <span class="keyword">in</span> /etc/xinetd.d/tftp</span><br><span class="line"><span class="number">4</span> : <span class="keyword">Some</span> network boot-loaders <span class="keyword">are</span> <span class="keyword">missing</span> <span class="keyword">from</span> /<span class="keyword">var</span>/lib/cobbler/loaders, you may run <span class="string">'cobbler get-loaders'</span> <span class="keyword">to</span> download them, <span class="keyword">or</span>, <span class="keyword">if</span> you <span class="keyword">only</span> want <span class="keyword">to</span> handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* <span class="keyword">version</span> <span class="keyword">of</span> the syslinux <span class="keyword">package</span> installed <span class="keyword">and</span> can <span class="keyword">ignore</span> this message entirely.  Files <span class="keyword">in</span> this <span class="keyword">directory</span>, should you want <span class="keyword">to</span> support <span class="keyword">all</span> architectures, should <span class="keyword">include</span> pxelinux<span class="number">.0</span>, menu.c32, elilo.efi, <span class="keyword">and</span> yaboot. The <span class="string">'cobbler get-loaders'</span> command <span class="keyword">is</span> the easiest way <span class="keyword">to</span> resolve these requirements.</span><br><span class="line"><span class="number">5</span> : <span class="keyword">enable</span> <span class="keyword">and</span> <span class="keyword">start</span> rsyncd.service <span class="keyword">with</span> systemctl</span><br><span class="line"><span class="number">6</span> : debmirror <span class="keyword">package</span> <span class="keyword">is</span> <span class="keyword">not</span> installed, it will be <span class="keyword">required</span> <span class="keyword">to</span> manage debian deployments <span class="keyword">and</span> repositories</span><br><span class="line"><span class="number">7</span> : ksvalidator was <span class="keyword">not</span> <span class="keyword">found</span>, <span class="keyword">install</span> pykickstart</span><br><span class="line"><span class="number">8</span> : The <span class="keyword">default</span> <span class="keyword">password</span> used <span class="keyword">by</span> the <span class="keyword">sample</span> templates <span class="keyword">for</span> newly installed machines (default_password_crypted <span class="keyword">in</span> /etc/cobbler/<span class="keyword">settings</span>) <span class="keyword">is</span> still <span class="keyword">set</span> <span class="keyword">to</span> <span class="string">'cobbler'</span> <span class="keyword">and</span> should be <span class="keyword">changed</span>, try: <span class="string">"openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'"</span> <span class="keyword">to</span> generate <span class="keyword">new</span> one</span><br><span class="line"><span class="number">9</span> : fencing tools were <span class="keyword">not</span> <span class="keyword">found</span>, <span class="keyword">and</span> <span class="keyword">are</span> <span class="keyword">required</span> <span class="keyword">to</span> <span class="keyword">use</span> the (optional) <span class="keyword">power</span> <span class="keyword">management</span> features. <span class="keyword">install</span> cman <span class="keyword">or</span> fence-agents <span class="keyword">to</span> <span class="keyword">use</span> them</span><br><span class="line"></span><br><span class="line">Restart cobblerd <span class="keyword">and</span> <span class="keyword">then</span> run <span class="string">'cobbler sync'</span> <span class="keyword">to</span> <span class="keyword">apply</span> changes.</span><br></pre></td></tr></table></figure><blockquote><p>看到上面出现的问题，然后一个一个的进行解决，先进行设置为可以动态配置，也可以直接更改配置文件。</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 设置可以动态修改配置文件</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># sed -ri <span class="string">'/allow_dynamic_settings:/c\allow_dynamic_settings: 1'</span> /etc/cobbler/settings</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># grep allow_dynamic_settings /etc/cobbler/settings </span></span><br><span class="line">allow_dynamic_settings: <span class="number">1</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl restart cobblerd</span></span><br></pre></td></tr></table></figure><p>逐个解决上面的问题<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> server</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler setting edit --name=server --value=192.168.2.128</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> next_server</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler setting edit --name=next_server --value=192.168.2.128</span></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> tftp_server</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># sed -ri <span class="string">'/disable/c\disable = no'</span> /etc/xinetd.d/tftp</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl enable xinetd</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl restart xinetd</span></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> boot-loaders</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler get-loaders</span></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> rsyncd</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl start rsyncd</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl enable rsyncd</span></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span> debmirror [optional]</span><br><span class="line"><span class="meta"># 这个是可选项的，可以忽略。这里就忽略了</span></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span> pykickstart</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># yum -y install pykickstart</span></span><br><span class="line"></span><br><span class="line"><span class="number">8.</span> default_password_crypted  <span class="meta">#注意：这里设置的密码，也就是后面安装完系统的初始化登录密码</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># openssl passwd -1 -salt `openssl rand -hex 4` <span class="string">'admin'</span></span></span><br><span class="line">$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler setting edit --name=default_password_crypted --value=<span class="string">'$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0'</span></span></span><br><span class="line"></span><br><span class="line"><span class="number">9.</span> fencing tools [optional]</span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># yum -y install fence-agents</span></span><br></pre></td></tr></table></figure></p><p>解决完成再次查看<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="comment"># cobbler check</span></span><br><span class="line">The following are potential configuration items <span class="literal">that</span> you may want <span class="keyword">to</span> fix:</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> : debmirror package <span class="keyword">is</span> <span class="keyword">not</span> installed, <span class="literal">it</span> will be required <span class="keyword">to</span> manage debian deployments <span class="keyword">and</span> repositories</span><br><span class="line"></span><br><span class="line">Restart cobblerd <span class="keyword">and</span> <span class="keyword">then</span> run <span class="string">'cobbler sync'</span> <span class="keyword">to</span> apply changes.</span><br></pre></td></tr></table></figure></p><h3 id="配置DHCP"><a href="#配置DHCP" class="headerlink" title="配置DHCP"></a>配置DHCP</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler setting edit --name=manage_dhcp --value=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"># 修改cobbler的dhcp模块，不要直接修改dhcp本身的配置文件，因为cobbler会覆盖</span><br><span class="line">[root@cobbler ~]# vim /etc/cobbler/dhcp.template</span><br><span class="line">...</span><br><span class="line">subnet <span class="number">192.168</span><span class="number">.2</span><span class="number">.0</span> netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> &#123; #这里改为分配的网段和掩码</span><br><span class="line">     #option routers             <span class="number">192.168</span><span class="number">.1</span><span class="number">.5</span>; #如果有网关，这里改为网关地址</span><br><span class="line">     #option domain-name-servers <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>; #如果有DNS，这里改为DNS地址</span><br><span class="line">     option subnet-mask         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>; #改为分配的IP的掩码</span><br><span class="line">     range dynamic-bootp        <span class="number">192.168</span><span class="number">.2</span><span class="number">.100</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.254</span>; #改为分配的IP的范围</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="同步cobbler配置"><a href="#同步cobbler配置" class="headerlink" title="同步cobbler配置"></a>同步cobbler配置</h3><blockquote><p>同步cobbler配置，它会根据配置自动修改dhcp等服务。</p></blockquote><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="comment"># cobbler rsync </span></span><br><span class="line">No such <span class="symbol">command:</span> rsync</span><br><span class="line">[root@cobbler ~]<span class="comment"># cobbler sync</span></span><br><span class="line">task <span class="symbol">started:</span> <span class="number">2019</span>-<span class="number">0</span>6-<span class="number">12_15262</span>3_sync</span><br><span class="line">task started (id=Sync, time=Wed Jun <span class="number">12</span> <span class="number">15</span>:<span class="number">26</span>:<span class="number">23</span> <span class="number">2019</span>)</span><br><span class="line">running pre-sync triggers</span><br><span class="line">cleaning trees</span><br><span class="line"><span class="symbol">removing:</span> /var/www/cobbler/images/centos6.<span class="number">9</span>-x86_64</span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">pxelinux</span>.<span class="title">cfg</span>/<span class="title">default</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">images</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">grub</span>-<span class="title">x86</span>.<span class="title">efi</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">grub</span>-<span class="title">x86_64</span>.<span class="title">efi</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">efidefault</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">images</span>/<span class="title">centos6</span>.9-<span class="title">x86_64</span></span></span><br><span class="line"><span class="symbol">removing:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/<span class="title">s390x</span>/<span class="title">profile_list</span></span></span><br><span class="line">copying bootloaders</span><br><span class="line">trying hardlink /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">loaders</span>/<span class="title">grub</span>-<span class="title">x86</span>.<span class="title">efi</span> -&gt; /<span class="title">var</span>/<span class="title">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">grub</span>-<span class="title">x86</span>.<span class="title">efi</span></span></span><br><span class="line">trying hardlink /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">loaders</span>/<span class="title">grub</span>-<span class="title">x86_64</span>.<span class="title">efi</span> -&gt; /<span class="title">var</span>/<span class="title">lib</span>/<span class="title">tftpboot</span>/<span class="title">grub</span>/<span class="title">grub</span>-<span class="title">x86_64</span>.<span class="title">efi</span></span></span><br><span class="line">copying distros to tftpboot</span><br><span class="line">copying files <span class="keyword">for</span> <span class="symbol">distro:</span> centos6.<span class="number">9</span>-x86_64</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/vmlinuz -&gt; <span class="regexp">/var/lib</span><span class="regexp">/tftpboot/images</span><span class="regexp">/centos6.9-x86_64/vmlinuz</span></span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/initrd.img -&gt; <span class="regexp">/var/lib</span><span class="regexp">/tftpboot/images</span><span class="regexp">/centos6.9-x86_64/initrd</span>.img</span><br><span class="line">copying images</span><br><span class="line">generating PXE configuration files</span><br><span class="line">generating PXE menu structure</span><br><span class="line">copying files <span class="keyword">for</span> <span class="symbol">distro:</span> centos6.<span class="number">9</span>-x86_64</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/vmlinuz -&gt; <span class="regexp">/var/www</span><span class="regexp">/cobbler/images</span><span class="regexp">/centos6.9-x86_64/vmlinuz</span></span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/initrd.img -&gt; <span class="regexp">/var/www</span><span class="regexp">/cobbler/images</span><span class="regexp">/centos6.9-x86_64/initrd</span>.img</span><br><span class="line">Writing template files <span class="keyword">for</span> centos6.<span class="number">9</span>-x86_64</span><br><span class="line">rendering DHCP files</span><br><span class="line">generating /etc/dhcp/dhcpd.conf</span><br><span class="line">rendering TFTPD files</span><br><span class="line">generating /etc/xinetd.d/tftp</span><br><span class="line">processing boot_files <span class="keyword">for</span> <span class="symbol">distro:</span> centos6.<span class="number">9</span>-x86_64</span><br><span class="line">cleaning link caches</span><br><span class="line">running post-sync triggers</span><br><span class="line">running python triggers from /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">triggers</span>/<span class="title">sync</span>/<span class="title">post</span>/*</span></span><br><span class="line">running python trigger cobbler.modules.sync_post_restart_services</span><br><span class="line"><span class="symbol">running:</span> dhcpd -t -q</span><br><span class="line">received on <span class="symbol">stdout:</span> </span><br><span class="line">received on <span class="symbol">stderr:</span> </span><br><span class="line"><span class="symbol">running:</span> service dhcpd restart</span><br><span class="line">received on <span class="symbol">stdout:</span> </span><br><span class="line">received on <span class="symbol">stderr:</span> Redirecting to /bin/systemctl restart dhcpd.service</span><br><span class="line"></span><br><span class="line">running shell triggers from /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">triggers</span>/<span class="title">sync</span>/<span class="title">post</span>/*</span></span><br><span class="line">running python triggers from /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">triggers</span>/<span class="title">change</span>/*</span></span><br><span class="line">running python trigger cobbler.modules.manage_genders</span><br><span class="line">running python trigger cobbler.modules.scm_track</span><br><span class="line">running shell triggers from /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cobbler</span>/<span class="title">triggers</span>/<span class="title">change</span>/*</span></span><br><span class="line">*** TASK COMPLETE ***</span><br></pre></td></tr></table></figure><p>这时候创建一个新虚拟机可以获取到如下信息，没有镜像选择，只能从本地启动<br><img src="/2019/06/12/Cobbler自动化部署/cobbler03.png" alt></p><h3 id="cobbler命令帮助"><a href="#cobbler命令帮助" class="headerlink" title="cobbler命令帮助"></a>cobbler命令帮助</h3><table><thead><tr><th>命令</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>cobbler check</td><td style="text-align:left">核对当前设置是否有问题</td></tr><tr><td>cobbler list</td><td style="text-align:left">列出所有的cobbler元素</td></tr><tr><td>cobbler report</td><td style="text-align:left">列出元素的详细信息</td></tr><tr><td>cobbler sync</td><td style="text-align:left">同步配置到数据目录，更改配置最好都执行一下</td></tr><tr><td>cobbler reposync</td><td style="text-align:left">同步yum仓库</td></tr><tr><td>cobbler distro</td><td style="text-align:left">查看导入的发行版系统信息</td></tr><tr><td>cobbler system</td><td style="text-align:left">查看添加的系统信息</td></tr><tr><td>cobbler profile</td><td style="text-align:left">查看配置信息</td></tr></tbody></table><h2 id="cobbler配置安装centos6-x"><a href="#cobbler配置安装centos6-x" class="headerlink" title="cobbler配置安装centos6.x"></a>cobbler配置安装centos6.x</h2><blockquote><p>由于我这里实在<code>centos7</code>系统上面配置的<code>cobbler</code>，所以上传了一个<code>centos6</code>的镜像并进行挂载。</p></blockquote><p>1）创建挂载点，并进行挂载<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># mkdir /centos6</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># mount -o loop CentOS-6.9-x86_64-bin-DVD1.iso /centos6</span></span><br></pre></td></tr></table></figure></p><p>2）查看挂载后的目录<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="meta"># ls /centos6/</span></span><br><span class="line">CentOS_BuildTag  images                    repodata                       RPM-GPG-<span class="keyword">KEY</span>-CentOS-Testing<span class="number">-6</span></span><br><span class="line">EFI              isolinux                  RPM-GPG-<span class="keyword">KEY</span>-CentOS<span class="number">-6</span>           TRANS.TBL</span><br><span class="line">EULA             Packages                  RPM-GPG-<span class="keyword">KEY</span>-CentOS-Debug<span class="number">-6</span></span><br><span class="line">GPL              RELEASE-NOTES-en-US.html  RPM-GPG-<span class="keyword">KEY</span>-CentOS-Security<span class="number">-6</span></span><br></pre></td></tr></table></figure></p><p>3）导入镜像<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler import <span class="attribute">--path</span>=/centos6 <span class="attribute">--name</span>=centos6.9 <span class="attribute">--arch</span>=x86_64</span><br><span class="line"><span class="comment"># --path 镜像路径</span></span><br><span class="line"><span class="comment"># --name 为安装源定义一个名字</span></span><br><span class="line"><span class="comment"># --arch 指定安装源是32位、64位、ia64, 目前支持的选项有: x86│x86_64│ia64</span></span><br><span class="line"><span class="comment"># 安装源的唯一标示就是根据name参数来定义，本例导入成功后，安装源的唯一标示就是：centos6.9，如果重复，系统会提示导入失败。</span></span><br></pre></td></tr></table></figure></p><p>4）查看导入后镜像信息<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler distro report <span class="comment">--name=centos6.9-x86_64</span></span><br><span class="line">Name                           : <span class="type">centos6.9</span>-x86_64</span><br><span class="line">Architecture                   : <span class="type">x86_64</span></span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Breed                          : <span class="type">redhat</span></span><br><span class="line">Comment                        : </span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Initrd                         : /<span class="type">var</span>/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/initrd.img</span><br><span class="line">Kernel                         : /<span class="type">var</span>/www/cobbler/ks_mirror/centos6.<span class="number">9</span>-x86_64/images/pxeboot/vmlinuz</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart Metadata             : &#123;'<span class="type">tree</span>': <span class="symbol">'http</span>://@@http_server@@/cblr/links/centos6.<span class="number">9</span>-x86_64'&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">OS Version                     : <span class="type">rhel6</span></span><br><span class="line">Owners                         : ['<span class="type">admin</span>']</span><br><span class="line">Red Hat Management Key         : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br></pre></td></tr></table></figure></p><p>5）查看<code>profile</code>信息<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler profile report <span class="comment">--name=centos6.9-x86_64</span></span><br><span class="line">Name                           : <span class="type">centos6.9</span>-x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        : </span><br><span class="line">DHCP Tag                       : <span class="type">default</span></span><br><span class="line">Distribution                   : <span class="type">centos6.9</span>-x86_64</span><br><span class="line">Enable gPXE?                   : 0</span><br><span class="line">Enable PXE Menu?               : 1</span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart                      : /<span class="type">var</span>/lib/cobbler/kickstarts/sample_end.ks</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">Management Parameters          : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Owners                         : ['<span class="type">admin</span>']</span><br><span class="line">Parent Profile                 : </span><br><span class="line">Internal proxy                 : </span><br><span class="line">Red Hat Management Key         : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Repos                          : []</span><br><span class="line">Server Override                : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line">Virt Auto Boot                 : 1</span><br><span class="line">Virt Bridge                    : <span class="type">xenbr0</span></span><br><span class="line">Virt CPUs                      : 1</span><br><span class="line">Virt Disk Driver <span class="keyword">Type</span>          <span class="type">: </span>raw</span><br><span class="line">Virt File Size(GB)             : 5</span><br><span class="line">Virt Path                      : </span><br><span class="line">Virt RAM (MB)                  : 512</span><br><span class="line">Virt <span class="keyword">Type</span>                      <span class="type">: </span>kvm</span><br></pre></td></tr></table></figure></p><p>6）<code>copy</code>一份<code>profile</code>文件(<code>ks</code>)，进行修改<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="comment"># cd /var/lib/cobbler/kickstarts/</span></span><br><span class="line">[root@cobbler kickstarts]<span class="comment"># ls</span></span><br><span class="line">default.ks    install_profiles  sample_autoyast.xml  sample_esxi4.ks  sample.ks</span><br><span class="line">esxi4-ks.cfg  legacy.ks         sample_end.ks        sample_esxi5.ks  sample_old.seed</span><br><span class="line">esxi5-ks.cfg  pxerescue.ks      sample_esx4.ks       sample_esxi6.ks  sample.seed</span><br><span class="line">[root@cobbler kickstarts]<span class="comment"># cp sample_end.ks centos6.ks</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑centos6的kickstart文件</span></span><br><span class="line">[root@cobbler kickstarts]<span class="comment"># vim centos6.ks </span></span><br><span class="line"><span class="comment"># This kickstart file should only be used with EL &gt; 5 and/or Fedora &gt; 7.</span></span><br><span class="line"><span class="comment"># For older versions please use the sample.ks kickstart file.</span></span><br><span class="line"><span class="comment"># Install OS instead of upgrade</span></span><br><span class="line">install</span><br><span class="line"><span class="comment"># Use text mode install</span></span><br><span class="line">text</span><br><span class="line"><span class="comment"># System keyboard</span></span><br><span class="line">keyboard us</span><br><span class="line"><span class="comment"># System language</span></span><br><span class="line">lang en_US</span><br><span class="line"><span class="comment"># System timezone</span></span><br><span class="line">timezone  Asia/ShangHai</span><br><span class="line"><span class="comment">#Root password</span></span><br><span class="line">rootpw --iscrypted $default_password_crypted</span><br><span class="line"><span class="comment"># System authorization information</span></span><br><span class="line">auth  --useshadow  --enablemd5</span><br><span class="line"><span class="comment"># Firewall configuration</span></span><br><span class="line">firewall --disabled</span><br><span class="line"><span class="comment"># SELinux configuration</span></span><br><span class="line">selinux --disabled</span><br><span class="line"><span class="comment"># Use network installation</span></span><br><span class="line">url --url=$tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clear the Master Boot Record</span></span><br><span class="line">zerombr</span><br><span class="line"><span class="comment"># System bootloader configuration</span></span><br><span class="line">bootloader --location=mbr</span><br><span class="line"><span class="comment"># Partition clearing information</span></span><br><span class="line">clearpart --all --initlabel</span><br><span class="line">part /boot --fstype=ext4 --size=<span class="number">500</span></span><br><span class="line">part swap --fstype=swap --size=<span class="number">2048</span></span><br><span class="line">part / --fstype=ext4 --grow --size=<span class="number">200</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># If any cobbler repo definitions were referenced in the kickstart profile, include them here.</span></span><br><span class="line">$yum_repo_stanza</span><br><span class="line"><span class="comment"># Network information</span></span><br><span class="line">$SNIPPET(<span class="string">'network_config'</span>)</span><br><span class="line"><span class="comment"># Do not configure the X Window System</span></span><br><span class="line">skipx</span><br><span class="line"><span class="comment"># Run the Setup Agent on first boot</span></span><br><span class="line">firstboot --disable</span><br><span class="line"><span class="comment"># Reboot after installation</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%pre</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_pre'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'kickstart_start'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'pre_install_network_config'</span>)</span><br><span class="line"><span class="comment"># Enable installation monitoring</span></span><br><span class="line">$SNIPPET(<span class="string">'pre_anamon'</span>)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">$SNIPPET(<span class="string">'func_install_if_enabled'</span>)</span><br><span class="line">@core</span><br><span class="line">@base</span><br><span class="line">tree</span><br><span class="line">nmap</span><br><span class="line">wget</span><br><span class="line">lftp</span><br><span class="line">lrzsz</span><br><span class="line">telnet</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post --nochroot</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_post_nochroot'</span>)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_post'</span>)</span><br><span class="line"><span class="comment"># Start yum configuration</span></span><br><span class="line">$yum_config_stanza</span><br><span class="line"><span class="comment"># End yum configuration</span></span><br><span class="line">$SNIPPET(<span class="string">'post_install_kernel_options'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'post_install_network_config'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'func_register_if_enabled'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'download_config_files'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'koan_environment'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'redhat_register'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'cobbler_register'</span>)</span><br><span class="line"><span class="comment"># Enable post-install boot notification</span></span><br><span class="line">$SNIPPET(<span class="string">'post_anamon'</span>)</span><br><span class="line"><span class="comment"># Start final steps</span></span><br><span class="line">$SNIPPET(<span class="string">'kickstart_done'</span>)</span><br><span class="line"><span class="comment"># End final steps</span></span><br><span class="line"></span><br><span class="line">sed -ri <span class="string">"/^#UseDNS/c\UseDNS no"</span> /etc/ssh/sshd_config</span><br><span class="line">sed -ri <span class="string">"/^GSSAPIAuthentication/c\GSSAPIAuthentication no"</span> /etc/ssh/sshd_config</span><br><span class="line">%end</span><br></pre></td></tr></table></figure></p><p>7）编辑<code>centos6</code>镜像所使用的<code>kickstart</code>文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 动态编辑指定使用新的kickstart文件</span></span><br><span class="line">[root@cobbler ~]# cobbler<span class="built_in"> profile </span><span class="builtin-name">edit</span> <span class="attribute">--name</span>=centos6.9-x86_64 <span class="attribute">--kickstart</span>=/var/lib/cobbler/kickstarts/centos6.ks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证是否更改成功</span></span><br><span class="line">[root@cobbler ~]# cobbler<span class="built_in"> profile </span>report <span class="attribute">--name</span>=centos6.9-x86_64 |grep Kickstart</span><br><span class="line">Kickstart                      : /var/lib/cobbler/kickstarts/centos6.ks</span><br></pre></td></tr></table></figure></p><p>8）再次同步<code>cobbler</code>配置<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler sync</span></span><br></pre></td></tr></table></figure></p><p>9）新建虚拟机进行测试<br><img src="/2019/06/12/Cobbler自动化部署/cobbler04.png" alt><br>选择<code>centos6.9</code>进行安装，会按照<code>kickstart</code>文件安装并启动<br><img src="/2019/06/12/Cobbler自动化部署/cobbler05.png" alt></p><h2 id="cobbler配置安装centos7-x"><a href="#cobbler配置安装centos7-x" class="headerlink" title="cobbler配置安装centos7.x"></a>cobbler配置安装centos7.x</h2><blockquote><p>我这里cobbler服务器就是7的系统，所以直接挂载/dev/cdrom即可</p></blockquote><p>1）创建挂载点，并进行挂载<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># mkdir /centos7</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># mount -o loop /dev/cdrom /centos7</span></span><br></pre></td></tr></table></figure></p><p>2）查看挂载后的目录<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="meta"># ls /centos7/</span></span><br><span class="line">CentOS_BuildTag  EULA  images    LiveOS    repodata              RPM-GPG-<span class="keyword">KEY</span>-CentOS-Testing<span class="number">-7</span></span><br><span class="line">EFI              GPL   isolinux  Packages  RPM-GPG-<span class="keyword">KEY</span>-CentOS<span class="number">-7</span>  TRANS.TBL</span><br></pre></td></tr></table></figure></p><p>3）导入镜像<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@cobbler</span> ~]<span class="comment"># cobbler import --path=/centos7 --name=centos7.4 --arch=x86_64</span></span><br><span class="line">task <span class="symbol">started:</span> <span class="number">2019</span>-<span class="number">06</span>-<span class="number">12_165812_</span><span class="keyword">import</span></span><br><span class="line">task started (id=Media <span class="keyword">import</span>, time=Wed Jun <span class="number">12</span> <span class="number">16</span><span class="symbol">:</span><span class="number">58</span><span class="symbol">:</span><span class="number">12</span> <span class="number">2019</span>)</span><br><span class="line">Found a candidate <span class="symbol">signature:</span> breed=redhat, version=rhel6</span><br><span class="line">Found a candidate <span class="symbol">signature:</span> breed=redhat, version=rhel7</span><br><span class="line">Found a matching <span class="symbol">signature:</span> breed=redhat, version=rhel7</span><br><span class="line">Adding distros from path /var/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-<span class="symbol">x86_64:</span></span><br><span class="line">creating new <span class="symbol">distro:</span> centos7.<span class="number">4</span>-x86_64</span><br><span class="line">trying <span class="symbol">symlink:</span> /var/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64 -&gt; /var/www/cobbler/links/centos7.<span class="number">4</span>-x86_64</span><br><span class="line">creating new <span class="symbol">profile:</span> centos7.<span class="number">4</span>-x86_64</span><br><span class="line">associating repos</span><br><span class="line">checking <span class="keyword">for</span> rsync repo(s)</span><br><span class="line">checking <span class="keyword">for</span> rhn repo(s)</span><br><span class="line">checking <span class="keyword">for</span> yum repo(s)</span><br><span class="line">starting descent into /var/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64 <span class="keyword">for</span> centos7.<span class="number">4</span>-x86_64</span><br><span class="line">processing repo at : <span class="regexp">/var/www</span><span class="regexp">/cobbler/ks</span>_mirror/centos7.<span class="number">4</span>-x86_64</span><br><span class="line">need to process repo/<span class="symbol">comps:</span> /var/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64</span><br><span class="line">looking <span class="keyword">for</span> /var/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64/repodata/*comps*.xml</span><br><span class="line">Keeping repodata as-is <span class="symbol">:/var/www/cobbler/ks_mirror/centos7</span>.<span class="number">4</span>-x86_64/repodata</span><br><span class="line">*** TASK COMPLETE ***</span><br></pre></td></tr></table></figure></p><p>4）查看导入后镜像信息<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler distro report <span class="comment">--name=centos7.4-x86_64</span></span><br><span class="line">Name                           : <span class="type">centos7.4</span>-x86_64</span><br><span class="line">Architecture                   : <span class="type">x86_64</span></span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Breed                          : <span class="type">redhat</span></span><br><span class="line">Comment                        : </span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Initrd                         : /<span class="type">var</span>/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64/images/pxeboot/initrd.img</span><br><span class="line">Kernel                         : /<span class="type">var</span>/www/cobbler/ks_mirror/centos7.<span class="number">4</span>-x86_64/images/pxeboot/vmlinuz</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart Metadata             : &#123;'<span class="type">tree</span>': <span class="symbol">'http</span>://@@http_server@@/cblr/links/centos7.<span class="number">4</span>-x86_64'&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">OS Version                     : <span class="type">rhel7</span></span><br><span class="line">Owners                         : ['<span class="type">admin</span>']</span><br><span class="line">Red Hat Management Key         : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br></pre></td></tr></table></figure></p><p>5）查看<code>profile</code>信息<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]# cobbler profile report <span class="comment">--name=centos7.4-x86_64</span></span><br><span class="line">Name                           : <span class="type">centos7.4</span>-x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        : </span><br><span class="line">DHCP Tag                       : <span class="type">default</span></span><br><span class="line">Distribution                   : <span class="type">centos7.4</span>-x86_64</span><br><span class="line">Enable gPXE?                   : 0</span><br><span class="line">Enable PXE Menu?               : 1</span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart                      : /<span class="type">var</span>/lib/cobbler/kickstarts/sample_end.ks</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">Management Parameters          : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Owners                         : ['<span class="type">admin</span>']</span><br><span class="line">Parent Profile                 : </span><br><span class="line">Internal proxy                 : </span><br><span class="line">Red Hat Management Key         : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Repos                          : []</span><br><span class="line">Server Override                : &lt;&lt;<span class="type">inherit</span>&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line">Virt Auto Boot                 : 1</span><br><span class="line">Virt Bridge                    : <span class="type">xenbr0</span></span><br><span class="line">Virt CPUs                      : 1</span><br><span class="line">Virt Disk Driver <span class="keyword">Type</span>          <span class="type">: </span>raw</span><br><span class="line">Virt File Size(GB)             : 5</span><br><span class="line">Virt Path                      : </span><br><span class="line">Virt RAM (MB)                  : 512</span><br><span class="line">Virt <span class="keyword">Type</span>                      <span class="type">: </span>kvm</span><br></pre></td></tr></table></figure></p><p>7）<code>copy</code>一份<code>profile</code>文件( <code>ks</code> )，进行修改,这里直接copy上面6的了，然后修改修改即可<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">[root@cobbler ~]<span class="comment"># cd /var/lib/cobbler/kickstarts/</span></span><br><span class="line">[root@cobbler kickstarts]<span class="comment"># cp centos6.ks centos7.ks</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑centos7的kickstart文件</span></span><br><span class="line">[root@cobbler kickstarts]<span class="comment"># vim centos7.ks</span></span><br><span class="line"><span class="comment"># This kickstart file should only be used with EL &gt; 5 and/or Fedora &gt; 7.</span></span><br><span class="line"><span class="comment"># For older versions please use the sample.ks kickstart file.</span></span><br><span class="line"><span class="comment"># Install OS instead of upgrade</span></span><br><span class="line">install</span><br><span class="line"><span class="comment"># Use text mode install</span></span><br><span class="line">text</span><br><span class="line"><span class="comment"># System keyboard</span></span><br><span class="line">keyboard us</span><br><span class="line"><span class="comment"># System language</span></span><br><span class="line">lang en_US</span><br><span class="line"><span class="comment"># System timezone</span></span><br><span class="line">timezone  Asia/ShangHai</span><br><span class="line"><span class="comment">#Root password</span></span><br><span class="line">rootpw --iscrypted $default_password_crypted</span><br><span class="line"><span class="comment"># System authorization information</span></span><br><span class="line">auth  --useshadow  --enablemd5</span><br><span class="line"><span class="comment"># Firewall configuration</span></span><br><span class="line">firewall --disabled</span><br><span class="line"><span class="comment"># SELinux configuration</span></span><br><span class="line">selinux --disabled</span><br><span class="line"><span class="comment"># Use network installation</span></span><br><span class="line">url --url=$tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clear the Master Boot Record</span></span><br><span class="line">zerombr</span><br><span class="line"><span class="comment"># System bootloader configuration</span></span><br><span class="line">bootloader --location=mbr</span><br><span class="line"><span class="comment"># Partition clearing information</span></span><br><span class="line">clearpart --all --initlabel</span><br><span class="line">part /boot --fstype=xfs --size=<span class="number">500</span></span><br><span class="line">part swap --fstype=swap --size=<span class="number">2048</span></span><br><span class="line">part / --fstype=xfs --grow --size=<span class="number">200</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># If any cobbler repo definitions were referenced in the kickstart profile, include them here.</span></span><br><span class="line">$yum_repo_stanza</span><br><span class="line"><span class="comment"># Network information</span></span><br><span class="line">$SNIPPET(<span class="string">'network_config'</span>)</span><br><span class="line"><span class="comment"># Do not configure the X Window System</span></span><br><span class="line">skipx</span><br><span class="line"><span class="comment"># Run the Setup Agent on first boot</span></span><br><span class="line">firstboot --disable</span><br><span class="line"><span class="comment"># Reboot after installation</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%pre</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_pre'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'kickstart_start'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'pre_install_network_config'</span>)</span><br><span class="line"><span class="comment"># Enable installation monitoring</span></span><br><span class="line">$SNIPPET(<span class="string">'pre_anamon'</span>)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">$SNIPPET(<span class="string">'func_install_if_enabled'</span>)</span><br><span class="line">@core</span><br><span class="line">@base</span><br><span class="line">tree</span><br><span class="line">nmap</span><br><span class="line">wget</span><br><span class="line">lftp</span><br><span class="line">lrzsz</span><br><span class="line">telnet</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post --nochroot</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_post_nochroot'</span>)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post</span><br><span class="line">$SNIPPET(<span class="string">'log_ks_post'</span>)</span><br><span class="line"><span class="comment"># Start yum configuration</span></span><br><span class="line">$yum_config_stanza</span><br><span class="line"><span class="comment"># End yum configuration</span></span><br><span class="line">$SNIPPET(<span class="string">'post_install_kernel_options'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'post_install_network_config'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'func_register_if_enabled'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'download_config_files'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'koan_environment'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'redhat_register'</span>)</span><br><span class="line">$SNIPPET(<span class="string">'cobbler_register'</span>)</span><br><span class="line"><span class="comment"># Enable post-install boot notification</span></span><br><span class="line">$SNIPPET(<span class="string">'post_anamon'</span>)</span><br><span class="line"><span class="comment"># Start final steps</span></span><br><span class="line">$SNIPPET(<span class="string">'kickstart_done'</span>)</span><br><span class="line"><span class="comment"># End final steps</span></span><br><span class="line"></span><br><span class="line">sed -ri <span class="string">"/^#UseDNS/c\UseDNS no"</span> /etc/ssh/sshd_config</span><br><span class="line">sed -ri <span class="string">"/^GSSAPIAuthentication/c\GSSAPIAuthentication no"</span> /etc/ssh/sshd_config</span><br><span class="line">%end</span><br></pre></td></tr></table></figure></p><p>7）编辑<code>centos7</code>镜像所使用的<code>kickstart</code>文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 动态编辑指定使用新的kickstart文件</span></span><br><span class="line">[root@cobbler ~]# cobbler<span class="built_in"> profile </span><span class="builtin-name">edit</span> <span class="attribute">--name</span>=centos7.4-x86_64 <span class="attribute">--kickstart</span>=/var/lib/cobbler/kickstarts/centos7.ks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证是否更改成功</span></span><br><span class="line">[root@cobbler ~]# cobbler<span class="built_in"> profile </span>report <span class="attribute">--name</span>=centos7.4-x86_64 |grep Kickstart</span><br><span class="line">Kickstart                      : /var/lib/cobbler/kickstarts/centos7.ks</span><br></pre></td></tr></table></figure></p><p>8）再次同步<code>cobbler</code>配置<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler sync</span></span><br></pre></td></tr></table></figure></p><p>9）新建虚拟机进行测试<br><img src="/2019/06/12/Cobbler自动化部署/cobbler06.png" alt><br>选择<code>centos7.4</code>进行安装即可<br><img src="/2019/06/12/Cobbler自动化部署/cobbler07.png" alt></p><blockquote><p>说明：在<code>client</code>端系统安装时，可以在<code>cobbler</code>服务端上查看日志<code>/var/log/messages</code>，观察安装的每一个<code>cobbler</code>流程</p></blockquote><h2 id="cobbler-Web管理界面配置"><a href="#cobbler-Web管理界面配置" class="headerlink" title="cobbler Web管理界面配置"></a>cobbler Web管理界面配置</h2><blockquote><p><code>web</code>界面有很多功能，包括上传镜像、编辑<code>kickstart</code>、等等很多在命令行操作的都可以在<code>web</code>界面直接操作。<br>在上面已经安装了<code>cobbler-web</code>软件，访问地址：<a href="https://IP/cobbler_web" target="_blank" rel="noopener">https://IP/cobbler_web</a> 即可。默认账号为<code>cobbler</code>，密码也为<code>cobbler</code></p></blockquote><p><img src="/2019/06/12/Cobbler自动化部署/cobbler08.png" alt></p><p><strong>修改密码</strong><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/etc/cobbler/users.conf     <span class="meta">#Web服务授权配置文件</span></span><br><span class="line">/etc/cobbler/users.digest   <span class="meta">#用于web访问的用户名密码</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cat /etc/cobbler/users.digest </span></span><br><span class="line">cobbler:Cobbler:a2d6bae81669d707b72c0bd9806e01f3</span><br><span class="line"></span><br><span class="line"><span class="meta"># 设置密码，在Cobbler组添加cobbler用户，输入2遍密码确</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># htdigest /etc/cobbler/users.digest <span class="string">"Cobbler"</span> cobbler</span></span><br><span class="line">Changing password <span class="keyword">for</span> user cobbler <span class="keyword">in</span> realm Cobbler</span><br><span class="line">New password: superman</span><br><span class="line">Re-type new password: superman</span><br><span class="line"></span><br><span class="line"><span class="meta"># 同步配置并重启httpd、cobbler</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># cobbler sync</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl restart httpd</span></span><br><span class="line">[root<span class="symbol">@cobbler</span> ~]<span class="meta"># systemctl restart cobblerd</span></span><br></pre></td></tr></table></figure></p><p>再次登录即使用新设置的密码登录即可。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;cobbler简介&quot;&gt;&lt;a href=&quot;#cobbler简介&quot; class=&quot;headerlink&quot; title=&quot;cobbler简介&quot;&gt;&lt;/a&gt;cobbler简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;Cobbler&lt;/code&gt; 可以用来快速建立
      
    
    </summary>
    
      <category term="Cobbler" scheme="https://leeyj.coding.me/categories/Cobbler/"/>
    
    
      <category term="Cobbler" scheme="https://leeyj.coding.me/tags/Cobbler/"/>
    
  </entry>
  
  <entry>
    <title>Ansible项目实战lnmp</title>
    <link href="https://leeyj.coding.me/2019/06/05/Ansible%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98lnmp/"/>
    <id>https://leeyj.coding.me/2019/06/05/Ansible项目实战lnmp/</id>
    <published>2019-06-05T04:10:22.000Z</published>
    <updated>2019-07-10T01:46:29.906Z</updated>
    
    <content type="html"><![CDATA[<h2 id="项目规划"><a href="#项目规划" class="headerlink" title="项目规划"></a>项目规划</h2><blockquote><p>通过<code>ansible roles</code>配置<code>lnmp</code>环境，<code>nginx</code>通过源码编译安装，<code>php</code>通过源码编译安装，<code>mysql</code>通过<code>yum</code>安装（<code>mysql</code>源码编译超级慢）支持系统（<code>centos6.x</code>和<code>centos7.x</code>系列）</p></blockquote><blockquote><p><strong>说明:</strong>将nginx和php源码包放到对应的角色文件下的files目录下，通过vars/main.yml控制安装的版本和路径。如下：</p></blockquote><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible roles]<span class="meta"># cat nginx/vars/main.yml </span></span><br><span class="line"><span class="symbol">DOWNLOAD_DIR:</span> <span class="string">"/usr/local/src/"</span>  <span class="meta">#软件包拷贝到目标主机的存放路径</span></span><br><span class="line"><span class="symbol">INSTALL_DIR:</span> <span class="string">"/usr/local/"</span>       <span class="meta">#安装路径</span></span><br><span class="line"><span class="symbol">NGINX_VERSION:</span> <span class="string">"1.12.2"</span>          <span class="meta">#软件包版本</span></span><br><span class="line"><span class="symbol">USER:</span> <span class="string">"nginx"</span>                    <span class="meta">#运行的用户</span></span><br><span class="line"><span class="symbol">GROUP:</span> <span class="string">"nginx"</span>                   <span class="meta">#运行的组</span></span><br></pre></td></tr></table></figure><p><a href="https://buji595.github.io/2019/05/26/Ansible%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" target="_blank" rel="noopener">环境配置参考</a></p><h2 id="角色编写"><a href="#角色编写" class="headerlink" title="角色编写"></a>角色编写</h2><blockquote><p>这里角色都统一放在了<code>/etc/ansible/roles</code>下</p></blockquote><p>安装编译时所需要用到的依赖包<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible roles]# cat init_pkg.yml </span><br><span class="line">#安装源码编译php、nginx时所需要用到的依赖包</span><br><span class="line">-<span class="ruby">--</span></span><br><span class="line"><span class="ruby">- <span class="symbol">hosts:</span> all </span></span><br><span class="line"><span class="ruby">  <span class="symbol">remote_user:</span> root</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">  <span class="symbol">tasks:</span></span></span><br><span class="line"><span class="ruby">    - <span class="symbol">name:</span> Install Package</span></span><br><span class="line"><span class="ruby">      <span class="symbol">yum:</span> name=&#123;&#123; item &#125;&#125; state=installed</span></span><br><span class="line"><span class="ruby">      <span class="symbol">with_items:</span></span></span><br><span class="line"><span class="ruby">        - gcc-c++</span></span><br><span class="line"><span class="ruby">        - glibc</span></span><br><span class="line"><span class="ruby">        - glibc-devel</span></span><br><span class="line"><span class="ruby">        - glib2</span></span><br><span class="line"><span class="ruby">        - glib2-devel</span></span><br><span class="line"><span class="ruby">        - pcre</span></span><br><span class="line"><span class="ruby">        - pcre-devel</span></span><br><span class="line"><span class="ruby">        - zlib</span></span><br><span class="line"><span class="ruby">        - zlib-devel</span></span><br><span class="line"><span class="ruby">        - openssl</span></span><br><span class="line"><span class="ruby">        - openssl-devel</span></span><br><span class="line"><span class="ruby">        - libpng</span></span><br><span class="line"><span class="ruby">        - libpng-devel</span></span><br><span class="line"><span class="ruby">        - freetype</span></span><br><span class="line"><span class="ruby">        - freetype-devel</span></span><br><span class="line"><span class="ruby">        - libxml2</span></span><br><span class="line"><span class="ruby">        - libxml2-devel</span></span><br><span class="line"><span class="ruby">        - bzip2</span></span><br><span class="line"><span class="ruby">        - bzip2-devel</span></span><br><span class="line"><span class="ruby">        - ncurses</span></span><br><span class="line"><span class="ruby">        - curl</span></span><br><span class="line"><span class="ruby">        - gdbm-devel</span></span><br><span class="line"><span class="ruby">        - libXpm-devel</span></span><br><span class="line"><span class="ruby">        - libX11-devel</span></span><br><span class="line"><span class="ruby">        - gd-devel</span></span><br><span class="line"><span class="ruby">        - gmp-devel</span></span><br><span class="line"><span class="ruby">        - readline-devel</span></span><br><span class="line"><span class="ruby">        - libxslt-devel</span></span><br><span class="line"><span class="ruby">        - expat-devel</span></span><br><span class="line"><span class="ruby">        - xmlrpc-c</span></span><br><span class="line"><span class="ruby">        - libcurl-devel</span></span><br></pre></td></tr></table></figure></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># cd /etc/ansible/roles/</span></span><br></pre></td></tr></table></figure><h3 id="nginx-roles"><a href="#nginx-roles" class="headerlink" title="nginx roles"></a>nginx roles</h3><p>1）创建相应文件夹<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># mkdir -p nginx/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p><p>2）最终编写效果<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">tree</span> <span class="selector-tag">nginx</span></span><br><span class="line"><span class="selector-tag">nginx</span></span><br><span class="line">├── <span class="selector-tag">files</span></span><br><span class="line">│   ├── <span class="selector-tag">nginx-1</span><span class="selector-class">.12</span><span class="selector-class">.2</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">│   └── <span class="selector-tag">nginx-1</span><span class="selector-class">.16</span><span class="selector-class">.0</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">├── <span class="selector-tag">handlers</span></span><br><span class="line">│   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">tasks</span></span><br><span class="line">│   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">copypkg</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">group</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">│   └── <span class="selector-tag">user</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">templates</span></span><br><span class="line">│   ├── <span class="selector-tag">nginx</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">│   ├── <span class="selector-tag">nginx_init</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">nginx</span><span class="selector-class">.service</span><span class="selector-class">.j2</span></span><br><span class="line">└── <span class="selector-tag">vars</span></span><br><span class="line">    └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line"></span><br><span class="line">5 <span class="selector-tag">directories</span>, 14 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure></p><h3 id="php-roles"><a href="#php-roles" class="headerlink" title="php roles"></a>php roles</h3><p>1）创建相应文件夹<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># mkdir -p php/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p><p>2）最终编写效果<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">tree</span> <span class="selector-tag">php</span></span><br><span class="line"><span class="selector-tag">php</span></span><br><span class="line">├── <span class="selector-tag">files</span></span><br><span class="line">│   └── <span class="selector-tag">php-5</span><span class="selector-class">.6</span><span class="selector-class">.40</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">├── <span class="selector-tag">handlers</span></span><br><span class="line">│   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">tasks</span></span><br><span class="line">│   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">copypkg</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">group</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">│   └── <span class="selector-tag">user</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">templates</span></span><br><span class="line">│   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">│   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.init</span><span class="selector-class">.j2</span></span><br><span class="line">│   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.service</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">php</span><span class="selector-class">.ini</span><span class="selector-class">.j2</span></span><br><span class="line">└── <span class="selector-tag">vars</span></span><br><span class="line">    └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line"></span><br><span class="line">5 <span class="selector-tag">directories</span>, 14 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure></p><h3 id="mysql-roles"><a href="#mysql-roles" class="headerlink" title="mysql roles"></a>mysql roles</h3><p>1）创建相应文件夹<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># mkdir -p mysql/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p><p>2）最终编写效果<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">tree</span> <span class="selector-tag">mysql</span></span><br><span class="line"><span class="selector-tag">mysql</span></span><br><span class="line">├── <span class="selector-tag">files</span></span><br><span class="line">├── <span class="selector-tag">handlers</span></span><br><span class="line">│   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">tasks</span></span><br><span class="line">│   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   └── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">templates</span></span><br><span class="line">│   ├── <span class="selector-tag">my</span><span class="selector-class">.cnf6</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">my</span><span class="selector-class">.cnf7</span><span class="selector-class">.j2</span></span><br><span class="line">└── <span class="selector-tag">vars</span></span><br><span class="line"></span><br><span class="line">5 <span class="selector-tag">directories</span>, 7 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure></p><h3 id="角色执行playbook文件编写"><a href="#角色执行playbook文件编写" class="headerlink" title="角色执行playbook文件编写"></a>角色执行playbook文件编写</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">cat</span> <span class="string">nginx_roles.yml</span> </span><br><span class="line"><span class="comment">#源码编译安装nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">cat</span> <span class="string">php_roles.yml</span> </span><br><span class="line"><span class="comment">#源码编译安装nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">cat</span> <span class="string">mysql_roles.yml</span> </span><br><span class="line"><span class="comment">#yum安装MySQL</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">mysql</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">cat</span> <span class="string">lnmp.yml</span> </span><br><span class="line"><span class="comment">#配置lnmp,创建虚拟主机</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">php</span> </span><br><span class="line"><span class="attr">    - role:</span> <span class="string">mysql</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    PORT:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">    WEBDIR:</span> <span class="string">"/opt/www"</span></span><br><span class="line"><span class="attr">    CONFIGDIR:</span> <span class="string">"/usr/local/nginx/conf/conf.d"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">vhost</span> <span class="string">dir</span></span><br><span class="line"><span class="attr">      file:</span> <span class="string">name=&#123;&#123;</span> <span class="string">WEBDIR</span> <span class="string">&#125;&#125;</span> <span class="string">state=directory</span> <span class="string">owner=www</span> <span class="string">group=www</span> <span class="string">mode=755</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">vhost</span> <span class="string">conf</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=vhost.conf.j2</span> <span class="string">dest=&#123;&#123;</span> <span class="string">CONFIGDIR</span> <span class="string">&#125;&#125;/vhost.conf</span></span><br><span class="line"><span class="attr">      notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">index.php</span></span><br><span class="line"><span class="attr">      shell:</span> <span class="string">"echo '&lt;?php phpinfo(); ?&gt;' &gt; <span class="template-variable">&#123;&#123; WEBDIR &#125;&#125;</span>/index.php"</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># hostslist文件准备，这样方便执行，可以在执行playbook时指定某台机器上运行</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">cat</span> <span class="string">hostlist</span> </span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.36</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#所有文件查看</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">ll</span> </span><br><span class="line"><span class="string">总用量</span> <span class="number">28</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">53</span> <span class="number">6</span><span class="string">月</span>   <span class="number">4</span> <span class="number">22</span><span class="string">:37</span> <span class="string">hostlist</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">824</span> <span class="number">6</span><span class="string">月</span>   <span class="number">5</span> <span class="number">10</span><span class="string">:53</span> <span class="string">init_pkg.yml</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">646</span> <span class="number">6</span><span class="string">月</span>   <span class="number">5</span> <span class="number">12</span><span class="string">:05</span> <span class="string">lnmp.yml</span></span><br><span class="line"><span class="string">drwxr-xr-x.</span> <span class="number">7</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">77</span> <span class="number">6</span><span class="string">月</span>   <span class="number">5</span> <span class="number">10</span><span class="string">:44</span> <span class="string">mysql</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">81</span> <span class="number">6</span><span class="string">月</span>   <span class="number">5</span> <span class="number">10</span><span class="string">:06</span> <span class="string">mysql_roles.yml</span></span><br><span class="line"><span class="string">drwxr-xr-x.</span> <span class="number">7</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">77</span> <span class="number">6</span><span class="string">月</span>   <span class="number">4</span> <span class="number">15</span><span class="string">:37</span> <span class="string">nginx</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">89</span> <span class="number">6</span><span class="string">月</span>   <span class="number">4</span> <span class="number">17</span><span class="string">:10</span> <span class="string">nginx_roles.yml</span></span><br><span class="line"><span class="string">drwxr-xr-x.</span> <span class="number">7</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">77</span> <span class="number">6</span><span class="string">月</span>   <span class="number">4</span> <span class="number">17</span><span class="string">:18</span> <span class="string">php</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">87</span> <span class="number">6</span><span class="string">月</span>   <span class="number">4</span> <span class="number">17</span><span class="string">:37</span> <span class="string">php_roles.yml</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--.</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">811</span> <span class="number">6</span><span class="string">月</span>   <span class="number">5</span> <span class="number">11</span><span class="string">:53</span> <span class="string">vhost.conf.j2</span></span><br></pre></td></tr></table></figure><h2 id="所有文件查看"><a href="#所有文件查看" class="headerlink" title="所有文件查看"></a>所有文件查看</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">tree</span> </span><br><span class="line">.</span><br><span class="line">├── <span class="selector-tag">hostlist</span></span><br><span class="line">├── <span class="selector-tag">init_pkg</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">lnmp</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">mysql</span></span><br><span class="line">│   ├── <span class="selector-tag">files</span></span><br><span class="line">│   ├── <span class="selector-tag">handlers</span></span><br><span class="line">│   │   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">tasks</span></span><br><span class="line">│   │   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   └── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">templates</span></span><br><span class="line">│   │   ├── <span class="selector-tag">my</span><span class="selector-class">.cnf6</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   └── <span class="selector-tag">my</span><span class="selector-class">.cnf7</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">vars</span></span><br><span class="line">├── <span class="selector-tag">mysql_roles</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">nginx</span></span><br><span class="line">│   ├── <span class="selector-tag">files</span></span><br><span class="line">│   │   ├── <span class="selector-tag">nginx-1</span><span class="selector-class">.12</span><span class="selector-class">.2</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">│   │   └── <span class="selector-tag">nginx-1</span><span class="selector-class">.16</span><span class="selector-class">.0</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">│   ├── <span class="selector-tag">handlers</span></span><br><span class="line">│   │   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">tasks</span></span><br><span class="line">│   │   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">copypkg</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">group</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   └── <span class="selector-tag">user</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">templates</span></span><br><span class="line">│   │   ├── <span class="selector-tag">nginx</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   ├── <span class="selector-tag">nginx_init</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   └── <span class="selector-tag">nginx</span><span class="selector-class">.service</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">vars</span></span><br><span class="line">│       └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">nginx_roles</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">php</span></span><br><span class="line">│   ├── <span class="selector-tag">files</span></span><br><span class="line">│   │   └── <span class="selector-tag">php-5</span><span class="selector-class">.6</span><span class="selector-class">.40</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">│   ├── <span class="selector-tag">handlers</span></span><br><span class="line">│   │   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">tasks</span></span><br><span class="line">│   │   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">copypkg</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">group</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">service</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   └── <span class="selector-tag">user</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">templates</span></span><br><span class="line">│   │   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.init</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   ├── <span class="selector-tag">php-fpm</span><span class="selector-class">.service</span><span class="selector-class">.j2</span></span><br><span class="line">│   │   └── <span class="selector-tag">php</span><span class="selector-class">.ini</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">vars</span></span><br><span class="line">│       └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">├── <span class="selector-tag">php_roles</span><span class="selector-class">.yml</span></span><br><span class="line">└── <span class="selector-tag">vhost</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line"></span><br><span class="line">18 <span class="selector-tag">directories</span>, 42 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure><h2 id="执行说明"><a href="#执行说明" class="headerlink" title="执行说明"></a>执行说明</h2><p>1）单独某一台机器安装nginx<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">ansible-playbook</span> <span class="selector-tag">-i</span> <span class="selector-tag">hostlist</span> <span class="selector-tag">nginx_roles</span><span class="selector-class">.yml</span> <span class="selector-tag">--limit</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.31</span></span><br></pre></td></tr></table></figure></p><p>2）单独某一台机器安装php<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">ansible-playbook</span> <span class="selector-tag">-i</span> <span class="selector-tag">hostlist</span> <span class="selector-tag">php_roles</span><span class="selector-class">.yml</span> <span class="selector-tag">--limit</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.31</span></span><br></pre></td></tr></table></figure></p><p>3）单独某一台机器安装mysql<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">ansible-playbook</span> <span class="selector-tag">-i</span> <span class="selector-tag">hostlist</span> <span class="selector-tag">mysql_roles</span><span class="selector-class">.yml</span> <span class="selector-tag">--limit</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.31</span></span><br></pre></td></tr></table></figure></p><p>4）单独某一台机器部署lnmp<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">ansible-playbook</span> <span class="selector-tag">-i</span> <span class="selector-tag">hostlist</span> <span class="selector-tag">lnmp</span><span class="selector-class">.yml</span> <span class="selector-tag">--limit</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.31</span></span><br></pre></td></tr></table></figure></p><p>5）所有机器部署php<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># ansible-playbook php_roles.yml</span></span><br></pre></td></tr></table></figure></p><p>6）所有机器部署nginx<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># ansible-playbook nginx_roles.yml</span></span><br></pre></td></tr></table></figure></p><p>7）所有机器部署mysql<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># ansible-playbook mysql_roles.yml</span></span><br></pre></td></tr></table></figure></p><p>8）所有机器部署lnmp<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># ansible-playbook lnmp.yml</span></span><br></pre></td></tr></table></figure></p><p><img src="/2019/06/05/Ansible项目实战lnmp/01.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;项目规划&quot;&gt;&lt;a href=&quot;#项目规划&quot; class=&quot;headerlink&quot; title=&quot;项目规划&quot;&gt;&lt;/a&gt;项目规划&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;通过&lt;code&gt;ansible roles&lt;/code&gt;配置&lt;code&gt;lnmp&lt;/code&gt;环境
      
    
    </summary>
    
      <category term="Ansible" scheme="https://leeyj.coding.me/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://leeyj.coding.me/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible之Roles</title>
    <link href="https://leeyj.coding.me/2019/06/03/Ansible%E4%B9%8BRoles/"/>
    <id>https://leeyj.coding.me/2019/06/03/Ansible之Roles/</id>
    <published>2019-06-03T02:35:22.000Z</published>
    <updated>2019-07-10T01:46:29.892Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Roles介绍"><a href="#Roles介绍" class="headerlink" title="Roles介绍"></a>Roles介绍</h2><blockquote><p><code>ansible</code>自<code>1.2</code>版本引入的新特性，用于层次性、结构化地组织<code>playbook</code>。<code>roles</code>能够根据层次型结构自动装载变量文件、<code>tasks</code>以及<code>handlers</code>等。要使用<code>roles</code>只需要在<code>playbook</code>中使用<code>include</code>指令引入即可。简单来讲，<code>roles</code>就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷的<code>include</code>它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。主要使用场景代码复用度较高的情况下。</p></blockquote><h2 id="Roles目录结构"><a href="#Roles目录结构" class="headerlink" title="Roles目录结构"></a>Roles目录结构</h2><p><img src="/2019/06/03/Ansible之Roles/rolesdir.png" alt="rolesdir.png"></p><p><strong>各目录含义解释</strong><br><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">roles</span>:          &lt;--所有的角色必须放在roles目录下，这个目录可以自定义位置，默认的位置在/etc/ansible/roles</span><br><span class="line">  project:      &lt;-<span class="comment">--具体的角色项目名称，比如nginx、tomcat、php</span></span><br><span class="line">    files：     &lt;--用来存放由copy模块或script模块调用的文件。</span><br><span class="line">    templates：&lt;--用来存放jinjia2模板，template模块会自动在此目录中寻找jinjia2模板文件。</span><br><span class="line">    tasks：     &lt;--此目录应当包含一个main.yml文件，用于定义此角色的任务列表，此文件可以使用include包含其它的位于此目录的task文件。</span><br><span class="line">  main.yml</span><br><span class="line">    handlers：&lt;--此目录应当包含一个main.yml文件，用于定义此角色中触发条件时执行的动作。</span><br><span class="line">  main.yml</span><br><span class="line">    vars： &lt;--此目录应当包含一个main.yml文件，用于定义此角色用到的变量。</span><br><span class="line">  main.yml</span><br><span class="line">    defaults：&lt;--此目录应当包含一个main.yml文件，用于为当前角色设定默认变量。</span><br><span class="line">  main.yml</span><br><span class="line">    meta：&lt;--此目录应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系。</span><br><span class="line">  main.yml</span><br></pre></td></tr></table></figure></p><h2 id="Roles示例"><a href="#Roles示例" class="headerlink" title="Roles示例"></a>Roles示例</h2><blockquote><p>通过<code>ansible roles</code>安装配置<code>httpd</code>服务，此处的<code>roles</code>使用默认的路径<code>/etc/ansible/roles</code></p></blockquote><p>1）创建目录<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># cd /etc/ansible/roles/</span></span><br><span class="line"><span class="meta"># 创建需要用到的目录</span></span><br><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># mkdir -p httpd/&#123;handlers,tasks,templates,vars&#125;</span></span><br><span class="line">[root<span class="symbol">@ansible</span> roles]<span class="meta"># cd httpd/</span></span><br><span class="line">[root<span class="symbol">@ansible</span> httpd]<span class="meta"># tree .</span></span><br><span class="line">.</span><br><span class="line">├── handlers</span><br><span class="line">├── tasks</span><br><span class="line">├── templates</span><br><span class="line">└── vars</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> directories, <span class="number">0</span> file</span><br></pre></td></tr></table></figure></p><p>2）变量文件准备<code>vars/main.yml</code><br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible httpd]<span class="meta"># vim vars/main.yml</span></span><br><span class="line"><span class="symbol">PORT:</span> <span class="number">8088</span>        <span class="meta">#指定httpd监听的端口</span></span><br><span class="line"><span class="symbol">USERNAME:</span> www     <span class="meta">#指定httpd运行用户</span></span><br><span class="line"><span class="symbol">GROUPNAME:</span> www    <span class="meta">#指定httpd运行组</span></span><br></pre></td></tr></table></figure></p><p>3）配置文件模板准备<code>templates/httpd.conf.j2</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># copy一个本地的配置文件放在templates/下并已j2为后缀</span></span><br><span class="line">[root@ansible httpd]# cp /etc/httpd/conf/httpd.conf templates/httpd.conf.j2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行一些修改，调用上面定义的变量</span></span><br><span class="line">[root@ansible httpd]# vim templates/httpd.conf.j2</span><br><span class="line">Listen &#123;&#123;<span class="built_in"> PORT </span>&#125;&#125; </span><br><span class="line">User &#123;&#123; USERNAME &#125;&#125;</span><br><span class="line">Group &#123;&#123; GROUPNAME &#125;&#125;</span><br></pre></td></tr></table></figure></p><p>4）任务剧本编写，创建用户、创建组、安装软件、配置、启动等<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建组的task</span></span><br><span class="line">[root@ansible httpd]# vim tasks/group.yml</span><br><span class="line">- name: Create a Startup Group</span><br><span class="line">  group: <span class="attribute">name</span>=www <span class="attribute">gid</span>=60 <span class="attribute">system</span>=<span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户的task</span></span><br><span class="line">[root@ansible httpd]# vim tasks/user.yml</span><br><span class="line">- name: Create Startup Users</span><br><span class="line">  user: <span class="attribute">name</span>=www <span class="attribute">uid</span>=60 <span class="attribute">system</span>=<span class="literal">yes</span> <span class="attribute">shell</span>=/sbin/nologin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装软件的task</span></span><br><span class="line">[root@ansible httpd]# vim tasks/install.yml</span><br><span class="line">- name: Install Package Httpd</span><br><span class="line">  yum: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=installed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置软件的task</span></span><br><span class="line">[root@ansible httpd]# vim tasks/config.yml</span><br><span class="line">- name: Copy Httpd Template File</span><br><span class="line">  template: <span class="attribute">src</span>=httpd.conf.j2 <span class="attribute">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class="line">  notify: Restart Httpd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动软件的task</span></span><br><span class="line">[root@ansible httpd]# vim tasks/start.yml</span><br><span class="line">- name: Start Httpd Service</span><br><span class="line">  service: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=started <span class="attribute">enabled</span>=<span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写main.yml，将上面的这些task引入进来</span></span><br><span class="line">[root@ansible httpd]# vim tasks/main.yml</span><br><span class="line">- include: group.yml</span><br><span class="line">- include: user.yml</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: config.yml</span><br><span class="line">- include: start.ym</span><br></pre></td></tr></table></figure></p><p>5）编写重启httpd的<code>handlers</code>，<code>handlers/main.yml</code><br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible httpd]<span class="comment"># vim handlers/main.yml</span></span><br><span class="line"><span class="comment"># 这里的名字需要和task中的notify保持一致</span></span><br><span class="line">- name: Restart Httpd</span><br><span class="line">  service: name=httpd <span class="keyword">state</span>=restarted</span><br></pre></td></tr></table></figure></p><p>6）编写主的<code>httpd_roles.yml</code>文件调用httpd角色<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">httpd]#</span> <span class="string">cd</span> <span class="string">..</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">roles]#</span> <span class="string">vim</span> <span class="string">httpd_roles.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">httpd</span>        <span class="comment">#指定角色名称</span></span><br></pre></td></tr></table></figure></p><p>7）整体的一个目录结构查看<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ansible roles]</span># <span class="selector-tag">tree</span> .</span><br><span class="line">.</span><br><span class="line">├── <span class="selector-tag">httpd</span></span><br><span class="line">│   ├── <span class="selector-tag">handlers</span></span><br><span class="line">│   │   └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">tasks</span></span><br><span class="line">│   │   ├── <span class="selector-tag">config</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">group</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">install</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">start</span><span class="selector-class">.yml</span></span><br><span class="line">│   │   └── <span class="selector-tag">user</span><span class="selector-class">.yml</span></span><br><span class="line">│   ├── <span class="selector-tag">templates</span></span><br><span class="line">│   │   └── <span class="selector-tag">httpd</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">│   └── <span class="selector-tag">vars</span></span><br><span class="line">│       └── <span class="selector-tag">main</span><span class="selector-class">.yml</span></span><br><span class="line">└── <span class="selector-tag">httpd_roles</span><span class="selector-class">.yml</span></span><br><span class="line"></span><br><span class="line">5 <span class="selector-tag">directories</span>, 10 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure></p><p>8）测试<code>playbook</code>语法是否正确<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible roles]# ansible-playbook -C httpd_roles.yml </span><br><span class="line"></span><br><span class="line">PLAY [all] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create a Startup Group] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create Startup Users] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Install Package Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Copy Httpd Template File] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Start Httpd Service] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [httpd : Restart Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><p>9）上面的测试没有问题，正式执行<code>playbook</code><br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible roles]# ansible-playbook -C httpd_roles.yml </span><br><span class="line"></span><br><span class="line">PLAY [all] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create a Startup Group] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create Startup Users] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Install Package Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Copy Httpd Template File] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Start Httpd Service] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [httpd : Restart Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br><span class="line">[root@ansible roles]# ansible-playbook httpd_roles.yml </span><br><span class="line"></span><br><span class="line">PLAY [all] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create a Startup Group] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Create Startup Users] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Install Package Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Copy Httpd Template File] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [httpd : Start Httpd Service] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">fatal: [192.168.1.36]: FAILED! =&gt; &#123;"changed": false, "msg": "httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\n"&#125;</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [httpd : Restart Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.36               : ok=5    changed=4    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><p>这里有看到报错，其原因是因为<code>192.168.1.36</code>这台机器是<code>centos6</code>系统，别的都是<code>centos7</code>系统，两个系统安装的<code>httpd</code>默认版本是不一样的，所以报错。如果需要优化。<a href="https://buji595.github.io/2019/05/29/Ansible%E4%B9%8BPlaybook/#template%E4%B9%8Bwhen" target="_blank" rel="noopener">参考这里</a></p><h2 id="ansible-roles总结"><a href="#ansible-roles总结" class="headerlink" title="ansible roles总结"></a>ansible roles总结</h2><blockquote><p>1、编写任务(<code>task</code>)的时候，里面不需要写需要执行的主机，单纯的写某个任务是干什么的即可，装软件的就是装软件的，启动的就是启动的。单独做某一件事即可，最后通过<code>main.yml</code>将这些单独的任务安装执行顺序<code>include</code>进来即可，这样方便维护且一目了然。<br>2、定义变量时候直接安装<code>k:v</code>格式将变量写在<code>vars/main.yml</code>文件即可，然后<code>task</code>或者<code>template</code>直接调用即可，会自动去<code>vars/main.yml</code>文件里面去找。<br>3、定义<code>handlers</code>时候，直接在<code>handlers/main.yml</code>文件中写需要做什么事情即可，多可的话可以全部写在该文件里面，也可以像<code>task</code>那样分开来写，通过<code>include</code>引入一样的可以。在<code>task</code>调用<code>notify</code>时直接写与<code>handlers</code>名字对应即可(二者必须高度一直)。<br>4、模板文件一样放在<code>templates</code>目录下即可，task调用的时后直接写文件名字即可，会自动去到<code>templates</code>里面找。注意：如果是一个角色调用另外一个角色的单个<code>task</code>时后，那么<code>task</code>中如果有些模板或者文件，就得写绝对路径了。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Roles介绍&quot;&gt;&lt;a href=&quot;#Roles介绍&quot; class=&quot;headerlink&quot; title=&quot;Roles介绍&quot;&gt;&lt;/a&gt;Roles介绍&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;ansible&lt;/code&gt;自&lt;code&gt;1.2&lt;/code&gt;
      
    
    </summary>
    
      <category term="Ansible" scheme="https://leeyj.coding.me/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://leeyj.coding.me/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible之Playbook</title>
    <link href="https://leeyj.coding.me/2019/05/29/Ansible%E4%B9%8BPlaybook/"/>
    <id>https://leeyj.coding.me/2019/05/29/Ansible之Playbook/</id>
    <published>2019-05-29T07:35:22.000Z</published>
    <updated>2019-07-10T01:46:29.882Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Playbook介绍"><a href="#Playbook介绍" class="headerlink" title="Playbook介绍"></a>Playbook介绍</h2><p><a href="https://ansible-tran.readthedocs.io/en/latest/docs/playbooks.html" target="_blank" rel="noopener">playbook参考文档</a></p><blockquote><p><code>Playbook</code>与<code>ad-hoc</code>相比,是一种完全不同的运用ansible的方式，类似与<code>saltstack</code>的<code>state</code>状态文件。<code>ad-hoc</code>无法持久使用，<code>playbook</code>可以持久使用。<br><code>playbook</code>是由一个或多个<code>play</code>组成的列表，<code>play</code>的主要功能在于将事先归并为一组的主机装扮成事先通过<code>ansible</code>中的<code>task</code>定义好的角色。从根本上来讲，所谓的<code>task</code>无非是调用<code>ansible</code>的一个<code>module</code>。将多个<code>play</code>组织在一个<code>playbook</code>中，即可以让它们联合起来按事先编排的机制完成某一任务</p></blockquote><h2 id="Playbook核心元素"><a href="#Playbook核心元素" class="headerlink" title="Playbook核心元素"></a>Playbook核心元素</h2><blockquote><ul><li>Hosts  执行的远程主机列表</li><li>Tasks  任务集</li><li>Varniables 内置变量或自定义变量在playbook中调用</li><li>Templates 模板，即使用模板语法的文件，比如配置文件等</li><li>Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li><li>tags 标签，指定某条任务执行，用于选择运行playbook中的部分代码。</li></ul></blockquote><h2 id="Playbook语法"><a href="#Playbook语法" class="headerlink" title="Playbook语法"></a>Playbook语法</h2><blockquote><p><code>playbook</code>使用<code>yaml</code>语法格式，后缀可以是<code>yaml</code>,也可以是<code>yml</code>。</p><ul><li>在单一一个<code>playbook</code>文件中，可以连续三个连子号(<code>---</code>)区分多个<code>play</code>。还有选择性的连续三个点好(<code>...</code>)用来表示<code>play</code>的结尾，也可省略。</li><li>次行开始正常写<code>playbook</code>的内容，一般都会写上描述该<code>playbook</code>的功能。</li><li>使用#号注释代码。</li><li>缩进必须统一，不能空格和<code>tab</code>混用。</li><li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行实现的。</li><li><code>YAML</code>文件内容和<code>Linux</code>系统大小写判断方式保持一致，是区分大小写的，<code>k/v</code>的值均需大小写敏感</li><li><code>k/v</code>的值可同行写也可以换行写。同行使用:分隔。</li><li><code>v</code>可以是个字符串，也可以是一个列表</li><li>一个完整的代码块功能需要最少元素包括 <code>name: task</code></li></ul></blockquote><h3 id="一个简单的示例"><a href="#一个简单的示例" class="headerlink" title="一个简单的示例"></a>一个简单的示例</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 创建playbook文件</span></span><br><span class="line">[root@ansible ~]# cat playbook01.yml</span><br><span class="line">---                       #固定格式</span><br><span class="line"><span class="bullet">- </span>hosts: 192.168.1.31     #定义需要执行主机</span><br><span class="line">  remote_user: root       #远程用户</span><br><span class="line">  vars:                   #定义变量</span><br><span class="line"><span class="code">    http_port: 8088       #变量</span></span><br><span class="line"></span><br><span class="line">  tasks:                             #定义一个任务的开始</span><br><span class="line"><span class="code">    - name: create new file          #定义任务的名称</span></span><br><span class="line"><span class="code">      file: name=/tmp/playtest.txt state=touch   #调用模块，具体要做的事情</span></span><br><span class="line"><span class="code">    - name: create new user</span></span><br><span class="line"><span class="code">      user: name=test02 system=yes shell=/sbin/nologin</span></span><br><span class="line"><span class="code">    - name: install package</span></span><br><span class="line"><span class="code">      yum: name=httpd</span></span><br><span class="line"><span class="code">    - name: config httpd</span></span><br><span class="line"><span class="code">      template: src=./httpd.conf dest=/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="code">      notify:                 #定义执行一个动作(action)让handlers来引用执行，与handlers配合使用</span></span><br><span class="line"><span class="code">        - restart apache      #notify要执行的动作，这里必须与handlers中的name定义内容一致</span></span><br><span class="line"><span class="code">    - name: copy index.html</span></span><br><span class="line"><span class="code">      copy: src=/var/www/html/index.html dest=/var/www/html/index.html</span></span><br><span class="line"><span class="code">    - name: start httpd</span></span><br><span class="line"><span class="code">      service: name=httpd state=started</span></span><br><span class="line">  handlers:                                    #处理器：更加tasks中notify定义的action触发执行相应的处理动作</span><br><span class="line"><span class="code">    - name: restart apache                     #要与notify定义的内容相同</span></span><br><span class="line"><span class="code">      service: name=httpd state=restarted      #触发要执行的动作</span></span><br><span class="line"></span><br><span class="line"><span class="section">#测试页面准备</span></span><br><span class="line">[root@ansible ~]# echo "<span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span>playbook test file<span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>" &gt;&gt;/var/www/html/index.html</span><br><span class="line"><span class="section">#配置文件准备</span></span><br><span class="line">[root@ansible ~]# cat httpd.conf |grep ^Listen</span><br><span class="line">Listen &#123;&#123; http_port &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">#执行playbook， 第一次执行可以加-C选项，检查写的playbook是否ok</span></span><br><span class="line">[root@ansible ~]# ansible-playbook playbook01.yml</span><br><span class="line">PLAY [192.168.1.31] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">TASK [create new file] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">TASK [create new user] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">TASK [install package] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">TASK [config httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">TASK [copy index.html] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">TASK [start httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section"># 验证上面playbook执行的结果</span></span><br><span class="line">[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'ls /tmp/playtest.txt &amp;&amp; id test02'</span><br><span class="line">192.168.1.31 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/tmp/playtest.txt</span><br><span class="line">uid=990(test02) gid=985(test02) 组=985(test02)</span><br><span class="line"></span><br><span class="line">[root@ansible ~]# curl 192.168.1.31:8088</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span>playbook test file<span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="Playbook的运行方式"><a href="#Playbook的运行方式" class="headerlink" title="Playbook的运行方式"></a>Playbook的运行方式</h2><blockquote><p>通过<code>ansible-playbook</code>命令运行<br>格式：<code>ansible-playbook &lt;filename.yml&gt; ... [options]</code><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# ansible-playbook -h</span><br><span class="line">#ansible-playbook常用选项：</span><br><span class="line">-<span class="ruby">-check  <span class="keyword">or</span> -C    <span class="comment">#只检测可能会发生的改变，但不真正执行操作</span></span></span><br><span class="line"><span class="ruby">--list-hosts      <span class="comment">#列出运行任务的主机</span></span></span><br><span class="line"><span class="ruby">--list-tags       <span class="comment">#列出playbook文件中定义所有的tags</span></span></span><br><span class="line"><span class="ruby">--list-tasks      <span class="comment">#列出playbook文件中定义的所以任务集</span></span></span><br><span class="line"><span class="ruby">--limit           <span class="comment">#主机列表 只针对主机列表中的某个主机或者某个组执行</span></span></span><br><span class="line"><span class="ruby">-f                <span class="comment">#指定并发数，默认为5个</span></span></span><br><span class="line"><span class="ruby">-t                <span class="comment">#指定tags运行，运行某一个或者多个tags。（前提playbook中有定义tags）</span></span></span><br><span class="line"><span class="ruby">-v                <span class="comment">#显示过程  -vv  -vvv更详细</span></span></span><br></pre></td></tr></table></figure></p></blockquote><h2 id="Playbook中元素属性"><a href="#Playbook中元素属性" class="headerlink" title="Playbook中元素属性"></a>Playbook中元素属性</h2><h3 id="主机与用户"><a href="#主机与用户" class="headerlink" title="主机与用户"></a>主机与用户</h3><blockquote><p>在一个<code>playbook</code>开始时，最先定义的是要操作的主机和用户</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure><blockquote><p>除了上面的定义外，还可以在某一个<code>tasks</code>中定义要执行该任务的远程用户</p></blockquote><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tasks: </span><br><span class="line">  - name: <span class="keyword">run</span> df -<span class="built_in">h</span></span><br><span class="line">    remote_user: <span class="keyword">test</span></span><br><span class="line">    <span class="keyword">shell</span>: name=df -<span class="built_in">h</span></span><br></pre></td></tr></table></figure><blockquote><p>还可以定义使用<code>sudo</code>授权用户执行该任务</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span> </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">run</span> <span class="string">df</span> <span class="bullet">-h</span></span><br><span class="line"><span class="attr">    sudo_user:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">name=df</span> <span class="bullet">-h</span></span><br></pre></td></tr></table></figure><h3 id="tasks任务列表"><a href="#tasks任务列表" class="headerlink" title="tasks任务列表"></a>tasks任务列表</h3><blockquote><p>每一个<code>task</code>必须有一个名称<code>name</code>,这样在运行<code>playbook</code>时，从其输出的任务执行信息中可以很清楚的辨别是属于哪一个<code>task</code>的，如果没有定义 <code>name</code>，<code>action</code>的值将会用作输出信息中标记特定的<code>task</code>。<br>每一个<code>playbook</code>中可以包含一个或者多个<code>tasks</code>任务列表，每一个<code>tasks</code>完成具体的一件事，（任务模块）比如创建一个用户或者安装一个软件等，在<code>hosts</code>中定义的主机或者主机组都将会执行这个被定义的<code>tasks</code>。</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - name: create new file</span><br><span class="line">    file: <span class="attribute">path</span>=/tmp/test01.txt <span class="attribute">state</span>=touch</span><br><span class="line">  - name: create new user</span><br><span class="line">    user: <span class="attribute">name</span>=test001 <span class="attribute">state</span>=present</span><br></pre></td></tr></table></figure><h3 id="Handlers与Notify"><a href="#Handlers与Notify" class="headerlink" title="Handlers与Notify"></a>Handlers与Notify</h3><blockquote><p>很多时候当我们某一个配置发生改变，我们需要重启服务，（比如httpd配置文件文件发生改变了）这时候就可以用到<code>handlers</code>和<code>notify</code>了；<br>(当发生改动时)<code>notify actions</code>会在<code>playbook</code>的每一个task结束时被触发，而且即使有多个不同task通知改动的发生，<code>notify actions</code>知会被触发一次；比如多个<code>resources</code>指出因为一个配置文件被改动，所以<code>apache</code>需要重启，但是重新启动的操作知会被执行一次。</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# cat httpd.yml </span><br><span class="line"><span class="comment">#用于安装httpd并配置启动</span></span><br><span class="line">---</span><br><span class="line">- hosts: 192.168.1.31</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">  - name: install httpd</span><br><span class="line">    yum: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=installed</span><br><span class="line">  - name:<span class="built_in"> config </span>httpd</span><br><span class="line">    template: <span class="attribute">src</span>=/root/httpd.conf <span class="attribute">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class="line">    notify:</span><br><span class="line">      - restart httpd</span><br><span class="line">  - name: start httpd</span><br><span class="line">    service: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=started</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart httpd</span><br><span class="line">      service: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=restarted</span><br><span class="line"></span><br><span class="line"><span class="comment">#这里只要对httpd.conf配置文件作出了修改，修改后需要重启生效，在tasks中定义了restart httpd这个action，然后在handlers中引用上面tasks中定义的notify。</span></span><br></pre></td></tr></table></figure><h2 id="Playbook中变量的使用"><a href="#Playbook中变量的使用" class="headerlink" title="Playbook中变量的使用"></a>Playbook中变量的使用</h2><p><strong>环境说明</strong>：这里配置了两个组，一个apache组和一个nginx组<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible PlayBook]</span># cat /etc/ansible/hosts</span><br><span class="line"><span class="string">[apache]</span></span><br><span class="line"><span class="number">192.168.1.36</span></span><br><span class="line"><span class="number">192.168.1.33</span></span><br><span class="line"></span><br><span class="line"><span class="string">[nginx]</span></span><br><span class="line"><span class="number">192.168.1.3</span><span class="string">[1:2]</span></span><br></pre></td></tr></table></figure></p><h3 id="命令行指定变量"><a href="#命令行指定变量" class="headerlink" title="命令行指定变量"></a>命令行指定变量</h3><blockquote><p>执行<code>playbook</code>时候通过参数<code>-e</code>传入变量，这样传入的变量在整个<code>playbook</code>中都可以被调用，属于全局变量</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">variables.yml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">install</span> <span class="string">pkg</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkg</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行playbook 指定pkg</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span> <span class="bullet">-e</span> <span class="string">"pkg=httpd"</span> <span class="string">variables.yml</span></span><br></pre></td></tr></table></figure><h3 id="hosts文件中定义变量"><a href="#hosts文件中定义变量" class="headerlink" title="hosts文件中定义变量"></a>hosts文件中定义变量</h3><blockquote><p>在<code>/etc/ansible/hosts</code>文件中定义变量，可以针对每个主机定义不同的变量，也可以定义一个组的变量，然后直接在<code>playbook</code>中直接调用。注意，组中定义的变量没有单个主机中的优先级高。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑hosts文件定义变量</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">vim</span> <span class="string">/etc/ansible/hosts</span></span><br><span class="line"><span class="string">[apache]</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.36</span> <span class="string">webdir=/opt/test</span>     <span class="comment">#定义单个主机的变量</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span></span><br><span class="line"><span class="string">[apache:vars]</span>      <span class="comment">#定义整个组的统一变量</span></span><br><span class="line"><span class="string">webdir=/web/test</span></span><br><span class="line"></span><br><span class="line"><span class="string">[nginx]</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span><span class="string">[1:2]</span></span><br><span class="line"><span class="string">[nginx:vars]</span></span><br><span class="line"><span class="string">webdir=/opt/web</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑playbook文件</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">variables.yml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">webdir</span></span><br><span class="line"><span class="attr">      file:</span> <span class="string">name=&#123;&#123;</span> <span class="string">webdir</span> <span class="string">&#125;&#125;</span> <span class="string">state=directory</span>   <span class="comment">#引用变量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span> <span class="string">variables.yml</span></span><br></pre></td></tr></table></figure><h3 id="playbook文件中定义变量"><a href="#playbook文件中定义变量" class="headerlink" title="playbook文件中定义变量"></a>playbook文件中定义变量</h3><blockquote><p>编写<code>playbook</code>时，直接在里面定义变量，然后直接引用，可以定义多个变量；注意：如果在执行<code>playbook</code>时，又通过<code>-e</code>参数指定变量的值，那么会以<code>-e</code>参数指定的为准。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">variables.yml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span>                <span class="comment">#定义变量</span></span><br><span class="line"><span class="attr">    pkg:</span> <span class="string">nginx</span>         <span class="comment">#变量1</span></span><br><span class="line"><span class="attr">    dir:</span> <span class="string">/tmp/test1</span>    <span class="comment">#变量2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">install</span> <span class="string">pkg</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkg</span> <span class="string">&#125;&#125;</span> <span class="string">state=installed</span>    <span class="comment">#引用变量</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">new</span> <span class="string">dir</span></span><br><span class="line"><span class="attr">      file:</span> <span class="string">name=&#123;&#123;</span> <span class="string">dir</span> <span class="string">&#125;&#125;</span> <span class="string">state=directory</span>   <span class="comment">#引用变量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span> <span class="string">variables.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果执行时候又重新指定了变量的值，那么会已重新指定的为准</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span> <span class="bullet">-e</span> <span class="string">"dir=/tmp/test2"</span> <span class="string">variables.yml</span></span><br></pre></td></tr></table></figure><h3 id="调用setup模块获取变量"><a href="#调用setup模块获取变量" class="headerlink" title="调用setup模块获取变量"></a>调用setup模块获取变量</h3><blockquote><p><code>setup</code>模块默认是获取主机信息的，有时候在<code>playbook</code>中需要用到，所以可以直接调用。常用的参数<a href="https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup" target="_blank" rel="noopener">参考</a></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑playbook文件</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">variables.yml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">file</span></span><br><span class="line"><span class="attr">      file:</span> <span class="string">name=&#123;&#123;</span> <span class="string">ansible_fqdn</span> <span class="string">&#125;&#125;.log</span> <span class="string">state=touch</span>   <span class="comment">#引用setup中的ansible_fqdn</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span> <span class="string">variables.yml</span></span><br></pre></td></tr></table></figure><h3 id="独立的变量YAML文件中定义"><a href="#独立的变量YAML文件中定义" class="headerlink" title="独立的变量YAML文件中定义"></a>独立的变量YAML文件中定义</h3><blockquote><p>为了方便管理将所有的变量统一放在一个独立的变量<code>YAML</code>文件中，<code>laybook</code>文件直接引用文件调用变量即可。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义存放变量的文件</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">var.yml</span> </span><br><span class="line"><span class="attr">var1:</span> <span class="string">vsftpd</span></span><br><span class="line"><span class="attr">var2:</span> <span class="string">httpd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">variables.yml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars_files:</span>    <span class="comment">#引用变量文件</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">./var.yml</span>   <span class="comment">#指定变量文件的path（这里可以是绝对路径，也可以是相对路径）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">var1</span> <span class="string">&#125;&#125;</span>   <span class="comment">#引用变量</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">file</span></span><br><span class="line"><span class="attr">      file:</span> <span class="string">name=/tmp/&#123;&#123;</span> <span class="string">var2</span> <span class="string">&#125;&#125;.log</span> <span class="string">state=touch</span>   <span class="comment">#引用变量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行playbook</span></span><br><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">ansible-playbook</span>  <span class="string">variables.yml</span></span><br></pre></td></tr></table></figure><h2 id="Playbook中标签的使用"><a href="#Playbook中标签的使用" class="headerlink" title="Playbook中标签的使用"></a>Playbook中标签的使用</h2><blockquote><p>一个<code>playbook</code>文件中，执行时如果想执行某一个任务，那么可以给每个任务集进行打标签，这样在执行的时候可以通过<code>-t</code>选择指定标签执行，还可以通过<code>--skip-tags</code>选择除了某个标签外全部执行等。</p></blockquote><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 编辑playbook</span></span><br><span class="line">[root@ansible PlayBook]# cat httpd.yml </span><br><span class="line">---</span><br><span class="line"><span class="bullet">- </span>hosts: 192.168.1.31</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line"><span class="code">    - name: install httpd</span></span><br><span class="line"><span class="code">      yum: name=httpd state=installed</span></span><br><span class="line"><span class="code">      tags: inhttpd</span></span><br><span class="line"></span><br><span class="line"><span class="code">    - name: start httpd</span></span><br><span class="line"><span class="code">      service: name=httpd state=started</span></span><br><span class="line"><span class="code">      tags: sthttpd</span></span><br><span class="line"></span><br><span class="line"><span class="code">    - name: restart httpd</span></span><br><span class="line"><span class="code">      service: name=httpd state=restarted</span></span><br><span class="line"><span class="code">      tags: </span></span><br><span class="line"><span class="code">        - rshttpd</span></span><br><span class="line"><span class="code">        - rs_httpd</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 正常执行的结果</span></span><br><span class="line">[root@ansible PlayBook]# ansible-playbook httpd.yml </span><br><span class="line"></span><br><span class="line">PLAY [192.168.1.31] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [install httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [start httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [restart httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">192.168.1.31               : ok=4    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><p>1）通过<code>-t</code>选项指定<code>tags</code>进行执行<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 通过-t指定tags名称，多个tags用逗号隔开</span></span><br><span class="line">[root@ansible PlayBook]# ansible-playbook -t rshttpd httpd.yml </span><br><span class="line"></span><br><span class="line">PLAY [192.168.1.31] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [restart httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">192.168.1.31               : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><p>2）通过<code>--skip-tags</code>选项排除不执行的<code>tags</code><br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# ansible-playbook --skip-tags inhttpd httpd.yml </span><br><span class="line"></span><br><span class="line">PLAY [192.168.1.31] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [start httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [restart httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">192.168.1.31               : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><h2 id="Playbook中模板的使用"><a href="#Playbook中模板的使用" class="headerlink" title="Playbook中模板的使用"></a>Playbook中模板的使用</h2><blockquote><p><code>template</code>模板为我们提供了动态配置服务，使用<code>jinja2</code>语言，里面支持多种条件判断、循环、逻辑运算、比较操作等。其实说白了也就是一个文件，和之前配置文件使用<code>copy</code>一样，只是使用<code>copy</code>，不能根据服务器配置不一样进行不同动态的配置。这样就不利于管理。<br>说明：<br>1、多数情况下都将<code>template</code>文件放在和<code>playbook</code>文件同级的<code>templates</code>目录下（手动创建），这样<code>playbook</code>文件中可以直接引用，会自动去找这个文件。如果放在别的地方，也可以通过绝对路径去指定。<br>2、模板文件后缀名为<code>.j2</code>。</p></blockquote><p><a href="http://www.ansible.com.cn/docs/playbooks_loops.html#standard-loops" target="_blank" rel="noopener">循环参考</a><br><strong>示例：通过template安装httpd</strong><br>1）<code>playbook</code>文件编写<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">testtmp.yml</span> </span><br><span class="line"><span class="comment">#模板示例</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    - listen_port:</span> <span class="number">88</span>    <span class="comment">#定义变量</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=httpd</span> <span class="string">state=installed</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Config</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=httpd.conf.j2</span> <span class="string">dest=/etc/httpd/conf/httpd.conf</span>    <span class="comment">#使用模板</span></span><br><span class="line"><span class="attr">      notify:</span> <span class="string">Restart</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Start</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Restart</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure></p><p>2）模板文件准备，<code>httpd</code>配置文件准备，这里配置文件端口使用了变量<br><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# cat templates/httpd.conf.j2 |grep ^<span class="keyword">Listen</span></span><br><span class="line"><span class="keyword">Listen</span> &#123;&#123; listen_port &#125;&#125;</span><br></pre></td></tr></table></figure></p><p>3）查看目录结构<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 目录结构</span><br><span class="line"><span class="selector-attr">[root@ansible PlayBook]</span># <span class="selector-tag">tree</span> .</span><br><span class="line">.</span><br><span class="line">├── <span class="selector-tag">templates</span></span><br><span class="line">│   └── <span class="selector-tag">httpd</span><span class="selector-class">.conf</span><span class="selector-class">.j2</span></span><br><span class="line">└── <span class="selector-tag">testtmp</span><span class="selector-class">.yml</span></span><br><span class="line"></span><br><span class="line">1 <span class="selector-tag">directory</span>, 2 <span class="selector-tag">files</span></span><br></pre></td></tr></table></figure></p><p>4）执行<code>playbook</code>，由于<code>192.168.1.36</code>那台机器是<code>6</code>的系统，模板文件里面的配置文件是<code>7</code>上面默认的<code>httpd</code>配置文件，<code>httpd</code>版本不一样(<code>6默认版本为2.2.15，7默认版本为2.4.6</code>)，所以拷贝过去后启动报错。下面使用<code>playbook</code>中的判断语句进行处理；此处先略过<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# ansible-playbook testtmp.yml </span><br><span class="line"></span><br><span class="line">PLAY [all] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [Install Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">TASK [Config Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [Start Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">fatal: [192.168.1.36]: FAILED! =&gt; &#123;"changed": false, "msg": "httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\n"&#125;</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [Restart Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">192.168.1.31               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.32               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.33               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.1.36               : ok=3    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><h3 id="template之when"><a href="#template之when" class="headerlink" title="template之when"></a>template之when</h3><p><a href="http://www.ansible.com.cn/docs/playbooks_conditionals.html#when" target="_blank" rel="noopener">when语句参考</a></p><blockquote><p>条件测试：如果需要根据变量、<code>facts</code>或此前任务的执行结果来做为某<code>task</code>执行与否的前提时要用到条件测试，通过<code>when</code>语句执行，在<code>task</code>中使用<code>jinja2</code>的语法格式、<br>when语句：<br>在<code>task</code>后添加<code>when</code>子句即可使用条件测试；<code>when</code>语句支持<code>jinja2</code>表达式语法。</p></blockquote><p>类似这样：<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - <span class="keyword">command</span>: /<span class="title">bin</span>/<span class="title">false</span></span><br><span class="line">    register: <span class="built_in">result</span></span><br><span class="line">    ignore_errors: True</span><br><span class="line">  - <span class="keyword">command</span>: /<span class="title">bin</span>/<span class="title">something</span></span><br><span class="line">    when: <span class="built_in">result</span>|failed</span><br><span class="line">  - <span class="keyword">command</span>: /<span class="title">bin</span>/<span class="title">something_else</span></span><br><span class="line">    when: <span class="built_in">result</span>|success</span><br><span class="line">  - <span class="keyword">command</span>: /<span class="title">bin</span>/<span class="title">still</span>/<span class="title">something_else</span></span><br><span class="line">    when: <span class="built_in">result</span>|skipped</span><br></pre></td></tr></table></figure></p><p><strong>示例：通过when语句完善上面的httpd配置</strong><br>1）准备两个配置文件，一个<code>centos6</code>系统<code>httpd</code>配置文件，一个<code>centos7</code>系统httpd配置文件。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# tree templates/</span><br><span class="line">templates/</span><br><span class="line">├── httpd6.conf.j2     #<span class="number">6</span>系统<span class="number">2.2</span><span class="number">.15</span>版本httpd配置文件</span><br><span class="line">└── httpd7.conf.j2     #<span class="number">7</span>系统<span class="number">2.4</span><span class="number">.6</span>版本httpd配置文件</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> directories, <span class="number">2</span> files</span><br></pre></td></tr></table></figure></p><p>2）修改<code>playbook</code>文件，通过setup模块获取系统版本去判断。<a href="https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup" target="_blank" rel="noopener">setup常用模块</a><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# cat testtmp.yml </span><br><span class="line"><span class="comment">#when示例</span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    - listen_port: 88</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Httpd</span><br><span class="line">      yum: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=installed</span><br><span class="line">    - name:<span class="built_in"> Config </span>System6 Httpd</span><br><span class="line">      template: <span class="attribute">src</span>=httpd6.conf.j2 <span class="attribute">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class="line">      when: ansible_distribution_major_version == <span class="string">"6"</span>   #判断系统版本，为6便执行上面的template配置6的配置文件</span><br><span class="line">      notify: Restart Httpd</span><br><span class="line">    - name:<span class="built_in"> Config </span>System7 Httpd</span><br><span class="line">      template: <span class="attribute">src</span>=httpd7.conf.j2 <span class="attribute">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class="line">      when: ansible_distribution_major_version == <span class="string">"7"</span>   #判断系统版本，为7便执行上面的template配置7的配置文件</span><br><span class="line">      notify: Restart Httpd</span><br><span class="line">    - name: Start Httpd</span><br><span class="line">      service: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=started</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: Restart Httpd</span><br><span class="line">      service: <span class="attribute">name</span>=httpd <span class="attribute">state</span>=restarted</span><br></pre></td></tr></table></figure></p><p>3）执行playbook<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]# ansible-playbook testtmp.yml</span><br><span class="line"></span><br><span class="line">PLAY [all] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [Install Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [Config System6 Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">skipping: [192.168.1.33]</span><br><span class="line">skipping: [192.168.1.31]</span><br><span class="line">skipping: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">TASK [Config System7 Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">skipping: [192.168.1.36]</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line"></span><br><span class="line">TASK [Start Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">ok: [192.168.1.36]</span><br><span class="line">ok: [192.168.1.31]</span><br><span class="line">ok: [192.168.1.32]</span><br><span class="line">ok: [192.168.1.33]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [Restart Httpd] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">changed: [192.168.1.33]</span><br><span class="line">changed: [192.168.1.31]</span><br><span class="line">changed: [192.168.1.32]</span><br><span class="line">changed: [192.168.1.36]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">192.168.1.31               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">192.168.1.32               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">192.168.1.33               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">192.168.1.36               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p><h3 id="template之with-items"><a href="#template之with-items" class="headerlink" title="template之with_items"></a>template之with_items</h3><blockquote><p><code>with_items</code>迭代，当有需要重复性执行的任务时，可以使用迭代机制。<br>对迭代项的引用，固定变量名为<code>“item”</code>，要在task中使用with_items给定要迭代的元素列表。<br>列表格式：<br>&emsp;&ensp;字符串<br>&emsp;&ensp;字典</p></blockquote><p><strong>示例1：通过with_items安装多个不同软件</strong><br>编写<code>playbook</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">testwith.yml</span> </span><br><span class="line"><span class="comment"># 示例with_items</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Package</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=installed</span>   <span class="comment">#引用item获取值</span></span><br><span class="line"><span class="attr">      with_items:</span>     <span class="comment">#定义with_items</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">httpd</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">vsftpd</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure></p><p>上面<code>tasks</code>写法等同于：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Httpd</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=httpd</span> <span class="string">state=installed</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Vsftpd</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=vsftpd</span> <span class="string">state=installed</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=nginx</span> <span class="string">state=installed</span></span><br></pre></td></tr></table></figure></p><p><strong>示例2：通过嵌套子变量创建用户并加入不同的组</strong><br>1）编写<code>playbook</code><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]<span class="comment"># cat testwith01.yml </span></span><br><span class="line"><span class="comment"># 示例with_items嵌套子变量</span></span><br><span class="line"><span class="comment">---</span></span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: <span class="keyword">Create</span> <span class="keyword">New</span> <span class="keyword">Group</span></span><br><span class="line">      <span class="keyword">group</span>: <span class="keyword">name</span>=&#123;&#123; item &#125;&#125; state=<span class="keyword">present</span></span><br><span class="line">      with_items: </span><br><span class="line">        - group1</span><br><span class="line">        - group2</span><br><span class="line">        - group3 </span><br><span class="line"></span><br><span class="line">    - <span class="keyword">name</span>: <span class="keyword">Create</span> <span class="keyword">New</span> <span class="keyword">User</span></span><br><span class="line">      <span class="keyword">user</span>: <span class="keyword">name</span>=&#123;&#123; item.name &#125;&#125; <span class="keyword">group</span>=&#123;&#123; item.group &#125;&#125; state=<span class="keyword">present</span></span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; <span class="keyword">name</span>: <span class="string">'user1'</span>, <span class="keyword">group</span>: <span class="string">'group1'</span> &#125; </span><br><span class="line">        - &#123; <span class="keyword">name</span>: <span class="string">'user2'</span>, <span class="keyword">group</span>: <span class="string">'group2'</span> &#125; </span><br><span class="line">        - &#123; <span class="keyword">name</span>: <span class="string">'user3'</span>, <span class="keyword">group</span>: <span class="string">'group3'</span> &#125;</span><br></pre></td></tr></table></figure></p><p>2）执行<code>playbook</code>并验证<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行playbook</span></span><br><span class="line">[root@ansible PlayBook]<span class="comment"># ansible-playbook testwith01.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证是否成功创建用户及组</span></span><br><span class="line">[root@ansible PlayBook]<span class="comment"># ansible all -m shell -a 'tail -3 /etc/passwd'</span></span><br><span class="line"><span class="meta">192.168.1.36 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">user1:</span><span class="symbol">x:</span><span class="number">500</span><span class="symbol">:</span><span class="number">500</span><span class="symbol">:</span><span class="symbol">:/home/user1</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user2:</span><span class="symbol">x:</span><span class="number">501</span><span class="symbol">:</span><span class="number">501</span><span class="symbol">:</span><span class="symbol">:/home/user2</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user3:</span><span class="symbol">x:</span><span class="number">502</span><span class="symbol">:</span><span class="number">502</span><span class="symbol">:</span><span class="symbol">:/home/user3</span><span class="symbol">:/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">192.168.1.32 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">user1:</span><span class="symbol">x:</span><span class="number">1001</span><span class="symbol">:</span><span class="number">1001</span><span class="symbol">:</span><span class="symbol">:/home/user1</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user2:</span><span class="symbol">x:</span><span class="number">1002</span><span class="symbol">:</span><span class="number">1002</span><span class="symbol">:</span><span class="symbol">:/home/user2</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user3:</span><span class="symbol">x:</span><span class="number">1003</span><span class="symbol">:</span><span class="number">1003</span><span class="symbol">:</span><span class="symbol">:/home/user3</span><span class="symbol">:/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">user1:</span><span class="symbol">x:</span><span class="number">1002</span><span class="symbol">:</span><span class="number">1003</span><span class="symbol">:</span><span class="symbol">:/home/user1</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user2:</span><span class="symbol">x:</span><span class="number">1003</span><span class="symbol">:</span><span class="number">1004</span><span class="symbol">:</span><span class="symbol">:/home/user2</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user3:</span><span class="symbol">x:</span><span class="number">1004</span><span class="symbol">:</span><span class="number">1005</span><span class="symbol">:</span><span class="symbol">:/home/user3</span><span class="symbol">:/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">192.168.1.33 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">user1:</span><span class="symbol">x:</span><span class="number">1001</span><span class="symbol">:</span><span class="number">1001</span><span class="symbol">:</span><span class="symbol">:/home/user1</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user2:</span><span class="symbol">x:</span><span class="number">1002</span><span class="symbol">:</span><span class="number">1002</span><span class="symbol">:</span><span class="symbol">:/home/user2</span><span class="symbol">:/bin/bash</span></span><br><span class="line"><span class="symbol">user3:</span><span class="symbol">x:</span><span class="number">1003</span><span class="symbol">:</span><span class="number">1003</span><span class="symbol">:</span><span class="symbol">:/home/user3</span><span class="symbol">:/bin/bash</span></span><br></pre></td></tr></table></figure></p><h3 id="template之for-if"><a href="#template之for-if" class="headerlink" title="template之for if"></a>template之for if</h3><blockquote><p>通过使用<code>for</code>，<code>if</code>可以更加灵活的生成配置文件等需求，还可以在里面根据各种条件进行判断，然后生成不同的配置文件、或者服务器配置相关等。</p></blockquote><p><strong>示例1</strong><br>1）编写<code>playbook</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">testfor01.yml</span> </span><br><span class="line"><span class="comment"># template for 示例</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    nginx_vhost_port:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">81</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">82</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">83</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Templage</span> <span class="string">Nginx</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/tmp/nginx_test.conf</span></span><br></pre></td></tr></table></figure></p><p>2）模板文件编写<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 循环playbook文件中定义的变量，依次赋值给port</span></span><br><span class="line">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span><br><span class="line">&#123;% <span class="keyword">for</span><span class="built_in"> port </span><span class="keyword">in</span> nginx_vhost_port %&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     listen: &#123;&#123;<span class="built_in"> port </span>&#125;&#125;;</span><br><span class="line">     server_name: localhost;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure></p><p>3）执行<code>playbook</code>并查看生成结果<br><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]<span class="comment"># ansible-playbook testfor01.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class="line">[root@linux ~]<span class="comment"># cat /tmp/nginx_test.conf </span></span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>: 81;</span><br><span class="line">     <span class="attribute">server_name</span>: localhost;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>: 82;</span><br><span class="line">     <span class="attribute">server_name</span>: localhost;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>: 83;</span><br><span class="line">     <span class="attribute">server_name</span>: localhost;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>示例2</strong><br>1）编写<code>playbook</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">testfor02.yml</span> </span><br><span class="line"><span class="comment"># template for 示例</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    nginx_vhosts:</span></span><br><span class="line"><span class="attr">      - web1:</span></span><br><span class="line"><span class="attr">        listen:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">        server_name:</span> <span class="string">"web1.example.com"</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web1"</span></span><br><span class="line"><span class="attr">      - web2:</span></span><br><span class="line"><span class="attr">        listen:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">        server_name:</span> <span class="string">"web2.example.com"</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web2"</span></span><br><span class="line"><span class="attr">      - web3:</span></span><br><span class="line"><span class="attr">        listen:</span> <span class="number">8083</span></span><br><span class="line"><span class="attr">        server_name:</span> <span class="string">"web3.example.com"</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Templage</span> <span class="string">Nginx</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/tmp/nginx_vhost.conf</span></span><br></pre></td></tr></table></figure></p><p>2）模板文件编写<br><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> vhost <span class="keyword">in</span> nginx_vhosts %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">server&#123;</span></span><br><span class="line"><span class="xml">     listen:    </span><span class="template-variable">&#123;&#123; vhost.listen &#125;&#125;</span><span class="xml">;</span></span><br><span class="line"><span class="xml">     server_name:    </span><span class="template-variable">&#123;&#123; vhost.server_name &#125;&#125;</span><span class="xml">;</span></span><br><span class="line"><span class="xml">     root:   </span><span class="template-variable">&#123;&#123; vhost.root &#125;&#125;</span><span class="xml">; </span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure></p><p>3）执行<code>playbook</code>并查看生成结果<br><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]<span class="comment"># ansible-playbook testfor02.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class="line">[root@linux ~]<span class="comment"># cat /tmp/nginx_vhost.conf </span></span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>:    8081;</span><br><span class="line">     <span class="attribute">server_name</span>:    web1<span class="variable">.example</span><span class="variable">.com</span>;</span><br><span class="line">     <span class="attribute">root</span>:   /var/www/nginx/web1; </span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>:    8082;</span><br><span class="line">     <span class="attribute">server_name</span>:    web2<span class="variable">.example</span><span class="variable">.com</span>;</span><br><span class="line">     <span class="attribute">root</span>:   /var/www/nginx/web2; </span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     <span class="attribute">listen</span>:    8083;</span><br><span class="line">     <span class="attribute">server_name</span>:    web3<span class="variable">.example</span><span class="variable">.com</span>;</span><br><span class="line">     <span class="attribute">root</span>:   /var/www/nginx/web3; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>示例3</strong><br>在for循环中再嵌套if判断，让生成的配置文件更加灵活<br>1）编写<code>playbook</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@ansible</span> <span class="string">PlayBook]#</span> <span class="string">cat</span> <span class="string">testfor03.yml</span> </span><br><span class="line"><span class="comment"># template for 示例</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    nginx_vhosts:</span></span><br><span class="line"><span class="attr">      - web1:</span></span><br><span class="line"><span class="attr">        listen:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web1"</span></span><br><span class="line"><span class="attr">      - web2:</span></span><br><span class="line"><span class="attr">        server_name:</span> <span class="string">"web2.example.com"</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web2"</span></span><br><span class="line"><span class="attr">      - web3:</span></span><br><span class="line"><span class="attr">        listen:</span> <span class="number">8083</span></span><br><span class="line"><span class="attr">        server_name:</span> <span class="string">"web3.example.com"</span></span><br><span class="line"><span class="attr">        root:</span> <span class="string">"/var/www/nginx/web3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Templage</span> <span class="string">Nginx</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/tmp/nginx_vhost.conf</span></span><br></pre></td></tr></table></figure></p><p>2）模板文件编写<br><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"># 说明：这里添加了判断，如果listen没有定义的话，默认端口使用8888，如果server_name有定义，那么生成的配置文件中才有这一项。</span></span><br><span class="line"><span class="xml">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> vhost <span class="keyword">in</span> nginx_vhosts %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">server&#123;</span></span><br><span class="line"><span class="xml">     </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> vhost.listen is defined %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">     listen:    </span><span class="template-variable">&#123;&#123; vhost.listen &#125;&#125;</span><span class="xml">;</span></span><br><span class="line"><span class="xml">     </span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">     listen: 8888;</span></span><br><span class="line"><span class="xml">     </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">     </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> vhost.server_name is defined %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">     server_name:    </span><span class="template-variable">&#123;&#123; vhost.server_name &#125;&#125;</span><span class="xml">;</span></span><br><span class="line"><span class="xml">     </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">     root:   </span><span class="template-variable">&#123;&#123; vhost.root &#125;&#125;</span><span class="xml">; </span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure></p><p>3）执行<code>playbook</code>并查看生成结果<br><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible PlayBook]<span class="comment"># ansible-playbook testfor03.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class="line">[root@linux ~]<span class="comment"># cat /tmp/nginx_vhost.conf </span></span><br><span class="line">server&#123;</span><br><span class="line">          <span class="attribute">listen</span>:    8081;</span><br><span class="line">          <span class="attribute">root</span>:   /var/www/nginx/web1; </span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">          <span class="attribute">listen</span>: 8888;</span><br><span class="line">          <span class="attribute">server_name</span>:    web2<span class="variable">.example</span><span class="variable">.com</span>;</span><br><span class="line">          <span class="attribute">root</span>:   /var/www/nginx/web2; </span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">          <span class="attribute">listen</span>:    8083;</span><br><span class="line">          <span class="attribute">server_name</span>:    web3<span class="variable">.example</span><span class="variable">.com</span>;</span><br><span class="line">          <span class="attribute">root</span>:   /var/www/nginx/web3; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>上面三个示例的图片展示效果</strong><br><div class="tabs" id><ul class="nav-tabs"><li class="tab active"><a href="#-1">示例1</a></li><li class="tab"><a href="#-2">示例2</a></li><li class="tab"><a href="#-3">示例3</a></li></ul><div class="tab-content"><div class="tab-pane active" id="-1"><p><img src="/2019/05/29/Ansible之Playbook/shili01.png" alt></p></div><div class="tab-pane" id="-2"><p><img src="/2019/05/29/Ansible之Playbook/shili02.png" alt></p></div><div class="tab-pane" id="-3"><p><img src="/2019/05/29/Ansible之Playbook/shili03.png" alt></p></div></div></div></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Playbook介绍&quot;&gt;&lt;a href=&quot;#Playbook介绍&quot; class=&quot;headerlink&quot; title=&quot;Playbook介绍&quot;&gt;&lt;/a&gt;Playbook介绍&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://ansible-tran.readthed
      
    
    </summary>
    
      <category term="Ansible" scheme="https://leeyj.coding.me/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://leeyj.coding.me/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible  Module</title>
    <link href="https://leeyj.coding.me/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/"/>
    <id>https://leeyj.coding.me/2019/05/27/Ansible Ad-hoc常用Module/</id>
    <published>2019-05-27T15:25:22.000Z</published>
    <updated>2019-07-10T01:46:29.880Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Ansible-Ad-hoc模式常用模块"><a href="#Ansible-Ad-hoc模式常用模块" class="headerlink" title="Ansible Ad-hoc模式常用模块"></a>Ansible Ad-hoc模式常用模块</h2><p>ansible-doc 常用命令<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ansible-doc -h</span></span><br><span class="line"><span class="symbol">Usage:</span> ansible-doc [-l<span class="params">|-F|</span>-s] [options] [-t &lt;plugin type&gt; ] [plugin]</span><br><span class="line">-j  以json格式显示所有模块信息</span><br><span class="line">-l  列出所有的模块</span><br><span class="line">-s  查看模块常用参数</span><br><span class="line"><span class="comment"># 直接跟模块名，显示模块所有信息</span></span><br><span class="line"></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -j</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -l</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -l |wc -l   #统计所有模块个数，ansible2.8共计2834个模块</span></span><br><span class="line"><span class="number">2834</span></span><br></pre></td></tr></table></figure></p><h3 id="命令相关的模块"><a href="#命令相关的模块" class="headerlink" title="命令相关的模块"></a>命令相关的模块</h3><h4 id="command"><a href="#command" class="headerlink" title="command"></a>command</h4><blockquote><p><code>ansible</code>默认的模块,执行命令，注意：shell中的<code>&quot;&lt;&quot;</code>, <code>&quot;&gt;&quot;</code>, <code>&quot;|&quot;</code>, <code>&quot;;&quot;</code>, <code>&quot;&amp;&quot;</code>,<code>&quot;$&quot;</code>等特殊字符不能在<code>command</code>模块中使用，如果需要使用，则用<code>shell</code>模块</p></blockquote><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 查看模块参数</span><br><span class="line">[root@ansible ~]# ansible-doc -s command</span><br><span class="line"></span><br><span class="line"># 在<span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span>服务器上面执行ls命令，默认是在当前用户的家目录/root</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'ls'</span><br><span class="line"></span><br><span class="line"># chdir  先切换工作目录，再执行后面的命令，一般情况下在编译时候使用</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'chdir=/tmp pwd'</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | CHANGED | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">/tmp</span><br><span class="line"></span><br><span class="line"># creates  如果creates的文件存在，则执行后面的操作</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'creates=/tmp ls /etc/passwd'    #tmp目录存在，则不执行后面的ls命令</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">skipped, since /tmp exists</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'creates=/tmp11 ls /etc/passwd'    # tmp11文件不存在，则执行后面的ls命令</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | CHANGED | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">/etc/passwd</span><br><span class="line"></span><br><span class="line"># removes  和creates相反，如果removes的文件存在，才执行后面的操作</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'removes=/tmp ls /etc/passwd'    #tmp文件存在，则执行了后面的ls命令</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | CHANGED | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">/etc/passwd</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -a 'removes=/tmp11 ls /etc/passwd'  #tmp11文件不存在，则没有执行后面的ls命令</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">skipped, since /tmp11 does not exist</span><br></pre></td></tr></table></figure><h4 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h4><blockquote><p>专门用来执行<code>shell</code>命令的模块，和<code>command</code>模块一样，参数基本一样，都有<code>chdir,creates,removes</code>等参数</p></blockquote><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 查看模块参数</span><br><span class="line">[root@ansible ~]# ansible-doc -s shell</span><br><span class="line"></span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -m shell -a 'mkdir /tmp/test'</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -m shell -a 'ls /tmp' </span><br><span class="line"></span><br><span class="line">#执行下面这条命令，每次执行都会更新文件的时间戳</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -m shell -a 'cd /tmp/test &amp;&amp; <span class="section">touch</span> <span class="number">1.</span>txt &amp;&amp; ls' </span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | CHANGED | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line"><span class="number">1.</span>txt</span><br><span class="line"></span><br><span class="line"># 由于有时候不想更新文件的创建时间戳，则如果存在就不执行creates</span><br><span class="line">[root@ansible ~]# ansible <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> -m shell -a 'creates=/tmp/test/<span class="number">1.</span>txt cd /tmp/test &amp;&amp; <span class="section">touch</span> <span class="number">1.</span>txt &amp;&amp; ls'</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">skipped, since /tmp/test/<span class="number">1.</span>txt exists</span><br></pre></td></tr></table></figure><h4 id="script"><a href="#script" class="headerlink" title="script"></a>script</h4><blockquote><p>用于在被管理机器上面执行<code>shell</code>脚本的模块，脚本无需在被管理机器上面存在</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s script</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写shell脚本</span></span><br><span class="line">[root@ansible ~]<span class="comment"># vim ansible_test.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> `hostname`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在所有被管理机器上执行该脚本</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible all -m script -a '/root/ansible_test.sh'</span></span><br><span class="line">192.168.1.32 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"rc"</span>: 0, </span><br><span class="line">    <span class="string">"stderr"</span>: <span class="string">"Shared connection to 192.168.1.32 closed.\r\n"</span>, </span><br><span class="line">    <span class="string">"stderr_lines"</span>: [</span><br><span class="line">        <span class="string">"Shared connection to 192.168.1.32 closed."</span></span><br><span class="line">    ], </span><br><span class="line">    <span class="string">"stdout"</span>: <span class="string">"linux.node02.com\r\n"</span>, </span><br><span class="line">    <span class="string">"stdout_lines"</span>: [</span><br><span class="line">        <span class="string">"linux.node02.com"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h3 id="文件相关的模块"><a href="#文件相关的模块" class="headerlink" title="文件相关的模块"></a>文件相关的模块</h3><h4 id="file"><a href="#file" class="headerlink" title="file"></a>file</h4><blockquote><p>用于对文件的处理，创建，删除，权限控制等</p></blockquote><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s file</span></span><br><span class="line">path     <span class="comment">#要管理的文件路径</span></span><br><span class="line">recurse  <span class="comment">#递归</span></span><br><span class="line"><span class="keyword">state</span>：</span><br><span class="line">     directory  <span class="comment">#创建目录，如果目标不存在则创建目录及其子目录</span></span><br><span class="line">     touch      <span class="comment">#创建文件，如果文件存在，则修改文件 属性</span></span><br><span class="line">     </span><br><span class="line">     absent     <span class="comment">#删除文件或目录</span></span><br><span class="line">     mode       <span class="comment">#设置文件或目录权限</span></span><br><span class="line">     owner      <span class="comment">#设置文件或目录属主信息</span></span><br><span class="line">     group      <span class="comment">#设置文件或目录属组信息</span></span><br><span class="line">     <span class="keyword">link</span>       <span class="comment">#创建软连接，需要和src配合使用</span></span><br><span class="line">     hard       <span class="comment">#创建硬连接，需要和src配合使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m file -a 'path=/tmp/test1 state=directory'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建文件</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=touch'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立软链接（src表示源文件，path表示目标文件）</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m file -a 'src=/tmp/test1 path=/tmp/test3 state=link'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除文件</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=absent'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建文件时同时设置权限等信息</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m file -a 'path=/tmp/test4 state=directory mode=775 owner=root group=root'</span></span><br></pre></td></tr></table></figure><h4 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h4><blockquote><p>用于管理端复制文件到远程主机，并可以设置权限，属组，属主等</p></blockquote><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s copy</span></span><br><span class="line">src      <span class="comment">#需要copy的文件的源路径</span></span><br><span class="line">dest     <span class="comment">#需要copy的文件的目标路径</span></span><br><span class="line">backup   <span class="comment">#对copy的文件进行备份</span></span><br><span class="line">content  <span class="comment">#直接在远程主机被管理文件中添加内容，会覆盖原文件内容</span></span><br><span class="line">mode     <span class="comment">#对copy到远端的文件设置权限</span></span><br><span class="line">owner    <span class="comment">#对copy到远端的文件设置属主</span></span><br><span class="line">group    <span class="comment">#对copy到远端文件设置属组</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件到远程主机并改名</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件到远程主机，并备份远程文件,安装时间信息备份文件（当更新文件内容后，重新copy时用到）</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh backup=yes'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接在远程主机a.sh中添加内容</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh content="#!/bin/bash\n echo `uptime`"'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件到远程主机，并设置权限及属主与属组</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/passwd src=/etc/passwd mode=700 owner=root group=root'</span></span><br></pre></td></tr></table></figure><h4 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h4><blockquote><p>用于从被管理机器上面拉取文件，拉取下来的内容会保留目录结构，一般情况用在收集被管理机器的日志文件等</p></blockquote><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s fetch</span></span><br><span class="line">src      <span class="comment">#指定需要从远端机器拉取的文件路径</span></span><br><span class="line">dest     <span class="comment">#指定从远端机器拉取下来的文件存放路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从被管理机器上拉取cron日志文件，默认会已管理节点地址创建一个目录，并存放在内</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m fetch -a 'dest=/tmp src=/var/log/cron'</span></span><br><span class="line"></span><br><span class="line">[root@ansible ~]<span class="comment"># tree /tmp/192.168.1.31/</span></span><br><span class="line"><span class="regexp">/tmp/192.168.1.31/</span></span><br><span class="line">└── <span class="keyword">var</span></span><br><span class="line">    └── log</span><br><span class="line">        └── cron</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> directories, <span class="number">1</span> file</span><br></pre></td></tr></table></figure><h3 id="用户相关的模块"><a href="#用户相关的模块" class="headerlink" title="用户相关的模块"></a>用户相关的模块</h3><h4 id="user"><a href="#user" class="headerlink" title="user"></a>user</h4><blockquote><p>用于对系统用户的管理，用户的创建、删除、家目录、属组等设置</p></blockquote><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s user</span></span><br><span class="line">name        <span class="comment">#指定用户的名字</span></span><br><span class="line">home        <span class="comment">#指定用户的家目录</span></span><br><span class="line">uid         <span class="comment">#指定用户的uid</span></span><br><span class="line">group       <span class="comment">#指定用户的用户组</span></span><br><span class="line">groups      <span class="comment">#指定用户的附加组</span></span><br><span class="line">password    <span class="comment">#指定用户的密码</span></span><br><span class="line">shell       <span class="comment">#指定用户的登录shell</span></span><br><span class="line">create_home <span class="comment">#是否创建用户家目录，默认是yes</span></span><br><span class="line">remove      <span class="comment">#删除用户时，指定是否删除家目录</span></span><br><span class="line">state：</span><br><span class="line">      absent    <span class="comment">#删除用户</span></span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户名指定家目录，指定uid及组</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m user -a 'name=mysql home=/opt/mysql uid=1002 group=root'</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m shell  -a 'id mysql &amp;&amp; ls -l /opt'</span></span><br><span class="line"><span class="meta">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line">uid=<span class="number">1002</span>(mysql) gid=<span class="number">0</span>(root) 组=<span class="number">0</span>(root)</span><br><span class="line">总用量 <span class="number">0</span></span><br><span class="line">drwx------  <span class="number">3</span> mysql root <span class="number">78</span> <span class="number">5</span>月  <span class="number">27</span> <span class="number">18</span><span class="symbol">:</span><span class="number">13</span> mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户，不创建家目录，并且不能登录</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m user -a 'name=apache shell=/bin/nologin uid=1003 create_home=no'</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m shell  -a 'id apache &amp;&amp; tail -1 /etc/passwd'</span></span><br><span class="line"><span class="meta">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line">uid=<span class="number">1003</span>(apache) gid=<span class="number">1003</span>(apache) 组=<span class="number">1003</span>(apache)</span><br><span class="line"><span class="symbol">apache:</span><span class="symbol">x:</span><span class="number">1003</span><span class="symbol">:</span><span class="number">1003</span><span class="symbol">:</span><span class="symbol">:/home/apache</span><span class="symbol">:/bin/nologin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除用户</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m user -a 'name=apache state=absent'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除用户并删除家目录</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m user -a 'name=mysql state=absent remove=yes'</span></span><br></pre></td></tr></table></figure><h4 id="group"><a href="#group" class="headerlink" title="group"></a>group</h4><blockquote><p>用于创建组，当创建用户时如果需要指定组，组不存在的话就可以通过<code>group</code>先创建组</p></blockquote><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s group</span></span><br><span class="line">name     <span class="comment">#指定组的名字</span></span><br><span class="line">gid      <span class="comment">#指定组的gid</span></span><br><span class="line"><span class="keyword">state</span>：</span><br><span class="line">     absent   <span class="comment">#删除组</span></span><br><span class="line">     present  <span class="comment">#创建组（默认的状态）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建组</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m group -a 'name=www'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建组并指定gid</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m group -a 'name=www1 gid=1005'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除组</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m group -a 'name=www1 state=absent'</span></span><br></pre></td></tr></table></figure><h3 id="软件包相关的模块"><a href="#软件包相关的模块" class="headerlink" title="软件包相关的模块"></a>软件包相关的模块</h3><h4 id="yum"><a href="#yum" class="headerlink" title="yum"></a>yum</h4><blockquote><p>用于对软件包的管理，下载、安装、卸载、升级等操作</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 查看模块参数</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible-doc -s yum</span></span><br><span class="line">name            <span class="meta">#指定要操作的软件包名字</span></span><br><span class="line">download_dir    <span class="meta">#指定下载软件包的存放路径，需要配合download_only一起使用</span></span><br><span class="line">download_only   <span class="meta">#只下载软件包，而不进行安装，和yum --downloadonly一样</span></span><br><span class="line">list:</span><br><span class="line">    installed   <span class="meta">#列出所有已安装的软件包</span></span><br><span class="line">    updates     <span class="meta">#列出所有可以更新的软件包</span></span><br><span class="line">    repos       <span class="meta">#列出所有的yum仓库</span></span><br><span class="line">state:   </span><br><span class="line">    installed, present   <span class="meta">#安装软件包(两者任选其一都可以)</span></span><br><span class="line">    removed, absent      <span class="meta">#卸载软件包</span></span><br><span class="line">    latest      <span class="meta">#安装最新软件包</span></span><br><span class="line">    </span><br><span class="line"><span class="meta"># 列出所有已安装的软件包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'list=installed'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 列出所有可更新的软件包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'list=updates'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#列出所有的yum仓库</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'list=repos'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#只下载软件包并到指定目录下</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'name=httpd download_only=yes download_dir=/tmp'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#安装软件包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'name=httpd state=installed'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#卸载软件包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'name=httpd state=removed'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#安装包组，类似yum groupinstall <span class="string">'Development Tools'</span></span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'name="@Development Tools" state=installed'</span></span></span><br></pre></td></tr></table></figure><h4 id="pip"><a href="#pip" class="headerlink" title="pip"></a>pip</h4><blockquote><p>用于安装python中的包</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 查看模块参数</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible-doc -s pip</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 使用pip时，需要保证被管理机器上有python-pip软件包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m yum -a <span class="string">'name=python-pip'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 安装pip包</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m pip -a <span class="string">'name=flask'</span></span></span><br></pre></td></tr></table></figure><h4 id="service"><a href="#service" class="headerlink" title="service"></a>service</h4><blockquote><p>服务模块，用于对服务进行管理，服务的启动、关闭、开机自启等</p></blockquote><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s service</span></span><br><span class="line">name       <span class="comment">#指定需要管理的服务名</span></span><br><span class="line">enabled    <span class="comment">#指定是否开机自启动</span></span><br><span class="line"><span class="keyword">state</span>:     <span class="comment">#指定服务状态</span></span><br><span class="line">    started    <span class="comment">#启动服务</span></span><br><span class="line">    stopped    <span class="comment">#停止服务</span></span><br><span class="line">    restarted  <span class="comment">#重启服务</span></span><br><span class="line">    reloaded   <span class="comment">#重载服务</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务，并设置开机自启动 </span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m service -a 'name=crond state=started enabled=yes'</span></span><br></pre></td></tr></table></figure><h3 id="计划任务相关的模块"><a href="#计划任务相关的模块" class="headerlink" title="计划任务相关的模块"></a>计划任务相关的模块</h3><h4 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h4><blockquote><p>用于指定计划任务，和<code>crontab -e</code>一样</p></blockquote><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块参数</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible-doc -s cron</span></span><br><span class="line">job     <span class="comment">#指定需要执行的任务</span></span><br><span class="line">minute   <span class="comment">#分钟</span></span><br><span class="line">hour     <span class="comment">#小时</span></span><br><span class="line">day      <span class="comment">#天</span></span><br><span class="line">month    <span class="comment">#月</span></span><br><span class="line">weekday  <span class="comment">#周</span></span><br><span class="line">name     <span class="comment">#对计划任务进行描述</span></span><br><span class="line"><span class="symbol">state:</span></span><br><span class="line">    absetn   <span class="comment">#删除计划任务</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个计划任务，并描述是干嘛用的</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m cron -a "name='这是一个测试的计划任务' minute=* hour=* day=* month=* weekday=* job='/bin/bash /root/test.sh'"</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m shell -a 'crontab -l'</span></span><br><span class="line"><span class="meta">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="comment">#Ansible: 这是一个测试的计划任务</span></span><br><span class="line">* * * * * <span class="regexp">/bin/bash</span> /root/test.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个没有带描述的计划任务</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m cron -a "job='/bin/sh /root/test.sh'"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除计划任务</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 192.168.1.31 -m cron -a "name='None' job='/bin/sh /root/test.sh' state=absent"</span></span><br></pre></td></tr></table></figure><h3 id="系统信息相关的模块"><a href="#系统信息相关的模块" class="headerlink" title="系统信息相关的模块"></a>系统信息相关的模块</h3><h4 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h4><blockquote><p>用于获取系统信息的一个模块</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 查看模块参数</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible-doc -s setup</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看系统所有信息</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m setup</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># filter 对系统信息进行过滤</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible 192.168.1.31 -m setup -a <span class="string">'filter=ansible_all_ipv4_addresses'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 常用的过滤选项</span></span><br><span class="line">ansible_all_ipv4_addresses         所有的ipv4地址</span><br><span class="line">ansible_all_ipv6_addresses         所有的ipv6地址</span><br><span class="line">ansible_architecture               系统的架构</span><br><span class="line">ansible_date_time                  系统时间</span><br><span class="line">ansible_default_ipv4               系统的默认ipv4地址</span><br><span class="line">ansible_distribution               系统名称</span><br><span class="line">ansible_distribution_file_variety  系统的家族</span><br><span class="line">ansible_distribution_major_version 系统的版本</span><br><span class="line">ansible_domain                     系统所在的域</span><br><span class="line">ansible_fqdn                       系统的主机名</span><br><span class="line">ansible_hostname                   系统的主机名,简写</span><br><span class="line">ansible_os_family                  系统的家族</span><br><span class="line">ansible_processor_cores            cpu的核数</span><br><span class="line">ansible_processor_count            cpu的颗数</span><br><span class="line">ansible_processor_vcpus            cpu的个数</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Ansible-Ad-hoc模式常用模块&quot;&gt;&lt;a href=&quot;#Ansible-Ad-hoc模式常用模块&quot; class=&quot;headerlink&quot; title=&quot;Ansible Ad-hoc模式常用模块&quot;&gt;&lt;/a&gt;Ansible Ad-hoc模式常用模块&lt;/h2&gt;&lt;
      
    
    </summary>
    
      <category term="Ansible" scheme="https://leeyj.coding.me/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://leeyj.coding.me/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible快速入门</title>
    <link href="https://leeyj.coding.me/2019/05/26/Ansible%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>https://leeyj.coding.me/2019/05/26/Ansible快速入门/</id>
    <published>2019-05-26T14:35:22.000Z</published>
    <updated>2019-07-10T01:46:29.899Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote><p><code>Ansible</code>是一款简单的运维自动化工具，只需要使用<code>ssh</code>协议连接就可以来进行系统管理，自动化执行命令，部署等任务。</p></blockquote><p><strong>Ansible的特点</strong></p><blockquote><p>1、ansible不需要单独安装客户端，也不需要启动任何服务<br>2、ansible是python中的一套完整的自动化执行任务模块<br>3、ansible playbook 采用yaml配置，对于自动化任务执行过一目了然</p></blockquote><p><strong>Ansible组成结构</strong></p><ul><li>Ansible<br>是<code>Ansible</code>的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。</li><li>Ansible Playbook<br>任务剧本（又称任务集），编排定义<code>Ansible</code>任务集的配置文件，由<code>Ansible</code>顺序依次执行，<code>yaml</code>格式。</li><li>Inventory<br><code>Ansible</code>管理主机的清单，默认是<code>/etc/ansible/hosts</code>文件。</li><li>Modules<br><code>Ansible</code>执行命令的功能模块，<code>Ansible2.3</code>版本为止，共有<code>1039</code>个模块。还可以自定义模块。</li><li>Plugins<br>插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。</li><li>API<br>提供给第三方程序调用的应用程序编程接口。</li></ul><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><table><thead><tr><th style="text-align:center">IP</th><th style="text-align:center">系统</th><th style="text-align:center">主机名</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">192.168.1.30</td><td style="text-align:center">CentOS7</td><td style="text-align:center">ansible</td><td style="text-align:center">ansible管理节点</td></tr><tr><td style="text-align:center">192.168.1.31</td><td style="text-align:center">CentOS7</td><td style="text-align:center">linux.node01.com</td><td style="text-align:center">被管理节点1</td></tr><tr><td style="text-align:center">192.168.1.32</td><td style="text-align:center">CentOS7</td><td style="text-align:center">linux.node02.com</td><td style="text-align:center">被管理节点2</td></tr><tr><td style="text-align:center">192.168.1.33</td><td style="text-align:center">CentOS7</td><td style="text-align:center">linux.node03.com</td><td style="text-align:center">被管理节点3</td></tr><tr><td style="text-align:center">192.168.1.36</td><td style="text-align:center">CentOS6</td><td style="text-align:center">linux.node06.com</td><td style="text-align:center">被管理节点6</td></tr></tbody></table><h2 id="Ansible安装"><a href="#Ansible安装" class="headerlink" title="Ansible安装"></a>Ansible安装</h2><p>1）配置<code>epel</code>源<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># yum clean all</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># yum makecache</span></span><br></pre></td></tr></table></figure></p><p>2）安装<code>ansible</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># yum -y install ansible</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ansible版本</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible --version</span></span><br><span class="line">ansible <span class="number">2.8</span><span class="number">.0</span></span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [<span class="string">u'/root/.ansible/plugins/modules'</span>, <span class="string">u'/usr/share/ansible/plugins/modules'</span>]</span><br><span class="line">  ansible python module location = /usr/lib/python2<span class="number">.7</span>/site-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = <span class="number">2.7</span><span class="number">.5</span> (default, Aug  <span class="number">4</span> <span class="number">2017</span>, <span class="number">00</span>:<span class="number">39</span>:<span class="number">18</span>) [GCC <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-16</span>)]</span><br></pre></td></tr></table></figure></p><h2 id="Ansible-Inventory文件"><a href="#Ansible-Inventory文件" class="headerlink" title="Ansible Inventory文件"></a>Ansible Inventory文件</h2><p><a href="http://www.ansible.com.cn/docs/intro_inventory.html" target="_blank" rel="noopener">Inventory中文文档</a></p><blockquote><p><code>Inventory</code>文件通常用于定义要管理的主机的认证信息，例如<code>ssh</code>登录用户名、密码以及<code>key</code>相关信息。可以同时操作一个组的多台主机，组与主机组之间的关系都是通过<code>inventory</code>文件配置。配置文件路径为：<code>/etc/ansible/hosts</code></p></blockquote><h3 id="基于密码连接"><a href="#基于密码连接" class="headerlink" title="基于密码连接"></a>基于密码连接</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class="line"><span class="comment"># 方法一 主机+端口+密码</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.31 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line">192.168.1.32 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line">192.168.1.33 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line">192.168.1.36 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二 主机+端口+密码</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.3[1:3] <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二 主机+端口+密码</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.3[1:3]</span><br><span class="line">[webserver:vars]</span><br><span class="line"><span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br></pre></td></tr></table></figure><h3 id="基于秘钥连接"><a href="#基于秘钥连接" class="headerlink" title="基于秘钥连接"></a>基于秘钥连接</h3><blockquote><p>基于秘钥连接需要先创建公钥和私钥，并发送给被管理机器</p></blockquote><p>1）生成公私钥<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# ssh-keygen</span><br><span class="line">[root@ansible ~]# for i in &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>&#125;; do ssh-copy-id -i <span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span>$i ; done</span><br></pre></td></tr></table></figure></p><p>2）配置连接<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class="line"><span class="comment"># 方法一 主机+端口+密钥</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.31:22</span><br><span class="line">192.168.1.32</span><br><span class="line">192.168.1.33</span><br><span class="line">192.168.1.36</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法一 别名主机+端口+密钥</span></span><br><span class="line">[webserver]</span><br><span class="line">node1 <span class="attribute">ansible_ssh_host</span>=192.168.1.31 <span class="attribute">ansible_ssh_port</span>=22</span><br><span class="line">node2 <span class="attribute">ansible_ssh_host</span>=192.168.1.32 <span class="attribute">ansible_ssh_port</span>=22</span><br><span class="line">node3 <span class="attribute">ansible_ssh_host</span>=192.168.1.33 <span class="attribute">ansible_ssh_port</span>=22</span><br><span class="line">node6 <span class="attribute">ansible_ssh_host</span>=192.168.1.36 <span class="attribute">ansible_ssh_port</span>=22</span><br></pre></td></tr></table></figure></p><h3 id="主机组的使用"><a href="#主机组的使用" class="headerlink" title="主机组的使用"></a>主机组的使用</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 主机组变量名+主机+密码</span></span><br><span class="line">[<span class="meta">apache</span>]</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.36</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span></span><br><span class="line">[<span class="meta">apache.vars</span>]</span><br><span class="line">ansible_ssh_pass=<span class="string">'123456'</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 主机组变量名+主机+密钥</span></span><br><span class="line">[<span class="meta">nginx</span>]</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span>[<span class="number">1</span>:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta"># 定义多个组，把一个组当另外一个组的组员</span></span><br><span class="line">[<span class="meta">webserver:children</span>]  <span class="meta">#webserver组包括两个子组：apache nginx</span></span><br><span class="line">apache</span><br><span class="line">nginx</span><br></pre></td></tr></table></figure><h3 id="临时指定inventory"><a href="#临时指定inventory" class="headerlink" title="临时指定inventory"></a>临时指定inventory</h3><p>1）先编辑一个主机定义清单<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# vim /etc/dockers</span><br><span class="line">[dockers]</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> ansible_ssh_pass='<span class="number">123456</span>'</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span></span><br></pre></td></tr></table></figure></p><p>2）在执行命令是指定<code>inventory</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# ansible dockers -m<span class="built_in"> ping </span>-i /etc/dockers -o </span><br><span class="line">192.168.1.33 | SUCCESS =&gt; &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: <span class="literal">false</span>, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line">192.168.1.32 | SUCCESS =&gt; &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: <span class="literal">false</span>, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line">192.168.1.31 | SUCCESS =&gt; &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: <span class="literal">false</span>, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br></pre></td></tr></table></figure></p><h3 id="Inventory内置参数"><a href="#Inventory内置参数" class="headerlink" title="Inventory内置参数"></a>Inventory内置参数</h3><p><img src="/2019/05/26/Ansible快速入门/ansible01.png" alt="ansible inventory内置参数"></p><h2 id="Ansible-Ad-Hoc"><a href="#Ansible-Ad-Hoc" class="headerlink" title="Ansible Ad-Hoc"></a>Ansible Ad-Hoc</h2><p><a href="http://www.ansible.com.cn/docs/intro_adhoc.html" target="_blank" rel="noopener">Ad-Hoc中文文档</a></p><blockquote><p>ad hoc —— 临时的，在<code>ansible</code>中是指需要快速执行，并且不需要保存的命令。说白了就是执行简单的命令——一条命令。对于复杂的命令则为<code>playbook</code>，类似于<code>saltstack</code>的<code>state sls</code>状态文件。</p></blockquote><h3 id="ansible命令格式"><a href="#ansible命令格式" class="headerlink" title="ansible命令格式"></a>ansible命令格式</h3><p>1）常用命令参数<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# ansible -h</span><br><span class="line">Usage: ansible &lt;host-pattern&gt; [options]</span><br><span class="line">-<span class="ruby">a MODULE_ARGS   <span class="comment">#模块参数</span></span></span><br><span class="line"><span class="ruby">-C, --check  <span class="comment">#检查语法</span></span></span><br><span class="line"><span class="ruby">-f FORKS <span class="comment">#并发</span></span></span><br><span class="line"><span class="ruby">--list-hosts <span class="comment">#列出主机列表</span></span></span><br><span class="line"><span class="ruby">-m MODULE_NAME <span class="comment">#模块名字</span></span></span><br><span class="line"><span class="ruby">-o 使用精简的输出</span></span><br></pre></td></tr></table></figure></p><p>2）示例<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@ansible</span> ~]<span class="comment"># ansible webserver -m shell -a 'uptime' -o</span></span><br><span class="line">192.168.1.36 |<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  13:46:14 up 1 day,  9:20,  4 users,  load average: 0.00, 0.00, 0.00</span></span><br><span class="line"><span class="string">192.168.1.33 </span>|<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  21:26:33 up 1 day,  8:51,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class="line"><span class="string">192.168.1.31 </span>|<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  21:26:33 up 1 day,  8:50,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class="line"><span class="string">192.168.1.32 </span>|<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  21:26:33 up 1 day,  8:59,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br></pre></td></tr></table></figure></p><p>3）命令说明<br><img src="/2019/05/26/Ansible快速入门/ansible02.png" alt="ansible command"></p><h3 id="host-pattern格式"><a href="#host-pattern格式" class="headerlink" title="host-pattern格式"></a>host-pattern格式</h3><p>目标<code>target</code>主机，主机组匹配方式</p><h4 id="主机的匹配"><a href="#主机的匹配" class="headerlink" title="主机的匹配"></a>主机的匹配</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  一台目标主机</span></span><br><span class="line">[root@ansible ~]# ansible 192.168.1.31 -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多台目标主机</span></span><br><span class="line">[root@ansible ~]# ansible 192.168.1.31,192.168.1.32 -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有目标主机</span></span><br><span class="line">[root@ansible ~]# ansible all -m ping</span><br></pre></td></tr></table></figure><h4 id="组的匹配"><a href="#组的匹配" class="headerlink" title="组的匹配"></a>组的匹配</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 组的配置信息如下：这里定义了一个nginx组和一个apache组</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible nginx --list</span></span><br><span class="line">  hosts (<span class="number">2</span>)<span class="symbol">:</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.31</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.32</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible apache --list</span></span><br><span class="line">  hosts (<span class="number">3</span>)<span class="symbol">:</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.36</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.33</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.32</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一个组的所有主机匹配</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible apache -m ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配apache组中有，但是nginx组中没有的所有主机</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 'apache:!nginx' -m ping -o</span></span><br><span class="line"><span class="meta">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配apache组和nginx组中都有的机器（并集）</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 'apache:&amp;nginx' -m ping -o</span></span><br><span class="line"><span class="meta">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配apache组nginx组两个组所有的机器（并集）；等于ansible apache,nginx -m ping</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 'apache:nginx' -m ping -o</span></span><br><span class="line"><span class="meta">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.31 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;Ansible&lt;/code&gt;是一款简单的运维自动化工具，只需要使用&lt;code&gt;ssh&lt;/code&gt;协议
      
    
    </summary>
    
      <category term="Ansible" scheme="https://leeyj.coding.me/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://leeyj.coding.me/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>linux保存history到日志文件</title>
    <link href="https://leeyj.coding.me/2019/05/22/linux%E4%BF%9D%E5%AD%98history%E5%88%B0%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6/"/>
    <id>https://leeyj.coding.me/2019/05/22/linux保存history到日志文件/</id>
    <published>2019-05-22T08:30:09.000Z</published>
    <updated>2019-05-22T13:07:59.030Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑<code>/etc/bashrc</code>文件记录历史命令到日志文件下面，并已登录来源<code>IP</code>，登录用户名，登录时间命名日志文件名字</p></blockquote><h5 id="查看默认的history"><a href="#查看默认的history" class="headerlink" title="查看默认的history"></a>查看默认的history</h5><p><img src="https://upload-images.jianshu.io/upload_images/11763553-a2f73d6c0783224d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="默认的history"></p><h5 id="编辑-etc-bashrc"><a href="#编辑-etc-bashrc" class="headerlink" title="编辑/etc/bashrc"></a>编辑/etc/bashrc</h5><p>编辑<code>/etc/bashrc</code>文件，加入以下内容，也可以放在<code>/etc/profile</code>文件里<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/bashrc</span></span><br><span class="line">USER_IP=$(<span class="built_in">echo</span> -e <span class="string">"\033[31m\033[1m`who -u am i 2&gt;/dev/null| awk '&#123;print <span class="variable">$NF</span>&#125;'|sed -e 's/[()]//g'`\033[0m"</span>)</span><br><span class="line">IP=$(who -u am i 2&gt;/dev/null| awk <span class="string">'&#123;print $NF&#125;'</span>|sed -e <span class="string">'s/[()]//g'</span>)</span><br><span class="line">USER=$(whoami)</span><br><span class="line">USER_NAME=`<span class="built_in">echo</span> -e <span class="string">"\033[36m\033[1m<span class="variable">$(whoami)</span> \033[0m"</span>`</span><br><span class="line">HISTFILESIZE=100000</span><br><span class="line">HISTSIZE=4096</span><br><span class="line">HISTTIMEFORMAT=<span class="string">"%F %T  <span class="variable">$USER_IP</span>  <span class="variable">$USER_NAME</span>  "</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$USER_IP</span>"</span> = <span class="string">""</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   USER_IP=`hostname`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d /var/<span class="built_in">log</span>/<span class="built_in">history</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   mkdir /var/<span class="built_in">log</span>/<span class="built_in">history</span></span><br><span class="line">   chmod 777 /var/<span class="built_in">log</span>/<span class="built_in">history</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    mkdir /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span></span><br><span class="line">    chmod 300 /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">DT=`date <span class="string">"+%Y%m%d_%H%M"</span>`</span><br><span class="line"><span class="built_in">export</span> HISTFILE=<span class="string">"/var/log/history/<span class="variable">$&#123;LOGNAME&#125;</span>/<span class="variable">$&#123;DT&#125;</span>_<span class="variable">$&#123;USER&#125;</span>_<span class="variable">$&#123;IP&#125;</span>"</span></span><br><span class="line">chmod 600 /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span>/* 2&gt;/dev/null</span><br></pre></td></tr></table></figure></p><p>退出重新登录再次查看<br><img src="https://upload-images.jianshu.io/upload_images/11763553-dad4faed53395912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>查看前面保留的历史记录日志<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# <span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/</span><br><span class="line">总用量 <span class="number">0</span></span><br><span class="line">d-wx------. <span class="number">2</span> root root <span class="number">6</span> <span class="number">5</span>月  <span class="number">22</span> <span class="number">14</span>:<span class="number">27</span> root</span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# <span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/root/</span><br><span class="line">总用量 <span class="number">4</span></span><br><span class="line">-rw-------. <span class="number">1</span> root root <span class="number">123</span> <span class="number">5</span>月  <span class="number">22</span> <span class="number">14</span>:<span class="number">29</span> <span class="number">20190522</span>_1427_root_192.<span class="number">168.1</span>.<span class="number">123</span></span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/root/<span class="number">20190522</span>_1427_root_192.<span class="number">168.1</span>.<span class="number">123</span> </span><br><span class="line">#<span class="number">1558506461</span></span><br><span class="line"><span class="keyword">ls</span></span><br><span class="line">#<span class="number">1558506467</span></span><br><span class="line"><span class="keyword">history</span></span><br><span class="line">#<span class="number">1558506519</span></span><br><span class="line"><span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/</span><br><span class="line">#<span class="number">1558506571</span></span><br><span class="line"><span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/root/</span><br><span class="line">#<span class="number">1558506574</span></span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑&lt;code&gt;/etc/bashrc&lt;/code&gt;文件记录历史命令到日志文件下面，并已登录来源&lt;code&gt;IP&lt;/
      
    
    </summary>
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/categories/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/tags/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>saltstack项目实战</title>
    <link href="https://leeyj.coding.me/2019/05/21/saltstack%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/"/>
    <id>https://leeyj.coding.me/2019/05/21/saltstack项目实战/</id>
    <published>2019-05-21T07:43:05.000Z</published>
    <updated>2019-05-28T14:26:57.451Z</updated>
    
    <content type="html"><![CDATA[<h2 id="项目架构规划"><a href="#项目架构规划" class="headerlink" title="项目架构规划"></a>项目架构规划</h2><blockquote><p>后端web服务器使用<code>Nginx+Php</code>作为站点，通过<code>HAproxy</code>做负载均衡，<code>Keepalived</code>做高可用</p></blockquote><p><img src="/2019/05/21/saltstack项目实战/01.png" alt="架构规划图"></p><h2 id="项目环境准备"><a href="#项目环境准备" class="headerlink" title="项目环境准备"></a>项目环境准备</h2><p><img src="/2019/05/21/saltstack项目实战/02.png" alt="环境准备"></p><p><strong>说明：</strong> 关闭防火墙、<code>selinux</code>、时间同步等<br><code>host</code>绑定<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /etc/hosts</span><br><span class="line"><span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>salt-master</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.31</span>salt-minion01</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.32</span>salt-minion02</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.33</span>salt-minion03</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.34</span>salt-minion04</span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# for i <span class="keyword">in</span> <span class="string">`seq 4`</span><span class="comment">; do scp /etc/hosts 192.168.1.3$i:/etc/hosts ; done</span></span><br></pre></td></tr></table></figure></p><h3 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h3><p><a href="https://www.cnblogs.com/yanjieli/p/10864648.html" target="_blank" rel="noopener">参考地址</a><br>1）<code>Master</code>上软件安装<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class="number">2</span>.el7.noarch.rpm</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# sed</span> -i <span class="string">"s/repo.saltstack.com/mirrors.aliyun.com\/saltstack/g"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> enable salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> <span class="literal">start</span> salt-<span class="literal">master</span></span><br></pre></td></tr></table></figure></p><p>2）<code>Minion</code>上软件安装并配置<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm</span></span><br><span class="line"><span class="meta"># yum -y install salt-minion</span></span><br><span class="line"><span class="meta"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class="line"><span class="meta"># sed -i '/#master: /c\master: salt-master' /etc/salt/minion</span></span><br><span class="line"><span class="meta"># systemctl enable salt-minion</span></span><br><span class="line"><span class="meta"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p><h3 id="Master上认证"><a href="#Master上认证" class="headerlink" title="Master上认证"></a>Master上认证</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -L </span><br><span class="line">Accepted Keys:</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">salt-minion02</span><br><span class="line">salt-minion03</span><br><span class="line">salt-minion04</span><br><span class="line">Rejected Keys:</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -A -y</span><br><span class="line">The following keys are going to be accepted:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">salt-minion02</span><br><span class="line">salt-minion03</span><br><span class="line">salt-minion04</span><br><span class="line">Key for minion salt-minion01 accepted.</span><br><span class="line">Key for minion salt-minion02 accepted.</span><br><span class="line">Key for minion salt-minion03 accepted.</span><br><span class="line">Key for minion salt-minion04 accepted.</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -L </span><br><span class="line">Accepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">salt-minion02</span><br><span class="line">salt-minion03</span><br><span class="line">salt-minion04</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">Rejected Keys:</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' test.ping</span><br><span class="line">salt-minion01:</span><br><span class="line">    <span class="literal">True</span></span><br><span class="line">salt-minion02:</span><br><span class="line">    <span class="literal">True</span></span><br><span class="line">salt-minion03:</span><br><span class="line">    <span class="literal">True</span></span><br><span class="line">salt-minion04:</span><br><span class="line">    <span class="literal">True</span></span><br></pre></td></tr></table></figure><h2 id="Master上state编写"><a href="#Master上state编写" class="headerlink" title="Master上state编写"></a>Master上state编写</h2><h3 id="state环境设置"><a href="#state环境设置" class="headerlink" title="state环境设置"></a>state环境设置</h3><blockquote><p>说明：该案例在<code>prod</code>环境下配置，在<code>prod</code>下面创建了一个<code>modules</code>的目录，所有的安装配置都放在这个目录下面了，里面分别又对应创建了对应的软件目录，每个软件目录下面的<code>files</code>目录用来存放的是软件包或者配置文件模板<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">file_roots:</span><br><span class="line">  base:</span><br><span class="line">    - /srv/salt/base</span><br><span class="line">  test:</span><br><span class="line">    - /srv/salt/test</span><br><span class="line">  prod:</span><br><span class="line">    - /srv/salt/prod</span><br><span class="line">  dev:</span><br><span class="line">    - /srv/salt/dev</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/&#123;base,test,prod,dev&#125;</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/prod/modules/&#123;nginx,php,mysql,haproxy,keepalived,lnmp&#125;/files</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> /srv/salt/prod/modules/user</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# tree</span> /srv/salt/prod/modules/</span><br><span class="line">/srv/salt/prod/modules/</span><br><span class="line">├── haproxy</span><br><span class="line">│   └── files</span><br><span class="line">├── keepalived</span><br><span class="line">│   └── files</span><br><span class="line">├── lnmp</span><br><span class="line">│   └── files</span><br><span class="line">├── mysql</span><br><span class="line">│   └── files</span><br><span class="line">├── nginx</span><br><span class="line">│   └── files</span><br><span class="line">├── php</span><br><span class="line">│   └── files</span><br><span class="line">└── user</span><br><span class="line"></span><br><span class="line"><span class="number">13</span> directories, <span class="number">0</span> files</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="sls文件编写"><a href="#sls文件编写" class="headerlink" title="sls文件编写"></a>sls文件编写</h3><h4 id="pkg基础包"><a href="#pkg基础包" class="headerlink" title="pkg基础包"></a>pkg基础包</h4><p>安装源码编译所需要用到的基础软件包<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /srv/salt/prod/modules/pkg.sls </span><br><span class="line">pkg-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    -<span class="ruby"> <span class="symbol">pkgs:</span></span></span><br><span class="line"><span class="ruby">      - gcc</span></span><br><span class="line"><span class="ruby">      - gcc-c++</span></span><br><span class="line"><span class="ruby">      - make</span></span><br><span class="line"><span class="ruby">      - autoconf</span></span><br><span class="line"><span class="ruby">      - glibc</span></span><br><span class="line"><span class="ruby">      - glibc-devel</span></span><br><span class="line"><span class="ruby">      - glib2</span></span><br><span class="line"><span class="ruby">      - glib2-devel</span></span><br><span class="line"><span class="ruby">      - pcre</span></span><br><span class="line"><span class="ruby">      - pcre-devel</span></span><br><span class="line"><span class="ruby">      - zlib</span></span><br><span class="line"><span class="ruby">      - zlib-devel</span></span><br><span class="line"><span class="ruby">      - openssl</span></span><br><span class="line"><span class="ruby">      - openssl-devel</span></span><br><span class="line"><span class="ruby">      - libpng</span></span><br><span class="line"><span class="ruby">      - libpng-devel</span></span><br><span class="line"><span class="ruby">      - freetype</span></span><br><span class="line"><span class="ruby">      - freetype-devel</span></span><br><span class="line"><span class="ruby">      - libxml2</span></span><br><span class="line"><span class="ruby">      - libxml2-devel</span></span><br><span class="line"><span class="ruby">      - bzip2</span></span><br><span class="line"><span class="ruby">      - bzip2-devel</span></span><br><span class="line"><span class="ruby">      - ncurses</span></span><br><span class="line"><span class="ruby">      - curl</span></span><br><span class="line"><span class="ruby">      - gdbm-devel</span></span><br><span class="line"><span class="ruby">      - libXpm-devel</span></span><br><span class="line"><span class="ruby">      - libX11-devel</span></span><br><span class="line"><span class="ruby">      - gd-devel</span></span><br><span class="line"><span class="ruby">      - gmp-devel</span></span><br><span class="line"><span class="ruby">      - readline-devel</span></span><br><span class="line"><span class="ruby">      - libxslt-devel</span></span><br><span class="line"><span class="ruby">      - expat-devel</span></span><br><span class="line"><span class="ruby">      - xmlrpc-c</span></span><br><span class="line"><span class="ruby">      - xmlrpc-c-devel</span></span><br></pre></td></tr></table></figure></p><h4 id="useradd"><a href="#useradd" class="headerlink" title="useradd"></a>useradd</h4><p>创建网站运行用户<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/modules/user/www.sls</span> </span><br><span class="line"><span class="attr">www-user-group:</span></span><br><span class="line">  <span class="string">group.present:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - gid:</span> <span class="number">2000</span></span><br><span class="line"></span><br><span class="line">  <span class="string">user.present:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - fullname:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - shell:</span> <span class="string">/sbin/nologin</span></span><br><span class="line"><span class="attr">    - uid:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">    - gid:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">id</span> <span class="string">www</span></span><br></pre></td></tr></table></figure></p><h4 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/nginx/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">nginx</span>]<span class="comment"># tree </span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── nginx-<span class="number">1.12</span>.<span class="number">2</span>.tar.gz</span><br><span class="line">│   ├── nginx-<span class="number">1.16</span>.<span class="number">0</span>.tar.gz</span><br><span class="line">│   ├── nginx.conf.template</span><br><span class="line">│   └── nginx.service.template</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">6</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master nginx]<span class="comment"># cat install.sls </span></span><br><span class="line">&#123;% <span class="keyword">set</span> nginx_<span class="keyword">version</span> = <span class="string">"1.16.0"</span>%&#125;</span><br><span class="line">include:</span><br><span class="line">  - modules.pkg</span><br><span class="line">  - modules.user.www</span><br><span class="line"></span><br><span class="line">nginx-install:</span><br><span class="line">  file.managed:</span><br><span class="line">    - name: <span class="string">/usr/local/src/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - source: salt:<span class="string">//modules/nginx/files/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - mode: 644</span><br><span class="line"></span><br><span class="line">  cmd.run:</span><br><span class="line">    - name: <span class="keyword">cd</span> <span class="string">/usr/local/src/</span> &amp;&amp; tar xf nginx-&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span> &amp;&amp; <span class="keyword">cd</span> nginx-&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; &amp;&amp; <span class="string">./configure</span> <span class="params">--prefix=/usr/local/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; <span class="params">--user=root</span> <span class="params">--group=root</span> <span class="params">--with-http_ssl_module</span> <span class="params">--with-stream</span> <span class="params">--with-http_stub_status_module</span> <span class="params">--with-file-aio</span> <span class="params">--with-http_gzip_static_module</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class="string">/usr/local/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; <span class="string">/usr/local/nginx</span></span><br><span class="line">    - unless: test -d <span class="string">/usr/local/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; &amp;&amp; test -L <span class="string">/usr/local/nginx</span></span><br><span class="line">    - require:</span><br><span class="line">      - file: nginx-install</span><br><span class="line">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">nginx]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入nginx安装sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.nginx.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#添加systemctl</span></span><br><span class="line"><span class="attr">nginx-init:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/lib/systemd/system/nginx.service</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/nginx/files/nginx.service.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">test</span> <span class="bullet">-f</span> <span class="string">/usr/lib/systemd/system/nginx.service</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">nginx-init</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件</span></span><br><span class="line"><span class="string">/usr/local/nginx/conf/nginx.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/nginx/files/nginx.conf.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动nginx</span></span><br><span class="line"><span class="attr">nginx-service:</span></span><br><span class="line">  <span class="string">file.directory:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/nginx/conf/conf.d</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">nginx-install</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - reload:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">nginx-init</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">/usr/local/nginx/conf/nginx.conf</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">nginx-service</span></span><br></pre></td></tr></table></figure></p><h4 id="php"><a href="#php" class="headerlink" title="php"></a>php</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/php/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">php</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── php-<span class="number">5.6</span>.<span class="number">40</span>.tar.gz</span><br><span class="line">│   ├── php-fpm.conf.template</span><br><span class="line">│   ├── php-fpm.service.template</span><br><span class="line">│   ├── php-fpm.template</span><br><span class="line">│   └── php.ini.template</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">7</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master php]<span class="comment"># cat install.sls </span></span><br><span class="line">&#123;% <span class="keyword">set</span> php_<span class="keyword">version</span> = <span class="string">"5.6.40"</span> %&#125;</span><br><span class="line">include:</span><br><span class="line">  - modules.pkg</span><br><span class="line"></span><br><span class="line">php-install:</span><br><span class="line">  file.managed:</span><br><span class="line">    - name: <span class="string">/usr/local/src/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - source: salt:<span class="string">//modules/php/files/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - mode: 644</span><br><span class="line"></span><br><span class="line">  cmd.run:</span><br><span class="line">    - name: <span class="keyword">cd</span> <span class="string">/usr/local/src/</span> &amp;&amp; tar xf php-&#123;&#123; php_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span> &amp;&amp; <span class="keyword">cd</span> php-&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; &amp;&amp; <span class="string">./configure</span> <span class="params">--prefix=/usr/local/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; <span class="params">--with-curl</span> <span class="params">--with-freetype-dir</span> <span class="params">--with-gd</span> <span class="params">--with-gettext</span> <span class="params">--with-iconv-dir</span> <span class="params">--with-jpeg-dir</span> <span class="params">--with-kerberos</span> <span class="params">--with-libdir=lib64</span> <span class="params">--with-libxml-dir</span> <span class="params">--with-mysql</span> <span class="params">--with-mysqli</span> <span class="params">--with-openssl</span> <span class="params">--with-pcre-regex</span> <span class="params">--with-pdo-mysql</span> <span class="params">--with-dpo-sqlite</span> <span class="params">--with-pear</span> <span class="params">--with-png-dir</span> <span class="params">--with-openssl</span> <span class="params">--with-xmlrpc</span> <span class="params">--with-xsl</span> <span class="params">--with-zlib</span> <span class="params">--enable-fpm</span> <span class="params">--enable-bcmath</span> <span class="params">--enable-libxml</span> <span class="params">--enable-inline-optimization</span> <span class="params">--enable-gd-native-ttf</span> <span class="params">--enable-mbregex</span> <span class="params">--enable-mbstring</span> <span class="params">--enable-opcache</span> <span class="params">--enable-pcntl</span> <span class="params">--enable-shmop</span> <span class="params">--enable-soap</span> <span class="params">--enable-sockets</span> <span class="params">--enable-sysvsem</span> <span class="params">--enable-xml</span> <span class="params">--enable-zip</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class="string">/usr/local/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; <span class="string">/usr/local/php</span></span><br><span class="line">    - unless: test -d <span class="string">/usr/local/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; &amp;&amp; test -L <span class="string">/usr/local/php</span></span><br><span class="line">    - require:</span><br><span class="line">      - file: php-install</span><br><span class="line">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">php]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入php安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.php.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#php-ini配置文件配置</span></span><br><span class="line"><span class="attr">php-ini:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/php/etc/php.ini</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php.ini.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ln</span> <span class="bullet">-s</span> <span class="string">/usr/local/php/etc/php.ini</span> <span class="string">/etc/php.ini</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">test</span> <span class="bullet">-L</span> <span class="string">/etc/php.ini</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-ini</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#php-fpm配置文件配置</span></span><br><span class="line"><span class="attr">php-fpm:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/php/etc/php-fpm.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php-fpm.conf.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ln</span> <span class="bullet">-s</span> <span class="string">/usr/local/php/etc/php-fpm.conf</span> <span class="string">/etc/php-fpm.conf</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">test</span> <span class="bullet">-L</span> <span class="string">/etc/php-fpm.conf</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-fpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#加入system启动</span></span><br><span class="line"><span class="attr">php-systemd:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/lib/systemd/system/php-fpm.service</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php-fpm.service.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#加入/etc/init.d/启动</span></span><br><span class="line"><span class="attr">php-init:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/init.d/php-fpm</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php-fpm.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动php-fpm</span></span><br><span class="line"><span class="attr">php-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-systemd</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-ini</span></span><br></pre></td></tr></table></figure></p><h4 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h4><p>1）配置文件模板准备<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/mysql/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">mysql</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   └── my.cnf</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">mysql</span>]<span class="comment"># cat install.sls </span></span><br><span class="line">mariadb-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - pkgs:</span><br><span class="line">      - mariadb-server</span><br><span class="line">      - mariadb</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">mysql]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入mysql安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.mysql.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#my.cnf配置文件</span></span><br><span class="line"><span class="attr">mariadb-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/my.cnf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/mysql/files/my.cnf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">mariadb-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动mariadb</span></span><br><span class="line"><span class="attr">mariadb-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">mariadb</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">mariadb-config</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">mariadb-install</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">mariadb-config</span></span><br></pre></td></tr></table></figure></p><h4 id="lnmp"><a href="#lnmp" class="headerlink" title="lnmp"></a>lnmp</h4><p>1）准备测试文件<code>php info</code> 和<code>nginx</code>虚拟主机配置文件<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/lnmp/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">lnmp</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── index.php</span><br><span class="line">│   └── www.conf</span><br><span class="line">└── www.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>www.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">lnmp]#</span> <span class="string">cat</span> <span class="string">www.sls</span> </span><br><span class="line"><span class="comment">#引入nginx、php、mysql的安装</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.nginx.service</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.php.service</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.mysql.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#虚拟主机web站点目录创建</span></span><br><span class="line"><span class="attr">web-www:</span></span><br><span class="line">  <span class="string">file.directory:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/opt/www</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#虚拟主机配置文件配置</span></span><br><span class="line"><span class="attr">web-www-conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/nginx/conf/conf.d/www.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/lnmp/files/www.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">web-www</span></span><br><span class="line"><span class="attr">    - watch_in:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="attr">      PORT:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      IPADDR:</span> <span class="string">&#123;&#123;</span> <span class="string">grains['fqdn_ip4'][0]</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#phpinfo测试文件准备</span></span><br><span class="line"><span class="attr">web-index:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/opt/www/index.php</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/lnmp/files/index.php</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br></pre></td></tr></table></figure></p><h4 id="测试lnmp是否OK"><a href="#测试lnmp是否OK" class="headerlink" title="测试lnmp是否OK"></a>测试lnmp是否OK</h4><p>1）<code>Top file</code>编写<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/top.sls </span><br><span class="line">prod:</span><br><span class="line">  <span class="string">"salt-minion0[3-4]"</span>:</span><br><span class="line">    - modules.lnmp.www</span><br></pre></td></tr></table></figure></p><p>2）执行高级状态<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><p>3）访问测试<br><img src="/2019/05/21/saltstack项目实战/03.png" alt="http://192.168.1.31"><br><img src="/2019/05/21/saltstack项目实战/04.png" alt="http://192.168.1.32"></p><h4 id="haproxy"><a href="#haproxy" class="headerlink" title="haproxy"></a>haproxy</h4><p>1）配置文件准备<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/haproxy/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">haproxy</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   └── haproxy.cfg</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">haproxy</span>]<span class="comment"># cat install.sls </span></span><br><span class="line">haproxy-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - name: haproxy</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">haproxy]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入haproxy安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.haproxy.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件</span></span><br><span class="line"><span class="attr">haproxy-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/haproxy/files/haproxy.cfg</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">haproxy-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动haproxy</span></span><br><span class="line"><span class="attr">haproxy-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">haproxy</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">haproxy-install</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">haproxy-config</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">haproxy-config</span></span><br></pre></td></tr></table></figure></p><h4 id="keepalived"><a href="#keepalived" class="headerlink" title="keepalived"></a>keepalived</h4><p>1）配置文件准备<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/keepalived/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   └── keepalived.conf</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment"># cat install.sls </span></span><br><span class="line">keepalived-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - name: keepalived</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">keepalived]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入keepalived安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.keepalived.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#keepalived配置文件</span></span><br><span class="line"><span class="attr">keepalived-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/keepalived/keepalived.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/keepalived/files/keepalived.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">keepalived-install</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">if</span> <span class="string">grains['fqdn']</span> <span class="string">==</span> <span class="string">"salt-minion01"</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="attr">      ROUTER_ID:</span> <span class="string">saltstack01</span></span><br><span class="line"><span class="attr">      STATE:</span> <span class="string">MASTER</span></span><br><span class="line"><span class="attr">      PRIORITY:</span> <span class="number">150</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">elif</span> <span class="string">grains['fqdn']</span> <span class="string">==</span> <span class="string">"salt-minion02"</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="attr">      ROUTER_ID:</span> <span class="string">saltstack02</span></span><br><span class="line"><span class="attr">      STATE:</span> <span class="string">BACKUP</span></span><br><span class="line"><span class="attr">      PRIORITY:</span> <span class="number">100</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">endif</span> <span class="string">%&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动keepalived</span></span><br><span class="line"><span class="attr">keepalived-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">keepalived</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">keepalived-install</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">keepalived-config</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">keepalived-config</span></span><br></pre></td></tr></table></figure></p><h3 id="整体部署"><a href="#整体部署" class="headerlink" title="整体部署"></a>整体部署</h3><p>1）top file 编写<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/top.sls </span><br><span class="line">prod:</span><br><span class="line">  <span class="string">"salt-minion0[3-4]"</span>:</span><br><span class="line">    - modules.lnmp.www</span><br><span class="line"></span><br><span class="line">  <span class="string">"salt-minion0[1-2]"</span>:</span><br><span class="line">    - modules.haproxy.service</span><br><span class="line">    - modules.keepalived.service</span><br></pre></td></tr></table></figure></p><p>2）高级状态执行<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><p>3）测试<br>访问<code>192.168.1.31</code>和<code>192.168.1.32</code>的状态页<br><img src="/2019/05/21/saltstack项目实战/05.png" alt="http://192.168.1.31:1314/status"><br><img src="/2019/05/21/saltstack项目实战/06.png" alt="http://192.168.1.32:1314/status"><br>访问VIP<code>192.168.1.100</code><br><img src="/2019/05/21/saltstack项目实战/07.png" alt="http://192.168.1.100"></p><p>通过上面测试可看到可以成功访问<code>lnmp</code>站点，并且<code>haproxy</code>也<code>ok</code>。访问所有四台服务器都可以得到<code>phpinfo</code>页面，而在生产环境中，我们只是对外提供<code>vip</code>即可。</p><h2 id="项目总结"><a href="#项目总结" class="headerlink" title="项目总结"></a>项目总结</h2><p>1）整体环境查看<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# tree /srv/salt/prod/modules/</span><br><span class="line">/srv/salt/prod/modules/</span><br><span class="line">├── haproxy</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   └── haproxy.cfg</span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── keepalived</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   └── keepalived.<span class="keyword">conf</span></span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── lnmp</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   ├── <span class="built_in">index</span>.php</span><br><span class="line">│   │   └── www.<span class="keyword">conf</span></span><br><span class="line">│   └── www.sls</span><br><span class="line">├── mysql</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   └── my.<span class="keyword">cnf</span></span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── nginx</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   ├── nginx-<span class="number">1.12</span>.<span class="number">2</span>.tar.gz</span><br><span class="line">│   │   ├── nginx-<span class="number">1.16</span>.<span class="number">0</span>.tar.gz</span><br><span class="line">│   │   ├── nginx.<span class="keyword">conf</span>.template</span><br><span class="line">│   │   └── nginx.service.template</span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── php</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   ├── php-<span class="number">5.6</span>.<span class="number">40</span>.tar.gz</span><br><span class="line">│   │   ├── php-fpm.<span class="keyword">conf</span>.template</span><br><span class="line">│   │   ├── php-fpm.service.template</span><br><span class="line">│   │   ├── php-fpm.template</span><br><span class="line">│   │   └── php.ini.template</span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── pkg.sls</span><br><span class="line">└── user</span><br><span class="line">    └── www.sls</span><br><span class="line"></span><br><span class="line"><span class="number">13</span> directories, <span class="number">27</span> <span class="keyword">files</span></span><br></pre></td></tr></table></figure></p><p>2）如果需要在某台服务器上面单独部署某一部分，参考以下写法：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># cat /srv/salt/base/top.sls </span></span><br><span class="line"><span class="meta">#部署lnmp及haproxy+keepalived</span></span><br><span class="line"><span class="symbol">prod:</span></span><br><span class="line">  <span class="string">"salt-minion0[3-4]"</span>:</span><br><span class="line">    - modules.lnmp.www</span><br><span class="line"></span><br><span class="line">  <span class="string">"salt-minion0[1-2]"</span>:</span><br><span class="line">    - modules.haproxy.service</span><br><span class="line">    - modules.keepalived.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#单实例操作说明：</span></span><br><span class="line"><span class="symbol">prod:</span></span><br><span class="line">  <span class="string">"salt-minion04"</span>:</span><br><span class="line">    - modules.nginx.service<span class="meta">#单独安装nginx时</span></span><br><span class="line">    - modules.mysql.service     <span class="meta">#单独安装mysql时</span></span><br><span class="line">    - modules.php.service       <span class="meta">#单独安装php时</span></span><br><span class="line">    - modules.keepalived.service  <span class="meta">#单独安装keepalived时</span></span><br><span class="line">    - modules.haproxy.service   <span class="meta">#单独安装haproxy时</span></span><br><span class="line"></span><br><span class="line">  <span class="string">"salt-minion03"</span>:</span><br><span class="line">    - modules.lnmp.www     <span class="meta">#单独部署lnmp环境时</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;项目架构规划&quot;&gt;&lt;a href=&quot;#项目架构规划&quot; class=&quot;headerlink&quot; title=&quot;项目架构规划&quot;&gt;&lt;/a&gt;项目架构规划&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;后端web服务器使用&lt;code&gt;Nginx+Php&lt;/code&gt;作为站点，通过&lt;c
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack接口salt-api</title>
    <link href="https://leeyj.coding.me/2019/05/20/saltstack%E6%8E%A5%E5%8F%A3salt-api/"/>
    <id>https://leeyj.coding.me/2019/05/20/saltstack接口salt-api/</id>
    <published>2019-05-20T14:04:05.000Z</published>
    <updated>2019-05-23T15:15:21.768Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><a href="https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html" target="_blank" rel="noopener">参考官档</a><br><a href="https://www.unixhot.com/docs/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html#a-rest-api-for-salt" target="_blank" rel="noopener">参考官档</a></p><blockquote><p><code>SaltStack</code>官方提供有<code>REST API</code>格式的<code>salt-api</code>项目，将使<code>salt</code>与第三方系统集成变得更加简单。</p></blockquote><h2 id="salt-api安装配置"><a href="#salt-api安装配置" class="headerlink" title="salt-api安装配置"></a>salt-api安装配置</h2><p>1）在<code>salt-master</code>上进行安装<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install salt-api</span><br></pre></td></tr></table></figure></p><p>2）自签名证书，生产环境可以购买（说明：如果没有<code>salt-call</code>命令，装上<code>salt-minion</code>即可，依赖于该包）<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt-call --local tls.create_self_signed_cert</span></span><br><span class="line"><span class="keyword">local</span>:</span><br><span class="line">    Created Private Key: <span class="string">"/etc/pki/tls/certs/localhost.key."</span> Created Certificate: <span class="string">"/etc/pki/tls/certs/localhost.crt."</span></span><br></pre></td></tr></table></figure></p><p>3）打开<code>include</code>加载子配置文件，方便管理<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">default_include: <span class="literal">master</span>.d/*.conf</span><br></pre></td></tr></table></figure></p><p>4）配置<code>api</code>配置文件，将上面生成的证书写到配置文件<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># vim /etc/salt/master.d/api.conf</span></span><br><span class="line"><span class="symbol">rest_cherrypy:</span></span><br><span class="line"><span class="symbol">  host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.30</span></span><br><span class="line"><span class="symbol">  port:</span> <span class="number">8000</span></span><br><span class="line"><span class="symbol">  ssl_crt:</span> <span class="meta-keyword">/etc/</span>pki<span class="meta-keyword">/tls/</span>certs/localhost.crt</span><br><span class="line"><span class="symbol">  ssl_key:</span> <span class="meta-keyword">/etc/</span>pki<span class="meta-keyword">/tls/</span>certs/localhost.key</span><br></pre></td></tr></table></figure></p><p>5）创建认证用户，并设置密码<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# useradd</span> -M -s /sbin/nologin saltapi</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# echo</span> 'saltapi' | passwd --stdin saltapi</span><br></pre></td></tr></table></figure></p><p>6）创建认证配置文件<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# vim /etc/salt/master.d/auth.conf</span><br><span class="line">external_auth:</span><br><span class="line">  pam:</span><br><span class="line">    saltapi:</span><br><span class="line">      -<span class="ruby"> .*</span></span><br><span class="line"><span class="ruby">      - <span class="string">'@wheel'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'@runner'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'@jobs'</span></span></span><br></pre></td></tr></table></figure></p><p>7）重启<code>salt-master</code>和启动<code>salt-api</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> <span class="literal">start</span> salt-api</span><br></pre></td></tr></table></figure></p><p>8）查看<code>salt-api</code>监听端口<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# netstat -anlutp |grep <span class="number">8000</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>:<span class="number">8000</span>       <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*               LISTEN      <span class="number">10904</span>/python        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>:<span class="number">53414</span>      <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>:<span class="number">8000</span>       TIME_WAIT   -</span><br></pre></td></tr></table></figure></p><p>9）验证<code>login</code>登录，获取<code>token</code>字符串<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="comment"># curl -sSk https://192.168.1.30:8000/login \</span></span><br><span class="line">&gt;     -H <span class="string">'Accept: application/x-yaml'</span> <span class="string">\</span></span><br><span class="line">&gt;     -d username=saltapi <span class="string">\</span></span><br><span class="line">&gt;     -d password=saltapi <span class="string">\</span></span><br><span class="line">&gt;     -d eauth=pam</span><br><span class="line">return:</span><br><span class="line">- eauth: pam</span><br><span class="line">  expire: <span class="number">1558663247.869537</span></span><br><span class="line">  perms:</span><br><span class="line">  - .*</span><br><span class="line">  - <span class="string">'@wheel'</span></span><br><span class="line">  - <span class="string">'@runner'</span></span><br><span class="line">  - <span class="string">'@jobs'</span></span><br><span class="line">  start: <span class="number">1558620047.869536</span></span><br><span class="line">  token: e8330f642a3addd853c723d63844d29a12de9484</span><br><span class="line">  user: saltapi</span><br></pre></td></tr></table></figure></p><p>10）通过<code>api</code>执行<code>test.ping</code>测试连通性<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>salt-master ~]# curl -sSk https:<span class="comment">//192.168.1.30:8000 \</span></span><br><span class="line">&gt;     -H <span class="string">'Accept: application/x-yaml'</span> \</span><br><span class="line">&gt;     -H <span class="string">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\</span><br><span class="line">&gt;     -d client=local \</span><br><span class="line">&gt;     -d tgt=<span class="string">'*'</span> \</span><br><span class="line">&gt;     -d <span class="function"><span class="keyword">fun</span>=test.ping</span></span><br><span class="line"><span class="keyword">return</span>:</span><br><span class="line">- salt-minion01: <span class="literal">true</span></span><br><span class="line">  salt-minion02: <span class="literal">true</span></span><br><span class="line">  salt-minion03: <span class="literal">true</span></span><br><span class="line">  salt-minion04: <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><p>11）通过<code>api</code>执行<code>cmd.run</code><br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>salt-master ~]# curl -sSk https:<span class="comment">//192.168.1.30:8000 \</span></span><br><span class="line">&gt;     -H <span class="string">'Accept: application/x-yaml'</span> \</span><br><span class="line">&gt;     -H <span class="string">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\</span><br><span class="line">&gt;     -d client=local \</span><br><span class="line">&gt;     -d tgt=<span class="string">'*'</span> \</span><br><span class="line">&gt;     -d <span class="function"><span class="keyword">fun</span>='cmd.run' -d arg='uptime'</span></span><br><span class="line"><span class="keyword">return</span>:</span><br><span class="line">- salt-minion01: <span class="string">' 22:10:25 up 46 min,  1 user,  load average: 0.00, 0.01, 0.05'</span></span><br><span class="line">  salt-minion02: <span class="string">' 22:10:25 up 7 min,  0 users,  load average: 0.00, 0.18, 0.15'</span></span><br><span class="line">  salt-minion03: <span class="string">' 22:10:25 up 7 min,  0 users,  load average: 0.06, 0.33, 0.26'</span></span><br><span class="line">  salt-minion04: <span class="string">' 22:10:25 up 7 min,  0 users,  load average: 0.01, 0.21, 0.16'</span></span><br></pre></td></tr></table></figure></p><p>12）通过<code>api</code>获取<code>grains</code>信息`<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master <span class="symbol">~]# curl -sSk https</span>:<span class="comment">//192.168.1.30:8000/minions/salt-minion01 \</span></span><br><span class="line">&gt;     -H 'Accept: application/x-yaml' \</span><br><span class="line">&gt;     -H 'X-Auth-Token: e<span class="number">8330</span>f642a3addd853c723d<span class="number">6384</span>4d29a12de<span class="number">9484</span>'</span><br><span class="line">return:</span><br><span class="line">- salt-minion01:</span><br><span class="line">    SSDs: []</span><br><span class="line">    biosreleasedate: <span class="number">05</span>/<span class="number">19</span>/<span class="number">2017</span></span><br><span class="line">    biosversion: '6.00'</span><br><span class="line">    cpu_flags:</span><br><span class="line">    - fpu</span><br><span class="line">    - vme</span><br><span class="line">    - de</span><br><span class="line">    - pse</span><br><span class="line">    - tsc</span><br><span class="line">.....</span><br></pre></td></tr></table></figure></p><p>13）使用<code>json</code>格式<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# curl -sSk https://<span class="number">192.168</span><span class="number">.1</span><span class="number">.30</span>:<span class="number">8000</span>/minions/salt-minion01 \</span><br><span class="line">&gt;     -<span class="symbol">H</span> <span class="string">'Accept: application/json'</span> \</span><br><span class="line">&gt;     -<span class="symbol">H</span> <span class="string">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span></span><br><span class="line">&#123;<span class="string">"return"</span>: [&#123;<span class="string">"salt-minion01"</span>: &#123;<span class="string">"biosversion"</span>: <span class="string">"6.00"</span>, <span class="string">"kernel"</span>: <span class="string">"Linux"</span>, <span class="string">"domain"</span>: <span class="string">""</span>, <span class="string">"uid"</span>: <span class="number">0</span>, <span class="string">"zmqversion"</span>: <span class="string">"4.1.4"</span>, <span class="string">"kernelrelease"</span>: <span class="string">"3.10.0-693.el7.x86_64"</span>, <span class="string">"selinux"</span>: &#123;<span class="string">"enforced"</span>: <span class="string">"Disabled"</span>, <span class="string">"enabled"</span>: false&#125;, <span class="string">"serialnumber"</span>: <span class="string">"VMware-56 4d 9e a0 21 56 90 87-cd 89 69 32 13 94 17 44"</span>, <span class="string">"pid"</span>: <span class="number">1449</span>, <span class="string">"fqdns"</span>: [], <span class="string">"ip_interfaces"</span>: &#123;<span class="string">"lo"</span>: [<span class="string">"127.0.0.1"</span>, <span class="string">"::1"</span>], <span class="string">"virbr0"</span>: [<span class="string">"192.168.122.1"</span>], <span class="string">"virbr0-nic"</span>: [], <span class="string">"ens33"</span>: [<span class="string">"192.168.1.31"</span>, <span class="string">"192.168.1.100"</span>, <span class="string">"fe80::20c:29ff:fe94:1744"</span>]&#125;, <span class="string">"groupname"</span>: <span class="string">"root"</span>, <span class="string">"fqdn_ip6"</span>: [<span class="string">"fe80::20c:29ff:fe94:1744"</span>],</span><br><span class="line">.......</span><br></pre></td></tr></table></figure></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p><code>salt-api</code>必须使用<code>https</code>，生产环境建议使用可信证书<br>当<code>salt-api</code>服务重启后原<code>token</code>失效</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://docs.saltstack.com/en/latest/ref/netapi/all/salt.neta
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
</feed>
