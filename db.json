{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.png","path":"images/avatar.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/algolia-search.js","path":"js/src/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/exturl.js","path":"js/src/exturl.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/hook-duoshuo.js","path":"js/src/hook-duoshuo.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/js.cookie.js","path":"js/src/js.cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scroll-cookie.js","path":"js/src/scroll-cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","path":"lib/algolia-instant-search/instantsearch.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","path":"lib/canvas-nest/canvas-nest.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","path":"lib/canvas-ribbon/canvas-ribbon.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/LICENSE","path":"lib/fastclick/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/README.md","path":"lib/fastclick/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/bower.json","path":"lib/fastclick/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","path":"lib/font-awesome/HELP-US-OUT.txt","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/bower.json","path":"lib/font-awesome/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","path":"lib/jquery_lazyload/CONTRIBUTING.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","path":"lib/jquery_lazyload/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","path":"lib/jquery_lazyload/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","path":"lib/jquery_lazyload/jquery.lazyload.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","path":"lib/jquery_lazyload/jquery.scrollstop.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/font-embedded.css","path":"lib/needsharebutton/font-embedded.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.css","path":"lib/needsharebutton/needsharebutton.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.js","path":"lib/needsharebutton/needsharebutton.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","path":"lib/three/canvas_lines.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","path":"lib/three/canvas_sphere.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three-waves.min.js","path":"lib/three/three-waves.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/bower.json","path":"lib/velocity/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","path":"lib/velocity/velocity.ui.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/Valine.min.js","path":"js/src/Valine.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery/index.js","path":"lib/jquery/index.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/av-min.js","path":"js/src/av-min.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.css","path":"lib/Han/dist/han.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.js","path":"lib/Han/dist/han.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","path":"lib/fancybox/source/blank.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","path":"lib/fancybox/source/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","path":"lib/fancybox/source/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","path":"lib/fancybox/source/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","path":"lib/fancybox/source/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","path":"lib/fancybox/source/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","path":"lib/fancybox/source/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","path":"lib/fastclick/lib/fastclick.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","path":"lib/fastclick/lib/fastclick.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","path":"lib/font-awesome/css/font-awesome.css.map","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","path":"lib/ua-parser-js/dist/ua-parser.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","path":"lib/ua-parser-js/dist/ua-parser.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.css","path":"lib/Han/dist/han.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.js","path":"lib/Han/dist/han.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.js","path":"lib/velocity/velocity.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","path":"lib/Han/dist/font/han-space.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","path":"lib/Han/dist/font/han-space.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","path":"lib/Han/dist/font/han.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","path":"lib/Han/dist/font/han.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.woff2","path":"lib/Han/dist/font/han.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","path":"lib/fancybox/source/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","path":"lib/fancybox/source/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","path":"lib/font-awesome/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","path":"lib/font-awesome/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","path":"lib/algolia-instant-search/instantsearch.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three.min.js","path":"lib/three/three.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","path":"lib/font-awesome/fonts/fontawesome-webfont.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar3.png","path":"images/avatar3.png","modified":0,"renderable":1}],"Cache":[{"_id":"source/.DS_Store","hash":"cc75fbdb977a72e3c33a32b977ec965c1597d5c5","modified":1557936211109},{"_id":"themes/next/.bowerrc","hash":"334da94ca6f024d60d012cc26ea655681e724ad8","modified":1557981344471},{"_id":"themes/next/.editorconfig","hash":"211d2c92bfdddb3e81ea946f4ca7a539f150f4da","modified":1557981344472},{"_id":"themes/next/.gitattributes","hash":"8454b9313cb1a97b63fb87e2d29daee497ce6249","modified":1557981344473},{"_id":"themes/next/.gitignore","hash":"ee0b13c268cc8695d3883a5da84930af02d4ed08","modified":1557981344499},{"_id":"themes/next/.hound.yml","hash":"289dcf5bfe92dbd680d54d6e0668f41c9c9c0c78","modified":1557981344500},{"_id":"themes/next/.javascript_ignore","hash":"cd250ad74ca22bd2c054476456a73d9687f05f87","modified":1557981344501},{"_id":"themes/next/.jshintrc","hash":"b7d23f2ce8d99fa073f22f9960605f318acd7710","modified":1557981344502},{"_id":"themes/next/.stylintrc","hash":"3b7f9785e9ad0dab764e1c535b40df02f4ff5fd6","modified":1557981344503},{"_id":"themes/next/.travis.yml","hash":"6674fbdfe0d0c03b8a04527ffb8ab66a94253acd","modified":1557981344504},{"_id":"themes/next/LICENSE","hash":"ec44503d7e617144909e54533754f0147845f0c5","modified":1557981344505},{"_id":"themes/next/README.cn.md","hash":"b764aae78ffa561a9a68fdee4c6f21c3ce260fbb","modified":1557981344507},{"_id":"themes/next/README.md","hash":"4e276fb9a3c31f1259df3ea9a4b92f4a8d72714d","modified":1557981344508},{"_id":"themes/next/gulpfile.coffee","hash":"412defab3d93d404b7c26aaa0279e2e586e97454","modified":1557981344512},{"_id":"themes/next/_config.yml","hash":"be9604c93ef603a373c98b059468e2e752ac39e4","modified":1557981344509},{"_id":"themes/next/bower.json","hash":"486ebd72068848c97def75f36b71cbec9bb359c5","modified":1557981344511},{"_id":"themes/next/package.json","hash":"3963ad558a24c78a3fd4ef23cf5f73f421854627","modified":1557981344699},{"_id":"source/_posts/MySQL自动备份脚本.md","hash":"53eb7dc773bb568616054a3880bf3088928e5a63","modified":1557981344290},{"_id":"source/_posts/ftp虚拟用户.md","hash":"5508fccad548c8be1c54528f0e55d0c9a72f3036","modified":1557981344291},{"_id":"source/_posts/linuxTools-小工具集合.md","hash":"bc8cca9409e30e04208f3f23d69e88271cc5c954","modified":1557981344293},{"_id":"source/_posts/linux下解压windows上压缩rar包.md","hash":"73e2aa6d9f90136d72a8cbdd1e2922b5f9631c2e","modified":1557981344294},{"_id":"source/_posts/phpMyAdmin搭建.md","hash":"bd20276779fef5723dcdf8bd5f0b6deca7db03c2","modified":1557981344297},{"_id":"source/_posts/saltstack基本入门.md","hash":"cc3947aa0232b4936eb170c1af045a953de67138","modified":1557981344307},{"_id":"source/_posts/saltstack远程执行.md","hash":"de1e9037e7ce2fd79fd4551bd3d2bd3080781bc1","modified":1557981344309},{"_id":"source/_posts/saltstack配置管理.md","hash":"6117fbc9082ea6f4c0c991d1923593d72e646773","modified":1557999940646},{"_id":"source/photos/index.md","hash":"6d5ca16d422cebb10fd5c3dcbcded8bddd289d75","modified":1557981344314},{"_id":"source/categories/index.md","hash":"6961d405c0b14bc71f21fd08b06d872af855b897","modified":1557981344312},{"_id":"source/tags/index.md","hash":"953dc4d18f1067cfd6e76e82b8cf1407c528f05e","modified":1557981344316},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"5adfad3ef1b870063e621bc0838268eb2c7c697a","modified":1557981344484},{"_id":"themes/next/.github/ISSUE_TEMPLATE.md","hash":"b1ec000babd42bb7ffd26f5ad8aac9b5bec79ae5","modified":1557981344485},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"1228506a940114288d61812bfe60c045a0abeac1","modified":1557981344496},{"_id":"themes/next/.github/browserstack_logo.png","hash":"a6c43887f64a7f48a2814e3714eaa1215e542037","modified":1514748788000},{"_id":"themes/next/languages/de.yml","hash":"fd02d9c2035798d5dc7c1a96b4c3e24b05b31a47","modified":1557981344514},{"_id":"themes/next/languages/default.yml","hash":"b3bcd8934327448a43d9bfada5dd11b1b8c1402e","modified":1557981344515},{"_id":"themes/next/languages/en.yml","hash":"2f4b4776ca1a08cc266a19afb0d1350a3926f42c","modified":1557981344517},{"_id":"themes/next/languages/fr-FR.yml","hash":"efeeb55d5c4add54ad59a612fc0630ee1300388c","modified":1557981344518},{"_id":"themes/next/languages/id.yml","hash":"dccae33e2a5b3c9f11c0e05ec4a7201af1b25745","modified":1557981344519},{"_id":"themes/next/languages/it.yml","hash":"a215d016146b1bd92cef046042081cbe0c7f976f","modified":1557981344525},{"_id":"themes/next/languages/ja.yml","hash":"37f954e47a3bc669620ca559e3edb3b0072a4be5","modified":1557981344526},{"_id":"themes/next/languages/ko.yml","hash":"dc8f3e8c64eb7c4bb2385025b3006b8efec8b31d","modified":1557981344529},{"_id":"themes/next/languages/nl-NL.yml","hash":"213e7a002b82fb265f69dabafbbc382cfd460030","modified":1557981344530},{"_id":"themes/next/languages/pt-BR.yml","hash":"568d494a1f37726a5375b11452a45c71c3e2852d","modified":1557981344531},{"_id":"themes/next/languages/pt.yml","hash":"2efcd240c66ab1a122f061505ca0fb1e8819877b","modified":1557981344532},{"_id":"themes/next/languages/ru.yml","hash":"e33ee44e80f82e329900fc41eb0bb6823397a4d6","modified":1557981344533},{"_id":"themes/next/languages/vi.yml","hash":"a9b89ebd3e5933033d1386c7c56b66c44aca299a","modified":1557981344535},{"_id":"themes/next/languages/zh-Hans.yml","hash":"77c0a197f9521f7b30ba035e9bdcfe8e4feeba0b","modified":1557981344536},{"_id":"themes/next/languages/zh-hk.yml","hash":"fe0d45807d015082049f05b54714988c244888da","modified":1557981344537},{"_id":"themes/next/languages/zh-tw.yml","hash":"432463b481e105073accda16c3e590e54c8e7b74","modified":1557981344538},{"_id":"themes/next/layout/_layout.swig","hash":"d34cd8fea68115dc9e995a7c073450e5588856e1","modified":1557981344545},{"_id":"themes/next/layout/archive.swig","hash":"9a2c14874a75c7085d2bada5e39201d3fc4fd2b4","modified":1557981344690},{"_id":"themes/next/layout/category.swig","hash":"3cbb3f72429647411f9e85f2544bdf0e3ad2e6b2","modified":1557981344691},{"_id":"themes/next/layout/index.swig","hash":"555a357ecf17128db4e29346c92bb6298e66547a","modified":1557981344692},{"_id":"themes/next/layout/page.swig","hash":"e8fcaa641d46930237675d2ad4b56964d9e262e9","modified":1557981344694},{"_id":"themes/next/layout/post.swig","hash":"7a6ce102ca82c3a80f776e555dddae1a9981e1ed","modified":1557981344695},{"_id":"themes/next/layout/schedule.swig","hash":"87ad6055df01fa2e63e51887d34a2d8f0fbd2f5a","modified":1557981344697},{"_id":"themes/next/layout/tag.swig","hash":"34e1c016cbdf94a31f9c5d494854ff46b2a182e9","modified":1557981344698},{"_id":"themes/next/scripts/merge-configs.js","hash":"38d86aab4fc12fb741ae52099be475196b9db972","modified":1557981344700},{"_id":"themes/next/scripts/merge.js","hash":"39b84b937b2a9608b94e5872349a47200e1800ff","modified":1557981344702},{"_id":"themes/next/test/.jshintrc","hash":"c9fca43ae0d99718e45a6f5ce736a18ba5fc8fb6","modified":1557981345210},{"_id":"themes/next/test/helpers.js","hash":"f25e7f3265eb5a6e1ccbb5e5012fa9bebf134105","modified":1557981345212},{"_id":"themes/next/test/intern.js","hash":"db90b1063356727d72be0d77054fdc32fa882a66","modified":1557981345213},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/layout/_custom/header.swig","hash":"ba8ab5a0280b953aa97435ff8946cbcbb2755a27","modified":1557981344540},{"_id":"themes/next/layout/_custom/sidebar.swig","hash":"ba8ab5a0280b953aa97435ff8946cbcbb2755a27","modified":1557981344544},{"_id":"themes/next/layout/_macro/my-copyright.swig","hash":"26dc2670a27468a11eb89f8c14046d2a04c63f91","modified":1557981344547},{"_id":"themes/next/layout/_macro/passage-end-tag.swig","hash":"0bd1e2cebdf9c0e1152868f16ec024cc933a8f9f","modified":1557981344548},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"8c56dd26157cbc580ae41d97ac34b90ab48ced3f","modified":1557981344577},{"_id":"themes/next/layout/_macro/post-copyright.swig","hash":"f83befdc740beb8dc88805efd7fbb0fef9ed19be","modified":1557981344578},{"_id":"themes/next/layout/_macro/post.swig","hash":"dd63d42cb77878450bb89004c44132fc0c8a8d47","modified":1557981344579},{"_id":"themes/next/layout/_macro/reward.swig","hash":"357d86ec9586705bfbb2c40a8c7d247a407db21a","modified":1557981344581},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"9c7343fd470e0943ebd75f227a083a980816290b","modified":1557981344584},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"e2e4eae391476da994045ed4c7faf5e05aca2cd7","modified":1557981344589},{"_id":"themes/next/layout/_partials/comments.swig","hash":"4adc65a602d1276615da3b887dcbf2ac68e7382b","modified":1557981344594},{"_id":"themes/next/layout/_partials/footer.swig","hash":"154abef906f2353de3fd9d961878b14449dc7397","modified":1557981344597},{"_id":"themes/next/layout/_partials/head.swig","hash":"f14a39dad1ddd98e6d3ceb25dda092ba80d391b5","modified":1557981344599},{"_id":"themes/next/layout/_partials/header.swig","hash":"c54b32263bc8d75918688fb21f795103b3f57f03","modified":1557981344608},{"_id":"themes/next/layout/_partials/page-header.swig","hash":"77c61e0baea3544df361b7338c3cd13dc84dde22","modified":1557981344610},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"1634fb887842698e01ff6e632597fe03c75d2d01","modified":1557981344611},{"_id":"themes/next/layout/_partials/search.swig","hash":"b4ebe4a52a3b51efe549dd1cdee846103664f5eb","modified":1557981344613},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"c0f5a0955f69ca4ed9ee64a2d5f8aa75064935ad","modified":1557981344626},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"931808ad9b8d8390c0dcf9bdeb0954eeb9185d68","modified":1557981344627},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"9be624634703be496a5d2535228bc568a8373af9","modified":1557981344636},{"_id":"themes/next/layout/_third-party/copy-code.swig","hash":"e5fda28428438d595f5a4f1e8a9b1f6e37691e68","modified":1557981344671},{"_id":"themes/next/layout/_third-party/duoshuo-hot-articles.swig","hash":"ba75672183d94f1de7c8bd0eeee497a58c70e889","modified":1557981344673},{"_id":"themes/next/layout/_third-party/exturl.swig","hash":"8301c9600bb3e47f7fb98b0e0332ef3c51bb1688","modified":1557981344674},{"_id":"themes/next/layout/_third-party/mathjax.swig","hash":"a0bd3388587fd943baae0d84ca779a707fbcad89","modified":1557981344675},{"_id":"themes/next/layout/_third-party/needsharebutton.swig","hash":"fa882641da3bd83d9a58a8a97f9d4c62a9ee7b5c","modified":1557981344676},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"554ec568e9d2c71e4a624a8de3cb5929050811d6","modified":1557981344677},{"_id":"themes/next/layout/_third-party/schedule.swig","hash":"db15d7e1552aa2d2386a6b8a33b3b3a40bf9e43d","modified":1557981344678},{"_id":"themes/next/layout/_third-party/scroll-cookie.swig","hash":"9a188938d46931d5f3882a140aa1c48b3a893f0c","modified":1557981344679},{"_id":"themes/next/scripts/tags/button.js","hash":"eddbb612c15ac27faf11c59c019ce188f33dec2c","modified":1557981344703},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"99b66949f18398689b904907af23c013be1b978f","modified":1557981344704},{"_id":"themes/next/scripts/tags/exturl.js","hash":"5022c0ba9f1d13192677cf1fd66005c57c3d0f53","modified":1557981344705},{"_id":"themes/next/scripts/tags/full-image.js","hash":"c9f833158c66bd72f627a0559cf96550e867aa72","modified":1557981344706},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"ac681b0d0d8d39ba3817336c0270c6787c2b6b70","modified":1557981344712},{"_id":"themes/next/scripts/tags/label.js","hash":"6f00952d70aadece844ce7fd27adc52816cc7374","modified":1557981344713},{"_id":"themes/next/scripts/tags/lazy-image.js","hash":"bcba2ff25cd7850ce6da322d8bd85a8dd00b5ceb","modified":1557981344714},{"_id":"themes/next/scripts/tags/note.js","hash":"f7eae135f35cdab23728e9d0d88b76e00715faa0","modified":1557981344715},{"_id":"themes/next/scripts/tags/tabs.js","hash":"aa7fc94a5ec27737458d9fe1a75c0db7593352fd","modified":1557981344716},{"_id":"themes/next/source/css/main.styl","hash":"a91dbb7ef799f0a171b5e726c801139efe545176","modified":1557981344964},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"45eeea0b5fba833e21e38ea10ed5ab385ceb4f01","modified":1557981344969},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1514748788000},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1514748788000},{"_id":"themes/next/source/images/avatar.png","hash":"75dbfd5a1d3a64eb4fdd4dcc30127b243cead72c","modified":1558064241749},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1557981344975},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1557981344976},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1557981344977},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1557981344979},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1557981344990},{"_id":"themes/next/source/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1557981345038},{"_id":"themes/next/source/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1557981345040},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1514748788000},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1514748788000},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1514748788000},{"_id":"themes/next/source/images/logo.svg","hash":"169f56fd82941591dad3abd734a50ec7259be950","modified":1557981345044},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1514748788000},{"_id":"themes/next/source/images/quote-l.svg","hash":"cd108d6f44351cadf8e6742565217f88818a0458","modified":1557981345046},{"_id":"themes/next/source/images/quote-r.svg","hash":"2a2a250b32a87c69dcc1b1976c74b747bedbfb41","modified":1557981345051},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1514748788000},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"source/_posts/phpMyAdmin搭建/4.png","hash":"19c4b342d5c4a2d29e98611d7ddf4f2a9610d604","modified":1556262531412},{"_id":"themes/next/layout/_partials/head/custom-head.swig","hash":"a223919d2e1bf17ca4d6abb2c86f2efca9883dc1","modified":1557981344603},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"f5e487b0d213ca0bd94aa30bc23b240d65081627","modified":1557981344605},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"b2f0d247b213e4cf8de47af6a304d98070cc7256","modified":1557981344617},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"a8c7f9ca7c605d039a1f3bf4e4d3183700a3dd62","modified":1557981344618},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"b25002a83cbd2ca0c4a5df87ad5bff26477c0457","modified":1557981344619},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"9e3d133ac5bcc6cb51702c83b2611a49811abad1","modified":1557981344621},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"d9e2d9282f9be6e04eae105964abb81e512bffed","modified":1557981344622},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"d4fbffd7fa8f2090eb32a871872665d90a885fac","modified":1557981344623},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"0a9cdd6958395fcdffc80ab60f0c6301b63664a5","modified":1557981344624},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"9b84ab576982b2c3bb0291da49143bc77fba3cc6","modified":1557981344629},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"a9a3995b9615adfb8d6b127c78c6771627bee19a","modified":1557981344630},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a9a3995b9615adfb8d6b127c78c6771627bee19a","modified":1557981344635},{"_id":"themes/next/layout/_third-party/analytics/analytics-with-widget.swig","hash":"ff947f3561b229bc528cb1837d4ca19612219411","modified":1557981344638},{"_id":"themes/next/layout/_third-party/analytics/application-insights.swig","hash":"71397a5823e8ec8aad3b68aace13150623b3e19d","modified":1557981344639},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"753d262911c27baf663fcaf199267133528656af","modified":1557981344641},{"_id":"themes/next/layout/_third-party/analytics/busuanzi-counter.swig","hash":"7b11eac3a0685fa1ab2ab6ecff60afc4f15f0d16","modified":1557981344642},{"_id":"themes/next/layout/_third-party/analytics/cnzz-analytics.swig","hash":"a10b7f19d7b5725527514622899df413a34a89db","modified":1557981344643},{"_id":"themes/next/layout/_third-party/analytics/facebook-sdk.swig","hash":"7d94845f96197d9d84a405fa5d4ede75fb81b225","modified":1557981344644},{"_id":"themes/next/layout/_third-party/analytics/firestore.swig","hash":"ccc443b22bd4f8c7ac4145664686c756395b90e0","modified":1557981344645},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"b1e13df83fb2b1d5d513b30b7aa6158b0837daab","modified":1557981344649},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"45f3f629c2aacc381095750e1c8649041a71a84b","modified":1557981344652},{"_id":"themes/next/layout/_third-party/analytics/lean-analytics.swig","hash":"e6d10ee4fb70b3ae1cd37e9e36e000306734aa2e","modified":1557981344653},{"_id":"themes/next/layout/_third-party/analytics/tencent-analytics.swig","hash":"8a399df90dadba5ad4e781445b58f4765aeb701e","modified":1557981344654},{"_id":"themes/next/layout/_third-party/analytics/tencent-mta.swig","hash":"5a8027328f060f965b3014060bebec1d7cf149c1","modified":1557981344655},{"_id":"themes/next/layout/_third-party/analytics/vkontakte-api.swig","hash":"f9a1647a8f1866deeb94052d1f87a5df99cb1e70","modified":1557981344656},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"4c501ea0b9c494181eb3c607c5526a5754e7fbd8","modified":1557981344658},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"b83a51bbe0f1e2ded9819070840b0ea145f003a6","modified":1557981344659},{"_id":"themes/next/layout/_third-party/comments/duoshuo.swig","hash":"1600f340e0225361580c44890568dc07dbcf2c89","modified":1557981344660},{"_id":"themes/next/layout/_third-party/comments/gitment.swig","hash":"4dcc3213c033994d342d02b800b6229295433d30","modified":1557981344661},{"_id":"themes/next/layout/_third-party/comments/hypercomments.swig","hash":"af7f3e43cbdc4f88c13f101f0f341af96ace3383","modified":1557981344662},{"_id":"themes/next/layout/_third-party/comments/index.swig","hash":"493bd5999a1061b981922be92d8277a0f9152447","modified":1557981344663},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"9246162d4bc7e949ce1d12d135cbbaf5dc3024ec","modified":1557981344664},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"4274b042bc6a9e7b73106b9dcb100e7f09dcd093","modified":1557981344665},{"_id":"themes/next/layout/_third-party/comments/youyan.swig","hash":"7e65ff8fe586cd655b0e9d1ad2912663ff9bd36c","modified":1557981344668},{"_id":"themes/next/layout/_third-party/search/index.swig","hash":"34599633658f3b0ffb487728b7766e1c7b551f5a","modified":1557981344683},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"93479642fd076a1257fecc25fcf5d20ccdefe509","modified":1557981344684},{"_id":"themes/next/layout/_third-party/search/tinysou.swig","hash":"fe95dd3d166634c466e19aa756e65ad6e8254d3e","modified":1557981344685},{"_id":"themes/next/layout/_third-party/seo/baidu-push.swig","hash":"d8c98938719284fa06492c114d99a1904652a555","modified":1557981344687},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"186005a9a4845c1286d7d317554b16f074ac6599","modified":1557981344893},{"_id":"themes/next/source/css/_mixins/Gemini.styl","hash":"07f7da320689f828f6e36a6123807964a45157a0","modified":1557981344895},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"7896c3ee107e1a8b9108b6019f1c070600a1e8cc","modified":1557981344912},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"0e55cbd93852dc3f8ccb44df74d35d9918f847e0","modified":1557981344914},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"58e7dd5947817d9fc30770712fc39b2f52230d1e","modified":1557981344957},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"a25408534f8fe6e321db4bbf9dd03335d648fe17","modified":1557981344958},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"4069f918ccc312da86db6c51205fc6c6eaabb116","modified":1557981344960},{"_id":"themes/next/source/css/_variables/base.styl","hash":"b1f6ea881a4938a54603d68282b0f8efb4d7915d","modified":1557981344962},{"_id":"themes/next/source/js/src/affix.js","hash":"1b509c3b5b290a6f4607f0f06461a0c33acb69b1","modified":1557981345058},{"_id":"themes/next/source/js/src/algolia-search.js","hash":"cb431b54ba9c692165a1f5a12e4c564a560f8058","modified":1557981345059},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"0289031200c3d4c2bdd801ee10fff13bb2c353e4","modified":1557981345062},{"_id":"themes/next/source/js/src/exturl.js","hash":"a2a0f0de07e46211f74942a468f42ee270aa555c","modified":1557981345063},{"_id":"themes/next/source/js/src/hook-duoshuo.js","hash":"b35a7dc47b634197b93487cea8671a40a9fdffce","modified":1557981345064},{"_id":"themes/next/source/js/src/js.cookie.js","hash":"1512c751d219577d338ac0780fb2bbd9075d5298","modified":1557981345066},{"_id":"themes/next/source/js/src/motion.js","hash":"885176ed51d468f662fbf0fc09611f45c7e5a3b1","modified":1557981345067},{"_id":"themes/next/source/js/src/post-details.js","hash":"93a18271b4123dd8f94f09d1439b47c3c19a8712","modified":1557981345068},{"_id":"themes/next/source/js/src/scroll-cookie.js","hash":"02cf91514e41200bc9df5d8bdbeb58575ec06074","modified":1557981345070},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"b7657be25fc52ec67c75ab5481bdcb483573338b","modified":1557981345071},{"_id":"themes/next/source/js/src/utils.js","hash":"b3e9eca64aba59403334f3fa821f100d98d40337","modified":1557981345074},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1514748788000},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1514748788000},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","hash":"b02737510e9b89aeed6b54f89f602a9c24b06ff2","modified":1557981345104},{"_id":"themes/next/source/lib/fancybox/.bower.json","hash":"cc40a9b11e52348e554c84e4a5c058056f6b7aeb","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/.gitattributes","hash":"2db21acfbd457452462f71cc4048a943ee61b8e0","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/.bower.json","hash":"bf3eef9d647cd7c9b62feda3bc708c6cdd7c0877","modified":1557981345132},{"_id":"themes/next/source/lib/fastclick/LICENSE","hash":"6f474ea75c42442da7bbcf2e9143ce98258efd8d","modified":1557981345135},{"_id":"themes/next/source/lib/fastclick/README.md","hash":"68a9b9d53126405b0fa5f3324f1fb96dbcc547aa","modified":1557981345136},{"_id":"themes/next/source/lib/fastclick/bower.json","hash":"a9b3ee1e4db71a0e4ea6d5bed292d176dd68b261","modified":1557981345137},{"_id":"themes/next/source/lib/font-awesome/.bower.json","hash":"b4aefc910578d76b267e86dfffdd5121c8db9aec","modified":1557981345142},{"_id":"themes/next/source/lib/font-awesome/.gitignore","hash":"03ddbf76c1dd1afb93eed0b670d2eee747472ef1","modified":1557981345143},{"_id":"themes/next/source/lib/font-awesome/.npmignore","hash":"c31ff06a740955e44edd4403902e653ccabfd4db","modified":1557981345144},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","hash":"ee33b2798b1e714b904d663436c6b3521011d1fa","modified":1557981345145},{"_id":"themes/next/source/lib/font-awesome/bower.json","hash":"71e7183634dc1b9449f590f15ebd7201add22ca7","modified":1557981345146},{"_id":"themes/next/source/lib/jquery/.bower.json","hash":"865d6c1328ab209a4376b9d2b7a7824369565f28","modified":1557981345168},{"_id":"themes/next/source/lib/jquery_lazyload/.bower.json","hash":"90fa628f156d8045357ff11eaf32e61abacf10e8","modified":1557981345173},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","hash":"4ded6fee668544778e97e38c2b211fc56c848e77","modified":1557981345174},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","hash":"b930297cb98b8e1dbd5abe9bc1ed9d5935d18ce8","modified":1557981345175},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","hash":"e0acf1db27b0cc16128a59c46db1db406b5c4c58","modified":1557981345176},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","hash":"f4a570908f6c89c6edfb1c74959e733eaadea4f2","modified":1557981345178},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","hash":"bf773ad48a0b9aa77681a89d7569eefc0f7b7b18","modified":1557981345179},{"_id":"themes/next/source/lib/needsharebutton/font-embedded.css","hash":"14264a210bf94232d58d7599ea2ba93bfa4fb458","modified":1557981345181},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.css","hash":"e33aa8fa48b6639d8d8b937d13261597dd473b3a","modified":1557981345183},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.js","hash":"2ce5f3bf15c523b9bfc97720d8884bb22602a454","modified":1557981345184},{"_id":"themes/next/source/lib/pace/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1556202421981},{"_id":"themes/next/source/lib/pace/README.md","hash":"33b87ed998d59f117dc329f999a4ffc744b41e79","modified":1556202421981},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1556202421982},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1556202421982},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1556202421982},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1556202421985},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1556202421985},{"_id":"themes/next/source/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1556202421985},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","hash":"2d9a9f38c493fdf7c0b833bb9184b6a1645c11b2","modified":1557981345186},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","hash":"46a50b91c98b639c9a2b9265c5a1e66a5c656881","modified":1557981345188},{"_id":"themes/next/source/lib/three/three-waves.min.js","hash":"8148492dd49aa876d32bb7d5b728d3f5bf6f5074","modified":1557981345190},{"_id":"themes/next/source/lib/velocity/.bower.json","hash":"63da5e80ebb61bb66a2794d5936315ca44231f0c","modified":1557981345201},{"_id":"themes/next/source/lib/velocity/bower.json","hash":"92d92860418c4216aa59eb4cb4a556290a7ad9c3","modified":1557981345202},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"bf172816a9c57f9040e3d19c24e181a142daf92b","modified":1557981345206},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","hash":"f6d0852b22cc20759fe1c2705649eb7ec9c03a80","modified":1557981345208},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"c0040e89696beac1733a04de88c1b6a8b55e8122","modified":1557981345209},{"_id":"themes/next/source/js/src/Valine.min.js","hash":"65f2257ac52bcab6b0ac5f95f5b9b18b253554e7","modified":1557981345057},{"_id":"themes/next/source/lib/jquery/index.js","hash":"17a740d68a1c330876c198b6a4d9319f379f3af2","modified":1557981345171},{"_id":"themes/next/layout/_third-party/search/algolia-search/assets.swig","hash":"218cc936ba3518a3591b2c9eda46bc701edf7710","modified":1557981344681},{"_id":"themes/next/layout/_third-party/search/algolia-search/dom.swig","hash":"2530de0f3125a912756f6c0e9090cd012134a4c5","modified":1557981344682},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"8f86f694c0749a18ab3ad6f6df75466ca137a4bc","modified":1557981344720},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"237d185ac62ec9877e300947fa0109c44fb8db19","modified":1557981344721},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"8b32928686c327151e13d3ab100157f9a03cd59f","modified":1557981344722},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"ff4489cd582f518bba6909a301ac1292a38b4e96","modified":1557981344723},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"7ad4081466b397e2a6204141bb7768b7c01bd93c","modified":1557981344724},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"4f2801fc4cf3f31bf2069f41db8c6ce0e3da9e39","modified":1557981344755},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"6eb4bcc3056bd279d000607e8b4dad50d368ca69","modified":1557981344830},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"12662536c7a07fff548abe94171f34b768dd610f","modified":1557981344881},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"24ee4b356ff55fc6e58f26a929fa07750002cf29","modified":1557981344882},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"1da5c800d025345f212a3bf1be035060f4e5e6ed","modified":1557981344886},{"_id":"themes/next/source/css/_common/scaffolding/mobile.styl","hash":"91ca75492cd51f2553f4d294ed2f48239fcd55eb","modified":1557981344887},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"3f40e8a9fe8e7bd5cfc4cf4cbbbcb9539462e973","modified":1557981344889},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"a17e2b871a335f290afb392a08f94fd35f59c715","modified":1557981344890},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"ea9069645696f86c5df64208490876fe150c8cae","modified":1557981344891},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"60fa84aa7731760f05f52dd7d8f79b5f74ac478d","modified":1557981344920},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"25d5e45a355ee2093f3b8b8eeac125ebf3905026","modified":1557981344923},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"d0bfd1bef988c76f7d7dd72d88af6f0908a8b0db","modified":1557981344924},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"b1025c421406d2c24cc92a02ae28c1915b01e240","modified":1557981344925},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"26666c1f472bf5f3fb9bc62081cca22b4de15ccb","modified":1557981344927},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"d9236257aeebe120082ecf7a7f7f98037128abb2","modified":1557981344928},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"09c965022c13b84ed8a661fee8ac2a6d550495ae","modified":1557981344930},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"9b913b73d31d21f057f97115ffab93cfa578b884","modified":1557981344931},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"bce344d3a665b4c55230d2a91eac2ad16d6f32fd","modified":1557981344949},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"416988dca389e6e2fdfa51fa7f4ee07eb53f82fb","modified":1557981344950},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"4642e30010af8b2b037f5b43146b10a934941958","modified":1557981344951},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"1f6e2ce674735269599acc6d77b3ea18d31967fc","modified":1557981344953},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"ad2dcedf393ed1f3f5afd2508d24969c916d02fc","modified":1557981344954},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"86197902dfd3bededba10ba62b8f9f22e0420bde","modified":1557981344955},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"31127dcbf4c7b4ada53ffbf1638b5fe325b7cbc0","modified":1557981344939},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"748dbfbf9c08e719ddc775958003c64b00d39dab","modified":1557981344940},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"a98ad885ee4f48d85b2578a0b9c2bbf166e96733","modified":1557981344941},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"09c965022c13b84ed8a661fee8ac2a6d550495ae","modified":1557981344943},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"5dbc0d0c897e46760e5dbee416530d485c747bba","modified":1557981344944},{"_id":"themes/next/source/js/src/av-min.js","hash":"00f3825bf726d9746318ac3acce985ec98e09efc","modified":1557981345061},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"f1d0b5d7af32c423eaa8bb93ab6a0b45655645dc","modified":1557981345069},{"_id":"themes/next/source/lib/Han/dist/han.min.css","hash":"6d586bfcfb7ae48f1b12f76eec82d3ad31947501","modified":1557981345089},{"_id":"themes/next/source/lib/Han/dist/han.min.js","hash":"16b03db23a52623348f37c04544f2792032c1fb6","modified":1557981345090},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","hash":"82f33ad0842aa9c154d029e0dada2497d4eb1d57","modified":1557981345128},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","hash":"d71602cbca33b9ecdb7ab291b7f86a49530f3601","modified":1557981345129},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"ae6318aeb62ad4ce7a7e9a4cdacd93ffb004f0fb","modified":1557981345130},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","hash":"1d6aeda0480d0e4cb6198edf7719d601d4ae2ccc","modified":1557981345139},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","hash":"3655f1fdf1e584c4d8e8d39026093ca306a5a341","modified":1557981345148},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","hash":"1573904b82807abbb32c97a3632c6c6808eaac50","modified":1557981345150},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","hash":"88af80502c44cd52ca81ffe7dc7276b7eccb06cf","modified":1557981345151},{"_id":"themes/next/source/lib/pace/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1556202421975},{"_id":"themes/next/source/lib/pace/.git/config","hash":"46d590e05dc25560a69d5cc71b337adad9654443","modified":1556202421977},{"_id":"themes/next/source/lib/pace/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1556202418158},{"_id":"themes/next/source/lib/pace/.git/index","hash":"f916936bb525ec0301660daa3f9c06252999005b","modified":1557584774948},{"_id":"themes/next/source/lib/pace/.git/packed-refs","hash":"a04f762b5ecb138fde3c5f6107d05494d8e4c905","modified":1556202421972},{"_id":"themes/next/source/lib/pace/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1556202421981},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","hash":"41ea797c68dbcff2f6fb3aba1d1043a22e7cc0f6","modified":1557981345199},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"a817b6c158cbc5bab3582713de9fe18a18a80552","modified":1557981345200},{"_id":"themes/next/source/lib/Han/dist/han.css","hash":"6c26cdb36687d4f0a11dabf5290a909c3506be5c","modified":1557981345084},{"_id":"themes/next/source/lib/Han/dist/han.js","hash":"4ac683b2bc8531c84d98f51b86957be0e6f830f3","modified":1557981345086},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1514748788000},{"_id":"themes/next/source/lib/velocity/velocity.js","hash":"4237c6e9d59da349639de20e559e87c2c0218cfd","modified":1557981345205},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"9f73c4696f0907aa451a855444f88fc0698fa472","modified":1557981344726},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"53cde051e0337f4bf42fb8d6d7a79fa3fa6d4ef2","modified":1557981344728},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d63e0cacc53dd375fcc113465a4328c59ff5f2c1","modified":1557981344729},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"1a0d059799a298fe17c49a44298d32cebde93785","modified":1557981344730},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"0656e753f182c9f47fef7304c847b7587a85ef0d","modified":1557981344731},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"1727702eac5d326b5c81a667944a245016668231","modified":1557981344734},{"_id":"themes/next/source/css/_common/components/highlight/diff.styl","hash":"167986d0f649516671ddf7193eebba7b421cd115","modified":1557981344735},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"50450d9fdc8a2b2be8cfca51e3e1a01ffd636c0b","modified":1557981344737},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"7fe4d4d656e86276c17cb4e48a560cb6a4def703","modified":1557981344738},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"b6f3a06a94a6ee5470c956663164d58eda818a64","modified":1557981344740},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"7fb593f90d74a99c21840679933b9ef6fdc16a61","modified":1557981344750},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"f9760ecf186954cee3ba4a149be334e9ba296b89","modified":1557981344752},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"4e3838d7ac81d9ad133960f0f7ed58a44a015285","modified":1557981344753},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"8cf318644acc8b4978537c263290363e21c7f5af","modified":1557981344754},{"_id":"themes/next/source/css/_common/components/post/my-post-copyright.styl","hash":"d5ce2f3c7b3ca46d37f51189f992bedbe34d0eba","modified":1557981344771},{"_id":"themes/next/source/css/_common/components/post/post-button.styl","hash":"62fbbd32cf5a99ae550c45c763a2c4813a138d01","modified":1557981344772},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"875cbe88d5c7f6248990e2beb97c9828920e7e24","modified":1557981344773},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"caf263d1928496688c0e1419801eafd7e6919ce5","modified":1557981344775},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"a200c0a1c5a895ac9dc41e0641a5dfcd766be99b","modified":1557981344776},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"a6c6eb8adba0a090ad1f4b9124e866887f20d10d","modified":1557981344779},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"cd9e214e502697f2f2db84eb721bac57a49b0fce","modified":1557981344780},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"d0d7a5c90d62b685520d2b47fea8ba6019ff5402","modified":1557981344781},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"27deb3d3a243d30022055dac7dad851024099a8b","modified":1557981344782},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"ca88ea6999a61fb905eb6e72eba5f92d4ee31e6e","modified":1557981344783},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"b2495ae5e04dcca610aacadc47881d9e716cd440","modified":1557981344784},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"5a982d8ef3b3623ea5f59e63728990f5623c1b57","modified":1557981344785},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"ccb34c52be8adba5996c6b94f9e723bd07d34c16","modified":1557981344786},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"01567edaea6978628aa5521a122a85434c418bfd","modified":1557981344787},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"7968343e41f8b94b318c36289dff1196c3eb1791","modified":1557981344790},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"c38c1af844d1747c9807b986252585d841fcaae8","modified":1557981344791},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"39f04c4c7237a4e10acd3002331992b79945d241","modified":1557981344793},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"7c7764eb789552d55979b991580d33e2493f699e","modified":1557981344795},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"8dd9a1c6f4f6baa00c2cf01837e7617120cf9660","modified":1557981344796},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-dimmer.styl","hash":"11c22f0fb3f6beb13e5a425ec064a4ff974c13b7","modified":1557981344797},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"61f8cea3c01acd600e90e1bc2a07def405503748","modified":1557981344798},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"1153bb71edf253765145559674390e16dd67c633","modified":1557981344800},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"c8fe49a4bc014c24dead05b782a7082411a4abc5","modified":1557981344803},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"a1521d48bb06d8d703753f52a198baa197af7da2","modified":1557981344806},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"5ef6343835f484a2c0770bd1eb9cc443609e4c39","modified":1557981344823},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"e71652d3216e289c8548b1ea2357822c1476a425","modified":1557981344824},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"2fe76476432b31993338cb45cdb3b29a518b6379","modified":1557981344833},{"_id":"themes/next/source/css/_common/components/tags/exturl.styl","hash":"a3bdd71237afc112b2aa255f278cab6baeb25351","modified":1557981344835},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"f825da191816eef69ea8efb498a7f756d5ebb498","modified":1557981344837},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"2ad1a2a9bbf6742d1b0762c4c623b68113d1e0fe","modified":1557981344839},{"_id":"themes/next/source/css/_common/components/tags/label.styl","hash":"2ab1322fe52ab5aafd49e68f5bd890e8380ee927","modified":1557981344840},{"_id":"themes/next/source/css/_common/components/tags/note-modern.styl","hash":"b7076e58d647265ee0ad2b461fe8ce72c9373bc5","modified":1557981344841},{"_id":"themes/next/source/css/_common/components/tags/note.styl","hash":"9a409b798decdefdaf7a23f0b11004a8c27e82f3","modified":1557981344846},{"_id":"themes/next/source/css/_common/components/tags/tabs.styl","hash":"154a87a32d2fead480d5e909c37f6c476671c5e6","modified":1557981344847},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"b80604868e4f5cf20fccafd7ee415c20c804f700","modified":1557981344852},{"_id":"themes/next/source/css/_common/components/third-party/algolia-search.styl","hash":"bba4f3bdb7517cd85376df3e1209b570c0548c69","modified":1557981344861},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"5dbeed535d63a50265d96b396a5440f9bb31e4ba","modified":1557981344865},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"a6e7d698702c2e383dde3fde2abde27951679084","modified":1557981344866},{"_id":"themes/next/source/css/_common/components/third-party/duoshuo.styl","hash":"717cc7f82be9cc151e23a7678601ff2fd3a7fa1d","modified":1557981344872},{"_id":"themes/next/source/css/_common/components/third-party/gitment.styl","hash":"874278147115601d2abf15987f5f7a84ada1ac6b","modified":1557981344873},{"_id":"themes/next/source/css/_common/components/third-party/han.styl","hash":"10599e16414a8b7a76c4e79e6617b5fe3d4d1adf","modified":1557981344874},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"15975ba7456b96916b1dbac448a1a0d2c38b8f3d","modified":1557981344875},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"16087276945fa038f199692e3eabb1c52b8ea633","modified":1557981344877},{"_id":"themes/next/source/css/_common/components/third-party/needsharebutton.styl","hash":"28825ae15fa20ae3942cdaa7bcc1f3523ce59acc","modified":1557981344878},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"9c8196394a89dfa40b87bf0019e80144365a9c93","modified":1557981344879},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"a07aa12cc36ac5c819670c2a3c17d07ed7a08986","modified":1557981344934},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"1f09be9bb38411f0629b58c3b23873589a6dbcaa","modified":1557981344936},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"1f09be9bb38411f0629b58c3b23873589a6dbcaa","modified":1557981344947},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","hash":"07436f011b44051f61b8329c99de4bec64e86f4b","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","hash":"7a635062b10bf5662ae1d218ba0980171005d060","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","hash":"f1f6bb8f461f5672e000380195d3d2358a28494c","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","hash":"f38ff9b2eecaa17b50b66aa2dae87e9e7436d195","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/font/han.woff2","hash":"623af3ed5423371ac136a4fe0e8cc7bb7396037a","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"6394c48092085788a8c0ef72670b0652006231a1","modified":1557981345122},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"ee948b4489aedeb548a77c9e45d8c7c5732fd62d","modified":1557981345123},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"51139a4c79573d372a347ef01a493222a1eaf10a","modified":1557981345124},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"b88b589f5f1aa1b3d87cc7eef34c281ff749b1ae","modified":1557981345126},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"d22b1629cb23a6181bebb70d0cf653ffe4b835c8","modified":1557981345127},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1514748788000},{"_id":"themes/next/source/lib/pace/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1556202418160},{"_id":"themes/next/source/lib/pace/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1556202418159},{"_id":"themes/next/source/lib/pace/.git/hooks/fsmonitor-watchman.sample","hash":"f7c0aa40cb0d620ff0bca3efe3521ec79e5d7156","modified":1556202418160},{"_id":"themes/next/source/lib/pace/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1556202418160},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1556202418162},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1556202418159},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1556202418162},{"_id":"themes/next/source/lib/pace/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1556202418158},{"_id":"themes/next/source/lib/pace/.git/logs/HEAD","hash":"a1e96ae1aa3f38847271435b43d48051e481f5a3","modified":1556202421976},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1514748788000},{"_id":"themes/next/source/lib/pace/.git/objects/00/13175fe71888324d9142744034e8296501174a","hash":"0ad0e50f7fe91fe14491924aa4b1e2e8f060a5cd","modified":1556202421954},{"_id":"themes/next/source/lib/pace/.git/objects/0c/dada082d621dbfdd00f7020c33dc751129167f","hash":"b490c11cdefde6b331a7d4ddb055e34ad08459d8","modified":1556202421952},{"_id":"themes/next/source/lib/pace/.git/objects/1c/159365320ef5dde63906912f3df067376b40d0","hash":"1dd6b7373c3f9c67e34aa319c9c08fd0f667156a","modified":1556202421962},{"_id":"themes/next/source/lib/pace/.git/objects/23/4f9b3e93f06a85cb2ec01acc872ccdc2bec7cb","hash":"63f8640eceff35a80175a102fcbd8789e690cfaa","modified":1556202421962},{"_id":"themes/next/source/lib/pace/.git/objects/2f/9eba51ec174b1e0c719d12cafa7c3c07140471","hash":"fc994d9d8b3b21ec7c941eea7e3862970e297e9b","modified":1556202421952},{"_id":"themes/next/source/lib/pace/.git/objects/35/a749d823ad0aae6111a76dc501a1170478f376","hash":"e757129fb6bca3170b62b05f3e850e4b55f3ae88","modified":1556202421961},{"_id":"themes/next/source/lib/pace/.git/objects/3e/dcd352d2a1a60dbb6a43e7e9f00bab8b55791a","hash":"725bf5094855cd943dd1cd351906fb1ebec1d861","modified":1556202421955},{"_id":"themes/next/source/lib/pace/.git/objects/41/28e69301ad36a283c0fc523f3aef89644d2467","hash":"d8b985cf431fbdc5b4fa3be89e27db7a3437c920","modified":1556202421963},{"_id":"themes/next/source/lib/pace/.git/objects/49/0db22b657dd64430d003fe2831905a54858b22","hash":"43694656c4c331cfa3667afca630bd486ac0d0fe","modified":1556202421959},{"_id":"themes/next/source/lib/pace/.git/objects/4d/fbb499a4f7b2f26a535c335cd66c966ff8b261","hash":"14e4cdcc137045c7efed32f796273d40c9fcef87","modified":1556202421960},{"_id":"themes/next/source/lib/pace/.git/objects/53/3d55db0342c2b011ac05703c3b42e88a25c1ed","hash":"c48454760d2e04602a5499188b33d38839c58aee","modified":1556202421960},{"_id":"themes/next/source/lib/pace/.git/objects/60/0378418401f2b0e7c58407a7bbc5a5196cfa51","hash":"20489d796247dda758599f40cbfcf14d194ef64a","modified":1556202421949},{"_id":"themes/next/source/lib/pace/.git/objects/61/fcbe3a99ad371eacdf3a3703883f8e95e072c8","hash":"480b60d684f9a077ade5dda0acfc75bcd9597aff","modified":1556202421951},{"_id":"themes/next/source/lib/pace/.git/objects/69/a20d65d83035fdb01734a8eabe3340f740a4cb","hash":"9e95b02d8e43ec92e06bee3f60dffb74e8e7b9fa","modified":1556202421953},{"_id":"themes/next/source/lib/pace/.git/objects/82/8dcba3c8a21de08d1eb38f2eee453b51543188","hash":"629aad2ee2e564790e78cd46e99ad396544960ab","modified":1556202421956},{"_id":"themes/next/source/lib/pace/.git/objects/84/a17ac7b4fe9cea559de91f00af88f810bff7f1","hash":"b41b6d3cbccd75b711f0523bba1c26bf19b0a862","modified":1556202421948},{"_id":"themes/next/source/lib/pace/.git/objects/8b/b4535a79cc15127f8906b24c4e0bb4a38a5947","hash":"9c2d65a63f18929b09f3592dda064f24309ff98b","modified":1556202421957},{"_id":"themes/next/source/lib/pace/.git/objects/97/1e8a1f2ad6d45f693980c106af0aead9d1c215","hash":"e45f0963920a53a57f6b53d178e5b05a8e315189","modified":1556202421954},{"_id":"themes/next/source/lib/pace/.git/objects/9b/3058068409f2282607ebb91717d7a6a1406230","hash":"651c5857021e11dc397df86dbe0f01e6c7dc7f16","modified":1556202421958},{"_id":"themes/next/source/lib/pace/.git/objects/a6/dbd9c99e726f621e2bdcd3c6fe2795a5d4272d","hash":"25350dd31f504af7206610ced355d162aabda8dd","modified":1556202421958},{"_id":"themes/next/source/lib/pace/.git/objects/aa/813c5a6398600e01b740696cd889eb3becad84","hash":"c62a1513ca820dc59fe1cd6d9ec16c92e0e2fbf0","modified":1556202421950},{"_id":"themes/next/source/lib/pace/.git/objects/c0/05c71f1a000d8187df58083d215c962d7f5505","hash":"dffd212ca2ec705233fabe82a6f483d6be4b151d","modified":1556202421957},{"_id":"themes/next/source/lib/pace/.git/objects/da/79363b808519d44a7eda67d7bc81e1587a06e8","hash":"0dc5dc27991da9a09d705e488bc3f1fe5a4d4728","modified":1556202421947},{"_id":"themes/next/source/lib/pace/.git/objects/de/79ab6539ac3702aaac64b879d95e6575f4eefa","hash":"0046fefd52ed4679e0fee757cc91ced94e3ddc12","modified":1556202421963},{"_id":"themes/next/source/lib/pace/.git/objects/f3/0e0a99bb016267bde55537dd47b3657ae59544","hash":"8bf0bc17a6111b6a82981073133f33cc8e815c41","modified":1556202421955},{"_id":"themes/next/source/lib/pace/.git/refs/heads/master","hash":"2cf353bc3f5e2816a3a0e05d3f154a777200f091","modified":1556202421976},{"_id":"source/_posts/phpMyAdmin搭建/6.png","hash":"e5f1230ee77aeba32f983d3878be427212022f48","modified":1556263552536},{"_id":"themes/next/source/lib/pace/.git/logs/refs/heads/master","hash":"a1e96ae1aa3f38847271435b43d48051e481f5a3","modified":1556202421976},{"_id":"themes/next/source/lib/pace/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1556202421974},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","hash":"90a1b22129efc172e2dfcceeeb76bff58bc3192f","modified":1557981345095},{"_id":"themes/next/source/lib/pace/.git/logs/refs/remotes/origin/HEAD","hash":"a1e96ae1aa3f38847271435b43d48051e481f5a3","modified":1556202421974},{"_id":"themes/next/source/lib/three/three.min.js","hash":"26273b1cb4914850a89529b48091dc584f2c57b8","modified":1557981345194},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"b5483b11f8ba213e733b5b8af9927a04fec996f6","modified":1557981345160},{"_id":"source/_posts/saltstack状态判断unless与onlyif.md","hash":"240dd680934dd70ca01bca726f95255a6d9caacb","modified":1558080253094},{"_id":"themes/next/source/images/avatar3.png","hash":"5b475bcde35a71d593059d4ca27d4c005bdfa180","modified":1558064241750},{"_id":"source/_posts/phpRedisAdmin搭建.md","hash":"0a55ef2943baf11a51fa9bfc5b1608a631e5e1b8","modified":1558082944957}],"Category":[{"name":"Shell","_id":"cjvqprtzv0003zt34tumwvx9o"},{"name":"Linux","_id":"cjvqpru000008zt34jwxt4a8s"},{"name":"Linux运维日常","_id":"cjvqpru04000fzt34tk43e4tl"},{"name":"Saltstack","_id":"cjvqpru0c000pzt34vhcn2vvx"}],"Data":[],"Page":[{"title":"photos","date":"2019-04-22T16:36:22.000Z","type":"photos","_content":"","source":"photos/index.md","raw":"---\ntitle: photos\ndate: 2019-04-23 00:36:22\ntype: photos\n---\n","updated":"2019-05-16T04:35:44.314Z","path":"photos/index.html","_id":"cjvqprtzs0001zt34iw6swx8n","comments":1,"layout":"page","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"分类","date":"2019-04-22T12:36:46.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\ndate: 2019-04-22 20:36:46\ntype: \"categories\"\n---\n","updated":"2019-05-16T04:35:44.312Z","path":"categories/index.html","_id":"cjvqpru4i000uzt34ybdt2zek","comments":1,"layout":"page","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"标签","date":"2019-04-22T11:56:18.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\ndate: 2019-04-22 19:56:18\ntype: \"tags\"\n---\n","updated":"2019-05-16T04:35:44.316Z","path":"tags/index.html","_id":"cjvqpru4k000wzt34v91azqrg","comments":1,"layout":"page","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"MySQL自动备份脚本","date":"2019-04-24T09:56:56.000Z","copyright":true,"_content":"\n##### 通过 shell 脚本定时备份数据库，并定时清理\n`ceshi yixia `\n\n```html\n#!/bin/bash\n#Desc:本地数据库备份脚本\n#Date:2017-12-24\n#by:Lee-YJ\n#运行脚本前先创建一个备份用户，并授予权限\n#mysql> grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";\n#mysql> flush privileges;\n\nmysqluser=back                    #用于数据库备份的用户名\nmysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码\nmysqlhost=127.0.0.1               #连接数据库的host\nbakpath=/opt/data/Back/DBbak          #备份数据库存放的路径\n\nbakdate=`date '+%Y%m%d'`\nbaktime=`date '+%H%M'`\n\n#----------------------------获取mysql中的数据库名---------------------------------\n/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test > /tmp/DBname\n\n#----------------------------数据库备份--mysqldump备份------------------------------\n\nif [ ! -d \"$bakpath\" ];then\n    mkdir -p $bakpath\nfi\n\ncd $bakpath\n\nif [ ! -d \"$bakdate\" ];then\n    mkdir $bakdate\nfi\n\ncd $bakdate\n\necho \"------------------------$bakdate$baktime-------------------------------------\" >> $bakpath/DBbak.log\nfor DBname in `cat /tmp/DBname`;do\n    if [ ! -d \"$DBname\" ];then\n        mkdir $DBname\n    fi\n    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  > $DBname/$baktime\\.sql\n    if [ $? = 0 ];then\n        echo \"$DBname Back OK!\" >> $bakpath/DBbak.log\n    else\n        echo \"$DBname Back ERROR!\" >> $bakpath/DBbak.log\n    fi\ndone\necho \"\" >> $bakpath/DBbak.log \n\n\n#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------\nshopt -s extglob\nolddate=`date '+%Y%m%d' -d \"-6 days\"`\ncd $bakpath/$olddate\nfor deldbname in `ls $bakpath/$olddate`;do\n    cd $deldbname\n    file=`ls| sort -R | head -n1`\n    rm -f !($file)\ndone\n\nif [ ! -d \"$bakpath/Oldest\" ];then\n    mkdir -p $bakpath/Oldest\nfi\n\nmv $bakpath/$olddate $bakpath/Oldest/\n\nrm -f /tmp/DBname\n\n\n\n```\n\n","source":"_posts/MySQL自动备份脚本.md","raw":"---\ntitle: MySQL自动备份脚本\ndate: 2019-04-24 17:56:56\ntags: Linux运维日常\ncategories: Shell\ncopyright: true\n---\n\n##### 通过 shell 脚本定时备份数据库，并定时清理\n`ceshi yixia `\n\n```html\n#!/bin/bash\n#Desc:本地数据库备份脚本\n#Date:2017-12-24\n#by:Lee-YJ\n#运行脚本前先创建一个备份用户，并授予权限\n#mysql> grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";\n#mysql> flush privileges;\n\nmysqluser=back                    #用于数据库备份的用户名\nmysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码\nmysqlhost=127.0.0.1               #连接数据库的host\nbakpath=/opt/data/Back/DBbak          #备份数据库存放的路径\n\nbakdate=`date '+%Y%m%d'`\nbaktime=`date '+%H%M'`\n\n#----------------------------获取mysql中的数据库名---------------------------------\n/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test > /tmp/DBname\n\n#----------------------------数据库备份--mysqldump备份------------------------------\n\nif [ ! -d \"$bakpath\" ];then\n    mkdir -p $bakpath\nfi\n\ncd $bakpath\n\nif [ ! -d \"$bakdate\" ];then\n    mkdir $bakdate\nfi\n\ncd $bakdate\n\necho \"------------------------$bakdate$baktime-------------------------------------\" >> $bakpath/DBbak.log\nfor DBname in `cat /tmp/DBname`;do\n    if [ ! -d \"$DBname\" ];then\n        mkdir $DBname\n    fi\n    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  > $DBname/$baktime\\.sql\n    if [ $? = 0 ];then\n        echo \"$DBname Back OK!\" >> $bakpath/DBbak.log\n    else\n        echo \"$DBname Back ERROR!\" >> $bakpath/DBbak.log\n    fi\ndone\necho \"\" >> $bakpath/DBbak.log \n\n\n#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------\nshopt -s extglob\nolddate=`date '+%Y%m%d' -d \"-6 days\"`\ncd $bakpath/$olddate\nfor deldbname in `ls $bakpath/$olddate`;do\n    cd $deldbname\n    file=`ls| sort -R | head -n1`\n    rm -f !($file)\ndone\n\nif [ ! -d \"$bakpath/Oldest\" ];then\n    mkdir -p $bakpath/Oldest\nfi\n\nmv $bakpath/$olddate $bakpath/Oldest/\n\nrm -f /tmp/DBname\n\n\n\n```\n\n","slug":"MySQL自动备份脚本","published":1,"updated":"2019-05-16T04:35:44.290Z","_id":"cjvqprtzn0000zt34v7lyxe7s","comments":1,"layout":"post","photos":[],"link":"","content":"<h5 id=\"通过-shell-脚本定时备份数据库，并定时清理\"><a href=\"#通过-shell-脚本定时备份数据库，并定时清理\" class=\"headerlink\" title=\"通过 shell 脚本定时备份数据库，并定时清理\"></a>通过 shell 脚本定时备份数据库，并定时清理</h5><p><code>ceshi yixia</code></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">#Desc:本地数据库备份脚本</span><br><span class=\"line\">#Date:2017-12-24</span><br><span class=\"line\">#by:Lee-YJ</span><br><span class=\"line\">#运行脚本前先创建一个备份用户，并授予权限</span><br><span class=\"line\">#mysql&gt; grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";</span><br><span class=\"line\">#mysql&gt; flush privileges;</span><br><span class=\"line\"></span><br><span class=\"line\">mysqluser=back                    #用于数据库备份的用户名</span><br><span class=\"line\">mysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码</span><br><span class=\"line\">mysqlhost=127.0.0.1               #连接数据库的host</span><br><span class=\"line\">bakpath=/opt/data/Back/DBbak          #备份数据库存放的路径</span><br><span class=\"line\"></span><br><span class=\"line\">bakdate=`date '+%Y%m%d'`</span><br><span class=\"line\">baktime=`date '+%H%M'`</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------获取mysql中的数据库名---------------------------------</span><br><span class=\"line\">/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test &gt; /tmp/DBname</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------数据库备份--mysqldump备份------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakpath</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakdate\" ];then</span><br><span class=\"line\">    mkdir $bakdate</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakdate</span><br><span class=\"line\"></span><br><span class=\"line\">echo \"------------------------$bakdate$baktime-------------------------------------\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">for DBname in `cat /tmp/DBname`;do</span><br><span class=\"line\">    if [ ! -d \"$DBname\" ];then</span><br><span class=\"line\">        mkdir $DBname</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  &gt; $DBname/$baktime\\.sql</span><br><span class=\"line\">    if [ $? = 0 ];then</span><br><span class=\"line\">        echo \"$DBname Back OK!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"$DBname Back ERROR!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    fi</span><br><span class=\"line\">done</span><br><span class=\"line\">echo \"\" &gt;&gt; $bakpath/DBbak.log </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------</span><br><span class=\"line\">shopt -s extglob</span><br><span class=\"line\">olddate=`date '+%Y%m%d' -d \"-6 days\"`</span><br><span class=\"line\">cd $bakpath/$olddate</span><br><span class=\"line\">for deldbname in `ls $bakpath/$olddate`;do</span><br><span class=\"line\">    cd $deldbname</span><br><span class=\"line\">    file=`ls| sort -R | head -n1`</span><br><span class=\"line\">    rm -f !($file)</span><br><span class=\"line\">done</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath/Oldest\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath/Oldest</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">mv $bakpath/$olddate $bakpath/Oldest/</span><br><span class=\"line\"></span><br><span class=\"line\">rm -f /tmp/DBname</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h5 id=\"通过-shell-脚本定时备份数据库，并定时清理\"><a href=\"#通过-shell-脚本定时备份数据库，并定时清理\" class=\"headerlink\" title=\"通过 shell 脚本定时备份数据库，并定时清理\"></a>通过 shell 脚本定时备份数据库，并定时清理</h5><p><code>ceshi yixia</code></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">#Desc:本地数据库备份脚本</span><br><span class=\"line\">#Date:2017-12-24</span><br><span class=\"line\">#by:Lee-YJ</span><br><span class=\"line\">#运行脚本前先创建一个备份用户，并授予权限</span><br><span class=\"line\">#mysql&gt; grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";</span><br><span class=\"line\">#mysql&gt; flush privileges;</span><br><span class=\"line\"></span><br><span class=\"line\">mysqluser=back                    #用于数据库备份的用户名</span><br><span class=\"line\">mysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码</span><br><span class=\"line\">mysqlhost=127.0.0.1               #连接数据库的host</span><br><span class=\"line\">bakpath=/opt/data/Back/DBbak          #备份数据库存放的路径</span><br><span class=\"line\"></span><br><span class=\"line\">bakdate=`date '+%Y%m%d'`</span><br><span class=\"line\">baktime=`date '+%H%M'`</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------获取mysql中的数据库名---------------------------------</span><br><span class=\"line\">/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test &gt; /tmp/DBname</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------数据库备份--mysqldump备份------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakpath</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakdate\" ];then</span><br><span class=\"line\">    mkdir $bakdate</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakdate</span><br><span class=\"line\"></span><br><span class=\"line\">echo \"------------------------$bakdate$baktime-------------------------------------\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">for DBname in `cat /tmp/DBname`;do</span><br><span class=\"line\">    if [ ! -d \"$DBname\" ];then</span><br><span class=\"line\">        mkdir $DBname</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  &gt; $DBname/$baktime\\.sql</span><br><span class=\"line\">    if [ $? = 0 ];then</span><br><span class=\"line\">        echo \"$DBname Back OK!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"$DBname Back ERROR!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    fi</span><br><span class=\"line\">done</span><br><span class=\"line\">echo \"\" &gt;&gt; $bakpath/DBbak.log </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------</span><br><span class=\"line\">shopt -s extglob</span><br><span class=\"line\">olddate=`date '+%Y%m%d' -d \"-6 days\"`</span><br><span class=\"line\">cd $bakpath/$olddate</span><br><span class=\"line\">for deldbname in `ls $bakpath/$olddate`;do</span><br><span class=\"line\">    cd $deldbname</span><br><span class=\"line\">    file=`ls| sort -R | head -n1`</span><br><span class=\"line\">    rm -f !($file)</span><br><span class=\"line\">done</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath/Oldest\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath/Oldest</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">mv $bakpath/$olddate $bakpath/Oldest/</span><br><span class=\"line\"></span><br><span class=\"line\">rm -f /tmp/DBname</span><br></pre></td></tr></table></figure>\n"},{"title":"ftp虚拟用户","date":"2019-04-23T14:30:00.000Z","copyright":true,"_content":"### 需求：\n进（账户）\\\nusername: ftpComeSsbq\\\npassword: ftp_come_#@UkieO9\\\n上传文件的目录：/opt/ftp/come\n\n出（账户）\\\nusername: ftpOutSsbq\\\npassword: ftp_out_#@45oUkie\\\n上床文件的目录：/opt/ftp/out\n\n### 具体步骤\n\n1 安装软件\n```\n# yum -y install vsftpd\n```\n2 创建相应的ftp数据目录\n```\n# mkdir -p /opt/ftp/{come,out}\n```\n3 创建一个用户提供给虚拟用户使用\n```\n# useradd -s /sbin/nologin virtual\n```\n4 将ftp数据目录设置成virtual用户\n```\n# chown virtual. /opt/ftp/ -R\n# ll /opt/ftp/\ntotal 8\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 come\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 out\n```\n5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)\n```\n# vim /etc/vsftpd/logins.txt\nftpComeSsbq\nftp_come_#@UkieO9\nftpOutSsbq\nftp_out_#@45oUkie\n```\n6 将创建好的密码文件txt格式转换db格式\n```\n# db_load -T -t hash -f /etc/vsftpd/logins.txt /etc/vsftpd/login.db\n```\n7 定义db文件的权限\n```\n# chmod 600 /etc/vsftpd/login.db\n```\n8 定义pam认证文件\n```\n# vim /etc/pam.d/ftp\nauth  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\naccount  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\n```\n9 配置vsftpd主配置文件\n```\n# cp /etc/vsftpd/vsftpd.conf{,.bak}\n# vim /etc/vsftpd/vsftpd.conf\n#禁止匿名登录FTP服务器\nanonymous_enable=NO\n#允许本地用户登录FTP服务器\nlocal_enable=YES\n#可以上传(全局控制) \nwrite_enable=NO\n#匿名用户可以上传\nanon_upload_enable=NO\n#匿名用户可以建目录\nanon_mkdir_write_enable=NO\n#匿名用户修改删除\nanon_other_write_enable=NO\n#全部用户被限制在主目录\nchroot_local_user=YES\n#将所有用户看成虚拟用户guest\nguest_enable=YES\n#指定虚拟用户，也就是将guest用户映射到virtual用户\nguest_username=virtual\n#指定为独立服务\nlisten=YES\n#指定监听的端口\nlisten_port=21\n#开启被动模式\npasv_enable=YES\n#FTP服务器公网IP\npasv_address=120.79.93.66\n#设置被动模式下，建立数据传输可使用port范围的最小值\npasv_min_port=10000\n#设置被动模式下，建立数据传输可使用port范围的最大值\npasv_max_port=10088\n#是否允许匿名用户下载全局可读的文件\nanon_world_readable_only=NO\n#指定虚拟用户配置文件的路径\nuser_config_dir=/etc/vsftpd/user_conf\n```\n10 创建上面配置文件中指定的子配置文件目录 user_conf\n```\n# mkdir /etc/vsftpd/user_conf\n```\n11 定义 ftpComeSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpComeSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/come\n```\n12 定义 ftpOutSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpOutSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/out\n```\n13 启动vsftpd\n```\n# service vsftpd start\n```\n14 测试\n...\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/ftp虚拟用户.md","raw":"---\ntitle: ftp虚拟用户\ndate: 2019-04-23 22:30:00\ntags: Linux运维日常\ncategories: Linux\ncopyright: true\n---\n### 需求：\n进（账户）\\\nusername: ftpComeSsbq\\\npassword: ftp_come_#@UkieO9\\\n上传文件的目录：/opt/ftp/come\n\n出（账户）\\\nusername: ftpOutSsbq\\\npassword: ftp_out_#@45oUkie\\\n上床文件的目录：/opt/ftp/out\n\n### 具体步骤\n\n1 安装软件\n```\n# yum -y install vsftpd\n```\n2 创建相应的ftp数据目录\n```\n# mkdir -p /opt/ftp/{come,out}\n```\n3 创建一个用户提供给虚拟用户使用\n```\n# useradd -s /sbin/nologin virtual\n```\n4 将ftp数据目录设置成virtual用户\n```\n# chown virtual. /opt/ftp/ -R\n# ll /opt/ftp/\ntotal 8\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 come\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 out\n```\n5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)\n```\n# vim /etc/vsftpd/logins.txt\nftpComeSsbq\nftp_come_#@UkieO9\nftpOutSsbq\nftp_out_#@45oUkie\n```\n6 将创建好的密码文件txt格式转换db格式\n```\n# db_load -T -t hash -f /etc/vsftpd/logins.txt /etc/vsftpd/login.db\n```\n7 定义db文件的权限\n```\n# chmod 600 /etc/vsftpd/login.db\n```\n8 定义pam认证文件\n```\n# vim /etc/pam.d/ftp\nauth  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\naccount  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\n```\n9 配置vsftpd主配置文件\n```\n# cp /etc/vsftpd/vsftpd.conf{,.bak}\n# vim /etc/vsftpd/vsftpd.conf\n#禁止匿名登录FTP服务器\nanonymous_enable=NO\n#允许本地用户登录FTP服务器\nlocal_enable=YES\n#可以上传(全局控制) \nwrite_enable=NO\n#匿名用户可以上传\nanon_upload_enable=NO\n#匿名用户可以建目录\nanon_mkdir_write_enable=NO\n#匿名用户修改删除\nanon_other_write_enable=NO\n#全部用户被限制在主目录\nchroot_local_user=YES\n#将所有用户看成虚拟用户guest\nguest_enable=YES\n#指定虚拟用户，也就是将guest用户映射到virtual用户\nguest_username=virtual\n#指定为独立服务\nlisten=YES\n#指定监听的端口\nlisten_port=21\n#开启被动模式\npasv_enable=YES\n#FTP服务器公网IP\npasv_address=120.79.93.66\n#设置被动模式下，建立数据传输可使用port范围的最小值\npasv_min_port=10000\n#设置被动模式下，建立数据传输可使用port范围的最大值\npasv_max_port=10088\n#是否允许匿名用户下载全局可读的文件\nanon_world_readable_only=NO\n#指定虚拟用户配置文件的路径\nuser_config_dir=/etc/vsftpd/user_conf\n```\n10 创建上面配置文件中指定的子配置文件目录 user_conf\n```\n# mkdir /etc/vsftpd/user_conf\n```\n11 定义 ftpComeSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpComeSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/come\n```\n12 定义 ftpOutSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpOutSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/out\n```\n13 启动vsftpd\n```\n# service vsftpd start\n```\n14 测试\n...\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","slug":"ftp虚拟用户","published":1,"updated":"2019-05-16T04:35:44.291Z","_id":"cjvqprtzt0002zt34tbkn1z0b","comments":1,"layout":"post","photos":[],"link":"","content":"<h3 id=\"需求：\"><a href=\"#需求：\" class=\"headerlink\" title=\"需求：\"></a>需求：</h3><p>进（账户）\\<br>username: ftpComeSsbq\\<br>password: ftp<em>come</em>#@UkieO9\\<br>上传文件的目录：/opt/ftp/come</p>\n<p>出（账户）\\<br>username: ftpOutSsbq\\<br>password: ftp<em>out</em>#@45oUkie\\<br>上床文件的目录：/opt/ftp/out</p>\n<h3 id=\"具体步骤\"><a href=\"#具体步骤\" class=\"headerlink\" title=\"具体步骤\"></a>具体步骤</h3><p>1 安装软件<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install vsftpd</span></span><br></pre></td></tr></table></figure></p>\n<p>2 创建相应的ftp数据目录<br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># <span class=\"keyword\">mkdir</span> -p /opt/ftp/&#123;come,<span class=\"keyword\">out</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3 创建一个用户提供给虚拟用户使用<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># useradd -s /sbin/nologin virtual</span></span><br></pre></td></tr></table></figure></p>\n<p>4 将ftp数据目录设置成virtual用户<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># chown virtual. /opt/ftp/ -R</span></span><br><span class=\"line\"><span class=\"comment\"># ll /opt/ftp/</span></span><br><span class=\"line\">total 8</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 come</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 out</span><br></pre></td></tr></table></figure></p>\n<p>5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/logins.txt</span></span><br><span class=\"line\">ftpComeSsbq</span><br><span class=\"line\">ftp_come<span class=\"number\">_</span><span class=\"comment\">#<span class=\"doctag\">@UkieO</span>9</span></span><br><span class=\"line\">ftpOutSsbq</span><br><span class=\"line\">ftp_out<span class=\"number\">_</span><span class=\"comment\">#@45oUkie</span></span><br></pre></td></tr></table></figure></p>\n<p>6 将创建好的密码文件txt格式转换db格式<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># db_load -T -t hash -f <span class=\"regexp\">/etc/</span>vsftpd<span class=\"regexp\">/logins.txt /</span>etc<span class=\"regexp\">/vsftpd/</span>login.db</span><br></pre></td></tr></table></figure></p>\n<p>7 定义db文件的权限<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># chmod 600 /etc/vsftpd/login.db</span></span><br></pre></td></tr></table></figure></p>\n<p>8 定义pam认证文件<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/pam.d/ftp</span></span><br><span class=\"line\">auth  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br><span class=\"line\">account  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br></pre></td></tr></table></figure></p>\n<p>9 配置vsftpd主配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cp /etc/vsftpd/vsftpd.conf&#123;,.bak&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/vsftpd.conf</span></span><br><span class=\"line\"><span class=\"comment\">#禁止匿名登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">anonymous_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#允许本地用户登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">local_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#可以上传(全局控制) </span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以上传</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以建目录</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户修改删除</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#全部用户被限制在主目录</span></span><br><span class=\"line\"><span class=\"attr\">chroot_local_user</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#将所有用户看成虚拟用户guest</span></span><br><span class=\"line\"><span class=\"attr\">guest_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户，也就是将guest用户映射到virtual用户</span></span><br><span class=\"line\"><span class=\"attr\">guest_username</span>=virtual</span><br><span class=\"line\"><span class=\"comment\">#指定为独立服务</span></span><br><span class=\"line\"><span class=\"attr\">listen</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定监听的端口</span></span><br><span class=\"line\"><span class=\"attr\">listen_port</span>=<span class=\"number\">21</span></span><br><span class=\"line\"><span class=\"comment\">#开启被动模式</span></span><br><span class=\"line\"><span class=\"attr\">pasv_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#FTP服务器公网IP</span></span><br><span class=\"line\"><span class=\"attr\">pasv_address</span>=<span class=\"number\">120.79</span>.<span class=\"number\">93.66</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最小值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_min_port</span>=<span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最大值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_max_port</span>=<span class=\"number\">10088</span></span><br><span class=\"line\"><span class=\"comment\">#是否允许匿名用户下载全局可读的文件</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户配置文件的路径</span></span><br><span class=\"line\"><span class=\"attr\">user_config_dir</span>=/etc/vsftpd/user_conf</span><br></pre></td></tr></table></figure></p>\n<p>10 创建上面配置文件中指定的子配置文件目录 user_conf<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># mkdir /etc/vsftpd/user_conf</span></span><br></pre></td></tr></table></figure></p>\n<p>11 定义 ftpComeSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpComeSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/come</span><br></pre></td></tr></table></figure></p>\n<p>12 定义 ftpOutSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpOutSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/out</span><br></pre></td></tr></table></figure></p>\n<p>13 启动vsftpd<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># service vsftpd start</span></span><br></pre></td></tr></table></figure></p>\n<p>14 测试<br>…</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"需求：\"><a href=\"#需求：\" class=\"headerlink\" title=\"需求：\"></a>需求：</h3><p>进（账户）\\<br>username: ftpComeSsbq\\<br>password: ftp<em>come</em>#@UkieO9\\<br>上传文件的目录：/opt/ftp/come</p>\n<p>出（账户）\\<br>username: ftpOutSsbq\\<br>password: ftp<em>out</em>#@45oUkie\\<br>上床文件的目录：/opt/ftp/out</p>\n<h3 id=\"具体步骤\"><a href=\"#具体步骤\" class=\"headerlink\" title=\"具体步骤\"></a>具体步骤</h3><p>1 安装软件<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install vsftpd</span></span><br></pre></td></tr></table></figure></p>\n<p>2 创建相应的ftp数据目录<br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># <span class=\"keyword\">mkdir</span> -p /opt/ftp/&#123;come,<span class=\"keyword\">out</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3 创建一个用户提供给虚拟用户使用<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># useradd -s /sbin/nologin virtual</span></span><br></pre></td></tr></table></figure></p>\n<p>4 将ftp数据目录设置成virtual用户<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># chown virtual. /opt/ftp/ -R</span></span><br><span class=\"line\"><span class=\"comment\"># ll /opt/ftp/</span></span><br><span class=\"line\">total 8</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 come</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 out</span><br></pre></td></tr></table></figure></p>\n<p>5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/logins.txt</span></span><br><span class=\"line\">ftpComeSsbq</span><br><span class=\"line\">ftp_come<span class=\"number\">_</span><span class=\"comment\">#<span class=\"doctag\">@UkieO</span>9</span></span><br><span class=\"line\">ftpOutSsbq</span><br><span class=\"line\">ftp_out<span class=\"number\">_</span><span class=\"comment\">#@45oUkie</span></span><br></pre></td></tr></table></figure></p>\n<p>6 将创建好的密码文件txt格式转换db格式<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># db_load -T -t hash -f <span class=\"regexp\">/etc/</span>vsftpd<span class=\"regexp\">/logins.txt /</span>etc<span class=\"regexp\">/vsftpd/</span>login.db</span><br></pre></td></tr></table></figure></p>\n<p>7 定义db文件的权限<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># chmod 600 /etc/vsftpd/login.db</span></span><br></pre></td></tr></table></figure></p>\n<p>8 定义pam认证文件<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/pam.d/ftp</span></span><br><span class=\"line\">auth  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br><span class=\"line\">account  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br></pre></td></tr></table></figure></p>\n<p>9 配置vsftpd主配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cp /etc/vsftpd/vsftpd.conf&#123;,.bak&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/vsftpd.conf</span></span><br><span class=\"line\"><span class=\"comment\">#禁止匿名登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">anonymous_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#允许本地用户登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">local_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#可以上传(全局控制) </span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以上传</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以建目录</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户修改删除</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#全部用户被限制在主目录</span></span><br><span class=\"line\"><span class=\"attr\">chroot_local_user</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#将所有用户看成虚拟用户guest</span></span><br><span class=\"line\"><span class=\"attr\">guest_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户，也就是将guest用户映射到virtual用户</span></span><br><span class=\"line\"><span class=\"attr\">guest_username</span>=virtual</span><br><span class=\"line\"><span class=\"comment\">#指定为独立服务</span></span><br><span class=\"line\"><span class=\"attr\">listen</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定监听的端口</span></span><br><span class=\"line\"><span class=\"attr\">listen_port</span>=<span class=\"number\">21</span></span><br><span class=\"line\"><span class=\"comment\">#开启被动模式</span></span><br><span class=\"line\"><span class=\"attr\">pasv_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#FTP服务器公网IP</span></span><br><span class=\"line\"><span class=\"attr\">pasv_address</span>=<span class=\"number\">120.79</span>.<span class=\"number\">93.66</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最小值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_min_port</span>=<span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最大值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_max_port</span>=<span class=\"number\">10088</span></span><br><span class=\"line\"><span class=\"comment\">#是否允许匿名用户下载全局可读的文件</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户配置文件的路径</span></span><br><span class=\"line\"><span class=\"attr\">user_config_dir</span>=/etc/vsftpd/user_conf</span><br></pre></td></tr></table></figure></p>\n<p>10 创建上面配置文件中指定的子配置文件目录 user_conf<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># mkdir /etc/vsftpd/user_conf</span></span><br></pre></td></tr></table></figure></p>\n<p>11 定义 ftpComeSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpComeSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/come</span><br></pre></td></tr></table></figure></p>\n<p>12 定义 ftpOutSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpOutSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/out</span><br></pre></td></tr></table></figure></p>\n<p>13 启动vsftpd<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># service vsftpd start</span></span><br></pre></td></tr></table></figure></p>\n<p>14 测试<br>…</p>\n"},{"title":"linuxTools(小工具集合)","date":"2019-04-30T08:18:37.000Z","copyright":true,"_content":"###### Linux下常用的小工具集合（grep cut soft uniq tee paste tr diff wc du df)\n\n这是一个测试\n\n\n<<<<<<< HEAD\nmacshangmiances \n\n\n\n\nrwarsdfsdfsdfsdfsdf\n=======\n问我的是会\n\n\nmacshangmiances \n>>>>>>> f21331d96b6546d78eff355b4f327f7aff2af26c\n\n\n\n\n\n\n1111111111111111111111111\n\n222\n\n\n111","source":"_posts/linuxTools-小工具集合.md","raw":"---\ntitle: linuxTools(小工具集合)\ndate: 2019-04-30 16:18:37\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n###### Linux下常用的小工具集合（grep cut soft uniq tee paste tr diff wc du df)\n\n这是一个测试\n\n\n<<<<<<< HEAD\nmacshangmiances \n\n\n\n\nrwarsdfsdfsdfsdfsdf\n=======\n问我的是会\n\n\nmacshangmiances \n>>>>>>> f21331d96b6546d78eff355b4f327f7aff2af26c\n\n\n\n\n\n\n1111111111111111111111111\n\n222\n\n\n111","slug":"linuxTools-小工具集合","published":1,"updated":"2019-05-16T04:35:44.293Z","_id":"cjvqprtzx0005zt34qnllmvh1","comments":1,"layout":"post","photos":[],"link":"","content":"<h6 id=\"Linux下常用的小工具集合（grep-cut-soft-uniq-tee-paste-tr-diff-wc-du-df\"><a href=\"#Linux下常用的小工具集合（grep-cut-soft-uniq-tee-paste-tr-diff-wc-du-df\" class=\"headerlink\" title=\"Linux下常用的小工具集合（grep cut soft uniq tee paste tr diff wc du df)\"></a>Linux下常用的小工具集合（grep cut soft uniq tee paste tr diff wc du df)</h6><p>这是一个测试</p>\n<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD<br>macshangmiances </p>\n<h1 id=\"rwarsdfsdfsdfsdfsdf\"><a href=\"#rwarsdfsdfsdfsdfsdf\" class=\"headerlink\" title=\"rwarsdfsdfsdfsdfsdf\"></a>rwarsdfsdfsdfsdfsdf</h1><p>问我的是会</p>\n<p>macshangmiances </p>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>f21331d96b6546d78eff355b4f327f7aff2af26c</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<p>1111111111111111111111111</p>\n<p>222</p>\n<p>111</p>\n","site":{"data":{}},"excerpt":"","more":"<h6 id=\"Linux下常用的小工具集合（grep-cut-soft-uniq-tee-paste-tr-diff-wc-du-df\"><a href=\"#Linux下常用的小工具集合（grep-cut-soft-uniq-tee-paste-tr-diff-wc-du-df\" class=\"headerlink\" title=\"Linux下常用的小工具集合（grep cut soft uniq tee paste tr diff wc du df)\"></a>Linux下常用的小工具集合（grep cut soft uniq tee paste tr diff wc du df)</h6><p>这是一个测试</p>\n<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD<br>macshangmiances </p>\n<h1 id=\"rwarsdfsdfsdfsdfsdf\"><a href=\"#rwarsdfsdfsdfsdfsdf\" class=\"headerlink\" title=\"rwarsdfsdfsdfsdfsdf\"></a>rwarsdfsdfsdfsdfsdf</h1><p>问我的是会</p>\n<p>macshangmiances </p>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>f21331d96b6546d78eff355b4f327f7aff2af26c</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<p>1111111111111111111111111</p>\n<p>222</p>\n<p>111</p>\n"},{"title":"linux下解压windows上压缩rar包","date":"2019-04-30T05:48:55.000Z","copyright":true,"_content":"##### 下载\n``# wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz``\n##### 安装\n```\n# tar xvzf rarlinux-3.8.0.tar.gz\n# cd rar\n# make \n# make install\n```\n##### rar命令语法\n将 /etc 目录压缩为 etc.rar 命令为：\\\n``# rar a etc.rar /etc``\\\n将 etc.rar 解压 命令为：\\\n```\nrar x etc.rar\nunrar -e etc.rar\n```\n##### rar帮助手册\n```markdown\n# rar\n\nRAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008\nShareware version         Type RAR -? for help\n\nUsage:     rar <command> -<switch 1> -<switch N> <archive> <files...>\n               <@listfiles...> <path_to_extract\\>\n\n<Commands>\n  a             Add files to archive\n  c             Add archive comment\n  cf            Add files comment\n  ch            Change archive parameters\n  cw            Write archive comment to file\n  d             Delete files from archive\n  e             Extract files to current directory\n  f             Freshen files in archive\n  i[par]=<str>  Find string in archives\n  k             Lock archive\n  l[t,b]        List archive [technical, bare]\n  m[f]          Move to archive [files only]\n  p             Print file to stdout\n  r             Repair archive\n  rc            Reconstruct missing volumes\n  rn            Rename archived files\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[name|-]     Convert archive to or from SFX\n  t             Test archive files\n  u             Update files in archive\n  v[t,b]        Verbosely list archive [technical,bare]\n  x             Extract files with full path\n\n<Switches>\n  -             Stop switches scanning\n  ad            Append archive name to destination path\n  ag[format]    Generate archive name using the current date\n  ap<path>      Set path inside archive\n  as            Synchronize archive contents\n  av            Put authenticity verification (registered versions only)\n  av-           Disable authenticity verification check\n  c-            Disable comments show\n  cfg-          Disable read configuration\n  cl            Convert names to lower case\n  cu            Convert names to upper case\n  df            Delete files after archiving\n  dh            Open shared files\n  ds            Disable name sort for solid archive\n  dw            Wipe files after archiving\n  e[+]<attr>    Set file exclude and include attributes\n  ed            Do not add empty directories\n  en            Do not put 'end of archive' block\n  ep            Exclude paths from names\n  ep1           Exclude base directory from names\n  ep3           Expand paths to full including the drive letter\n  f             Freshen files\n  hp[password]  Encrypt both file data and headers\n  id[c,d,p,q]   Disable messages\n  ierr          Send all messages to stderr\n  ilog[name]    Log errors to file (registered versions only)\n  inul          Disable all messages\n  isnd          Enable sound\n  k             Lock archive\n  kb            Keep broken extracted files\n  m<0..5>       Set compression level (0-store...3-default...5-maximal)\n  mc<par>       Set advanced compression parameters\n  md<size>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)\n  ms[ext;ext]   Specify file types to store\n  n<file>       Include only specified file\n  n@            Read file names to include from stdin\n  n@<list>      Include files in specified list file\n  o[+|-]        Set the overwrite mode\n  ol            Save symbolic links as the link instead of the file\n  or            Rename files automatically\n  ow            Save or restore file owner and group\n  p[password]   Set password\n  p-            Do not query password\n  r             Recurse subdirectories\n  r0            Recurse subdirectories for wildcard names only\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[<N>,v[-],e] Create solid archive\n  s-            Disable solid archiving\n  sc<chr>[obj]  Specify the character set\n  sfx[name]     Create SFX archive\n  si[name]      Read data from standard input (stdin)\n  sl<size>      Process files with size less than specified\n  sm<size>      Process files with size more than specified\n  t             Test files after archiving\n  ta<date>      Process files modified after <date> in YYYYMMDDHHMMSS format\n  tb<date>      Process files modified before <date> in YYYYMMDDHHMMSS format\n  tk            Keep original archive time\n  tl            Set archive time to latest file\n  tn<time>      Process files newer than <time>\n  to<time>      Process files older than <time>\n  ts<m,c,a>[N]  Save or restore file time (modification, creation, access)\n  u             Update files\n  v             Create volumes with size autodetection or list all volumes\n  v<size>[k,b]  Create volumes with size=<size>*1000 [*1024, *1]\n  ver[n]        File version control\n  vn            Use the old style volume naming scheme\n  vp            Pause before each volume\n  w<path>       Assign work directory\n  x<file>       Exclude specified file\n  x@            Read file names to exclude from stdin\n  x@<list>      Exclude files in specified list file\n  y             Assume Yes on all queries\n  z[file]       Read archive comment from file\n```","source":"_posts/linux下解压windows上压缩rar包.md","raw":"---\ntitle: linux下解压windows上压缩rar包\ndate: 2019-04-30 13:48:55\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n##### 下载\n``# wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz``\n##### 安装\n```\n# tar xvzf rarlinux-3.8.0.tar.gz\n# cd rar\n# make \n# make install\n```\n##### rar命令语法\n将 /etc 目录压缩为 etc.rar 命令为：\\\n``# rar a etc.rar /etc``\\\n将 etc.rar 解压 命令为：\\\n```\nrar x etc.rar\nunrar -e etc.rar\n```\n##### rar帮助手册\n```markdown\n# rar\n\nRAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008\nShareware version         Type RAR -? for help\n\nUsage:     rar <command> -<switch 1> -<switch N> <archive> <files...>\n               <@listfiles...> <path_to_extract\\>\n\n<Commands>\n  a             Add files to archive\n  c             Add archive comment\n  cf            Add files comment\n  ch            Change archive parameters\n  cw            Write archive comment to file\n  d             Delete files from archive\n  e             Extract files to current directory\n  f             Freshen files in archive\n  i[par]=<str>  Find string in archives\n  k             Lock archive\n  l[t,b]        List archive [technical, bare]\n  m[f]          Move to archive [files only]\n  p             Print file to stdout\n  r             Repair archive\n  rc            Reconstruct missing volumes\n  rn            Rename archived files\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[name|-]     Convert archive to or from SFX\n  t             Test archive files\n  u             Update files in archive\n  v[t,b]        Verbosely list archive [technical,bare]\n  x             Extract files with full path\n\n<Switches>\n  -             Stop switches scanning\n  ad            Append archive name to destination path\n  ag[format]    Generate archive name using the current date\n  ap<path>      Set path inside archive\n  as            Synchronize archive contents\n  av            Put authenticity verification (registered versions only)\n  av-           Disable authenticity verification check\n  c-            Disable comments show\n  cfg-          Disable read configuration\n  cl            Convert names to lower case\n  cu            Convert names to upper case\n  df            Delete files after archiving\n  dh            Open shared files\n  ds            Disable name sort for solid archive\n  dw            Wipe files after archiving\n  e[+]<attr>    Set file exclude and include attributes\n  ed            Do not add empty directories\n  en            Do not put 'end of archive' block\n  ep            Exclude paths from names\n  ep1           Exclude base directory from names\n  ep3           Expand paths to full including the drive letter\n  f             Freshen files\n  hp[password]  Encrypt both file data and headers\n  id[c,d,p,q]   Disable messages\n  ierr          Send all messages to stderr\n  ilog[name]    Log errors to file (registered versions only)\n  inul          Disable all messages\n  isnd          Enable sound\n  k             Lock archive\n  kb            Keep broken extracted files\n  m<0..5>       Set compression level (0-store...3-default...5-maximal)\n  mc<par>       Set advanced compression parameters\n  md<size>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)\n  ms[ext;ext]   Specify file types to store\n  n<file>       Include only specified file\n  n@            Read file names to include from stdin\n  n@<list>      Include files in specified list file\n  o[+|-]        Set the overwrite mode\n  ol            Save symbolic links as the link instead of the file\n  or            Rename files automatically\n  ow            Save or restore file owner and group\n  p[password]   Set password\n  p-            Do not query password\n  r             Recurse subdirectories\n  r0            Recurse subdirectories for wildcard names only\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[<N>,v[-],e] Create solid archive\n  s-            Disable solid archiving\n  sc<chr>[obj]  Specify the character set\n  sfx[name]     Create SFX archive\n  si[name]      Read data from standard input (stdin)\n  sl<size>      Process files with size less than specified\n  sm<size>      Process files with size more than specified\n  t             Test files after archiving\n  ta<date>      Process files modified after <date> in YYYYMMDDHHMMSS format\n  tb<date>      Process files modified before <date> in YYYYMMDDHHMMSS format\n  tk            Keep original archive time\n  tl            Set archive time to latest file\n  tn<time>      Process files newer than <time>\n  to<time>      Process files older than <time>\n  ts<m,c,a>[N]  Save or restore file time (modification, creation, access)\n  u             Update files\n  v             Create volumes with size autodetection or list all volumes\n  v<size>[k,b]  Create volumes with size=<size>*1000 [*1024, *1]\n  ver[n]        File version control\n  vn            Use the old style volume naming scheme\n  vp            Pause before each volume\n  w<path>       Assign work directory\n  x<file>       Exclude specified file\n  x@            Read file names to exclude from stdin\n  x@<list>      Exclude files in specified list file\n  y             Assume Yes on all queries\n  z[file]       Read archive comment from file\n```","slug":"linux下解压windows上压缩rar包","published":1,"updated":"2019-05-16T04:35:44.294Z","_id":"cjvqprtzy0006zt34u7nl9cwo","comments":1,"layout":"post","photos":[],"link":"","content":"<h5 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h5><p><code># wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz</code></p>\n<h5 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h5><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># tar xvzf rarlinux-3.8.0.tar.gz</span></span><br><span class=\"line\"><span class=\"meta\"># cd rar</span></span><br><span class=\"line\"><span class=\"meta\"># make </span></span><br><span class=\"line\"><span class=\"meta\"># make install</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"rar命令语法\"><a href=\"#rar命令语法\" class=\"headerlink\" title=\"rar命令语法\"></a>rar命令语法</h5><p>将 /etc 目录压缩为 etc.rar 命令为：\\<br><code># rar a etc.rar /etc</code>\\<br>将 etc.rar 解压 命令为：\\<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">rar</span> <span class=\"selector-tag\">x</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br><span class=\"line\"><span class=\"selector-tag\">unrar</span> <span class=\"selector-tag\">-e</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br></pre></td></tr></table></figure></p>\n<h5 id=\"rar帮助手册\"><a href=\"#rar帮助手册\" class=\"headerlink\" title=\"rar帮助手册\"></a>rar帮助手册</h5><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># rar</span></span><br><span class=\"line\"></span><br><span class=\"line\">RAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008</span><br><span class=\"line\">Shareware version         Type RAR -? for help</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:     rar <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">command</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">1</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">N</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">archive</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">files...</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"code\">               &lt;@listfiles...&gt; &lt;path_to_extract\\&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Commands</span>&gt;</span></span></span><br><span class=\"line\">  a             Add files to archive</span><br><span class=\"line\">  c             Add archive comment</span><br><span class=\"line\">  cf            Add files comment</span><br><span class=\"line\">  ch            Change archive parameters</span><br><span class=\"line\">  cw            Write archive comment to file</span><br><span class=\"line\">  d             Delete files from archive</span><br><span class=\"line\">  e             Extract files to current directory</span><br><span class=\"line\">  f             Freshen files in archive</span><br><span class=\"line\">  i[par]=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">str</span>&gt;</span></span>  Find string in archives</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  l[t,b]        List archive [technical, bare]</span><br><span class=\"line\">  m[f]          Move to archive [files only]</span><br><span class=\"line\">  p             Print file to stdout</span><br><span class=\"line\">  r             Repair archive</span><br><span class=\"line\">  rc            Reconstruct missing volumes</span><br><span class=\"line\">  rn            Rename archived files</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[name|-]     Convert archive to or from SFX</span><br><span class=\"line\">  t             Test archive files</span><br><span class=\"line\">  u             Update files in archive</span><br><span class=\"line\">  v[t,b]        Verbosely list archive [technical,bare]</span><br><span class=\"line\">  x             Extract files with full path</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Switches</span>&gt;</span></span></span><br><span class=\"line\">  -             Stop switches scanning</span><br><span class=\"line\">  ad            Append archive name to destination path</span><br><span class=\"line\">  ag[format]    Generate archive name using the current date</span><br><span class=\"line\">  ap<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>      Set path inside archive</span><br><span class=\"line\">  as            Synchronize archive contents</span><br><span class=\"line\">  av            Put authenticity verification (registered versions only)</span><br><span class=\"line\">  av-           Disable authenticity verification check</span><br><span class=\"line\">  c-            Disable comments show</span><br><span class=\"line\">  cfg-          Disable read configuration</span><br><span class=\"line\">  cl            Convert names to lower case</span><br><span class=\"line\">  cu            Convert names to upper case</span><br><span class=\"line\">  df            Delete files after archiving</span><br><span class=\"line\">  dh            Open shared files</span><br><span class=\"line\">  ds            Disable name sort for solid archive</span><br><span class=\"line\">  dw            Wipe files after archiving</span><br><span class=\"line\">  e[+]<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">attr</span>&gt;</span></span>    Set file exclude and include attributes</span><br><span class=\"line\">  ed            Do not add empty directories</span><br><span class=\"line\">  en            Do not put 'end of archive' block</span><br><span class=\"line\">  ep            Exclude paths from names</span><br><span class=\"line\">  ep1           Exclude base directory from names</span><br><span class=\"line\">  ep3           Expand paths to full including the drive letter</span><br><span class=\"line\">  f             Freshen files</span><br><span class=\"line\">  hp[password]  Encrypt both file data and headers</span><br><span class=\"line\">  id[c,d,p,q]   Disable messages</span><br><span class=\"line\">  ierr          Send all messages to stderr</span><br><span class=\"line\">  ilog[name]    Log errors to file (registered versions only)</span><br><span class=\"line\">  inul          Disable all messages</span><br><span class=\"line\">  isnd          Enable sound</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  kb            Keep broken extracted files</span><br><span class=\"line\">  m<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">0..5</span>&gt;</span></span>       Set compression level (0-store...3-default...5-maximal)</span><br><span class=\"line\">  mc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">par</span>&gt;</span></span>       Set advanced compression parameters</span><br><span class=\"line\">  md<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)</span><br><span class=\"line\">  ms[ext;ext]   Specify file types to store</span><br><span class=\"line\">  n<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Include only specified file</span><br><span class=\"line\">  n@            Read file names to include from stdin</span><br><span class=\"line\">  n@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Include files in specified list file</span><br><span class=\"line\">  o[+|-]        Set the overwrite mode</span><br><span class=\"line\">  ol            Save symbolic links as the link instead of the file</span><br><span class=\"line\">  or            Rename files automatically</span><br><span class=\"line\">  ow            Save or restore file owner and group</span><br><span class=\"line\">  p[password]   Set password</span><br><span class=\"line\">  p-            Do not query password</span><br><span class=\"line\">  r             Recurse subdirectories</span><br><span class=\"line\">  r0            Recurse subdirectories for wildcard names only</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">N</span>&gt;</span></span>,v[-],e] Create solid archive</span><br><span class=\"line\">  s-            Disable solid archiving</span><br><span class=\"line\">  sc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">chr</span>&gt;</span></span>[obj]  Specify the character set</span><br><span class=\"line\">  sfx[name]     Create SFX archive</span><br><span class=\"line\">  si[name]      Read data from standard input (stdin)</span><br><span class=\"line\">  sl<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size less than specified</span><br><span class=\"line\">  sm<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size more than specified</span><br><span class=\"line\">  t             Test files after archiving</span><br><span class=\"line\">  ta<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified after <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tb<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified before <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tk            Keep original archive time</span><br><span class=\"line\">  tl            Set archive time to latest file</span><br><span class=\"line\">  tn<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files newer than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  to<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files older than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  ts<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">m,c,a</span>&gt;</span></span>[N]  Save or restore file time (modification, creation, access)</span><br><span class=\"line\">  u             Update files</span><br><span class=\"line\">  v             Create volumes with size autodetection or list all volumes</span><br><span class=\"line\">  v<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>[k,b]  Create volumes with size=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span><span class=\"emphasis\">*1000 [*</span>1024, *1]</span><br><span class=\"line\">  ver[n]        File version control</span><br><span class=\"line\">  vn            Use the old style volume naming scheme</span><br><span class=\"line\">  vp            Pause before each volume</span><br><span class=\"line\">  w<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>       Assign work directory</span><br><span class=\"line\">  x<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Exclude specified file</span><br><span class=\"line\">  x@            Read file names to exclude from stdin</span><br><span class=\"line\">  x@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Exclude files in specified list file</span><br><span class=\"line\">  y             Assume Yes on all queries</span><br><span class=\"line\">  z[file]       Read archive comment from file</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h5 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h5><p><code># wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz</code></p>\n<h5 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h5><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># tar xvzf rarlinux-3.8.0.tar.gz</span></span><br><span class=\"line\"><span class=\"meta\"># cd rar</span></span><br><span class=\"line\"><span class=\"meta\"># make </span></span><br><span class=\"line\"><span class=\"meta\"># make install</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"rar命令语法\"><a href=\"#rar命令语法\" class=\"headerlink\" title=\"rar命令语法\"></a>rar命令语法</h5><p>将 /etc 目录压缩为 etc.rar 命令为：\\<br><code># rar a etc.rar /etc</code>\\<br>将 etc.rar 解压 命令为：\\<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">rar</span> <span class=\"selector-tag\">x</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br><span class=\"line\"><span class=\"selector-tag\">unrar</span> <span class=\"selector-tag\">-e</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br></pre></td></tr></table></figure></p>\n<h5 id=\"rar帮助手册\"><a href=\"#rar帮助手册\" class=\"headerlink\" title=\"rar帮助手册\"></a>rar帮助手册</h5><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># rar</span></span><br><span class=\"line\"></span><br><span class=\"line\">RAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008</span><br><span class=\"line\">Shareware version         Type RAR -? for help</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:     rar <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">command</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">1</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">N</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">archive</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">files...</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"code\">               &lt;@listfiles...&gt; &lt;path_to_extract\\&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Commands</span>&gt;</span></span></span><br><span class=\"line\">  a             Add files to archive</span><br><span class=\"line\">  c             Add archive comment</span><br><span class=\"line\">  cf            Add files comment</span><br><span class=\"line\">  ch            Change archive parameters</span><br><span class=\"line\">  cw            Write archive comment to file</span><br><span class=\"line\">  d             Delete files from archive</span><br><span class=\"line\">  e             Extract files to current directory</span><br><span class=\"line\">  f             Freshen files in archive</span><br><span class=\"line\">  i[par]=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">str</span>&gt;</span></span>  Find string in archives</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  l[t,b]        List archive [technical, bare]</span><br><span class=\"line\">  m[f]          Move to archive [files only]</span><br><span class=\"line\">  p             Print file to stdout</span><br><span class=\"line\">  r             Repair archive</span><br><span class=\"line\">  rc            Reconstruct missing volumes</span><br><span class=\"line\">  rn            Rename archived files</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[name|-]     Convert archive to or from SFX</span><br><span class=\"line\">  t             Test archive files</span><br><span class=\"line\">  u             Update files in archive</span><br><span class=\"line\">  v[t,b]        Verbosely list archive [technical,bare]</span><br><span class=\"line\">  x             Extract files with full path</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Switches</span>&gt;</span></span></span><br><span class=\"line\">  -             Stop switches scanning</span><br><span class=\"line\">  ad            Append archive name to destination path</span><br><span class=\"line\">  ag[format]    Generate archive name using the current date</span><br><span class=\"line\">  ap<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>      Set path inside archive</span><br><span class=\"line\">  as            Synchronize archive contents</span><br><span class=\"line\">  av            Put authenticity verification (registered versions only)</span><br><span class=\"line\">  av-           Disable authenticity verification check</span><br><span class=\"line\">  c-            Disable comments show</span><br><span class=\"line\">  cfg-          Disable read configuration</span><br><span class=\"line\">  cl            Convert names to lower case</span><br><span class=\"line\">  cu            Convert names to upper case</span><br><span class=\"line\">  df            Delete files after archiving</span><br><span class=\"line\">  dh            Open shared files</span><br><span class=\"line\">  ds            Disable name sort for solid archive</span><br><span class=\"line\">  dw            Wipe files after archiving</span><br><span class=\"line\">  e[+]<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">attr</span>&gt;</span></span>    Set file exclude and include attributes</span><br><span class=\"line\">  ed            Do not add empty directories</span><br><span class=\"line\">  en            Do not put 'end of archive' block</span><br><span class=\"line\">  ep            Exclude paths from names</span><br><span class=\"line\">  ep1           Exclude base directory from names</span><br><span class=\"line\">  ep3           Expand paths to full including the drive letter</span><br><span class=\"line\">  f             Freshen files</span><br><span class=\"line\">  hp[password]  Encrypt both file data and headers</span><br><span class=\"line\">  id[c,d,p,q]   Disable messages</span><br><span class=\"line\">  ierr          Send all messages to stderr</span><br><span class=\"line\">  ilog[name]    Log errors to file (registered versions only)</span><br><span class=\"line\">  inul          Disable all messages</span><br><span class=\"line\">  isnd          Enable sound</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  kb            Keep broken extracted files</span><br><span class=\"line\">  m<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">0..5</span>&gt;</span></span>       Set compression level (0-store...3-default...5-maximal)</span><br><span class=\"line\">  mc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">par</span>&gt;</span></span>       Set advanced compression parameters</span><br><span class=\"line\">  md<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)</span><br><span class=\"line\">  ms[ext;ext]   Specify file types to store</span><br><span class=\"line\">  n<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Include only specified file</span><br><span class=\"line\">  n@            Read file names to include from stdin</span><br><span class=\"line\">  n@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Include files in specified list file</span><br><span class=\"line\">  o[+|-]        Set the overwrite mode</span><br><span class=\"line\">  ol            Save symbolic links as the link instead of the file</span><br><span class=\"line\">  or            Rename files automatically</span><br><span class=\"line\">  ow            Save or restore file owner and group</span><br><span class=\"line\">  p[password]   Set password</span><br><span class=\"line\">  p-            Do not query password</span><br><span class=\"line\">  r             Recurse subdirectories</span><br><span class=\"line\">  r0            Recurse subdirectories for wildcard names only</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">N</span>&gt;</span></span>,v[-],e] Create solid archive</span><br><span class=\"line\">  s-            Disable solid archiving</span><br><span class=\"line\">  sc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">chr</span>&gt;</span></span>[obj]  Specify the character set</span><br><span class=\"line\">  sfx[name]     Create SFX archive</span><br><span class=\"line\">  si[name]      Read data from standard input (stdin)</span><br><span class=\"line\">  sl<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size less than specified</span><br><span class=\"line\">  sm<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size more than specified</span><br><span class=\"line\">  t             Test files after archiving</span><br><span class=\"line\">  ta<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified after <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tb<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified before <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tk            Keep original archive time</span><br><span class=\"line\">  tl            Set archive time to latest file</span><br><span class=\"line\">  tn<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files newer than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  to<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files older than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  ts<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">m,c,a</span>&gt;</span></span>[N]  Save or restore file time (modification, creation, access)</span><br><span class=\"line\">  u             Update files</span><br><span class=\"line\">  v             Create volumes with size autodetection or list all volumes</span><br><span class=\"line\">  v<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>[k,b]  Create volumes with size=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span><span class=\"emphasis\">*1000 [*</span>1024, *1]</span><br><span class=\"line\">  ver[n]        File version control</span><br><span class=\"line\">  vn            Use the old style volume naming scheme</span><br><span class=\"line\">  vp            Pause before each volume</span><br><span class=\"line\">  w<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>       Assign work directory</span><br><span class=\"line\">  x<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Exclude specified file</span><br><span class=\"line\">  x@            Read file names to exclude from stdin</span><br><span class=\"line\">  x@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Exclude files in specified list file</span><br><span class=\"line\">  y             Assume Yes on all queries</span><br><span class=\"line\">  z[file]       Read archive comment from file</span><br></pre></td></tr></table></figure>"},{"title":"phpMyAdmin搭建","date":"2019-04-26T07:30:09.000Z","copyright":true,"_content":"##### 在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\n\n- 下载phpMyAdmin\\\n官网地址：https://www.phpmyadmin.net/\n\n- 上传到服务器进行安装\n```html\n# unzip phpMyAdmin-4.8.5-all-languages.zip\n# mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin\n# chown apache. /opt/phpMyAdmin\n```\n- 编辑配置文件 config.default.php\n```\n# vim /opt/phpMyAdmin/libraries/config.default.php\n$cfg['Servers'][$i]['host'] = '130.39.113.45';\n$cfg['Servers'][$i]['port'] = '3306';\n$cfg['Servers'][$i]['socket'] = 'socket';\n$cfg['Servers'][$i]['user'] = 'tj_court';\n$cfg['Servers'][$i]['password'] = 'AigheiguSh4eesh0eey8';\n```\n- 配置nginx站点\n```html\n# vim phpMyAdmin.conf\nserver {\n    listen       80;\n    server_name  www.phpadmin.com;\n    autoindex off;\n\n    error_log  logs/phpadmin_error.log error;\n    access_log logs/phpadmin_access.log main;\n\n    location / {\n    root /opt/phpMyAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n- 配置完成后启动nginx访问配置的域名进行连接\n![](phpMyAdmin搭建/4.png)\n![](phpMyAdmin搭建/6.png)\n\n","source":"_posts/phpMyAdmin搭建.md","raw":"---\ntitle: phpMyAdmin搭建\ndate: 2019-04-26 15:30:09\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n##### 在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\n\n- 下载phpMyAdmin\\\n官网地址：https://www.phpmyadmin.net/\n\n- 上传到服务器进行安装\n```html\n# unzip phpMyAdmin-4.8.5-all-languages.zip\n# mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin\n# chown apache. /opt/phpMyAdmin\n```\n- 编辑配置文件 config.default.php\n```\n# vim /opt/phpMyAdmin/libraries/config.default.php\n$cfg['Servers'][$i]['host'] = '130.39.113.45';\n$cfg['Servers'][$i]['port'] = '3306';\n$cfg['Servers'][$i]['socket'] = 'socket';\n$cfg['Servers'][$i]['user'] = 'tj_court';\n$cfg['Servers'][$i]['password'] = 'AigheiguSh4eesh0eey8';\n```\n- 配置nginx站点\n```html\n# vim phpMyAdmin.conf\nserver {\n    listen       80;\n    server_name  www.phpadmin.com;\n    autoindex off;\n\n    error_log  logs/phpadmin_error.log error;\n    access_log logs/phpadmin_access.log main;\n\n    location / {\n    root /opt/phpMyAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n- 配置完成后启动nginx访问配置的域名进行连接\n![](phpMyAdmin搭建/4.png)\n![](phpMyAdmin搭建/6.png)\n\n","slug":"phpMyAdmin搭建","published":1,"updated":"2019-05-16T04:35:44.297Z","_id":"cjvqprtzz0007zt34iizvxh8s","comments":1,"layout":"post","photos":[],"link":"","content":"<h5 id=\"在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\"><a href=\"#在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\" class=\"headerlink\" title=\"在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\"></a>在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。</h5><ul>\n<li><p>下载phpMyAdmin\\<br>官网地址：<a href=\"https://www.phpmyadmin.net/\" target=\"_blank\" rel=\"noopener\">https://www.phpmyadmin.net/</a></p>\n</li>\n<li><p>上传到服务器进行安装</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># unzip phpMyAdmin-4.8.5-all-languages.zip</span><br><span class=\"line\"># mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin</span><br><span class=\"line\"># chown apache. /opt/phpMyAdmin</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>编辑配置文件 config.default.php</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># vim /opt/phpMyAdmin/libraries/config.default.php</span></span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'host'</span>] = '130.39.113.45';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'port'</span>] = '3306';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'socket'</span>] = 'socket';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'user'</span>] = 'tj_court';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'password'</span>] = 'AigheiguSh4eesh0eey8';</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置nginx站点</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># vim phpMyAdmin.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  www.phpadmin.com;</span><br><span class=\"line\">    autoindex off;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_log  logs/phpadmin_error.log error;</span><br><span class=\"line\">    access_log logs/phpadmin_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">    root /opt/phpMyAdmin;</span><br><span class=\"line\">        index  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fastcgi_intercept_errors on;</span><br><span class=\"line\">    error_page  404             /404.html;</span><br><span class=\"line\">    location ~ \\.php$ &#123;</span><br><span class=\"line\">        root           html;</span><br><span class=\"line\">        fastcgi_pass   127.0.0.1:9000;</span><br><span class=\"line\">        fastcgi_index  index.php;</span><br><span class=\"line\">        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;</span><br><span class=\"line\">        include        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location ~ /\\. &#123;</span><br><span class=\"line\">        deny all;</span><br><span class=\"line\">        error_page  403             /404.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置完成后启动nginx访问配置的域名进行连接<br><img src=\"/2019/04/26/phpMyAdmin搭建/4.png\" alt><br><img src=\"/2019/04/26/phpMyAdmin搭建/6.png\" alt></p>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h5 id=\"在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\"><a href=\"#在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\" class=\"headerlink\" title=\"在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\"></a>在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。</h5><ul>\n<li><p>下载phpMyAdmin\\<br>官网地址：<a href=\"https://www.phpmyadmin.net/\" target=\"_blank\" rel=\"noopener\">https://www.phpmyadmin.net/</a></p>\n</li>\n<li><p>上传到服务器进行安装</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># unzip phpMyAdmin-4.8.5-all-languages.zip</span><br><span class=\"line\"># mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin</span><br><span class=\"line\"># chown apache. /opt/phpMyAdmin</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>编辑配置文件 config.default.php</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># vim /opt/phpMyAdmin/libraries/config.default.php</span></span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'host'</span>] = '130.39.113.45';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'port'</span>] = '3306';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'socket'</span>] = 'socket';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'user'</span>] = 'tj_court';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'password'</span>] = 'AigheiguSh4eesh0eey8';</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置nginx站点</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># vim phpMyAdmin.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  www.phpadmin.com;</span><br><span class=\"line\">    autoindex off;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_log  logs/phpadmin_error.log error;</span><br><span class=\"line\">    access_log logs/phpadmin_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">    root /opt/phpMyAdmin;</span><br><span class=\"line\">        index  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fastcgi_intercept_errors on;</span><br><span class=\"line\">    error_page  404             /404.html;</span><br><span class=\"line\">    location ~ \\.php$ &#123;</span><br><span class=\"line\">        root           html;</span><br><span class=\"line\">        fastcgi_pass   127.0.0.1:9000;</span><br><span class=\"line\">        fastcgi_index  index.php;</span><br><span class=\"line\">        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;</span><br><span class=\"line\">        include        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location ~ /\\. &#123;</span><br><span class=\"line\">        deny all;</span><br><span class=\"line\">        error_page  403             /404.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置完成后启动nginx访问配置的域名进行连接<br><img src=\"/2019/04/26/phpMyAdmin搭建/4.png\" alt><br><img src=\"/2019/04/26/phpMyAdmin搭建/6.png\" alt></p>\n</li>\n</ul>\n"},{"title":"saltstack远程执行","date":"2019-05-14T07:18:05.000Z","copyright":true,"_content":"<div class=\"note success\"><p>安装完`Saltstack`后可以立即执行`shell`命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：http://docs.saltstack.cn/topics/tutorials/modules.html</p></div>\n```\n[root@salt-master ~]# salt '*' cmd.run \"uptime\"\nsalt-minion01:\n     15:23:08 up 1 day, 58 min,  2 users,  load average: 0.00, 0.03, 0.08\nsalt-minion02:\n     15:23:08 up 21:38,  2 users,  load average: 0.00, 0.04, 0.10\nsalt-minion03:\n     15:23:08 up 21:36,  2 users,  load average: 0.00, 0.04, 0.10\n```\n\n## Salt命令的结构语法\n```\nsalt '<target>' <function> [arguments]\n```\n\n![](https://upload-images.jianshu.io/upload_images/11763553-e5e69a972680590f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n## 目标主机Target\n![](https://upload-images.jianshu.io/upload_images/11763553-e3ed49a6c6b6633f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n1、通配符匹配\n```\n[root@salt-master ~]# salt '*' test.ping\n[root@salt-master ~]# salt 'salt-minion01' test.ping\n[root@salt-master ~]# salt '*01' test.ping\n[root@salt-master ~]# salt 'salt-minion0[1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0[!1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0?' test.ping\n```\n2、列表匹配\n```\n[root@salt-master ~]# salt -L 'salt-minion01,salt-minion02' test.ping\n```\n3、正则匹配\n```\n[root@salt-master ~]# salt -E '^salt' test.ping\n[root@salt-master ~]# salt -E '^salt.*2$' test.ping\n```\n4、IP匹配\n```\n[root@salt-master ~]# salt -S '192.168.1.32' test.ping\n[root@salt-master ~]# salt -S '192.168.1.0/24' test.ping\n```\n5、复合匹配\n```\n[root@salt-master ~]# salt -C 'G@os:CentOS and S@192.168.1.32' test.ping\n```\n6、分组匹配\n```\n[root@salt-master ~]# vim /etc/salt/master\nnodegroups:\n  webserver: 'salt-minion01,salt-minion02'\n  dbserver: 'salt-minion03\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# salt -N 'webserver' test.ping\n[root@salt-master ~]# salt -N 'dbserver' test.ping\n```\n7、Grains匹配\n```\n[root@salt-master ~]# salt -G 'os:CentOS' test.ping\n[root@salt-master ~]# salt -G 'localhost:salt-minion02' test.ping\n```\n> 说明：上面这些匹配方式在`top.sls`文件中同样适用。\n## 模块Module\n![](https://upload-images.jianshu.io/upload_images/11763553-18184de0fb7156aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n> `test`模块多用于测试\n`user`模块用于用户管理\n`cmd`模块可以执行任意`shell`命令\n`pkg`模块用于软件包管理\n`file`模块多用于配置\n`service`模块用于服务管理\n\n[所有模块列表](http://docs.saltstack.cn/ref/modules/all/index.html)\n\n**test模块**\n```\n模块名：test\n功能：用于测试\n[root@salt-master ~]# salt '*' test.ping\n```\n**user模块**\n```\n参考：http://docs.saltstack.cn/ref/modules/all/salt.modules.useradd.html#module-salt.modules.useradd\n# salt '*' user.add name <uid> <gid> <groups> <home> <shell>\n[root@salt-master ~]# salt '*' user.add testuser\n```\n**cmd模块**\n```\n模块名：cmd\n功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）\n#查看所有minion内存和磁盘使用情况\n[root@salt-master ~]# salt '*' cmd.run \"free -m\"\n[root@salt-master ~]# salt '*' cmd.run \"df -h\"\n```\n**pkg模块**\n```\n模块名：pkg\n功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）\n\n#安装\n[root@salt-master ~]# salt '*' pkg.install \"vsftpd\"\n#卸载\n[root@salt-master ~]# salt '*' pkg.remove \"vsftpd\"\n#安装最新版本\n[root@salt-master ~]# salt '*' pkg.latest_version \"vsftpd\"\n#更新软件包\n[root@salt-master ~]# salt '*' pkg.upgrade \"vsftpd\"\n\n#查看帮助手册\n[root@salt-master ~]# salt '*' pkg\n```\n**file模块**\n```\n模块名：file\n功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验\n\n#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法\n[root@salt-master ~]# salt '*' file.get_sum /etc/passwd md5\n\n#修改所有minion主机/etc/passwd文件的属组、用户权限、等价于chown root:root /etc/passwd\n[root@salt-master ~]# salt '*' file.chown /etc/passwd root root\n\n#获取所有minion主机/etc/passwd的stats信息\n[root@salt-master ~]# salt '*' file.stats /etc/passwd\n\n#获取所有minion主机/etc/passwd的权限mode,如755,644\n[root@salt-master ~]# salt '*' file.get_mode /etc/passwd\n\n#修改所有minion主机/etc/passwd的权限mode为0644\n[root@salt-master ~]# salt '*' file.set_mode /etc/passwd 0644\n\n#在所有minion主机创建/opt/test目录\n[root@salt-master ~]# salt '*' file.mkdir /opt/test\n\n#在所有minion主机穿件/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.touch /tmp/test.conf\n\n#将所有minion主机/tmp/test.conf文件追加内容'maxclient 100'\n[root@salt-master ~]# salt '*' file.append /tmp/test.conf 'maxclient 100'\n\n#删除所有minion主机的/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.remove /tmp/test.conf\n```\n**service模块**\n```\n模块名：service\n功能：被控主机程序包服务管理\n\n#开启（enable）禁用（disable）\nsalt '*' service.enable <service name>\nsalt '*' service.disabled <service name>\n\n#reload、restart、start、stop、status操作\nsalt '*' service.reload <service name>\nsalt '*' service.restart <service name>\nsalt '*' service.start <service name>\nsalt '*' service.stop <service name>\nsalt '*' service.status <service name>\n```","source":"_posts/saltstack远程执行.md","raw":"---\ntitle: saltstack远程执行\ndate: 2019-05-14 15:18:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n<div class=\"note success\"><p>安装完`Saltstack`后可以立即执行`shell`命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：http://docs.saltstack.cn/topics/tutorials/modules.html</p></div>\n```\n[root@salt-master ~]# salt '*' cmd.run \"uptime\"\nsalt-minion01:\n     15:23:08 up 1 day, 58 min,  2 users,  load average: 0.00, 0.03, 0.08\nsalt-minion02:\n     15:23:08 up 21:38,  2 users,  load average: 0.00, 0.04, 0.10\nsalt-minion03:\n     15:23:08 up 21:36,  2 users,  load average: 0.00, 0.04, 0.10\n```\n\n## Salt命令的结构语法\n```\nsalt '<target>' <function> [arguments]\n```\n\n![](https://upload-images.jianshu.io/upload_images/11763553-e5e69a972680590f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n## 目标主机Target\n![](https://upload-images.jianshu.io/upload_images/11763553-e3ed49a6c6b6633f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n1、通配符匹配\n```\n[root@salt-master ~]# salt '*' test.ping\n[root@salt-master ~]# salt 'salt-minion01' test.ping\n[root@salt-master ~]# salt '*01' test.ping\n[root@salt-master ~]# salt 'salt-minion0[1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0[!1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0?' test.ping\n```\n2、列表匹配\n```\n[root@salt-master ~]# salt -L 'salt-minion01,salt-minion02' test.ping\n```\n3、正则匹配\n```\n[root@salt-master ~]# salt -E '^salt' test.ping\n[root@salt-master ~]# salt -E '^salt.*2$' test.ping\n```\n4、IP匹配\n```\n[root@salt-master ~]# salt -S '192.168.1.32' test.ping\n[root@salt-master ~]# salt -S '192.168.1.0/24' test.ping\n```\n5、复合匹配\n```\n[root@salt-master ~]# salt -C 'G@os:CentOS and S@192.168.1.32' test.ping\n```\n6、分组匹配\n```\n[root@salt-master ~]# vim /etc/salt/master\nnodegroups:\n  webserver: 'salt-minion01,salt-minion02'\n  dbserver: 'salt-minion03\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# salt -N 'webserver' test.ping\n[root@salt-master ~]# salt -N 'dbserver' test.ping\n```\n7、Grains匹配\n```\n[root@salt-master ~]# salt -G 'os:CentOS' test.ping\n[root@salt-master ~]# salt -G 'localhost:salt-minion02' test.ping\n```\n> 说明：上面这些匹配方式在`top.sls`文件中同样适用。\n## 模块Module\n![](https://upload-images.jianshu.io/upload_images/11763553-18184de0fb7156aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n> `test`模块多用于测试\n`user`模块用于用户管理\n`cmd`模块可以执行任意`shell`命令\n`pkg`模块用于软件包管理\n`file`模块多用于配置\n`service`模块用于服务管理\n\n[所有模块列表](http://docs.saltstack.cn/ref/modules/all/index.html)\n\n**test模块**\n```\n模块名：test\n功能：用于测试\n[root@salt-master ~]# salt '*' test.ping\n```\n**user模块**\n```\n参考：http://docs.saltstack.cn/ref/modules/all/salt.modules.useradd.html#module-salt.modules.useradd\n# salt '*' user.add name <uid> <gid> <groups> <home> <shell>\n[root@salt-master ~]# salt '*' user.add testuser\n```\n**cmd模块**\n```\n模块名：cmd\n功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）\n#查看所有minion内存和磁盘使用情况\n[root@salt-master ~]# salt '*' cmd.run \"free -m\"\n[root@salt-master ~]# salt '*' cmd.run \"df -h\"\n```\n**pkg模块**\n```\n模块名：pkg\n功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）\n\n#安装\n[root@salt-master ~]# salt '*' pkg.install \"vsftpd\"\n#卸载\n[root@salt-master ~]# salt '*' pkg.remove \"vsftpd\"\n#安装最新版本\n[root@salt-master ~]# salt '*' pkg.latest_version \"vsftpd\"\n#更新软件包\n[root@salt-master ~]# salt '*' pkg.upgrade \"vsftpd\"\n\n#查看帮助手册\n[root@salt-master ~]# salt '*' pkg\n```\n**file模块**\n```\n模块名：file\n功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验\n\n#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法\n[root@salt-master ~]# salt '*' file.get_sum /etc/passwd md5\n\n#修改所有minion主机/etc/passwd文件的属组、用户权限、等价于chown root:root /etc/passwd\n[root@salt-master ~]# salt '*' file.chown /etc/passwd root root\n\n#获取所有minion主机/etc/passwd的stats信息\n[root@salt-master ~]# salt '*' file.stats /etc/passwd\n\n#获取所有minion主机/etc/passwd的权限mode,如755,644\n[root@salt-master ~]# salt '*' file.get_mode /etc/passwd\n\n#修改所有minion主机/etc/passwd的权限mode为0644\n[root@salt-master ~]# salt '*' file.set_mode /etc/passwd 0644\n\n#在所有minion主机创建/opt/test目录\n[root@salt-master ~]# salt '*' file.mkdir /opt/test\n\n#在所有minion主机穿件/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.touch /tmp/test.conf\n\n#将所有minion主机/tmp/test.conf文件追加内容'maxclient 100'\n[root@salt-master ~]# salt '*' file.append /tmp/test.conf 'maxclient 100'\n\n#删除所有minion主机的/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.remove /tmp/test.conf\n```\n**service模块**\n```\n模块名：service\n功能：被控主机程序包服务管理\n\n#开启（enable）禁用（disable）\nsalt '*' service.enable <service name>\nsalt '*' service.disabled <service name>\n\n#reload、restart、start、stop、status操作\nsalt '*' service.reload <service name>\nsalt '*' service.restart <service name>\nsalt '*' service.start <service name>\nsalt '*' service.stop <service name>\nsalt '*' service.status <service name>\n```","slug":"saltstack远程执行","published":1,"updated":"2019-05-16T04:35:44.309Z","_id":"cjvqpru02000bzt345nglafc6","comments":1,"layout":"post","photos":[],"link":"","content":"<p><div class=\"note success\"><p>安装完<code>Saltstack</code>后可以立即执行<code>shell</code>命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：<a href=\"http://docs.saltstack.cn/topics/tutorials/modules.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/tutorials/modules.html</a></p></div><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># salt '*' cmd.run \"uptime\"</span></span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">     15:23:08 up 1 day, 58 min,  2 users,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.03</span>, <span class=\"number\">0.08</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion02:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">38</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion03:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">36</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Salt命令的结构语法\"><a href=\"#Salt命令的结构语法\" class=\"headerlink\" title=\"Salt命令的结构语法\"></a>Salt命令的结构语法</h2><figure class=\"highlight matlab\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">salt <span class=\"string\">'&lt;target&gt;'</span> &lt;<span class=\"function\"><span class=\"keyword\">function</span>&gt; <span class=\"params\">[arguments]</span></span></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-e5e69a972680590f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<h2 id=\"目标主机Target\"><a href=\"#目标主机Target\" class=\"headerlink\" title=\"目标主机Target\"></a>目标主机Target</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-e3ed49a6c6b6633f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt><br>1、通配符匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[!1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0?'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -L <span class=\"string\">'salt-minion01,salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>3、正则匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt.*2$'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>4、IP匹配<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span>' test.ping</span><br><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>5、复合匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -C 'G@os:CentOS <span class=\"keyword\">and</span> S@<span class=\"number\">192.168</span>.<span class=\"number\">1.32</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>6、分组匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">nodegroups:</span><br><span class=\"line\">  webserver: 'salt-minion01,salt-minion02'</span><br><span class=\"line\">  dbserver: 'salt-minion03</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'webserver' test.ping</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'dbserver' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>7、Grains匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'os:CentOS'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'localhost:salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>说明：上面这些匹配方式在<code>top.sls</code>文件中同样适用。</p>\n</blockquote>\n<h2 id=\"模块Module\"><a href=\"#模块Module\" class=\"headerlink\" title=\"模块Module\"></a>模块Module</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-18184de0fb7156aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<blockquote>\n<p><code>test</code>模块多用于测试<br><code>user</code>模块用于用户管理<br><code>cmd</code>模块可以执行任意<code>shell</code>命令<br><code>pkg</code>模块用于软件包管理<br><code>file</code>模块多用于配置<br><code>service</code>模块用于服务管理</p>\n</blockquote>\n<p><a href=\"http://docs.saltstack.cn/ref/modules/all/index.html\" target=\"_blank\" rel=\"noopener\">所有模块列表</a></p>\n<p><strong>test模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：test</span><br><span class=\"line\">功能：用于测试</span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>user模块</strong><br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">参考：http://docs.saltstack.<span class=\"keyword\">cn</span>/ref/modules/<span class=\"keyword\">all</span>/salt.modules.useradd.html#module-salt.modules.useradd</span><br><span class=\"line\"># salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> name <span class=\"symbol\">&lt;uid&gt;</span> <span class=\"symbol\">&lt;gid&gt;</span> <span class=\"symbol\">&lt;groups&gt;</span> <span class=\"symbol\">&lt;home&gt;</span> <span class=\"symbol\">&lt;shell&gt;</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> testuser</span><br></pre></td></tr></table></figure></p>\n<p><strong>cmd模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：cmd</span><br><span class=\"line\">功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）</span><br><span class=\"line\"><span class=\"meta\">#查看所有minion内存和磁盘使用情况</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"free -m\"</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"df -h\"</span></span></span><br></pre></td></tr></table></figure></p>\n<p><strong>pkg模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：pkg</span><br><span class=\"line\">功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.install <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#卸载</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.remove <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#安装最新版本</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.latest_version <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#更新软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.upgrade <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#查看帮助手册</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>file模块</strong><br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：<span class=\"keyword\">file</span></span><br><span class=\"line\">功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验</span><br><span class=\"line\"></span><br><span class=\"line\">#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_sum <span class=\"regexp\">/etc/</span>passwd md5</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd文件的属组、用户权限、等价于chown root:root <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.chown <span class=\"regexp\">/etc/</span>passwd root root</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的stats信息</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.stats <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode,如<span class=\"number\">755</span>,<span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_mode <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode为<span class=\"number\">0644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.set_mode <span class=\"regexp\">/etc/</span>passwd <span class=\"number\">0644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机创建<span class=\"regexp\">/opt/</span>test目录</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.mkdir <span class=\"regexp\">/opt/</span>test</span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机穿件<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.touch <span class=\"regexp\">/tmp/</span>test.conf</span><br><span class=\"line\"></span><br><span class=\"line\">#将所有minion主机<span class=\"regexp\">/tmp/</span>test.conf文件追加内容<span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.<span class=\"keyword\">append</span> <span class=\"regexp\">/tmp/</span>test.conf <span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\"></span><br><span class=\"line\">#删除所有minion主机的<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.remove <span class=\"regexp\">/tmp/</span>test.conf</span><br></pre></td></tr></table></figure></p>\n<p><strong>service模块</strong><br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：service</span><br><span class=\"line\">功能：被控主机程序包服务管理</span><br><span class=\"line\"></span><br><span class=\"line\">#开启（enable）禁用（disable）</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.enable</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.disabled</span> &lt;service name&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">#reload、restart、start、stop、status操作</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.reload</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.restart</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.start</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.stop</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.status</span> &lt;service name&gt;</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<p><div class=\"note success\"><p>安装完<code>Saltstack</code>后可以立即执行<code>shell</code>命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：<a href=\"http://docs.saltstack.cn/topics/tutorials/modules.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/tutorials/modules.html</a></p></div><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># salt '*' cmd.run \"uptime\"</span></span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">     15:23:08 up 1 day, 58 min,  2 users,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.03</span>, <span class=\"number\">0.08</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion02:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">38</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion03:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">36</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Salt命令的结构语法\"><a href=\"#Salt命令的结构语法\" class=\"headerlink\" title=\"Salt命令的结构语法\"></a>Salt命令的结构语法</h2><figure class=\"highlight matlab\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">salt <span class=\"string\">'&lt;target&gt;'</span> &lt;<span class=\"function\"><span class=\"keyword\">function</span>&gt; <span class=\"params\">[arguments]</span></span></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-e5e69a972680590f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<h2 id=\"目标主机Target\"><a href=\"#目标主机Target\" class=\"headerlink\" title=\"目标主机Target\"></a>目标主机Target</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-e3ed49a6c6b6633f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt><br>1、通配符匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[!1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0?'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -L <span class=\"string\">'salt-minion01,salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>3、正则匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt.*2$'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>4、IP匹配<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span>' test.ping</span><br><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>5、复合匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -C 'G@os:CentOS <span class=\"keyword\">and</span> S@<span class=\"number\">192.168</span>.<span class=\"number\">1.32</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>6、分组匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">nodegroups:</span><br><span class=\"line\">  webserver: 'salt-minion01,salt-minion02'</span><br><span class=\"line\">  dbserver: 'salt-minion03</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'webserver' test.ping</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'dbserver' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>7、Grains匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'os:CentOS'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'localhost:salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>说明：上面这些匹配方式在<code>top.sls</code>文件中同样适用。</p>\n</blockquote>\n<h2 id=\"模块Module\"><a href=\"#模块Module\" class=\"headerlink\" title=\"模块Module\"></a>模块Module</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-18184de0fb7156aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<blockquote>\n<p><code>test</code>模块多用于测试<br><code>user</code>模块用于用户管理<br><code>cmd</code>模块可以执行任意<code>shell</code>命令<br><code>pkg</code>模块用于软件包管理<br><code>file</code>模块多用于配置<br><code>service</code>模块用于服务管理</p>\n</blockquote>\n<p><a href=\"http://docs.saltstack.cn/ref/modules/all/index.html\" target=\"_blank\" rel=\"noopener\">所有模块列表</a></p>\n<p><strong>test模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：test</span><br><span class=\"line\">功能：用于测试</span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>user模块</strong><br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">参考：http://docs.saltstack.<span class=\"keyword\">cn</span>/ref/modules/<span class=\"keyword\">all</span>/salt.modules.useradd.html#module-salt.modules.useradd</span><br><span class=\"line\"># salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> name <span class=\"symbol\">&lt;uid&gt;</span> <span class=\"symbol\">&lt;gid&gt;</span> <span class=\"symbol\">&lt;groups&gt;</span> <span class=\"symbol\">&lt;home&gt;</span> <span class=\"symbol\">&lt;shell&gt;</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> testuser</span><br></pre></td></tr></table></figure></p>\n<p><strong>cmd模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：cmd</span><br><span class=\"line\">功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）</span><br><span class=\"line\"><span class=\"meta\">#查看所有minion内存和磁盘使用情况</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"free -m\"</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"df -h\"</span></span></span><br></pre></td></tr></table></figure></p>\n<p><strong>pkg模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：pkg</span><br><span class=\"line\">功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.install <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#卸载</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.remove <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#安装最新版本</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.latest_version <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#更新软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.upgrade <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#查看帮助手册</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>file模块</strong><br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：<span class=\"keyword\">file</span></span><br><span class=\"line\">功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验</span><br><span class=\"line\"></span><br><span class=\"line\">#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_sum <span class=\"regexp\">/etc/</span>passwd md5</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd文件的属组、用户权限、等价于chown root:root <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.chown <span class=\"regexp\">/etc/</span>passwd root root</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的stats信息</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.stats <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode,如<span class=\"number\">755</span>,<span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_mode <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode为<span class=\"number\">0644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.set_mode <span class=\"regexp\">/etc/</span>passwd <span class=\"number\">0644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机创建<span class=\"regexp\">/opt/</span>test目录</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.mkdir <span class=\"regexp\">/opt/</span>test</span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机穿件<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.touch <span class=\"regexp\">/tmp/</span>test.conf</span><br><span class=\"line\"></span><br><span class=\"line\">#将所有minion主机<span class=\"regexp\">/tmp/</span>test.conf文件追加内容<span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.<span class=\"keyword\">append</span> <span class=\"regexp\">/tmp/</span>test.conf <span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\"></span><br><span class=\"line\">#删除所有minion主机的<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.remove <span class=\"regexp\">/tmp/</span>test.conf</span><br></pre></td></tr></table></figure></p>\n<p><strong>service模块</strong><br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：service</span><br><span class=\"line\">功能：被控主机程序包服务管理</span><br><span class=\"line\"></span><br><span class=\"line\">#开启（enable）禁用（disable）</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.enable</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.disabled</span> &lt;service name&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">#reload、restart、start、stop、status操作</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.reload</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.restart</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.start</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.stop</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.status</span> &lt;service name&gt;</span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack基本入门","date":"2019-05-13T07:47:05.000Z","copyright":true,"_content":"## saltstack介绍\n<div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n**主要功能**\n远程执行\n配置管理\n[Stalstack官方文档](http://docs.saltstack.cn/)\n## Saltstack原理\n>`Salt`使用`server-agent`通信模型，服务端组件被称为`Salt master`，`agent`被称为`Salt minion`\n`Salt master`主要负责向`Salt minions`发送命令，然后聚合并显示这些命令的结果。一个`Salt master`可以管理多个`minion`系统\n`Salt server`与`Salt minion`通信的连接由`Salt minion`发起，这也意味着`Salt minion`上不需要打开任何传入端口（从而减少攻击）。`Salt server`使用端口`4505`和`4506`，必须打开端口才能接收到访问连接\n\n![通信示例图](https://upload-images.jianshu.io/upload_images/11763553-2ead569e18094825.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n- **Publisher** （端口4505）所有`Salt minions`都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。\n- **Request Server** （端口4506）`Salt minios`根据需要连接到请求服务器，将结果发送给`Salt master`，并安全地获取请求的文件或特定`minion`相关的数据值（称为`Salt pillar`）。连接到这个端口的连接在`Salt master`和`Salt minion`之间是1:1（不是异步）。\n\n```\n[root@salt-master ~]# lsof -i:4505\nCOMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nsalt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)\nsalt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505->salt-minion03:37240 (ESTABLISHED)\nsalt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505->salt-minion01:47804 (ESTABLISHED)\nsalt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505->salt-minion02:58594 (ESTABLISHED)\n```\n\n## 快速安装\n1.1 配置 yum 仓库\n```\n# 使用官方自带yum\n[root@salt-master ~]# yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm\n# 或者使用阿里云的yum（建议使用阿里云的，速度快一点）\n[root@salt-master ~]# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n[root@salt-master ~]# sed -i \"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\" /etc/yum.repos.d/salt-latest.repo\n[root@salt-master ~]# yum clean all\n[root@salt-master ~]# yum makecache\n```\n1.2 安装Master，并启动服务\n```\n[root@salt-master ~]# yum -y install salt-master\n[root@salt-master ~]# systemctl enable salt-master\n[root@salt-master ~]# systemctl start salt-master\n```\n1.3 安装 Salt-Minion 指向 Salt-Master 网络地址\n```\n[root@salt-minion01 ~]# yum -y install salt-minion\n# 可以使用主机名，也可以使用IP地址\n[root@salt-minion01 ~]# cp /etc/salt/minion{,.back}\n[root@salt-minion01 ~]# sed -i '/#master: /c\\master: salt-master' /etc/salt/minion\n[root@salt-minion01 ~]# systemctl enable salt-minion\n[root@salt-minion01 ~]# systemctl start salt-minion\n```\n##  SaltStack认证方式\n![master与minion之间的架构关系图](https://upload-images.jianshu.io/upload_images/11763553-51113b6686102c1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n<div class=\"note success\"><p> `Salt` 的数据传输是通过 `AES` 加密，`Master` 和 `Minion` 之前在通信之前，需要进行认证。\n`Salt` 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  `minion` 在第一次启动时候，会在 `/etc/salt/pki/minion/` 下自动生成 `minion.pem(private key)` 和 `minion.pub(public key) `, 然后将 `minion.pub` 发送给 `master `\n2. `master` 在第一次启动时，会在 `/etc/salt/pki/master/` 下自动生成 `master.pem` 和 `master.pub` ；并且会接收到 `minion` 的 `public key` , 通过 `salt-key` 命令接收 `minion public key`， 会在 `master` 的 `/etc/salt/pki/master/minions` 目录下存放以 `minion id` 命令的 `public key` ；验证成功后同时 `minion` 会保存一份 `master public key` 在 minion的 `/etc/salt/pki/minion/minion_master.pub`里。</p></div>\n\n**Salt认证原理总结**\n> `minion`将自己的公钥发送给`master`\n`master`认证后再将自己的公钥也发送给`minion`端\n\n**Master端认证示例**\n根据上面提到的认证原理，先看下未认证前的`master`和`minion`的`pki`目录\n```\n# master上查看\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   │   └── salt-minion01\n│   └── minions_rejected\n└── minion\n\n# minion上查看\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion.pem\n    └── minion.pub\n```\n`salt-key`命令解释：\n```\n[root@salt-master ~]# salt-key -L \nAccepted Keys:        #已经接受的key\nDenied Keys:          #拒绝的key\nUnaccepted Keys:      #未加入的key\nRejected Keys:        #吊销的key\n\n#常用参数\n-L  #查看KEY状态\n-A  #允许所有\n-D  #删除所有\n-a  #认证指定的key\n-d  #删除指定的key\n-r  #注销掉指定key（该状态为未被认证）\n\n#配置master自动接受请求认证(master上配置 /etc/salt/master)\nauto_accept: True\n```\n`salt-key`认证\n```\n#列出当前所有的key\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nDenied Keys:\nUnaccepted Keys:\nsalt-minion01\nRejected Keys:\n\n#添加指定minion的key\n[root@salt-master ~]# salt-key -a salt-minion01 -y\nThe following keys are going to be accepted:\nUnaccepted Keys:\nsalt-minion01\nKey for minion salt-minion01 accepted.\n#添加所有minion的key\n[root@salt-master ~]# salt-key -A -y\n\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nsalt-minion01\nDenied Keys:\nUnaccepted Keys:\nRejected Keys:\n```\n上面认证完成后再次查看`master`和`minion`的`pki`目录\n```\n# master上\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   │   └── salt-minion01\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   └── minions_rejected\n└── minion\n\n# minion上\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion_master.pub\n    ├── minion.pem\n    └── minion.pub\n```\n## Saltstack远程执行\n>远程执行是 `Saltstack` 的核心功能之一。主要使用 `salt` 模块批量给选定的 `minion` 端执行相应的命令，并获得返回结果。\n\n1、判断 `salt` 的 `minion` 主机是否存活\n```\n[root@salt-master ~]# salt '*' test.ping\nsalt-minion02:\n    True\nsalt-minion03:\n    True\nsalt-minion01:\n    True\n\n# salt saltstack自带的一个命令\n# * 表示目标主机，这里表示所有目标主机\n# test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法\n```\n2、`saltstack`使用 `cmd.run`模块远程执行shell命令\n```\n#在指定目标minion节点运行uptime命令\n[root@salt-master ~]# salt 'salt-minion02' cmd.run 'uptime'\nsalt-minion02:\n     18:13:08 up 28 min,  2 users,  load average: 0.00, 0.04, 0.13\n```\n## Saltstack配置管理\n<div class=\"note success\"><p>`Salt` 通过`State`模块来进行文件的管理；通过`YAML`语法来描述，后缀是`.sls`的文件</p></div>1、了解 `YAML` 参考：http://docs.saltstack.cn/topics/yaml/index.html\n```\nremove vim:\n  pkg.removed:\n    - name: vim\n```\n- 带有ID和每个函数调用的行都以冒号（:)结束。\n- 每个函数调用在ID下面缩进两个空格。\n- 参数作为列表传递给每个函数。\n- 每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。\n- 如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。\n- 如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格\n\n2、配置`sals` ,定义环境   [参考文档](https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md)\n```\n# 定义环境目录\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n# 创建上面定义的目录\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n# 重启服务\n[root@salt-master ~]# systemctl restart salt-master\n```\n3、编写第一个`sls`文件\n```\n# 在base环境下编写第一个安装apache的sls文件\n[root@salt-master ~]# cd /srv/salt/base/\n[root@salt-master base]# cat apache.sls \napache-install:\n  pkg.installed:\n    - name: httpd\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n# 在dev环境下编写一个安装ftp的sls文件\n[root@salt-master base]# cd /srv/salt/dev/\n[root@salt-master dev]# cat vsftpd.sls \nvsftpd-install:\n  pkg.installed:\n    - name: vsftpd\n\nvsftpd-service:\n  service.running:\n    - name: vsftpd\n    - enable: True\n```\n4、使用`salt`命令的`state`状态模块让`minion`应用配置\n```\n# 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）\n[root@salt-master ~]# salt '*' state.sls apache\n\n# 让所有的minion都安装vsftpd（saltenv指定环境）\n[root@salt-master ~]# salt '*' state.sls vsftpd saltenv=dev\n```\n5、使用`salt`的高级状态使不同主机应用不同的配置\n```\n# topfile入口文件只能放在base环境\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nbase:\n  'salt-minion01':\n    - apache\n  'salt-minion03':\n    - apache\ndev:\n  'salt-minion02':\n    - vsftpd\n  'salt-minion03':\n    - vsftpd\n```\n6、使用`salt`命令执行高级状态，会将`top.sls`当做入口文件，进行调用\n```\n# 将高级状态应用到所有主机\n[root@salt-master ~]# salt '*' state.highstate\n```\n## Saltstack常用配置\n1、**Salt Master配置**\n`Salt Master`端的配置文件`/etc/salt/master`，常用配置如下：\n```\ninterface: \t//指定bind 的地址(默认为0.0.0.0)\npublish_port: //指定发布端口(默认为4505)\nret_port: //指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)\nuser: //指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)\ntimeout: //指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)\nkeep_jobs: //minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)\njob_cache: //master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)\nfile_recv : //是否允许minion传送文件到master 上(默认是Flase)\nfile_roots: //指定file server目录,  默认为:\n    file_roots:    \n       base:    \n        - /srv/salt     \npillar_roots : //指定pillar 目录,  默认为:\n    pillar_roots:     \n      base:     \n        - /srv/pillar     \nlog_level: //日志级别\n支持的日志级别有'garbage', 'trace', 'debug', info', 'warning', 'error', ‘critical ’ ( 默认为’warning’)\n```\n2、`Salt Minion`端的配置文件`/etc/salt/minion`，常用配置如下：\n```\nmaster: //指定master 主机(默认为salt)\nmaster_port: //指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)\nid: //指定本minion的标识, salt内部使用id作为标识(默认为主机名)\nuser: //指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)\ncache_jobs : //minion是否缓存执行结果(默认为False)\nbackup_mode: //在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效\nproviders : //指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5\nrenderer: //指定配置管理系统中的渲染器(默认值为:yaml_jinja )\nfile_client : //指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)\nloglevel: //指定日志级别(默认为warning)\ntcp_keepalive : //minion 是否与master 保持keepalive 检查, zeromq3(默认为True)\n```\n","source":"_posts/saltstack基本入门.md","raw":"---\ntitle: saltstack基本入门\ndate: 2019-05-13 15:47:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## saltstack介绍\n<div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n**主要功能**\n远程执行\n配置管理\n[Stalstack官方文档](http://docs.saltstack.cn/)\n## Saltstack原理\n>`Salt`使用`server-agent`通信模型，服务端组件被称为`Salt master`，`agent`被称为`Salt minion`\n`Salt master`主要负责向`Salt minions`发送命令，然后聚合并显示这些命令的结果。一个`Salt master`可以管理多个`minion`系统\n`Salt server`与`Salt minion`通信的连接由`Salt minion`发起，这也意味着`Salt minion`上不需要打开任何传入端口（从而减少攻击）。`Salt server`使用端口`4505`和`4506`，必须打开端口才能接收到访问连接\n\n![通信示例图](https://upload-images.jianshu.io/upload_images/11763553-2ead569e18094825.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n- **Publisher** （端口4505）所有`Salt minions`都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。\n- **Request Server** （端口4506）`Salt minios`根据需要连接到请求服务器，将结果发送给`Salt master`，并安全地获取请求的文件或特定`minion`相关的数据值（称为`Salt pillar`）。连接到这个端口的连接在`Salt master`和`Salt minion`之间是1:1（不是异步）。\n\n```\n[root@salt-master ~]# lsof -i:4505\nCOMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nsalt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)\nsalt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505->salt-minion03:37240 (ESTABLISHED)\nsalt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505->salt-minion01:47804 (ESTABLISHED)\nsalt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505->salt-minion02:58594 (ESTABLISHED)\n```\n\n## 快速安装\n1.1 配置 yum 仓库\n```\n# 使用官方自带yum\n[root@salt-master ~]# yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm\n# 或者使用阿里云的yum（建议使用阿里云的，速度快一点）\n[root@salt-master ~]# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n[root@salt-master ~]# sed -i \"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\" /etc/yum.repos.d/salt-latest.repo\n[root@salt-master ~]# yum clean all\n[root@salt-master ~]# yum makecache\n```\n1.2 安装Master，并启动服务\n```\n[root@salt-master ~]# yum -y install salt-master\n[root@salt-master ~]# systemctl enable salt-master\n[root@salt-master ~]# systemctl start salt-master\n```\n1.3 安装 Salt-Minion 指向 Salt-Master 网络地址\n```\n[root@salt-minion01 ~]# yum -y install salt-minion\n# 可以使用主机名，也可以使用IP地址\n[root@salt-minion01 ~]# cp /etc/salt/minion{,.back}\n[root@salt-minion01 ~]# sed -i '/#master: /c\\master: salt-master' /etc/salt/minion\n[root@salt-minion01 ~]# systemctl enable salt-minion\n[root@salt-minion01 ~]# systemctl start salt-minion\n```\n##  SaltStack认证方式\n![master与minion之间的架构关系图](https://upload-images.jianshu.io/upload_images/11763553-51113b6686102c1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n<div class=\"note success\"><p> `Salt` 的数据传输是通过 `AES` 加密，`Master` 和 `Minion` 之前在通信之前，需要进行认证。\n`Salt` 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  `minion` 在第一次启动时候，会在 `/etc/salt/pki/minion/` 下自动生成 `minion.pem(private key)` 和 `minion.pub(public key) `, 然后将 `minion.pub` 发送给 `master `\n2. `master` 在第一次启动时，会在 `/etc/salt/pki/master/` 下自动生成 `master.pem` 和 `master.pub` ；并且会接收到 `minion` 的 `public key` , 通过 `salt-key` 命令接收 `minion public key`， 会在 `master` 的 `/etc/salt/pki/master/minions` 目录下存放以 `minion id` 命令的 `public key` ；验证成功后同时 `minion` 会保存一份 `master public key` 在 minion的 `/etc/salt/pki/minion/minion_master.pub`里。</p></div>\n\n**Salt认证原理总结**\n> `minion`将自己的公钥发送给`master`\n`master`认证后再将自己的公钥也发送给`minion`端\n\n**Master端认证示例**\n根据上面提到的认证原理，先看下未认证前的`master`和`minion`的`pki`目录\n```\n# master上查看\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   │   └── salt-minion01\n│   └── minions_rejected\n└── minion\n\n# minion上查看\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion.pem\n    └── minion.pub\n```\n`salt-key`命令解释：\n```\n[root@salt-master ~]# salt-key -L \nAccepted Keys:        #已经接受的key\nDenied Keys:          #拒绝的key\nUnaccepted Keys:      #未加入的key\nRejected Keys:        #吊销的key\n\n#常用参数\n-L  #查看KEY状态\n-A  #允许所有\n-D  #删除所有\n-a  #认证指定的key\n-d  #删除指定的key\n-r  #注销掉指定key（该状态为未被认证）\n\n#配置master自动接受请求认证(master上配置 /etc/salt/master)\nauto_accept: True\n```\n`salt-key`认证\n```\n#列出当前所有的key\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nDenied Keys:\nUnaccepted Keys:\nsalt-minion01\nRejected Keys:\n\n#添加指定minion的key\n[root@salt-master ~]# salt-key -a salt-minion01 -y\nThe following keys are going to be accepted:\nUnaccepted Keys:\nsalt-minion01\nKey for minion salt-minion01 accepted.\n#添加所有minion的key\n[root@salt-master ~]# salt-key -A -y\n\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nsalt-minion01\nDenied Keys:\nUnaccepted Keys:\nRejected Keys:\n```\n上面认证完成后再次查看`master`和`minion`的`pki`目录\n```\n# master上\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   │   └── salt-minion01\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   └── minions_rejected\n└── minion\n\n# minion上\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion_master.pub\n    ├── minion.pem\n    └── minion.pub\n```\n## Saltstack远程执行\n>远程执行是 `Saltstack` 的核心功能之一。主要使用 `salt` 模块批量给选定的 `minion` 端执行相应的命令，并获得返回结果。\n\n1、判断 `salt` 的 `minion` 主机是否存活\n```\n[root@salt-master ~]# salt '*' test.ping\nsalt-minion02:\n    True\nsalt-minion03:\n    True\nsalt-minion01:\n    True\n\n# salt saltstack自带的一个命令\n# * 表示目标主机，这里表示所有目标主机\n# test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法\n```\n2、`saltstack`使用 `cmd.run`模块远程执行shell命令\n```\n#在指定目标minion节点运行uptime命令\n[root@salt-master ~]# salt 'salt-minion02' cmd.run 'uptime'\nsalt-minion02:\n     18:13:08 up 28 min,  2 users,  load average: 0.00, 0.04, 0.13\n```\n## Saltstack配置管理\n<div class=\"note success\"><p>`Salt` 通过`State`模块来进行文件的管理；通过`YAML`语法来描述，后缀是`.sls`的文件</p></div>1、了解 `YAML` 参考：http://docs.saltstack.cn/topics/yaml/index.html\n```\nremove vim:\n  pkg.removed:\n    - name: vim\n```\n- 带有ID和每个函数调用的行都以冒号（:)结束。\n- 每个函数调用在ID下面缩进两个空格。\n- 参数作为列表传递给每个函数。\n- 每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。\n- 如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。\n- 如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格\n\n2、配置`sals` ,定义环境   [参考文档](https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md)\n```\n# 定义环境目录\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n# 创建上面定义的目录\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n# 重启服务\n[root@salt-master ~]# systemctl restart salt-master\n```\n3、编写第一个`sls`文件\n```\n# 在base环境下编写第一个安装apache的sls文件\n[root@salt-master ~]# cd /srv/salt/base/\n[root@salt-master base]# cat apache.sls \napache-install:\n  pkg.installed:\n    - name: httpd\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n# 在dev环境下编写一个安装ftp的sls文件\n[root@salt-master base]# cd /srv/salt/dev/\n[root@salt-master dev]# cat vsftpd.sls \nvsftpd-install:\n  pkg.installed:\n    - name: vsftpd\n\nvsftpd-service:\n  service.running:\n    - name: vsftpd\n    - enable: True\n```\n4、使用`salt`命令的`state`状态模块让`minion`应用配置\n```\n# 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）\n[root@salt-master ~]# salt '*' state.sls apache\n\n# 让所有的minion都安装vsftpd（saltenv指定环境）\n[root@salt-master ~]# salt '*' state.sls vsftpd saltenv=dev\n```\n5、使用`salt`的高级状态使不同主机应用不同的配置\n```\n# topfile入口文件只能放在base环境\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nbase:\n  'salt-minion01':\n    - apache\n  'salt-minion03':\n    - apache\ndev:\n  'salt-minion02':\n    - vsftpd\n  'salt-minion03':\n    - vsftpd\n```\n6、使用`salt`命令执行高级状态，会将`top.sls`当做入口文件，进行调用\n```\n# 将高级状态应用到所有主机\n[root@salt-master ~]# salt '*' state.highstate\n```\n## Saltstack常用配置\n1、**Salt Master配置**\n`Salt Master`端的配置文件`/etc/salt/master`，常用配置如下：\n```\ninterface: \t//指定bind 的地址(默认为0.0.0.0)\npublish_port: //指定发布端口(默认为4505)\nret_port: //指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)\nuser: //指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)\ntimeout: //指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)\nkeep_jobs: //minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)\njob_cache: //master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)\nfile_recv : //是否允许minion传送文件到master 上(默认是Flase)\nfile_roots: //指定file server目录,  默认为:\n    file_roots:    \n       base:    \n        - /srv/salt     \npillar_roots : //指定pillar 目录,  默认为:\n    pillar_roots:     \n      base:     \n        - /srv/pillar     \nlog_level: //日志级别\n支持的日志级别有'garbage', 'trace', 'debug', info', 'warning', 'error', ‘critical ’ ( 默认为’warning’)\n```\n2、`Salt Minion`端的配置文件`/etc/salt/minion`，常用配置如下：\n```\nmaster: //指定master 主机(默认为salt)\nmaster_port: //指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)\nid: //指定本minion的标识, salt内部使用id作为标识(默认为主机名)\nuser: //指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)\ncache_jobs : //minion是否缓存执行结果(默认为False)\nbackup_mode: //在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效\nproviders : //指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5\nrenderer: //指定配置管理系统中的渲染器(默认值为:yaml_jinja )\nfile_client : //指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)\nloglevel: //指定日志级别(默认为warning)\ntcp_keepalive : //minion 是否与master 保持keepalive 检查, zeromq3(默认为True)\n```\n","slug":"saltstack基本入门","published":1,"updated":"2019-05-16T04:35:44.307Z","_id":"cjvqpru4i000tzt34xpxhio5h","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"saltstack介绍\"><a href=\"#saltstack介绍\" class=\"headerlink\" title=\"saltstack介绍\"></a>saltstack介绍</h2><div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n<p><strong>主要功能</strong><br>远程执行<br>配置管理<br><a href=\"http://docs.saltstack.cn/\" target=\"_blank\" rel=\"noopener\">Stalstack官方文档</a></p>\n<h2 id=\"Saltstack原理\"><a href=\"#Saltstack原理\" class=\"headerlink\" title=\"Saltstack原理\"></a>Saltstack原理</h2><blockquote>\n<p><code>Salt</code>使用<code>server-agent</code>通信模型，服务端组件被称为<code>Salt master</code>，<code>agent</code>被称为<code>Salt minion</code><br><code>Salt master</code>主要负责向<code>Salt minions</code>发送命令，然后聚合并显示这些命令的结果。一个<code>Salt master</code>可以管理多个<code>minion</code>系统<br><code>Salt server</code>与<code>Salt minion</code>通信的连接由<code>Salt minion</code>发起，这也意味着<code>Salt minion</code>上不需要打开任何传入端口（从而减少攻击）。<code>Salt server</code>使用端口<code>4505</code>和<code>4506</code>，必须打开端口才能接收到访问连接</p>\n</blockquote>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-2ead569e18094825.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"通信示例图\"></p>\n<ul>\n<li><strong>Publisher</strong> （端口4505）所有<code>Salt minions</code>都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。</li>\n<li><strong>Request Server</strong> （端口4506）<code>Salt minios</code>根据需要连接到请求服务器，将结果发送给<code>Salt master</code>，并安全地获取请求的文件或特定<code>minion</code>相关的数据值（称为<code>Salt pillar</code>）。连接到这个端口的连接在<code>Salt master</code>和<code>Salt minion</code>之间是1:1（不是异步）。</li>\n</ul>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# lsof -i:4505</span><br><span class=\"line\">COMMAND     PID<span class=\"built_in\"> USER </span>  FD  <span class=\"built_in\"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">salt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)</span><br><span class=\"line\">salt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505-&gt;salt-minion03:37240 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505-&gt;salt-minion01:47804 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505-&gt;salt-minion02:58594 (ESTABLISHED)</span><br></pre></td></tr></table></figure>\n<h2 id=\"快速安装\"><a href=\"#快速安装\" class=\"headerlink\" title=\"快速安装\"></a>快速安装</h2><p>1.1 配置 yum 仓库<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用官方自带yum</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm</span><br><span class=\"line\"><span class=\"comment\"># 或者使用阿里云的yum（建议使用阿里云的，速度快一点）</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class=\"number\">2</span>.el7.noarch.rpm</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# sed</span> -i <span class=\"string\">\"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> clean all</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> makecache</span><br></pre></td></tr></table></figure></p>\n<p>1.2 安装Master，并启动服务<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> enable salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>1.3 安装 Salt-Minion 指向 Salt-Master 网络地址<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># yum -y install salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># 可以使用主机名，也可以使用IP地址</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># sed -i <span class=\"string\">'/#master: /c\\master: salt-master'</span> /etc/salt/minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl enable salt-minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"SaltStack认证方式\"><a href=\"#SaltStack认证方式\" class=\"headerlink\" title=\"SaltStack认证方式\"></a>SaltStack认证方式</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-51113b6686102c1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"master与minion之间的架构关系图\"></p>\n<div class=\"note success\"><p> <code>Salt</code> 的数据传输是通过 <code>AES</code> 加密，<code>Master</code> 和 <code>Minion</code> 之前在通信之前，需要进行认证。<br><code>Salt</code> 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  <code>minion</code> 在第一次启动时候，会在 <code>/etc/salt/pki/minion/</code> 下自动生成 <code>minion.pem(private key)</code> 和 <code>minion.pub(public key)</code>, 然后将 <code>minion.pub</code> 发送给 <code>master</code><br>2. <code>master</code> 在第一次启动时，会在 <code>/etc/salt/pki/master/</code> 下自动生成 <code>master.pem</code> 和 <code>master.pub</code> ；并且会接收到 <code>minion</code> 的 <code>public key</code> , 通过 <code>salt-key</code> 命令接收 <code>minion public key</code>， 会在 <code>master</code> 的 <code>/etc/salt/pki/master/minions</code> 目录下存放以 <code>minion id</code> 命令的 <code>public key</code> ；验证成功后同时 <code>minion</code> 会保存一份 <code>master public key</code> 在 minion的 <code>/etc/salt/pki/minion/minion_master.pub</code>里。</p></div>\n\n<p><strong>Salt认证原理总结</strong></p>\n<blockquote>\n<p><code>minion</code>将自己的公钥发送给<code>master</code><br><code>master</code>认证后再将自己的公钥也发送给<code>minion</code>端</p>\n</blockquote>\n<p><strong>Master端认证示例</strong><br>根据上面提到的认证原理，先看下未认证前的<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上查看</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上查看</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>命令解释：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-key</span> <span class=\"bullet\">-L</span> </span><br><span class=\"line\"><span class=\"string\">Accepted</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#已经接受的key</span></span><br><span class=\"line\"><span class=\"string\">Denied</span> <span class=\"attr\">Keys:</span>          <span class=\"comment\">#拒绝的key</span></span><br><span class=\"line\"><span class=\"string\">Unaccepted</span> <span class=\"attr\">Keys:</span>      <span class=\"comment\">#未加入的key</span></span><br><span class=\"line\"><span class=\"string\">Rejected</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#吊销的key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#常用参数</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">L</span>  <span class=\"comment\">#查看KEY状态</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">A</span>  <span class=\"comment\">#允许所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">D</span>  <span class=\"comment\">#删除所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">a</span>  <span class=\"comment\">#认证指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">d</span>  <span class=\"comment\">#删除指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">r</span>  <span class=\"comment\">#注销掉指定key（该状态为未被认证）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置master自动接受请求认证(master上配置 /etc/salt/master)</span></span><br><span class=\"line\"><span class=\"attr\">auto_accept:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>认证<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#列出当前所有的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加指定minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -a salt-minion01 -y</span><br><span class=\"line\">The following keys are going to be accepted:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Key for minion salt-minion01 accepted.</span><br><span class=\"line\"><span class=\"comment\">#添加所有minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -A -y</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">Rejected Keys:</span><br></pre></td></tr></table></figure></p>\n<p>上面认证完成后再次查看<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion_master.pub</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack远程执行\"><a href=\"#Saltstack远程执行\" class=\"headerlink\" title=\"Saltstack远程执行\"></a>Saltstack远程执行</h2><blockquote>\n<p>远程执行是 <code>Saltstack</code> 的核心功能之一。主要使用 <code>salt</code> 模块批量给选定的 <code>minion</code> 端执行相应的命令，并获得返回结果。</p>\n</blockquote>\n<p>1、判断 <code>salt</code> 的 <code>minion</code> 主机是否存活<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt</span> <span class=\"string\">'*'</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion03:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># salt saltstack自带的一个命令</span></span><br><span class=\"line\"><span class=\"comment\"># * 表示目标主机，这里表示所有目标主机</span></span><br><span class=\"line\"><span class=\"comment\"># test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法</span></span><br></pre></td></tr></table></figure></p>\n<p>2、<code>saltstack</code>使用 <code>cmd.run</code>模块远程执行shell命令<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#在指定目标minion节点运行uptime命令</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion02'</span> cmd.run <span class=\"string\">'uptime'</span></span></span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">     <span class=\"number\">18</span>:<span class=\"number\">13</span>:<span class=\"number\">08</span> up <span class=\"number\">28</span> min,  <span class=\"number\">2</span> users,  load average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.13</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack配置管理\"><a href=\"#Saltstack配置管理\" class=\"headerlink\" title=\"Saltstack配置管理\"></a>Saltstack配置管理</h2><p><div class=\"note success\"><p><code>Salt</code> 通过<code>State</code>模块来进行文件的管理；通过<code>YAML</code>语法来描述，后缀是<code>.sls</code>的文件</p></div>1、了解 <code>YAML</code> 参考：<a href=\"http://docs.saltstack.cn/topics/yaml/index.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/yaml/index.html</a><br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">remove <span class=\"string\">vim:</span></span><br><span class=\"line\">  pkg.<span class=\"string\">removed:</span></span><br><span class=\"line\">    - <span class=\"string\">name:</span> vim</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>带有ID和每个函数调用的行都以冒号（:)结束。</li>\n<li>每个函数调用在ID下面缩进两个空格。</li>\n<li>参数作为列表传递给每个函数。</li>\n<li>每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。</li>\n<li>如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。</li>\n<li>如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格</li>\n</ul>\n<p>2、配置<code>sals</code> ,定义环境   <a href=\"https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md\" target=\"_blank\" rel=\"noopener\">参考文档</a><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义环境目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">file_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/salt/base</span><br><span class=\"line\">  dev:</span><br><span class=\"line\">    - /srv/salt/dev</span><br><span class=\"line\">  prod:</span><br><span class=\"line\">    - /srv/salt/prod</span><br><span class=\"line\"><span class=\"comment\"># 创建上面定义的目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\"><span class=\"comment\"># 重启服务</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>3、编写第一个<code>sls</code>文件<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在base环境下编写第一个安装apache的sls文件</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cd /srv/salt/base/</span></span><br><span class=\"line\">[root@salt-master base]<span class=\"comment\"># cat apache.sls </span></span><br><span class=\"line\">apache-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在dev环境下编写一个安装ftp的sls文件</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> base]<span class=\"comment\"># cd /srv/salt/dev/</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> dev]<span class=\"comment\"># cat vsftpd.sls </span></span><br><span class=\"line\">vsftpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\"></span><br><span class=\"line\">vsftpd-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4、使用<code>salt</code>命令的<code>state</code>状态模块让<code>minion</code>应用配置<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls apache</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装vsftpd（saltenv指定环境）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls vsftpd saltenv=dev</span></span><br></pre></td></tr></table></figure></p>\n<p>5、使用<code>salt</code>的高级状态使不同主机应用不同的配置<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># topfile入口文件只能放在base环境</span></span><br><span class=\"line\">[<span class=\"meta\">root@salt-master ~</span>]<span class=\"meta\"># cat /srv/salt/base/top.sls </span></span><br><span class=\"line\"><span class=\"keyword\">base</span>:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion01'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">dev:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion02'</span>:</span><br><span class=\"line\">    - vsftpd</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - vsftpd</span><br></pre></td></tr></table></figure></p>\n<p>6、使用<code>salt</code>命令执行高级状态，会将<code>top.sls</code>当做入口文件，进行调用<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 将高级状态应用到所有主机</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack常用配置\"><a href=\"#Saltstack常用配置\" class=\"headerlink\" title=\"Saltstack常用配置\"></a>Saltstack常用配置</h2><p>1、<strong>Salt Master配置</strong><br><code>Salt Master</code>端的配置文件<code>/etc/salt/master</code>，常用配置如下：<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">interface</span>: \t<span class=\"comment\">//指定bind 的地址(默认为0.0.0.0)</span></span><br><span class=\"line\"><span class=\"attribute\">publish_port</span>: <span class=\"comment\">//指定发布端口(默认为4505)</span></span><br><span class=\"line\"><span class=\"attribute\">ret_port</span>: <span class=\"comment\">//指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"attribute\">user</span>: <span class=\"comment\">//指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)</span></span><br><span class=\"line\"><span class=\"attribute\">timeout</span>: <span class=\"comment\">//指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)</span></span><br><span class=\"line\"><span class=\"attribute\">keep_jobs</span>: <span class=\"comment\">//minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)</span></span><br><span class=\"line\"><span class=\"attribute\">job_cache</span>: <span class=\"comment\">//master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)</span></span><br><span class=\"line\"><span class=\"attribute\">file_recv </span>: <span class=\"comment\">//是否允许minion传送文件到master 上(默认是Flase)</span></span><br><span class=\"line\"><span class=\"attribute\">file_roots</span>: <span class=\"comment\">//指定file server目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">file_roots</span>:    </span><br><span class=\"line\">       <span class=\"attribute\">base</span>:    </span><br><span class=\"line\">        - /srv/salt     </span><br><span class=\"line\"><span class=\"attribute\">pillar_roots </span>: <span class=\"comment\">//指定pillar 目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">pillar_roots</span>:     </span><br><span class=\"line\">      <span class=\"attribute\">base</span>:     </span><br><span class=\"line\">        - /srv/pillar     </span><br><span class=\"line\"><span class=\"attribute\">log_level</span>: <span class=\"comment\">//日志级别</span></span><br><span class=\"line\">支持的日志级别有<span class=\"string\">'garbage'</span>, <span class=\"string\">'trace'</span>, <span class=\"string\">'debug'</span>, info<span class=\"string\">', '</span>warning<span class=\"string\">', '</span>error', ‘critical ’ ( 默认为’warning’)</span><br></pre></td></tr></table></figure></p>\n<p>2、<code>Salt Minion</code>端的配置文件<code>/etc/salt/minion</code>，常用配置如下：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">master:</span> <span class=\"comment\">//指定master 主机(默认为salt)</span></span><br><span class=\"line\"><span class=\"string\">master_port:</span> <span class=\"comment\">//指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"string\">id:</span> <span class=\"comment\">//指定本minion的标识, salt内部使用id作为标识(默认为主机名)</span></span><br><span class=\"line\"><span class=\"string\">user:</span> <span class=\"comment\">//指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)</span></span><br><span class=\"line\"><span class=\"string\">cache_jobs :</span> <span class=\"comment\">//minion是否缓存执行结果(默认为False)</span></span><br><span class=\"line\"><span class=\"string\">backup_mode:</span> <span class=\"comment\">//在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效</span></span><br><span class=\"line\"><span class=\"string\">providers :</span> <span class=\"comment\">//指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5</span></span><br><span class=\"line\"><span class=\"string\">renderer:</span> <span class=\"comment\">//指定配置管理系统中的渲染器(默认值为:yaml_jinja )</span></span><br><span class=\"line\"><span class=\"string\">file_client :</span> <span class=\"comment\">//指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)</span></span><br><span class=\"line\"><span class=\"string\">loglevel:</span> <span class=\"comment\">//指定日志级别(默认为warning)</span></span><br><span class=\"line\"><span class=\"string\">tcp_keepalive :</span> <span class=\"comment\">//minion 是否与master 保持keepalive 检查, zeromq3(默认为True)</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"saltstack介绍\"><a href=\"#saltstack介绍\" class=\"headerlink\" title=\"saltstack介绍\"></a>saltstack介绍</h2><div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n<p><strong>主要功能</strong><br>远程执行<br>配置管理<br><a href=\"http://docs.saltstack.cn/\" target=\"_blank\" rel=\"noopener\">Stalstack官方文档</a></p>\n<h2 id=\"Saltstack原理\"><a href=\"#Saltstack原理\" class=\"headerlink\" title=\"Saltstack原理\"></a>Saltstack原理</h2><blockquote>\n<p><code>Salt</code>使用<code>server-agent</code>通信模型，服务端组件被称为<code>Salt master</code>，<code>agent</code>被称为<code>Salt minion</code><br><code>Salt master</code>主要负责向<code>Salt minions</code>发送命令，然后聚合并显示这些命令的结果。一个<code>Salt master</code>可以管理多个<code>minion</code>系统<br><code>Salt server</code>与<code>Salt minion</code>通信的连接由<code>Salt minion</code>发起，这也意味着<code>Salt minion</code>上不需要打开任何传入端口（从而减少攻击）。<code>Salt server</code>使用端口<code>4505</code>和<code>4506</code>，必须打开端口才能接收到访问连接</p>\n</blockquote>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-2ead569e18094825.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"通信示例图\"></p>\n<ul>\n<li><strong>Publisher</strong> （端口4505）所有<code>Salt minions</code>都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。</li>\n<li><strong>Request Server</strong> （端口4506）<code>Salt minios</code>根据需要连接到请求服务器，将结果发送给<code>Salt master</code>，并安全地获取请求的文件或特定<code>minion</code>相关的数据值（称为<code>Salt pillar</code>）。连接到这个端口的连接在<code>Salt master</code>和<code>Salt minion</code>之间是1:1（不是异步）。</li>\n</ul>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# lsof -i:4505</span><br><span class=\"line\">COMMAND     PID<span class=\"built_in\"> USER </span>  FD  <span class=\"built_in\"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">salt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)</span><br><span class=\"line\">salt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505-&gt;salt-minion03:37240 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505-&gt;salt-minion01:47804 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505-&gt;salt-minion02:58594 (ESTABLISHED)</span><br></pre></td></tr></table></figure>\n<h2 id=\"快速安装\"><a href=\"#快速安装\" class=\"headerlink\" title=\"快速安装\"></a>快速安装</h2><p>1.1 配置 yum 仓库<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用官方自带yum</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm</span><br><span class=\"line\"><span class=\"comment\"># 或者使用阿里云的yum（建议使用阿里云的，速度快一点）</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class=\"number\">2</span>.el7.noarch.rpm</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# sed</span> -i <span class=\"string\">\"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> clean all</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> makecache</span><br></pre></td></tr></table></figure></p>\n<p>1.2 安装Master，并启动服务<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> enable salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>1.3 安装 Salt-Minion 指向 Salt-Master 网络地址<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># yum -y install salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># 可以使用主机名，也可以使用IP地址</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># sed -i <span class=\"string\">'/#master: /c\\master: salt-master'</span> /etc/salt/minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl enable salt-minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"SaltStack认证方式\"><a href=\"#SaltStack认证方式\" class=\"headerlink\" title=\"SaltStack认证方式\"></a>SaltStack认证方式</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-51113b6686102c1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"master与minion之间的架构关系图\"></p>\n<div class=\"note success\"><p> <code>Salt</code> 的数据传输是通过 <code>AES</code> 加密，<code>Master</code> 和 <code>Minion</code> 之前在通信之前，需要进行认证。<br><code>Salt</code> 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  <code>minion</code> 在第一次启动时候，会在 <code>/etc/salt/pki/minion/</code> 下自动生成 <code>minion.pem(private key)</code> 和 <code>minion.pub(public key)</code>, 然后将 <code>minion.pub</code> 发送给 <code>master</code><br>2. <code>master</code> 在第一次启动时，会在 <code>/etc/salt/pki/master/</code> 下自动生成 <code>master.pem</code> 和 <code>master.pub</code> ；并且会接收到 <code>minion</code> 的 <code>public key</code> , 通过 <code>salt-key</code> 命令接收 <code>minion public key</code>， 会在 <code>master</code> 的 <code>/etc/salt/pki/master/minions</code> 目录下存放以 <code>minion id</code> 命令的 <code>public key</code> ；验证成功后同时 <code>minion</code> 会保存一份 <code>master public key</code> 在 minion的 <code>/etc/salt/pki/minion/minion_master.pub</code>里。</p></div>\n\n<p><strong>Salt认证原理总结</strong></p>\n<blockquote>\n<p><code>minion</code>将自己的公钥发送给<code>master</code><br><code>master</code>认证后再将自己的公钥也发送给<code>minion</code>端</p>\n</blockquote>\n<p><strong>Master端认证示例</strong><br>根据上面提到的认证原理，先看下未认证前的<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上查看</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上查看</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>命令解释：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-key</span> <span class=\"bullet\">-L</span> </span><br><span class=\"line\"><span class=\"string\">Accepted</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#已经接受的key</span></span><br><span class=\"line\"><span class=\"string\">Denied</span> <span class=\"attr\">Keys:</span>          <span class=\"comment\">#拒绝的key</span></span><br><span class=\"line\"><span class=\"string\">Unaccepted</span> <span class=\"attr\">Keys:</span>      <span class=\"comment\">#未加入的key</span></span><br><span class=\"line\"><span class=\"string\">Rejected</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#吊销的key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#常用参数</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">L</span>  <span class=\"comment\">#查看KEY状态</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">A</span>  <span class=\"comment\">#允许所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">D</span>  <span class=\"comment\">#删除所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">a</span>  <span class=\"comment\">#认证指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">d</span>  <span class=\"comment\">#删除指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">r</span>  <span class=\"comment\">#注销掉指定key（该状态为未被认证）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置master自动接受请求认证(master上配置 /etc/salt/master)</span></span><br><span class=\"line\"><span class=\"attr\">auto_accept:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>认证<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#列出当前所有的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加指定minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -a salt-minion01 -y</span><br><span class=\"line\">The following keys are going to be accepted:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Key for minion salt-minion01 accepted.</span><br><span class=\"line\"><span class=\"comment\">#添加所有minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -A -y</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">Rejected Keys:</span><br></pre></td></tr></table></figure></p>\n<p>上面认证完成后再次查看<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion_master.pub</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack远程执行\"><a href=\"#Saltstack远程执行\" class=\"headerlink\" title=\"Saltstack远程执行\"></a>Saltstack远程执行</h2><blockquote>\n<p>远程执行是 <code>Saltstack</code> 的核心功能之一。主要使用 <code>salt</code> 模块批量给选定的 <code>minion</code> 端执行相应的命令，并获得返回结果。</p>\n</blockquote>\n<p>1、判断 <code>salt</code> 的 <code>minion</code> 主机是否存活<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt</span> <span class=\"string\">'*'</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion03:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># salt saltstack自带的一个命令</span></span><br><span class=\"line\"><span class=\"comment\"># * 表示目标主机，这里表示所有目标主机</span></span><br><span class=\"line\"><span class=\"comment\"># test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法</span></span><br></pre></td></tr></table></figure></p>\n<p>2、<code>saltstack</code>使用 <code>cmd.run</code>模块远程执行shell命令<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#在指定目标minion节点运行uptime命令</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion02'</span> cmd.run <span class=\"string\">'uptime'</span></span></span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">     <span class=\"number\">18</span>:<span class=\"number\">13</span>:<span class=\"number\">08</span> up <span class=\"number\">28</span> min,  <span class=\"number\">2</span> users,  load average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.13</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack配置管理\"><a href=\"#Saltstack配置管理\" class=\"headerlink\" title=\"Saltstack配置管理\"></a>Saltstack配置管理</h2><p><div class=\"note success\"><p><code>Salt</code> 通过<code>State</code>模块来进行文件的管理；通过<code>YAML</code>语法来描述，后缀是<code>.sls</code>的文件</p></div>1、了解 <code>YAML</code> 参考：<a href=\"http://docs.saltstack.cn/topics/yaml/index.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/yaml/index.html</a><br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">remove <span class=\"string\">vim:</span></span><br><span class=\"line\">  pkg.<span class=\"string\">removed:</span></span><br><span class=\"line\">    - <span class=\"string\">name:</span> vim</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>带有ID和每个函数调用的行都以冒号（:)结束。</li>\n<li>每个函数调用在ID下面缩进两个空格。</li>\n<li>参数作为列表传递给每个函数。</li>\n<li>每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。</li>\n<li>如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。</li>\n<li>如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格</li>\n</ul>\n<p>2、配置<code>sals</code> ,定义环境   <a href=\"https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md\" target=\"_blank\" rel=\"noopener\">参考文档</a><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义环境目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">file_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/salt/base</span><br><span class=\"line\">  dev:</span><br><span class=\"line\">    - /srv/salt/dev</span><br><span class=\"line\">  prod:</span><br><span class=\"line\">    - /srv/salt/prod</span><br><span class=\"line\"><span class=\"comment\"># 创建上面定义的目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\"><span class=\"comment\"># 重启服务</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>3、编写第一个<code>sls</code>文件<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在base环境下编写第一个安装apache的sls文件</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cd /srv/salt/base/</span></span><br><span class=\"line\">[root@salt-master base]<span class=\"comment\"># cat apache.sls </span></span><br><span class=\"line\">apache-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在dev环境下编写一个安装ftp的sls文件</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> base]<span class=\"comment\"># cd /srv/salt/dev/</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> dev]<span class=\"comment\"># cat vsftpd.sls </span></span><br><span class=\"line\">vsftpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\"></span><br><span class=\"line\">vsftpd-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4、使用<code>salt</code>命令的<code>state</code>状态模块让<code>minion</code>应用配置<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls apache</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装vsftpd（saltenv指定环境）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls vsftpd saltenv=dev</span></span><br></pre></td></tr></table></figure></p>\n<p>5、使用<code>salt</code>的高级状态使不同主机应用不同的配置<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># topfile入口文件只能放在base环境</span></span><br><span class=\"line\">[<span class=\"meta\">root@salt-master ~</span>]<span class=\"meta\"># cat /srv/salt/base/top.sls </span></span><br><span class=\"line\"><span class=\"keyword\">base</span>:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion01'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">dev:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion02'</span>:</span><br><span class=\"line\">    - vsftpd</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - vsftpd</span><br></pre></td></tr></table></figure></p>\n<p>6、使用<code>salt</code>命令执行高级状态，会将<code>top.sls</code>当做入口文件，进行调用<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 将高级状态应用到所有主机</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack常用配置\"><a href=\"#Saltstack常用配置\" class=\"headerlink\" title=\"Saltstack常用配置\"></a>Saltstack常用配置</h2><p>1、<strong>Salt Master配置</strong><br><code>Salt Master</code>端的配置文件<code>/etc/salt/master</code>，常用配置如下：<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">interface</span>: \t<span class=\"comment\">//指定bind 的地址(默认为0.0.0.0)</span></span><br><span class=\"line\"><span class=\"attribute\">publish_port</span>: <span class=\"comment\">//指定发布端口(默认为4505)</span></span><br><span class=\"line\"><span class=\"attribute\">ret_port</span>: <span class=\"comment\">//指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"attribute\">user</span>: <span class=\"comment\">//指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)</span></span><br><span class=\"line\"><span class=\"attribute\">timeout</span>: <span class=\"comment\">//指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)</span></span><br><span class=\"line\"><span class=\"attribute\">keep_jobs</span>: <span class=\"comment\">//minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)</span></span><br><span class=\"line\"><span class=\"attribute\">job_cache</span>: <span class=\"comment\">//master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)</span></span><br><span class=\"line\"><span class=\"attribute\">file_recv </span>: <span class=\"comment\">//是否允许minion传送文件到master 上(默认是Flase)</span></span><br><span class=\"line\"><span class=\"attribute\">file_roots</span>: <span class=\"comment\">//指定file server目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">file_roots</span>:    </span><br><span class=\"line\">       <span class=\"attribute\">base</span>:    </span><br><span class=\"line\">        - /srv/salt     </span><br><span class=\"line\"><span class=\"attribute\">pillar_roots </span>: <span class=\"comment\">//指定pillar 目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">pillar_roots</span>:     </span><br><span class=\"line\">      <span class=\"attribute\">base</span>:     </span><br><span class=\"line\">        - /srv/pillar     </span><br><span class=\"line\"><span class=\"attribute\">log_level</span>: <span class=\"comment\">//日志级别</span></span><br><span class=\"line\">支持的日志级别有<span class=\"string\">'garbage'</span>, <span class=\"string\">'trace'</span>, <span class=\"string\">'debug'</span>, info<span class=\"string\">', '</span>warning<span class=\"string\">', '</span>error', ‘critical ’ ( 默认为’warning’)</span><br></pre></td></tr></table></figure></p>\n<p>2、<code>Salt Minion</code>端的配置文件<code>/etc/salt/minion</code>，常用配置如下：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">master:</span> <span class=\"comment\">//指定master 主机(默认为salt)</span></span><br><span class=\"line\"><span class=\"string\">master_port:</span> <span class=\"comment\">//指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"string\">id:</span> <span class=\"comment\">//指定本minion的标识, salt内部使用id作为标识(默认为主机名)</span></span><br><span class=\"line\"><span class=\"string\">user:</span> <span class=\"comment\">//指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)</span></span><br><span class=\"line\"><span class=\"string\">cache_jobs :</span> <span class=\"comment\">//minion是否缓存执行结果(默认为False)</span></span><br><span class=\"line\"><span class=\"string\">backup_mode:</span> <span class=\"comment\">//在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效</span></span><br><span class=\"line\"><span class=\"string\">providers :</span> <span class=\"comment\">//指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5</span></span><br><span class=\"line\"><span class=\"string\">renderer:</span> <span class=\"comment\">//指定配置管理系统中的渲染器(默认值为:yaml_jinja )</span></span><br><span class=\"line\"><span class=\"string\">file_client :</span> <span class=\"comment\">//指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)</span></span><br><span class=\"line\"><span class=\"string\">loglevel:</span> <span class=\"comment\">//指定日志级别(默认为warning)</span></span><br><span class=\"line\"><span class=\"string\">tcp_keepalive :</span> <span class=\"comment\">//minion 是否与master 保持keepalive 检查, zeromq3(默认为True)</span></span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack配置管理","date":"2019-05-15T15:42:05.000Z","copyright":true,"_content":"## Saltstack状态模块\n>远程执行模块的执行是过程式，而状态是对`minion`的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述`minion`的状态描述。\n它的和兴是写`sls(Salt State file)`文件，`sls`文件默认格式为`YAML`格式，并默认使用`jinja`模板，`jinja`是根据`django`的模板语言发展而来的语言，简单并强大，支持`for if `等循环语句。`salt state`主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。\n\n```\nmysql-install:   #ID声明，必须唯一\n  pkg.installed:   #state状态声明\n    - pkgs:   #选项声明\n      - mariadb:   #选项列表\n      - mariadb-server\n\n说明：\n一个ID只能出现一次\n一个ID下相同模块只能使用一次\n一个ID下不可以使用多个不同模块\n```\n模块帮助手册\n```\n#列出所有状态模块\n[root@salt-master ~]# salt '*' sys.list_modules\n#查看指定模块的所有方法\n[root@salt-master ~]# salt '*' sys.list_state_functions pkg\n#查看指定模块的使用方法\n[root@salt-master ~]# salt '*' sys.state_doc pkg\n#查看指定模块的指定方法的用法\n[root@salt-master ~]# salt '*' sys.state_doc pkg.installed\n```\n### pkg软件模块\n[pkg模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html)\n`pkg.installed` 软件安装\n```\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql: \">=5.4.16\"    #指定安装版本\n      - php-pdo\n      - php-cli\n```\n指定安装最新版本的软件\n```\nphp-install:\n  pkg.latest:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n```\n### file文件模块\n[file模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html)\n`file.managed` 下发文件，确保文件存在\n```\n[root@salt-master ~]# mkdir /srv/salt/base/files\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/base/files/\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\n说明：\n- name: 表示存放目的地址\n- source: 表示这个文件来自哪里（说明这个文件得提前准备）\n\n或者这样写，直接已目的地址命令ID，这样ID也表示目的地址\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\n/etc/httpd/conf/httpd.conf:\n  file.managed:\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n```\n```\n小示例：\n[root@salt-master ~]# cat /srv/salt/base/test.sls\n/tmp/passwd_back:\n  file.managed:\n    - source: salt://files/passwd\n    - user: root\n    - group: root\n    - mode: 644\n[root@salt-master ~]# cp /etc/passwd /srv/salt/base/files/\n[root@salt-master ~]# salt '*' state.sls test\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /tmp/passwd_back\"\nsalt-minion03:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion02:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion01:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\n```\n`file.directory` 建立目录\n```\n[root@salt-master ~]# cat /srv/salt/base/directory.sls\n/tmp/saltdir:\n  file.directory:\n    - user: root\n    - group: root\n    - mode: 755\n    - makedirs: True   #如果上一级目录不存在自动创建；类似（mkdir -p）\n\n[root@salt-master ~]# salt '*' state.sls directory\n[root@salt-master ~]# salt '*' cmd.run \"ls -d /tmp/saltdir\"\nsalt-minion03:\n    /tmp/saltdir\nsalt-minion02:\n    /tmp/saltdir\nsalt-minion01:\n    /tmp/saltdir\n```\n`file.recurse` 下发整个目录\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd_conf_dir.sls\nhttpd_conf_dir:\n  file.recurse:\n    - name: /etc/httpd/conf.d\n    - source: salt://files/conf.d\n    - file_mode: 600    #文件权限\n    - dir_mode: 755    #目录权限\n    - include_empty: True   #同步空目录\n    - clean: True    #使用后minion与master保持一致\n\n[root@salt-master ~]# rsync -avh /etc/httpd/conf.d /srv/salt/base/files/\n```\n`file.symlink` 建立软链接\n```\n[root@salt-master ~]# cat /srv/salt/base/target_link.sls\n/etc/grub.cfg:\n  file.symlink:\n    - target: /etc/grub2.cfg\n\n[root@salt-master ~]# salt '*' state.sls target_link\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /etc/grub.cfg\"\nsalt-minion03:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion01:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion02:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\n```\n### service服务模块\n[service模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html)\n```\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:\n  service.running:\n    - name: httpd   #服务名称\n    - enable: True    #开机自启动\n    - reload: True    #允许重载配置文件，不写则是restart\n\n或者这样写\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:   #即表示ID，又表示服务名\n  service.running:\n    - enable: True\n    - reload: True\n```\n\n## 高级状态模块\n>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 `top file`\n来进行管理。可以通过正则，`grain`模块，或分组名，来进行匹配，再下一级是要执行的`state`文件\n\n可以将我们的配置需求转换为`YAML`并在`Top file`文件中表示：\n\n![](https://upload-images.jianshu.io/upload_images/11763553-9098e5814f51b40c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n`Top file`示例\n```\nbase:\n  '*': #通过正则去匹配所有minion\n    - app.nginx\n\n  webserver: #定义的分组名称\n    - match: nodegroup\n    - app.cron\n\n  'os:centos':  #通过grains模块匹配\n    - match: grains\n    - nginx \n```\n`Top file` 高级状态的执行\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## LAMP架构案例\n说明：该案例在`prod`环境配置\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir /srv/salt/prod/{httpd,php,mysql,files}\n```\n3）配置文件准备及测试文件准备\n```\n[root@salt-master ~]# cp /etc/my.cnf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/php.ini  /srv/salt/prod/files/\n[root@salt-master ~]# echo \"<h1>LAMP html</h1>\" >>/srv/salt/prod/files/index.html\n[root@salt-master ~]# echo \"<?php phpinfo(); ?>\" >> /srv/salt/prod/files/index.php\n```\n4）编写`state sls`状态文件\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n\n#测试文件\n[root@salt-master ~]# cat /srv/salt/prod/testfile.sls\n/var/www/html/index.html:\n  file.managed:\n    - source: salt://files/index.html\n\n/var/www/html/index.php:\n  file.managed:\n    - source: salt://files/index.php\n```\n6）`topfile`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - httpd.init\n    - php.init\n    - mysql.init\n    - testfile\n```\n7）部署`LAMP`整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n```\n8）执行`topfile`\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## States状态依赖\n通过上面的`lamp`可以看出已经可以使用`state`模块来定义`minion`的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用`requisites`来进行控制\n>关系说明：\n1、`require` 我依赖某个状态，我依赖谁\n2、`require_in` 我被某个状态依赖，谁依赖我\n3、`watch` 我关注某个状态，当状态发生改变，进行`restart`或者`reload`操作\n4、`watch_in` 我被某个状态关注\n5、`include` 我引用谁\n\n1）修改上面`lamp`状态间依赖关系\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: apache-install   #表示上面apache-install执行成功，才能执行apache-config\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n    - require:\n      - file: apache-config\n    - watch:\n      - file: apache-config\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n    - reqiure_in:\n      - file: php-config\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: mariadb-install\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n    - reload: True\n    - require:\n      - file: mariadb-config\n    - watch:\n      - file: mariadb-config\n```\n2）修改引用关系后`include`\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── lamp.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n\n[root@salt-master ~]# cat /srv/salt/prod/lamp.sls\ninclude:\n  - httpd.init\n  - php.init\n  - mysql.init\n  - testfile\n\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - lamp\n```\n3）编写`SLS`技巧\n>1、按照状态分类，如果单独使用，清晰明了\n2、按照服务分类，可以被其它`SLS`引用\n\n## Jinja模板使用\n>配置文件一般灵活多变，比如配置`apache`的`IP`地址或者端口`PORT`等，则可以动态传值。\n[Jinja官档](http://docs.jinkan.org/docs/jinja2/)\n[salt jinja官档](https://docs.saltstack.com/en/latest/topics/jinja/index.html)\n\n`Jinja2` 模板包含变量和表达式，变量用 &#123;&#123; ... &#125;&#125; 包围，表达式用 &#123;&#37; ... &#37;&#125; 包围。变量使用示例：\n```\n[root@salt-master ~]# cat /srv/salt/base/var.sls \n{% set var= 'hello world!' %}\ntest_var:\n  cmd.run:\n    - name: echo \"测试变量 {{ var }}\"\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls var\nsalt-minion01:\n----------\n          ID: test_var\n    Function: cmd.run\n        Name: echo \"测试变量 hello world!\"\n      Result: True\n     Comment: Command \"echo \"测试变量 hello world!\"\" run\n     Started: 14:50:58.302424\n    Duration: 12.358 ms\n     Changes:   \n              ----------\n              pid:\n                  22510\n              retcode:\n                  0\n              stderr:\n              stdout:\n                  测试变量 hello world!\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  12.358 ms\n```\n`jinja2` 常用变量\n1、字符串类型\n```\n{% set var = 'test' %}  #定义变量\n{{ var }}  #调用变量\n```\n2、列表类型\n```\n{% set list = ['one', 'two', 'three'] %}\n{{ list[1] }}  #获取变量的第一个值\n```\n3、字典类型\n```\n{% set dict = {'key1':'value1', 'key2':'value2'} %}\n{{ dict['key1'] }}  #获取'key1'的值\n```\n示例1：`Saltstack`使用`jinja`模块配置`apache`监听端口\n```\n#1.告诉file状态模块，需要使用jinja\n    - template: jinja\n#2.列出参数列表\n    - defaults:\n      PORT: 8000\n#3.配置文件引用jinja模板\n{{ PORT }}\n\n# 配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n\n# 修改httpd.conf配置文件引用变量\nListen {{ PORT }}\n```\n示例2：使用`grinas` 方式进行赋值\n```\n#配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n      IPADDR: {{ grains['fqdn_ip4'][0] }}\n\n# 修改httpd.conf配置文件引用变量\nListen {{ IPADDR }}:{{ PORT }}\n```\n示例3：通过`jinja+grains`根据系统不同安装`apache`\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd.sls\n#根据grains获取的值判别系统后安装软件\nhttpd-install:\n  pkg.installed:\n{% if grains['os'] == 'CentOS' %}\n    - name: httpd\n{% elif grains['OS'] == 'Debin' %}\n    - name: apache2\n{% endif %}\n```\n\n\n","source":"_posts/saltstack配置管理.md","raw":"---\ntitle: saltstack配置管理\ndate: 2019-05-15 23:42:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## Saltstack状态模块\n>远程执行模块的执行是过程式，而状态是对`minion`的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述`minion`的状态描述。\n它的和兴是写`sls(Salt State file)`文件，`sls`文件默认格式为`YAML`格式，并默认使用`jinja`模板，`jinja`是根据`django`的模板语言发展而来的语言，简单并强大，支持`for if `等循环语句。`salt state`主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。\n\n```\nmysql-install:   #ID声明，必须唯一\n  pkg.installed:   #state状态声明\n    - pkgs:   #选项声明\n      - mariadb:   #选项列表\n      - mariadb-server\n\n说明：\n一个ID只能出现一次\n一个ID下相同模块只能使用一次\n一个ID下不可以使用多个不同模块\n```\n模块帮助手册\n```\n#列出所有状态模块\n[root@salt-master ~]# salt '*' sys.list_modules\n#查看指定模块的所有方法\n[root@salt-master ~]# salt '*' sys.list_state_functions pkg\n#查看指定模块的使用方法\n[root@salt-master ~]# salt '*' sys.state_doc pkg\n#查看指定模块的指定方法的用法\n[root@salt-master ~]# salt '*' sys.state_doc pkg.installed\n```\n### pkg软件模块\n[pkg模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html)\n`pkg.installed` 软件安装\n```\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql: \">=5.4.16\"    #指定安装版本\n      - php-pdo\n      - php-cli\n```\n指定安装最新版本的软件\n```\nphp-install:\n  pkg.latest:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n```\n### file文件模块\n[file模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html)\n`file.managed` 下发文件，确保文件存在\n```\n[root@salt-master ~]# mkdir /srv/salt/base/files\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/base/files/\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\n说明：\n- name: 表示存放目的地址\n- source: 表示这个文件来自哪里（说明这个文件得提前准备）\n\n或者这样写，直接已目的地址命令ID，这样ID也表示目的地址\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\n/etc/httpd/conf/httpd.conf:\n  file.managed:\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n```\n```\n小示例：\n[root@salt-master ~]# cat /srv/salt/base/test.sls\n/tmp/passwd_back:\n  file.managed:\n    - source: salt://files/passwd\n    - user: root\n    - group: root\n    - mode: 644\n[root@salt-master ~]# cp /etc/passwd /srv/salt/base/files/\n[root@salt-master ~]# salt '*' state.sls test\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /tmp/passwd_back\"\nsalt-minion03:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion02:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion01:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\n```\n`file.directory` 建立目录\n```\n[root@salt-master ~]# cat /srv/salt/base/directory.sls\n/tmp/saltdir:\n  file.directory:\n    - user: root\n    - group: root\n    - mode: 755\n    - makedirs: True   #如果上一级目录不存在自动创建；类似（mkdir -p）\n\n[root@salt-master ~]# salt '*' state.sls directory\n[root@salt-master ~]# salt '*' cmd.run \"ls -d /tmp/saltdir\"\nsalt-minion03:\n    /tmp/saltdir\nsalt-minion02:\n    /tmp/saltdir\nsalt-minion01:\n    /tmp/saltdir\n```\n`file.recurse` 下发整个目录\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd_conf_dir.sls\nhttpd_conf_dir:\n  file.recurse:\n    - name: /etc/httpd/conf.d\n    - source: salt://files/conf.d\n    - file_mode: 600    #文件权限\n    - dir_mode: 755    #目录权限\n    - include_empty: True   #同步空目录\n    - clean: True    #使用后minion与master保持一致\n\n[root@salt-master ~]# rsync -avh /etc/httpd/conf.d /srv/salt/base/files/\n```\n`file.symlink` 建立软链接\n```\n[root@salt-master ~]# cat /srv/salt/base/target_link.sls\n/etc/grub.cfg:\n  file.symlink:\n    - target: /etc/grub2.cfg\n\n[root@salt-master ~]# salt '*' state.sls target_link\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /etc/grub.cfg\"\nsalt-minion03:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion01:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion02:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\n```\n### service服务模块\n[service模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html)\n```\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:\n  service.running:\n    - name: httpd   #服务名称\n    - enable: True    #开机自启动\n    - reload: True    #允许重载配置文件，不写则是restart\n\n或者这样写\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:   #即表示ID，又表示服务名\n  service.running:\n    - enable: True\n    - reload: True\n```\n\n## 高级状态模块\n>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 `top file`\n来进行管理。可以通过正则，`grain`模块，或分组名，来进行匹配，再下一级是要执行的`state`文件\n\n可以将我们的配置需求转换为`YAML`并在`Top file`文件中表示：\n\n![](https://upload-images.jianshu.io/upload_images/11763553-9098e5814f51b40c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n`Top file`示例\n```\nbase:\n  '*': #通过正则去匹配所有minion\n    - app.nginx\n\n  webserver: #定义的分组名称\n    - match: nodegroup\n    - app.cron\n\n  'os:centos':  #通过grains模块匹配\n    - match: grains\n    - nginx \n```\n`Top file` 高级状态的执行\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## LAMP架构案例\n说明：该案例在`prod`环境配置\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir /srv/salt/prod/{httpd,php,mysql,files}\n```\n3）配置文件准备及测试文件准备\n```\n[root@salt-master ~]# cp /etc/my.cnf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/php.ini  /srv/salt/prod/files/\n[root@salt-master ~]# echo \"<h1>LAMP html</h1>\" >>/srv/salt/prod/files/index.html\n[root@salt-master ~]# echo \"<?php phpinfo(); ?>\" >> /srv/salt/prod/files/index.php\n```\n4）编写`state sls`状态文件\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n\n#测试文件\n[root@salt-master ~]# cat /srv/salt/prod/testfile.sls\n/var/www/html/index.html:\n  file.managed:\n    - source: salt://files/index.html\n\n/var/www/html/index.php:\n  file.managed:\n    - source: salt://files/index.php\n```\n6）`topfile`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - httpd.init\n    - php.init\n    - mysql.init\n    - testfile\n```\n7）部署`LAMP`整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n```\n8）执行`topfile`\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## States状态依赖\n通过上面的`lamp`可以看出已经可以使用`state`模块来定义`minion`的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用`requisites`来进行控制\n>关系说明：\n1、`require` 我依赖某个状态，我依赖谁\n2、`require_in` 我被某个状态依赖，谁依赖我\n3、`watch` 我关注某个状态，当状态发生改变，进行`restart`或者`reload`操作\n4、`watch_in` 我被某个状态关注\n5、`include` 我引用谁\n\n1）修改上面`lamp`状态间依赖关系\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: apache-install   #表示上面apache-install执行成功，才能执行apache-config\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n    - require:\n      - file: apache-config\n    - watch:\n      - file: apache-config\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n    - reqiure_in:\n      - file: php-config\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: mariadb-install\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n    - reload: True\n    - require:\n      - file: mariadb-config\n    - watch:\n      - file: mariadb-config\n```\n2）修改引用关系后`include`\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── lamp.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n\n[root@salt-master ~]# cat /srv/salt/prod/lamp.sls\ninclude:\n  - httpd.init\n  - php.init\n  - mysql.init\n  - testfile\n\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - lamp\n```\n3）编写`SLS`技巧\n>1、按照状态分类，如果单独使用，清晰明了\n2、按照服务分类，可以被其它`SLS`引用\n\n## Jinja模板使用\n>配置文件一般灵活多变，比如配置`apache`的`IP`地址或者端口`PORT`等，则可以动态传值。\n[Jinja官档](http://docs.jinkan.org/docs/jinja2/)\n[salt jinja官档](https://docs.saltstack.com/en/latest/topics/jinja/index.html)\n\n`Jinja2` 模板包含变量和表达式，变量用 &#123;&#123; ... &#125;&#125; 包围，表达式用 &#123;&#37; ... &#37;&#125; 包围。变量使用示例：\n```\n[root@salt-master ~]# cat /srv/salt/base/var.sls \n{% set var= 'hello world!' %}\ntest_var:\n  cmd.run:\n    - name: echo \"测试变量 {{ var }}\"\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls var\nsalt-minion01:\n----------\n          ID: test_var\n    Function: cmd.run\n        Name: echo \"测试变量 hello world!\"\n      Result: True\n     Comment: Command \"echo \"测试变量 hello world!\"\" run\n     Started: 14:50:58.302424\n    Duration: 12.358 ms\n     Changes:   \n              ----------\n              pid:\n                  22510\n              retcode:\n                  0\n              stderr:\n              stdout:\n                  测试变量 hello world!\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  12.358 ms\n```\n`jinja2` 常用变量\n1、字符串类型\n```\n{% set var = 'test' %}  #定义变量\n{{ var }}  #调用变量\n```\n2、列表类型\n```\n{% set list = ['one', 'two', 'three'] %}\n{{ list[1] }}  #获取变量的第一个值\n```\n3、字典类型\n```\n{% set dict = {'key1':'value1', 'key2':'value2'} %}\n{{ dict['key1'] }}  #获取'key1'的值\n```\n示例1：`Saltstack`使用`jinja`模块配置`apache`监听端口\n```\n#1.告诉file状态模块，需要使用jinja\n    - template: jinja\n#2.列出参数列表\n    - defaults:\n      PORT: 8000\n#3.配置文件引用jinja模板\n{{ PORT }}\n\n# 配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n\n# 修改httpd.conf配置文件引用变量\nListen {{ PORT }}\n```\n示例2：使用`grinas` 方式进行赋值\n```\n#配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n      IPADDR: {{ grains['fqdn_ip4'][0] }}\n\n# 修改httpd.conf配置文件引用变量\nListen {{ IPADDR }}:{{ PORT }}\n```\n示例3：通过`jinja+grains`根据系统不同安装`apache`\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd.sls\n#根据grains获取的值判别系统后安装软件\nhttpd-install:\n  pkg.installed:\n{% if grains['os'] == 'CentOS' %}\n    - name: httpd\n{% elif grains['OS'] == 'Debin' %}\n    - name: apache2\n{% endif %}\n```\n\n\n","slug":"saltstack配置管理","published":1,"updated":"2019-05-16T09:45:40.646Z","_id":"cjvqpru4j000vzt34y1v7g8e3","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"Saltstack状态模块\"><a href=\"#Saltstack状态模块\" class=\"headerlink\" title=\"Saltstack状态模块\"></a>Saltstack状态模块</h2><blockquote>\n<p>远程执行模块的执行是过程式，而状态是对<code>minion</code>的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述<code>minion</code>的状态描述。<br>它的和兴是写<code>sls(Salt State file)</code>文件，<code>sls</code>文件默认格式为<code>YAML</code>格式，并默认使用<code>jinja</code>模板，<code>jinja</code>是根据<code>django</code>的模板语言发展而来的语言，简单并强大，支持<code>for if</code>等循环语句。<code>salt state</code>主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql-<span class=\"keyword\">install</span>:   <span class=\"comment\">#ID声明，必须唯一</span></span><br><span class=\"line\">  pkg.installed:   <span class=\"comment\">#state状态声明</span></span><br><span class=\"line\">    - pkgs:   <span class=\"comment\">#选项声明</span></span><br><span class=\"line\">      - mariadb:   <span class=\"comment\">#选项列表</span></span><br><span class=\"line\">      - mariadb-<span class=\"keyword\">server</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>只能出现一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下相同模块只能使用一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下不可以使用多个不同模块</span><br></pre></td></tr></table></figure>\n<p>模块帮助手册<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#列出所有状态模块</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_modules</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的所有方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_state_functions pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的使用方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的指定方法的用法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg.installed</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"pkg软件模块\"><a href=\"#pkg软件模块\" class=\"headerlink\" title=\"pkg软件模块\"></a>pkg软件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html\" target=\"_blank\" rel=\"noopener\">pkg模块官档</a><br><code>pkg.installed</code> 软件安装<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-<span class=\"symbol\">mysql:</span> <span class=\"string\">\"&gt;=5.4.16\"</span>    <span class=\"comment\">#指定安装版本</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<p>指定安装最新版本的软件<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.latest:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-mysql</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"file文件模块\"><a href=\"#file文件模块\" class=\"headerlink\" title=\"file文件模块\"></a>file文件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html\" target=\"_blank\" rel=\"noopener\">file模块官档</a><br><code>file.managed</code> 下发文件，确保文件存在<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"built_in\">mkdir</span> /srv/salt/base/<span class=\"keyword\">files</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cp</span> /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span> /srv/salt/base/<span class=\"keyword\">files</span>/</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">- name: 表示存放目的地址</span><br><span class=\"line\">- <span class=\"keyword\">source</span>: 表示这个文件来自哪里（说明这个文件得提前准备）</span><br><span class=\"line\"></span><br><span class=\"line\">或者这样写，直接已目的地址命令ID，这样ID也表示目的地址</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">/etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span>:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">小示例：</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/test.sls</span><br><span class=\"line\">/tmp/passwd_back:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - source: salt://files/passwd</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/passwd /srv/salt/base/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls test</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -l /tmp/passwd_back\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br></pre></td></tr></table></figure>\n<p><code>file.directory</code> 建立目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/directory.sls</span><br><span class=\"line\">/tmp/saltdir:</span><br><span class=\"line\">  file.directory:</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">755</span></span><br><span class=\"line\">    - makedirs: <span class=\"literal\">True</span>   <span class=\"comment\">#如果上一级目录不存在自动创建；类似（mkdir -p）</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls directory</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -d /tmp/saltdir\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    /tmp/saltdir</span><br></pre></td></tr></table></figure></p>\n<p><code>file.recurse</code> 下发整个目录<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/httpd_conf_dir.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd_conf_dir:</span></span><br><span class=\"line\">  <span class=\"string\">file.recurse:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - file_mode:</span> <span class=\"number\">600</span>    <span class=\"comment\">#文件权限</span></span><br><span class=\"line\"><span class=\"attr\">    - dir_mode:</span> <span class=\"number\">755</span>    <span class=\"comment\">#目录权限</span></span><br><span class=\"line\"><span class=\"attr\">    - include_empty:</span> <span class=\"literal\">True</span>   <span class=\"comment\">#同步空目录</span></span><br><span class=\"line\"><span class=\"attr\">    - clean:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#使用后minion与master保持一致</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">rsync</span> <span class=\"bullet\">-avh</span> <span class=\"string\">/etc/httpd/conf.d</span> <span class=\"string\">/srv/salt/base/files/</span></span><br></pre></td></tr></table></figure></p>\n<p><code>file.symlink</code> 建立软链接<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># cat /srv/salt/base/target_link.sls</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>grub.cfg:</span><br><span class=\"line\">  file.symlink:</span><br><span class=\"line\">    - target: <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls target_link</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"ls -l /etc/grub.cfg\"</span></span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"service服务模块\"><a href=\"#service服务模块\" class=\"headerlink\" title=\"service服务模块\"></a>service服务模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html\" target=\"_blank\" rel=\"noopener\">service模块官档</a><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span>   <span class=\"comment\">#服务名称</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#开机自启动</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#允许重载配置文件，不写则是restart</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">或者这样写</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span>   <span class=\"comment\">#即表示ID，又表示服务名</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"高级状态模块\"><a href=\"#高级状态模块\" class=\"headerlink\" title=\"高级状态模块\"></a>高级状态模块</h2><blockquote>\n<p>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 <code>top file</code><br>来进行管理。可以通过正则，<code>grain</code>模块，或分组名，来进行匹配，再下一级是要执行的<code>state</code>文件</p>\n</blockquote>\n<p>可以将我们的配置需求转换为<code>YAML</code>并在<code>Top file</code>文件中表示：</p>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-9098e5814f51b40c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<p><code>Top file</code>示例<br><figure class=\"highlight rsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base:</span><br><span class=\"line\">  <span class=\"string\">'*'</span>: <span class=\"meta\">#通过正则去匹配所有minion</span></span><br><span class=\"line\">    - app.nginx</span><br><span class=\"line\"></span><br><span class=\"line\">  webserver: <span class=\"meta\">#定义的分组名称</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: nodegroup</span><br><span class=\"line\">    - app.cron</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">'os:centos'</span>:  <span class=\"meta\">#通过grains模块匹配</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: grains</span><br><span class=\"line\">    - nginx</span><br></pre></td></tr></table></figure></p>\n<p><code>Top file</code> 高级状态的执行<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"LAMP架构案例\"><a href=\"#LAMP架构案例\" class=\"headerlink\" title=\"LAMP架构案例\"></a>LAMP架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/salt/prod/&#123;httpd,php,mysql,files&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）配置文件准备及测试文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/my.cnf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/httpd/conf/httpd.conf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/php.ini  /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;h1&gt;LAMP html&lt;/h1&gt;\"</span> &gt;&gt;/srv/salt/prod/files/index.html</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;?php phpinfo(); ?&gt;\"</span> &gt;&gt; /srv/salt/prod/files/index.php</span><br></pre></td></tr></table></figure></p>\n<p>4）编写<code>state sls</code>状态文件<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#httpd</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/httpd/init.sls</span><br><span class=\"line\">apache-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - httpd</span><br><span class=\"line\">      - httpd-tools</span><br><span class=\"line\"></span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: httpd</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#php</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/php/init.sls</span><br><span class=\"line\">php-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - php</span><br><span class=\"line\">      - php-mysql</span><br><span class=\"line\">      - php-pdo</span><br><span class=\"line\">      - php-cli</span><br><span class=\"line\"></span><br><span class=\"line\">php-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/php.ini</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/php.ini</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#mysql</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/mysql/init.sls</span><br><span class=\"line\">mariadb-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - mariadb-server</span><br><span class=\"line\">      - mariadb</span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: mariadb</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#测试文件</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/testfile.sls</span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.htm<span class=\"variable\">l:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.html</span><br><span class=\"line\"></span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.php:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.php</span><br></pre></td></tr></table></figure></p>\n<p>6）<code>topfile</code>文件编写<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - testfile</span><br></pre></td></tr></table></figure></p>\n<p>7）部署<code>LAMP</code>整体<code>state</code>文件查看<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">    │   ├── httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.html</span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.php</span><br><span class=\"line\">    │   ├── my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    └── testfile.sls</span><br></pre></td></tr></table></figure></p>\n<p>8）执行<code>topfile</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"States状态依赖\"><a href=\"#States状态依赖\" class=\"headerlink\" title=\"States状态依赖\"></a>States状态依赖</h2><p>通过上面的<code>lamp</code>可以看出已经可以使用<code>state</code>模块来定义<code>minion</code>的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用<code>requisites</code>来进行控制</p>\n<blockquote>\n<p>关系说明：<br>1、<code>require</code> 我依赖某个状态，我依赖谁<br>2、<code>require_in</code> 我被某个状态依赖，谁依赖我<br>3、<code>watch</code> 我关注某个状态，当状态发生改变，进行<code>restart</code>或者<code>reload</code>操作<br>4、<code>watch_in</code> 我被某个状态关注<br>5、<code>include</code> 我引用谁</p>\n</blockquote>\n<p>1）修改上面<code>lamp</code>状态间依赖关系<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#httpd</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/httpd/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">apache-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd-tools</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">apache-install</span>   <span class=\"comment\">#表示上面apache-install执行成功，才能执行apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/php/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">php-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-mysql</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-pdo</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-cli</span></span><br><span class=\"line\"><span class=\"attr\">    - reqiure_in:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">php-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#mysql</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/mysql/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb-server</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br></pre></td></tr></table></figure></p>\n<p>2）修改引用关系后<code>include</code><br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── files</span><br><span class=\"line\">    │   ├── httpd.conf</span><br><span class=\"line\">    │   ├── index.html</span><br><span class=\"line\">    │   ├── index.php</span><br><span class=\"line\">    │   ├── my.cnf</span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── lamp.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    └── testfile.sls</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/prod/lamp.sls</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - testfile</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - lamp</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>SLS</code>技巧</p>\n<blockquote>\n<p>1、按照状态分类，如果单独使用，清晰明了<br>2、按照服务分类，可以被其它<code>SLS</code>引用</p>\n</blockquote>\n<h2 id=\"Jinja模板使用\"><a href=\"#Jinja模板使用\" class=\"headerlink\" title=\"Jinja模板使用\"></a>Jinja模板使用</h2><blockquote>\n<p>配置文件一般灵活多变，比如配置<code>apache</code>的<code>IP</code>地址或者端口<code>PORT</code>等，则可以动态传值。<br><a href=\"http://docs.jinkan.org/docs/jinja2/\" target=\"_blank\" rel=\"noopener\">Jinja官档</a><br><a href=\"https://docs.saltstack.com/en/latest/topics/jinja/index.html\" target=\"_blank\" rel=\"noopener\">salt jinja官档</a></p>\n</blockquote>\n<p><code>Jinja2</code> 模板包含变量和表达式，变量用 &#123;&#123; … &#125;&#125; 包围，表达式用 &#123;&#37; … &#37;&#125; 包围。变量使用示例：<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/base/var.sls </span><br><span class=\"line\">&#123;% set var= <span class=\"emphasis\">'hello world!'</span> %&#125;</span><br><span class=\"line\">test<span class=\"emphasis\">_var:</span></span><br><span class=\"line\"><span class=\"emphasis\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"emphasis\">    - name: echo \"测试变量 &#123;&#123; var &#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"emphasis\"></span></span><br><span class=\"line\"><span class=\"emphasis\">[root@salt-master ~]# salt 'salt-minion01' state.sls var</span></span><br><span class=\"line\"><span class=\"emphasis\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"emphasis\">----------</span></span><br><span class=\"line\"><span class=\"emphasis\">          ID: test_</span>var</span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: echo \"测试变量 hello world!\"</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"echo \"测试变量 hello world!\"\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 14:50:58.302424</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 12.358 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  22510</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"><span class=\"code\">                  测试变量 hello world!</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  12.358 ms</span><br></pre></td></tr></table></figure></p>\n<p><code>jinja2</code> 常用变量<br>1、字符串类型<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> <span class=\"keyword\">var</span> = <span class=\"string\">'test'</span> %&#125;  <span class=\"meta\">#定义变量</span></span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">var</span> &#125;&#125;  <span class=\"meta\">#调用变量</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表类型<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% set <span class=\"keyword\">list</span> = [<span class=\"string\">'one'</span>, <span class=\"string\">'two'</span>, <span class=\"string\">'three'</span>] %&#125;</span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">list</span>[<span class=\"number\">1</span>] &#125;&#125;  <span class=\"comment\">#获取变量的第一个值</span></span><br></pre></td></tr></table></figure></p>\n<p>3、字典类型<br><figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> dict <span class=\"comment\">= &#123;</span><span class=\"comment\">'key1'</span><span class=\"comment\">:</span><span class=\"comment\">'value1'</span><span class=\"comment\">,</span> <span class=\"comment\">'key2'</span><span class=\"comment\">:</span><span class=\"comment\">'value2'</span><span class=\"comment\">&#125; %&#125;</span></span><br><span class=\"line\">&#123;&#123; dict[<span class=\"string\">'key1'</span>] &#125;&#125;  #获取<span class=\"string\">'key1'</span>的值</span><br></pre></td></tr></table></figure></p>\n<p>示例1：<code>Saltstack</code>使用<code>jinja</code>模块配置<code>apache</code>监听端口<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.告诉file状态模块，需要使用jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"comment\">#2.列出参数列表</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"comment\">#3.配置文件引用jinja模板</span></span><br><span class=\"line\"><span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例2：使用<code>grinas</code> 方式进行赋值<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"attr\">      IPADDR:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">IPADDR</span> <span class=\"string\">&#125;&#125;:&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例3：通过<code>jinja+grains</code>根据系统不同安装<code>apache</code><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cat /srv/salt/base/httpd.sls</span></span><br><span class=\"line\"><span class=\"comment\">#根据grains获取的值判别系统后安装软件</span></span><br><span class=\"line\">httpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">&#123;% <span class=\"keyword\">if</span> grains[<span class=\"string\">'os'</span>] == <span class=\"string\">'CentOS'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">&#123;% elif grains[<span class=\"string\">'OS'</span>] == <span class=\"string\">'Debin'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: apache2</span><br><span class=\"line\">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Saltstack状态模块\"><a href=\"#Saltstack状态模块\" class=\"headerlink\" title=\"Saltstack状态模块\"></a>Saltstack状态模块</h2><blockquote>\n<p>远程执行模块的执行是过程式，而状态是对<code>minion</code>的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述<code>minion</code>的状态描述。<br>它的和兴是写<code>sls(Salt State file)</code>文件，<code>sls</code>文件默认格式为<code>YAML</code>格式，并默认使用<code>jinja</code>模板，<code>jinja</code>是根据<code>django</code>的模板语言发展而来的语言，简单并强大，支持<code>for if</code>等循环语句。<code>salt state</code>主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql-<span class=\"keyword\">install</span>:   <span class=\"comment\">#ID声明，必须唯一</span></span><br><span class=\"line\">  pkg.installed:   <span class=\"comment\">#state状态声明</span></span><br><span class=\"line\">    - pkgs:   <span class=\"comment\">#选项声明</span></span><br><span class=\"line\">      - mariadb:   <span class=\"comment\">#选项列表</span></span><br><span class=\"line\">      - mariadb-<span class=\"keyword\">server</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>只能出现一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下相同模块只能使用一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下不可以使用多个不同模块</span><br></pre></td></tr></table></figure>\n<p>模块帮助手册<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#列出所有状态模块</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_modules</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的所有方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_state_functions pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的使用方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的指定方法的用法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg.installed</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"pkg软件模块\"><a href=\"#pkg软件模块\" class=\"headerlink\" title=\"pkg软件模块\"></a>pkg软件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html\" target=\"_blank\" rel=\"noopener\">pkg模块官档</a><br><code>pkg.installed</code> 软件安装<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-<span class=\"symbol\">mysql:</span> <span class=\"string\">\"&gt;=5.4.16\"</span>    <span class=\"comment\">#指定安装版本</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<p>指定安装最新版本的软件<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.latest:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-mysql</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"file文件模块\"><a href=\"#file文件模块\" class=\"headerlink\" title=\"file文件模块\"></a>file文件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html\" target=\"_blank\" rel=\"noopener\">file模块官档</a><br><code>file.managed</code> 下发文件，确保文件存在<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"built_in\">mkdir</span> /srv/salt/base/<span class=\"keyword\">files</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cp</span> /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span> /srv/salt/base/<span class=\"keyword\">files</span>/</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">- name: 表示存放目的地址</span><br><span class=\"line\">- <span class=\"keyword\">source</span>: 表示这个文件来自哪里（说明这个文件得提前准备）</span><br><span class=\"line\"></span><br><span class=\"line\">或者这样写，直接已目的地址命令ID，这样ID也表示目的地址</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">/etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span>:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">小示例：</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/test.sls</span><br><span class=\"line\">/tmp/passwd_back:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - source: salt://files/passwd</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/passwd /srv/salt/base/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls test</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -l /tmp/passwd_back\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br></pre></td></tr></table></figure>\n<p><code>file.directory</code> 建立目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/directory.sls</span><br><span class=\"line\">/tmp/saltdir:</span><br><span class=\"line\">  file.directory:</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">755</span></span><br><span class=\"line\">    - makedirs: <span class=\"literal\">True</span>   <span class=\"comment\">#如果上一级目录不存在自动创建；类似（mkdir -p）</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls directory</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -d /tmp/saltdir\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    /tmp/saltdir</span><br></pre></td></tr></table></figure></p>\n<p><code>file.recurse</code> 下发整个目录<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/httpd_conf_dir.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd_conf_dir:</span></span><br><span class=\"line\">  <span class=\"string\">file.recurse:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - file_mode:</span> <span class=\"number\">600</span>    <span class=\"comment\">#文件权限</span></span><br><span class=\"line\"><span class=\"attr\">    - dir_mode:</span> <span class=\"number\">755</span>    <span class=\"comment\">#目录权限</span></span><br><span class=\"line\"><span class=\"attr\">    - include_empty:</span> <span class=\"literal\">True</span>   <span class=\"comment\">#同步空目录</span></span><br><span class=\"line\"><span class=\"attr\">    - clean:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#使用后minion与master保持一致</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">rsync</span> <span class=\"bullet\">-avh</span> <span class=\"string\">/etc/httpd/conf.d</span> <span class=\"string\">/srv/salt/base/files/</span></span><br></pre></td></tr></table></figure></p>\n<p><code>file.symlink</code> 建立软链接<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># cat /srv/salt/base/target_link.sls</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>grub.cfg:</span><br><span class=\"line\">  file.symlink:</span><br><span class=\"line\">    - target: <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls target_link</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"ls -l /etc/grub.cfg\"</span></span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"service服务模块\"><a href=\"#service服务模块\" class=\"headerlink\" title=\"service服务模块\"></a>service服务模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html\" target=\"_blank\" rel=\"noopener\">service模块官档</a><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span>   <span class=\"comment\">#服务名称</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#开机自启动</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#允许重载配置文件，不写则是restart</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">或者这样写</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span>   <span class=\"comment\">#即表示ID，又表示服务名</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"高级状态模块\"><a href=\"#高级状态模块\" class=\"headerlink\" title=\"高级状态模块\"></a>高级状态模块</h2><blockquote>\n<p>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 <code>top file</code><br>来进行管理。可以通过正则，<code>grain</code>模块，或分组名，来进行匹配，再下一级是要执行的<code>state</code>文件</p>\n</blockquote>\n<p>可以将我们的配置需求转换为<code>YAML</code>并在<code>Top file</code>文件中表示：</p>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-9098e5814f51b40c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<p><code>Top file</code>示例<br><figure class=\"highlight rsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base:</span><br><span class=\"line\">  <span class=\"string\">'*'</span>: <span class=\"meta\">#通过正则去匹配所有minion</span></span><br><span class=\"line\">    - app.nginx</span><br><span class=\"line\"></span><br><span class=\"line\">  webserver: <span class=\"meta\">#定义的分组名称</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: nodegroup</span><br><span class=\"line\">    - app.cron</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">'os:centos'</span>:  <span class=\"meta\">#通过grains模块匹配</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: grains</span><br><span class=\"line\">    - nginx</span><br></pre></td></tr></table></figure></p>\n<p><code>Top file</code> 高级状态的执行<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"LAMP架构案例\"><a href=\"#LAMP架构案例\" class=\"headerlink\" title=\"LAMP架构案例\"></a>LAMP架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/salt/prod/&#123;httpd,php,mysql,files&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）配置文件准备及测试文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/my.cnf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/httpd/conf/httpd.conf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/php.ini  /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;h1&gt;LAMP html&lt;/h1&gt;\"</span> &gt;&gt;/srv/salt/prod/files/index.html</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;?php phpinfo(); ?&gt;\"</span> &gt;&gt; /srv/salt/prod/files/index.php</span><br></pre></td></tr></table></figure></p>\n<p>4）编写<code>state sls</code>状态文件<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#httpd</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/httpd/init.sls</span><br><span class=\"line\">apache-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - httpd</span><br><span class=\"line\">      - httpd-tools</span><br><span class=\"line\"></span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: httpd</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#php</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/php/init.sls</span><br><span class=\"line\">php-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - php</span><br><span class=\"line\">      - php-mysql</span><br><span class=\"line\">      - php-pdo</span><br><span class=\"line\">      - php-cli</span><br><span class=\"line\"></span><br><span class=\"line\">php-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/php.ini</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/php.ini</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#mysql</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/mysql/init.sls</span><br><span class=\"line\">mariadb-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - mariadb-server</span><br><span class=\"line\">      - mariadb</span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: mariadb</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#测试文件</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/testfile.sls</span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.htm<span class=\"variable\">l:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.html</span><br><span class=\"line\"></span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.php:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.php</span><br></pre></td></tr></table></figure></p>\n<p>6）<code>topfile</code>文件编写<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - testfile</span><br></pre></td></tr></table></figure></p>\n<p>7）部署<code>LAMP</code>整体<code>state</code>文件查看<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">    │   ├── httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.html</span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.php</span><br><span class=\"line\">    │   ├── my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    └── testfile.sls</span><br></pre></td></tr></table></figure></p>\n<p>8）执行<code>topfile</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"States状态依赖\"><a href=\"#States状态依赖\" class=\"headerlink\" title=\"States状态依赖\"></a>States状态依赖</h2><p>通过上面的<code>lamp</code>可以看出已经可以使用<code>state</code>模块来定义<code>minion</code>的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用<code>requisites</code>来进行控制</p>\n<blockquote>\n<p>关系说明：<br>1、<code>require</code> 我依赖某个状态，我依赖谁<br>2、<code>require_in</code> 我被某个状态依赖，谁依赖我<br>3、<code>watch</code> 我关注某个状态，当状态发生改变，进行<code>restart</code>或者<code>reload</code>操作<br>4、<code>watch_in</code> 我被某个状态关注<br>5、<code>include</code> 我引用谁</p>\n</blockquote>\n<p>1）修改上面<code>lamp</code>状态间依赖关系<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#httpd</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/httpd/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">apache-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd-tools</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">apache-install</span>   <span class=\"comment\">#表示上面apache-install执行成功，才能执行apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/php/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">php-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-mysql</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-pdo</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-cli</span></span><br><span class=\"line\"><span class=\"attr\">    - reqiure_in:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">php-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#mysql</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/mysql/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb-server</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br></pre></td></tr></table></figure></p>\n<p>2）修改引用关系后<code>include</code><br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── files</span><br><span class=\"line\">    │   ├── httpd.conf</span><br><span class=\"line\">    │   ├── index.html</span><br><span class=\"line\">    │   ├── index.php</span><br><span class=\"line\">    │   ├── my.cnf</span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── lamp.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    └── testfile.sls</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/prod/lamp.sls</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - testfile</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - lamp</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>SLS</code>技巧</p>\n<blockquote>\n<p>1、按照状态分类，如果单独使用，清晰明了<br>2、按照服务分类，可以被其它<code>SLS</code>引用</p>\n</blockquote>\n<h2 id=\"Jinja模板使用\"><a href=\"#Jinja模板使用\" class=\"headerlink\" title=\"Jinja模板使用\"></a>Jinja模板使用</h2><blockquote>\n<p>配置文件一般灵活多变，比如配置<code>apache</code>的<code>IP</code>地址或者端口<code>PORT</code>等，则可以动态传值。<br><a href=\"http://docs.jinkan.org/docs/jinja2/\" target=\"_blank\" rel=\"noopener\">Jinja官档</a><br><a href=\"https://docs.saltstack.com/en/latest/topics/jinja/index.html\" target=\"_blank\" rel=\"noopener\">salt jinja官档</a></p>\n</blockquote>\n<p><code>Jinja2</code> 模板包含变量和表达式，变量用 &#123;&#123; … &#125;&#125; 包围，表达式用 &#123;&#37; … &#37;&#125; 包围。变量使用示例：<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/base/var.sls </span><br><span class=\"line\">&#123;% set var= <span class=\"emphasis\">'hello world!'</span> %&#125;</span><br><span class=\"line\">test<span class=\"emphasis\">_var:</span></span><br><span class=\"line\"><span class=\"emphasis\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"emphasis\">    - name: echo \"测试变量 &#123;&#123; var &#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"emphasis\"></span></span><br><span class=\"line\"><span class=\"emphasis\">[root@salt-master ~]# salt 'salt-minion01' state.sls var</span></span><br><span class=\"line\"><span class=\"emphasis\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"emphasis\">----------</span></span><br><span class=\"line\"><span class=\"emphasis\">          ID: test_</span>var</span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: echo \"测试变量 hello world!\"</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"echo \"测试变量 hello world!\"\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 14:50:58.302424</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 12.358 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  22510</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"><span class=\"code\">                  测试变量 hello world!</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  12.358 ms</span><br></pre></td></tr></table></figure></p>\n<p><code>jinja2</code> 常用变量<br>1、字符串类型<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> <span class=\"keyword\">var</span> = <span class=\"string\">'test'</span> %&#125;  <span class=\"meta\">#定义变量</span></span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">var</span> &#125;&#125;  <span class=\"meta\">#调用变量</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表类型<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% set <span class=\"keyword\">list</span> = [<span class=\"string\">'one'</span>, <span class=\"string\">'two'</span>, <span class=\"string\">'three'</span>] %&#125;</span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">list</span>[<span class=\"number\">1</span>] &#125;&#125;  <span class=\"comment\">#获取变量的第一个值</span></span><br></pre></td></tr></table></figure></p>\n<p>3、字典类型<br><figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> dict <span class=\"comment\">= &#123;</span><span class=\"comment\">'key1'</span><span class=\"comment\">:</span><span class=\"comment\">'value1'</span><span class=\"comment\">,</span> <span class=\"comment\">'key2'</span><span class=\"comment\">:</span><span class=\"comment\">'value2'</span><span class=\"comment\">&#125; %&#125;</span></span><br><span class=\"line\">&#123;&#123; dict[<span class=\"string\">'key1'</span>] &#125;&#125;  #获取<span class=\"string\">'key1'</span>的值</span><br></pre></td></tr></table></figure></p>\n<p>示例1：<code>Saltstack</code>使用<code>jinja</code>模块配置<code>apache</code>监听端口<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.告诉file状态模块，需要使用jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"comment\">#2.列出参数列表</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"comment\">#3.配置文件引用jinja模板</span></span><br><span class=\"line\"><span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例2：使用<code>grinas</code> 方式进行赋值<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"attr\">      IPADDR:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">IPADDR</span> <span class=\"string\">&#125;&#125;:&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例3：通过<code>jinja+grains</code>根据系统不同安装<code>apache</code><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cat /srv/salt/base/httpd.sls</span></span><br><span class=\"line\"><span class=\"comment\">#根据grains获取的值判别系统后安装软件</span></span><br><span class=\"line\">httpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">&#123;% <span class=\"keyword\">if</span> grains[<span class=\"string\">'os'</span>] == <span class=\"string\">'CentOS'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">&#123;% elif grains[<span class=\"string\">'OS'</span>] == <span class=\"string\">'Debin'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: apache2</span><br><span class=\"line\">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack状态判断unless与onlyif","date":"2019-05-17T07:43:05.000Z","copyright":true,"_content":">很多时候我们在编写`state` 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的`unless`和`onlyif`。\n\n## unless\n`unless`示例：需求创建`/tmp/unless.txt`文件，存在则不创建，不存在则创建\n```\n[root@salt-master ~]# cat /srv/salt/prod/unless.sls \ntest-unless:\n  cmd.run:\n    - name: touch /tmp/unless.txt\n    - unless: test -f /tmp/unless.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: Command \"touch /tmp/unless.txt\" run\n     Started: 15:10:51.522319\n    Duration: 31.822 ms\n     Changes:   \n              ----------\n              pid:\n                  6538\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  31.822 ms\n#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: unless condition is true\n     Started: 15:11:40.819789\n    Duration: 10.477 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  10.477 ms\n#第二次执行，可以看到该文件已经存在，并没有再次创建\n```\n>通过上面的小案例可以看出，当`unless`返回为真则不执行，当`unless`返回为假才执行。\n\n## onlyif\n> `onlyif`正好和`unless`相反，当`onlyif`返回为真执行，当`onlyif`返回为假不执行\n\n`onlyif`示例：需求，当`/tmp/onlyif.txt`文件存在，则创建`/tmp/onlyif`目录，不存在，则不创建`/tmp/onlyif`目录\n```\n[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls \ntest-onlyif:\n  cmd.run:\n    - name: mkdir /tmp/onlyif\n    - onlyif: test -f /tmp/onlyif.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: onlyif condition is false\n     Started: 15:34:56.460583\n    Duration: 9.612 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:   9.612 ms\n\n#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行\n[root@salt-master ~]# salt 'salt-minion01' cmd.run \"touch /tmp/onlyif.txt\"\nsalt-minion01:\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: Command \"mkdir /tmp/onlyif\" run\n     Started: 15:38:07.712492\n    Duration: 14.646 ms\n     Changes:   \n              ----------\n              pid:\n                  6871\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  14.646 ms\n\n#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录\n```\n## Redis主从架构案例\n说明：该案例在`prod`环境配置\n![redis主从环境](https://upload-images.jianshu.io/upload_images/11763553-bc3bd43a55d275ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir -p /srv/salt/prod/redis/files/\n```\n3）编写`state sls`状态文件\n```\n#初始化redis（安装和基本配置）\n[root@salt-master ~]# cat /srv/salt/prod/redis/init.sls \nredis-install:\n  pkg.installed:\n    - name: redis\n\nredis-config:\n  file.managed:\n    - name: /etc/redis.conf\n    - source: salt://redis/files/redis.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      BIND: {{ grains['fqdn_ip4'][0] }}\n      PORT: 6379\n      DAEMONIZA: 'yes'\n    - require:\n      - pkg: redis-install\n\nredis-service:\n  service.running:\n    - name: redis\n    - enable: True\n    - watch:\n      - file: redis-config\n\n\n#master直接引入 init\n[root@salt-master ~]# cat /srv/salt/prod/redis/master.sls \ninclude:\n  - redis.init\n\n\n#slave引入init 并配置主从信息\n[root@salt-master ~]# cat /srv/salt/prod/redis/slave.sls \ninclude:\n  - redis.init\n\n#配置主从\nslave-config:\n  cmd.run:\n    - name: redis-cli -h 192.168.1.34 slaveof 192.168.1.33 6379\n    - unless: redis-cli -h 192.168.1.34 info |grep role:slave\n    - require:\n      - service: redis-service\n\n说明：\nunless：返回为真则不执行，反之为假则执行\n```\n4）配置文件准备\n```\n[root@salt-master ~]# grep \"^[a-Z]\" /etc/redis.conf  >>/srv/salt/prod/redis/files/redis.conf\n[root@salt-master ~]# cat /srv/salt/prod/redis/files/redis.conf \n#这里使用jinja\nbind {{ BIND }}\nprotected-mode yes\n#这里使用jinja\nport {{ PORT }}\ntcp-backlog 511\ntimeout 0\ntcp-keepalive 300\n#这里使用jinja\ndaemonize {{ DAEMONIZA }}\nsupervised no\npidfile /var/run/redis_6379.pid\nloglevel notice\nlogfile /var/log/redis/redis.log\ndatabases 16\nsave 900 1\nsave 300 10\nsave 60 10000\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename dump.rdb\ndir /var/lib/redis\nslave-serve-stale-data yes\nslave-read-only yes\nrepl-diskless-sync no\nrepl-diskless-sync-delay 5\nrepl-disable-tcp-nodelay no\nslave-priority 100\nappendonly no\nappendfilename \"appendonly.aof\"\nappendfsync everysec\nno-appendfsync-on-rewrite no\nauto-aof-rewrite-percentage 100\nauto-aof-rewrite-min-size 64mb\naof-load-truncated yes\nlua-time-limit 5000\nslowlog-log-slower-than 10000\nslowlog-max-len 128\nlatency-monitor-threshold 0\nnotify-keyspace-events \"\"\nhash-max-ziplist-entries 512\nhash-max-ziplist-value 64\nlist-max-ziplist-size -2\nlist-compress-depth 0\nset-max-intset-entries 512\nzset-max-ziplist-entries 128\nzset-max-ziplist-value 64\nhll-sparse-max-bytes 3000\nactiverehashing yes\nclient-output-buffer-limit normal 0 0 0\nclient-output-buffer-limit slave 256mb 64mb 60\nclient-output-buffer-limit pubsub 32mb 8mb 60\nhz 10\naof-rewrite-incremental-fsync yes\n```\n5）`top file`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  'salt-minion02':\n    - redis.master\n  'salt-minion03':\n    - redis.slave\n```\n6）整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/prod/redis/\n/srv/salt/prod/redis/\n├── files\n│   └── redis.conf\n├── init.sls\n├── master.sls\n└── slave.sls\n\n1 directory, 4 files\n```\n7）`top file`高级状态执行\n```\n#先测试下看下状态文件是否编写正确，再正式执行\n[root@salt-master ~]# salt '*' state.highstate test=True\n[root@salt-master ~]# salt '*' state.highstate\n```\n","source":"_posts/saltstack状态判断unless与onlyif.md","raw":"---\ntitle: saltstack状态判断unless与onlyif\ndate: 2019-05-17 15:43:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n>很多时候我们在编写`state` 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的`unless`和`onlyif`。\n\n## unless\n`unless`示例：需求创建`/tmp/unless.txt`文件，存在则不创建，不存在则创建\n```\n[root@salt-master ~]# cat /srv/salt/prod/unless.sls \ntest-unless:\n  cmd.run:\n    - name: touch /tmp/unless.txt\n    - unless: test -f /tmp/unless.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: Command \"touch /tmp/unless.txt\" run\n     Started: 15:10:51.522319\n    Duration: 31.822 ms\n     Changes:   \n              ----------\n              pid:\n                  6538\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  31.822 ms\n#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: unless condition is true\n     Started: 15:11:40.819789\n    Duration: 10.477 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  10.477 ms\n#第二次执行，可以看到该文件已经存在，并没有再次创建\n```\n>通过上面的小案例可以看出，当`unless`返回为真则不执行，当`unless`返回为假才执行。\n\n## onlyif\n> `onlyif`正好和`unless`相反，当`onlyif`返回为真执行，当`onlyif`返回为假不执行\n\n`onlyif`示例：需求，当`/tmp/onlyif.txt`文件存在，则创建`/tmp/onlyif`目录，不存在，则不创建`/tmp/onlyif`目录\n```\n[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls \ntest-onlyif:\n  cmd.run:\n    - name: mkdir /tmp/onlyif\n    - onlyif: test -f /tmp/onlyif.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: onlyif condition is false\n     Started: 15:34:56.460583\n    Duration: 9.612 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:   9.612 ms\n\n#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行\n[root@salt-master ~]# salt 'salt-minion01' cmd.run \"touch /tmp/onlyif.txt\"\nsalt-minion01:\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: Command \"mkdir /tmp/onlyif\" run\n     Started: 15:38:07.712492\n    Duration: 14.646 ms\n     Changes:   \n              ----------\n              pid:\n                  6871\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  14.646 ms\n\n#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录\n```\n## Redis主从架构案例\n说明：该案例在`prod`环境配置\n![redis主从环境](https://upload-images.jianshu.io/upload_images/11763553-bc3bd43a55d275ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir -p /srv/salt/prod/redis/files/\n```\n3）编写`state sls`状态文件\n```\n#初始化redis（安装和基本配置）\n[root@salt-master ~]# cat /srv/salt/prod/redis/init.sls \nredis-install:\n  pkg.installed:\n    - name: redis\n\nredis-config:\n  file.managed:\n    - name: /etc/redis.conf\n    - source: salt://redis/files/redis.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      BIND: {{ grains['fqdn_ip4'][0] }}\n      PORT: 6379\n      DAEMONIZA: 'yes'\n    - require:\n      - pkg: redis-install\n\nredis-service:\n  service.running:\n    - name: redis\n    - enable: True\n    - watch:\n      - file: redis-config\n\n\n#master直接引入 init\n[root@salt-master ~]# cat /srv/salt/prod/redis/master.sls \ninclude:\n  - redis.init\n\n\n#slave引入init 并配置主从信息\n[root@salt-master ~]# cat /srv/salt/prod/redis/slave.sls \ninclude:\n  - redis.init\n\n#配置主从\nslave-config:\n  cmd.run:\n    - name: redis-cli -h 192.168.1.34 slaveof 192.168.1.33 6379\n    - unless: redis-cli -h 192.168.1.34 info |grep role:slave\n    - require:\n      - service: redis-service\n\n说明：\nunless：返回为真则不执行，反之为假则执行\n```\n4）配置文件准备\n```\n[root@salt-master ~]# grep \"^[a-Z]\" /etc/redis.conf  >>/srv/salt/prod/redis/files/redis.conf\n[root@salt-master ~]# cat /srv/salt/prod/redis/files/redis.conf \n#这里使用jinja\nbind {{ BIND }}\nprotected-mode yes\n#这里使用jinja\nport {{ PORT }}\ntcp-backlog 511\ntimeout 0\ntcp-keepalive 300\n#这里使用jinja\ndaemonize {{ DAEMONIZA }}\nsupervised no\npidfile /var/run/redis_6379.pid\nloglevel notice\nlogfile /var/log/redis/redis.log\ndatabases 16\nsave 900 1\nsave 300 10\nsave 60 10000\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename dump.rdb\ndir /var/lib/redis\nslave-serve-stale-data yes\nslave-read-only yes\nrepl-diskless-sync no\nrepl-diskless-sync-delay 5\nrepl-disable-tcp-nodelay no\nslave-priority 100\nappendonly no\nappendfilename \"appendonly.aof\"\nappendfsync everysec\nno-appendfsync-on-rewrite no\nauto-aof-rewrite-percentage 100\nauto-aof-rewrite-min-size 64mb\naof-load-truncated yes\nlua-time-limit 5000\nslowlog-log-slower-than 10000\nslowlog-max-len 128\nlatency-monitor-threshold 0\nnotify-keyspace-events \"\"\nhash-max-ziplist-entries 512\nhash-max-ziplist-value 64\nlist-max-ziplist-size -2\nlist-compress-depth 0\nset-max-intset-entries 512\nzset-max-ziplist-entries 128\nzset-max-ziplist-value 64\nhll-sparse-max-bytes 3000\nactiverehashing yes\nclient-output-buffer-limit normal 0 0 0\nclient-output-buffer-limit slave 256mb 64mb 60\nclient-output-buffer-limit pubsub 32mb 8mb 60\nhz 10\naof-rewrite-incremental-fsync yes\n```\n5）`top file`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  'salt-minion02':\n    - redis.master\n  'salt-minion03':\n    - redis.slave\n```\n6）整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/prod/redis/\n/srv/salt/prod/redis/\n├── files\n│   └── redis.conf\n├── init.sls\n├── master.sls\n└── slave.sls\n\n1 directory, 4 files\n```\n7）`top file`高级状态执行\n```\n#先测试下看下状态文件是否编写正确，再正式执行\n[root@salt-master ~]# salt '*' state.highstate test=True\n[root@salt-master ~]# salt '*' state.highstate\n```\n","slug":"saltstack状态判断unless与onlyif","published":1,"updated":"2019-05-17T08:04:13.094Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjvrt616i00009otc6hzylyo9","content":"<blockquote>\n<p>很多时候我们在编写<code>state</code> 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的<code>unless</code>和<code>onlyif</code>。</p>\n</blockquote>\n<h2 id=\"unless\"><a href=\"#unless\" class=\"headerlink\" title=\"unless\"></a>unless</h2><p><code>unless</code>示例：需求创建<code>/tmp/unless.txt</code>文件，存在则不创建，不存在则创建<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/unless.sls </span><br><span class=\"line\">test-unless:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">    - unless: test -f /tmp/unless.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"touch /tmp/unless.txt\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:10:51.522319</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 31.822 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6538</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  31.822 ms</span><br><span class=\"line\">#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: unless condition is true</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:11:40.819789</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 10.477 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  10.477 ms</span><br><span class=\"line\">#第二次执行，可以看到该文件已经存在，并没有再次创建</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>通过上面的小案例可以看出，当<code>unless</code>返回为真则不执行，当<code>unless</code>返回为假才执行。</p>\n</blockquote>\n<h2 id=\"onlyif\"><a href=\"#onlyif\" class=\"headerlink\" title=\"onlyif\"></a>onlyif</h2><blockquote>\n<p><code>onlyif</code>正好和<code>unless</code>相反，当<code>onlyif</code>返回为真执行，当<code>onlyif</code>返回为假不执行</p>\n</blockquote>\n<p><code>onlyif</code>示例：需求，当<code>/tmp/onlyif.txt</code>文件存在，则创建<code>/tmp/onlyif</code>目录，不存在，则不创建<code>/tmp/onlyif</code>目录<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls </span><br><span class=\"line\">test-onlyif:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">    - onlyif: test -f /tmp/onlyif.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: onlyif condition is false</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:34:56.460583</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 9.612 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:   9.612 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> cmd.run \"touch /tmp/onlyif.txt\"</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"mkdir /tmp/onlyif\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:38:07.712492</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 14.646 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6871</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  14.646 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Redis主从架构案例\"><a href=\"#Redis主从架构案例\" class=\"headerlink\" title=\"Redis主从架构案例\"></a>Redis主从架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-bc3bd43a55d275ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"redis主从环境\"></p>\n<p>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/prod/redis/files/</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>state sls</code>状态文件<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#初始化redis（安装和基本配置）</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/init.sls</span> </span><br><span class=\"line\"><span class=\"attr\">redis-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://redis/files/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      BIND:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">      DAEMONIZA:</span> <span class=\"string\">'yes'</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">redis-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">redis-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#master直接引入 init</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/master.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#slave引入init 并配置主从信息</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/slave.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置主从</span></span><br><span class=\"line\"><span class=\"attr\">slave-config:</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">slaveof</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">info</span> <span class=\"string\">|grep</span> <span class=\"attr\">role:slave</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - service:</span> <span class=\"string\">redis-service</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">说明：</span></span><br><span class=\"line\"><span class=\"string\">unless：返回为真则不执行，反之为假则执行</span></span><br></pre></td></tr></table></figure></p>\n<p>4）配置文件准备<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">grep</span> <span class=\"string\">\"^[a-Z]\"</span> /etc/redis.<span class=\"keyword\">conf</span>  &gt;&gt;/srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span> </span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">bind &#123;&#123; BIND &#125;&#125;</span><br><span class=\"line\">protected-<span class=\"keyword\">mode</span> yes</span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">port &#123;&#123; PORT &#125;&#125;</span><br><span class=\"line\">tcp-backlog <span class=\"number\">511</span></span><br><span class=\"line\">timeout <span class=\"number\">0</span></span><br><span class=\"line\">tcp-keepalive <span class=\"number\">300</span></span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">daemonize &#123;&#123; DAEMONIZA &#125;&#125;</span><br><span class=\"line\">supervised <span class=\"keyword\">no</span></span><br><span class=\"line\">pidfile /var/run/redis_6379.pid</span><br><span class=\"line\">loglevel notice</span><br><span class=\"line\">logfile /var/<span class=\"built_in\">log</span>/redis/redis.<span class=\"built_in\">log</span></span><br><span class=\"line\">databases <span class=\"number\">16</span></span><br><span class=\"line\">save <span class=\"number\">900</span> <span class=\"number\">1</span></span><br><span class=\"line\">save <span class=\"number\">300</span> <span class=\"number\">10</span></span><br><span class=\"line\">save <span class=\"number\">60</span> <span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"keyword\">stop</span>-writes-<span class=\"keyword\">on</span>-bgsave-error yes</span><br><span class=\"line\">rdbcompression yes</span><br><span class=\"line\">rdbchecksum yes</span><br><span class=\"line\">dbfilename dump.rdb</span><br><span class=\"line\">dir /var/lib/redis</span><br><span class=\"line\">slave-serve-stale-data yes</span><br><span class=\"line\">slave-<span class=\"keyword\">read</span>-<span class=\"keyword\">only</span> yes</span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span> <span class=\"keyword\">no</span></span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span>-delay <span class=\"number\">5</span></span><br><span class=\"line\">repl-disable-tcp-nodelay <span class=\"keyword\">no</span></span><br><span class=\"line\">slave-priority <span class=\"number\">100</span></span><br><span class=\"line\">appendonly <span class=\"keyword\">no</span></span><br><span class=\"line\">appendfilename <span class=\"string\">\"appendonly.aof\"</span></span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"><span class=\"keyword\">no</span>-appendfsync-<span class=\"keyword\">on</span>-rewrite <span class=\"keyword\">no</span></span><br><span class=\"line\">auto-aof-rewrite-percentage <span class=\"number\">100</span></span><br><span class=\"line\">auto-aof-rewrite-<span class=\"built_in\">min</span>-size <span class=\"number\">64</span>mb</span><br><span class=\"line\">aof-load-truncated yes</span><br><span class=\"line\"><span class=\"keyword\">lua</span>-time-limit <span class=\"number\">5000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">log</span>-slower-than <span class=\"number\">10000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">max</span>-<span class=\"built_in\">len</span> <span class=\"number\">128</span></span><br><span class=\"line\">latency-monitor-threshold <span class=\"number\">0</span></span><br><span class=\"line\">notify-keyspace-events <span class=\"string\">\"\"</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">512</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-<span class=\"built_in\">max</span>-ziplist-size -<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-compress-depth <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">set</span>-<span class=\"built_in\">max</span>-intset-entries <span class=\"number\">512</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">128</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\">hll-sparse-<span class=\"built_in\">max</span>-bytes <span class=\"number\">3000</span></span><br><span class=\"line\">activerehashing yes</span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit <span class=\"keyword\">normal</span> <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">0</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit slave <span class=\"number\">256</span>mb <span class=\"number\">64</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit pubsub <span class=\"number\">32</span>mb <span class=\"number\">8</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">hz <span class=\"number\">10</span></span><br><span class=\"line\">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>top file</code>文件编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  'salt-minion02':</span><br><span class=\"line\">    - redis.<span class=\"literal\">master</span></span><br><span class=\"line\">  'salt-minion03':</span><br><span class=\"line\">    - redis.<span class=\"literal\">slave</span></span><br></pre></td></tr></table></figure></p>\n<p>6）整体<code>state</code>文件查看<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /srv/salt/prod/redis/</span><br><span class=\"line\">/srv/salt/prod/redis/</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── redis.conf</span><br><span class=\"line\">├── init.sls</span><br><span class=\"line\">├── <span class=\"literal\">master</span>.sls</span><br><span class=\"line\">└── <span class=\"literal\">slave</span>.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">4</span> files</span><br></pre></td></tr></table></figure></p>\n<p>7）<code>top file</code>高级状态执行<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#先测试下看下状态文件是否编写正确，再正式执行</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate <span class=\"attr\">test=</span><span class=\"literal\">True</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>很多时候我们在编写<code>state</code> 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的<code>unless</code>和<code>onlyif</code>。</p>\n</blockquote>\n<h2 id=\"unless\"><a href=\"#unless\" class=\"headerlink\" title=\"unless\"></a>unless</h2><p><code>unless</code>示例：需求创建<code>/tmp/unless.txt</code>文件，存在则不创建，不存在则创建<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/unless.sls </span><br><span class=\"line\">test-unless:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">    - unless: test -f /tmp/unless.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"touch /tmp/unless.txt\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:10:51.522319</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 31.822 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6538</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  31.822 ms</span><br><span class=\"line\">#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: unless condition is true</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:11:40.819789</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 10.477 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  10.477 ms</span><br><span class=\"line\">#第二次执行，可以看到该文件已经存在，并没有再次创建</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>通过上面的小案例可以看出，当<code>unless</code>返回为真则不执行，当<code>unless</code>返回为假才执行。</p>\n</blockquote>\n<h2 id=\"onlyif\"><a href=\"#onlyif\" class=\"headerlink\" title=\"onlyif\"></a>onlyif</h2><blockquote>\n<p><code>onlyif</code>正好和<code>unless</code>相反，当<code>onlyif</code>返回为真执行，当<code>onlyif</code>返回为假不执行</p>\n</blockquote>\n<p><code>onlyif</code>示例：需求，当<code>/tmp/onlyif.txt</code>文件存在，则创建<code>/tmp/onlyif</code>目录，不存在，则不创建<code>/tmp/onlyif</code>目录<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls </span><br><span class=\"line\">test-onlyif:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">    - onlyif: test -f /tmp/onlyif.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: onlyif condition is false</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:34:56.460583</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 9.612 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:   9.612 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> cmd.run \"touch /tmp/onlyif.txt\"</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"mkdir /tmp/onlyif\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:38:07.712492</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 14.646 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6871</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  14.646 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Redis主从架构案例\"><a href=\"#Redis主从架构案例\" class=\"headerlink\" title=\"Redis主从架构案例\"></a>Redis主从架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-bc3bd43a55d275ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"redis主从环境\"></p>\n<p>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/prod/redis/files/</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>state sls</code>状态文件<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#初始化redis（安装和基本配置）</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/init.sls</span> </span><br><span class=\"line\"><span class=\"attr\">redis-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://redis/files/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      BIND:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">      DAEMONIZA:</span> <span class=\"string\">'yes'</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">redis-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">redis-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#master直接引入 init</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/master.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#slave引入init 并配置主从信息</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/slave.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置主从</span></span><br><span class=\"line\"><span class=\"attr\">slave-config:</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">slaveof</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">info</span> <span class=\"string\">|grep</span> <span class=\"attr\">role:slave</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - service:</span> <span class=\"string\">redis-service</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">说明：</span></span><br><span class=\"line\"><span class=\"string\">unless：返回为真则不执行，反之为假则执行</span></span><br></pre></td></tr></table></figure></p>\n<p>4）配置文件准备<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">grep</span> <span class=\"string\">\"^[a-Z]\"</span> /etc/redis.<span class=\"keyword\">conf</span>  &gt;&gt;/srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span> </span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">bind &#123;&#123; BIND &#125;&#125;</span><br><span class=\"line\">protected-<span class=\"keyword\">mode</span> yes</span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">port &#123;&#123; PORT &#125;&#125;</span><br><span class=\"line\">tcp-backlog <span class=\"number\">511</span></span><br><span class=\"line\">timeout <span class=\"number\">0</span></span><br><span class=\"line\">tcp-keepalive <span class=\"number\">300</span></span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">daemonize &#123;&#123; DAEMONIZA &#125;&#125;</span><br><span class=\"line\">supervised <span class=\"keyword\">no</span></span><br><span class=\"line\">pidfile /var/run/redis_6379.pid</span><br><span class=\"line\">loglevel notice</span><br><span class=\"line\">logfile /var/<span class=\"built_in\">log</span>/redis/redis.<span class=\"built_in\">log</span></span><br><span class=\"line\">databases <span class=\"number\">16</span></span><br><span class=\"line\">save <span class=\"number\">900</span> <span class=\"number\">1</span></span><br><span class=\"line\">save <span class=\"number\">300</span> <span class=\"number\">10</span></span><br><span class=\"line\">save <span class=\"number\">60</span> <span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"keyword\">stop</span>-writes-<span class=\"keyword\">on</span>-bgsave-error yes</span><br><span class=\"line\">rdbcompression yes</span><br><span class=\"line\">rdbchecksum yes</span><br><span class=\"line\">dbfilename dump.rdb</span><br><span class=\"line\">dir /var/lib/redis</span><br><span class=\"line\">slave-serve-stale-data yes</span><br><span class=\"line\">slave-<span class=\"keyword\">read</span>-<span class=\"keyword\">only</span> yes</span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span> <span class=\"keyword\">no</span></span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span>-delay <span class=\"number\">5</span></span><br><span class=\"line\">repl-disable-tcp-nodelay <span class=\"keyword\">no</span></span><br><span class=\"line\">slave-priority <span class=\"number\">100</span></span><br><span class=\"line\">appendonly <span class=\"keyword\">no</span></span><br><span class=\"line\">appendfilename <span class=\"string\">\"appendonly.aof\"</span></span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"><span class=\"keyword\">no</span>-appendfsync-<span class=\"keyword\">on</span>-rewrite <span class=\"keyword\">no</span></span><br><span class=\"line\">auto-aof-rewrite-percentage <span class=\"number\">100</span></span><br><span class=\"line\">auto-aof-rewrite-<span class=\"built_in\">min</span>-size <span class=\"number\">64</span>mb</span><br><span class=\"line\">aof-load-truncated yes</span><br><span class=\"line\"><span class=\"keyword\">lua</span>-time-limit <span class=\"number\">5000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">log</span>-slower-than <span class=\"number\">10000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">max</span>-<span class=\"built_in\">len</span> <span class=\"number\">128</span></span><br><span class=\"line\">latency-monitor-threshold <span class=\"number\">0</span></span><br><span class=\"line\">notify-keyspace-events <span class=\"string\">\"\"</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">512</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-<span class=\"built_in\">max</span>-ziplist-size -<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-compress-depth <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">set</span>-<span class=\"built_in\">max</span>-intset-entries <span class=\"number\">512</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">128</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\">hll-sparse-<span class=\"built_in\">max</span>-bytes <span class=\"number\">3000</span></span><br><span class=\"line\">activerehashing yes</span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit <span class=\"keyword\">normal</span> <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">0</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit slave <span class=\"number\">256</span>mb <span class=\"number\">64</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit pubsub <span class=\"number\">32</span>mb <span class=\"number\">8</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">hz <span class=\"number\">10</span></span><br><span class=\"line\">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>top file</code>文件编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  'salt-minion02':</span><br><span class=\"line\">    - redis.<span class=\"literal\">master</span></span><br><span class=\"line\">  'salt-minion03':</span><br><span class=\"line\">    - redis.<span class=\"literal\">slave</span></span><br></pre></td></tr></table></figure></p>\n<p>6）整体<code>state</code>文件查看<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /srv/salt/prod/redis/</span><br><span class=\"line\">/srv/salt/prod/redis/</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── redis.conf</span><br><span class=\"line\">├── init.sls</span><br><span class=\"line\">├── <span class=\"literal\">master</span>.sls</span><br><span class=\"line\">└── <span class=\"literal\">slave</span>.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">4</span> files</span><br></pre></td></tr></table></figure></p>\n<p>7）<code>top file</code>高级状态执行<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#先测试下看下状态文件是否编写正确，再正式执行</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate <span class=\"attr\">test=</span><span class=\"literal\">True</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate</span><br></pre></td></tr></table></figure></p>\n"},{"title":"phpRedisAdmin搭建","date":"2019-04-26T08:30:09.000Z","copyright":true,"_content":">在已有的` lnmp` 环境下搭建 `phpRedisAdmin` 由于服务器做了限制，隧道端口转发等都不能使用，导致 `RedisDesktopManager` 管理工具不能使用，只能通过 `phpRedisAdmin`来进行管理了。\n\n1）下载软件\n```\n# git clone https://github.com/ErikDubbelboer/phpRedisAdmin.git\n# cd phpRedisAdmin\n# git clone https://github.com/nrk/predis.git vendor\n```\n2）放置到`web`站点目录\n```\n# cd ..\n# mv phpRedisAdmin /opt/\n# chown apache.apache phpRedisAdmin/ -R\n```\n3）编辑`nginx`配置文件\n```\n# vim phpRedisAdmin.conf\nserver {\n    listen       80;\n    server_name  www.redis.com;\n    autoindex off;\n\n    error_log  logs/redis_error.log error;\n    access_log logs/redis_access.log main;\n\n    location / {\n    root /opt/phpRedisAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpRedisAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n4）配置连接管理，默认连接的是`6379`端口\n```\n# vim /opt/phpRedisAdmin/includes/config.sample.inc.php\n$config = array(\n  'servers' => array(\n    array(\n      'name'   => 'local server', // Optional name.\n      'host'   => '127.0.0.1',\n      'port'   => 6395,\n      'filter' => '*',\n      'scheme' => 'tcp', // Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket\n      'path'   => '', // Optional. Path to unix domain socket. Uses only if 'scheme' => 'unix'. Example: '/var/run/redis/redis.sock'\n      'auth' => 'jieg6uy5Dach0yooxo1l' // Warning: The password is sent in plain-text to the Redis server.\n    ),\n```\n5）`windows`添加`host`然后访问 `http://www.redis.com`\n![](https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n\n","source":"_posts/phpRedisAdmin搭建.md","raw":"---\ntitle: phpRedisAdmin搭建\ndate: 2019-04-26 16:30:09\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n>在已有的` lnmp` 环境下搭建 `phpRedisAdmin` 由于服务器做了限制，隧道端口转发等都不能使用，导致 `RedisDesktopManager` 管理工具不能使用，只能通过 `phpRedisAdmin`来进行管理了。\n\n1）下载软件\n```\n# git clone https://github.com/ErikDubbelboer/phpRedisAdmin.git\n# cd phpRedisAdmin\n# git clone https://github.com/nrk/predis.git vendor\n```\n2）放置到`web`站点目录\n```\n# cd ..\n# mv phpRedisAdmin /opt/\n# chown apache.apache phpRedisAdmin/ -R\n```\n3）编辑`nginx`配置文件\n```\n# vim phpRedisAdmin.conf\nserver {\n    listen       80;\n    server_name  www.redis.com;\n    autoindex off;\n\n    error_log  logs/redis_error.log error;\n    access_log logs/redis_access.log main;\n\n    location / {\n    root /opt/phpRedisAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpRedisAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n4）配置连接管理，默认连接的是`6379`端口\n```\n# vim /opt/phpRedisAdmin/includes/config.sample.inc.php\n$config = array(\n  'servers' => array(\n    array(\n      'name'   => 'local server', // Optional name.\n      'host'   => '127.0.0.1',\n      'port'   => 6395,\n      'filter' => '*',\n      'scheme' => 'tcp', // Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket\n      'path'   => '', // Optional. Path to unix domain socket. Uses only if 'scheme' => 'unix'. Example: '/var/run/redis/redis.sock'\n      'auth' => 'jieg6uy5Dach0yooxo1l' // Warning: The password is sent in plain-text to the Redis server.\n    ),\n```\n5）`windows`添加`host`然后访问 `http://www.redis.com`\n![](https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n\n","slug":"phpRedisAdmin搭建","published":1,"updated":"2019-05-17T08:49:04.957Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjvrueukk000024tcw4tdmheh","content":"<blockquote>\n<p>在已有的<code>lnmp</code> 环境下搭建 <code>phpRedisAdmin</code> 由于服务器做了限制，隧道端口转发等都不能使用，导致 <code>RedisDesktopManager</code> 管理工具不能使用，只能通过 <code>phpRedisAdmin</code>来进行管理了。</p>\n</blockquote>\n<p>1）下载软件<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/ErikDubbelboer/phpRedisAdmin.git</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> <span class=\"built_in\">cd</span> phpRedisAdmin</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/nrk/predis.git vendor</span></span><br></pre></td></tr></table></figure></p>\n<p>2）放置到<code>web</code>站点目录<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># cd ..</span></span><br><span class=\"line\"><span class=\"meta\"># mv phpRedisAdmin /opt/</span></span><br><span class=\"line\"><span class=\"meta\"># chown apache.apache phpRedisAdmin/ -R</span></span><br></pre></td></tr></table></figure></p>\n<p>3）编辑<code>nginx</code>配置文件<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim phpRedisAdmin.conf</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span>  www.redis.com;</span><br><span class=\"line\">    <span class=\"attribute\">autoindex</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">error_log</span>  logs/redis_error.log <span class=\"literal\">error</span>;</span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> logs/redis_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /opt/phpRedisAdmin;</span><br><span class=\"line\">        <span class=\"attribute\">index</span>  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_intercept_errors</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">error_page</span>  <span class=\"number\">404</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ \\.php$</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span>           html;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_pass</span>   <span class=\"number\">127.0.0.1:9000</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_index</span>  index.php;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_param</span>  SCRIPT_FILENAME  /opt/phpRedisAdmin<span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">        <span class=\"attribute\">include</span>        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ /\\.</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">        <span class=\"attribute\">error_page</span>  <span class=\"number\">403</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>4）配置连接管理，默认连接的是<code>6379</code>端口<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /opt/phpRedisAdmin/includes/config.sample.inc.php</span></span><br><span class=\"line\">$config = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">  <span class=\"string\">'servers'</span> =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"keyword\">array</span>(</span><br><span class=\"line\">      <span class=\"string\">'name'</span>   =&gt; <span class=\"string\">'local server'</span>, <span class=\"comment\">// Optional name.</span></span><br><span class=\"line\">      <span class=\"string\">'host'</span>   =&gt; <span class=\"string\">'127.0.0.1'</span>,</span><br><span class=\"line\">      <span class=\"string\">'port'</span>   =&gt; <span class=\"number\">6395</span>,</span><br><span class=\"line\">      <span class=\"string\">'filter'</span> =&gt; <span class=\"string\">'*'</span>,</span><br><span class=\"line\">      <span class=\"string\">'scheme'</span> =&gt; <span class=\"string\">'tcp'</span>, <span class=\"comment\">// Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket</span></span><br><span class=\"line\">      <span class=\"string\">'path'</span>   =&gt; <span class=\"string\">''</span>, <span class=\"comment\">// Optional. Path to unix domain socket. Uses only if 'scheme' =&gt; 'unix'. Example: '/var/run/redis/redis.sock'</span></span><br><span class=\"line\">      <span class=\"string\">'auth'</span> =&gt; <span class=\"string\">'jieg6uy5Dach0yooxo1l'</span> <span class=\"comment\">// Warning: The password is sent in plain-text to the Redis server.</span></span><br><span class=\"line\">    ),</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>windows</code>添加<code>host</code>然后访问 <code>http://www.redis.com</code><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>在已有的<code>lnmp</code> 环境下搭建 <code>phpRedisAdmin</code> 由于服务器做了限制，隧道端口转发等都不能使用，导致 <code>RedisDesktopManager</code> 管理工具不能使用，只能通过 <code>phpRedisAdmin</code>来进行管理了。</p>\n</blockquote>\n<p>1）下载软件<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/ErikDubbelboer/phpRedisAdmin.git</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> <span class=\"built_in\">cd</span> phpRedisAdmin</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/nrk/predis.git vendor</span></span><br></pre></td></tr></table></figure></p>\n<p>2）放置到<code>web</code>站点目录<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># cd ..</span></span><br><span class=\"line\"><span class=\"meta\"># mv phpRedisAdmin /opt/</span></span><br><span class=\"line\"><span class=\"meta\"># chown apache.apache phpRedisAdmin/ -R</span></span><br></pre></td></tr></table></figure></p>\n<p>3）编辑<code>nginx</code>配置文件<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim phpRedisAdmin.conf</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span>  www.redis.com;</span><br><span class=\"line\">    <span class=\"attribute\">autoindex</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">error_log</span>  logs/redis_error.log <span class=\"literal\">error</span>;</span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> logs/redis_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /opt/phpRedisAdmin;</span><br><span class=\"line\">        <span class=\"attribute\">index</span>  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_intercept_errors</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">error_page</span>  <span class=\"number\">404</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ \\.php$</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span>           html;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_pass</span>   <span class=\"number\">127.0.0.1:9000</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_index</span>  index.php;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_param</span>  SCRIPT_FILENAME  /opt/phpRedisAdmin<span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">        <span class=\"attribute\">include</span>        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ /\\.</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">        <span class=\"attribute\">error_page</span>  <span class=\"number\">403</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>4）配置连接管理，默认连接的是<code>6379</code>端口<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /opt/phpRedisAdmin/includes/config.sample.inc.php</span></span><br><span class=\"line\">$config = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">  <span class=\"string\">'servers'</span> =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"keyword\">array</span>(</span><br><span class=\"line\">      <span class=\"string\">'name'</span>   =&gt; <span class=\"string\">'local server'</span>, <span class=\"comment\">// Optional name.</span></span><br><span class=\"line\">      <span class=\"string\">'host'</span>   =&gt; <span class=\"string\">'127.0.0.1'</span>,</span><br><span class=\"line\">      <span class=\"string\">'port'</span>   =&gt; <span class=\"number\">6395</span>,</span><br><span class=\"line\">      <span class=\"string\">'filter'</span> =&gt; <span class=\"string\">'*'</span>,</span><br><span class=\"line\">      <span class=\"string\">'scheme'</span> =&gt; <span class=\"string\">'tcp'</span>, <span class=\"comment\">// Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket</span></span><br><span class=\"line\">      <span class=\"string\">'path'</span>   =&gt; <span class=\"string\">''</span>, <span class=\"comment\">// Optional. Path to unix domain socket. Uses only if 'scheme' =&gt; 'unix'. Example: '/var/run/redis/redis.sock'</span></span><br><span class=\"line\">      <span class=\"string\">'auth'</span> =&gt; <span class=\"string\">'jieg6uy5Dach0yooxo1l'</span> <span class=\"comment\">// Warning: The password is sent in plain-text to the Redis server.</span></span><br><span class=\"line\">    ),</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>windows</code>添加<code>host</code>然后访问 <code>http://www.redis.com</code><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n"}],"PostAsset":[{"_id":"source/_posts/phpMyAdmin搭建/4.png","slug":"4.png","post":"cjvqprtzz0007zt34iizvxh8s","modified":0,"renderable":0},{"_id":"source/_posts/phpMyAdmin搭建/6.png","slug":"6.png","post":"cjvqprtzz0007zt34iizvxh8s","modified":0,"renderable":0}],"PostCategory":[{"post_id":"cjvqprtzn0000zt34v7lyxe7s","category_id":"cjvqprtzv0003zt34tumwvx9o","_id":"cjvqpru04000dzt34qw8p99is"},{"post_id":"cjvqprtzt0002zt34tbkn1z0b","category_id":"cjvqpru000008zt34jwxt4a8s","_id":"cjvqpru05000jzt34uw18xszo"},{"post_id":"cjvqprtzx0005zt34qnllmvh1","category_id":"cjvqpru04000fzt34tk43e4tl","_id":"cjvqpru0c000nzt34yh4hc6uz"},{"post_id":"cjvqprtzy0006zt34u7nl9cwo","category_id":"cjvqpru04000fzt34tk43e4tl","_id":"cjvqpru0c000qzt34bq88xhyx"},{"post_id":"cjvqprtzz0007zt34iizvxh8s","category_id":"cjvqpru04000fzt34tk43e4tl","_id":"cjvqpru0d000rzt34hliwt7uo"},{"post_id":"cjvqpru02000bzt345nglafc6","category_id":"cjvqpru0c000pzt34vhcn2vvx","_id":"cjvqpru0d000szt344tyvf67f"},{"post_id":"cjvqpru4i000tzt34xpxhio5h","category_id":"cjvqpru0c000pzt34vhcn2vvx","_id":"cjvqpru4n000zzt34o058hcol"},{"post_id":"cjvqpru4j000vzt34y1v7g8e3","category_id":"cjvqpru0c000pzt34vhcn2vvx","_id":"cjvqpru4o0010zt342hn0uyof"},{"post_id":"cjvrt616i00009otc6hzylyo9","category_id":"cjvqpru0c000pzt34vhcn2vvx","_id":"cjvrt616v00029otc81w15evi"},{"post_id":"cjvrueukk000024tcw4tdmheh","category_id":"cjvqpru04000fzt34tk43e4tl","_id":"cjvrueukx000224tcs0sokjpr"}],"PostTag":[{"post_id":"cjvqprtzy0006zt34u7nl9cwo","tag_id":"cjvqprtzx0004zt34tuh4iqvz","_id":"cjvqpru02000azt34z27nly3d"},{"post_id":"cjvqprtzn0000zt34v7lyxe7s","tag_id":"cjvqprtzx0004zt34tuh4iqvz","_id":"cjvqpru03000czt34p1iq2ltp"},{"post_id":"cjvqprtzz0007zt34iizvxh8s","tag_id":"cjvqprtzx0004zt34tuh4iqvz","_id":"cjvqpru04000gzt34gfygqsko"},{"post_id":"cjvqprtzt0002zt34tbkn1z0b","tag_id":"cjvqprtzx0004zt34tuh4iqvz","_id":"cjvqpru05000hzt34crnjlpf1"},{"post_id":"cjvqprtzx0005zt34qnllmvh1","tag_id":"cjvqprtzx0004zt34tuh4iqvz","_id":"cjvqpru06000lzt34hizh8uz5"},{"post_id":"cjvqpru02000bzt345nglafc6","tag_id":"cjvqpru05000izt34b2elx5hy","_id":"cjvqpru0c000ozt34exhw3q6p"},{"post_id":"cjvqpru4i000tzt34xpxhio5h","tag_id":"cjvqpru05000izt34b2elx5hy","_id":"cjvqpru4m000xzt34g73nrfk1"},{"post_id":"cjvqpru4j000vzt34y1v7g8e3","tag_id":"cjvqpru05000izt34b2elx5hy","_id":"cjvqpru4n000yzt344s65cf54"},{"post_id":"cjvrt616i00009otc6hzylyo9","tag_id":"cjvqpru05000izt34b2elx5hy","_id":"cjvrt616u00019otc12268chl"},{"post_id":"cjvrueukk000024tcw4tdmheh","tag_id":"cjvqprtzx0004zt34tuh4iqvz","_id":"cjvrueukw000124tczg0itg52"}],"Tag":[{"name":"Linux运维日常","_id":"cjvqprtzx0004zt34tuh4iqvz"},{"name":"Saltstack","_id":"cjvqpru05000izt34b2elx5hy"}]}}