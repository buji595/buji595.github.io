{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.png","path":"images/avatar.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar3.png","path":"images/avatar3.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","path":"lib/algolia-instant-search/instantsearch.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","path":"lib/canvas-nest/canvas-nest.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","path":"lib/canvas-ribbon/canvas-ribbon.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/bower.json","path":"lib/font-awesome/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","path":"lib/font-awesome/HELP-US-OUT.txt","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/bower.json","path":"lib/fastclick/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/LICENSE","path":"lib/fastclick/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/README.md","path":"lib/fastclick/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","path":"lib/jquery_lazyload/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","path":"lib/jquery_lazyload/jquery.scrollstop.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","path":"lib/jquery_lazyload/CONTRIBUTING.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","path":"lib/jquery_lazyload/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","path":"lib/jquery_lazyload/jquery.lazyload.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.css","path":"lib/needsharebutton/needsharebutton.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/font-embedded.css","path":"lib/needsharebutton/font-embedded.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.js","path":"lib/needsharebutton/needsharebutton.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/bower.json","path":"lib/velocity/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","path":"lib/velocity/velocity.ui.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","path":"lib/three/canvas_lines.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","path":"lib/three/canvas_sphere.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three-waves.min.js","path":"lib/three/three-waves.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/algolia-search.js","path":"js/src/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/exturl.js","path":"js/src/exturl.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/js.cookie.js","path":"js/src/js.cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/hook-duoshuo.js","path":"js/src/hook-duoshuo.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scroll-cookie.js","path":"js/src/scroll-cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery/index.js","path":"lib/jquery/index.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","path":"lib/fancybox/source/blank.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","path":"lib/fancybox/source/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","path":"lib/fancybox/source/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","path":"lib/fancybox/source/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","path":"lib/fancybox/source/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","path":"lib/fancybox/source/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.css","path":"lib/Han/dist/han.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.js","path":"lib/Han/dist/han.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","path":"lib/font-awesome/css/font-awesome.css.map","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","path":"lib/fastclick/lib/fastclick.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","path":"lib/fastclick/lib/fastclick.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","path":"lib/ua-parser-js/dist/ua-parser.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/Valine.min.js","path":"js/src/Valine.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","path":"lib/ua-parser-js/dist/ua-parser.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","path":"lib/fancybox/source/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","path":"lib/fancybox/source/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","path":"lib/fancybox/source/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","path":"lib/Han/dist/font/han-space.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","path":"lib/Han/dist/font/han-space.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","path":"lib/Han/dist/font/han.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.woff2","path":"lib/Han/dist/font/han.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","path":"lib/Han/dist/font/han.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.js","path":"lib/Han/dist/han.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.css","path":"lib/Han/dist/han.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/av-min.js","path":"js/src/av-min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","path":"lib/font-awesome/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.js","path":"lib/velocity/velocity.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","path":"lib/font-awesome/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","path":"lib/algolia-instant-search/instantsearch.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","path":"lib/font-awesome/fonts/fontawesome-webfont.svg","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three.min.js","path":"lib/three/three.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/LICENSE","path":"lib/pace/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/README.md","path":"lib/pace/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","path":"lib/pace/pace-theme-barber-shop.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","path":"lib/pace/pace-theme-big-counter.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","path":"lib/pace/pace-theme-bounce.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","path":"lib/pace/pace-theme-center-atom.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","path":"lib/pace/pace-theme-center-circle.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","path":"lib/pace/pace-theme-center-radar.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","path":"lib/pace/pace-theme-center-simple.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","path":"lib/pace/pace-theme-corner-indicator.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","path":"lib/pace/pace-theme-fill-left.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","path":"lib/pace/pace-theme-flash.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","path":"lib/pace/pace-theme-loading-bar.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","path":"lib/pace/pace-theme-mac-osx.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","path":"lib/pace/pace-theme-minimal.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace.min.js","path":"lib/pace/pace.min.js","modified":0,"renderable":1}],"Cache":[{"_id":"themes/next/.bowerrc","hash":"3228a58ed0ece9f85e1e3136352094080b8dece1","modified":1514748788000},{"_id":"themes/next/.editorconfig","hash":"792fd2bd8174ece1a75d5fd24ab16594886f3a7f","modified":1514748788000},{"_id":"themes/next/.gitattributes","hash":"44bd4729c74ccb88110804f41746fec07bf487d4","modified":1514748788000},{"_id":"themes/next/.gitignore","hash":"0b5c2ffd41f66eb1849d6426ba8cf9649eeed329","modified":1514748788000},{"_id":"themes/next/.hound.yml","hash":"b76daa84c9ca3ad292c78412603370a367cc2bc3","modified":1514748788000},{"_id":"themes/next/.javascript_ignore","hash":"8a224b381155f10e6eb132a4d815c5b52962a9d1","modified":1514748788000},{"_id":"source/.DS_Store","hash":"cc75fbdb977a72e3c33a32b977ec965c1597d5c5","modified":1562723189876},{"_id":"themes/next/.jshintrc","hash":"9928f81bd822f6a8d67fdbc909b517178533bca9","modified":1514748788000},{"_id":"themes/next/.stylintrc","hash":"b28e24704a5d8de08346c45286574c8e76cc109f","modified":1514748788000},{"_id":"themes/next/.travis.yml","hash":"d60d4a5375fea23d53b2156b764a99b2e56fa660","modified":1514748788000},{"_id":"themes/next/LICENSE","hash":"f293bcfcdc06c0b77ba13570bb8af55eb5c059fd","modified":1514748788000},{"_id":"themes/next/README.md","hash":"898213e66d34a46c3cf8446bf693bd50db0d3269","modified":1514748788000},{"_id":"themes/next/_config.yml","hash":"3ddbe7c9e9154a955eac790577119209bf4e16d4","modified":1559133328365},{"_id":"themes/next/bower.json","hash":"0674f11d3d514e087a176da0e1d85c2286aa5fba","modified":1514748788000},{"_id":"themes/next/gulpfile.coffee","hash":"031bffc483e417b20e90eceb6cf358e7596d2e69","modified":1514748788000},{"_id":"themes/next/README.cn.md","hash":"58ffe752bc4b7f0069fcd6304bbc2d5ff7b80f89","modified":1514748788000},{"_id":"themes/next/package.json","hash":"036d3a1346203d2f1a3958024df7f74e7ac07bfe","modified":1514748788000},{"_id":"source/_posts/.DS_Store","hash":"a2208f10977c1030be83153e392c996bfc25866a","modified":1562723189879},{"_id":"source/_posts/Ansible Ad-hoc常用Module.md","hash":"226a167410197b8403398f3cdc8b55ea50fa2002","modified":1562723189880},{"_id":"source/_posts/Ansible之Playbook.md","hash":"0e93e1a72f439c6887250279406c4f713cac16aa","modified":1562723189882},{"_id":"source/_posts/Ansible之Roles.md","hash":"ae396f4dc654f09c8b940928322819969442b156","modified":1562723189892},{"_id":"source/_posts/ELK快速入门(一)-基本部署.md","hash":"c434eafa5343bccde2ecabef8afd0b5f03c61fca","modified":1562724291918},{"_id":"source/_posts/Ansible快速入门.md","hash":"4f6b595a873a7d41511e1f89379448de527ed1d1","modified":1562723189899},{"_id":"source/_posts/Ansible项目实战lnmp.md","hash":"b1225b5d548227eefe58fe75ad20b8654978d283","modified":1562723189906},{"_id":"source/_posts/MySQL自动备份脚本.md","hash":"8ee5aaa0cf9ab6fcd9f1b98d4004a804e2647160","modified":1558099401438},{"_id":"source/_posts/Tomcat+Nginx+Memcached综合案例.md","hash":"704a711f5653f9985ff0419ccf99f67f94c02be0","modified":1562723189979},{"_id":"source/_posts/Cobbler自动化部署.md","hash":"ef1b5c478d3d242fb88af4a92bd580f591d5ff09","modified":1562723189912},{"_id":"source/_posts/ftp虚拟用户.md","hash":"2d5bbc0dadc9f492a1215d2929c0d6ec4e674a21","modified":1556030242762},{"_id":"source/_posts/Tomcat安装与部署.md","hash":"d13a31cbd5fd11ecc60c27e67dc1f2e1f91f61bb","modified":1562723189992},{"_id":"source/_posts/linux下解压windows上压缩rar包.md","hash":"3d5d981f7556a44a9b132a1549a8d3ae5b22c495","modified":1556604910476},{"_id":"source/_posts/linux保存history到日志文件.md","hash":"bd29ec4a126f39b0feb431d10ece11811561b940","modified":1558530479030},{"_id":"source/_posts/phpMyAdmin搭建.md","hash":"4233eca65b3534890a91f5822f46e4e34349b603","modified":1558099401439},{"_id":"source/_posts/phpRedisAdmin搭建.md","hash":"c32a0be5c2bc4e10f263c126611631876071da94","modified":1558099401439},{"_id":"source/_posts/saltstack使用salt-ssh.md","hash":"f3c2948a2af418839fca7ddcd15cab04aa79d653","modified":1558614597764},{"_id":"source/_posts/saltstack基本入门.md","hash":"118a7daedaf11c5492897b5f4d556b1d8ffd963b","modified":1559050987955},{"_id":"source/_posts/saltstack接口salt-api.md","hash":"67ee2a5013fdb8caabf898541de226a200dccdcc","modified":1558624521768},{"_id":"source/_posts/saltstack状态判断unless与onlyif.md","hash":"e9ef51404589f7eee200a87d0556aef4d72f4466","modified":1559051711365},{"_id":"source/_posts/saltstack远程执行.md","hash":"93af1bda429bd03dbde8a564ac58982e938e3781","modified":1559051402567},{"_id":"source/_posts/saltstack数据系统.md","hash":"331a69c03987f73ba57bb2c40b8cafd0177eb83f","modified":1558099401439},{"_id":"source/categories/index.md","hash":"af423fcd07075032a3891c59f4c6704b453b561c","modified":1556159772750},{"_id":"source/photos/index.md","hash":"6c52c1388adffb027c83f747bc05133bec05508c","modified":1555951095074},{"_id":"source/tags/index.md","hash":"519745fc886e3e27fd53e7d567b98241f75a537e","modified":1556159772755},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"3b5eafd32abb718e56ccf8d1cee0607ad8ce611d","modified":1514748788000},{"_id":"source/_posts/saltstack配置管理.md","hash":"fb0718e2421cc26a0f6d2778876d1c3b6a78dda2","modified":1559051535398},{"_id":"themes/next/.github/ISSUE_TEMPLATE.md","hash":"352093a1b210c72136687fd2eee649244cee402c","modified":1514748788000},{"_id":"themes/next/.github/browserstack_logo.png","hash":"a6c43887f64a7f48a2814e3714eaa1215e542037","modified":1562723190460},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"902f627155a65099e0a37842ff396a58d0dc306f","modified":1514748788000},{"_id":"themes/next/languages/de.yml","hash":"057e7df11ddeb1c8c15a5d7c5ff29430d725ec6b","modified":1514748788000},{"_id":"themes/next/languages/default.yml","hash":"44ef3f26917f467459326c2c8be2f73e4d947f35","modified":1514748788000},{"_id":"themes/next/languages/fr-FR.yml","hash":"7e4eb7011b8feee641cfb11c6e73180b0ded1c0f","modified":1514748788000},{"_id":"source/_posts/saltstack项目实战.md","hash":"ee1f85fca3cd40e4bcf8fb3030380b6c80373b42","modified":1559053617451},{"_id":"themes/next/languages/id.yml","hash":"b5de1ea66dd9ef54cac9a1440eaa4e3f5fc011f5","modified":1514748788000},{"_id":"themes/next/languages/it.yml","hash":"aa595f2bda029f73ef7bfa104b4c55c3f4e9fb4c","modified":1514748788000},{"_id":"themes/next/languages/ja.yml","hash":"3c76e16fd19b262864475faa6854b718bc08c4d8","modified":1514748788000},{"_id":"themes/next/languages/ko.yml","hash":"ea5b46056e73ebcee121d5551627af35cbffc900","modified":1514748788000},{"_id":"themes/next/languages/nl-NL.yml","hash":"edca4f3598857dbc3cbf19ed412213329b6edd47","modified":1514748788000},{"_id":"themes/next/languages/pt-BR.yml","hash":"b1694ae766ed90277bcc4daca4b1cfa19cdcb72b","modified":1514748788000},{"_id":"themes/next/languages/en.yml","hash":"7e680d9bb8f3a3a9d1ba1c9d312b3d257183dded","modified":1556168496047},{"_id":"themes/next/languages/pt.yml","hash":"44b61f2d085b827b507909a0b8f8ce31c6ef5d04","modified":1514748788000},{"_id":"themes/next/languages/ru.yml","hash":"98ec6f0b7183282e11cffc7ff586ceb82400dd75","modified":1514748788000},{"_id":"themes/next/languages/vi.yml","hash":"fd08d3c8d2c62965a98ac420fdaf95e54c25d97c","modified":1514748788000},{"_id":"themes/next/languages/zh-hk.yml","hash":"9396f41ae76e4fef99b257c93c7354e661f6e0fa","modified":1514748788000},{"_id":"themes/next/languages/zh-Hans.yml","hash":"7dac6b188c6a3902d01613383c5350f65d442f08","modified":1556168621773},{"_id":"themes/next/languages/zh-tw.yml","hash":"50b71abb3ecc0686f9739e179e2f829cd074ecd9","modified":1514748788000},{"_id":"themes/next/layout/archive.swig","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1514748788000},{"_id":"themes/next/layout/category.swig","hash":"4472255f4a3e3dd6d79201523a9526dcabdfbf18","modified":1514748788000},{"_id":"themes/next/layout/index.swig","hash":"783611349c941848a0e26ee2f1dc44dd14879bd1","modified":1514748788000},{"_id":"themes/next/layout/page.swig","hash":"969caaee05bdea725e99016eb63d810893a73e99","modified":1514748788000},{"_id":"themes/next/layout/_layout.swig","hash":"129f3c8fdbd182624578840cc07278fd17eaf64e","modified":1556168041888},{"_id":"themes/next/layout/post.swig","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1514748788000},{"_id":"themes/next/scripts/merge-configs.js","hash":"81e86717ecfb775986b945d17f0a4ba27532ef07","modified":1514748788000},{"_id":"themes/next/layout/schedule.swig","hash":"d86f8de4e118f8c4d778b285c140474084a271db","modified":1514748788000},{"_id":"themes/next/scripts/merge.js","hash":"9130dabe6a674c54b535f322b17d75fe6081472f","modified":1514748788000},{"_id":"themes/next/layout/tag.swig","hash":"7e0a7d7d832883eddb1297483ad22c184e4368de","modified":1514748788000},{"_id":"themes/next/test/.jshintrc","hash":"19f93d13d1689fe033c82eb2d5f3ce30b6543cc0","modified":1514748788000},{"_id":"themes/next/test/helpers.js","hash":"a1f5de25154c3724ffc24a91ddc576cdbd60864f","modified":1514748788000},{"_id":"themes/next/test/intern.js","hash":"11fa8a4f5c3b4119a179ae0a2584c8187f907a73","modified":1514748788000},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1562723191215},{"_id":"source/_posts/Ansible之Playbook/shili01.png","hash":"4f216827edf551fe8755e3b4c790c24ac4e52505","modified":1562723189886},{"_id":"source/_posts/Ansible之Playbook/shili02.png","hash":"3d127d14ef9c1da568f348e861ccbcbce5ca5118","modified":1562723189888},{"_id":"source/_posts/Ansible之Roles/rolesdir.png","hash":"19ef4e21ac4c65dc5ef22f755417e0cfc8087dfe","modified":1562723189896},{"_id":"source/_posts/Ansible快速入门/ansible01.png","hash":"e4182ab79097348cb4096d8cacce3b6d4672d241","modified":1562723189901},{"_id":"source/_posts/Ansible项目实战lnmp/01.png","hash":"eb4c76655fd0023a11dd419c97c10b926d63808b","modified":1562723189910},{"_id":"source/_posts/Cobbler自动化部署/cobbler01.png","hash":"46d7b822d6ca0f08def6f6091cef733469bf2811","modified":1562723189915},{"_id":"source/_posts/Cobbler自动化部署/cobbler02.png","hash":"edba58d13a438890a866f45a683f24f2a4a2320b","modified":1562723189916},{"_id":"source/_posts/Cobbler自动化部署/cobbler03.png","hash":"b58a92a889b217989c2d2d8c51c31f01eb7777f6","modified":1562723189918},{"_id":"source/_posts/Cobbler自动化部署/cobbler04.png","hash":"759e8d0ca872cea3a4172edaa1df5af3dd9a04b2","modified":1562723189920},{"_id":"source/_posts/Cobbler自动化部署/cobbler05.png","hash":"d941c6997785c4a996b932e82bc392f0e7245bc1","modified":1562723189924},{"_id":"source/_posts/Cobbler自动化部署/cobbler06.png","hash":"87e3f4627af2b3ca59d4b66e8788d4fe4dfbfc7b","modified":1562723189926},{"_id":"source/_posts/Cobbler自动化部署/cobbler07.png","hash":"6296622ee58f2867dd122565e5a9ffa8c18d4c71","modified":1562723189929},{"_id":"source/_posts/Cobbler自动化部署/cobbler08.png","hash":"4d11fa24a18f5f08c260b1c8a4a11f6c4be62afc","modified":1562723189931},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk01.png","hash":"c70144da14842696315b42c43f3ad0f5eb01c771","modified":1562723189939},{"_id":"source/_posts/Cobbler自动化部署/cobbler09.png","hash":"7a5dd05b41eb020a9f100bae7ba27d578185da68","modified":1562723189934},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk02.png","hash":"a150dafb1e65bdb535327db300468023f25c2896","modified":1562723189941},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk03.png","hash":"8d4ee8baa4cfcf17e61dd0d00f9a4a893e548f13","modified":1562723189943},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk05.png","hash":"9933382fd35c9ac4738910889a90c3533070ced3","modified":1562723189948},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk04.png","hash":"35ba8275b4cc7641300e716eae5c7f46274c597f","modified":1562723189946},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk07.png","hash":"b51f9ec453b78eb65d4a6a71b7205bd75ba3ff15","modified":1562723189953},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk08.png","hash":"9a1656d13d4a9406f6b44b18a0394fe0d599583a","modified":1562723189955},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk10.png","hash":"89c2ba24da18785487fd3564f1f266d82c9508e9","modified":1562723189961},{"_id":"source/_posts/Tomcat+Nginx+Memcached综合案例/tomcat1.png","hash":"4c08727e323c70ec90af6ad8aa4c22ee2915e114","modified":1562723189982},{"_id":"source/_posts/Tomcat+Nginx+Memcached综合案例/tomcat2.png","hash":"c1d2c9e6bc0cc17508f4237eb8909f4f7ee82148","modified":1562723189984},{"_id":"source/_posts/Tomcat+Nginx+Memcached综合案例/tomcat3.png","hash":"df7906d842b2d826430b7ac5893febd8b275e4ae","modified":1562723189988},{"_id":"source/_posts/Tomcat+Nginx+Memcached综合案例/tomcat4.png","hash":"36b6a4a48edb29efc7c4363be55ef505b707eddb","modified":1562723189990},{"_id":"source/_posts/Tomcat安装与部署/tomcat09.png","hash":"c15a91d5f18f4637802fa1f8e2ef804f0c910020","modified":1562723190024},{"_id":"source/_posts/Tomcat安装与部署/tomcat07.png","hash":"a3d2c47acb386263580de47bd930f58538d09936","modified":1562723190019},{"_id":"source/_posts/Tomcat安装与部署/tomcat08.png","hash":"9c7b5c173fe702df224ccfd717b0b9c01a16c28c","modified":1562723190022},{"_id":"source/_posts/imgs/salt01.png","hash":"680d3cb476d5561e2f0fe20c9f62fb87dc56929a","modified":1562723190029},{"_id":"source/_posts/imgs/salt03.png","hash":"95ad81478ae7a8e095f8ce776df11aa8444e0ca0","modified":1562723190034},{"_id":"source/_posts/imgs/salt02.png","hash":"57dc4a414ae7cf205d9088da4e422554257df936","modified":1562723190031},{"_id":"source/_posts/imgs/salt04.png","hash":"784057974cfaa2ff6c8968d444dd1bf6759c0df8","modified":1562723190036},{"_id":"source/_posts/imgs/salt05.png","hash":"39d6666f7c6f67244822f8e9b3c19610913d09cb","modified":1562723190037},{"_id":"source/_posts/saltstack基本入门/01.png","hash":"f99529f78ab049a94edd5ebfe07f1d778f1b4fbe","modified":1562723190065},{"_id":"source/_posts/saltstack基本入门/02.png","hash":"585647e926ce0ad2694873ac58cb96f3be273618","modified":1562723190067},{"_id":"source/_posts/saltstack状态判断unless与onlyif/01.png","hash":"898bad3ebe967c968e96d72b6cfba5d7ea407f4a","modified":1562723190076},{"_id":"source/_posts/saltstack远程执行/01.png","hash":"4a1242e6982b7e6162816a1fe2f73b986cd78952","modified":1562723190082},{"_id":"source/_posts/saltstack远程执行/02.png","hash":"b48ef022820ebe417aec28127e4aca5418d259bc","modified":1562723190084},{"_id":"source/_posts/saltstack远程执行/03.png","hash":"54fff484d84f5d5f95e9a2679209fa66d882ac54","modified":1562723190086},{"_id":"source/_posts/saltstack配置管理/01.png","hash":"5477e294cae7f6f4853ef95c99e62dde2ffd5464","modified":1562723190091},{"_id":"source/_posts/saltstack项目实战/02.png","hash":"7b18158dc717b1486fce6bd06c5adb19e82c7218","modified":1562723190099},{"_id":"source/_posts/saltstack项目实战/01.png","hash":"d57188079384d29207f342306ef0124192e81e84","modified":1562723190097},{"_id":"themes/next/layout/_partials/comments.swig","hash":"4a6f5b1792b2e5262b7fdab9a716b3108e2f09c7","modified":1514748788000},{"_id":"themes/next/layout/_partials/footer.swig","hash":"aa1ac4d03db4095709f95571dca47c30646dc34b","modified":1555939819838},{"_id":"themes/next/layout/_partials/page-header.swig","hash":"1efd925d34a5d4ba2dc0838d9c86ba911e705fc9","modified":1514748788000},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"9e8e21d194ef44d271b1cca0bc1448c14d7edf4f","modified":1514748788000},{"_id":"themes/next/layout/_partials/search.swig","hash":"9dbd378e94abfcb3f864a5b8dbbf18d212ca2ee0","modified":1514748788000},{"_id":"themes/next/layout/_partials/head.swig","hash":"6b94fe8f3279daea5623c49ef4bb35917ba57510","modified":1514748788000},{"_id":"themes/next/layout/_macro/passage-end-tag.swig","hash":"f29b50d83bcdc9e70696b6a8a8917d8b2ad4be10","modified":1555935543509},{"_id":"themes/next/layout/_partials/header.swig","hash":"ed042be6252848058c90109236ec988e392d91d4","modified":1514748788000},{"_id":"themes/next/layout/_macro/my-copyright.swig","hash":"b6e335c7773b0af614a897b1cdd428d0d7f0d59e","modified":1555947276734},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"31322a7f57936cf2dc62e824af5490da5354cf02","modified":1514748788000},{"_id":"themes/next/layout/_macro/post-copyright.swig","hash":"665a928604f99d2ba7dc4a4a9150178229568cc6","modified":1514748788000},{"_id":"themes/next/layout/_custom/header.swig","hash":"adc83b19e793491b1c6ea0fd8b46cd9f32e592fc","modified":1514748788000},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"39852700e4084ecccffa6d4669168e5cc0514c9e","modified":1514748788000},{"_id":"themes/next/layout/_custom/sidebar.swig","hash":"adc83b19e793491b1c6ea0fd8b46cd9f32e592fc","modified":1514748788000},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"03aaebe9d50f6acb007ec38cc04acd1cfceb404d","modified":1514748788000},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"766b2bdda29523ed6cd8d7aa197f996022f8fd94","modified":1514748788000},{"_id":"themes/next/layout/_macro/reward.swig","hash":"56e8d8556cf474c56ae1bef9cb7bbd26554adb07","modified":1514748788000},{"_id":"themes/next/layout/_macro/post.swig","hash":"a2dce2d123e61bb99c1f98d9a4acbe465f992ff1","modified":1555947765151},{"_id":"themes/next/layout/_third-party/duoshuo-hot-articles.swig","hash":"5d4638c46aef65bf32a01681495b62416ccc98db","modified":1514748788000},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"6a54c3c85ff6b19d275827a327abbf4bd99b2ebf","modified":1514748788000},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"a266f96ad06ee87bdeae6e105a4b53cd587bbd04","modified":1514748788000},{"_id":"themes/next/layout/_third-party/copy-code.swig","hash":"c64e52f01d243e00190ed20c6dff33b1dfc950ad","modified":1556167993275},{"_id":"themes/next/layout/_third-party/mathjax.swig","hash":"6d25596d6a7c57700d37b607f8d9a62d89708683","modified":1514748788000},{"_id":"themes/next/layout/_third-party/needsharebutton.swig","hash":"5fe0447cc88a5a63b530cf0426f93c4634811876","modified":1514748788000},{"_id":"themes/next/layout/_third-party/scroll-cookie.swig","hash":"1ddb2336a1a19b47af3017047012c01ec5f54529","modified":1514748788000},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"fc93b1a7e6aed0dddb1f3910142b48d8ab61174e","modified":1514748788000},{"_id":"themes/next/layout/_third-party/schedule.swig","hash":"22369026c87fc23893c35a7f250b42f3bb1b60f1","modified":1514748788000},{"_id":"themes/next/layout/_third-party/exturl.swig","hash":"7c04a42319d728be356746363aff8ea247791d24","modified":1514748788000},{"_id":"themes/next/scripts/tags/button.js","hash":"d023f10a00077f47082b0517e2ad666e6e994f60","modified":1514748788000},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"535fc542781021c4326dec24d8495cbb1387634a","modified":1514748788000},{"_id":"themes/next/scripts/tags/exturl.js","hash":"8d7e60f60779bde050d20fd76f6fdc36fc85e06d","modified":1514748788000},{"_id":"themes/next/scripts/tags/full-image.js","hash":"8eeb3fb89540299bdbb799edfdfdac3743b50596","modified":1514748788000},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"49252824cd53184dc9b97b2f2d87ff28e1b3ef27","modified":1514748788000},{"_id":"themes/next/scripts/tags/lazy-image.js","hash":"eeeabede68cf263de9e6593ecf682f620da16f0a","modified":1514748788000},{"_id":"themes/next/scripts/tags/label.js","hash":"2f8f41a7316372f0d1ed6b51190dc4acd3e16fff","modified":1514748788000},{"_id":"themes/next/scripts/tags/note.js","hash":"64de4e9d01cf3b491ffc7d53afdf148ee5ad9779","modified":1514748788000},{"_id":"themes/next/scripts/tags/tabs.js","hash":"5786545d51c38e8ca38d1bfc7dd9e946fc70a316","modified":1514748788000},{"_id":"themes/next/source/css/main.styl","hash":"20702c48d6053c92c5bcdbc68e8d0ef1369848a0","modified":1514748788000},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1562723191221},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1562723191222},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1514748788000},{"_id":"themes/next/source/images/avatar.png","hash":"75dbfd5a1d3a64eb4fdd4dcc30127b243cead72c","modified":1562723191226},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1514748788000},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1514748788000},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1514748788000},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1514748788000},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1562723191247},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1514748788000},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1562723191251},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1514748788000},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1514748788000},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1562723191255},{"_id":"themes/next/source/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1514748788000},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1562723191249},{"_id":"themes/next/source/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1514748788000},{"_id":"themes/next/source/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1514748788000},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1562723191260},{"_id":"source/_posts/Ansible之Playbook/shili03.png","hash":"42b05c85e59394f5a874eaca576e957a8e2ca644","modified":1562723189890},{"_id":"source/_posts/Ansible快速入门/ansible02.png","hash":"b7f4d78494b2a113e0181a55c04570a292eafe2a","modified":1562723189904},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk06.png","hash":"0d4381e03459395fbba3feb4e0a041d87e6b8c50","modified":1562723189951},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk12.png","hash":"be759c34d6894996320edcea86c2e8a8934da552","modified":1562723189966},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk14.png","hash":"bb213a559bf9ed568f6505e2ed975d40e7f5da08","modified":1562723189972},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk13.png","hash":"2e5db86fb4a64b36c9481980ab805ad687f52ed2","modified":1562723189969},{"_id":"source/_posts/Tomcat安装与部署/tomcat02.png","hash":"ad15a810bd06f98a285de89e17ce84d9a7e932f8","modified":1562723190005},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk09.png","hash":"e64769568a4a319718a80cab8a935e30b1142d2c","modified":1562723189958},{"_id":"source/_posts/Tomcat安装与部署/tomcat03.png","hash":"30d0e1baec42f786f6b9aa1d08d34154bc5a2d1e","modified":1562723190008},{"_id":"source/_posts/Tomcat安装与部署/tomcat05.png","hash":"8a2aa2a85c256d94cedb1fc32ff5daa099847f1a","modified":1562723190013},{"_id":"source/_posts/Tomcat安装与部署/tomcat04.png","hash":"0bfc60aa9b4620d04ea2ae4e0a27b32ddc9a8499","modified":1562723190010},{"_id":"source/_posts/saltstack项目实战/05.png","hash":"067e380e55a87c7c315435995b51595e0f89fd62","modified":1562723190111},{"_id":"source/_posts/saltstack项目实战/06.png","hash":"880626056397aad0e5869f0ab0ff24d87852ad28","modified":1562723190114},{"_id":"source/_posts/saltstack项目实战/07.png","hash":"5893686789a705730765ac77de80f72084d6f385","modified":1562723190116},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1562723190638},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1562723190648},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1562723191142},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1562723191142},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1562723191148},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1562723191206},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1562723191211},{"_id":"themes/next/source/images/avatar3.png","hash":"5b475bcde35a71d593059d4ca27d4c005bdfa180","modified":1562723191229},{"_id":"source/_posts/Tomcat安装与部署/tomcat01.png","hash":"9ff9946bda56211c372d5452632150f7325bf27b","modified":1562723189998},{"_id":"source/_posts/phpMyAdmin搭建/4.png","hash":"19c4b342d5c4a2d29e98611d7ddf4f2a9610d604","modified":1562723190049},{"_id":"themes/next/layout/_partials/head/custom-head.swig","hash":"9e1b9666efa77f4cf8d8261bcfa445a9ac608e53","modified":1514748788000},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"7ce76358411184482bb0934e70037949dd0da8ca","modified":1514748788000},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"957701729b85fb0c5bfcf2fb99c19d54582f91ed","modified":1514748788000},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"959b7e04a96a5596056e4009b73b6489c117597e","modified":1514748788000},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"eefe2388ff3d424694045eda21346989b123977c","modified":1514748788000},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"23e23dc0f76ef3c631f24c65277adf7ea517b383","modified":1514748788000},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"1f1107468aaf03f7d0dcd7eb2b653e2813a675b4","modified":1514748788000},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"89c5a5240ecb223acfe1d12377df5562a943fd5d","modified":1514748788000},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"048fd5e98149469f8c28c21ba3561a7a67952c9b","modified":1514748788000},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"a44acf9b0d0f44ef3dfc767376a95c984cc127de","modified":1514748788000},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"069d1357c717572256e5cdee09574ebce529cbae","modified":1514748788000},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a44acf9b0d0f44ef3dfc767376a95c984cc127de","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"0e3378f7c39b2b0f69638290873ede6b6b6825c0","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"c316758546dc9ba6c60cb4d852c17ca6bb6d6724","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/index.swig","hash":"aa0629277d751c55c6d973e7691bf84af9b17a60","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/duoshuo.swig","hash":"a356b2185d40914447fde817eb3d358ab6b3e4c3","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/gitment.swig","hash":"10160daceaa6f1ecf632323d422ebe2caae49ddf","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/hypercomments.swig","hash":"3e8dc5c6c912628a37e3b5f886bec7b2e5ed14ea","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/youyan.swig","hash":"8b6650f77fe0a824c8075b2659e0403e0c78a705","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"8a2e393d2e49f7bf560766d8a07cd461bf3fce4f","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"db61e9aba8d5d9d8df384c27a612b93d2b12742e","modified":1557753665172},{"_id":"themes/next/layout/_third-party/analytics/analytics-with-widget.swig","hash":"98df9d72e37dd071e882f2d5623c9d817815b139","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"deda6a814ed48debc694c4e0c466f06c127163d0","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/application-insights.swig","hash":"60426bf73f8a89ba61fb1be2df3ad5398e32c4ef","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/busuanzi-counter.swig","hash":"18e7bef8923d83ea42df6c97405e515a876cede4","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/cnzz-analytics.swig","hash":"8160b27bee0aa372c7dc7c8476c05bae57f58d0f","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/facebook-sdk.swig","hash":"a234c5cd1f75ca5731e814d0dbb92fdcf9240d1b","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/firestore.swig","hash":"1cd01c6e92ab1913d48e556a92bb4f28b6dc4996","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"5d9943d74cc2e0a91badcf4f755c6de77eab193a","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"5e9bb24c750b49513d9a65799e832f07410002ac","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/lean-analytics.swig","hash":"fc65b9c98a0a8ab43a5e7aabff6c5f03838e09c8","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/tencent-analytics.swig","hash":"3658414379e0e8a34c45c40feadc3edc8dc55f88","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/tencent-mta.swig","hash":"0ddc94ed4ba0c19627765fdf1abc4d8efbe53d5a","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/vkontakte-api.swig","hash":"c3971fd154d781088e1cc665035f8561a4098f4c","modified":1514748788000},{"_id":"themes/next/layout/_third-party/search/index.swig","hash":"c747fb5c6b1f500e8f0c583e44195878b66e4e29","modified":1514748788000},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"385c066af96bee30be2459dbec8aae1f15d382f5","modified":1514748788000},{"_id":"themes/next/layout/_third-party/search/tinysou.swig","hash":"cb3a5d36dbe1630bab84e03a52733a46df7c219b","modified":1514748788000},{"_id":"themes/next/layout/_third-party/seo/baidu-push.swig","hash":"c057b17f79e8261680fbae8dc4e81317a127c799","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/Gemini.styl","hash":"2aa5b7166a85a8aa34b17792ae4f58a5a96df6cc","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"9ab65361ba0a12a986edd103e56492644c2db0b8","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"82f9055955920ed88a2ab6a20ab02169abb2c634","modified":1514748788000},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"99fbb4686ea9a3e03a4726ed7cf4d8f529034452","modified":1514748788000},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"be087dcc060e8179f7e7f60ab4feb65817bd3d9f","modified":1514748788000},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"f29165e36489a87ba32d17dddfd2720d84e3f3ec","modified":1514748788000},{"_id":"themes/next/source/css/_variables/base.styl","hash":"29c261fa6b4046322559074d75239c6b272fb8a3","modified":1514748788000},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"5395615efd23c7784dcdd87fb9b31dadc6fc061e","modified":1557926677516},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1562723191320},{"_id":"themes/next/source/lib/font-awesome/.gitignore","hash":"69d152fa46b517141ec3b1114dd6134724494d83","modified":1514748788000},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1562723191327},{"_id":"themes/next/source/lib/font-awesome/.npmignore","hash":"dcf470ab3a358103bb896a539cc03caeda10fa8b","modified":1514748788000},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","hash":"ff5915eb2596e890a2fc6697c864f861a1995ec0","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/bower.json","hash":"279a8a718ab6c930a67c41237f0aac166c1b9440","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/.bower.json","hash":"a2aaaf12378db56bd10596ba3daae30950eac051","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/.bower.json","hash":"93ebd5b35e632f714dcf1753e1f6db77ec74449b","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/bower.json","hash":"13379463c7463b4b96d13556b46faa4cc38d81e6","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/LICENSE","hash":"dcd5b6b43095d9e90353a28b09cb269de8d4838e","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/README.md","hash":"1decd8e1adad2cd6db0ab50cf56de6035156f4ea","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/.bower.json","hash":"b7638afc93e9cd350d0783565ee9a7da6805ad8e","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","hash":"65bc85d12197e71c40a55c0cd7f6823995a05222","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","hash":"4891864c24c28efecd81a6a8d3f261145190f901","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","hash":"895d50fa29759af7835256522e9dd7dac597765c","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1514748788000},{"_id":"themes/next/source/lib/jquery/.bower.json","hash":"91745c2cc6c946c7275f952b2b0760b880cea69e","modified":1514748788000},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.css","hash":"3ef0020a1815ca6151ea4886cd0d37421ae3695c","modified":1514748788000},{"_id":"themes/next/source/lib/needsharebutton/font-embedded.css","hash":"c39d37278c1e178838732af21bd26cd0baeddfe0","modified":1514748788000},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.js","hash":"9885fd9bea5e7ebafc5b1de9d17be5e106248d96","modified":1514748788000},{"_id":"themes/next/source/lib/velocity/.bower.json","hash":"05f960846f1c7a93dab1d3f9a1121e86812e8c88","modified":1514748788000},{"_id":"themes/next/source/lib/velocity/bower.json","hash":"2ec99573e84c7117368beccb9e94b6bf35d2db03","modified":1514748788000},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1514748788000},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","hash":"b4e960835d8700839e458e2cf7a3d7aed5b249ee","modified":1555861289608},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"d49abca8562d79c89ac7d323021f405d80721127","modified":1555861289601},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","hash":"dce4a3b65f8bf958f973690caa7ec4952f353b0c","modified":1514748788000},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","hash":"d8ea241a53c135a650f7335d2b6982b899fd58a9","modified":1514748788000},{"_id":"themes/next/source/lib/three/three-waves.min.js","hash":"d968cba6b3a50b3626a02d67b544f349d83b147c","modified":1514748788000},{"_id":"themes/next/source/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1514748788000},{"_id":"themes/next/source/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1514748788000},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"034bc8113e0966fe2096ba5b56061bbf10ef0512","modified":1514748788000},{"_id":"themes/next/source/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1514748788000},{"_id":"themes/next/source/js/src/js.cookie.js","hash":"9b37973a90fd50e71ea91682265715e45ae82c75","modified":1514748788000},{"_id":"themes/next/source/js/src/post-details.js","hash":"a13f45f7aa8291cf7244ec5ba93907d119c5dbdd","modified":1514748788000},{"_id":"themes/next/source/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1514748788000},{"_id":"themes/next/source/js/src/scroll-cookie.js","hash":"09dc828cbf5f31158ff6250d2bf7c3cde6365c67","modified":1514748788000},{"_id":"source/_posts/saltstack项目实战/04.png","hash":"44e810310977ed2c02157d38ee5c3fb92e9c66e1","modified":1562723190105},{"_id":"themes/next/source/js/src/utils.js","hash":"9b1325801d27213083d1487a12b1a62b539ab6f8","modified":1514748788000},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1514748788000},{"_id":"themes/next/source/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1514748788000},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk15.png","hash":"f58d1600e2ee3d4ae0741c2bf72175ccb440001e","modified":1562723189974},{"_id":"themes/next/source/js/src/motion.js","hash":"754b294394f102c8fd9423a1789ddb1201677898","modified":1514748788000},{"_id":"source/_posts/saltstack项目实战/03.png","hash":"de3252e2c048eeca52ba2a940631ba824cbbf3ad","modified":1562723190102},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"7e509c7c28c59f905b847304dd3d14d94b6f3b8e","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"31050fc7a25784805b4843550151c93bfa55c9c8","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"4719ce717962663c5c33ef97b1119a0b3a4ecdc3","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"471f1627891aca5c0e1973e09fbcb01e1510d193","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"a6bb5256be6195e76addbda12f4ed7c662d65e7a","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"c5d48863f332ff8ce7c88dec2c893f709d7331d3","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"dd8a3b22fc2f222ac6e6c05bd8a773fb039169c0","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"f7c44b0ee46cf2cf82a4c9455ba8d8b55299976f","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"9c25c75311e1bd4d68df031d3f2ae6d141a90766","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/mobile.styl","hash":"47a46583a1f3731157a3f53f80ed1ed5e2753e8e","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"a280a583b7615e939aaddbf778f5c108ef8a2a6c","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"ece571f38180febaf02ace8187ead8318a300ea7","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"64f5d56c08d74a338813df1265580ca0cbf0190b","modified":1514748788000},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"2186be20e317505cd31886f1291429cc21f76703","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"c2d079788d6fc2e9a191ccdae94e50d55bf849dc","modified":1514748788000},{"_id":"themes/next/layout/_third-party/search/algolia-search/assets.swig","hash":"28ff4ed6714c59124569ffcbd10f1173d53ca923","modified":1514748788000},{"_id":"themes/next/layout/_third-party/search/algolia-search/dom.swig","hash":"ba698f49dd3a868c95b240d802f5b1b24ff287e4","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"5ae7906dc7c1d9468c7f4b4a6feddddc555797a1","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"38e5df90c8689a71c978fd83ba74af3d4e4e5386","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"b0dcca862cd0cc6e732e33d975b476d744911742","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"98540f2bbc89f6cd806609da9ad42a1f73c01b28","modified":1556158705840},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"9a5581a770af8964064fef7afd3e16963e45547f","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"0efa036a15c18f5abb058b7c0fad1dd9ac5eed4c","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"18c3336ee3d09bd2da6a876e1336539f03d5a973","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"8829bc556ca38bfec4add4f15a2f028092ac6d46","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"02fb8fa6b6c252b6bed469539cd057716606a787","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"a0e2030a606c934fb2c5c7373aaae04a1caac4c5","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"c4ed249798296f60bda02351fe6404fb3ef2126f","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"5b93958239d3d2bf9aeaede44eced2434d784462","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"2f878213cb24c5ddc18877f6d15ec5c5f57745ac","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"215de948be49bcf14f06d500cef9f7035e406a43","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"9d16fa3c14ed76b71229f022b63a02fd0f580958","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"69ecd6c97e7cdfd822ac8102b45ad0ede85050db","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1562723191336},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1562723191338},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1562723191340},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1562723191342},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1562723191346},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1562723191348},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/han.css","hash":"bd40da3fba8735df5850956814e312bd7b3193d7","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/han.min.js","hash":"f559c68a25065a14f47da954a7617d87263e409d","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1562723191380},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1514748788000},{"_id":"source/_posts/Tomcat安装与部署/tomcat06.png","hash":"49db5f9104c59d6f509e2a90303123d477a0b76f","modified":1562723190018},{"_id":"themes/next/source/js/src/Valine.min.js","hash":"f3f7072297784338bc8dd8876df280355820fbf5","modified":1557751508334},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"8050a5b2683d1d77238c5762b6bd89c543daed6e","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1562723191418},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"7905a7f625702b45645d8be1268cb8af3f698c70","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"ae1ca14e51de67b07dba8f61ec79ee0e2e344574","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d27448f199fc2f9980b601bc22b87f08b5d64dd1","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"49c2b2c14a1e7fcc810c6be4b632975d0204c281","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/highlight/diff.styl","hash":"96f32ea6c3265a3889e6abe57587f6e2a2a40dfb","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"8a2421cb9005352905fae9d41a847ae56957247e","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"6c00f6e0978f4d8f9a846a15579963728aaa6a17","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"25dc25f61a232f03ca72472b7852f882448ec185","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"4eff5b252d7b614e500fc7d52c97ce325e57d3ab","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"2039590632bba3943c39319d80ef630af7928185","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"9bf4362a4d0ae151ada84b219d39fbe5bb8c790e","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-button.styl","hash":"e72a89e0f421444453e149ba32c77a64bd8e44e8","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"b76387934fb6bb75212b23c1a194486892cc495e","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"f5aa2ba3bfffc15475e7e72a55b5c9d18609fdf5","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"a82afbb72d83ee394aedc7b37ac0008a9823b4f4","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/my-post-copyright.styl","hash":"1a510f995e665b28d85ba4d169b824276c40e4f3","modified":1555947304373},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"f54367c0feda6986c030cc4d15a0ca6ceea14bcb","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"2cdc094ecf907a02fce25ad4a607cd5c40da0f2b","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"0f7f522cc6bfb3401d5afd62b0fcdf48bb2d604b","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"387ce23bba52b22a586b2dfb4ec618fe1ffd3926","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"535b3b4f8cb1eec2558e094320e7dfb01f94c0e7","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"017074ef58166e2d69c53bb7590a0e7a8947a1ed","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"36332c8a91f089f545f3c3e8ea90d08aa4d6e60c","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"a352ae5b1f8857393bf770d2e638bf15f0c9585d","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"aea21141015ca8c409d8b33e3e34ec505f464e93","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"a5d8617a24d7cb6c5ad91ea621183ca2c0917331","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"10251257aceecb117233c9554dcf8ecfef8e2104","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"d5a4e4fc17f1f7e7c3a61b52d8e2e9677e139de7","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"e4055a0d2cd2b0ad9dc55928e2f3e7bd4e499da3","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/exturl.styl","hash":"1b3cc9f4e5a7f6e05b4100e9990b37b20d4a2005","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/label.styl","hash":"4a457d265d62f287c63d48764ce45d9bcfc9ec5a","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"060c2602297128540d91c45f0bd307aa4a5f73e9","modified":1555946740712},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"c2abe4d87148e23e15d49ee225bc650de60baf46","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"4851b981020c5cbc354a1af9b831a2dcb3cf9d39","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"ead0d0f2321dc71505788c7f689f92257cf14947","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"37e951e734a252fe8a81f452b963df2ba90bfe90","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"0a6c0efffdf18bddbc1d1238feaed282b09cd0fe","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"89dd4f8b1f1cce3ad46cf2256038472712387d02","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/note-modern.styl","hash":"ee7528900578ef4753effe05b346381c40de5499","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/note.styl","hash":"32c9156bea5bac9e9ad0b4c08ffbca8b3d9aac4b","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-dimmer.styl","hash":"efa5e5022e205b52786ce495d4879f5e7b8f84b2","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/tabs.styl","hash":"4ab5deed8c3b0c338212380f678f8382672e1bcb","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"9486ddd2cb255227db102d09a7df4cae0fabad72","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"f5e8fa6f6e632a2f87f09cf1a0bf069725be750b","modified":1555936921771},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"45fa7193435a8eae9960267438750b4c9fa9587f","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"12937cae17c96c74d5c58db6cb29de3b2dfa14a2","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"f7784aba0c1cd20d824c918c120012d57a5eaa2a","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"50305b6ad7d09d2ffa4854e39f41ec1f4fe984fd","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"3623e7fa4324ec1307370f33d8f287a9e20a5578","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/algolia-search.styl","hash":"fd42777b9125fd8969dc39d4f15473e2b91b4142","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"93b08815c4d17e2b96fef8530ec1f1064dede6ef","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/gitment.styl","hash":"34935b40237c074be5f5e8818c14ccfd802b7439","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/han.styl","hash":"cce6772e2cdb4db85d35486ae4c6c59367fbdd40","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"327b5f63d55ec26f7663185c1a778440588d9803","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"d4e6d8d7b34dc69994593c208f875ae8f7e8a3ae","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/needsharebutton.styl","hash":"a5e3e6b4b4b814a9fe40b34d784fed67d6d977fa","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/duoshuo.styl","hash":"2340dd9b3202c61d73cc708b790fac5adddbfc7f","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"1ccfbd4d0f5754b2dc2719a91245c95f547a7652","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"d89c4b562b528e4746696b2ad8935764d133bdae","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"5dc4859c66305f871e56cba78f64bfe3bf1b5f01","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1562723191351},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","hash":"07436f011b44051f61b8329c99de4bec64e86f4b","modified":1562723191300},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","hash":"7a635062b10bf5662ae1d218ba0980171005d060","modified":1562723191301},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","hash":"f1f6bb8f461f5672e000380195d3d2358a28494c","modified":1562723191303},{"_id":"themes/next/source/lib/Han/dist/font/han.woff2","hash":"623af3ed5423371ac136a4fe0e8cc7bb7396037a","modified":1562723191307},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","hash":"f38ff9b2eecaa17b50b66aa2dae87e9e7436d195","modified":1562723191305},{"_id":"themes/next/source/lib/Han/dist/han.js","hash":"e345397e0585c9fed1449e614ec13e0224acf2ab","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/han.min.css","hash":"a0c9e32549a8b8cf327ab9227b037f323cdb60ee","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1562723191416},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1514748788000},{"_id":"source/_posts/ELK快速入门(一)-基本部署/elk11.png","hash":"9f2a3dfd04a136114aad50db4eb8e224e3d771b5","modified":1562723189964},{"_id":"themes/next/source/js/src/av-min.js","hash":"6097275a370ccb57eefb0e1949d3958fc0369983","modified":1557752242566},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1562723191403},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1562723191408},{"_id":"themes/next/source/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1562723191414},{"_id":"source/_posts/phpMyAdmin搭建/6.png","hash":"e5f1230ee77aeba32f983d3878be427212022f48","modified":1562723190054},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","hash":"9ccc6f8144f54e86df9a3fd33a18368d81cf3a4f","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1514748788000},{"_id":"themes/next/source/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1514748788000},{"_id":"public/atom.xml","hash":"a19ef3679794203a648c9ee5905ba67f68a46792","modified":1571908827390},{"_id":"public/search.xml","hash":"c5f8b40819b50a65d96859cf2fbf40bddb300100","modified":1571908827391},{"_id":"public/categories/index.html","hash":"bd6dd46cfed1fc79906f889da04500df2db801e7","modified":1571908827849},{"_id":"public/photos/index.html","hash":"17b2a14c0c2ae01b5cbe3e651043ea0e91225147","modified":1571908827849},{"_id":"public/tags/index.html","hash":"50c8774d709cb8ecf887f316b1f08d2c4033e1ec","modified":1571908827852},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/index.html","hash":"a6f1bad4ef8226629a9407362e59324d12cd9252","modified":1565344949303},{"_id":"public/2019/06/27/Tomcat+Nginx+Memcached综合案例/index.html","hash":"ad37545d16f3bbf9aeb271773fa92215ec05807b","modified":1571908827852},{"_id":"public/2019/06/26/Tomcat安装与部署/index.html","hash":"62d9758015b0f506024f0bdd187b47a4c5dd56f1","modified":1571908827853},{"_id":"public/2019/06/12/Cobbler自动化部署/index.html","hash":"3534a0cfc07c3bba5f731765f480a33b787886ea","modified":1571908827853},{"_id":"public/2019/06/05/Ansible项目实战lnmp/index.html","hash":"40f2386f2533c73b8e9a45b5256c3dd8ae910ba4","modified":1571908827853},{"_id":"public/2019/06/03/Ansible之Roles/index.html","hash":"4f4ae04afbf6f8b2d4a3f8b8bcb240aad7a7aec2","modified":1571908827853},{"_id":"public/2019/05/29/Ansible之Playbook/index.html","hash":"50a126ee6169026eaad9895ea4265aa527116fa4","modified":1571908827853},{"_id":"public/2019/05/27/Ansible Ad-hoc常用Module/index.html","hash":"a39ab267407f88d2019c6b5ae9ddd2a447aba9e2","modified":1571908827853},{"_id":"public/2019/05/26/Ansible快速入门/index.html","hash":"25390352bb5ca426813eba1a1c4396c028909120","modified":1571908827853},{"_id":"public/2019/05/22/linux保存history到日志文件/index.html","hash":"6951e1d349a5a7f11fcaad3c1863a827589ffb14","modified":1571908827853},{"_id":"public/2019/05/21/saltstack项目实战/index.html","hash":"89f080c779b80b5cd88b617e494d377bb474c34c","modified":1571908827854},{"_id":"public/2019/05/20/saltstack接口salt-api/index.html","hash":"02c41e31dba9c0fd586b416f1b5f86b234b26097","modified":1571908827854},{"_id":"public/2019/05/20/saltstack使用salt-ssh/index.html","hash":"04ac641d4b563767b39295d9e80c0fa2cc74d96b","modified":1571908827854},{"_id":"public/2019/05/17/saltstack数据系统/index.html","hash":"e35c6cef69b74fb7d47b2877f56eb33f38cb908f","modified":1571908827854},{"_id":"public/2019/05/17/saltstack状态判断unless与onlyif/index.html","hash":"94296949356efacbab0da8ae991dbbab3b849107","modified":1571908827854},{"_id":"public/2019/05/15/saltstack配置管理/index.html","hash":"b6251815707e7bee27b59a83fa176631aff2e4b2","modified":1571908827855},{"_id":"public/2019/05/14/saltstack远程执行/index.html","hash":"5c6ffd73792b24338f8c87a2c4d89f687bedcc3a","modified":1571908827855},{"_id":"public/2019/05/13/saltstack基本入门/index.html","hash":"d93cee281358e9d3d4a6ec380dcec8dcc0540f17","modified":1571908827855},{"_id":"public/2019/04/30/linux下解压windows上压缩rar包/index.html","hash":"837e179f0d659af26d134a26829bc07a3001eeed","modified":1571908827855},{"_id":"public/2019/04/26/phpRedisAdmin搭建/index.html","hash":"ea537d537fb55534689ae2f309773cda6508e247","modified":1571908827855},{"_id":"public/2019/04/26/phpMyAdmin搭建/index.html","hash":"e1604117c9f4f1a4496f01bc0f262bae5d2e6f77","modified":1571908827855},{"_id":"public/2019/04/24/MySQL自动备份脚本/index.html","hash":"089139994b5c8d01afe98317c234a808e96c700a","modified":1571908827855},{"_id":"public/2019/04/23/ftp虚拟用户/index.html","hash":"98475357dac2a66772d4e07c6dfac06f26510c0b","modified":1571908827855},{"_id":"public/archives/index.html","hash":"f09ea3d48feb89f465e291f5460469eb1443af7e","modified":1571908827855},{"_id":"public/archives/page/2/index.html","hash":"f20ff67dee34abff1e1f3539d16e027c49ba93e5","modified":1571908827856},{"_id":"public/archives/page/3/index.html","hash":"4aa4f6bf21086a1cf34c80da453f6947738d9872","modified":1571908827856},{"_id":"public/archives/2019/index.html","hash":"2a994b22592a732634d076a6dfed3cc52d3765be","modified":1571908827856},{"_id":"public/archives/2019/page/2/index.html","hash":"a10e21843989a32a5f027a38cb7c397297c2a39c","modified":1571908827856},{"_id":"public/archives/2019/page/3/index.html","hash":"31c4fcf0ae45b7679917984d4d93a418dc219240","modified":1571908827856},{"_id":"public/archives/2019/04/index.html","hash":"dff08b0057d4350dc22898c6cf153006eaec04f9","modified":1571908827856},{"_id":"public/archives/2019/05/index.html","hash":"703f2282209ac8d4fc433914cb8387b4215cf6ba","modified":1571908827856},{"_id":"public/archives/2019/05/page/2/index.html","hash":"4547e13686b288213869de1a41ca2c6db06863b7","modified":1571908827856},{"_id":"public/archives/2019/06/index.html","hash":"9b77cd7ee77839e7b0d4887f6ae3ee0cdb80fecc","modified":1571908827856},{"_id":"public/archives/2019/07/index.html","hash":"421a14af2b85179abe87dcb363c19f330caafa9f","modified":1571908827856},{"_id":"public/categories/Shell/index.html","hash":"4157e35bb67a41c1eb1cb51c2d47c5912b538cfd","modified":1571908827857},{"_id":"public/categories/Linux/index.html","hash":"8e1944e499e75d5b33a9571a977127fb3d365d79","modified":1571908827857},{"_id":"public/categories/Linux运维日常/index.html","hash":"30e44d4fcfeb30ca51ad6b792b3de142555fe569","modified":1571908827857},{"_id":"public/categories/Saltstack/index.html","hash":"f97013909c240e72b3db5a87bab02dd5b000ad74","modified":1571908827857},{"_id":"public/categories/Ansible/index.html","hash":"5b46888964fae2568de820638e9834ddaaf7fabb","modified":1571908827857},{"_id":"public/categories/Tomcat/index.html","hash":"11420b0395b1a81574be5cf7ebc1d88071e8be95","modified":1571908827857},{"_id":"public/categories/ELK/index.html","hash":"a51aced663928ae9b5a9f24ef18f6a8cd28166b7","modified":1571908827857},{"_id":"public/categories/Cobbler/index.html","hash":"47ed79983d4e52de8b97827ec9ea38e9a26438e3","modified":1571908827857},{"_id":"public/index.html","hash":"5222f3d55bd6b5e818b1da2f2556de239929174b","modified":1571908827857},{"_id":"public/page/2/index.html","hash":"6889d33298a75102528fbdcfb0f9131cfe01f279","modified":1571908827857},{"_id":"public/page/3/index.html","hash":"3c850118ad168a7ea6cf302fa1c4757e71752109","modified":1571908827857},{"_id":"public/tags/Linux运维日常/index.html","hash":"d3b5f6de8f042a962dc9c48ed9987d2e6c0ce1d0","modified":1571908827858},{"_id":"public/tags/Saltstack/index.html","hash":"997c442d7d8a1adff660b63168720061b3a40b96","modified":1571908827858},{"_id":"public/tags/Ansible/index.html","hash":"2c5c8c12c2eff36c61873ee9c31d56875116cf16","modified":1571908827858},{"_id":"public/tags/Tomcat/index.html","hash":"9a7d79eeeba0aff669a7706f979d6710861e6558","modified":1571908827858},{"_id":"public/tags/ELK/index.html","hash":"380c724a69fd0f07213586ee802df3330746ee1d","modified":1571908827858},{"_id":"public/tags/Cobbler/index.html","hash":"c7e021864a3f77860d2631555126dd5c45ffda9a","modified":1571908827858},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1562724386498},{"_id":"public/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1571908375380},{"_id":"public/images/avatar.png","hash":"75dbfd5a1d3a64eb4fdd4dcc30127b243cead72c","modified":1562724386498},{"_id":"public/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1571908374946},{"_id":"public/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1571908374946},{"_id":"public/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1571908374946},{"_id":"public/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1571908375384},{"_id":"public/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1571908374946},{"_id":"public/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1562724386498},{"_id":"public/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1562724386498},{"_id":"public/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1571908374947},{"_id":"public/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1571908374947},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1562724386499},{"_id":"public/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1562724386499},{"_id":"public/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1571908374947},{"_id":"public/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1571908374947},{"_id":"public/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1571908374947},{"_id":"public/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1562724386499},{"_id":"public/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1571908374947},{"_id":"public/lib/fastclick/LICENSE","hash":"dcd5b6b43095d9e90353a28b09cb269de8d4838e","modified":1571908374947},{"_id":"public/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1562724386499},{"_id":"public/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1562724386500},{"_id":"public/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1562724386500},{"_id":"public/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1562724386500},{"_id":"public/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1562724386500},{"_id":"public/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1562724386500},{"_id":"public/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1571908374947},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1562724386501},{"_id":"public/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1562724386501},{"_id":"public/lib/Han/dist/font/han-space.otf","hash":"07436f011b44051f61b8329c99de4bec64e86f4b","modified":1562724386501},{"_id":"public/lib/Han/dist/font/han-space.woff","hash":"7a635062b10bf5662ae1d218ba0980171005d060","modified":1562724386501},{"_id":"public/lib/Han/dist/font/han.otf","hash":"f1f6bb8f461f5672e000380195d3d2358a28494c","modified":1562724386501},{"_id":"public/lib/Han/dist/font/han.woff2","hash":"623af3ed5423371ac136a4fe0e8cc7bb7396037a","modified":1562724386501},{"_id":"public/lib/Han/dist/font/han.woff","hash":"f38ff9b2eecaa17b50b66aa2dae87e9e7436d195","modified":1562724386501},{"_id":"public/2019/06/03/Ansible之Roles/rolesdir.png","hash":"19ef4e21ac4c65dc5ef22f755417e0cfc8087dfe","modified":1562724386501},{"_id":"public/2019/05/17/saltstack状态判断unless与onlyif/01.png","hash":"898bad3ebe967c968e96d72b6cfba5d7ea407f4a","modified":1562724386501},{"_id":"public/2019/05/26/Ansible快速入门/ansible01.png","hash":"e4182ab79097348cb4096d8cacce3b6d4672d241","modified":1562724386502},{"_id":"public/2019/05/14/saltstack远程执行/03.png","hash":"54fff484d84f5d5f95e9a2679209fa66d882ac54","modified":1562724386502},{"_id":"public/2019/05/14/saltstack远程执行/02.png","hash":"b48ef022820ebe417aec28127e4aca5418d259bc","modified":1562724386502},{"_id":"public/2019/05/14/saltstack远程执行/01.png","hash":"4a1242e6982b7e6162816a1fe2f73b986cd78952","modified":1562724386502},{"_id":"public/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat1.png","hash":"4c08727e323c70ec90af6ad8aa4c22ee2915e114","modified":1562724386502},{"_id":"public/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat2.png","hash":"c1d2c9e6bc0cc17508f4237eb8909f4f7ee82148","modified":1562724386502},{"_id":"public/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat3.png","hash":"df7906d842b2d826430b7ac5893febd8b275e4ae","modified":1562724386502},{"_id":"public/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat4.png","hash":"36b6a4a48edb29efc7c4363be55ef505b707eddb","modified":1562724386502},{"_id":"public/2019/05/15/saltstack配置管理/01.png","hash":"5477e294cae7f6f4853ef95c99e62dde2ffd5464","modified":1562724386502},{"_id":"public/2019/05/13/saltstack基本入门/02.png","hash":"585647e926ce0ad2694873ac58cb96f3be273618","modified":1562724386502},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk02.png","hash":"a150dafb1e65bdb535327db300468023f25c2896","modified":1562724386502},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk01.png","hash":"c70144da14842696315b42c43f3ad0f5eb01c771","modified":1562724386502},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk03.png","hash":"8d4ee8baa4cfcf17e61dd0d00f9a4a893e548f13","modified":1562724386502},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk04.png","hash":"35ba8275b4cc7641300e716eae5c7f46274c597f","modified":1562724386502},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk07.png","hash":"b51f9ec453b78eb65d4a6a71b7205bd75ba3ff15","modified":1562724386502},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk08.png","hash":"9a1656d13d4a9406f6b44b18a0394fe0d599583a","modified":1562724386502},{"_id":"public/2019/05/29/Ansible之Playbook/shili01.png","hash":"4f216827edf551fe8755e3b4c790c24ac4e52505","modified":1562724386502},{"_id":"public/2019/05/29/Ansible之Playbook/shili02.png","hash":"3d127d14ef9c1da568f348e861ccbcbce5ca5118","modified":1562724386503},{"_id":"public/2019/05/29/Ansible之Playbook/shili03.png","hash":"42b05c85e59394f5a874eaca576e957a8e2ca644","modified":1562724386503},{"_id":"public/2019/05/21/saltstack项目实战/01.png","hash":"d57188079384d29207f342306ef0124192e81e84","modified":1562724386503},{"_id":"public/2019/05/21/saltstack项目实战/02.png","hash":"7b18158dc717b1486fce6bd06c5adb19e82c7218","modified":1562724386503},{"_id":"public/2019/06/12/Cobbler自动化部署/cobbler01.png","hash":"46d7b822d6ca0f08def6f6091cef733469bf2811","modified":1562724386503},{"_id":"public/2019/06/12/Cobbler自动化部署/cobbler02.png","hash":"edba58d13a438890a866f45a683f24f2a4a2320b","modified":1562724386503},{"_id":"public/2019/06/12/Cobbler自动化部署/cobbler03.png","hash":"b58a92a889b217989c2d2d8c51c31f01eb7777f6","modified":1562724386503},{"_id":"public/2019/06/12/Cobbler自动化部署/cobbler04.png","hash":"759e8d0ca872cea3a4172edaa1df5af3dd9a04b2","modified":1562724386503},{"_id":"public/2019/06/12/Cobbler自动化部署/cobbler05.png","hash":"d941c6997785c4a996b932e82bc392f0e7245bc1","modified":1562724386503},{"_id":"public/2019/06/12/Cobbler自动化部署/cobbler06.png","hash":"87e3f4627af2b3ca59d4b66e8788d4fe4dfbfc7b","modified":1562724386503},{"_id":"public/2019/06/12/Cobbler自动化部署/cobbler07.png","hash":"6296622ee58f2867dd122565e5a9ffa8c18d4c71","modified":1562724386503},{"_id":"public/2019/06/12/Cobbler自动化部署/cobbler08.png","hash":"4d11fa24a18f5f08c260b1c8a4a11f6c4be62afc","modified":1562724386503},{"_id":"public/2019/06/12/Cobbler自动化部署/cobbler09.png","hash":"7a5dd05b41eb020a9f100bae7ba27d578185da68","modified":1562724386503},{"_id":"public/2019/06/26/Tomcat安装与部署/tomcat07.png","hash":"a3d2c47acb386263580de47bd930f58538d09936","modified":1562724386503},{"_id":"public/2019/06/26/Tomcat安装与部署/tomcat08.png","hash":"9c7b5c173fe702df224ccfd717b0b9c01a16c28c","modified":1562724386503},{"_id":"public/2019/06/26/Tomcat安装与部署/tomcat09.png","hash":"c15a91d5f18f4637802fa1f8e2ef804f0c910020","modified":1562724386503},{"_id":"public/images/avatar3.png","hash":"5b475bcde35a71d593059d4ca27d4c005bdfa180","modified":1562724387192},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1562724387197},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1562724387197},{"_id":"public/2019/06/05/Ansible项目实战lnmp/01.png","hash":"eb4c76655fd0023a11dd419c97c10b926d63808b","modified":1562724387198},{"_id":"public/2019/05/13/saltstack基本入门/01.png","hash":"f99529f78ab049a94edd5ebfe07f1d778f1b4fbe","modified":1562724387198},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk05.png","hash":"9933382fd35c9ac4738910889a90c3533070ced3","modified":1562724387198},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk06.png","hash":"0d4381e03459395fbba3feb4e0a041d87e6b8c50","modified":1562724387198},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk09.png","hash":"e64769568a4a319718a80cab8a935e30b1142d2c","modified":1562724387198},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk10.png","hash":"89c2ba24da18785487fd3564f1f266d82c9508e9","modified":1562724387198},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk12.png","hash":"be759c34d6894996320edcea86c2e8a8934da552","modified":1562724387198},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk13.png","hash":"2e5db86fb4a64b36c9481980ab805ad687f52ed2","modified":1562724387198},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk14.png","hash":"bb213a559bf9ed568f6505e2ed975d40e7f5da08","modified":1562724387198},{"_id":"public/2019/05/21/saltstack项目实战/05.png","hash":"067e380e55a87c7c315435995b51595e0f89fd62","modified":1562724387198},{"_id":"public/2019/05/21/saltstack项目实战/06.png","hash":"880626056397aad0e5869f0ab0ff24d87852ad28","modified":1562724387199},{"_id":"public/2019/05/21/saltstack项目实战/07.png","hash":"5893686789a705730765ac77de80f72084d6f385","modified":1562724387199},{"_id":"public/2019/06/26/Tomcat安装与部署/tomcat02.png","hash":"ad15a810bd06f98a285de89e17ce84d9a7e932f8","modified":1562724387199},{"_id":"public/2019/06/26/Tomcat安装与部署/tomcat03.png","hash":"30d0e1baec42f786f6b9aa1d08d34154bc5a2d1e","modified":1562724387199},{"_id":"public/2019/06/26/Tomcat安装与部署/tomcat04.png","hash":"0bfc60aa9b4620d04ea2ae4e0a27b32ddc9a8499","modified":1562724387199},{"_id":"public/2019/06/26/Tomcat安装与部署/tomcat05.png","hash":"8a2aa2a85c256d94cedb1fc32ff5daa099847f1a","modified":1562724387199},{"_id":"public/lib/canvas-ribbon/canvas-ribbon.js","hash":"ff5915eb2596e890a2fc6697c864f861a1995ec0","modified":1562724387238},{"_id":"public/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1562724387239},{"_id":"public/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1562724387243},{"_id":"public/lib/font-awesome/bower.json","hash":"64394a2a9aa00f8e321d8daa5e51a420f0e96dad","modified":1562724387244},{"_id":"public/lib/fastclick/bower.json","hash":"4dcecf83afddba148464d5339c93f6d0aa9f42e9","modified":1562724387244},{"_id":"public/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1562724387244},{"_id":"public/lib/jquery_lazyload/bower.json","hash":"ae3c3b61e6e7f9e1d7e3585ad854380ecc04cf53","modified":1562724387245},{"_id":"public/lib/needsharebutton/needsharebutton.css","hash":"3ef0020a1815ca6151ea4886cd0d37421ae3695c","modified":1562724387246},{"_id":"public/lib/velocity/bower.json","hash":"0ef14e7ccdfba5db6eb3f8fc6aa3b47282c36409","modified":1562724387246},{"_id":"public/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1562724387247},{"_id":"public/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1562724387247},{"_id":"public/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1562724387247},{"_id":"public/js/src/bootstrap.js","hash":"034bc8113e0966fe2096ba5b56061bbf10ef0512","modified":1562724387247},{"_id":"public/js/src/js.cookie.js","hash":"9b37973a90fd50e71ea91682265715e45ae82c75","modified":1562724387247},{"_id":"public/js/src/post-details.js","hash":"a13f45f7aa8291cf7244ec5ba93907d119c5dbdd","modified":1562724387247},{"_id":"public/js/src/scroll-cookie.js","hash":"09dc828cbf5f31158ff6250d2bf7c3cde6365c67","modified":1562724387247},{"_id":"public/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1562724387247},{"_id":"public/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1562724387247},{"_id":"public/lib/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1562724387247},{"_id":"public/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1562724387247},{"_id":"public/js/src/schemes/pisces.js","hash":"8050a5b2683d1d77238c5762b6bd89c543daed6e","modified":1562724387247},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1562724387247},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1562724387247},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1562724387247},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1562724387247},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1562724387248},{"_id":"public/lib/fastclick/README.html","hash":"da3c74d484c73cc7df565e8abbfa4d6a5a18d4da","modified":1562724387248},{"_id":"public/lib/jquery_lazyload/README.html","hash":"bde24335f6bc09d8801c0dcd7274f71b466552bd","modified":1562724387248},{"_id":"public/lib/jquery_lazyload/CONTRIBUTING.html","hash":"a6358170d346af13b1452ac157b60505bec7015c","modified":1562724387248},{"_id":"public/css/main.css","hash":"b8991910a8ef5f70e40892bdc7e8a78070a102f0","modified":1571908375393},{"_id":"public/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1562724387248},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1562724387248},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1562724387248},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk15.png","hash":"f58d1600e2ee3d4ae0741c2bf72175ccb440001e","modified":1562724387248},{"_id":"public/2019/04/26/phpMyAdmin搭建/4.png","hash":"19c4b342d5c4a2d29e98611d7ddf4f2a9610d604","modified":1562724387248},{"_id":"public/2019/06/26/Tomcat安装与部署/tomcat01.png","hash":"9ff9946bda56211c372d5452632150f7325bf27b","modified":1562724387248},{"_id":"public/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1562724387264},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"d49abca8562d79c89ac7d323021f405d80721127","modified":1562724387264},{"_id":"public/js/src/utils.js","hash":"9b1325801d27213083d1487a12b1a62b539ab6f8","modified":1562724387265},{"_id":"public/js/src/motion.js","hash":"754b294394f102c8fd9423a1789ddb1201677898","modified":1562724387265},{"_id":"public/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1562724387265},{"_id":"public/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1562724387265},{"_id":"public/2019/05/26/Ansible快速入门/ansible02.png","hash":"b7f4d78494b2a113e0181a55c04570a292eafe2a","modified":1562724387265},{"_id":"public/lib/needsharebutton/needsharebutton.js","hash":"9885fd9bea5e7ebafc5b1de9d17be5e106248d96","modified":1562724387316},{"_id":"public/lib/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1562724387316},{"_id":"public/2019/07/05/ELK快速入门(一)-基本部署/elk11.png","hash":"9f2a3dfd04a136114aad50db4eb8e224e3d771b5","modified":1562724387316},{"_id":"public/2019/05/21/saltstack项目实战/04.png","hash":"44e810310977ed2c02157d38ee5c3fb92e9c66e1","modified":1562724387316},{"_id":"public/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1562724387363},{"_id":"public/lib/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1562724387364},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1562724387415},{"_id":"public/lib/velocity/velocity.ui.js","hash":"b4e960835d8700839e458e2cf7a3d7aed5b249ee","modified":1562724387415},{"_id":"public/lib/three/canvas_lines.min.js","hash":"dce4a3b65f8bf958f973690caa7ec4952f353b0c","modified":1562724387416},{"_id":"public/lib/three/canvas_sphere.min.js","hash":"d8ea241a53c135a650f7335d2b6982b899fd58a9","modified":1562724387416},{"_id":"public/lib/three/three-waves.min.js","hash":"d968cba6b3a50b3626a02d67b544f349d83b147c","modified":1562724387416},{"_id":"public/lib/Han/dist/han.min.js","hash":"f559c68a25065a14f47da954a7617d87263e409d","modified":1562724387417},{"_id":"public/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1562724387417},{"_id":"public/2019/06/26/Tomcat安装与部署/tomcat06.png","hash":"49db5f9104c59d6f509e2a90303123d477a0b76f","modified":1562724387417},{"_id":"public/lib/needsharebutton/font-embedded.css","hash":"c39d37278c1e178838732af21bd26cd0baeddfe0","modified":1562724387501},{"_id":"public/lib/Han/dist/han.min.css","hash":"a0c9e32549a8b8cf327ab9227b037f323cdb60ee","modified":1562724387501},{"_id":"public/2019/05/21/saltstack项目实战/03.png","hash":"de3252e2c048eeca52ba2a940631ba824cbbf3ad","modified":1562724387502},{"_id":"public/lib/Han/dist/han.css","hash":"bd40da3fba8735df5850956814e312bd7b3193d7","modified":1562724387519},{"_id":"public/lib/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1562724387519},{"_id":"public/js/src/Valine.min.js","hash":"f3f7072297784338bc8dd8876df280355820fbf5","modified":1562724387563},{"_id":"public/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1562724387589},{"_id":"public/lib/Han/dist/han.js","hash":"e345397e0585c9fed1449e614ec13e0224acf2ab","modified":1562724387589},{"_id":"public/2019/04/26/phpMyAdmin搭建/6.png","hash":"e5f1230ee77aeba32f983d3878be427212022f48","modified":1562724387589},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1571908375412},{"_id":"public/js/src/av-min.js","hash":"6097275a370ccb57eefb0e1949d3958fc0369983","modified":1562724387617},{"_id":"public/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1562724387623},{"_id":"public/lib/algolia-instant-search/instantsearch.min.js","hash":"9ccc6f8144f54e86df9a3fd33a18368d81cf3a4f","modified":1562724387642},{"_id":"public/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1562724387646},{"_id":"source/_posts/ELK快速入门五-配置nginx代理kibana.md","hash":"d252fd20b5003fe6cddb4a8443b1af130c9a26ee","modified":1571908336884},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志.md","hash":"c3d0368e6cd385ca303db92ccccb91516d40a445","modified":1571908336862},{"_id":"source/_posts/ELK快速入门一-基本部署.md","hash":"26a09647103210885c5a678981ebad23b99d2924","modified":1571908336845},{"_id":"source/_posts/ELK快速入门四-filebeat替代logstash收集日志.md","hash":"4c2328bb89aab6b8ddb822eb385a14ab757e8730","modified":1571908336885},{"_id":"source/_posts/存储服务之NFS.md","hash":"0ac0a2746d5f472920668dbd458d7bd7e9a88b86","modified":1571908336897},{"_id":"source/_posts/ELK快速入门三-logstash收集日志写入redis.md","hash":"4a0cb275e5928bed0903ae8372e25b5b1224f67e","modified":1571908336857},{"_id":"source/_posts/PHP配合inotify实现光闸ftp功能.md","hash":"765d7929545929017d0a13c9d689427b07f2d519","modified":1571908336888},{"_id":"source/_posts/ELK快速入门一-基本部署/elk01.png","hash":"c70144da14842696315b42c43f3ad0f5eb01c771","modified":1562723189939},{"_id":"source/_posts/ELK快速入门一-基本部署/elk02.png","hash":"a150dafb1e65bdb535327db300468023f25c2896","modified":1562723189941},{"_id":"source/_posts/ELK快速入门一-基本部署/elk03.png","hash":"8d4ee8baa4cfcf17e61dd0d00f9a4a893e548f13","modified":1562723189943},{"_id":"source/_posts/ELK快速入门一-基本部署/elk04.png","hash":"35ba8275b4cc7641300e716eae5c7f46274c597f","modified":1562723189946},{"_id":"source/_posts/ELK快速入门一-基本部署/elk05.png","hash":"9933382fd35c9ac4738910889a90c3533070ced3","modified":1562723189948},{"_id":"source/_posts/ELK快速入门一-基本部署/elk07.png","hash":"b51f9ec453b78eb65d4a6a71b7205bd75ba3ff15","modified":1562723189953},{"_id":"source/_posts/ELK快速入门一-基本部署/elk08.png","hash":"9a1656d13d4a9406f6b44b18a0394fe0d599583a","modified":1562723189955},{"_id":"source/_posts/ELK快速入门一-基本部署/elk10.png","hash":"89c2ba24da18785487fd3564f1f266d82c9508e9","modified":1562723189961},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log06.png","hash":"98a403efd4f8f3a978ae7b52859b7071aeae6178","modified":1562316168355},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log16.png","hash":"e508f612e6f07e02f96378fcdeb20570a28ae399","modified":1562642508282},{"_id":"source/_posts/ELK快速入门五-配置nginx代理kibana/nginx01.png","hash":"04b624329facea3ebda8c3551ea641e2f1a69323","modified":1562838278970},{"_id":"source/_posts/存储服务之NFS/02.png","hash":"23e338fba58dcd5d9e2e82689b9ba304ac946714","modified":1565255829921},{"_id":"source/_posts/存储服务之NFS/01.png","hash":"7afd3459bb1d4de4ed77bbf3aa3aa91342db6d80","modified":1565343922876},{"_id":"source/_posts/存储服务之NFS/03.png","hash":"5597d069e3031cc85b4860c65be105bb33fadfb1","modified":1565314212108},{"_id":"source/_posts/PHP配合inotify实现光闸ftp功能/01.png","hash":"dafee52b95d3cd3725baa0c8cf68461f412839d1","modified":1565065186437},{"_id":"source/_posts/ELK快速入门一-基本部署/elk06.png","hash":"0d4381e03459395fbba3feb4e0a041d87e6b8c50","modified":1562723189951},{"_id":"source/_posts/ELK快速入门一-基本部署/elk09.png","hash":"e64769568a4a319718a80cab8a935e30b1142d2c","modified":1562723189958},{"_id":"source/_posts/ELK快速入门一-基本部署/elk12.png","hash":"be759c34d6894996320edcea86c2e8a8934da552","modified":1562723189966},{"_id":"source/_posts/ELK快速入门一-基本部署/elk13.png","hash":"2e5db86fb4a64b36c9481980ab805ad687f52ed2","modified":1562723189969},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log01.png","hash":"31cc11ac58042c6d329f031147fb0c0b9b8467d0","modified":1562309841239},{"_id":"source/_posts/ELK快速入门一-基本部署/elk14.png","hash":"bb213a559bf9ed568f6505e2ed975d40e7f5da08","modified":1562723189972},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log03.png","hash":"89fe856ce5248e4fbb415195660c626c8d9f4bfa","modified":1562310122625},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log02.png","hash":"439fbcd811c595553de5935741fe03e69c58a83b","modified":1562309906594},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log07.png","hash":"7a96a22b852008c7b9fbcfedbaaaaf69f1aea725","modified":1562318885651},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log04.png","hash":"79f10f23be7acc134ed72ddb1ab830da79b1b3b2","modified":1562310161433},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log09.png","hash":"ae2156a55d07638de57e82f742a9ec4408112a9e","modified":1562556783980},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log10.png","hash":"ed37fbd8858ead0833696ca412e1f1afbbfb552b","modified":1562556829881},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log13.png","hash":"83353120c0793e9bb6f191af09f32140d6d3ebd5","modified":1562574225616},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log14.png","hash":"f5bb2b7a29fa91f6f41aa8fff8f9ff9e43093463","modified":1562574258205},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log17.png","hash":"0e4a40365f424e287967d96582a268b64eab2a5e","modified":1562644836662},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log20.png","hash":"09e0a1d271f2218d93179f4b74940802f7593457","modified":1562722376728},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log18.png","hash":"ff92567a87d04d075fb2ac01eed96d9cc8a9e43a","modified":1562644860205},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log21.png","hash":"8931a21f49a64954684542f7cd76ad626b59c108","modified":1562722396704},{"_id":"source/_posts/ELK快速入门三-logstash收集日志写入redis/redis01.png","hash":"c3e5f7399698670a939b03c521d4a0d99a8f7e14","modified":1562748553363},{"_id":"source/_posts/ELK快速入门五-配置nginx代理kibana/nginx02.png","hash":"82476959b8751377ead50da4c4b08ad72f9a3af7","modified":1562838307390},{"_id":"source/_posts/ELK快速入门三-logstash收集日志写入redis/redis03.png","hash":"a92b6c0ed970966a1dbd891825b7556e49b2d43a","modified":1562750131374},{"_id":"source/_posts/ELK快速入门三-logstash收集日志写入redis/redis02.png","hash":"a703763394990af9db17768ebb9a42b8d43d80d9","modified":1562750101760},{"_id":"source/_posts/ELK快速入门四-filebeat替代logstash收集日志/file03.png","hash":"20473fd7a7ab75b4fc9edc95d7a7045be8a29af3","modified":1562831917340},{"_id":"source/_posts/存储服务之NFS/04.png","hash":"009be59d359b4aad9becd9cc46f87fdf512105e3","modified":1565344048878},{"_id":"source/_posts/ELK快速入门四-filebeat替代logstash收集日志/file02.png","hash":"7d070ae3bd43f9933ee545e1e9cd9e5f727393be","modified":1562831592669},{"_id":"source/_posts/ELK快速入门四-filebeat替代logstash收集日志/file01.png","hash":"3810efabfc5a594eb481848eaa9c544eeb52da6d","modified":1562831565318},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log12.png","hash":"e1b67845358e231f2622de473a77bb9bd620daf8","modified":1562574090235},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log05.png","hash":"9286c9e9d642dc1688087c5d5ea4ccaca938f73f","modified":1562312390404},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log19.png","hash":"f354a4a1065299c3a3a5ae57afa77a8d37e669c0","modified":1562646372714},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log15.png","hash":"fcda2ad71cad4cc83b1f38a75778c2504fddd505","modified":1562574549666},{"_id":"source/_posts/ELK快速入门一-基本部署/elk15.png","hash":"f58d1600e2ee3d4ae0741c2bf72175ccb440001e","modified":1562723189974},{"_id":"source/_posts/ELK快速入门三-logstash收集日志写入redis/redis04.png","hash":"1bccd73dcf3125d1a8331771b2f27b03d2e9664c","modified":1562751373535},{"_id":"source/_posts/ELK快速入门一-基本部署/elk11.png","hash":"9f2a3dfd04a136114aad50db4eb8e224e3d771b5","modified":1562723189964},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log11.png","hash":"695d6f5a5e46bf130678343837823cf0e39ac813","modified":1562556936500},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log22.png","hash":"405feea50cf1b56fe2a468b4bf4bbf7b57de32bd","modified":1562722624092},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log08.png","hash":"a00f0a4e635b83eb0cf90a55cc64da0a13dbcb85","modified":1562556521677},{"_id":"public/2019/08/06/PHP配合inotify实现光闸ftp功能/index.html","hash":"daee896585f58e52f337eb5086f3add983d409e0","modified":1571908827852},{"_id":"public/2019/07/05/ELK快速入门五-配置nginx代理kibana/index.html","hash":"174073163a81c7041b7963d12360fd5971df711f","modified":1571908827852},{"_id":"public/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/index.html","hash":"954a4497afaca14fa1f6d8bae0942d1d6f022026","modified":1571908827852},{"_id":"public/2019/07/05/ELK快速入门三-logstash收集日志写入redis/index.html","hash":"6ad6c08638ecba2f139b2b39f2428664e98a718d","modified":1571908827852},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/index.html","hash":"ce80e28e18eaebe7780ccef32a23601465c490c6","modified":1571908827852},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/index.html","hash":"b66c16c84d42b991bfa6dff62c8497112c4f21ec","modified":1571908827852},{"_id":"public/archives/2019/08/index.html","hash":"2266d52d1d85888e5931e579284e0f8947c0a43a","modified":1571908827856},{"_id":"public/tags/Linux/index.html","hash":"b4df71b6a1b7e08660303201e914cf467ace22bc","modified":1571908827858},{"_id":"public/2019/08/08/存储服务之NFS/index.html","hash":"d6f3e44b0936a51308b842b25a606bbaffbb0393","modified":1571908827852},{"_id":"public/categories/Storage/index.html","hash":"abf08011b7b427c10fcb26027b93dc9f5bfee086","modified":1571908827857},{"_id":"public/tags/Storage/index.html","hash":"2c24aab21b1c4a4fb69cf67feb4f3df2e72fe542","modified":1571908827858},{"_id":"public/2019/07/05/ELK快速入门五-配置nginx代理kibana/nginx01.png","hash":"04b624329facea3ebda8c3551ea641e2f1a69323","modified":1565344949347},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk01.png","hash":"c70144da14842696315b42c43f3ad0f5eb01c771","modified":1565344949347},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk02.png","hash":"a150dafb1e65bdb535327db300468023f25c2896","modified":1565344949348},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk04.png","hash":"35ba8275b4cc7641300e716eae5c7f46274c597f","modified":1565344949348},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk05.png","hash":"9933382fd35c9ac4738910889a90c3533070ced3","modified":1565344949348},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk08.png","hash":"9a1656d13d4a9406f6b44b18a0394fe0d599583a","modified":1565344949348},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk07.png","hash":"b51f9ec453b78eb65d4a6a71b7205bd75ba3ff15","modified":1565344949348},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk10.png","hash":"89c2ba24da18785487fd3564f1f266d82c9508e9","modified":1565344949348},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log06.png","hash":"98a403efd4f8f3a978ae7b52859b7071aeae6178","modified":1565344949348},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log16.png","hash":"e508f612e6f07e02f96378fcdeb20570a28ae399","modified":1565344949348},{"_id":"public/2019/08/06/PHP配合inotify实现光闸ftp功能/01.png","hash":"dafee52b95d3cd3725baa0c8cf68461f412839d1","modified":1565344949348},{"_id":"public/2019/08/08/存储服务之NFS/03.png","hash":"5597d069e3031cc85b4860c65be105bb33fadfb1","modified":1565344949348},{"_id":"public/2019/08/08/存储服务之NFS/01.png","hash":"7afd3459bb1d4de4ed77bbf3aa3aa91342db6d80","modified":1565344949348},{"_id":"public/2019/07/05/ELK快速入门五-配置nginx代理kibana/nginx02.png","hash":"82476959b8751377ead50da4c4b08ad72f9a3af7","modified":1565344949363},{"_id":"public/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis01.png","hash":"c3e5f7399698670a939b03c521d4a0d99a8f7e14","modified":1565344949363},{"_id":"public/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis03.png","hash":"a92b6c0ed970966a1dbd891825b7556e49b2d43a","modified":1565344949364},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk03.png","hash":"8d4ee8baa4cfcf17e61dd0d00f9a4a893e548f13","modified":1565344949364},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk06.png","hash":"0d4381e03459395fbba3feb4e0a041d87e6b8c50","modified":1565344949366},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk09.png","hash":"e64769568a4a319718a80cab8a935e30b1142d2c","modified":1565344949366},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk13.png","hash":"2e5db86fb4a64b36c9481980ab805ad687f52ed2","modified":1565344949367},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log01.png","hash":"31cc11ac58042c6d329f031147fb0c0b9b8467d0","modified":1565344949367},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log02.png","hash":"439fbcd811c595553de5935741fe03e69c58a83b","modified":1565344949367},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log03.png","hash":"89fe856ce5248e4fbb415195660c626c8d9f4bfa","modified":1565344949367},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log04.png","hash":"79f10f23be7acc134ed72ddb1ab830da79b1b3b2","modified":1565344949367},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log07.png","hash":"7a96a22b852008c7b9fbcfedbaaaaf69f1aea725","modified":1565344949368},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log09.png","hash":"ae2156a55d07638de57e82f742a9ec4408112a9e","modified":1565344949368},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log13.png","hash":"83353120c0793e9bb6f191af09f32140d6d3ebd5","modified":1565344949369},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log20.png","hash":"09e0a1d271f2218d93179f4b74940802f7593457","modified":1565344949369},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log21.png","hash":"8931a21f49a64954684542f7cd76ad626b59c108","modified":1565344949369},{"_id":"public/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file01.png","hash":"3810efabfc5a594eb481848eaa9c544eeb52da6d","modified":1565344949369},{"_id":"public/2019/08/08/存储服务之NFS/02.png","hash":"23e338fba58dcd5d9e2e82689b9ba304ac946714","modified":1565344949369},{"_id":"public/2019/08/08/存储服务之NFS/04.png","hash":"009be59d359b4aad9becd9cc46f87fdf512105e3","modified":1565344949369},{"_id":"public/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file03.png","hash":"20473fd7a7ab75b4fc9edc95d7a7045be8a29af3","modified":1565344949436},{"_id":"public/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis02.png","hash":"a703763394990af9db17768ebb9a42b8d43d80d9","modified":1565344949436},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk12.png","hash":"be759c34d6894996320edcea86c2e8a8934da552","modified":1565344949436},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk14.png","hash":"bb213a559bf9ed568f6505e2ed975d40e7f5da08","modified":1565344949437},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log05.png","hash":"9286c9e9d642dc1688087c5d5ea4ccaca938f73f","modified":1565344949437},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log10.png","hash":"ed37fbd8858ead0833696ca412e1f1afbbfb552b","modified":1565344949437},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log14.png","hash":"f5bb2b7a29fa91f6f41aa8fff8f9ff9e43093463","modified":1565344949437},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log17.png","hash":"0e4a40365f424e287967d96582a268b64eab2a5e","modified":1565344949438},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log18.png","hash":"ff92567a87d04d075fb2ac01eed96d9cc8a9e43a","modified":1565344949438},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log19.png","hash":"f354a4a1065299c3a3a5ae57afa77a8d37e669c0","modified":1565344949438},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log22.png","hash":"405feea50cf1b56fe2a468b4bf4bbf7b57de32bd","modified":1565344949439},{"_id":"public/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file02.png","hash":"7d070ae3bd43f9933ee545e1e9cd9e5f727393be","modified":1565344949439},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log12.png","hash":"e1b67845358e231f2622de473a77bb9bd620daf8","modified":1565344949533},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log15.png","hash":"fcda2ad71cad4cc83b1f38a75778c2504fddd505","modified":1565344949533},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk11.png","hash":"9f2a3dfd04a136114aad50db4eb8e224e3d771b5","modified":1565344949535},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log11.png","hash":"695d6f5a5e46bf130678343837823cf0e39ac813","modified":1565344949573},{"_id":"public/2019/07/05/ELK快速入门二-通过logstash收集日志/log08.png","hash":"a00f0a4e635b83eb0cf90a55cc64da0a13dbcb85","modified":1565344949642},{"_id":"public/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis04.png","hash":"1bccd73dcf3125d1a8331771b2f27b03d2e9664c","modified":1565344949660},{"_id":"public/2019/07/05/ELK快速入门一-基本部署/elk15.png","hash":"f58d1600e2ee3d4ae0741c2bf72175ccb440001e","modified":1565344949661},{"_id":"source/_posts/网络RAID技术DRBD.md","hash":"22e2688af40480dd7892e0ffdacc4bf967e86fdb","modified":1571908336899},{"_id":"source/_posts/网络RAID技术DRBD/01.jpg","hash":"e0495683a2dc4aec7ae21fbfc3bbb4ce5cf20736","modified":1571908336900},{"_id":"themes/next/source/lib/fancybox/.bower.json","hash":"cc40a9b11e52348e554c84e4a5c058056f6b7aeb","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/.gitattributes","hash":"2db21acfbd457452462f71cc4048a943ee61b8e0","modified":1514748788000},{"_id":"themes/next/source/lib/pace/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1556202421981},{"_id":"themes/next/source/lib/pace/README.md","hash":"33b87ed998d59f117dc329f999a4ffc744b41e79","modified":1556202421981},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1556202421982},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1556202421982},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1556202421982},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1556202421985},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1556202421985},{"_id":"themes/next/source/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1556202421985},{"_id":"themes/next/source/lib/pace/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1556202421975},{"_id":"themes/next/source/lib/pace/.git/config","hash":"46d590e05dc25560a69d5cc71b337adad9654443","modified":1556202421977},{"_id":"themes/next/source/lib/pace/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1556202418158},{"_id":"themes/next/source/lib/pace/.git/index","hash":"f916936bb525ec0301660daa3f9c06252999005b","modified":1557584774948},{"_id":"themes/next/source/lib/pace/.git/packed-refs","hash":"a04f762b5ecb138fde3c5f6107d05494d8e4c905","modified":1556202421972},{"_id":"themes/next/source/lib/pace/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1556202421981},{"_id":"themes/next/source/lib/pace/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1556202418160},{"_id":"themes/next/source/lib/pace/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1556202418159},{"_id":"themes/next/source/lib/pace/.git/hooks/fsmonitor-watchman.sample","hash":"f7c0aa40cb0d620ff0bca3efe3521ec79e5d7156","modified":1556202418160},{"_id":"themes/next/source/lib/pace/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1556202418160},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1556202418162},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1556202418159},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1556202418162},{"_id":"themes/next/source/lib/pace/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1556202418158},{"_id":"themes/next/source/lib/pace/.git/logs/HEAD","hash":"a1e96ae1aa3f38847271435b43d48051e481f5a3","modified":1556202421976},{"_id":"themes/next/source/lib/pace/.git/objects/00/13175fe71888324d9142744034e8296501174a","hash":"0ad0e50f7fe91fe14491924aa4b1e2e8f060a5cd","modified":1556202421954},{"_id":"themes/next/source/lib/pace/.git/objects/0c/dada082d621dbfdd00f7020c33dc751129167f","hash":"b490c11cdefde6b331a7d4ddb055e34ad08459d8","modified":1556202421952},{"_id":"themes/next/source/lib/pace/.git/objects/1c/159365320ef5dde63906912f3df067376b40d0","hash":"1dd6b7373c3f9c67e34aa319c9c08fd0f667156a","modified":1556202421962},{"_id":"themes/next/source/lib/pace/.git/objects/23/4f9b3e93f06a85cb2ec01acc872ccdc2bec7cb","hash":"63f8640eceff35a80175a102fcbd8789e690cfaa","modified":1556202421962},{"_id":"themes/next/source/lib/pace/.git/objects/2f/9eba51ec174b1e0c719d12cafa7c3c07140471","hash":"fc994d9d8b3b21ec7c941eea7e3862970e297e9b","modified":1556202421952},{"_id":"themes/next/source/lib/pace/.git/objects/35/a749d823ad0aae6111a76dc501a1170478f376","hash":"e757129fb6bca3170b62b05f3e850e4b55f3ae88","modified":1556202421961},{"_id":"themes/next/source/lib/pace/.git/objects/3e/dcd352d2a1a60dbb6a43e7e9f00bab8b55791a","hash":"725bf5094855cd943dd1cd351906fb1ebec1d861","modified":1556202421955},{"_id":"themes/next/source/lib/pace/.git/objects/41/28e69301ad36a283c0fc523f3aef89644d2467","hash":"d8b985cf431fbdc5b4fa3be89e27db7a3437c920","modified":1556202421963},{"_id":"themes/next/source/lib/pace/.git/objects/49/0db22b657dd64430d003fe2831905a54858b22","hash":"43694656c4c331cfa3667afca630bd486ac0d0fe","modified":1556202421959},{"_id":"themes/next/source/lib/pace/.git/objects/4d/fbb499a4f7b2f26a535c335cd66c966ff8b261","hash":"14e4cdcc137045c7efed32f796273d40c9fcef87","modified":1556202421960},{"_id":"themes/next/source/lib/pace/.git/objects/53/3d55db0342c2b011ac05703c3b42e88a25c1ed","hash":"c48454760d2e04602a5499188b33d38839c58aee","modified":1556202421960},{"_id":"themes/next/source/lib/pace/.git/objects/60/0378418401f2b0e7c58407a7bbc5a5196cfa51","hash":"20489d796247dda758599f40cbfcf14d194ef64a","modified":1556202421949},{"_id":"themes/next/source/lib/pace/.git/objects/61/fcbe3a99ad371eacdf3a3703883f8e95e072c8","hash":"480b60d684f9a077ade5dda0acfc75bcd9597aff","modified":1556202421951},{"_id":"themes/next/source/lib/pace/.git/objects/69/a20d65d83035fdb01734a8eabe3340f740a4cb","hash":"9e95b02d8e43ec92e06bee3f60dffb74e8e7b9fa","modified":1556202421953},{"_id":"themes/next/source/lib/pace/.git/objects/82/8dcba3c8a21de08d1eb38f2eee453b51543188","hash":"629aad2ee2e564790e78cd46e99ad396544960ab","modified":1556202421956},{"_id":"themes/next/source/lib/pace/.git/objects/84/a17ac7b4fe9cea559de91f00af88f810bff7f1","hash":"b41b6d3cbccd75b711f0523bba1c26bf19b0a862","modified":1556202421948},{"_id":"themes/next/source/lib/pace/.git/objects/8b/b4535a79cc15127f8906b24c4e0bb4a38a5947","hash":"9c2d65a63f18929b09f3592dda064f24309ff98b","modified":1556202421957},{"_id":"themes/next/source/lib/pace/.git/objects/97/1e8a1f2ad6d45f693980c106af0aead9d1c215","hash":"e45f0963920a53a57f6b53d178e5b05a8e315189","modified":1556202421954},{"_id":"themes/next/source/lib/pace/.git/objects/9b/3058068409f2282607ebb91717d7a6a1406230","hash":"651c5857021e11dc397df86dbe0f01e6c7dc7f16","modified":1556202421958},{"_id":"themes/next/source/lib/pace/.git/objects/a6/dbd9c99e726f621e2bdcd3c6fe2795a5d4272d","hash":"25350dd31f504af7206610ced355d162aabda8dd","modified":1556202421958},{"_id":"themes/next/source/lib/pace/.git/objects/aa/813c5a6398600e01b740696cd889eb3becad84","hash":"c62a1513ca820dc59fe1cd6d9ec16c92e0e2fbf0","modified":1556202421950},{"_id":"themes/next/source/lib/pace/.git/objects/c0/05c71f1a000d8187df58083d215c962d7f5505","hash":"dffd212ca2ec705233fabe82a6f483d6be4b151d","modified":1556202421957},{"_id":"themes/next/source/lib/pace/.git/objects/de/79ab6539ac3702aaac64b879d95e6575f4eefa","hash":"0046fefd52ed4679e0fee757cc91ced94e3ddc12","modified":1556202421963},{"_id":"themes/next/source/lib/pace/.git/objects/da/79363b808519d44a7eda67d7bc81e1587a06e8","hash":"0dc5dc27991da9a09d705e488bc3f1fe5a4d4728","modified":1556202421947},{"_id":"themes/next/source/lib/pace/.git/objects/f3/0e0a99bb016267bde55537dd47b3657ae59544","hash":"8bf0bc17a6111b6a82981073133f33cc8e815c41","modified":1556202421955},{"_id":"themes/next/source/lib/pace/.git/refs/heads/master","hash":"2cf353bc3f5e2816a3a0e05d3f154a777200f091","modified":1556202421976},{"_id":"themes/next/source/lib/pace/.git/logs/refs/heads/master","hash":"a1e96ae1aa3f38847271435b43d48051e481f5a3","modified":1556202421976},{"_id":"themes/next/source/lib/pace/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1556202421974},{"_id":"themes/next/source/lib/pace/.git/logs/refs/remotes/origin/HEAD","hash":"a1e96ae1aa3f38847271435b43d48051e481f5a3","modified":1556202421974},{"_id":"public/2019/08/08/网络RAID技术DRBD/index.html","hash":"f22f97fcae613bdbd87aa9d3707676236e26465a","modified":1571908827852},{"_id":"public/lib/pace/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1571908374947},{"_id":"public/2019/08/08/网络RAID技术DRBD/01.jpg","hash":"e0495683a2dc4aec7ae21fbfc3bbb4ce5cf20736","modified":1571908374947},{"_id":"public/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1571908375391},{"_id":"public/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1571908375392},{"_id":"public/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1571908375392},{"_id":"public/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1571908375393},{"_id":"public/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1571908375393},{"_id":"public/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1571908375393},{"_id":"public/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1571908375393},{"_id":"public/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1571908375393},{"_id":"public/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1571908375393},{"_id":"public/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1571908375393},{"_id":"public/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1571908375393},{"_id":"public/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1571908375393},{"_id":"public/lib/pace/README.html","hash":"58f2105ada5cc52dff5aabcecb92569ee84493a0","modified":1571908375393},{"_id":"public/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1571908375399},{"_id":"public/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1571908375399},{"_id":"source/_posts/(一)Kubernetes系统基础.md","hash":"ca462e4e6f8a6023a19f78dd3f83fedfdeec9b20","modified":1571908782484},{"_id":"source/_posts/(一)Kubernetes系统基础/cluster.png","hash":"82576c7fc776a1cd88843f62365f0cf66c680abd","modified":1571823828000},{"_id":"source/_posts/(一)Kubernetes系统基础/deployment.png","hash":"4a0513e23e15ad5c98a7e2855ed5bd22e5d1e60b","modified":1571823829000},{"_id":"source/_posts/(一)Kubernetes系统基础/kubernetescluster.png","hash":"c152c2340dba9b88c41c78286d4134755b9c7e8e","modified":1571823830000},{"_id":"source/_posts/(一)Kubernetes系统基础/label.png","hash":"c61254348d81a45b2015020d9e96426d29f7fb03","modified":1571823830000},{"_id":"source/_posts/(一)Kubernetes系统基础/labels.png","hash":"a2dbba236f061217a54fc10d8425e73245aaa0f9","modified":1571823830000},{"_id":"source/_posts/(一)Kubernetes系统基础/namespace.png","hash":"48ebf3f0a733a5eff9e3325afcca4c45d1349f41","modified":1571823832000},{"_id":"source/_posts/(一)Kubernetes系统基础/pod.png","hash":"ea354837f139ce0fc25c7893e480a4c9badfa70b","modified":1571823832000},{"_id":"source/_posts/(一)Kubernetes系统基础/system.png","hash":"dac1f43d4f6ad3a0c186ffed0901fa1bb6ec0dfc","modified":1571823833000},{"_id":"source/_posts/(一)Kubernetes系统基础/scheduler.png","hash":"0e6d06e44fc6de2ee8d1d1072b085bfeb0733c0b","modified":1571823832000},{"_id":"source/_posts/(一)Kubernetes系统基础/1.gif","hash":"507504747227f8cb808194dd71bf9fb28e4dec16","modified":1571823828000},{"_id":"public/2019/10/24/(一)Kubernetes系统基础/index.html","hash":"710587155b7216c45b71df1328c5e26ace482c34","modified":1571908827862},{"_id":"public/archives/page/4/index.html","hash":"96bbc4bb6da6acc96572d5caf905eab502523fa2","modified":1571908827862},{"_id":"public/archives/2019/page/4/index.html","hash":"b45632bd10e385d4e0ed790328e79c5077c4a851","modified":1571908827862},{"_id":"public/archives/2019/10/index.html","hash":"dfaff9635cb860f1f7068d569dbdd552fdba6c3f","modified":1571908827862},{"_id":"public/categories/Kubernetes/index.html","hash":"511c83a3ca189de1c51b55fe58999c6b24d0ac9f","modified":1571908827862},{"_id":"public/page/4/index.html","hash":"183de7e1acf4fed878bafc960524eec19d1323bb","modified":1571908827862},{"_id":"public/tags/Kubernetes/index.html","hash":"27aa1b4a319e371c34a86a1ddccc70488aee879d","modified":1571908827862},{"_id":"public/2019/10/24/(一)Kubernetes系统基础/deployment.png","hash":"4a0513e23e15ad5c98a7e2855ed5bd22e5d1e60b","modified":1571908827865},{"_id":"public/2019/10/24/(一)Kubernetes系统基础/cluster.png","hash":"82576c7fc776a1cd88843f62365f0cf66c680abd","modified":1571908827865},{"_id":"public/2019/10/24/(一)Kubernetes系统基础/kubernetescluster.png","hash":"c152c2340dba9b88c41c78286d4134755b9c7e8e","modified":1571908827865},{"_id":"public/2019/10/24/(一)Kubernetes系统基础/label.png","hash":"c61254348d81a45b2015020d9e96426d29f7fb03","modified":1571908827865},{"_id":"public/2019/10/24/(一)Kubernetes系统基础/labels.png","hash":"a2dbba236f061217a54fc10d8425e73245aaa0f9","modified":1571908827865},{"_id":"public/2019/10/24/(一)Kubernetes系统基础/namespace.png","hash":"48ebf3f0a733a5eff9e3325afcca4c45d1349f41","modified":1571908827865},{"_id":"public/2019/10/24/(一)Kubernetes系统基础/pod.png","hash":"ea354837f139ce0fc25c7893e480a4c9badfa70b","modified":1571908827865},{"_id":"public/2019/10/24/(一)Kubernetes系统基础/system.png","hash":"dac1f43d4f6ad3a0c186ffed0901fa1bb6ec0dfc","modified":1571908827865},{"_id":"public/2019/10/24/(一)Kubernetes系统基础/1.gif","hash":"507504747227f8cb808194dd71bf9fb28e4dec16","modified":1571908827875},{"_id":"public/2019/10/24/(一)Kubernetes系统基础/scheduler.png","hash":"0e6d06e44fc6de2ee8d1d1072b085bfeb0733c0b","modified":1571908827875}],"Category":[{"name":"Shell","_id":"cjxwlqrcx0002lctcnlv5wop8"},{"name":"Linux","_id":"cjxwlqrd80004lctcfy113hld"},{"name":"Linux运维日常","_id":"cjxwlqrk8000elctc9uyi0mt2"},{"name":"Saltstack","_id":"cjxwlqrl5000xlctcbb3o1c57"},{"name":"Ansible","_id":"cjxwlqrmh001olctcioy5udyv"},{"name":"Tomcat","_id":"cjxwlqrn90020lctckyb7t8ek"},{"name":"ELK","_id":"cjxwlqro8002alctcv5p9kksc"},{"name":"Cobbler","_id":"cjxwlqrql002jlctcld92wkh7"},{"name":"Storage","_id":"cjz3xyipi000bdstcn46t15ln"},{"name":"Kubernetes","_id":"ck24hxdte00016wnruf1adni8"}],"Data":[],"Page":[{"title":"分类","date":"2019-04-22T12:36:46.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\ndate: 2019-04-22 20:36:46\ntype: \"categories\"\n---\n","updated":"2019-04-25T02:36:12.750Z","path":"categories/index.html","_id":"cjxwlqrjx000blctcowcjnf7j","comments":1,"layout":"page","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"photos","date":"2019-04-22T16:36:22.000Z","type":"photos","_content":"","source":"photos/index.md","raw":"---\ntitle: photos\ndate: 2019-04-23 00:36:22\ntype: photos\n---\n","updated":"2019-04-22T16:38:15.074Z","path":"photos/index.html","_id":"cjxwlqrk4000dlctcackjq0jw","comments":1,"layout":"page","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"标签","date":"2019-04-22T11:56:18.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\ndate: 2019-04-22 19:56:18\ntype: \"tags\"\n---\n","updated":"2019-04-25T02:36:12.755Z","path":"tags/index.html","_id":"cjxwlqrkc000hlctcfkm0kizb","comments":1,"layout":"page","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"MySQL自动备份脚本","date":"2019-04-24T09:56:56.000Z","copyright":true,"_content":">通过 shell 脚本定时备份数据库，并定时清理\n\n```html\n#!/bin/bash\n#Desc:本地数据库备份脚本\n#Date:2017-12-24\n#by:Lee-YJ\n#运行脚本前先创建一个备份用户，并授予权限\n#mysql> grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";\n#mysql> flush privileges;\n\nmysqluser=back                    #用于数据库备份的用户名\nmysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码\nmysqlhost=127.0.0.1               #连接数据库的host\nbakpath=/opt/data/Back/DBbak          #备份数据库存放的路径\n\nbakdate=`date '+%Y%m%d'`\nbaktime=`date '+%H%M'`\n\n#----------------------------获取mysql中的数据库名---------------------------------\n/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test > /tmp/DBname\n\n#----------------------------数据库备份--mysqldump备份------------------------------\n\nif [ ! -d \"$bakpath\" ];then\n    mkdir -p $bakpath\nfi\n\ncd $bakpath\n\nif [ ! -d \"$bakdate\" ];then\n    mkdir $bakdate\nfi\n\ncd $bakdate\n\necho \"------------------------$bakdate$baktime-------------------------------------\" >> $bakpath/DBbak.log\nfor DBname in `cat /tmp/DBname`;do\n    if [ ! -d \"$DBname\" ];then\n        mkdir $DBname\n    fi\n    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  > $DBname/$baktime\\.sql\n    if [ $? = 0 ];then\n        echo \"$DBname Back OK!\" >> $bakpath/DBbak.log\n    else\n        echo \"$DBname Back ERROR!\" >> $bakpath/DBbak.log\n    fi\ndone\necho \"\" >> $bakpath/DBbak.log \n\n\n#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------\nshopt -s extglob\nolddate=`date '+%Y%m%d' -d \"-6 days\"`\ncd $bakpath/$olddate\nfor deldbname in `ls $bakpath/$olddate`;do\n    cd $deldbname\n    file=`ls| sort -R | head -n1`\n    rm -f !($file)\ndone\n\nif [ ! -d \"$bakpath/Oldest\" ];then\n    mkdir -p $bakpath/Oldest\nfi\n\nmv $bakpath/$olddate $bakpath/Oldest/\n\nrm -f /tmp/DBname\n\n\n\n```\n\n","source":"_posts/MySQL自动备份脚本.md","raw":"---\ntitle: MySQL自动备份脚本\ndate: 2019-04-24 17:56:56\ntags: Linux运维日常\ncategories: Shell\ncopyright: true\n---\n>通过 shell 脚本定时备份数据库，并定时清理\n\n```html\n#!/bin/bash\n#Desc:本地数据库备份脚本\n#Date:2017-12-24\n#by:Lee-YJ\n#运行脚本前先创建一个备份用户，并授予权限\n#mysql> grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";\n#mysql> flush privileges;\n\nmysqluser=back                    #用于数据库备份的用户名\nmysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码\nmysqlhost=127.0.0.1               #连接数据库的host\nbakpath=/opt/data/Back/DBbak          #备份数据库存放的路径\n\nbakdate=`date '+%Y%m%d'`\nbaktime=`date '+%H%M'`\n\n#----------------------------获取mysql中的数据库名---------------------------------\n/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test > /tmp/DBname\n\n#----------------------------数据库备份--mysqldump备份------------------------------\n\nif [ ! -d \"$bakpath\" ];then\n    mkdir -p $bakpath\nfi\n\ncd $bakpath\n\nif [ ! -d \"$bakdate\" ];then\n    mkdir $bakdate\nfi\n\ncd $bakdate\n\necho \"------------------------$bakdate$baktime-------------------------------------\" >> $bakpath/DBbak.log\nfor DBname in `cat /tmp/DBname`;do\n    if [ ! -d \"$DBname\" ];then\n        mkdir $DBname\n    fi\n    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  > $DBname/$baktime\\.sql\n    if [ $? = 0 ];then\n        echo \"$DBname Back OK!\" >> $bakpath/DBbak.log\n    else\n        echo \"$DBname Back ERROR!\" >> $bakpath/DBbak.log\n    fi\ndone\necho \"\" >> $bakpath/DBbak.log \n\n\n#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------\nshopt -s extglob\nolddate=`date '+%Y%m%d' -d \"-6 days\"`\ncd $bakpath/$olddate\nfor deldbname in `ls $bakpath/$olddate`;do\n    cd $deldbname\n    file=`ls| sort -R | head -n1`\n    rm -f !($file)\ndone\n\nif [ ! -d \"$bakpath/Oldest\" ];then\n    mkdir -p $bakpath/Oldest\nfi\n\nmv $bakpath/$olddate $bakpath/Oldest/\n\nrm -f /tmp/DBname\n\n\n\n```\n\n","slug":"MySQL自动备份脚本","published":1,"updated":"2019-05-17T13:23:21.438Z","_id":"cjxwlqrcm0000lctcqojngy03","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>通过 shell 脚本定时备份数据库，并定时清理</p>\n</blockquote>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">#Desc:本地数据库备份脚本</span><br><span class=\"line\">#Date:2017-12-24</span><br><span class=\"line\">#by:Lee-YJ</span><br><span class=\"line\">#运行脚本前先创建一个备份用户，并授予权限</span><br><span class=\"line\">#mysql&gt; grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";</span><br><span class=\"line\">#mysql&gt; flush privileges;</span><br><span class=\"line\"></span><br><span class=\"line\">mysqluser=back                    #用于数据库备份的用户名</span><br><span class=\"line\">mysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码</span><br><span class=\"line\">mysqlhost=127.0.0.1               #连接数据库的host</span><br><span class=\"line\">bakpath=/opt/data/Back/DBbak          #备份数据库存放的路径</span><br><span class=\"line\"></span><br><span class=\"line\">bakdate=`date '+%Y%m%d'`</span><br><span class=\"line\">baktime=`date '+%H%M'`</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------获取mysql中的数据库名---------------------------------</span><br><span class=\"line\">/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test &gt; /tmp/DBname</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------数据库备份--mysqldump备份------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakpath</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakdate\" ];then</span><br><span class=\"line\">    mkdir $bakdate</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakdate</span><br><span class=\"line\"></span><br><span class=\"line\">echo \"------------------------$bakdate$baktime-------------------------------------\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">for DBname in `cat /tmp/DBname`;do</span><br><span class=\"line\">    if [ ! -d \"$DBname\" ];then</span><br><span class=\"line\">        mkdir $DBname</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  &gt; $DBname/$baktime\\.sql</span><br><span class=\"line\">    if [ $? = 0 ];then</span><br><span class=\"line\">        echo \"$DBname Back OK!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"$DBname Back ERROR!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    fi</span><br><span class=\"line\">done</span><br><span class=\"line\">echo \"\" &gt;&gt; $bakpath/DBbak.log </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------</span><br><span class=\"line\">shopt -s extglob</span><br><span class=\"line\">olddate=`date '+%Y%m%d' -d \"-6 days\"`</span><br><span class=\"line\">cd $bakpath/$olddate</span><br><span class=\"line\">for deldbname in `ls $bakpath/$olddate`;do</span><br><span class=\"line\">    cd $deldbname</span><br><span class=\"line\">    file=`ls| sort -R | head -n1`</span><br><span class=\"line\">    rm -f !($file)</span><br><span class=\"line\">done</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath/Oldest\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath/Oldest</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">mv $bakpath/$olddate $bakpath/Oldest/</span><br><span class=\"line\"></span><br><span class=\"line\">rm -f /tmp/DBname</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>通过 shell 脚本定时备份数据库，并定时清理</p>\n</blockquote>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">#Desc:本地数据库备份脚本</span><br><span class=\"line\">#Date:2017-12-24</span><br><span class=\"line\">#by:Lee-YJ</span><br><span class=\"line\">#运行脚本前先创建一个备份用户，并授予权限</span><br><span class=\"line\">#mysql&gt; grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";</span><br><span class=\"line\">#mysql&gt; flush privileges;</span><br><span class=\"line\"></span><br><span class=\"line\">mysqluser=back                    #用于数据库备份的用户名</span><br><span class=\"line\">mysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码</span><br><span class=\"line\">mysqlhost=127.0.0.1               #连接数据库的host</span><br><span class=\"line\">bakpath=/opt/data/Back/DBbak          #备份数据库存放的路径</span><br><span class=\"line\"></span><br><span class=\"line\">bakdate=`date '+%Y%m%d'`</span><br><span class=\"line\">baktime=`date '+%H%M'`</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------获取mysql中的数据库名---------------------------------</span><br><span class=\"line\">/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test &gt; /tmp/DBname</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------数据库备份--mysqldump备份------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakpath</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakdate\" ];then</span><br><span class=\"line\">    mkdir $bakdate</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakdate</span><br><span class=\"line\"></span><br><span class=\"line\">echo \"------------------------$bakdate$baktime-------------------------------------\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">for DBname in `cat /tmp/DBname`;do</span><br><span class=\"line\">    if [ ! -d \"$DBname\" ];then</span><br><span class=\"line\">        mkdir $DBname</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  &gt; $DBname/$baktime\\.sql</span><br><span class=\"line\">    if [ $? = 0 ];then</span><br><span class=\"line\">        echo \"$DBname Back OK!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"$DBname Back ERROR!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    fi</span><br><span class=\"line\">done</span><br><span class=\"line\">echo \"\" &gt;&gt; $bakpath/DBbak.log </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------</span><br><span class=\"line\">shopt -s extglob</span><br><span class=\"line\">olddate=`date '+%Y%m%d' -d \"-6 days\"`</span><br><span class=\"line\">cd $bakpath/$olddate</span><br><span class=\"line\">for deldbname in `ls $bakpath/$olddate`;do</span><br><span class=\"line\">    cd $deldbname</span><br><span class=\"line\">    file=`ls| sort -R | head -n1`</span><br><span class=\"line\">    rm -f !($file)</span><br><span class=\"line\">done</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath/Oldest\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath/Oldest</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">mv $bakpath/$olddate $bakpath/Oldest/</span><br><span class=\"line\"></span><br><span class=\"line\">rm -f /tmp/DBname</span><br></pre></td></tr></table></figure>\n"},{"title":"ftp虚拟用户","date":"2019-04-23T14:30:00.000Z","copyright":true,"_content":"### 需求：\n进（账户）\\\nusername: ftpComeSsbq\\\npassword: ftp_come_#@UkieO9\\\n上传文件的目录：/opt/ftp/come\n\n出（账户）\\\nusername: ftpOutSsbq\\\npassword: ftp_out_#@45oUkie\\\n上床文件的目录：/opt/ftp/out\n\n### 具体步骤\n\n1 安装软件\n```\n# yum -y install vsftpd\n```\n2 创建相应的ftp数据目录\n```\n# mkdir -p /opt/ftp/{come,out}\n```\n3 创建一个用户提供给虚拟用户使用\n```\n# useradd -s /sbin/nologin virtual\n```\n4 将ftp数据目录设置成virtual用户\n```\n# chown virtual. /opt/ftp/ -R\n# ll /opt/ftp/\ntotal 8\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 come\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 out\n```\n5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)\n```\n# vim /etc/vsftpd/logins.txt\nftpComeSsbq\nftp_come_#@UkieO9\nftpOutSsbq\nftp_out_#@45oUkie\n```\n6 将创建好的密码文件txt格式转换db格式\n```\n# db_load -T -t hash -f /etc/vsftpd/logins.txt /etc/vsftpd/login.db\n```\n7 定义db文件的权限\n```\n# chmod 600 /etc/vsftpd/login.db\n```\n8 定义pam认证文件\n```\n# vim /etc/pam.d/ftp\nauth  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\naccount  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\n```\n9 配置vsftpd主配置文件\n```\n# cp /etc/vsftpd/vsftpd.conf{,.bak}\n# vim /etc/vsftpd/vsftpd.conf\n#禁止匿名登录FTP服务器\nanonymous_enable=NO\n#允许本地用户登录FTP服务器\nlocal_enable=YES\n#可以上传(全局控制) \nwrite_enable=NO\n#匿名用户可以上传\nanon_upload_enable=NO\n#匿名用户可以建目录\nanon_mkdir_write_enable=NO\n#匿名用户修改删除\nanon_other_write_enable=NO\n#全部用户被限制在主目录\nchroot_local_user=YES\n#将所有用户看成虚拟用户guest\nguest_enable=YES\n#指定虚拟用户，也就是将guest用户映射到virtual用户\nguest_username=virtual\n#指定为独立服务\nlisten=YES\n#指定监听的端口\nlisten_port=21\n#开启被动模式\npasv_enable=YES\n#FTP服务器公网IP\npasv_address=120.79.93.66\n#设置被动模式下，建立数据传输可使用port范围的最小值\npasv_min_port=10000\n#设置被动模式下，建立数据传输可使用port范围的最大值\npasv_max_port=10088\n#是否允许匿名用户下载全局可读的文件\nanon_world_readable_only=NO\n#指定虚拟用户配置文件的路径\nuser_config_dir=/etc/vsftpd/user_conf\n```\n10 创建上面配置文件中指定的子配置文件目录 user_conf\n```\n# mkdir /etc/vsftpd/user_conf\n```\n11 定义 ftpComeSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpComeSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/come\n```\n12 定义 ftpOutSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpOutSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/out\n```\n13 启动vsftpd\n```\n# service vsftpd start\n```\n14 测试\n...\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/ftp虚拟用户.md","raw":"---\ntitle: ftp虚拟用户\ndate: 2019-04-23 22:30:00\ntags: Linux运维日常\ncategories: Linux\ncopyright: true\n---\n### 需求：\n进（账户）\\\nusername: ftpComeSsbq\\\npassword: ftp_come_#@UkieO9\\\n上传文件的目录：/opt/ftp/come\n\n出（账户）\\\nusername: ftpOutSsbq\\\npassword: ftp_out_#@45oUkie\\\n上床文件的目录：/opt/ftp/out\n\n### 具体步骤\n\n1 安装软件\n```\n# yum -y install vsftpd\n```\n2 创建相应的ftp数据目录\n```\n# mkdir -p /opt/ftp/{come,out}\n```\n3 创建一个用户提供给虚拟用户使用\n```\n# useradd -s /sbin/nologin virtual\n```\n4 将ftp数据目录设置成virtual用户\n```\n# chown virtual. /opt/ftp/ -R\n# ll /opt/ftp/\ntotal 8\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 come\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 out\n```\n5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)\n```\n# vim /etc/vsftpd/logins.txt\nftpComeSsbq\nftp_come_#@UkieO9\nftpOutSsbq\nftp_out_#@45oUkie\n```\n6 将创建好的密码文件txt格式转换db格式\n```\n# db_load -T -t hash -f /etc/vsftpd/logins.txt /etc/vsftpd/login.db\n```\n7 定义db文件的权限\n```\n# chmod 600 /etc/vsftpd/login.db\n```\n8 定义pam认证文件\n```\n# vim /etc/pam.d/ftp\nauth  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\naccount  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\n```\n9 配置vsftpd主配置文件\n```\n# cp /etc/vsftpd/vsftpd.conf{,.bak}\n# vim /etc/vsftpd/vsftpd.conf\n#禁止匿名登录FTP服务器\nanonymous_enable=NO\n#允许本地用户登录FTP服务器\nlocal_enable=YES\n#可以上传(全局控制) \nwrite_enable=NO\n#匿名用户可以上传\nanon_upload_enable=NO\n#匿名用户可以建目录\nanon_mkdir_write_enable=NO\n#匿名用户修改删除\nanon_other_write_enable=NO\n#全部用户被限制在主目录\nchroot_local_user=YES\n#将所有用户看成虚拟用户guest\nguest_enable=YES\n#指定虚拟用户，也就是将guest用户映射到virtual用户\nguest_username=virtual\n#指定为独立服务\nlisten=YES\n#指定监听的端口\nlisten_port=21\n#开启被动模式\npasv_enable=YES\n#FTP服务器公网IP\npasv_address=120.79.93.66\n#设置被动模式下，建立数据传输可使用port范围的最小值\npasv_min_port=10000\n#设置被动模式下，建立数据传输可使用port范围的最大值\npasv_max_port=10088\n#是否允许匿名用户下载全局可读的文件\nanon_world_readable_only=NO\n#指定虚拟用户配置文件的路径\nuser_config_dir=/etc/vsftpd/user_conf\n```\n10 创建上面配置文件中指定的子配置文件目录 user_conf\n```\n# mkdir /etc/vsftpd/user_conf\n```\n11 定义 ftpComeSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpComeSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/come\n```\n12 定义 ftpOutSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpOutSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/out\n```\n13 启动vsftpd\n```\n# service vsftpd start\n```\n14 测试\n...\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","slug":"ftp虚拟用户","published":1,"updated":"2019-04-23T14:37:22.762Z","_id":"cjxwlqrct0001lctc9hxr5k60","comments":1,"layout":"post","photos":[],"link":"","content":"<h3 id=\"需求：\"><a href=\"#需求：\" class=\"headerlink\" title=\"需求：\"></a>需求：</h3><p>进（账户）\\<br>username: ftpComeSsbq\\<br>password: ftp<em>come</em>#@UkieO9\\<br>上传文件的目录：/opt/ftp/come</p>\n<p>出（账户）\\<br>username: ftpOutSsbq\\<br>password: ftp<em>out</em>#@45oUkie\\<br>上床文件的目录：/opt/ftp/out</p>\n<h3 id=\"具体步骤\"><a href=\"#具体步骤\" class=\"headerlink\" title=\"具体步骤\"></a>具体步骤</h3><p>1 安装软件<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install vsftpd</span></span><br></pre></td></tr></table></figure></p>\n<p>2 创建相应的ftp数据目录<br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># <span class=\"keyword\">mkdir</span> -p /opt/ftp/&#123;come,<span class=\"keyword\">out</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3 创建一个用户提供给虚拟用户使用<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># useradd -s /sbin/nologin virtual</span></span><br></pre></td></tr></table></figure></p>\n<p>4 将ftp数据目录设置成virtual用户<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># chown virtual. /opt/ftp/ -R</span></span><br><span class=\"line\"><span class=\"comment\"># ll /opt/ftp/</span></span><br><span class=\"line\">total 8</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 come</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 out</span><br></pre></td></tr></table></figure></p>\n<p>5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/logins.txt</span></span><br><span class=\"line\">ftpComeSsbq</span><br><span class=\"line\">ftp_come<span class=\"number\">_</span><span class=\"comment\">#<span class=\"doctag\">@UkieO</span>9</span></span><br><span class=\"line\">ftpOutSsbq</span><br><span class=\"line\">ftp_out<span class=\"number\">_</span><span class=\"comment\">#@45oUkie</span></span><br></pre></td></tr></table></figure></p>\n<p>6 将创建好的密码文件txt格式转换db格式<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># db_load -T -t hash -f <span class=\"regexp\">/etc/</span>vsftpd<span class=\"regexp\">/logins.txt /</span>etc<span class=\"regexp\">/vsftpd/</span>login.db</span><br></pre></td></tr></table></figure></p>\n<p>7 定义db文件的权限<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># chmod 600 /etc/vsftpd/login.db</span></span><br></pre></td></tr></table></figure></p>\n<p>8 定义pam认证文件<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/pam.d/ftp</span></span><br><span class=\"line\">auth  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br><span class=\"line\">account  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br></pre></td></tr></table></figure></p>\n<p>9 配置vsftpd主配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cp /etc/vsftpd/vsftpd.conf&#123;,.bak&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/vsftpd.conf</span></span><br><span class=\"line\"><span class=\"comment\">#禁止匿名登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">anonymous_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#允许本地用户登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">local_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#可以上传(全局控制) </span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以上传</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以建目录</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户修改删除</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#全部用户被限制在主目录</span></span><br><span class=\"line\"><span class=\"attr\">chroot_local_user</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#将所有用户看成虚拟用户guest</span></span><br><span class=\"line\"><span class=\"attr\">guest_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户，也就是将guest用户映射到virtual用户</span></span><br><span class=\"line\"><span class=\"attr\">guest_username</span>=virtual</span><br><span class=\"line\"><span class=\"comment\">#指定为独立服务</span></span><br><span class=\"line\"><span class=\"attr\">listen</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定监听的端口</span></span><br><span class=\"line\"><span class=\"attr\">listen_port</span>=<span class=\"number\">21</span></span><br><span class=\"line\"><span class=\"comment\">#开启被动模式</span></span><br><span class=\"line\"><span class=\"attr\">pasv_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#FTP服务器公网IP</span></span><br><span class=\"line\"><span class=\"attr\">pasv_address</span>=<span class=\"number\">120.79</span>.<span class=\"number\">93.66</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最小值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_min_port</span>=<span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最大值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_max_port</span>=<span class=\"number\">10088</span></span><br><span class=\"line\"><span class=\"comment\">#是否允许匿名用户下载全局可读的文件</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户配置文件的路径</span></span><br><span class=\"line\"><span class=\"attr\">user_config_dir</span>=/etc/vsftpd/user_conf</span><br></pre></td></tr></table></figure></p>\n<p>10 创建上面配置文件中指定的子配置文件目录 user_conf<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># mkdir /etc/vsftpd/user_conf</span></span><br></pre></td></tr></table></figure></p>\n<p>11 定义 ftpComeSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpComeSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/come</span><br></pre></td></tr></table></figure></p>\n<p>12 定义 ftpOutSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpOutSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/out</span><br></pre></td></tr></table></figure></p>\n<p>13 启动vsftpd<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># service vsftpd start</span></span><br></pre></td></tr></table></figure></p>\n<p>14 测试<br>…</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"需求：\"><a href=\"#需求：\" class=\"headerlink\" title=\"需求：\"></a>需求：</h3><p>进（账户）\\<br>username: ftpComeSsbq\\<br>password: ftp<em>come</em>#@UkieO9\\<br>上传文件的目录：/opt/ftp/come</p>\n<p>出（账户）\\<br>username: ftpOutSsbq\\<br>password: ftp<em>out</em>#@45oUkie\\<br>上床文件的目录：/opt/ftp/out</p>\n<h3 id=\"具体步骤\"><a href=\"#具体步骤\" class=\"headerlink\" title=\"具体步骤\"></a>具体步骤</h3><p>1 安装软件<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install vsftpd</span></span><br></pre></td></tr></table></figure></p>\n<p>2 创建相应的ftp数据目录<br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># <span class=\"keyword\">mkdir</span> -p /opt/ftp/&#123;come,<span class=\"keyword\">out</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3 创建一个用户提供给虚拟用户使用<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># useradd -s /sbin/nologin virtual</span></span><br></pre></td></tr></table></figure></p>\n<p>4 将ftp数据目录设置成virtual用户<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># chown virtual. /opt/ftp/ -R</span></span><br><span class=\"line\"><span class=\"comment\"># ll /opt/ftp/</span></span><br><span class=\"line\">total 8</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 come</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 out</span><br></pre></td></tr></table></figure></p>\n<p>5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/logins.txt</span></span><br><span class=\"line\">ftpComeSsbq</span><br><span class=\"line\">ftp_come<span class=\"number\">_</span><span class=\"comment\">#<span class=\"doctag\">@UkieO</span>9</span></span><br><span class=\"line\">ftpOutSsbq</span><br><span class=\"line\">ftp_out<span class=\"number\">_</span><span class=\"comment\">#@45oUkie</span></span><br></pre></td></tr></table></figure></p>\n<p>6 将创建好的密码文件txt格式转换db格式<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># db_load -T -t hash -f <span class=\"regexp\">/etc/</span>vsftpd<span class=\"regexp\">/logins.txt /</span>etc<span class=\"regexp\">/vsftpd/</span>login.db</span><br></pre></td></tr></table></figure></p>\n<p>7 定义db文件的权限<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># chmod 600 /etc/vsftpd/login.db</span></span><br></pre></td></tr></table></figure></p>\n<p>8 定义pam认证文件<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/pam.d/ftp</span></span><br><span class=\"line\">auth  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br><span class=\"line\">account  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br></pre></td></tr></table></figure></p>\n<p>9 配置vsftpd主配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cp /etc/vsftpd/vsftpd.conf&#123;,.bak&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/vsftpd.conf</span></span><br><span class=\"line\"><span class=\"comment\">#禁止匿名登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">anonymous_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#允许本地用户登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">local_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#可以上传(全局控制) </span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以上传</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以建目录</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户修改删除</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#全部用户被限制在主目录</span></span><br><span class=\"line\"><span class=\"attr\">chroot_local_user</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#将所有用户看成虚拟用户guest</span></span><br><span class=\"line\"><span class=\"attr\">guest_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户，也就是将guest用户映射到virtual用户</span></span><br><span class=\"line\"><span class=\"attr\">guest_username</span>=virtual</span><br><span class=\"line\"><span class=\"comment\">#指定为独立服务</span></span><br><span class=\"line\"><span class=\"attr\">listen</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定监听的端口</span></span><br><span class=\"line\"><span class=\"attr\">listen_port</span>=<span class=\"number\">21</span></span><br><span class=\"line\"><span class=\"comment\">#开启被动模式</span></span><br><span class=\"line\"><span class=\"attr\">pasv_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#FTP服务器公网IP</span></span><br><span class=\"line\"><span class=\"attr\">pasv_address</span>=<span class=\"number\">120.79</span>.<span class=\"number\">93.66</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最小值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_min_port</span>=<span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最大值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_max_port</span>=<span class=\"number\">10088</span></span><br><span class=\"line\"><span class=\"comment\">#是否允许匿名用户下载全局可读的文件</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户配置文件的路径</span></span><br><span class=\"line\"><span class=\"attr\">user_config_dir</span>=/etc/vsftpd/user_conf</span><br></pre></td></tr></table></figure></p>\n<p>10 创建上面配置文件中指定的子配置文件目录 user_conf<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># mkdir /etc/vsftpd/user_conf</span></span><br></pre></td></tr></table></figure></p>\n<p>11 定义 ftpComeSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpComeSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/come</span><br></pre></td></tr></table></figure></p>\n<p>12 定义 ftpOutSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpOutSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/out</span><br></pre></td></tr></table></figure></p>\n<p>13 启动vsftpd<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># service vsftpd start</span></span><br></pre></td></tr></table></figure></p>\n<p>14 测试<br>…</p>\n"},{"title":"linux下解压windows上压缩rar包","date":"2019-04-30T05:48:55.000Z","copyright":true,"_content":"##### 下载\n``# wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz``\n##### 安装\n```\n# tar xvzf rarlinux-3.8.0.tar.gz\n# cd rar\n# make \n# make install\n```\n##### rar命令语法\n将 /etc 目录压缩为 etc.rar 命令为：\\\n``# rar a etc.rar /etc``\\\n将 etc.rar 解压 命令为：\\\n```\nrar x etc.rar\nunrar -e etc.rar\n```\n##### rar帮助手册\n```markdown\n# rar\n\nRAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008\nShareware version         Type RAR -? for help\n\nUsage:     rar <command> -<switch 1> -<switch N> <archive> <files...>\n               <@listfiles...> <path_to_extract\\>\n\n<Commands>\n  a             Add files to archive\n  c             Add archive comment\n  cf            Add files comment\n  ch            Change archive parameters\n  cw            Write archive comment to file\n  d             Delete files from archive\n  e             Extract files to current directory\n  f             Freshen files in archive\n  i[par]=<str>  Find string in archives\n  k             Lock archive\n  l[t,b]        List archive [technical, bare]\n  m[f]          Move to archive [files only]\n  p             Print file to stdout\n  r             Repair archive\n  rc            Reconstruct missing volumes\n  rn            Rename archived files\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[name|-]     Convert archive to or from SFX\n  t             Test archive files\n  u             Update files in archive\n  v[t,b]        Verbosely list archive [technical,bare]\n  x             Extract files with full path\n\n<Switches>\n  -             Stop switches scanning\n  ad            Append archive name to destination path\n  ag[format]    Generate archive name using the current date\n  ap<path>      Set path inside archive\n  as            Synchronize archive contents\n  av            Put authenticity verification (registered versions only)\n  av-           Disable authenticity verification check\n  c-            Disable comments show\n  cfg-          Disable read configuration\n  cl            Convert names to lower case\n  cu            Convert names to upper case\n  df            Delete files after archiving\n  dh            Open shared files\n  ds            Disable name sort for solid archive\n  dw            Wipe files after archiving\n  e[+]<attr>    Set file exclude and include attributes\n  ed            Do not add empty directories\n  en            Do not put 'end of archive' block\n  ep            Exclude paths from names\n  ep1           Exclude base directory from names\n  ep3           Expand paths to full including the drive letter\n  f             Freshen files\n  hp[password]  Encrypt both file data and headers\n  id[c,d,p,q]   Disable messages\n  ierr          Send all messages to stderr\n  ilog[name]    Log errors to file (registered versions only)\n  inul          Disable all messages\n  isnd          Enable sound\n  k             Lock archive\n  kb            Keep broken extracted files\n  m<0..5>       Set compression level (0-store...3-default...5-maximal)\n  mc<par>       Set advanced compression parameters\n  md<size>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)\n  ms[ext;ext]   Specify file types to store\n  n<file>       Include only specified file\n  n@            Read file names to include from stdin\n  n@<list>      Include files in specified list file\n  o[+|-]        Set the overwrite mode\n  ol            Save symbolic links as the link instead of the file\n  or            Rename files automatically\n  ow            Save or restore file owner and group\n  p[password]   Set password\n  p-            Do not query password\n  r             Recurse subdirectories\n  r0            Recurse subdirectories for wildcard names only\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[<N>,v[-],e] Create solid archive\n  s-            Disable solid archiving\n  sc<chr>[obj]  Specify the character set\n  sfx[name]     Create SFX archive\n  si[name]      Read data from standard input (stdin)\n  sl<size>      Process files with size less than specified\n  sm<size>      Process files with size more than specified\n  t             Test files after archiving\n  ta<date>      Process files modified after <date> in YYYYMMDDHHMMSS format\n  tb<date>      Process files modified before <date> in YYYYMMDDHHMMSS format\n  tk            Keep original archive time\n  tl            Set archive time to latest file\n  tn<time>      Process files newer than <time>\n  to<time>      Process files older than <time>\n  ts<m,c,a>[N]  Save or restore file time (modification, creation, access)\n  u             Update files\n  v             Create volumes with size autodetection or list all volumes\n  v<size>[k,b]  Create volumes with size=<size>*1000 [*1024, *1]\n  ver[n]        File version control\n  vn            Use the old style volume naming scheme\n  vp            Pause before each volume\n  w<path>       Assign work directory\n  x<file>       Exclude specified file\n  x@            Read file names to exclude from stdin\n  x@<list>      Exclude files in specified list file\n  y             Assume Yes on all queries\n  z[file]       Read archive comment from file\n```","source":"_posts/linux下解压windows上压缩rar包.md","raw":"---\ntitle: linux下解压windows上压缩rar包\ndate: 2019-04-30 13:48:55\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n##### 下载\n``# wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz``\n##### 安装\n```\n# tar xvzf rarlinux-3.8.0.tar.gz\n# cd rar\n# make \n# make install\n```\n##### rar命令语法\n将 /etc 目录压缩为 etc.rar 命令为：\\\n``# rar a etc.rar /etc``\\\n将 etc.rar 解压 命令为：\\\n```\nrar x etc.rar\nunrar -e etc.rar\n```\n##### rar帮助手册\n```markdown\n# rar\n\nRAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008\nShareware version         Type RAR -? for help\n\nUsage:     rar <command> -<switch 1> -<switch N> <archive> <files...>\n               <@listfiles...> <path_to_extract\\>\n\n<Commands>\n  a             Add files to archive\n  c             Add archive comment\n  cf            Add files comment\n  ch            Change archive parameters\n  cw            Write archive comment to file\n  d             Delete files from archive\n  e             Extract files to current directory\n  f             Freshen files in archive\n  i[par]=<str>  Find string in archives\n  k             Lock archive\n  l[t,b]        List archive [technical, bare]\n  m[f]          Move to archive [files only]\n  p             Print file to stdout\n  r             Repair archive\n  rc            Reconstruct missing volumes\n  rn            Rename archived files\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[name|-]     Convert archive to or from SFX\n  t             Test archive files\n  u             Update files in archive\n  v[t,b]        Verbosely list archive [technical,bare]\n  x             Extract files with full path\n\n<Switches>\n  -             Stop switches scanning\n  ad            Append archive name to destination path\n  ag[format]    Generate archive name using the current date\n  ap<path>      Set path inside archive\n  as            Synchronize archive contents\n  av            Put authenticity verification (registered versions only)\n  av-           Disable authenticity verification check\n  c-            Disable comments show\n  cfg-          Disable read configuration\n  cl            Convert names to lower case\n  cu            Convert names to upper case\n  df            Delete files after archiving\n  dh            Open shared files\n  ds            Disable name sort for solid archive\n  dw            Wipe files after archiving\n  e[+]<attr>    Set file exclude and include attributes\n  ed            Do not add empty directories\n  en            Do not put 'end of archive' block\n  ep            Exclude paths from names\n  ep1           Exclude base directory from names\n  ep3           Expand paths to full including the drive letter\n  f             Freshen files\n  hp[password]  Encrypt both file data and headers\n  id[c,d,p,q]   Disable messages\n  ierr          Send all messages to stderr\n  ilog[name]    Log errors to file (registered versions only)\n  inul          Disable all messages\n  isnd          Enable sound\n  k             Lock archive\n  kb            Keep broken extracted files\n  m<0..5>       Set compression level (0-store...3-default...5-maximal)\n  mc<par>       Set advanced compression parameters\n  md<size>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)\n  ms[ext;ext]   Specify file types to store\n  n<file>       Include only specified file\n  n@            Read file names to include from stdin\n  n@<list>      Include files in specified list file\n  o[+|-]        Set the overwrite mode\n  ol            Save symbolic links as the link instead of the file\n  or            Rename files automatically\n  ow            Save or restore file owner and group\n  p[password]   Set password\n  p-            Do not query password\n  r             Recurse subdirectories\n  r0            Recurse subdirectories for wildcard names only\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[<N>,v[-],e] Create solid archive\n  s-            Disable solid archiving\n  sc<chr>[obj]  Specify the character set\n  sfx[name]     Create SFX archive\n  si[name]      Read data from standard input (stdin)\n  sl<size>      Process files with size less than specified\n  sm<size>      Process files with size more than specified\n  t             Test files after archiving\n  ta<date>      Process files modified after <date> in YYYYMMDDHHMMSS format\n  tb<date>      Process files modified before <date> in YYYYMMDDHHMMSS format\n  tk            Keep original archive time\n  tl            Set archive time to latest file\n  tn<time>      Process files newer than <time>\n  to<time>      Process files older than <time>\n  ts<m,c,a>[N]  Save or restore file time (modification, creation, access)\n  u             Update files\n  v             Create volumes with size autodetection or list all volumes\n  v<size>[k,b]  Create volumes with size=<size>*1000 [*1024, *1]\n  ver[n]        File version control\n  vn            Use the old style volume naming scheme\n  vp            Pause before each volume\n  w<path>       Assign work directory\n  x<file>       Exclude specified file\n  x@            Read file names to exclude from stdin\n  x@<list>      Exclude files in specified list file\n  y             Assume Yes on all queries\n  z[file]       Read archive comment from file\n```","slug":"linux下解压windows上压缩rar包","published":1,"updated":"2019-04-30T06:15:10.476Z","_id":"cjxwlqrju000alctc1h6slfn1","comments":1,"layout":"post","photos":[],"link":"","content":"<h5 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h5><p><code># wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz</code></p>\n<h5 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h5><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># tar xvzf rarlinux-3.8.0.tar.gz</span></span><br><span class=\"line\"><span class=\"meta\"># cd rar</span></span><br><span class=\"line\"><span class=\"meta\"># make </span></span><br><span class=\"line\"><span class=\"meta\"># make install</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"rar命令语法\"><a href=\"#rar命令语法\" class=\"headerlink\" title=\"rar命令语法\"></a>rar命令语法</h5><p>将 /etc 目录压缩为 etc.rar 命令为：\\<br><code># rar a etc.rar /etc</code>\\<br>将 etc.rar 解压 命令为：\\<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">rar</span> <span class=\"selector-tag\">x</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br><span class=\"line\"><span class=\"selector-tag\">unrar</span> <span class=\"selector-tag\">-e</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br></pre></td></tr></table></figure></p>\n<h5 id=\"rar帮助手册\"><a href=\"#rar帮助手册\" class=\"headerlink\" title=\"rar帮助手册\"></a>rar帮助手册</h5><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># rar</span></span><br><span class=\"line\"></span><br><span class=\"line\">RAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008</span><br><span class=\"line\">Shareware version         Type RAR -? for help</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:     rar <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">command</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">1</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">N</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">archive</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">files...</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"code\">               &lt;@listfiles...&gt; &lt;path_to_extract\\&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Commands</span>&gt;</span></span></span><br><span class=\"line\">  a             Add files to archive</span><br><span class=\"line\">  c             Add archive comment</span><br><span class=\"line\">  cf            Add files comment</span><br><span class=\"line\">  ch            Change archive parameters</span><br><span class=\"line\">  cw            Write archive comment to file</span><br><span class=\"line\">  d             Delete files from archive</span><br><span class=\"line\">  e             Extract files to current directory</span><br><span class=\"line\">  f             Freshen files in archive</span><br><span class=\"line\">  i[par]=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">str</span>&gt;</span></span>  Find string in archives</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  l[t,b]        List archive [technical, bare]</span><br><span class=\"line\">  m[f]          Move to archive [files only]</span><br><span class=\"line\">  p             Print file to stdout</span><br><span class=\"line\">  r             Repair archive</span><br><span class=\"line\">  rc            Reconstruct missing volumes</span><br><span class=\"line\">  rn            Rename archived files</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[name|-]     Convert archive to or from SFX</span><br><span class=\"line\">  t             Test archive files</span><br><span class=\"line\">  u             Update files in archive</span><br><span class=\"line\">  v[t,b]        Verbosely list archive [technical,bare]</span><br><span class=\"line\">  x             Extract files with full path</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Switches</span>&gt;</span></span></span><br><span class=\"line\">  -             Stop switches scanning</span><br><span class=\"line\">  ad            Append archive name to destination path</span><br><span class=\"line\">  ag[format]    Generate archive name using the current date</span><br><span class=\"line\">  ap<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>      Set path inside archive</span><br><span class=\"line\">  as            Synchronize archive contents</span><br><span class=\"line\">  av            Put authenticity verification (registered versions only)</span><br><span class=\"line\">  av-           Disable authenticity verification check</span><br><span class=\"line\">  c-            Disable comments show</span><br><span class=\"line\">  cfg-          Disable read configuration</span><br><span class=\"line\">  cl            Convert names to lower case</span><br><span class=\"line\">  cu            Convert names to upper case</span><br><span class=\"line\">  df            Delete files after archiving</span><br><span class=\"line\">  dh            Open shared files</span><br><span class=\"line\">  ds            Disable name sort for solid archive</span><br><span class=\"line\">  dw            Wipe files after archiving</span><br><span class=\"line\">  e[+]<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">attr</span>&gt;</span></span>    Set file exclude and include attributes</span><br><span class=\"line\">  ed            Do not add empty directories</span><br><span class=\"line\">  en            Do not put 'end of archive' block</span><br><span class=\"line\">  ep            Exclude paths from names</span><br><span class=\"line\">  ep1           Exclude base directory from names</span><br><span class=\"line\">  ep3           Expand paths to full including the drive letter</span><br><span class=\"line\">  f             Freshen files</span><br><span class=\"line\">  hp[password]  Encrypt both file data and headers</span><br><span class=\"line\">  id[c,d,p,q]   Disable messages</span><br><span class=\"line\">  ierr          Send all messages to stderr</span><br><span class=\"line\">  ilog[name]    Log errors to file (registered versions only)</span><br><span class=\"line\">  inul          Disable all messages</span><br><span class=\"line\">  isnd          Enable sound</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  kb            Keep broken extracted files</span><br><span class=\"line\">  m<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">0..5</span>&gt;</span></span>       Set compression level (0-store...3-default...5-maximal)</span><br><span class=\"line\">  mc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">par</span>&gt;</span></span>       Set advanced compression parameters</span><br><span class=\"line\">  md<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)</span><br><span class=\"line\">  ms[ext;ext]   Specify file types to store</span><br><span class=\"line\">  n<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Include only specified file</span><br><span class=\"line\">  n@            Read file names to include from stdin</span><br><span class=\"line\">  n@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Include files in specified list file</span><br><span class=\"line\">  o[+|-]        Set the overwrite mode</span><br><span class=\"line\">  ol            Save symbolic links as the link instead of the file</span><br><span class=\"line\">  or            Rename files automatically</span><br><span class=\"line\">  ow            Save or restore file owner and group</span><br><span class=\"line\">  p[password]   Set password</span><br><span class=\"line\">  p-            Do not query password</span><br><span class=\"line\">  r             Recurse subdirectories</span><br><span class=\"line\">  r0            Recurse subdirectories for wildcard names only</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">N</span>&gt;</span></span>,v[-],e] Create solid archive</span><br><span class=\"line\">  s-            Disable solid archiving</span><br><span class=\"line\">  sc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">chr</span>&gt;</span></span>[obj]  Specify the character set</span><br><span class=\"line\">  sfx[name]     Create SFX archive</span><br><span class=\"line\">  si[name]      Read data from standard input (stdin)</span><br><span class=\"line\">  sl<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size less than specified</span><br><span class=\"line\">  sm<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size more than specified</span><br><span class=\"line\">  t             Test files after archiving</span><br><span class=\"line\">  ta<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified after <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tb<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified before <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tk            Keep original archive time</span><br><span class=\"line\">  tl            Set archive time to latest file</span><br><span class=\"line\">  tn<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files newer than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  to<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files older than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  ts<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">m,c,a</span>&gt;</span></span>[N]  Save or restore file time (modification, creation, access)</span><br><span class=\"line\">  u             Update files</span><br><span class=\"line\">  v             Create volumes with size autodetection or list all volumes</span><br><span class=\"line\">  v<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>[k,b]  Create volumes with size=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span><span class=\"emphasis\">*1000 [*</span>1024, *1]</span><br><span class=\"line\">  ver[n]        File version control</span><br><span class=\"line\">  vn            Use the old style volume naming scheme</span><br><span class=\"line\">  vp            Pause before each volume</span><br><span class=\"line\">  w<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>       Assign work directory</span><br><span class=\"line\">  x<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Exclude specified file</span><br><span class=\"line\">  x@            Read file names to exclude from stdin</span><br><span class=\"line\">  x@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Exclude files in specified list file</span><br><span class=\"line\">  y             Assume Yes on all queries</span><br><span class=\"line\">  z[file]       Read archive comment from file</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h5 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h5><p><code># wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz</code></p>\n<h5 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h5><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># tar xvzf rarlinux-3.8.0.tar.gz</span></span><br><span class=\"line\"><span class=\"meta\"># cd rar</span></span><br><span class=\"line\"><span class=\"meta\"># make </span></span><br><span class=\"line\"><span class=\"meta\"># make install</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"rar命令语法\"><a href=\"#rar命令语法\" class=\"headerlink\" title=\"rar命令语法\"></a>rar命令语法</h5><p>将 /etc 目录压缩为 etc.rar 命令为：\\<br><code># rar a etc.rar /etc</code>\\<br>将 etc.rar 解压 命令为：\\<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">rar</span> <span class=\"selector-tag\">x</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br><span class=\"line\"><span class=\"selector-tag\">unrar</span> <span class=\"selector-tag\">-e</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br></pre></td></tr></table></figure></p>\n<h5 id=\"rar帮助手册\"><a href=\"#rar帮助手册\" class=\"headerlink\" title=\"rar帮助手册\"></a>rar帮助手册</h5><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># rar</span></span><br><span class=\"line\"></span><br><span class=\"line\">RAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008</span><br><span class=\"line\">Shareware version         Type RAR -? for help</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:     rar <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">command</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">1</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">N</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">archive</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">files...</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"code\">               &lt;@listfiles...&gt; &lt;path_to_extract\\&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Commands</span>&gt;</span></span></span><br><span class=\"line\">  a             Add files to archive</span><br><span class=\"line\">  c             Add archive comment</span><br><span class=\"line\">  cf            Add files comment</span><br><span class=\"line\">  ch            Change archive parameters</span><br><span class=\"line\">  cw            Write archive comment to file</span><br><span class=\"line\">  d             Delete files from archive</span><br><span class=\"line\">  e             Extract files to current directory</span><br><span class=\"line\">  f             Freshen files in archive</span><br><span class=\"line\">  i[par]=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">str</span>&gt;</span></span>  Find string in archives</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  l[t,b]        List archive [technical, bare]</span><br><span class=\"line\">  m[f]          Move to archive [files only]</span><br><span class=\"line\">  p             Print file to stdout</span><br><span class=\"line\">  r             Repair archive</span><br><span class=\"line\">  rc            Reconstruct missing volumes</span><br><span class=\"line\">  rn            Rename archived files</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[name|-]     Convert archive to or from SFX</span><br><span class=\"line\">  t             Test archive files</span><br><span class=\"line\">  u             Update files in archive</span><br><span class=\"line\">  v[t,b]        Verbosely list archive [technical,bare]</span><br><span class=\"line\">  x             Extract files with full path</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Switches</span>&gt;</span></span></span><br><span class=\"line\">  -             Stop switches scanning</span><br><span class=\"line\">  ad            Append archive name to destination path</span><br><span class=\"line\">  ag[format]    Generate archive name using the current date</span><br><span class=\"line\">  ap<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>      Set path inside archive</span><br><span class=\"line\">  as            Synchronize archive contents</span><br><span class=\"line\">  av            Put authenticity verification (registered versions only)</span><br><span class=\"line\">  av-           Disable authenticity verification check</span><br><span class=\"line\">  c-            Disable comments show</span><br><span class=\"line\">  cfg-          Disable read configuration</span><br><span class=\"line\">  cl            Convert names to lower case</span><br><span class=\"line\">  cu            Convert names to upper case</span><br><span class=\"line\">  df            Delete files after archiving</span><br><span class=\"line\">  dh            Open shared files</span><br><span class=\"line\">  ds            Disable name sort for solid archive</span><br><span class=\"line\">  dw            Wipe files after archiving</span><br><span class=\"line\">  e[+]<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">attr</span>&gt;</span></span>    Set file exclude and include attributes</span><br><span class=\"line\">  ed            Do not add empty directories</span><br><span class=\"line\">  en            Do not put 'end of archive' block</span><br><span class=\"line\">  ep            Exclude paths from names</span><br><span class=\"line\">  ep1           Exclude base directory from names</span><br><span class=\"line\">  ep3           Expand paths to full including the drive letter</span><br><span class=\"line\">  f             Freshen files</span><br><span class=\"line\">  hp[password]  Encrypt both file data and headers</span><br><span class=\"line\">  id[c,d,p,q]   Disable messages</span><br><span class=\"line\">  ierr          Send all messages to stderr</span><br><span class=\"line\">  ilog[name]    Log errors to file (registered versions only)</span><br><span class=\"line\">  inul          Disable all messages</span><br><span class=\"line\">  isnd          Enable sound</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  kb            Keep broken extracted files</span><br><span class=\"line\">  m<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">0..5</span>&gt;</span></span>       Set compression level (0-store...3-default...5-maximal)</span><br><span class=\"line\">  mc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">par</span>&gt;</span></span>       Set advanced compression parameters</span><br><span class=\"line\">  md<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)</span><br><span class=\"line\">  ms[ext;ext]   Specify file types to store</span><br><span class=\"line\">  n<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Include only specified file</span><br><span class=\"line\">  n@            Read file names to include from stdin</span><br><span class=\"line\">  n@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Include files in specified list file</span><br><span class=\"line\">  o[+|-]        Set the overwrite mode</span><br><span class=\"line\">  ol            Save symbolic links as the link instead of the file</span><br><span class=\"line\">  or            Rename files automatically</span><br><span class=\"line\">  ow            Save or restore file owner and group</span><br><span class=\"line\">  p[password]   Set password</span><br><span class=\"line\">  p-            Do not query password</span><br><span class=\"line\">  r             Recurse subdirectories</span><br><span class=\"line\">  r0            Recurse subdirectories for wildcard names only</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">N</span>&gt;</span></span>,v[-],e] Create solid archive</span><br><span class=\"line\">  s-            Disable solid archiving</span><br><span class=\"line\">  sc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">chr</span>&gt;</span></span>[obj]  Specify the character set</span><br><span class=\"line\">  sfx[name]     Create SFX archive</span><br><span class=\"line\">  si[name]      Read data from standard input (stdin)</span><br><span class=\"line\">  sl<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size less than specified</span><br><span class=\"line\">  sm<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size more than specified</span><br><span class=\"line\">  t             Test files after archiving</span><br><span class=\"line\">  ta<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified after <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tb<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified before <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tk            Keep original archive time</span><br><span class=\"line\">  tl            Set archive time to latest file</span><br><span class=\"line\">  tn<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files newer than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  to<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files older than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  ts<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">m,c,a</span>&gt;</span></span>[N]  Save or restore file time (modification, creation, access)</span><br><span class=\"line\">  u             Update files</span><br><span class=\"line\">  v             Create volumes with size autodetection or list all volumes</span><br><span class=\"line\">  v<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>[k,b]  Create volumes with size=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span><span class=\"emphasis\">*1000 [*</span>1024, *1]</span><br><span class=\"line\">  ver[n]        File version control</span><br><span class=\"line\">  vn            Use the old style volume naming scheme</span><br><span class=\"line\">  vp            Pause before each volume</span><br><span class=\"line\">  w<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>       Assign work directory</span><br><span class=\"line\">  x<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Exclude specified file</span><br><span class=\"line\">  x@            Read file names to exclude from stdin</span><br><span class=\"line\">  x@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Exclude files in specified list file</span><br><span class=\"line\">  y             Assume Yes on all queries</span><br><span class=\"line\">  z[file]       Read archive comment from file</span><br></pre></td></tr></table></figure>"},{"title":"linux保存history到日志文件","date":"2019-05-22T08:30:09.000Z","copyright":true,"_content":">在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑`/etc/bashrc`文件记录历史命令到日志文件下面，并已登录来源`IP`，登录用户名，登录时间命名日志文件名字\n\n##### 查看默认的history\n![默认的history](https://upload-images.jianshu.io/upload_images/11763553-a2f73d6c0783224d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n##### 编辑/etc/bashrc\n编辑`/etc/bashrc`文件，加入以下内容，也可以放在`/etc/profile`文件里\n```\n# vim /etc/bashrc\nUSER_IP=$(echo -e \"\\033[31m\\033[1m`who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g'`\\033[0m\")\nIP=$(who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g')\nUSER=$(whoami)\nUSER_NAME=`echo -e \"\\033[36m\\033[1m$(whoami) \\033[0m\"`\nHISTFILESIZE=100000\nHISTSIZE=4096\nHISTTIMEFORMAT=\"%F %T  $USER_IP  $USER_NAME  \"\nif [ \"$USER_IP\" = \"\" ]\nthen\n   USER_IP=`hostname`\nfi\n\nif [ ! -d /var/log/history ]\nthen\n   mkdir /var/log/history\n   chmod 777 /var/log/history\nfi\n\nif [ ! -d /var/log/history/${LOGNAME} ]\nthen\n    mkdir /var/log/history/${LOGNAME}\n    chmod 300 /var/log/history/${LOGNAME}\nfi\nDT=`date \"+%Y%m%d_%H%M\"`\nexport HISTFILE=\"/var/log/history/${LOGNAME}/${DT}_${USER}_${IP}\"\nchmod 600 /var/log/history/${LOGNAME}/* 2>/dev/null\n```\n退出重新登录再次查看\n![](https://upload-images.jianshu.io/upload_images/11763553-dad4faed53395912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n查看前面保留的历史记录日志\n```\n[root@salt-master ~]# ll /var/log/history/\n总用量 0\nd-wx------. 2 root root 6 5月  22 14:27 root\n\n[root@salt-master ~]# ll /var/log/history/root/\n总用量 4\n-rw-------. 1 root root 123 5月  22 14:29 20190522_1427_root_192.168.1.123\n\n[root@salt-master ~]# cat /var/log/history/root/20190522_1427_root_192.168.1.123 \n#1558506461\nls\n#1558506467\nhistory\n#1558506519\nll /var/log/history/\n#1558506571\nll /var/log/history/root/\n#1558506574\nexit\n```","source":"_posts/linux保存history到日志文件.md","raw":"---\ntitle: linux保存history到日志文件\ndate: 2019-05-22 16:30:09\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n>在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑`/etc/bashrc`文件记录历史命令到日志文件下面，并已登录来源`IP`，登录用户名，登录时间命名日志文件名字\n\n##### 查看默认的history\n![默认的history](https://upload-images.jianshu.io/upload_images/11763553-a2f73d6c0783224d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n##### 编辑/etc/bashrc\n编辑`/etc/bashrc`文件，加入以下内容，也可以放在`/etc/profile`文件里\n```\n# vim /etc/bashrc\nUSER_IP=$(echo -e \"\\033[31m\\033[1m`who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g'`\\033[0m\")\nIP=$(who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g')\nUSER=$(whoami)\nUSER_NAME=`echo -e \"\\033[36m\\033[1m$(whoami) \\033[0m\"`\nHISTFILESIZE=100000\nHISTSIZE=4096\nHISTTIMEFORMAT=\"%F %T  $USER_IP  $USER_NAME  \"\nif [ \"$USER_IP\" = \"\" ]\nthen\n   USER_IP=`hostname`\nfi\n\nif [ ! -d /var/log/history ]\nthen\n   mkdir /var/log/history\n   chmod 777 /var/log/history\nfi\n\nif [ ! -d /var/log/history/${LOGNAME} ]\nthen\n    mkdir /var/log/history/${LOGNAME}\n    chmod 300 /var/log/history/${LOGNAME}\nfi\nDT=`date \"+%Y%m%d_%H%M\"`\nexport HISTFILE=\"/var/log/history/${LOGNAME}/${DT}_${USER}_${IP}\"\nchmod 600 /var/log/history/${LOGNAME}/* 2>/dev/null\n```\n退出重新登录再次查看\n![](https://upload-images.jianshu.io/upload_images/11763553-dad4faed53395912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n查看前面保留的历史记录日志\n```\n[root@salt-master ~]# ll /var/log/history/\n总用量 0\nd-wx------. 2 root root 6 5月  22 14:27 root\n\n[root@salt-master ~]# ll /var/log/history/root/\n总用量 4\n-rw-------. 1 root root 123 5月  22 14:29 20190522_1427_root_192.168.1.123\n\n[root@salt-master ~]# cat /var/log/history/root/20190522_1427_root_192.168.1.123 \n#1558506461\nls\n#1558506467\nhistory\n#1558506519\nll /var/log/history/\n#1558506571\nll /var/log/history/root/\n#1558506574\nexit\n```","slug":"linux保存history到日志文件","published":1,"updated":"2019-05-22T13:07:59.030Z","_id":"cjxwlqrk0000clctca2p7ixnr","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑<code>/etc/bashrc</code>文件记录历史命令到日志文件下面，并已登录来源<code>IP</code>，登录用户名，登录时间命名日志文件名字</p>\n</blockquote>\n<h5 id=\"查看默认的history\"><a href=\"#查看默认的history\" class=\"headerlink\" title=\"查看默认的history\"></a>查看默认的history</h5><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-a2f73d6c0783224d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"默认的history\"></p>\n<h5 id=\"编辑-etc-bashrc\"><a href=\"#编辑-etc-bashrc\" class=\"headerlink\" title=\"编辑/etc/bashrc\"></a>编辑/etc/bashrc</h5><p>编辑<code>/etc/bashrc</code>文件，加入以下内容，也可以放在<code>/etc/profile</code>文件里<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/bashrc</span></span><br><span class=\"line\">USER_IP=$(<span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\033[31m\\033[1m`who -u am i 2&gt;/dev/null| awk '&#123;print <span class=\"variable\">$NF</span>&#125;'|sed -e 's/[()]//g'`\\033[0m\"</span>)</span><br><span class=\"line\">IP=$(who -u am i 2&gt;/dev/null| awk <span class=\"string\">'&#123;print $NF&#125;'</span>|sed -e <span class=\"string\">'s/[()]//g'</span>)</span><br><span class=\"line\">USER=$(whoami)</span><br><span class=\"line\">USER_NAME=`<span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\033[36m\\033[1m<span class=\"variable\">$(whoami)</span> \\033[0m\"</span>`</span><br><span class=\"line\">HISTFILESIZE=100000</span><br><span class=\"line\">HISTSIZE=4096</span><br><span class=\"line\">HISTTIMEFORMAT=<span class=\"string\">\"%F %T  <span class=\"variable\">$USER_IP</span>  <span class=\"variable\">$USER_NAME</span>  \"</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$USER_IP</span>\"</span> = <span class=\"string\">\"\"</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">   USER_IP=`hostname`</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ ! -d /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">   mkdir /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span></span><br><span class=\"line\">   chmod 777 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ ! -d /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">    mkdir /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span></span><br><span class=\"line\">    chmod 300 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">DT=`date <span class=\"string\">\"+%Y%m%d_%H%M\"</span>`</span><br><span class=\"line\"><span class=\"built_in\">export</span> HISTFILE=<span class=\"string\">\"/var/log/history/<span class=\"variable\">$&#123;LOGNAME&#125;</span>/<span class=\"variable\">$&#123;DT&#125;</span>_<span class=\"variable\">$&#123;USER&#125;</span>_<span class=\"variable\">$&#123;IP&#125;</span>\"</span></span><br><span class=\"line\">chmod 600 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span>/* 2&gt;/dev/null</span><br></pre></td></tr></table></figure></p>\n<p>退出重新登录再次查看<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-dad4faed53395912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt><br>查看前面保留的历史记录日志<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/</span><br><span class=\"line\">总用量 <span class=\"number\">0</span></span><br><span class=\"line\">d-wx------. <span class=\"number\">2</span> root root <span class=\"number\">6</span> <span class=\"number\">5</span>月  <span class=\"number\">22</span> <span class=\"number\">14</span>:<span class=\"number\">27</span> root</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/</span><br><span class=\"line\">总用量 <span class=\"number\">4</span></span><br><span class=\"line\">-rw-------. <span class=\"number\">1</span> root root <span class=\"number\">123</span> <span class=\"number\">5</span>月  <span class=\"number\">22</span> <span class=\"number\">14</span>:<span class=\"number\">29</span> <span class=\"number\">20190522</span>_1427_root_192.<span class=\"number\">168.1</span>.<span class=\"number\">123</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/<span class=\"number\">20190522</span>_1427_root_192.<span class=\"number\">168.1</span>.<span class=\"number\">123</span> </span><br><span class=\"line\">#<span class=\"number\">1558506461</span></span><br><span class=\"line\"><span class=\"keyword\">ls</span></span><br><span class=\"line\">#<span class=\"number\">1558506467</span></span><br><span class=\"line\"><span class=\"keyword\">history</span></span><br><span class=\"line\">#<span class=\"number\">1558506519</span></span><br><span class=\"line\"><span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/</span><br><span class=\"line\">#<span class=\"number\">1558506571</span></span><br><span class=\"line\"><span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/</span><br><span class=\"line\">#<span class=\"number\">1558506574</span></span><br><span class=\"line\"><span class=\"keyword\">exit</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑<code>/etc/bashrc</code>文件记录历史命令到日志文件下面，并已登录来源<code>IP</code>，登录用户名，登录时间命名日志文件名字</p>\n</blockquote>\n<h5 id=\"查看默认的history\"><a href=\"#查看默认的history\" class=\"headerlink\" title=\"查看默认的history\"></a>查看默认的history</h5><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-a2f73d6c0783224d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"默认的history\"></p>\n<h5 id=\"编辑-etc-bashrc\"><a href=\"#编辑-etc-bashrc\" class=\"headerlink\" title=\"编辑/etc/bashrc\"></a>编辑/etc/bashrc</h5><p>编辑<code>/etc/bashrc</code>文件，加入以下内容，也可以放在<code>/etc/profile</code>文件里<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/bashrc</span></span><br><span class=\"line\">USER_IP=$(<span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\033[31m\\033[1m`who -u am i 2&gt;/dev/null| awk '&#123;print <span class=\"variable\">$NF</span>&#125;'|sed -e 's/[()]//g'`\\033[0m\"</span>)</span><br><span class=\"line\">IP=$(who -u am i 2&gt;/dev/null| awk <span class=\"string\">'&#123;print $NF&#125;'</span>|sed -e <span class=\"string\">'s/[()]//g'</span>)</span><br><span class=\"line\">USER=$(whoami)</span><br><span class=\"line\">USER_NAME=`<span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\033[36m\\033[1m<span class=\"variable\">$(whoami)</span> \\033[0m\"</span>`</span><br><span class=\"line\">HISTFILESIZE=100000</span><br><span class=\"line\">HISTSIZE=4096</span><br><span class=\"line\">HISTTIMEFORMAT=<span class=\"string\">\"%F %T  <span class=\"variable\">$USER_IP</span>  <span class=\"variable\">$USER_NAME</span>  \"</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$USER_IP</span>\"</span> = <span class=\"string\">\"\"</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">   USER_IP=`hostname`</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ ! -d /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">   mkdir /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span></span><br><span class=\"line\">   chmod 777 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ ! -d /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">    mkdir /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span></span><br><span class=\"line\">    chmod 300 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">DT=`date <span class=\"string\">\"+%Y%m%d_%H%M\"</span>`</span><br><span class=\"line\"><span class=\"built_in\">export</span> HISTFILE=<span class=\"string\">\"/var/log/history/<span class=\"variable\">$&#123;LOGNAME&#125;</span>/<span class=\"variable\">$&#123;DT&#125;</span>_<span class=\"variable\">$&#123;USER&#125;</span>_<span class=\"variable\">$&#123;IP&#125;</span>\"</span></span><br><span class=\"line\">chmod 600 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span>/* 2&gt;/dev/null</span><br></pre></td></tr></table></figure></p>\n<p>退出重新登录再次查看<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-dad4faed53395912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt><br>查看前面保留的历史记录日志<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/</span><br><span class=\"line\">总用量 <span class=\"number\">0</span></span><br><span class=\"line\">d-wx------. <span class=\"number\">2</span> root root <span class=\"number\">6</span> <span class=\"number\">5</span>月  <span class=\"number\">22</span> <span class=\"number\">14</span>:<span class=\"number\">27</span> root</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/</span><br><span class=\"line\">总用量 <span class=\"number\">4</span></span><br><span class=\"line\">-rw-------. <span class=\"number\">1</span> root root <span class=\"number\">123</span> <span class=\"number\">5</span>月  <span class=\"number\">22</span> <span class=\"number\">14</span>:<span class=\"number\">29</span> <span class=\"number\">20190522</span>_1427_root_192.<span class=\"number\">168.1</span>.<span class=\"number\">123</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/<span class=\"number\">20190522</span>_1427_root_192.<span class=\"number\">168.1</span>.<span class=\"number\">123</span> </span><br><span class=\"line\">#<span class=\"number\">1558506461</span></span><br><span class=\"line\"><span class=\"keyword\">ls</span></span><br><span class=\"line\">#<span class=\"number\">1558506467</span></span><br><span class=\"line\"><span class=\"keyword\">history</span></span><br><span class=\"line\">#<span class=\"number\">1558506519</span></span><br><span class=\"line\"><span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/</span><br><span class=\"line\">#<span class=\"number\">1558506571</span></span><br><span class=\"line\"><span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/</span><br><span class=\"line\">#<span class=\"number\">1558506574</span></span><br><span class=\"line\"><span class=\"keyword\">exit</span></span><br></pre></td></tr></table></figure></p>\n"},{"title":"phpMyAdmin搭建","date":"2019-04-26T07:30:09.000Z","copyright":true,"_content":"##### 在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\n\n- 下载phpMyAdmin\n官网地址：https://www.phpmyadmin.net/\n\n- 上传到服务器进行安装\n```html\n# unzip phpMyAdmin-4.8.5-all-languages.zip\n# mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin\n# chown apache. /opt/phpMyAdmin\n```\n- 编辑配置文件 config.default.php\n```\n# vim /opt/phpMyAdmin/libraries/config.default.php\n$cfg['Servers'][$i]['host'] = '130.39.113.45';\n$cfg['Servers'][$i]['port'] = '3306';\n$cfg['Servers'][$i]['socket'] = 'socket';\n$cfg['Servers'][$i]['user'] = 'tj_court';\n$cfg['Servers'][$i]['password'] = 'AigheiguSh4eesh0eey8';\n```\n- 配置nginx站点\n```html\n# vim phpMyAdmin.conf\nserver {\n    listen       80;\n    server_name  www.phpadmin.com;\n    autoindex off;\n\n    error_log  logs/phpadmin_error.log error;\n    access_log logs/phpadmin_access.log main;\n\n    location / {\n    root /opt/phpMyAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n- 配置完成后启动nginx访问配置的域名进行连接\n![](phpMyAdmin搭建/4.png)\n![](phpMyAdmin搭建/6.png)\n\n","source":"_posts/phpMyAdmin搭建.md","raw":"---\ntitle: phpMyAdmin搭建\ndate: 2019-04-26 15:30:09\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n##### 在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\n\n- 下载phpMyAdmin\n官网地址：https://www.phpmyadmin.net/\n\n- 上传到服务器进行安装\n```html\n# unzip phpMyAdmin-4.8.5-all-languages.zip\n# mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin\n# chown apache. /opt/phpMyAdmin\n```\n- 编辑配置文件 config.default.php\n```\n# vim /opt/phpMyAdmin/libraries/config.default.php\n$cfg['Servers'][$i]['host'] = '130.39.113.45';\n$cfg['Servers'][$i]['port'] = '3306';\n$cfg['Servers'][$i]['socket'] = 'socket';\n$cfg['Servers'][$i]['user'] = 'tj_court';\n$cfg['Servers'][$i]['password'] = 'AigheiguSh4eesh0eey8';\n```\n- 配置nginx站点\n```html\n# vim phpMyAdmin.conf\nserver {\n    listen       80;\n    server_name  www.phpadmin.com;\n    autoindex off;\n\n    error_log  logs/phpadmin_error.log error;\n    access_log logs/phpadmin_access.log main;\n\n    location / {\n    root /opt/phpMyAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n- 配置完成后启动nginx访问配置的域名进行连接\n![](phpMyAdmin搭建/4.png)\n![](phpMyAdmin搭建/6.png)\n\n","slug":"phpMyAdmin搭建","published":1,"updated":"2019-05-17T13:23:21.439Z","_id":"cjxwlqrka000glctco5k5uoqg","comments":1,"layout":"post","photos":[],"link":"","content":"<h5 id=\"在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\"><a href=\"#在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\" class=\"headerlink\" title=\"在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\"></a>在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。</h5><ul>\n<li><p>下载phpMyAdmin<br>官网地址：<a href=\"https://www.phpmyadmin.net/\" target=\"_blank\" rel=\"noopener\">https://www.phpmyadmin.net/</a></p>\n</li>\n<li><p>上传到服务器进行安装</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># unzip phpMyAdmin-4.8.5-all-languages.zip</span><br><span class=\"line\"># mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin</span><br><span class=\"line\"># chown apache. /opt/phpMyAdmin</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>编辑配置文件 config.default.php</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># vim /opt/phpMyAdmin/libraries/config.default.php</span></span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'host'</span>] = '130.39.113.45';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'port'</span>] = '3306';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'socket'</span>] = 'socket';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'user'</span>] = 'tj_court';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'password'</span>] = 'AigheiguSh4eesh0eey8';</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置nginx站点</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># vim phpMyAdmin.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  www.phpadmin.com;</span><br><span class=\"line\">    autoindex off;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_log  logs/phpadmin_error.log error;</span><br><span class=\"line\">    access_log logs/phpadmin_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">    root /opt/phpMyAdmin;</span><br><span class=\"line\">        index  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fastcgi_intercept_errors on;</span><br><span class=\"line\">    error_page  404             /404.html;</span><br><span class=\"line\">    location ~ \\.php$ &#123;</span><br><span class=\"line\">        root           html;</span><br><span class=\"line\">        fastcgi_pass   127.0.0.1:9000;</span><br><span class=\"line\">        fastcgi_index  index.php;</span><br><span class=\"line\">        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;</span><br><span class=\"line\">        include        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location ~ /\\. &#123;</span><br><span class=\"line\">        deny all;</span><br><span class=\"line\">        error_page  403             /404.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置完成后启动nginx访问配置的域名进行连接<br><img src=\"/2019/04/26/phpMyAdmin搭建/4.png\" alt><br><img src=\"/2019/04/26/phpMyAdmin搭建/6.png\" alt></p>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h5 id=\"在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\"><a href=\"#在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\" class=\"headerlink\" title=\"在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\"></a>在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。</h5><ul>\n<li><p>下载phpMyAdmin<br>官网地址：<a href=\"https://www.phpmyadmin.net/\" target=\"_blank\" rel=\"noopener\">https://www.phpmyadmin.net/</a></p>\n</li>\n<li><p>上传到服务器进行安装</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># unzip phpMyAdmin-4.8.5-all-languages.zip</span><br><span class=\"line\"># mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin</span><br><span class=\"line\"># chown apache. /opt/phpMyAdmin</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>编辑配置文件 config.default.php</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># vim /opt/phpMyAdmin/libraries/config.default.php</span></span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'host'</span>] = '130.39.113.45';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'port'</span>] = '3306';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'socket'</span>] = 'socket';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'user'</span>] = 'tj_court';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'password'</span>] = 'AigheiguSh4eesh0eey8';</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置nginx站点</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># vim phpMyAdmin.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  www.phpadmin.com;</span><br><span class=\"line\">    autoindex off;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_log  logs/phpadmin_error.log error;</span><br><span class=\"line\">    access_log logs/phpadmin_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">    root /opt/phpMyAdmin;</span><br><span class=\"line\">        index  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fastcgi_intercept_errors on;</span><br><span class=\"line\">    error_page  404             /404.html;</span><br><span class=\"line\">    location ~ \\.php$ &#123;</span><br><span class=\"line\">        root           html;</span><br><span class=\"line\">        fastcgi_pass   127.0.0.1:9000;</span><br><span class=\"line\">        fastcgi_index  index.php;</span><br><span class=\"line\">        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;</span><br><span class=\"line\">        include        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location ~ /\\. &#123;</span><br><span class=\"line\">        deny all;</span><br><span class=\"line\">        error_page  403             /404.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置完成后启动nginx访问配置的域名进行连接<br><img src=\"/2019/04/26/phpMyAdmin搭建/4.png\" alt><br><img src=\"/2019/04/26/phpMyAdmin搭建/6.png\" alt></p>\n</li>\n</ul>\n"},{"title":"phpRedisAdmin搭建","date":"2019-04-26T08:30:09.000Z","copyright":true,"_content":">在已有的` lnmp` 环境下搭建 `phpRedisAdmin` 由于服务器做了限制，隧道端口转发等都不能使用，导致 `RedisDesktopManager` 管理工具不能使用，只能通过 `phpRedisAdmin`来进行管理了。\n\n1）下载软件\n```\n# git clone https://github.com/ErikDubbelboer/phpRedisAdmin.git\n# cd phpRedisAdmin\n# git clone https://github.com/nrk/predis.git vendor\n```\n2）放置到`web`站点目录\n```\n# cd ..\n# mv phpRedisAdmin /opt/\n# chown apache.apache phpRedisAdmin/ -R\n```\n3）编辑`nginx`配置文件\n```\n# vim phpRedisAdmin.conf\nserver {\n    listen       80;\n    server_name  www.redis.com;\n    autoindex off;\n\n    error_log  logs/redis_error.log error;\n    access_log logs/redis_access.log main;\n\n    location / {\n    root /opt/phpRedisAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpRedisAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n4）配置连接管理，默认连接的是`6379`端口\n```\n# vim /opt/phpRedisAdmin/includes/config.sample.inc.php\n$config = array(\n  'servers' => array(\n    array(\n      'name'   => 'local server', // Optional name.\n      'host'   => '127.0.0.1',\n      'port'   => 6395,\n      'filter' => '*',\n      'scheme' => 'tcp', // Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket\n      'path'   => '', // Optional. Path to unix domain socket. Uses only if 'scheme' => 'unix'. Example: '/var/run/redis/redis.sock'\n      'auth' => 'jieg6uy5Dach0yooxo1l' // Warning: The password is sent in plain-text to the Redis server.\n    ),\n```\n5）`windows`添加`host`然后访问 `http://www.redis.com`\n![](https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n\n","source":"_posts/phpRedisAdmin搭建.md","raw":"---\ntitle: phpRedisAdmin搭建\ndate: 2019-04-26 16:30:09\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n>在已有的` lnmp` 环境下搭建 `phpRedisAdmin` 由于服务器做了限制，隧道端口转发等都不能使用，导致 `RedisDesktopManager` 管理工具不能使用，只能通过 `phpRedisAdmin`来进行管理了。\n\n1）下载软件\n```\n# git clone https://github.com/ErikDubbelboer/phpRedisAdmin.git\n# cd phpRedisAdmin\n# git clone https://github.com/nrk/predis.git vendor\n```\n2）放置到`web`站点目录\n```\n# cd ..\n# mv phpRedisAdmin /opt/\n# chown apache.apache phpRedisAdmin/ -R\n```\n3）编辑`nginx`配置文件\n```\n# vim phpRedisAdmin.conf\nserver {\n    listen       80;\n    server_name  www.redis.com;\n    autoindex off;\n\n    error_log  logs/redis_error.log error;\n    access_log logs/redis_access.log main;\n\n    location / {\n    root /opt/phpRedisAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpRedisAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n4）配置连接管理，默认连接的是`6379`端口\n```\n# vim /opt/phpRedisAdmin/includes/config.sample.inc.php\n$config = array(\n  'servers' => array(\n    array(\n      'name'   => 'local server', // Optional name.\n      'host'   => '127.0.0.1',\n      'port'   => 6395,\n      'filter' => '*',\n      'scheme' => 'tcp', // Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket\n      'path'   => '', // Optional. Path to unix domain socket. Uses only if 'scheme' => 'unix'. Example: '/var/run/redis/redis.sock'\n      'auth' => 'jieg6uy5Dach0yooxo1l' // Warning: The password is sent in plain-text to the Redis server.\n    ),\n```\n5）`windows`添加`host`然后访问 `http://www.redis.com`\n![](https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n\n","slug":"phpRedisAdmin搭建","published":1,"updated":"2019-05-17T13:23:21.439Z","_id":"cjxwlqrkg000jlctc4avv1a70","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>在已有的<code>lnmp</code> 环境下搭建 <code>phpRedisAdmin</code> 由于服务器做了限制，隧道端口转发等都不能使用，导致 <code>RedisDesktopManager</code> 管理工具不能使用，只能通过 <code>phpRedisAdmin</code>来进行管理了。</p>\n</blockquote>\n<p>1）下载软件<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/ErikDubbelboer/phpRedisAdmin.git</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> <span class=\"built_in\">cd</span> phpRedisAdmin</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/nrk/predis.git vendor</span></span><br></pre></td></tr></table></figure></p>\n<p>2）放置到<code>web</code>站点目录<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># cd ..</span></span><br><span class=\"line\"><span class=\"meta\"># mv phpRedisAdmin /opt/</span></span><br><span class=\"line\"><span class=\"meta\"># chown apache.apache phpRedisAdmin/ -R</span></span><br></pre></td></tr></table></figure></p>\n<p>3）编辑<code>nginx</code>配置文件<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim phpRedisAdmin.conf</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span>  www.redis.com;</span><br><span class=\"line\">    <span class=\"attribute\">autoindex</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">error_log</span>  logs/redis_error.log <span class=\"literal\">error</span>;</span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> logs/redis_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /opt/phpRedisAdmin;</span><br><span class=\"line\">        <span class=\"attribute\">index</span>  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_intercept_errors</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">error_page</span>  <span class=\"number\">404</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ \\.php$</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span>           html;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_pass</span>   <span class=\"number\">127.0.0.1:9000</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_index</span>  index.php;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_param</span>  SCRIPT_FILENAME  /opt/phpRedisAdmin<span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">        <span class=\"attribute\">include</span>        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ /\\.</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">        <span class=\"attribute\">error_page</span>  <span class=\"number\">403</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>4）配置连接管理，默认连接的是<code>6379</code>端口<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /opt/phpRedisAdmin/includes/config.sample.inc.php</span></span><br><span class=\"line\">$config = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">  <span class=\"string\">'servers'</span> =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"keyword\">array</span>(</span><br><span class=\"line\">      <span class=\"string\">'name'</span>   =&gt; <span class=\"string\">'local server'</span>, <span class=\"comment\">// Optional name.</span></span><br><span class=\"line\">      <span class=\"string\">'host'</span>   =&gt; <span class=\"string\">'127.0.0.1'</span>,</span><br><span class=\"line\">      <span class=\"string\">'port'</span>   =&gt; <span class=\"number\">6395</span>,</span><br><span class=\"line\">      <span class=\"string\">'filter'</span> =&gt; <span class=\"string\">'*'</span>,</span><br><span class=\"line\">      <span class=\"string\">'scheme'</span> =&gt; <span class=\"string\">'tcp'</span>, <span class=\"comment\">// Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket</span></span><br><span class=\"line\">      <span class=\"string\">'path'</span>   =&gt; <span class=\"string\">''</span>, <span class=\"comment\">// Optional. Path to unix domain socket. Uses only if 'scheme' =&gt; 'unix'. Example: '/var/run/redis/redis.sock'</span></span><br><span class=\"line\">      <span class=\"string\">'auth'</span> =&gt; <span class=\"string\">'jieg6uy5Dach0yooxo1l'</span> <span class=\"comment\">// Warning: The password is sent in plain-text to the Redis server.</span></span><br><span class=\"line\">    ),</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>windows</code>添加<code>host</code>然后访问 <code>http://www.redis.com</code><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>在已有的<code>lnmp</code> 环境下搭建 <code>phpRedisAdmin</code> 由于服务器做了限制，隧道端口转发等都不能使用，导致 <code>RedisDesktopManager</code> 管理工具不能使用，只能通过 <code>phpRedisAdmin</code>来进行管理了。</p>\n</blockquote>\n<p>1）下载软件<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/ErikDubbelboer/phpRedisAdmin.git</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> <span class=\"built_in\">cd</span> phpRedisAdmin</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/nrk/predis.git vendor</span></span><br></pre></td></tr></table></figure></p>\n<p>2）放置到<code>web</code>站点目录<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># cd ..</span></span><br><span class=\"line\"><span class=\"meta\"># mv phpRedisAdmin /opt/</span></span><br><span class=\"line\"><span class=\"meta\"># chown apache.apache phpRedisAdmin/ -R</span></span><br></pre></td></tr></table></figure></p>\n<p>3）编辑<code>nginx</code>配置文件<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim phpRedisAdmin.conf</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span>  www.redis.com;</span><br><span class=\"line\">    <span class=\"attribute\">autoindex</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">error_log</span>  logs/redis_error.log <span class=\"literal\">error</span>;</span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> logs/redis_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /opt/phpRedisAdmin;</span><br><span class=\"line\">        <span class=\"attribute\">index</span>  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_intercept_errors</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">error_page</span>  <span class=\"number\">404</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ \\.php$</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span>           html;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_pass</span>   <span class=\"number\">127.0.0.1:9000</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_index</span>  index.php;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_param</span>  SCRIPT_FILENAME  /opt/phpRedisAdmin<span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">        <span class=\"attribute\">include</span>        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ /\\.</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">        <span class=\"attribute\">error_page</span>  <span class=\"number\">403</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>4）配置连接管理，默认连接的是<code>6379</code>端口<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /opt/phpRedisAdmin/includes/config.sample.inc.php</span></span><br><span class=\"line\">$config = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">  <span class=\"string\">'servers'</span> =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"keyword\">array</span>(</span><br><span class=\"line\">      <span class=\"string\">'name'</span>   =&gt; <span class=\"string\">'local server'</span>, <span class=\"comment\">// Optional name.</span></span><br><span class=\"line\">      <span class=\"string\">'host'</span>   =&gt; <span class=\"string\">'127.0.0.1'</span>,</span><br><span class=\"line\">      <span class=\"string\">'port'</span>   =&gt; <span class=\"number\">6395</span>,</span><br><span class=\"line\">      <span class=\"string\">'filter'</span> =&gt; <span class=\"string\">'*'</span>,</span><br><span class=\"line\">      <span class=\"string\">'scheme'</span> =&gt; <span class=\"string\">'tcp'</span>, <span class=\"comment\">// Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket</span></span><br><span class=\"line\">      <span class=\"string\">'path'</span>   =&gt; <span class=\"string\">''</span>, <span class=\"comment\">// Optional. Path to unix domain socket. Uses only if 'scheme' =&gt; 'unix'. Example: '/var/run/redis/redis.sock'</span></span><br><span class=\"line\">      <span class=\"string\">'auth'</span> =&gt; <span class=\"string\">'jieg6uy5Dach0yooxo1l'</span> <span class=\"comment\">// Warning: The password is sent in plain-text to the Redis server.</span></span><br><span class=\"line\">    ),</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>windows</code>添加<code>host</code>然后访问 <code>http://www.redis.com</code><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n"},{"title":"saltstack使用salt-ssh","date":"2019-05-20T01:43:05.000Z","copyright":true,"_content":"## salt-ssh 介绍\n[参考官档](https://docs.saltstack.com/en/latest/topics/ssh/index.html)\n>`salt-ssh`是 `0.17.0` 新引入的一个功能，不需要minion对客户端进行管理，也可以不需要`master`；`salt-ssh`也支持`salt`大部分的功能：比如`grains`,`modules`,`state`等；`salt-ssh`没有使用`ZeroMQ`的通信架构，执行是串行模式\n\n## salt-ssh执行原理\n>- `salt-ssh`是在`salt`基础上打了一个`python`包上传到客户端的默认`tmp`目录下, 在客户端上面解压并执行返回结果,最后删除`tmp`上传的临时文件。\n>- `salt-minion`方法是`salt-mater`先执行语法验证，验证通过后发送到`minion`，`minion`收到`Msater`的状态文件默认保存在`/var/cache/salt/minion`\n>- `salt-ssh`和`salt-minion`可以共存，`salt-minion`不依赖于`ssh`服务\n\n\n## 安装配置\n1）安装`salt-ssh`\n```\n[root@salt-master ~]# yum -y install salt-ssh\n```\n2）修改`roster`文件，配置需要管理的机器\n```\n[root@salt-master ~]# vim /etc/salt/roster\nsalt-minion01:\n  host: 192.168.1.31\n  user: root\n  passwd: 123456\n  port: 22\n\nsalt-minion02:\n  host: 192.168.1.32\n  user: root\n  passwd: 123456\n  port: 22\n```\n3）管理测试 (说明，如果第一次需要输入`yes或no`进行`ssh`认证，可以加`-i`参数自动认证)\n```\n[root@salt-master ~]# salt-ssh '*' test.ping -i\nsalt-minion01:\n    True\nsalt-minion02:\n    True\n```\n4）`salt-ssh`命令参数\n```\n-r, –raw, –raw-shell # 直接使用shell命令\n–priv #指定SSH私有密钥文件\n–roster #定义使用哪个roster系统，如果定义了一个后端数据库，扫描方式，或者用户自定义的的roster系统，默认的就是/etc/salt/roster文件\n–roster-file #指定roster文件\n–refresh, –refresh-cache #刷新cache，如果target的grains改变会自动刷新\n–max-procs #指定进程数，默认为25\n-i, –ignore-host-keys #当ssh连接时，忽略keys\n–passwd #指定默认密码\n–key-deploy #配置keys 设置这个参数对于所有minions用来部署ssh-key认证，\n 这个参和–passwd结合起来使用会使初始化部署很快很方便。当调用master模块时，并加上参数 –key-deploy 即可在minions生成keys，下次开始就不使用密码\n```\n5）`salt-ssh`执行命令\n```\n[root@salt-master ~]# salt-ssh '*' -r \"uptime\"\nsalt-minion01:\n    ----------\n    retcode:\n        0\n    stderr:\n    stdout:\n        root@192.168.1.31's password: \n         10:06:08 up 1 day, 17:05,  2 users,  load average: 0.00, 0.01, 0.05\nsalt-minion02:\n    ----------\n    retcode:\n        0\n    stderr:\n    stdout:\n        root@192.168.1.32's password: \n         10:06:08 up 1 day, 17:16,  2 users,  load average: 0.03, 0.06, 0.06\n```\n6）`salt-ssh`执行状态模块\n```\n[root@salt-master ~]# salt-ssh '*' state.sls modules.haproxy.service saltenv=prod\nsalt-minion02:\n----------\n          ID: haproxy-install\n    Function: pkg.installed\n        Name: haproxy\n      Result: True\n     Comment: All specified packages are already installed\n     Started: 10:09:48.541019\n    Duration: 10161.705 ms\n     Changes:   \n----------\n          ID: haproxy-config\n    Function: file.managed\n        Name: /etc/haproxy/haproxy.cfg\n      Result: True\n     Comment: File /etc/haproxy/haproxy.cfg is in the correct state\n     Started: 10:09:59.020659\n    Duration: 54.263 ms\n     Changes:   \n----------\n          ID: haproxy-service\n    Function: service.running\n        Name: haproxy\n      Result: True\n     Comment: The service haproxy is already running\n     Started: 10:09:59.079110\n    Duration: 128.052 ms\n     Changes:   \n\nSummary for salt-minion02\n------------\nSucceeded: 3\nFailed:    0\n------------\nTotal states run:     3\nTotal run time:  10.344 s\nsalt-minion01:\n----------\n          ID: haproxy-install\n    Function: pkg.installed\n        Name: haproxy\n      Result: True\n     Comment: All specified packages are already installed\n     Started: 10:10:00.561015\n    Duration: 2862.018 ms\n     Changes:   \n----------\n          ID: haproxy-config\n    Function: file.managed\n        Name: /etc/haproxy/haproxy.cfg\n      Result: True\n     Comment: File /etc/haproxy/haproxy.cfg is in the correct state\n     Started: 10:10:03.905713\n    Duration: 220.443 ms\n     Changes:   \n----------\n          ID: haproxy-service\n    Function: service.running\n        Name: haproxy\n      Result: True\n     Comment: The service haproxy is already running\n     Started: 10:10:04.135607\n    Duration: 230.231 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 3\nFailed:    0\n------------\nTotal states run:     3\nTotal run time:   3.313 s\n```\n## Roster说明\n>`salt-ssh`需要一个名单系统来确定哪些执行目标，`Salt`的`0.17.0`版本中`salt-ssh`引入`roste`r系统\n`roster`系统编译成了一个数据结构，包含了`targets`，这些`targets`是一个目标系统主机列表和或如连接到这些`targets`。\n\n配置文件说明：\n```\n# target的信息\n    host:        # 远端主机的ip地址或者dns域名\n    user:        # 登录的用户\n    passwd:      # 用户密码,如果不使用此选项，则默认使用秘钥方式\n# 可选的部分\n    port:        #ssh端口\n    sudo:        #可以通过sudo\n    tty:         # 如果设置了sudo，设置这个参数为true\n    priv:        # ssh秘钥的文件路径\n    timeout:     # 当建立链接时等待响应时间的秒数\n    minion_opts: # minion的位置路径\n    thin_dir:    # target系统的存储目录，默认是/tmp/salt-<hash>\n    cmd_umask:   # 使用salt-call命令的umask值\n```","source":"_posts/saltstack使用salt-ssh.md","raw":"---\ntitle: saltstack使用salt-ssh\ndate: 2019-05-20 09:43:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## salt-ssh 介绍\n[参考官档](https://docs.saltstack.com/en/latest/topics/ssh/index.html)\n>`salt-ssh`是 `0.17.0` 新引入的一个功能，不需要minion对客户端进行管理，也可以不需要`master`；`salt-ssh`也支持`salt`大部分的功能：比如`grains`,`modules`,`state`等；`salt-ssh`没有使用`ZeroMQ`的通信架构，执行是串行模式\n\n## salt-ssh执行原理\n>- `salt-ssh`是在`salt`基础上打了一个`python`包上传到客户端的默认`tmp`目录下, 在客户端上面解压并执行返回结果,最后删除`tmp`上传的临时文件。\n>- `salt-minion`方法是`salt-mater`先执行语法验证，验证通过后发送到`minion`，`minion`收到`Msater`的状态文件默认保存在`/var/cache/salt/minion`\n>- `salt-ssh`和`salt-minion`可以共存，`salt-minion`不依赖于`ssh`服务\n\n\n## 安装配置\n1）安装`salt-ssh`\n```\n[root@salt-master ~]# yum -y install salt-ssh\n```\n2）修改`roster`文件，配置需要管理的机器\n```\n[root@salt-master ~]# vim /etc/salt/roster\nsalt-minion01:\n  host: 192.168.1.31\n  user: root\n  passwd: 123456\n  port: 22\n\nsalt-minion02:\n  host: 192.168.1.32\n  user: root\n  passwd: 123456\n  port: 22\n```\n3）管理测试 (说明，如果第一次需要输入`yes或no`进行`ssh`认证，可以加`-i`参数自动认证)\n```\n[root@salt-master ~]# salt-ssh '*' test.ping -i\nsalt-minion01:\n    True\nsalt-minion02:\n    True\n```\n4）`salt-ssh`命令参数\n```\n-r, –raw, –raw-shell # 直接使用shell命令\n–priv #指定SSH私有密钥文件\n–roster #定义使用哪个roster系统，如果定义了一个后端数据库，扫描方式，或者用户自定义的的roster系统，默认的就是/etc/salt/roster文件\n–roster-file #指定roster文件\n–refresh, –refresh-cache #刷新cache，如果target的grains改变会自动刷新\n–max-procs #指定进程数，默认为25\n-i, –ignore-host-keys #当ssh连接时，忽略keys\n–passwd #指定默认密码\n–key-deploy #配置keys 设置这个参数对于所有minions用来部署ssh-key认证，\n 这个参和–passwd结合起来使用会使初始化部署很快很方便。当调用master模块时，并加上参数 –key-deploy 即可在minions生成keys，下次开始就不使用密码\n```\n5）`salt-ssh`执行命令\n```\n[root@salt-master ~]# salt-ssh '*' -r \"uptime\"\nsalt-minion01:\n    ----------\n    retcode:\n        0\n    stderr:\n    stdout:\n        root@192.168.1.31's password: \n         10:06:08 up 1 day, 17:05,  2 users,  load average: 0.00, 0.01, 0.05\nsalt-minion02:\n    ----------\n    retcode:\n        0\n    stderr:\n    stdout:\n        root@192.168.1.32's password: \n         10:06:08 up 1 day, 17:16,  2 users,  load average: 0.03, 0.06, 0.06\n```\n6）`salt-ssh`执行状态模块\n```\n[root@salt-master ~]# salt-ssh '*' state.sls modules.haproxy.service saltenv=prod\nsalt-minion02:\n----------\n          ID: haproxy-install\n    Function: pkg.installed\n        Name: haproxy\n      Result: True\n     Comment: All specified packages are already installed\n     Started: 10:09:48.541019\n    Duration: 10161.705 ms\n     Changes:   \n----------\n          ID: haproxy-config\n    Function: file.managed\n        Name: /etc/haproxy/haproxy.cfg\n      Result: True\n     Comment: File /etc/haproxy/haproxy.cfg is in the correct state\n     Started: 10:09:59.020659\n    Duration: 54.263 ms\n     Changes:   \n----------\n          ID: haproxy-service\n    Function: service.running\n        Name: haproxy\n      Result: True\n     Comment: The service haproxy is already running\n     Started: 10:09:59.079110\n    Duration: 128.052 ms\n     Changes:   \n\nSummary for salt-minion02\n------------\nSucceeded: 3\nFailed:    0\n------------\nTotal states run:     3\nTotal run time:  10.344 s\nsalt-minion01:\n----------\n          ID: haproxy-install\n    Function: pkg.installed\n        Name: haproxy\n      Result: True\n     Comment: All specified packages are already installed\n     Started: 10:10:00.561015\n    Duration: 2862.018 ms\n     Changes:   \n----------\n          ID: haproxy-config\n    Function: file.managed\n        Name: /etc/haproxy/haproxy.cfg\n      Result: True\n     Comment: File /etc/haproxy/haproxy.cfg is in the correct state\n     Started: 10:10:03.905713\n    Duration: 220.443 ms\n     Changes:   \n----------\n          ID: haproxy-service\n    Function: service.running\n        Name: haproxy\n      Result: True\n     Comment: The service haproxy is already running\n     Started: 10:10:04.135607\n    Duration: 230.231 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 3\nFailed:    0\n------------\nTotal states run:     3\nTotal run time:   3.313 s\n```\n## Roster说明\n>`salt-ssh`需要一个名单系统来确定哪些执行目标，`Salt`的`0.17.0`版本中`salt-ssh`引入`roste`r系统\n`roster`系统编译成了一个数据结构，包含了`targets`，这些`targets`是一个目标系统主机列表和或如连接到这些`targets`。\n\n配置文件说明：\n```\n# target的信息\n    host:        # 远端主机的ip地址或者dns域名\n    user:        # 登录的用户\n    passwd:      # 用户密码,如果不使用此选项，则默认使用秘钥方式\n# 可选的部分\n    port:        #ssh端口\n    sudo:        #可以通过sudo\n    tty:         # 如果设置了sudo，设置这个参数为true\n    priv:        # ssh秘钥的文件路径\n    timeout:     # 当建立链接时等待响应时间的秒数\n    minion_opts: # minion的位置路径\n    thin_dir:    # target系统的存储目录，默认是/tmp/salt-<hash>\n    cmd_umask:   # 使用salt-call命令的umask值\n```","slug":"saltstack使用salt-ssh","published":1,"updated":"2019-05-23T12:29:57.764Z","_id":"cjxwlqrkk000llctccnlax5cu","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"salt-ssh-介绍\"><a href=\"#salt-ssh-介绍\" class=\"headerlink\" title=\"salt-ssh 介绍\"></a>salt-ssh 介绍</h2><p><a href=\"https://docs.saltstack.com/en/latest/topics/ssh/index.html\" target=\"_blank\" rel=\"noopener\">参考官档</a></p>\n<blockquote>\n<p><code>salt-ssh</code>是 <code>0.17.0</code> 新引入的一个功能，不需要minion对客户端进行管理，也可以不需要<code>master</code>；<code>salt-ssh</code>也支持<code>salt</code>大部分的功能：比如<code>grains</code>,<code>modules</code>,<code>state</code>等；<code>salt-ssh</code>没有使用<code>ZeroMQ</code>的通信架构，执行是串行模式</p>\n</blockquote>\n<h2 id=\"salt-ssh执行原理\"><a href=\"#salt-ssh执行原理\" class=\"headerlink\" title=\"salt-ssh执行原理\"></a>salt-ssh执行原理</h2><blockquote>\n<ul>\n<li><code>salt-ssh</code>是在<code>salt</code>基础上打了一个<code>python</code>包上传到客户端的默认<code>tmp</code>目录下, 在客户端上面解压并执行返回结果,最后删除<code>tmp</code>上传的临时文件。</li>\n<li><code>salt-minion</code>方法是<code>salt-mater</code>先执行语法验证，验证通过后发送到<code>minion</code>，<code>minion</code>收到<code>Msater</code>的状态文件默认保存在<code>/var/cache/salt/minion</code></li>\n<li><code>salt-ssh</code>和<code>salt-minion</code>可以共存，<code>salt-minion</code>不依赖于<code>ssh</code>服务</li>\n</ul>\n</blockquote>\n<h2 id=\"安装配置\"><a href=\"#安装配置\" class=\"headerlink\" title=\"安装配置\"></a>安装配置</h2><p>1）安装<code>salt-ssh</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-ssh</span><br></pre></td></tr></table></figure></p>\n<p>2）修改<code>roster</code>文件，配置需要管理的机器<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">vim</span> <span class=\"string\">/etc/salt/roster</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span></span><br><span class=\"line\"><span class=\"attr\">  user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  passwd:</span> <span class=\"number\">123456</span></span><br><span class=\"line\"><span class=\"attr\">  port:</span> <span class=\"number\">22</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"><span class=\"attr\">  user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  passwd:</span> <span class=\"number\">123456</span></span><br><span class=\"line\"><span class=\"attr\">  port:</span> <span class=\"number\">22</span></span><br></pre></td></tr></table></figure></p>\n<p>3）管理测试 (说明，如果第一次需要输入<code>yes或no</code>进行<code>ssh</code>认证，可以加<code>-i</code>参数自动认证)<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-ssh</span> <span class=\"string\">'*'</span> <span class=\"string\">test.ping</span> <span class=\"bullet\">-i</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4）<code>salt-ssh</code>命令参数<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-r, –raw, –raw-shell <span class=\"comment\"># 直接使用shell命令</span></span><br><span class=\"line\">–priv <span class=\"comment\">#指定SSH私有密钥文件</span></span><br><span class=\"line\">–roster <span class=\"comment\">#定义使用哪个roster系统，如果定义了一个后端数据库，扫描方式，或者用户自定义的的roster系统，默认的就是/etc/salt/roster文件</span></span><br><span class=\"line\">–roster-file <span class=\"comment\">#指定roster文件</span></span><br><span class=\"line\">–refresh, –refresh-<span class=\"keyword\">cache</span> <span class=\"comment\">#刷新cache，如果target的grains改变会自动刷新</span></span><br><span class=\"line\">–<span class=\"keyword\">max</span>-procs <span class=\"comment\">#指定进程数，默认为25</span></span><br><span class=\"line\">-i, –<span class=\"keyword\">ignore</span>-host-<span class=\"keyword\">keys</span> <span class=\"comment\">#当ssh连接时，忽略keys</span></span><br><span class=\"line\">–passwd <span class=\"comment\">#指定默认密码</span></span><br><span class=\"line\">–<span class=\"keyword\">key</span>-deploy <span class=\"comment\">#配置keys 设置这个参数对于所有minions用来部署ssh-key认证，</span></span><br><span class=\"line\"> 这个参和–passwd结合起来使用会使初始化部署很快很方便。当调用<span class=\"keyword\">master</span>模块时，并加上参数 –<span class=\"keyword\">key</span>-deploy 即可在minions生成<span class=\"keyword\">keys</span>，下次开始就不使用密码</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>salt-ssh</code>执行命令<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-ssh</span> <span class=\"string\">'*'</span> <span class=\"bullet\">-r</span> <span class=\"string\">\"uptime\"</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span><span class=\"bullet\">---------</span></span><br><span class=\"line\"><span class=\"attr\">    retcode:</span></span><br><span class=\"line\">        <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">    stderr:</span></span><br><span class=\"line\"><span class=\"attr\">    stdout:</span></span><br><span class=\"line\">        <span class=\"string\">root@192.168.1.31's</span> <span class=\"attr\">password:</span> </span><br><span class=\"line\">         <span class=\"number\">10</span><span class=\"string\">:06:08</span> <span class=\"string\">up</span> <span class=\"number\">1</span> <span class=\"string\">day,</span> <span class=\"number\">17</span><span class=\"string\">:05,</span>  <span class=\"number\">2</span> <span class=\"string\">users,</span>  <span class=\"string\">load</span> <span class=\"attr\">average:</span> <span class=\"number\">0.00</span><span class=\"string\">,</span> <span class=\"number\">0.01</span><span class=\"string\">,</span> <span class=\"number\">0.05</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span><span class=\"bullet\">---------</span></span><br><span class=\"line\"><span class=\"attr\">    retcode:</span></span><br><span class=\"line\">        <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">    stderr:</span></span><br><span class=\"line\"><span class=\"attr\">    stdout:</span></span><br><span class=\"line\">        <span class=\"string\">root@192.168.1.32's</span> <span class=\"attr\">password:</span> </span><br><span class=\"line\">         <span class=\"number\">10</span><span class=\"string\">:06:08</span> <span class=\"string\">up</span> <span class=\"number\">1</span> <span class=\"string\">day,</span> <span class=\"number\">17</span><span class=\"string\">:16,</span>  <span class=\"number\">2</span> <span class=\"string\">users,</span>  <span class=\"string\">load</span> <span class=\"attr\">average:</span> <span class=\"number\">0.03</span><span class=\"string\">,</span> <span class=\"number\">0.06</span><span class=\"string\">,</span> <span class=\"number\">0.06</span></span><br></pre></td></tr></table></figure></p>\n<p>6）<code>salt-ssh</code>执行状态模块<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt-ssh <span class=\"emphasis\">'*'</span> state.sls modules.haproxy.service saltenv=prod</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-install</span></span><br><span class=\"line\"><span class=\"code\">    Function: pkg.installed</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: All specified packages are already installed</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:48.541019</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 10161.705 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-config</span></span><br><span class=\"line\"><span class=\"code\">    Function: file.managed</span></span><br><span class=\"line\"><span class=\"code\">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:59.020659</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 54.263 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-service</span></span><br><span class=\"line\"><span class=\"code\">    Function: service.running</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: The service haproxy is already running</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:59.079110</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 128.052 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion02</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 3</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     3</span><br><span class=\"line\">Total run time:  10.344 s</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-install</span></span><br><span class=\"line\"><span class=\"code\">    Function: pkg.installed</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: All specified packages are already installed</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:00.561015</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 2862.018 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-config</span></span><br><span class=\"line\"><span class=\"code\">    Function: file.managed</span></span><br><span class=\"line\"><span class=\"code\">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:03.905713</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 220.443 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-service</span></span><br><span class=\"line\"><span class=\"code\">    Function: service.running</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: The service haproxy is already running</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:04.135607</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 230.231 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 3</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     3</span><br><span class=\"line\">Total run time:   3.313 s</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Roster说明\"><a href=\"#Roster说明\" class=\"headerlink\" title=\"Roster说明\"></a>Roster说明</h2><blockquote>\n<p><code>salt-ssh</code>需要一个名单系统来确定哪些执行目标，<code>Salt</code>的<code>0.17.0</code>版本中<code>salt-ssh</code>引入<code>roste</code>r系统<br><code>roster</code>系统编译成了一个数据结构，包含了<code>targets</code>，这些<code>targets</code>是一个目标系统主机列表和或如连接到这些<code>targets</code>。</p>\n</blockquote>\n<p>配置文件说明：<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># target的信息</span></span><br><span class=\"line\"><span class=\"symbol\">    host:</span>        <span class=\"meta\"># 远端主机的ip地址或者dns域名</span></span><br><span class=\"line\"><span class=\"symbol\">    user:</span>        <span class=\"meta\"># 登录的用户</span></span><br><span class=\"line\"><span class=\"symbol\">    passwd:</span>      <span class=\"meta\"># 用户密码,如果不使用此选项，则默认使用秘钥方式</span></span><br><span class=\"line\"><span class=\"meta\"># 可选的部分</span></span><br><span class=\"line\"><span class=\"symbol\">    port:</span>        <span class=\"meta\">#ssh端口</span></span><br><span class=\"line\"><span class=\"symbol\">    sudo:</span>        <span class=\"meta\">#可以通过sudo</span></span><br><span class=\"line\"><span class=\"symbol\">    tty:</span>         <span class=\"meta\"># 如果设置了sudo，设置这个参数为true</span></span><br><span class=\"line\"><span class=\"symbol\">    priv:</span>        <span class=\"meta\"># ssh秘钥的文件路径</span></span><br><span class=\"line\"><span class=\"symbol\">    timeout:</span>     <span class=\"meta\"># 当建立链接时等待响应时间的秒数</span></span><br><span class=\"line\"><span class=\"symbol\">    minion_opts:</span> <span class=\"meta\"># minion的位置路径</span></span><br><span class=\"line\"><span class=\"symbol\">    thin_dir:</span>    <span class=\"meta\"># target系统的存储目录，默认是/tmp/salt-&lt;hash&gt;</span></span><br><span class=\"line\"><span class=\"symbol\">    cmd_umask:</span>   <span class=\"meta\"># 使用salt-call命令的umask值</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"salt-ssh-介绍\"><a href=\"#salt-ssh-介绍\" class=\"headerlink\" title=\"salt-ssh 介绍\"></a>salt-ssh 介绍</h2><p><a href=\"https://docs.saltstack.com/en/latest/topics/ssh/index.html\" target=\"_blank\" rel=\"noopener\">参考官档</a></p>\n<blockquote>\n<p><code>salt-ssh</code>是 <code>0.17.0</code> 新引入的一个功能，不需要minion对客户端进行管理，也可以不需要<code>master</code>；<code>salt-ssh</code>也支持<code>salt</code>大部分的功能：比如<code>grains</code>,<code>modules</code>,<code>state</code>等；<code>salt-ssh</code>没有使用<code>ZeroMQ</code>的通信架构，执行是串行模式</p>\n</blockquote>\n<h2 id=\"salt-ssh执行原理\"><a href=\"#salt-ssh执行原理\" class=\"headerlink\" title=\"salt-ssh执行原理\"></a>salt-ssh执行原理</h2><blockquote>\n<ul>\n<li><code>salt-ssh</code>是在<code>salt</code>基础上打了一个<code>python</code>包上传到客户端的默认<code>tmp</code>目录下, 在客户端上面解压并执行返回结果,最后删除<code>tmp</code>上传的临时文件。</li>\n<li><code>salt-minion</code>方法是<code>salt-mater</code>先执行语法验证，验证通过后发送到<code>minion</code>，<code>minion</code>收到<code>Msater</code>的状态文件默认保存在<code>/var/cache/salt/minion</code></li>\n<li><code>salt-ssh</code>和<code>salt-minion</code>可以共存，<code>salt-minion</code>不依赖于<code>ssh</code>服务</li>\n</ul>\n</blockquote>\n<h2 id=\"安装配置\"><a href=\"#安装配置\" class=\"headerlink\" title=\"安装配置\"></a>安装配置</h2><p>1）安装<code>salt-ssh</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-ssh</span><br></pre></td></tr></table></figure></p>\n<p>2）修改<code>roster</code>文件，配置需要管理的机器<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">vim</span> <span class=\"string\">/etc/salt/roster</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span></span><br><span class=\"line\"><span class=\"attr\">  user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  passwd:</span> <span class=\"number\">123456</span></span><br><span class=\"line\"><span class=\"attr\">  port:</span> <span class=\"number\">22</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"><span class=\"attr\">  user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  passwd:</span> <span class=\"number\">123456</span></span><br><span class=\"line\"><span class=\"attr\">  port:</span> <span class=\"number\">22</span></span><br></pre></td></tr></table></figure></p>\n<p>3）管理测试 (说明，如果第一次需要输入<code>yes或no</code>进行<code>ssh</code>认证，可以加<code>-i</code>参数自动认证)<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-ssh</span> <span class=\"string\">'*'</span> <span class=\"string\">test.ping</span> <span class=\"bullet\">-i</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4）<code>salt-ssh</code>命令参数<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-r, –raw, –raw-shell <span class=\"comment\"># 直接使用shell命令</span></span><br><span class=\"line\">–priv <span class=\"comment\">#指定SSH私有密钥文件</span></span><br><span class=\"line\">–roster <span class=\"comment\">#定义使用哪个roster系统，如果定义了一个后端数据库，扫描方式，或者用户自定义的的roster系统，默认的就是/etc/salt/roster文件</span></span><br><span class=\"line\">–roster-file <span class=\"comment\">#指定roster文件</span></span><br><span class=\"line\">–refresh, –refresh-<span class=\"keyword\">cache</span> <span class=\"comment\">#刷新cache，如果target的grains改变会自动刷新</span></span><br><span class=\"line\">–<span class=\"keyword\">max</span>-procs <span class=\"comment\">#指定进程数，默认为25</span></span><br><span class=\"line\">-i, –<span class=\"keyword\">ignore</span>-host-<span class=\"keyword\">keys</span> <span class=\"comment\">#当ssh连接时，忽略keys</span></span><br><span class=\"line\">–passwd <span class=\"comment\">#指定默认密码</span></span><br><span class=\"line\">–<span class=\"keyword\">key</span>-deploy <span class=\"comment\">#配置keys 设置这个参数对于所有minions用来部署ssh-key认证，</span></span><br><span class=\"line\"> 这个参和–passwd结合起来使用会使初始化部署很快很方便。当调用<span class=\"keyword\">master</span>模块时，并加上参数 –<span class=\"keyword\">key</span>-deploy 即可在minions生成<span class=\"keyword\">keys</span>，下次开始就不使用密码</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>salt-ssh</code>执行命令<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-ssh</span> <span class=\"string\">'*'</span> <span class=\"bullet\">-r</span> <span class=\"string\">\"uptime\"</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span><span class=\"bullet\">---------</span></span><br><span class=\"line\"><span class=\"attr\">    retcode:</span></span><br><span class=\"line\">        <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">    stderr:</span></span><br><span class=\"line\"><span class=\"attr\">    stdout:</span></span><br><span class=\"line\">        <span class=\"string\">root@192.168.1.31's</span> <span class=\"attr\">password:</span> </span><br><span class=\"line\">         <span class=\"number\">10</span><span class=\"string\">:06:08</span> <span class=\"string\">up</span> <span class=\"number\">1</span> <span class=\"string\">day,</span> <span class=\"number\">17</span><span class=\"string\">:05,</span>  <span class=\"number\">2</span> <span class=\"string\">users,</span>  <span class=\"string\">load</span> <span class=\"attr\">average:</span> <span class=\"number\">0.00</span><span class=\"string\">,</span> <span class=\"number\">0.01</span><span class=\"string\">,</span> <span class=\"number\">0.05</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span><span class=\"bullet\">---------</span></span><br><span class=\"line\"><span class=\"attr\">    retcode:</span></span><br><span class=\"line\">        <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">    stderr:</span></span><br><span class=\"line\"><span class=\"attr\">    stdout:</span></span><br><span class=\"line\">        <span class=\"string\">root@192.168.1.32's</span> <span class=\"attr\">password:</span> </span><br><span class=\"line\">         <span class=\"number\">10</span><span class=\"string\">:06:08</span> <span class=\"string\">up</span> <span class=\"number\">1</span> <span class=\"string\">day,</span> <span class=\"number\">17</span><span class=\"string\">:16,</span>  <span class=\"number\">2</span> <span class=\"string\">users,</span>  <span class=\"string\">load</span> <span class=\"attr\">average:</span> <span class=\"number\">0.03</span><span class=\"string\">,</span> <span class=\"number\">0.06</span><span class=\"string\">,</span> <span class=\"number\">0.06</span></span><br></pre></td></tr></table></figure></p>\n<p>6）<code>salt-ssh</code>执行状态模块<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt-ssh <span class=\"emphasis\">'*'</span> state.sls modules.haproxy.service saltenv=prod</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-install</span></span><br><span class=\"line\"><span class=\"code\">    Function: pkg.installed</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: All specified packages are already installed</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:48.541019</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 10161.705 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-config</span></span><br><span class=\"line\"><span class=\"code\">    Function: file.managed</span></span><br><span class=\"line\"><span class=\"code\">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:59.020659</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 54.263 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-service</span></span><br><span class=\"line\"><span class=\"code\">    Function: service.running</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: The service haproxy is already running</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:59.079110</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 128.052 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion02</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 3</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     3</span><br><span class=\"line\">Total run time:  10.344 s</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-install</span></span><br><span class=\"line\"><span class=\"code\">    Function: pkg.installed</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: All specified packages are already installed</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:00.561015</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 2862.018 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-config</span></span><br><span class=\"line\"><span class=\"code\">    Function: file.managed</span></span><br><span class=\"line\"><span class=\"code\">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:03.905713</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 220.443 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-service</span></span><br><span class=\"line\"><span class=\"code\">    Function: service.running</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: The service haproxy is already running</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:04.135607</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 230.231 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 3</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     3</span><br><span class=\"line\">Total run time:   3.313 s</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Roster说明\"><a href=\"#Roster说明\" class=\"headerlink\" title=\"Roster说明\"></a>Roster说明</h2><blockquote>\n<p><code>salt-ssh</code>需要一个名单系统来确定哪些执行目标，<code>Salt</code>的<code>0.17.0</code>版本中<code>salt-ssh</code>引入<code>roste</code>r系统<br><code>roster</code>系统编译成了一个数据结构，包含了<code>targets</code>，这些<code>targets</code>是一个目标系统主机列表和或如连接到这些<code>targets</code>。</p>\n</blockquote>\n<p>配置文件说明：<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># target的信息</span></span><br><span class=\"line\"><span class=\"symbol\">    host:</span>        <span class=\"meta\"># 远端主机的ip地址或者dns域名</span></span><br><span class=\"line\"><span class=\"symbol\">    user:</span>        <span class=\"meta\"># 登录的用户</span></span><br><span class=\"line\"><span class=\"symbol\">    passwd:</span>      <span class=\"meta\"># 用户密码,如果不使用此选项，则默认使用秘钥方式</span></span><br><span class=\"line\"><span class=\"meta\"># 可选的部分</span></span><br><span class=\"line\"><span class=\"symbol\">    port:</span>        <span class=\"meta\">#ssh端口</span></span><br><span class=\"line\"><span class=\"symbol\">    sudo:</span>        <span class=\"meta\">#可以通过sudo</span></span><br><span class=\"line\"><span class=\"symbol\">    tty:</span>         <span class=\"meta\"># 如果设置了sudo，设置这个参数为true</span></span><br><span class=\"line\"><span class=\"symbol\">    priv:</span>        <span class=\"meta\"># ssh秘钥的文件路径</span></span><br><span class=\"line\"><span class=\"symbol\">    timeout:</span>     <span class=\"meta\"># 当建立链接时等待响应时间的秒数</span></span><br><span class=\"line\"><span class=\"symbol\">    minion_opts:</span> <span class=\"meta\"># minion的位置路径</span></span><br><span class=\"line\"><span class=\"symbol\">    thin_dir:</span>    <span class=\"meta\"># target系统的存储目录，默认是/tmp/salt-&lt;hash&gt;</span></span><br><span class=\"line\"><span class=\"symbol\">    cmd_umask:</span>   <span class=\"meta\"># 使用salt-call命令的umask值</span></span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack接口salt-api","date":"2019-05-20T14:04:05.000Z","copyright":true,"_content":"## 介绍\n[参考官档](https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html)\n[参考官档](https://www.unixhot.com/docs/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html#a-rest-api-for-salt)\n>`SaltStack`官方提供有`REST API`格式的`salt-api`项目，将使`salt`与第三方系统集成变得更加简单。\n\n## salt-api安装配置\n1）在`salt-master`上进行安装\n```\n[root@salt-master ~]# yum -y install salt-api\n```\n2）自签名证书，生产环境可以购买（说明：如果没有`salt-call`命令，装上`salt-minion`即可，依赖于该包）\n```\n[root@salt-master ~]# salt-call --local tls.create_self_signed_cert\nlocal:\n    Created Private Key: \"/etc/pki/tls/certs/localhost.key.\" Created Certificate: \"/etc/pki/tls/certs/localhost.crt.\"\n```\n3）打开`include`加载子配置文件，方便管理\n```\n[root@salt-master ~]# vim /etc/salt/master\ndefault_include: master.d/*.conf\n```\n4）配置`api`配置文件，将上面生成的证书写到配置文件\n```\n[root@salt-master ~]# vim /etc/salt/master.d/api.conf\nrest_cherrypy:\n  host: 192.168.1.30\n  port: 8000\n  ssl_crt: /etc/pki/tls/certs/localhost.crt\n  ssl_key: /etc/pki/tls/certs/localhost.key\n```\n5）创建认证用户，并设置密码\n```\n[root@salt-master ~]# useradd -M -s /sbin/nologin saltapi\n[root@salt-master ~]# echo 'saltapi' | passwd --stdin saltapi\n```\n6）创建认证配置文件\n```\n[root@salt-master ~]# vim /etc/salt/master.d/auth.conf\nexternal_auth:\n  pam:\n    saltapi:\n      - .*\n      - '@wheel'\n      - '@runner'\n      - '@jobs'\n```\n7）重启`salt-master`和启动`salt-api`\n```\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# systemctl start salt-api\n```\n8）查看`salt-api`监听端口\n```\n[root@salt-master ~]# netstat -anlutp |grep 8000\ntcp        0      0 192.168.1.30:8000       0.0.0.0:*               LISTEN      10904/python        \ntcp        0      0 192.168.1.30:53414      192.168.1.30:8000       TIME_WAIT   - \n```\n9）验证`login`登录，获取`token`字符串\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/login \\\n>     -H 'Accept: application/x-yaml' \\\n>     -d username=saltapi \\\n>     -d password=saltapi \\\n>     -d eauth=pam\nreturn:\n- eauth: pam\n  expire: 1558663247.869537\n  perms:\n  - .*\n  - '@wheel'\n  - '@runner'\n  - '@jobs'\n  start: 1558620047.869536\n  token: e8330f642a3addd853c723d63844d29a12de9484\n  user: saltapi\n```\n10）通过`api`执行`test.ping`测试连通性\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\\\n>     -d client=local \\\n>     -d tgt='*' \\\n>     -d fun=test.ping\nreturn:\n- salt-minion01: true\n  salt-minion02: true\n  salt-minion03: true\n  salt-minion04: true\n```\n11）通过`api`执行`cmd.run`\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\\\n>     -d client=local \\\n>     -d tgt='*' \\\n>     -d fun='cmd.run' -d arg='uptime'\nreturn:\n- salt-minion01: ' 22:10:25 up 46 min,  1 user,  load average: 0.00, 0.01, 0.05'\n  salt-minion02: ' 22:10:25 up 7 min,  0 users,  load average: 0.00, 0.18, 0.15'\n  salt-minion03: ' 22:10:25 up 7 min,  0 users,  load average: 0.06, 0.33, 0.26'\n  salt-minion04: ' 22:10:25 up 7 min,  0 users,  load average: 0.01, 0.21, 0.16'\n```\n12）通过`api`获取`grains`信息`\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/minions/salt-minion01 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\nreturn:\n- salt-minion01:\n    SSDs: []\n    biosreleasedate: 05/19/2017\n    biosversion: '6.00'\n    cpu_flags:\n    - fpu\n    - vme\n    - de\n    - pse\n    - tsc\n.....\n```\n13）使用`json`格式\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/minions/salt-minion01 \\\n>     -H 'Accept: application/json' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\n{\"return\": [{\"salt-minion01\": {\"biosversion\": \"6.00\", \"kernel\": \"Linux\", \"domain\": \"\", \"uid\": 0, \"zmqversion\": \"4.1.4\", \"kernelrelease\": \"3.10.0-693.el7.x86_64\", \"selinux\": {\"enforced\": \"Disabled\", \"enabled\": false}, \"serialnumber\": \"VMware-56 4d 9e a0 21 56 90 87-cd 89 69 32 13 94 17 44\", \"pid\": 1449, \"fqdns\": [], \"ip_interfaces\": {\"lo\": [\"127.0.0.1\", \"::1\"], \"virbr0\": [\"192.168.122.1\"], \"virbr0-nic\": [], \"ens33\": [\"192.168.1.31\", \"192.168.1.100\", \"fe80::20c:29ff:fe94:1744\"]}, \"groupname\": \"root\", \"fqdn_ip6\": [\"fe80::20c:29ff:fe94:1744\"],\n.......\n```\n\n## 总结\n>`salt-api`必须使用`https`，生产环境建议使用可信证书\n>当`salt-api`服务重启后原`token`失效\n\n","source":"_posts/saltstack接口salt-api.md","raw":"---\ntitle: saltstack接口salt-api\ndate: 2019-05-20 22:04:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## 介绍\n[参考官档](https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html)\n[参考官档](https://www.unixhot.com/docs/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html#a-rest-api-for-salt)\n>`SaltStack`官方提供有`REST API`格式的`salt-api`项目，将使`salt`与第三方系统集成变得更加简单。\n\n## salt-api安装配置\n1）在`salt-master`上进行安装\n```\n[root@salt-master ~]# yum -y install salt-api\n```\n2）自签名证书，生产环境可以购买（说明：如果没有`salt-call`命令，装上`salt-minion`即可，依赖于该包）\n```\n[root@salt-master ~]# salt-call --local tls.create_self_signed_cert\nlocal:\n    Created Private Key: \"/etc/pki/tls/certs/localhost.key.\" Created Certificate: \"/etc/pki/tls/certs/localhost.crt.\"\n```\n3）打开`include`加载子配置文件，方便管理\n```\n[root@salt-master ~]# vim /etc/salt/master\ndefault_include: master.d/*.conf\n```\n4）配置`api`配置文件，将上面生成的证书写到配置文件\n```\n[root@salt-master ~]# vim /etc/salt/master.d/api.conf\nrest_cherrypy:\n  host: 192.168.1.30\n  port: 8000\n  ssl_crt: /etc/pki/tls/certs/localhost.crt\n  ssl_key: /etc/pki/tls/certs/localhost.key\n```\n5）创建认证用户，并设置密码\n```\n[root@salt-master ~]# useradd -M -s /sbin/nologin saltapi\n[root@salt-master ~]# echo 'saltapi' | passwd --stdin saltapi\n```\n6）创建认证配置文件\n```\n[root@salt-master ~]# vim /etc/salt/master.d/auth.conf\nexternal_auth:\n  pam:\n    saltapi:\n      - .*\n      - '@wheel'\n      - '@runner'\n      - '@jobs'\n```\n7）重启`salt-master`和启动`salt-api`\n```\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# systemctl start salt-api\n```\n8）查看`salt-api`监听端口\n```\n[root@salt-master ~]# netstat -anlutp |grep 8000\ntcp        0      0 192.168.1.30:8000       0.0.0.0:*               LISTEN      10904/python        \ntcp        0      0 192.168.1.30:53414      192.168.1.30:8000       TIME_WAIT   - \n```\n9）验证`login`登录，获取`token`字符串\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/login \\\n>     -H 'Accept: application/x-yaml' \\\n>     -d username=saltapi \\\n>     -d password=saltapi \\\n>     -d eauth=pam\nreturn:\n- eauth: pam\n  expire: 1558663247.869537\n  perms:\n  - .*\n  - '@wheel'\n  - '@runner'\n  - '@jobs'\n  start: 1558620047.869536\n  token: e8330f642a3addd853c723d63844d29a12de9484\n  user: saltapi\n```\n10）通过`api`执行`test.ping`测试连通性\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\\\n>     -d client=local \\\n>     -d tgt='*' \\\n>     -d fun=test.ping\nreturn:\n- salt-minion01: true\n  salt-minion02: true\n  salt-minion03: true\n  salt-minion04: true\n```\n11）通过`api`执行`cmd.run`\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\\\n>     -d client=local \\\n>     -d tgt='*' \\\n>     -d fun='cmd.run' -d arg='uptime'\nreturn:\n- salt-minion01: ' 22:10:25 up 46 min,  1 user,  load average: 0.00, 0.01, 0.05'\n  salt-minion02: ' 22:10:25 up 7 min,  0 users,  load average: 0.00, 0.18, 0.15'\n  salt-minion03: ' 22:10:25 up 7 min,  0 users,  load average: 0.06, 0.33, 0.26'\n  salt-minion04: ' 22:10:25 up 7 min,  0 users,  load average: 0.01, 0.21, 0.16'\n```\n12）通过`api`获取`grains`信息`\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/minions/salt-minion01 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\nreturn:\n- salt-minion01:\n    SSDs: []\n    biosreleasedate: 05/19/2017\n    biosversion: '6.00'\n    cpu_flags:\n    - fpu\n    - vme\n    - de\n    - pse\n    - tsc\n.....\n```\n13）使用`json`格式\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/minions/salt-minion01 \\\n>     -H 'Accept: application/json' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\n{\"return\": [{\"salt-minion01\": {\"biosversion\": \"6.00\", \"kernel\": \"Linux\", \"domain\": \"\", \"uid\": 0, \"zmqversion\": \"4.1.4\", \"kernelrelease\": \"3.10.0-693.el7.x86_64\", \"selinux\": {\"enforced\": \"Disabled\", \"enabled\": false}, \"serialnumber\": \"VMware-56 4d 9e a0 21 56 90 87-cd 89 69 32 13 94 17 44\", \"pid\": 1449, \"fqdns\": [], \"ip_interfaces\": {\"lo\": [\"127.0.0.1\", \"::1\"], \"virbr0\": [\"192.168.122.1\"], \"virbr0-nic\": [], \"ens33\": [\"192.168.1.31\", \"192.168.1.100\", \"fe80::20c:29ff:fe94:1744\"]}, \"groupname\": \"root\", \"fqdn_ip6\": [\"fe80::20c:29ff:fe94:1744\"],\n.......\n```\n\n## 总结\n>`salt-api`必须使用`https`，生产环境建议使用可信证书\n>当`salt-api`服务重启后原`token`失效\n\n","slug":"saltstack接口salt-api","published":1,"updated":"2019-05-23T15:15:21.768Z","_id":"cjxwlqrkp000olctc8vqiftmr","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p><a href=\"https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html\" target=\"_blank\" rel=\"noopener\">参考官档</a><br><a href=\"https://www.unixhot.com/docs/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html#a-rest-api-for-salt\" target=\"_blank\" rel=\"noopener\">参考官档</a></p>\n<blockquote>\n<p><code>SaltStack</code>官方提供有<code>REST API</code>格式的<code>salt-api</code>项目，将使<code>salt</code>与第三方系统集成变得更加简单。</p>\n</blockquote>\n<h2 id=\"salt-api安装配置\"><a href=\"#salt-api安装配置\" class=\"headerlink\" title=\"salt-api安装配置\"></a>salt-api安装配置</h2><p>1）在<code>salt-master</code>上进行安装<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-api</span><br></pre></td></tr></table></figure></p>\n<p>2）自签名证书，生产环境可以购买（说明：如果没有<code>salt-call</code>命令，装上<code>salt-minion</code>即可，依赖于该包）<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt-call --local tls.create_self_signed_cert</span></span><br><span class=\"line\"><span class=\"keyword\">local</span>:</span><br><span class=\"line\">    Created Private Key: <span class=\"string\">\"/etc/pki/tls/certs/localhost.key.\"</span> Created Certificate: <span class=\"string\">\"/etc/pki/tls/certs/localhost.crt.\"</span></span><br></pre></td></tr></table></figure></p>\n<p>3）打开<code>include</code>加载子配置文件，方便管理<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">default_include: <span class=\"literal\">master</span>.d/*.conf</span><br></pre></td></tr></table></figure></p>\n<p>4）配置<code>api</code>配置文件，将上面生成的证书写到配置文件<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master.d/api.conf</span></span><br><span class=\"line\"><span class=\"symbol\">rest_cherrypy:</span></span><br><span class=\"line\"><span class=\"symbol\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.30</span></span><br><span class=\"line\"><span class=\"symbol\">  port:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"symbol\">  ssl_crt:</span> <span class=\"meta-keyword\">/etc/</span>pki<span class=\"meta-keyword\">/tls/</span>certs/localhost.crt</span><br><span class=\"line\"><span class=\"symbol\">  ssl_key:</span> <span class=\"meta-keyword\">/etc/</span>pki<span class=\"meta-keyword\">/tls/</span>certs/localhost.key</span><br></pre></td></tr></table></figure></p>\n<p>5）创建认证用户，并设置密码<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# useradd</span> -M -s /sbin/nologin saltapi</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> 'saltapi' | passwd --stdin saltapi</span><br></pre></td></tr></table></figure></p>\n<p>6）创建认证配置文件<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# vim /etc/salt/master.d/auth.conf</span><br><span class=\"line\">external_auth:</span><br><span class=\"line\">  pam:</span><br><span class=\"line\">    saltapi:</span><br><span class=\"line\">      -<span class=\"ruby\"> .*</span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@wheel'</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@runner'</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@jobs'</span></span></span><br></pre></td></tr></table></figure></p>\n<p>7）重启<code>salt-master</code>和启动<code>salt-api</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-api</span><br></pre></td></tr></table></figure></p>\n<p>8）查看<code>salt-api</code>监听端口<br><figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# netstat -anlutp |grep <span class=\"number\">8000</span></span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">8000</span>       <span class=\"number\">0.0</span><span class=\"meta\">.0</span><span class=\"meta\">.0</span>:*               LISTEN      <span class=\"number\">10904</span>/python        </span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">53414</span>      <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">8000</span>       TIME_WAIT   -</span><br></pre></td></tr></table></figure></p>\n<p>9）验证<code>login</code>登录，获取<code>token</code>字符串<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># curl -sSk https://192.168.1.30:8000/login \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d username=saltapi <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d password=saltapi <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d eauth=pam</span><br><span class=\"line\">return:</span><br><span class=\"line\">- eauth: pam</span><br><span class=\"line\">  expire: <span class=\"number\">1558663247.869537</span></span><br><span class=\"line\">  perms:</span><br><span class=\"line\">  - .*</span><br><span class=\"line\">  - <span class=\"string\">'@wheel'</span></span><br><span class=\"line\">  - <span class=\"string\">'@runner'</span></span><br><span class=\"line\">  - <span class=\"string\">'@jobs'</span></span><br><span class=\"line\">  start: <span class=\"number\">1558620047.869536</span></span><br><span class=\"line\">  token: e8330f642a3addd853c723d63844d29a12de9484</span><br><span class=\"line\">  user: saltapi</span><br></pre></td></tr></table></figure></p>\n<p>10）通过<code>api</code>执行<code>test.ping</code>测试连通性<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# curl -sSk https:<span class=\"comment\">//192.168.1.30:8000 \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> \\</span><br><span class=\"line\">&gt;     -H <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\\</span><br><span class=\"line\">&gt;     -d client=local \\</span><br><span class=\"line\">&gt;     -d tgt=<span class=\"string\">'*'</span> \\</span><br><span class=\"line\">&gt;     -d <span class=\"function\"><span class=\"keyword\">fun</span>=test.ping</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>:</span><br><span class=\"line\">- salt-minion01: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion02: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion03: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion04: <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></p>\n<p>11）通过<code>api</code>执行<code>cmd.run</code><br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# curl -sSk https:<span class=\"comment\">//192.168.1.30:8000 \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> \\</span><br><span class=\"line\">&gt;     -H <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\\</span><br><span class=\"line\">&gt;     -d client=local \\</span><br><span class=\"line\">&gt;     -d tgt=<span class=\"string\">'*'</span> \\</span><br><span class=\"line\">&gt;     -d <span class=\"function\"><span class=\"keyword\">fun</span>='cmd.run' -d arg='uptime'</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>:</span><br><span class=\"line\">- salt-minion01: <span class=\"string\">' 22:10:25 up 46 min,  1 user,  load average: 0.00, 0.01, 0.05'</span></span><br><span class=\"line\">  salt-minion02: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.00, 0.18, 0.15'</span></span><br><span class=\"line\">  salt-minion03: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.06, 0.33, 0.26'</span></span><br><span class=\"line\">  salt-minion04: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.01, 0.21, 0.16'</span></span><br></pre></td></tr></table></figure></p>\n<p>12）通过<code>api</code>获取<code>grains</code>信息`<br><figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master <span class=\"symbol\">~]# curl -sSk https</span>:<span class=\"comment\">//192.168.1.30:8000/minions/salt-minion01 \\</span></span><br><span class=\"line\">&gt;     -H 'Accept: application/x-yaml' \\</span><br><span class=\"line\">&gt;     -H 'X-Auth-Token: e<span class=\"number\">8330</span>f642a3addd853c723d<span class=\"number\">6384</span>4d29a12de<span class=\"number\">9484</span>'</span><br><span class=\"line\">return:</span><br><span class=\"line\">- salt-minion01:</span><br><span class=\"line\">    SSDs: []</span><br><span class=\"line\">    biosreleasedate: <span class=\"number\">05</span>/<span class=\"number\">19</span>/<span class=\"number\">2017</span></span><br><span class=\"line\">    biosversion: '6.00'</span><br><span class=\"line\">    cpu_flags:</span><br><span class=\"line\">    - fpu</span><br><span class=\"line\">    - vme</span><br><span class=\"line\">    - de</span><br><span class=\"line\">    - pse</span><br><span class=\"line\">    - tsc</span><br><span class=\"line\">.....</span><br></pre></td></tr></table></figure></p>\n<p>13）使用<code>json</code>格式<br><figure class=\"highlight prolog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# curl -sSk https://<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.30</span>:<span class=\"number\">8000</span>/minions/salt-minion01 \\</span><br><span class=\"line\">&gt;     -<span class=\"symbol\">H</span> <span class=\"string\">'Accept: application/json'</span> \\</span><br><span class=\"line\">&gt;     -<span class=\"symbol\">H</span> <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span></span><br><span class=\"line\">&#123;<span class=\"string\">\"return\"</span>: [&#123;<span class=\"string\">\"salt-minion01\"</span>: &#123;<span class=\"string\">\"biosversion\"</span>: <span class=\"string\">\"6.00\"</span>, <span class=\"string\">\"kernel\"</span>: <span class=\"string\">\"Linux\"</span>, <span class=\"string\">\"domain\"</span>: <span class=\"string\">\"\"</span>, <span class=\"string\">\"uid\"</span>: <span class=\"number\">0</span>, <span class=\"string\">\"zmqversion\"</span>: <span class=\"string\">\"4.1.4\"</span>, <span class=\"string\">\"kernelrelease\"</span>: <span class=\"string\">\"3.10.0-693.el7.x86_64\"</span>, <span class=\"string\">\"selinux\"</span>: &#123;<span class=\"string\">\"enforced\"</span>: <span class=\"string\">\"Disabled\"</span>, <span class=\"string\">\"enabled\"</span>: false&#125;, <span class=\"string\">\"serialnumber\"</span>: <span class=\"string\">\"VMware-56 4d 9e a0 21 56 90 87-cd 89 69 32 13 94 17 44\"</span>, <span class=\"string\">\"pid\"</span>: <span class=\"number\">1449</span>, <span class=\"string\">\"fqdns\"</span>: [], <span class=\"string\">\"ip_interfaces\"</span>: &#123;<span class=\"string\">\"lo\"</span>: [<span class=\"string\">\"127.0.0.1\"</span>, <span class=\"string\">\"::1\"</span>], <span class=\"string\">\"virbr0\"</span>: [<span class=\"string\">\"192.168.122.1\"</span>], <span class=\"string\">\"virbr0-nic\"</span>: [], <span class=\"string\">\"ens33\"</span>: [<span class=\"string\">\"192.168.1.31\"</span>, <span class=\"string\">\"192.168.1.100\"</span>, <span class=\"string\">\"fe80::20c:29ff:fe94:1744\"</span>]&#125;, <span class=\"string\">\"groupname\"</span>: <span class=\"string\">\"root\"</span>, <span class=\"string\">\"fqdn_ip6\"</span>: [<span class=\"string\">\"fe80::20c:29ff:fe94:1744\"</span>],</span><br><span class=\"line\">.......</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><blockquote>\n<p><code>salt-api</code>必须使用<code>https</code>，生产环境建议使用可信证书<br>当<code>salt-api</code>服务重启后原<code>token</code>失效</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p><a href=\"https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html\" target=\"_blank\" rel=\"noopener\">参考官档</a><br><a href=\"https://www.unixhot.com/docs/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html#a-rest-api-for-salt\" target=\"_blank\" rel=\"noopener\">参考官档</a></p>\n<blockquote>\n<p><code>SaltStack</code>官方提供有<code>REST API</code>格式的<code>salt-api</code>项目，将使<code>salt</code>与第三方系统集成变得更加简单。</p>\n</blockquote>\n<h2 id=\"salt-api安装配置\"><a href=\"#salt-api安装配置\" class=\"headerlink\" title=\"salt-api安装配置\"></a>salt-api安装配置</h2><p>1）在<code>salt-master</code>上进行安装<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-api</span><br></pre></td></tr></table></figure></p>\n<p>2）自签名证书，生产环境可以购买（说明：如果没有<code>salt-call</code>命令，装上<code>salt-minion</code>即可，依赖于该包）<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt-call --local tls.create_self_signed_cert</span></span><br><span class=\"line\"><span class=\"keyword\">local</span>:</span><br><span class=\"line\">    Created Private Key: <span class=\"string\">\"/etc/pki/tls/certs/localhost.key.\"</span> Created Certificate: <span class=\"string\">\"/etc/pki/tls/certs/localhost.crt.\"</span></span><br></pre></td></tr></table></figure></p>\n<p>3）打开<code>include</code>加载子配置文件，方便管理<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">default_include: <span class=\"literal\">master</span>.d/*.conf</span><br></pre></td></tr></table></figure></p>\n<p>4）配置<code>api</code>配置文件，将上面生成的证书写到配置文件<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master.d/api.conf</span></span><br><span class=\"line\"><span class=\"symbol\">rest_cherrypy:</span></span><br><span class=\"line\"><span class=\"symbol\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.30</span></span><br><span class=\"line\"><span class=\"symbol\">  port:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"symbol\">  ssl_crt:</span> <span class=\"meta-keyword\">/etc/</span>pki<span class=\"meta-keyword\">/tls/</span>certs/localhost.crt</span><br><span class=\"line\"><span class=\"symbol\">  ssl_key:</span> <span class=\"meta-keyword\">/etc/</span>pki<span class=\"meta-keyword\">/tls/</span>certs/localhost.key</span><br></pre></td></tr></table></figure></p>\n<p>5）创建认证用户，并设置密码<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# useradd</span> -M -s /sbin/nologin saltapi</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> 'saltapi' | passwd --stdin saltapi</span><br></pre></td></tr></table></figure></p>\n<p>6）创建认证配置文件<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# vim /etc/salt/master.d/auth.conf</span><br><span class=\"line\">external_auth:</span><br><span class=\"line\">  pam:</span><br><span class=\"line\">    saltapi:</span><br><span class=\"line\">      -<span class=\"ruby\"> .*</span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@wheel'</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@runner'</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@jobs'</span></span></span><br></pre></td></tr></table></figure></p>\n<p>7）重启<code>salt-master</code>和启动<code>salt-api</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-api</span><br></pre></td></tr></table></figure></p>\n<p>8）查看<code>salt-api</code>监听端口<br><figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# netstat -anlutp |grep <span class=\"number\">8000</span></span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">8000</span>       <span class=\"number\">0.0</span><span class=\"meta\">.0</span><span class=\"meta\">.0</span>:*               LISTEN      <span class=\"number\">10904</span>/python        </span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">53414</span>      <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">8000</span>       TIME_WAIT   -</span><br></pre></td></tr></table></figure></p>\n<p>9）验证<code>login</code>登录，获取<code>token</code>字符串<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># curl -sSk https://192.168.1.30:8000/login \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d username=saltapi <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d password=saltapi <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d eauth=pam</span><br><span class=\"line\">return:</span><br><span class=\"line\">- eauth: pam</span><br><span class=\"line\">  expire: <span class=\"number\">1558663247.869537</span></span><br><span class=\"line\">  perms:</span><br><span class=\"line\">  - .*</span><br><span class=\"line\">  - <span class=\"string\">'@wheel'</span></span><br><span class=\"line\">  - <span class=\"string\">'@runner'</span></span><br><span class=\"line\">  - <span class=\"string\">'@jobs'</span></span><br><span class=\"line\">  start: <span class=\"number\">1558620047.869536</span></span><br><span class=\"line\">  token: e8330f642a3addd853c723d63844d29a12de9484</span><br><span class=\"line\">  user: saltapi</span><br></pre></td></tr></table></figure></p>\n<p>10）通过<code>api</code>执行<code>test.ping</code>测试连通性<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# curl -sSk https:<span class=\"comment\">//192.168.1.30:8000 \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> \\</span><br><span class=\"line\">&gt;     -H <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\\</span><br><span class=\"line\">&gt;     -d client=local \\</span><br><span class=\"line\">&gt;     -d tgt=<span class=\"string\">'*'</span> \\</span><br><span class=\"line\">&gt;     -d <span class=\"function\"><span class=\"keyword\">fun</span>=test.ping</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>:</span><br><span class=\"line\">- salt-minion01: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion02: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion03: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion04: <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></p>\n<p>11）通过<code>api</code>执行<code>cmd.run</code><br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# curl -sSk https:<span class=\"comment\">//192.168.1.30:8000 \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> \\</span><br><span class=\"line\">&gt;     -H <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\\</span><br><span class=\"line\">&gt;     -d client=local \\</span><br><span class=\"line\">&gt;     -d tgt=<span class=\"string\">'*'</span> \\</span><br><span class=\"line\">&gt;     -d <span class=\"function\"><span class=\"keyword\">fun</span>='cmd.run' -d arg='uptime'</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>:</span><br><span class=\"line\">- salt-minion01: <span class=\"string\">' 22:10:25 up 46 min,  1 user,  load average: 0.00, 0.01, 0.05'</span></span><br><span class=\"line\">  salt-minion02: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.00, 0.18, 0.15'</span></span><br><span class=\"line\">  salt-minion03: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.06, 0.33, 0.26'</span></span><br><span class=\"line\">  salt-minion04: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.01, 0.21, 0.16'</span></span><br></pre></td></tr></table></figure></p>\n<p>12）通过<code>api</code>获取<code>grains</code>信息`<br><figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master <span class=\"symbol\">~]# curl -sSk https</span>:<span class=\"comment\">//192.168.1.30:8000/minions/salt-minion01 \\</span></span><br><span class=\"line\">&gt;     -H 'Accept: application/x-yaml' \\</span><br><span class=\"line\">&gt;     -H 'X-Auth-Token: e<span class=\"number\">8330</span>f642a3addd853c723d<span class=\"number\">6384</span>4d29a12de<span class=\"number\">9484</span>'</span><br><span class=\"line\">return:</span><br><span class=\"line\">- salt-minion01:</span><br><span class=\"line\">    SSDs: []</span><br><span class=\"line\">    biosreleasedate: <span class=\"number\">05</span>/<span class=\"number\">19</span>/<span class=\"number\">2017</span></span><br><span class=\"line\">    biosversion: '6.00'</span><br><span class=\"line\">    cpu_flags:</span><br><span class=\"line\">    - fpu</span><br><span class=\"line\">    - vme</span><br><span class=\"line\">    - de</span><br><span class=\"line\">    - pse</span><br><span class=\"line\">    - tsc</span><br><span class=\"line\">.....</span><br></pre></td></tr></table></figure></p>\n<p>13）使用<code>json</code>格式<br><figure class=\"highlight prolog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# curl -sSk https://<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.30</span>:<span class=\"number\">8000</span>/minions/salt-minion01 \\</span><br><span class=\"line\">&gt;     -<span class=\"symbol\">H</span> <span class=\"string\">'Accept: application/json'</span> \\</span><br><span class=\"line\">&gt;     -<span class=\"symbol\">H</span> <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span></span><br><span class=\"line\">&#123;<span class=\"string\">\"return\"</span>: [&#123;<span class=\"string\">\"salt-minion01\"</span>: &#123;<span class=\"string\">\"biosversion\"</span>: <span class=\"string\">\"6.00\"</span>, <span class=\"string\">\"kernel\"</span>: <span class=\"string\">\"Linux\"</span>, <span class=\"string\">\"domain\"</span>: <span class=\"string\">\"\"</span>, <span class=\"string\">\"uid\"</span>: <span class=\"number\">0</span>, <span class=\"string\">\"zmqversion\"</span>: <span class=\"string\">\"4.1.4\"</span>, <span class=\"string\">\"kernelrelease\"</span>: <span class=\"string\">\"3.10.0-693.el7.x86_64\"</span>, <span class=\"string\">\"selinux\"</span>: &#123;<span class=\"string\">\"enforced\"</span>: <span class=\"string\">\"Disabled\"</span>, <span class=\"string\">\"enabled\"</span>: false&#125;, <span class=\"string\">\"serialnumber\"</span>: <span class=\"string\">\"VMware-56 4d 9e a0 21 56 90 87-cd 89 69 32 13 94 17 44\"</span>, <span class=\"string\">\"pid\"</span>: <span class=\"number\">1449</span>, <span class=\"string\">\"fqdns\"</span>: [], <span class=\"string\">\"ip_interfaces\"</span>: &#123;<span class=\"string\">\"lo\"</span>: [<span class=\"string\">\"127.0.0.1\"</span>, <span class=\"string\">\"::1\"</span>], <span class=\"string\">\"virbr0\"</span>: [<span class=\"string\">\"192.168.122.1\"</span>], <span class=\"string\">\"virbr0-nic\"</span>: [], <span class=\"string\">\"ens33\"</span>: [<span class=\"string\">\"192.168.1.31\"</span>, <span class=\"string\">\"192.168.1.100\"</span>, <span class=\"string\">\"fe80::20c:29ff:fe94:1744\"</span>]&#125;, <span class=\"string\">\"groupname\"</span>: <span class=\"string\">\"root\"</span>, <span class=\"string\">\"fqdn_ip6\"</span>: [<span class=\"string\">\"fe80::20c:29ff:fe94:1744\"</span>],</span><br><span class=\"line\">.......</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><blockquote>\n<p><code>salt-api</code>必须使用<code>https</code>，生产环境建议使用可信证书<br>当<code>salt-api</code>服务重启后原<code>token</code>失效</p>\n</blockquote>\n"},{"title":"saltstack状态判断unless与onlyif","date":"2019-05-17T07:43:05.000Z","copyright":true,"_content":">很多时候我们在编写`state` 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的`unless`和`onlyif`。\n\n## unless\n`unless`示例：需求创建`/tmp/unless.txt`文件，存在则不创建，不存在则创建\n```\n[root@salt-master ~]# cat /srv/salt/prod/unless.sls \ntest-unless:\n  cmd.run:\n    - name: touch /tmp/unless.txt\n    - unless: test -f /tmp/unless.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: Command \"touch /tmp/unless.txt\" run\n     Started: 15:10:51.522319\n    Duration: 31.822 ms\n     Changes:   \n              ----------\n              pid:\n                  6538\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  31.822 ms\n#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: unless condition is true\n     Started: 15:11:40.819789\n    Duration: 10.477 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  10.477 ms\n#第二次执行，可以看到该文件已经存在，并没有再次创建\n```\n>通过上面的小案例可以看出，当`unless`返回为真则不执行，当`unless`返回为假才执行。\n\n## onlyif\n> `onlyif`正好和`unless`相反，当`onlyif`返回为真执行，当`onlyif`返回为假不执行\n\n`onlyif`示例：需求，当`/tmp/onlyif.txt`文件存在，则创建`/tmp/onlyif`目录，不存在，则不创建`/tmp/onlyif`目录\n```\n[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls \ntest-onlyif:\n  cmd.run:\n    - name: mkdir /tmp/onlyif\n    - onlyif: test -f /tmp/onlyif.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: onlyif condition is false\n     Started: 15:34:56.460583\n    Duration: 9.612 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:   9.612 ms\n\n#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行\n[root@salt-master ~]# salt 'salt-minion01' cmd.run \"touch /tmp/onlyif.txt\"\nsalt-minion01:\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: Command \"mkdir /tmp/onlyif\" run\n     Started: 15:38:07.712492\n    Duration: 14.646 ms\n     Changes:   \n              ----------\n              pid:\n                  6871\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  14.646 ms\n\n#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录\n```\n## Redis主从架构案例\n说明：该案例在`prod`环境配置\n![redis主从环境](saltstack状态判断unless与onlyif/01.png)\n\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir -p /srv/salt/prod/redis/files/\n```\n3）编写`state sls`状态文件\n```\n#初始化redis（安装和基本配置）\n[root@salt-master ~]# cat /srv/salt/prod/redis/init.sls \nredis-install:\n  pkg.installed:\n    - name: redis\n\nredis-config:\n  file.managed:\n    - name: /etc/redis.conf\n    - source: salt://redis/files/redis.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      BIND: {{ grains['fqdn_ip4'][0] }}\n      PORT: 6379\n      DAEMONIZA: 'yes'\n    - require:\n      - pkg: redis-install\n\nredis-service:\n  service.running:\n    - name: redis\n    - enable: True\n    - watch:\n      - file: redis-config\n\n\n#master直接引入 init\n[root@salt-master ~]# cat /srv/salt/prod/redis/master.sls \ninclude:\n  - redis.init\n\n\n#slave引入init 并配置主从信息\n[root@salt-master ~]# cat /srv/salt/prod/redis/slave.sls \ninclude:\n  - redis.init\n\n#配置主从\nslave-config:\n  cmd.run:\n    - name: redis-cli -h 192.168.1.34 slaveof 192.168.1.33 6379\n    - unless: redis-cli -h 192.168.1.34 info |grep role:slave\n    - require:\n      - service: redis-service\n\n说明：\nunless：返回为真则不执行，反之为假则执行\n```\n4）配置文件准备\n```\n[root@salt-master ~]# grep \"^[a-Z]\" /etc/redis.conf  >>/srv/salt/prod/redis/files/redis.conf\n[root@salt-master ~]# cat /srv/salt/prod/redis/files/redis.conf \n#这里使用jinja\nbind {{ BIND }}\nprotected-mode yes\n#这里使用jinja\nport {{ PORT }}\ntcp-backlog 511\ntimeout 0\ntcp-keepalive 300\n#这里使用jinja\ndaemonize {{ DAEMONIZA }}\nsupervised no\npidfile /var/run/redis_6379.pid\nloglevel notice\nlogfile /var/log/redis/redis.log\ndatabases 16\nsave 900 1\nsave 300 10\nsave 60 10000\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename dump.rdb\ndir /var/lib/redis\nslave-serve-stale-data yes\nslave-read-only yes\nrepl-diskless-sync no\nrepl-diskless-sync-delay 5\nrepl-disable-tcp-nodelay no\nslave-priority 100\nappendonly no\nappendfilename \"appendonly.aof\"\nappendfsync everysec\nno-appendfsync-on-rewrite no\nauto-aof-rewrite-percentage 100\nauto-aof-rewrite-min-size 64mb\naof-load-truncated yes\nlua-time-limit 5000\nslowlog-log-slower-than 10000\nslowlog-max-len 128\nlatency-monitor-threshold 0\nnotify-keyspace-events \"\"\nhash-max-ziplist-entries 512\nhash-max-ziplist-value 64\nlist-max-ziplist-size -2\nlist-compress-depth 0\nset-max-intset-entries 512\nzset-max-ziplist-entries 128\nzset-max-ziplist-value 64\nhll-sparse-max-bytes 3000\nactiverehashing yes\nclient-output-buffer-limit normal 0 0 0\nclient-output-buffer-limit slave 256mb 64mb 60\nclient-output-buffer-limit pubsub 32mb 8mb 60\nhz 10\naof-rewrite-incremental-fsync yes\n```\n5）`top file`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  'salt-minion02':\n    - redis.master\n  'salt-minion03':\n    - redis.slave\n```\n6）整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/prod/redis/\n/srv/salt/prod/redis/\n├── files\n│   └── redis.conf\n├── init.sls\n├── master.sls\n└── slave.sls\n\n1 directory, 4 files\n```\n7）`top file`高级状态执行\n```\n#先测试下看下状态文件是否编写正确，再正式执行\n[root@salt-master ~]# salt '*' state.highstate test=True\n[root@salt-master ~]# salt '*' state.highstate\n```\n","source":"_posts/saltstack状态判断unless与onlyif.md","raw":"---\ntitle: saltstack状态判断unless与onlyif\ndate: 2019-05-17 15:43:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n>很多时候我们在编写`state` 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的`unless`和`onlyif`。\n\n## unless\n`unless`示例：需求创建`/tmp/unless.txt`文件，存在则不创建，不存在则创建\n```\n[root@salt-master ~]# cat /srv/salt/prod/unless.sls \ntest-unless:\n  cmd.run:\n    - name: touch /tmp/unless.txt\n    - unless: test -f /tmp/unless.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: Command \"touch /tmp/unless.txt\" run\n     Started: 15:10:51.522319\n    Duration: 31.822 ms\n     Changes:   \n              ----------\n              pid:\n                  6538\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  31.822 ms\n#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: unless condition is true\n     Started: 15:11:40.819789\n    Duration: 10.477 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  10.477 ms\n#第二次执行，可以看到该文件已经存在，并没有再次创建\n```\n>通过上面的小案例可以看出，当`unless`返回为真则不执行，当`unless`返回为假才执行。\n\n## onlyif\n> `onlyif`正好和`unless`相反，当`onlyif`返回为真执行，当`onlyif`返回为假不执行\n\n`onlyif`示例：需求，当`/tmp/onlyif.txt`文件存在，则创建`/tmp/onlyif`目录，不存在，则不创建`/tmp/onlyif`目录\n```\n[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls \ntest-onlyif:\n  cmd.run:\n    - name: mkdir /tmp/onlyif\n    - onlyif: test -f /tmp/onlyif.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: onlyif condition is false\n     Started: 15:34:56.460583\n    Duration: 9.612 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:   9.612 ms\n\n#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行\n[root@salt-master ~]# salt 'salt-minion01' cmd.run \"touch /tmp/onlyif.txt\"\nsalt-minion01:\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: Command \"mkdir /tmp/onlyif\" run\n     Started: 15:38:07.712492\n    Duration: 14.646 ms\n     Changes:   \n              ----------\n              pid:\n                  6871\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  14.646 ms\n\n#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录\n```\n## Redis主从架构案例\n说明：该案例在`prod`环境配置\n![redis主从环境](saltstack状态判断unless与onlyif/01.png)\n\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir -p /srv/salt/prod/redis/files/\n```\n3）编写`state sls`状态文件\n```\n#初始化redis（安装和基本配置）\n[root@salt-master ~]# cat /srv/salt/prod/redis/init.sls \nredis-install:\n  pkg.installed:\n    - name: redis\n\nredis-config:\n  file.managed:\n    - name: /etc/redis.conf\n    - source: salt://redis/files/redis.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      BIND: {{ grains['fqdn_ip4'][0] }}\n      PORT: 6379\n      DAEMONIZA: 'yes'\n    - require:\n      - pkg: redis-install\n\nredis-service:\n  service.running:\n    - name: redis\n    - enable: True\n    - watch:\n      - file: redis-config\n\n\n#master直接引入 init\n[root@salt-master ~]# cat /srv/salt/prod/redis/master.sls \ninclude:\n  - redis.init\n\n\n#slave引入init 并配置主从信息\n[root@salt-master ~]# cat /srv/salt/prod/redis/slave.sls \ninclude:\n  - redis.init\n\n#配置主从\nslave-config:\n  cmd.run:\n    - name: redis-cli -h 192.168.1.34 slaveof 192.168.1.33 6379\n    - unless: redis-cli -h 192.168.1.34 info |grep role:slave\n    - require:\n      - service: redis-service\n\n说明：\nunless：返回为真则不执行，反之为假则执行\n```\n4）配置文件准备\n```\n[root@salt-master ~]# grep \"^[a-Z]\" /etc/redis.conf  >>/srv/salt/prod/redis/files/redis.conf\n[root@salt-master ~]# cat /srv/salt/prod/redis/files/redis.conf \n#这里使用jinja\nbind {{ BIND }}\nprotected-mode yes\n#这里使用jinja\nport {{ PORT }}\ntcp-backlog 511\ntimeout 0\ntcp-keepalive 300\n#这里使用jinja\ndaemonize {{ DAEMONIZA }}\nsupervised no\npidfile /var/run/redis_6379.pid\nloglevel notice\nlogfile /var/log/redis/redis.log\ndatabases 16\nsave 900 1\nsave 300 10\nsave 60 10000\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename dump.rdb\ndir /var/lib/redis\nslave-serve-stale-data yes\nslave-read-only yes\nrepl-diskless-sync no\nrepl-diskless-sync-delay 5\nrepl-disable-tcp-nodelay no\nslave-priority 100\nappendonly no\nappendfilename \"appendonly.aof\"\nappendfsync everysec\nno-appendfsync-on-rewrite no\nauto-aof-rewrite-percentage 100\nauto-aof-rewrite-min-size 64mb\naof-load-truncated yes\nlua-time-limit 5000\nslowlog-log-slower-than 10000\nslowlog-max-len 128\nlatency-monitor-threshold 0\nnotify-keyspace-events \"\"\nhash-max-ziplist-entries 512\nhash-max-ziplist-value 64\nlist-max-ziplist-size -2\nlist-compress-depth 0\nset-max-intset-entries 512\nzset-max-ziplist-entries 128\nzset-max-ziplist-value 64\nhll-sparse-max-bytes 3000\nactiverehashing yes\nclient-output-buffer-limit normal 0 0 0\nclient-output-buffer-limit slave 256mb 64mb 60\nclient-output-buffer-limit pubsub 32mb 8mb 60\nhz 10\naof-rewrite-incremental-fsync yes\n```\n5）`top file`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  'salt-minion02':\n    - redis.master\n  'salt-minion03':\n    - redis.slave\n```\n6）整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/prod/redis/\n/srv/salt/prod/redis/\n├── files\n│   └── redis.conf\n├── init.sls\n├── master.sls\n└── slave.sls\n\n1 directory, 4 files\n```\n7）`top file`高级状态执行\n```\n#先测试下看下状态文件是否编写正确，再正式执行\n[root@salt-master ~]# salt '*' state.highstate test=True\n[root@salt-master ~]# salt '*' state.highstate\n```\n","slug":"saltstack状态判断unless与onlyif","published":1,"updated":"2019-05-28T13:55:11.365Z","_id":"cjxwlqrkt000qlctc7ixp4qe4","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>很多时候我们在编写<code>state</code> 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的<code>unless</code>和<code>onlyif</code>。</p>\n</blockquote>\n<h2 id=\"unless\"><a href=\"#unless\" class=\"headerlink\" title=\"unless\"></a>unless</h2><p><code>unless</code>示例：需求创建<code>/tmp/unless.txt</code>文件，存在则不创建，不存在则创建<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/unless.sls </span><br><span class=\"line\">test-unless:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">    - unless: test -f /tmp/unless.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"touch /tmp/unless.txt\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:10:51.522319</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 31.822 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6538</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  31.822 ms</span><br><span class=\"line\">#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: unless condition is true</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:11:40.819789</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 10.477 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  10.477 ms</span><br><span class=\"line\">#第二次执行，可以看到该文件已经存在，并没有再次创建</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>通过上面的小案例可以看出，当<code>unless</code>返回为真则不执行，当<code>unless</code>返回为假才执行。</p>\n</blockquote>\n<h2 id=\"onlyif\"><a href=\"#onlyif\" class=\"headerlink\" title=\"onlyif\"></a>onlyif</h2><blockquote>\n<p><code>onlyif</code>正好和<code>unless</code>相反，当<code>onlyif</code>返回为真执行，当<code>onlyif</code>返回为假不执行</p>\n</blockquote>\n<p><code>onlyif</code>示例：需求，当<code>/tmp/onlyif.txt</code>文件存在，则创建<code>/tmp/onlyif</code>目录，不存在，则不创建<code>/tmp/onlyif</code>目录<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls </span><br><span class=\"line\">test-onlyif:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">    - onlyif: test -f /tmp/onlyif.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: onlyif condition is false</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:34:56.460583</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 9.612 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:   9.612 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> cmd.run \"touch /tmp/onlyif.txt\"</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"mkdir /tmp/onlyif\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:38:07.712492</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 14.646 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6871</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  14.646 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Redis主从架构案例\"><a href=\"#Redis主从架构案例\" class=\"headerlink\" title=\"Redis主从架构案例\"></a>Redis主从架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br><img src=\"/2019/05/17/saltstack状态判断unless与onlyif/01.png\" alt=\"redis主从环境\"></p>\n<p>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/prod/redis/files/</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>state sls</code>状态文件<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#初始化redis（安装和基本配置）</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/init.sls</span> </span><br><span class=\"line\"><span class=\"attr\">redis-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://redis/files/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      BIND:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">      DAEMONIZA:</span> <span class=\"string\">'yes'</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">redis-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">redis-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#master直接引入 init</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/master.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#slave引入init 并配置主从信息</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/slave.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置主从</span></span><br><span class=\"line\"><span class=\"attr\">slave-config:</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">slaveof</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">info</span> <span class=\"string\">|grep</span> <span class=\"attr\">role:slave</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - service:</span> <span class=\"string\">redis-service</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">说明：</span></span><br><span class=\"line\"><span class=\"string\">unless：返回为真则不执行，反之为假则执行</span></span><br></pre></td></tr></table></figure></p>\n<p>4）配置文件准备<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">grep</span> <span class=\"string\">\"^[a-Z]\"</span> /etc/redis.<span class=\"keyword\">conf</span>  &gt;&gt;/srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span> </span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">bind &#123;&#123; BIND &#125;&#125;</span><br><span class=\"line\">protected-<span class=\"keyword\">mode</span> yes</span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">port &#123;&#123; PORT &#125;&#125;</span><br><span class=\"line\">tcp-backlog <span class=\"number\">511</span></span><br><span class=\"line\">timeout <span class=\"number\">0</span></span><br><span class=\"line\">tcp-keepalive <span class=\"number\">300</span></span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">daemonize &#123;&#123; DAEMONIZA &#125;&#125;</span><br><span class=\"line\">supervised <span class=\"keyword\">no</span></span><br><span class=\"line\">pidfile /var/run/redis_6379.pid</span><br><span class=\"line\">loglevel notice</span><br><span class=\"line\">logfile /var/<span class=\"built_in\">log</span>/redis/redis.<span class=\"built_in\">log</span></span><br><span class=\"line\">databases <span class=\"number\">16</span></span><br><span class=\"line\">save <span class=\"number\">900</span> <span class=\"number\">1</span></span><br><span class=\"line\">save <span class=\"number\">300</span> <span class=\"number\">10</span></span><br><span class=\"line\">save <span class=\"number\">60</span> <span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"keyword\">stop</span>-writes-<span class=\"keyword\">on</span>-bgsave-error yes</span><br><span class=\"line\">rdbcompression yes</span><br><span class=\"line\">rdbchecksum yes</span><br><span class=\"line\">dbfilename dump.rdb</span><br><span class=\"line\">dir /var/lib/redis</span><br><span class=\"line\">slave-serve-stale-data yes</span><br><span class=\"line\">slave-<span class=\"keyword\">read</span>-<span class=\"keyword\">only</span> yes</span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span> <span class=\"keyword\">no</span></span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span>-delay <span class=\"number\">5</span></span><br><span class=\"line\">repl-disable-tcp-nodelay <span class=\"keyword\">no</span></span><br><span class=\"line\">slave-priority <span class=\"number\">100</span></span><br><span class=\"line\">appendonly <span class=\"keyword\">no</span></span><br><span class=\"line\">appendfilename <span class=\"string\">\"appendonly.aof\"</span></span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"><span class=\"keyword\">no</span>-appendfsync-<span class=\"keyword\">on</span>-rewrite <span class=\"keyword\">no</span></span><br><span class=\"line\">auto-aof-rewrite-percentage <span class=\"number\">100</span></span><br><span class=\"line\">auto-aof-rewrite-<span class=\"built_in\">min</span>-size <span class=\"number\">64</span>mb</span><br><span class=\"line\">aof-load-truncated yes</span><br><span class=\"line\"><span class=\"keyword\">lua</span>-time-limit <span class=\"number\">5000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">log</span>-slower-than <span class=\"number\">10000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">max</span>-<span class=\"built_in\">len</span> <span class=\"number\">128</span></span><br><span class=\"line\">latency-monitor-threshold <span class=\"number\">0</span></span><br><span class=\"line\">notify-keyspace-events <span class=\"string\">\"\"</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">512</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-<span class=\"built_in\">max</span>-ziplist-size -<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-compress-depth <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">set</span>-<span class=\"built_in\">max</span>-intset-entries <span class=\"number\">512</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">128</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\">hll-sparse-<span class=\"built_in\">max</span>-bytes <span class=\"number\">3000</span></span><br><span class=\"line\">activerehashing yes</span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit <span class=\"keyword\">normal</span> <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">0</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit slave <span class=\"number\">256</span>mb <span class=\"number\">64</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit pubsub <span class=\"number\">32</span>mb <span class=\"number\">8</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">hz <span class=\"number\">10</span></span><br><span class=\"line\">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>top file</code>文件编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  'salt-minion02':</span><br><span class=\"line\">    - redis.<span class=\"literal\">master</span></span><br><span class=\"line\">  'salt-minion03':</span><br><span class=\"line\">    - redis.<span class=\"literal\">slave</span></span><br></pre></td></tr></table></figure></p>\n<p>6）整体<code>state</code>文件查看<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /srv/salt/prod/redis/</span><br><span class=\"line\">/srv/salt/prod/redis/</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── redis.conf</span><br><span class=\"line\">├── init.sls</span><br><span class=\"line\">├── <span class=\"literal\">master</span>.sls</span><br><span class=\"line\">└── <span class=\"literal\">slave</span>.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">4</span> files</span><br></pre></td></tr></table></figure></p>\n<p>7）<code>top file</code>高级状态执行<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#先测试下看下状态文件是否编写正确，再正式执行</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate <span class=\"attr\">test=</span><span class=\"literal\">True</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>很多时候我们在编写<code>state</code> 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的<code>unless</code>和<code>onlyif</code>。</p>\n</blockquote>\n<h2 id=\"unless\"><a href=\"#unless\" class=\"headerlink\" title=\"unless\"></a>unless</h2><p><code>unless</code>示例：需求创建<code>/tmp/unless.txt</code>文件，存在则不创建，不存在则创建<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/unless.sls </span><br><span class=\"line\">test-unless:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">    - unless: test -f /tmp/unless.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"touch /tmp/unless.txt\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:10:51.522319</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 31.822 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6538</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  31.822 ms</span><br><span class=\"line\">#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: unless condition is true</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:11:40.819789</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 10.477 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  10.477 ms</span><br><span class=\"line\">#第二次执行，可以看到该文件已经存在，并没有再次创建</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>通过上面的小案例可以看出，当<code>unless</code>返回为真则不执行，当<code>unless</code>返回为假才执行。</p>\n</blockquote>\n<h2 id=\"onlyif\"><a href=\"#onlyif\" class=\"headerlink\" title=\"onlyif\"></a>onlyif</h2><blockquote>\n<p><code>onlyif</code>正好和<code>unless</code>相反，当<code>onlyif</code>返回为真执行，当<code>onlyif</code>返回为假不执行</p>\n</blockquote>\n<p><code>onlyif</code>示例：需求，当<code>/tmp/onlyif.txt</code>文件存在，则创建<code>/tmp/onlyif</code>目录，不存在，则不创建<code>/tmp/onlyif</code>目录<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls </span><br><span class=\"line\">test-onlyif:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">    - onlyif: test -f /tmp/onlyif.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: onlyif condition is false</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:34:56.460583</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 9.612 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:   9.612 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> cmd.run \"touch /tmp/onlyif.txt\"</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"mkdir /tmp/onlyif\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:38:07.712492</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 14.646 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6871</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  14.646 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Redis主从架构案例\"><a href=\"#Redis主从架构案例\" class=\"headerlink\" title=\"Redis主从架构案例\"></a>Redis主从架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br><img src=\"/2019/05/17/saltstack状态判断unless与onlyif/01.png\" alt=\"redis主从环境\"></p>\n<p>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/prod/redis/files/</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>state sls</code>状态文件<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#初始化redis（安装和基本配置）</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/init.sls</span> </span><br><span class=\"line\"><span class=\"attr\">redis-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://redis/files/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      BIND:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">      DAEMONIZA:</span> <span class=\"string\">'yes'</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">redis-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">redis-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#master直接引入 init</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/master.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#slave引入init 并配置主从信息</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/slave.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置主从</span></span><br><span class=\"line\"><span class=\"attr\">slave-config:</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">slaveof</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">info</span> <span class=\"string\">|grep</span> <span class=\"attr\">role:slave</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - service:</span> <span class=\"string\">redis-service</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">说明：</span></span><br><span class=\"line\"><span class=\"string\">unless：返回为真则不执行，反之为假则执行</span></span><br></pre></td></tr></table></figure></p>\n<p>4）配置文件准备<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">grep</span> <span class=\"string\">\"^[a-Z]\"</span> /etc/redis.<span class=\"keyword\">conf</span>  &gt;&gt;/srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span> </span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">bind &#123;&#123; BIND &#125;&#125;</span><br><span class=\"line\">protected-<span class=\"keyword\">mode</span> yes</span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">port &#123;&#123; PORT &#125;&#125;</span><br><span class=\"line\">tcp-backlog <span class=\"number\">511</span></span><br><span class=\"line\">timeout <span class=\"number\">0</span></span><br><span class=\"line\">tcp-keepalive <span class=\"number\">300</span></span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">daemonize &#123;&#123; DAEMONIZA &#125;&#125;</span><br><span class=\"line\">supervised <span class=\"keyword\">no</span></span><br><span class=\"line\">pidfile /var/run/redis_6379.pid</span><br><span class=\"line\">loglevel notice</span><br><span class=\"line\">logfile /var/<span class=\"built_in\">log</span>/redis/redis.<span class=\"built_in\">log</span></span><br><span class=\"line\">databases <span class=\"number\">16</span></span><br><span class=\"line\">save <span class=\"number\">900</span> <span class=\"number\">1</span></span><br><span class=\"line\">save <span class=\"number\">300</span> <span class=\"number\">10</span></span><br><span class=\"line\">save <span class=\"number\">60</span> <span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"keyword\">stop</span>-writes-<span class=\"keyword\">on</span>-bgsave-error yes</span><br><span class=\"line\">rdbcompression yes</span><br><span class=\"line\">rdbchecksum yes</span><br><span class=\"line\">dbfilename dump.rdb</span><br><span class=\"line\">dir /var/lib/redis</span><br><span class=\"line\">slave-serve-stale-data yes</span><br><span class=\"line\">slave-<span class=\"keyword\">read</span>-<span class=\"keyword\">only</span> yes</span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span> <span class=\"keyword\">no</span></span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span>-delay <span class=\"number\">5</span></span><br><span class=\"line\">repl-disable-tcp-nodelay <span class=\"keyword\">no</span></span><br><span class=\"line\">slave-priority <span class=\"number\">100</span></span><br><span class=\"line\">appendonly <span class=\"keyword\">no</span></span><br><span class=\"line\">appendfilename <span class=\"string\">\"appendonly.aof\"</span></span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"><span class=\"keyword\">no</span>-appendfsync-<span class=\"keyword\">on</span>-rewrite <span class=\"keyword\">no</span></span><br><span class=\"line\">auto-aof-rewrite-percentage <span class=\"number\">100</span></span><br><span class=\"line\">auto-aof-rewrite-<span class=\"built_in\">min</span>-size <span class=\"number\">64</span>mb</span><br><span class=\"line\">aof-load-truncated yes</span><br><span class=\"line\"><span class=\"keyword\">lua</span>-time-limit <span class=\"number\">5000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">log</span>-slower-than <span class=\"number\">10000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">max</span>-<span class=\"built_in\">len</span> <span class=\"number\">128</span></span><br><span class=\"line\">latency-monitor-threshold <span class=\"number\">0</span></span><br><span class=\"line\">notify-keyspace-events <span class=\"string\">\"\"</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">512</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-<span class=\"built_in\">max</span>-ziplist-size -<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-compress-depth <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">set</span>-<span class=\"built_in\">max</span>-intset-entries <span class=\"number\">512</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">128</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\">hll-sparse-<span class=\"built_in\">max</span>-bytes <span class=\"number\">3000</span></span><br><span class=\"line\">activerehashing yes</span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit <span class=\"keyword\">normal</span> <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">0</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit slave <span class=\"number\">256</span>mb <span class=\"number\">64</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit pubsub <span class=\"number\">32</span>mb <span class=\"number\">8</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">hz <span class=\"number\">10</span></span><br><span class=\"line\">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>top file</code>文件编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  'salt-minion02':</span><br><span class=\"line\">    - redis.<span class=\"literal\">master</span></span><br><span class=\"line\">  'salt-minion03':</span><br><span class=\"line\">    - redis.<span class=\"literal\">slave</span></span><br></pre></td></tr></table></figure></p>\n<p>6）整体<code>state</code>文件查看<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /srv/salt/prod/redis/</span><br><span class=\"line\">/srv/salt/prod/redis/</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── redis.conf</span><br><span class=\"line\">├── init.sls</span><br><span class=\"line\">├── <span class=\"literal\">master</span>.sls</span><br><span class=\"line\">└── <span class=\"literal\">slave</span>.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">4</span> files</span><br></pre></td></tr></table></figure></p>\n<p>7）<code>top file</code>高级状态执行<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#先测试下看下状态文件是否编写正确，再正式执行</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate <span class=\"attr\">test=</span><span class=\"literal\">True</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate</span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack远程执行","date":"2019-05-14T09:47:05.000Z","copyright":true,"_content":"安装完`Saltstack`后可以立即执行`shell`命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：http://docs.saltstack.cn/topics/tutorials/modules.html\n```\n[root@salt-master ~]# salt '*' cmd.run \"uptime\"\nsalt-minion01:\n     15:23:08 up 1 day, 58 min,  2 users,  load average: 0.00, 0.03, 0.08\nsalt-minion02:\n     15:23:08 up 21:38,  2 users,  load average: 0.00, 0.04, 0.10\nsalt-minion03:\n     15:23:08 up 21:36,  2 users,  load average: 0.00, 0.04, 0.10\n```\n\n## Salt命令的结构语法\n```\nsalt '<target>' <function> [arguments]\n```\n![](saltstack远程执行/01.png)\n## 目标主机Target\n![](saltstack远程执行/02.png)\n1、通配符匹配\n```\n[root@salt-master ~]# salt '*' test.ping\n[root@salt-master ~]# salt 'salt-minion01' test.ping\n[root@salt-master ~]# salt '*01' test.ping\n[root@salt-master ~]# salt 'salt-minion0[1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0[!1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0?' test.ping\n```\n2、列表匹配\n```\n[root@salt-master ~]# salt -L 'salt-minion01,salt-minion02' test.ping\n```\n3、正则匹配\n```\n[root@salt-master ~]# salt -E '^salt' test.ping\n[root@salt-master ~]# salt -E '^salt.*2$' test.ping\n```\n4、IP匹配\n```\n[root@salt-master ~]# salt -S '192.168.1.32' test.ping\n[root@salt-master ~]# salt -S '192.168.1.0/24' test.ping\n```\n5、复合匹配\n```\n[root@salt-master ~]# salt -C 'G@os:CentOS and S@192.168.1.32' test.ping\n```\n6、分组匹配\n```\n[root@salt-master ~]# vim /etc/salt/master\nnodegroups:\n  webserver: 'salt-minion01,salt-minion02'\n  dbserver: 'salt-minion03\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# salt -N 'webserver' test.ping\n[root@salt-master ~]# salt -N 'dbserver' test.ping\n```\n7、Grains匹配\n```\n[root@salt-master ~]# salt -G 'os:CentOS' test.ping\n[root@salt-master ~]# salt -G 'localhost:salt-minion02' test.ping\n```\n> 说明：上面这些匹配方式在`top.sls`文件中同样适用。\n## 模块Module\n![](saltstack远程执行/03.png)\n> `test`模块多用于测试\n`user`模块用于用户管理\n`cmd`模块可以执行任意`shell`命令\n`pkg`模块用于软件包管理\n`file`模块多用于配置\n`service`模块用于服务管理\n\n[所有模块列表](http://docs.saltstack.cn/ref/modules/all/index.html)\n\n**test模块**\n```\n模块名：test\n功能：用于测试\n[root@salt-master ~]# salt '*' test.ping\n```\n**user模块**\n```\n参考：http://docs.saltstack.cn/ref/modules/all/salt.modules.useradd.html#module-salt.modules.useradd\n# salt '*' user.add name <uid> <gid> <groups> <home> <shell>\n[root@salt-master ~]# salt '*' user.add testuser\n```\n**cmd模块**\n```\n模块名：cmd\n功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）\n#查看所有minion内存和磁盘使用情况\n[root@salt-master ~]# salt '*' cmd.run \"free -m\"\n[root@salt-master ~]# salt '*' cmd.run \"df -h\"\n```\n**pkg模块**\n```\n模块名：pkg\n功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）\n\n#安装\n[root@salt-master ~]# salt '*' pkg.install \"vsftpd\" \n#卸载\n[root@salt-master ~]# salt '*' pkg.remove \"vsftpd\"\n#安装最新版本\n[root@salt-master ~]# salt '*' pkg.latest_version \"vsftpd\"\n#更新软件包\n[root@salt-master ~]# salt '*' pkg.upgrade \"vsftpd\"\n\n#查看帮助手册\n[root@salt-master ~]# salt '*' pkg\n```\n**file模块**\n```\n模块名：file\n功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验\n\n#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法\n[root@salt-master ~]# salt '*' file.get_sum /etc/passwd md5\n\n#修改所有minion主机/etc/passwd文件的属组、用户权限、等价于chown root:root /etc/passwd\n[root@salt-master ~]# salt '*' file.chown /etc/passwd root root\n\n#获取所有minion主机/etc/passwd的stats信息\n[root@salt-master ~]# salt '*' file.stats /etc/passwd\n\n#获取所有minion主机/etc/passwd的权限mode,如755,644\n[root@salt-master ~]# salt '*' file.get_mode /etc/passwd\n\n#修改所有minion主机/etc/passwd的权限mode为0644\n[root@salt-master ~]# salt '*' file.set_mode /etc/passwd 0644\n\n#在所有minion主机创建/opt/test目录\n[root@salt-master ~]# salt '*' file.mkdir /opt/test\n\n#在所有minion主机穿件/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.touch /tmp/test.conf\n\n#将所有minion主机/tmp/test.conf文件追加内容'maxclient 100'\n[root@salt-master ~]# salt '*' file.append /tmp/test.conf 'maxclient 100'\n\n#删除所有minion主机的/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.remove /tmp/test.conf\n```\n**service模块**\n```\n模块名：service\n功能：被控主机程序包服务管理\n\n#开启（enable）禁用（disable）\nsalt '*' service.enable <service name>\nsalt '*' service.disabled <service name>\n\n#reload、restart、start、stop、status操作\nsalt '*' service.reload <service name>\nsalt '*' service.restart <service name>\nsalt '*' service.start <service name>\nsalt '*' service.stop <service name>\nsalt '*' service.status <service name>\n```\n\n\n\n\n\n","source":"_posts/saltstack远程执行.md","raw":"---\ntitle: saltstack远程执行\ndate: 2019-05-14 17:47:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n安装完`Saltstack`后可以立即执行`shell`命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：http://docs.saltstack.cn/topics/tutorials/modules.html\n```\n[root@salt-master ~]# salt '*' cmd.run \"uptime\"\nsalt-minion01:\n     15:23:08 up 1 day, 58 min,  2 users,  load average: 0.00, 0.03, 0.08\nsalt-minion02:\n     15:23:08 up 21:38,  2 users,  load average: 0.00, 0.04, 0.10\nsalt-minion03:\n     15:23:08 up 21:36,  2 users,  load average: 0.00, 0.04, 0.10\n```\n\n## Salt命令的结构语法\n```\nsalt '<target>' <function> [arguments]\n```\n![](saltstack远程执行/01.png)\n## 目标主机Target\n![](saltstack远程执行/02.png)\n1、通配符匹配\n```\n[root@salt-master ~]# salt '*' test.ping\n[root@salt-master ~]# salt 'salt-minion01' test.ping\n[root@salt-master ~]# salt '*01' test.ping\n[root@salt-master ~]# salt 'salt-minion0[1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0[!1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0?' test.ping\n```\n2、列表匹配\n```\n[root@salt-master ~]# salt -L 'salt-minion01,salt-minion02' test.ping\n```\n3、正则匹配\n```\n[root@salt-master ~]# salt -E '^salt' test.ping\n[root@salt-master ~]# salt -E '^salt.*2$' test.ping\n```\n4、IP匹配\n```\n[root@salt-master ~]# salt -S '192.168.1.32' test.ping\n[root@salt-master ~]# salt -S '192.168.1.0/24' test.ping\n```\n5、复合匹配\n```\n[root@salt-master ~]# salt -C 'G@os:CentOS and S@192.168.1.32' test.ping\n```\n6、分组匹配\n```\n[root@salt-master ~]# vim /etc/salt/master\nnodegroups:\n  webserver: 'salt-minion01,salt-minion02'\n  dbserver: 'salt-minion03\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# salt -N 'webserver' test.ping\n[root@salt-master ~]# salt -N 'dbserver' test.ping\n```\n7、Grains匹配\n```\n[root@salt-master ~]# salt -G 'os:CentOS' test.ping\n[root@salt-master ~]# salt -G 'localhost:salt-minion02' test.ping\n```\n> 说明：上面这些匹配方式在`top.sls`文件中同样适用。\n## 模块Module\n![](saltstack远程执行/03.png)\n> `test`模块多用于测试\n`user`模块用于用户管理\n`cmd`模块可以执行任意`shell`命令\n`pkg`模块用于软件包管理\n`file`模块多用于配置\n`service`模块用于服务管理\n\n[所有模块列表](http://docs.saltstack.cn/ref/modules/all/index.html)\n\n**test模块**\n```\n模块名：test\n功能：用于测试\n[root@salt-master ~]# salt '*' test.ping\n```\n**user模块**\n```\n参考：http://docs.saltstack.cn/ref/modules/all/salt.modules.useradd.html#module-salt.modules.useradd\n# salt '*' user.add name <uid> <gid> <groups> <home> <shell>\n[root@salt-master ~]# salt '*' user.add testuser\n```\n**cmd模块**\n```\n模块名：cmd\n功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）\n#查看所有minion内存和磁盘使用情况\n[root@salt-master ~]# salt '*' cmd.run \"free -m\"\n[root@salt-master ~]# salt '*' cmd.run \"df -h\"\n```\n**pkg模块**\n```\n模块名：pkg\n功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）\n\n#安装\n[root@salt-master ~]# salt '*' pkg.install \"vsftpd\" \n#卸载\n[root@salt-master ~]# salt '*' pkg.remove \"vsftpd\"\n#安装最新版本\n[root@salt-master ~]# salt '*' pkg.latest_version \"vsftpd\"\n#更新软件包\n[root@salt-master ~]# salt '*' pkg.upgrade \"vsftpd\"\n\n#查看帮助手册\n[root@salt-master ~]# salt '*' pkg\n```\n**file模块**\n```\n模块名：file\n功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验\n\n#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法\n[root@salt-master ~]# salt '*' file.get_sum /etc/passwd md5\n\n#修改所有minion主机/etc/passwd文件的属组、用户权限、等价于chown root:root /etc/passwd\n[root@salt-master ~]# salt '*' file.chown /etc/passwd root root\n\n#获取所有minion主机/etc/passwd的stats信息\n[root@salt-master ~]# salt '*' file.stats /etc/passwd\n\n#获取所有minion主机/etc/passwd的权限mode,如755,644\n[root@salt-master ~]# salt '*' file.get_mode /etc/passwd\n\n#修改所有minion主机/etc/passwd的权限mode为0644\n[root@salt-master ~]# salt '*' file.set_mode /etc/passwd 0644\n\n#在所有minion主机创建/opt/test目录\n[root@salt-master ~]# salt '*' file.mkdir /opt/test\n\n#在所有minion主机穿件/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.touch /tmp/test.conf\n\n#将所有minion主机/tmp/test.conf文件追加内容'maxclient 100'\n[root@salt-master ~]# salt '*' file.append /tmp/test.conf 'maxclient 100'\n\n#删除所有minion主机的/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.remove /tmp/test.conf\n```\n**service模块**\n```\n模块名：service\n功能：被控主机程序包服务管理\n\n#开启（enable）禁用（disable）\nsalt '*' service.enable <service name>\nsalt '*' service.disabled <service name>\n\n#reload、restart、start、stop、status操作\nsalt '*' service.reload <service name>\nsalt '*' service.restart <service name>\nsalt '*' service.start <service name>\nsalt '*' service.stop <service name>\nsalt '*' service.status <service name>\n```\n\n\n\n\n\n","slug":"saltstack远程执行","published":1,"updated":"2019-05-28T13:50:02.567Z","_id":"cjxwlqrkz000tlctcfmrxjbr9","comments":1,"layout":"post","photos":[],"link":"","content":"<p>安装完<code>Saltstack</code>后可以立即执行<code>shell</code>命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：<a href=\"http://docs.saltstack.cn/topics/tutorials/modules.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/tutorials/modules.html</a><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># salt '*' cmd.run \"uptime\"</span></span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">     15:23:08 up 1 day, 58 min,  2 users,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.03</span>, <span class=\"number\">0.08</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion02:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">38</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion03:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">36</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Salt命令的结构语法\"><a href=\"#Salt命令的结构语法\" class=\"headerlink\" title=\"Salt命令的结构语法\"></a>Salt命令的结构语法</h2><figure class=\"highlight matlab\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">salt <span class=\"string\">'&lt;target&gt;'</span> &lt;<span class=\"function\"><span class=\"keyword\">function</span>&gt; <span class=\"params\">[arguments]</span></span></span><br></pre></td></tr></table></figure>\n<p><img src=\"/2019/05/14/saltstack远程执行/01.png\" alt></p>\n<h2 id=\"目标主机Target\"><a href=\"#目标主机Target\" class=\"headerlink\" title=\"目标主机Target\"></a>目标主机Target</h2><p><img src=\"/2019/05/14/saltstack远程执行/02.png\" alt><br>1、通配符匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[!1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0?'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -L <span class=\"string\">'salt-minion01,salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>3、正则匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt.*2$'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>4、IP匹配<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span>' test.ping</span><br><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>5、复合匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -C 'G@os:CentOS <span class=\"keyword\">and</span> S@<span class=\"number\">192.168</span>.<span class=\"number\">1.32</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>6、分组匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">nodegroups:</span><br><span class=\"line\">  webserver: 'salt-minion01,salt-minion02'</span><br><span class=\"line\">  dbserver: 'salt-minion03</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'webserver' test.ping</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'dbserver' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>7、Grains匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'os:CentOS'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'localhost:salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>说明：上面这些匹配方式在<code>top.sls</code>文件中同样适用。</p>\n</blockquote>\n<h2 id=\"模块Module\"><a href=\"#模块Module\" class=\"headerlink\" title=\"模块Module\"></a>模块Module</h2><p><img src=\"/2019/05/14/saltstack远程执行/03.png\" alt></p>\n<blockquote>\n<p><code>test</code>模块多用于测试<br><code>user</code>模块用于用户管理<br><code>cmd</code>模块可以执行任意<code>shell</code>命令<br><code>pkg</code>模块用于软件包管理<br><code>file</code>模块多用于配置<br><code>service</code>模块用于服务管理</p>\n</blockquote>\n<p><a href=\"http://docs.saltstack.cn/ref/modules/all/index.html\" target=\"_blank\" rel=\"noopener\">所有模块列表</a></p>\n<p><strong>test模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：test</span><br><span class=\"line\">功能：用于测试</span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>user模块</strong><br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">参考：http://docs.saltstack.<span class=\"keyword\">cn</span>/ref/modules/<span class=\"keyword\">all</span>/salt.modules.useradd.html#module-salt.modules.useradd</span><br><span class=\"line\"># salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> name <span class=\"symbol\">&lt;uid&gt;</span> <span class=\"symbol\">&lt;gid&gt;</span> <span class=\"symbol\">&lt;groups&gt;</span> <span class=\"symbol\">&lt;home&gt;</span> <span class=\"symbol\">&lt;shell&gt;</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> testuser</span><br></pre></td></tr></table></figure></p>\n<p><strong>cmd模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：cmd</span><br><span class=\"line\">功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）</span><br><span class=\"line\"><span class=\"meta\">#查看所有minion内存和磁盘使用情况</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"free -m\"</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"df -h\"</span></span></span><br></pre></td></tr></table></figure></p>\n<p><strong>pkg模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：pkg</span><br><span class=\"line\">功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.install <span class=\"string\">\"vsftpd\"</span> </span></span><br><span class=\"line\"><span class=\"meta\">#卸载</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.remove <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#安装最新版本</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.latest_version <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#更新软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.upgrade <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#查看帮助手册</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>file模块</strong><br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：<span class=\"keyword\">file</span></span><br><span class=\"line\">功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验</span><br><span class=\"line\"></span><br><span class=\"line\">#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_sum <span class=\"regexp\">/etc/</span>passwd md5</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd文件的属组、用户权限、等价于chown root:root <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.chown <span class=\"regexp\">/etc/</span>passwd root root</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的stats信息</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.stats <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode,如<span class=\"number\">755</span>,<span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_mode <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode为<span class=\"number\">0644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.set_mode <span class=\"regexp\">/etc/</span>passwd <span class=\"number\">0644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机创建<span class=\"regexp\">/opt/</span>test目录</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.mkdir <span class=\"regexp\">/opt/</span>test</span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机穿件<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.touch <span class=\"regexp\">/tmp/</span>test.conf</span><br><span class=\"line\"></span><br><span class=\"line\">#将所有minion主机<span class=\"regexp\">/tmp/</span>test.conf文件追加内容<span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.<span class=\"keyword\">append</span> <span class=\"regexp\">/tmp/</span>test.conf <span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\"></span><br><span class=\"line\">#删除所有minion主机的<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.remove <span class=\"regexp\">/tmp/</span>test.conf</span><br></pre></td></tr></table></figure></p>\n<p><strong>service模块</strong><br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：service</span><br><span class=\"line\">功能：被控主机程序包服务管理</span><br><span class=\"line\"></span><br><span class=\"line\">#开启（enable）禁用（disable）</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.enable</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.disabled</span> &lt;service name&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">#reload、restart、start、stop、status操作</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.reload</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.restart</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.start</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.stop</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.status</span> &lt;service name&gt;</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<p>安装完<code>Saltstack</code>后可以立即执行<code>shell</code>命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：<a href=\"http://docs.saltstack.cn/topics/tutorials/modules.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/tutorials/modules.html</a><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># salt '*' cmd.run \"uptime\"</span></span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">     15:23:08 up 1 day, 58 min,  2 users,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.03</span>, <span class=\"number\">0.08</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion02:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">38</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion03:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">36</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Salt命令的结构语法\"><a href=\"#Salt命令的结构语法\" class=\"headerlink\" title=\"Salt命令的结构语法\"></a>Salt命令的结构语法</h2><figure class=\"highlight matlab\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">salt <span class=\"string\">'&lt;target&gt;'</span> &lt;<span class=\"function\"><span class=\"keyword\">function</span>&gt; <span class=\"params\">[arguments]</span></span></span><br></pre></td></tr></table></figure>\n<p><img src=\"/2019/05/14/saltstack远程执行/01.png\" alt></p>\n<h2 id=\"目标主机Target\"><a href=\"#目标主机Target\" class=\"headerlink\" title=\"目标主机Target\"></a>目标主机Target</h2><p><img src=\"/2019/05/14/saltstack远程执行/02.png\" alt><br>1、通配符匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[!1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0?'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -L <span class=\"string\">'salt-minion01,salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>3、正则匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt.*2$'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>4、IP匹配<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span>' test.ping</span><br><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>5、复合匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -C 'G@os:CentOS <span class=\"keyword\">and</span> S@<span class=\"number\">192.168</span>.<span class=\"number\">1.32</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>6、分组匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">nodegroups:</span><br><span class=\"line\">  webserver: 'salt-minion01,salt-minion02'</span><br><span class=\"line\">  dbserver: 'salt-minion03</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'webserver' test.ping</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'dbserver' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>7、Grains匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'os:CentOS'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'localhost:salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>说明：上面这些匹配方式在<code>top.sls</code>文件中同样适用。</p>\n</blockquote>\n<h2 id=\"模块Module\"><a href=\"#模块Module\" class=\"headerlink\" title=\"模块Module\"></a>模块Module</h2><p><img src=\"/2019/05/14/saltstack远程执行/03.png\" alt></p>\n<blockquote>\n<p><code>test</code>模块多用于测试<br><code>user</code>模块用于用户管理<br><code>cmd</code>模块可以执行任意<code>shell</code>命令<br><code>pkg</code>模块用于软件包管理<br><code>file</code>模块多用于配置<br><code>service</code>模块用于服务管理</p>\n</blockquote>\n<p><a href=\"http://docs.saltstack.cn/ref/modules/all/index.html\" target=\"_blank\" rel=\"noopener\">所有模块列表</a></p>\n<p><strong>test模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：test</span><br><span class=\"line\">功能：用于测试</span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>user模块</strong><br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">参考：http://docs.saltstack.<span class=\"keyword\">cn</span>/ref/modules/<span class=\"keyword\">all</span>/salt.modules.useradd.html#module-salt.modules.useradd</span><br><span class=\"line\"># salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> name <span class=\"symbol\">&lt;uid&gt;</span> <span class=\"symbol\">&lt;gid&gt;</span> <span class=\"symbol\">&lt;groups&gt;</span> <span class=\"symbol\">&lt;home&gt;</span> <span class=\"symbol\">&lt;shell&gt;</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> testuser</span><br></pre></td></tr></table></figure></p>\n<p><strong>cmd模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：cmd</span><br><span class=\"line\">功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）</span><br><span class=\"line\"><span class=\"meta\">#查看所有minion内存和磁盘使用情况</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"free -m\"</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"df -h\"</span></span></span><br></pre></td></tr></table></figure></p>\n<p><strong>pkg模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：pkg</span><br><span class=\"line\">功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.install <span class=\"string\">\"vsftpd\"</span> </span></span><br><span class=\"line\"><span class=\"meta\">#卸载</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.remove <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#安装最新版本</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.latest_version <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#更新软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.upgrade <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#查看帮助手册</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>file模块</strong><br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：<span class=\"keyword\">file</span></span><br><span class=\"line\">功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验</span><br><span class=\"line\"></span><br><span class=\"line\">#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_sum <span class=\"regexp\">/etc/</span>passwd md5</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd文件的属组、用户权限、等价于chown root:root <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.chown <span class=\"regexp\">/etc/</span>passwd root root</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的stats信息</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.stats <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode,如<span class=\"number\">755</span>,<span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_mode <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode为<span class=\"number\">0644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.set_mode <span class=\"regexp\">/etc/</span>passwd <span class=\"number\">0644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机创建<span class=\"regexp\">/opt/</span>test目录</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.mkdir <span class=\"regexp\">/opt/</span>test</span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机穿件<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.touch <span class=\"regexp\">/tmp/</span>test.conf</span><br><span class=\"line\"></span><br><span class=\"line\">#将所有minion主机<span class=\"regexp\">/tmp/</span>test.conf文件追加内容<span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.<span class=\"keyword\">append</span> <span class=\"regexp\">/tmp/</span>test.conf <span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\"></span><br><span class=\"line\">#删除所有minion主机的<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.remove <span class=\"regexp\">/tmp/</span>test.conf</span><br></pre></td></tr></table></figure></p>\n<p><strong>service模块</strong><br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：service</span><br><span class=\"line\">功能：被控主机程序包服务管理</span><br><span class=\"line\"></span><br><span class=\"line\">#开启（enable）禁用（disable）</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.enable</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.disabled</span> &lt;service name&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">#reload、restart、start、stop、status操作</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.reload</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.restart</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.start</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.stop</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.status</span> &lt;service name&gt;</span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack数据系统","date":"2019-05-17T09:31:05.000Z","copyright":true,"_content":"## 数据系统Grains\n>1、`Grains`是`SaltStack`收集的有关底层管理系统的静态信息。包括操作系统版本、域名、IP地址、内存、内核、CPU、操作系统类型以及许多其他系统属性。`Minion` 收集的信息，可以作为`Master`端匹配目标。\n>2、如果需要自定义`grains`，需要添加到`Salt Minion`的`/etc/salt/grains`文件中（配置文件中定义的默认路径），也可以直接写在配置文件`/etc/salt/minion`中\n\n[Grains官方文档](https://docs.saltstack.com/en/latest/topics/grains/)\n1）资产管理，信息查询\n```\n#列出所有可用的grains状态模块\n[root@salt-master ~]# salt '*' grains.ls\n#打印所有状态信息\n[root@salt-master ~]# salt '*' grains.items\n#列出每台minion的本地IP地址\n[root@salt-master ~]# salt '*' grains.item fqdn_ip4\n#列出每台minion的操作系统\n[root@salt-master ~]# salt '*' grains.item os\n```\n2）用于匹配\n```\n[root@salt-master ~]# salt -G 'os:CentOS' test.ping\n[root@salt-master ~]# salt -G 'localhost:salt-minion01' test.ping\n```\n3）`minion`自定义`grains`\n```\n#1.修改配置文件，自定义grains\n[root@salt-minion01 ~]# vim /etc/salt/minion\ngrains:\n  roles:\n    - webserver\n    - memcache\n  ipaddr:\n    - 192.168.1.32\n\n#2.重启minion\n[root@salt-minion01 ~]# systemctl restart salt-minion\n\n#3.master上测试\n[root@salt-master ~]# salt -G 'ipaddr:192.168.1.32' test.ping \nsalt-minion01:\n    True\n```\n4）`Grains`优先级问题\n```\n1、Grains默认核心信息\n2、自定义写在/etc/salt/grains文件中的\n3、自定义写在/etc/salt/minion文件中的\n```\n## 数据系统Pillar\n>`Pillar`是动态的，`Pillar`存储在`master`上，提供给`minion`。\n>`Pillar`主要记录一些加密信息，可以确保这些敏感数据不被其他`minion`看到。比如：软件版本号、用户名密码等。存储格式都是`YAML`格式\n\n1）在`Master`端定义`Pillar`\n```\n[root@salt-master ~]# vim /etc/salt/master\npillar_roots:\n  base:\n    - /srv/pillar\n\n[root@salt-master ~]# mkdir /srv/pillar\n[root@salt-master ~]# cat /srv/pillar/zabbix.sls \nZabbix_Server: 192.168.1.11\nZabbix_Name: zabbix.examp.com\n```\n2）编写`TopFile`指定`Minion`端可以使用\n```\n[root@salt-master ~]# cat /srv/pillar/top.sls \nbase:\n  'salt-minion01':\n    - zabbix\n```\n3）刷新`Pillar`\n```\n[root@salt-master ~]# salt '*' saltutil.refresh_pillar\n```\n4）获取对应`pillar`值\n```\n[root@salt-master ~]# salt '*' pillar.items\nsalt-minion01:\n    ----------\n    Zabbix_Name:\n        zabbix.examp.com\n    Zabbix_Server:\n        192.168.1.11\nsalt-minion03:\n    ----------\nsalt-minion02:\n    ----------\n\n#获取指定的key\n[root@salt-master ~]# salt 'salt-minion01' pillar.item Zabbix_Server\nsalt-minion01:\n    ----------\n    Zabbix_Server:\n        192.168.1.11\n```\n>说明：如果`Master`更新了新的数值，需要刷新`Pillar`到`Minion`才可以获取\n\n>`Pirrar`与`Grains`对比\n```\n类型     数据采集方式   应用场景                   定义位置\nGrains   静态         minion启动时收集  数据查询  目标选择  配置管理   minion\nPillar   动态         master进行自定义  目标选择  配置管理  敏感数据   master\n```","source":"_posts/saltstack数据系统.md","raw":"---\ntitle: saltstack数据系统\ndate: 2019-05-17 17:31:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## 数据系统Grains\n>1、`Grains`是`SaltStack`收集的有关底层管理系统的静态信息。包括操作系统版本、域名、IP地址、内存、内核、CPU、操作系统类型以及许多其他系统属性。`Minion` 收集的信息，可以作为`Master`端匹配目标。\n>2、如果需要自定义`grains`，需要添加到`Salt Minion`的`/etc/salt/grains`文件中（配置文件中定义的默认路径），也可以直接写在配置文件`/etc/salt/minion`中\n\n[Grains官方文档](https://docs.saltstack.com/en/latest/topics/grains/)\n1）资产管理，信息查询\n```\n#列出所有可用的grains状态模块\n[root@salt-master ~]# salt '*' grains.ls\n#打印所有状态信息\n[root@salt-master ~]# salt '*' grains.items\n#列出每台minion的本地IP地址\n[root@salt-master ~]# salt '*' grains.item fqdn_ip4\n#列出每台minion的操作系统\n[root@salt-master ~]# salt '*' grains.item os\n```\n2）用于匹配\n```\n[root@salt-master ~]# salt -G 'os:CentOS' test.ping\n[root@salt-master ~]# salt -G 'localhost:salt-minion01' test.ping\n```\n3）`minion`自定义`grains`\n```\n#1.修改配置文件，自定义grains\n[root@salt-minion01 ~]# vim /etc/salt/minion\ngrains:\n  roles:\n    - webserver\n    - memcache\n  ipaddr:\n    - 192.168.1.32\n\n#2.重启minion\n[root@salt-minion01 ~]# systemctl restart salt-minion\n\n#3.master上测试\n[root@salt-master ~]# salt -G 'ipaddr:192.168.1.32' test.ping \nsalt-minion01:\n    True\n```\n4）`Grains`优先级问题\n```\n1、Grains默认核心信息\n2、自定义写在/etc/salt/grains文件中的\n3、自定义写在/etc/salt/minion文件中的\n```\n## 数据系统Pillar\n>`Pillar`是动态的，`Pillar`存储在`master`上，提供给`minion`。\n>`Pillar`主要记录一些加密信息，可以确保这些敏感数据不被其他`minion`看到。比如：软件版本号、用户名密码等。存储格式都是`YAML`格式\n\n1）在`Master`端定义`Pillar`\n```\n[root@salt-master ~]# vim /etc/salt/master\npillar_roots:\n  base:\n    - /srv/pillar\n\n[root@salt-master ~]# mkdir /srv/pillar\n[root@salt-master ~]# cat /srv/pillar/zabbix.sls \nZabbix_Server: 192.168.1.11\nZabbix_Name: zabbix.examp.com\n```\n2）编写`TopFile`指定`Minion`端可以使用\n```\n[root@salt-master ~]# cat /srv/pillar/top.sls \nbase:\n  'salt-minion01':\n    - zabbix\n```\n3）刷新`Pillar`\n```\n[root@salt-master ~]# salt '*' saltutil.refresh_pillar\n```\n4）获取对应`pillar`值\n```\n[root@salt-master ~]# salt '*' pillar.items\nsalt-minion01:\n    ----------\n    Zabbix_Name:\n        zabbix.examp.com\n    Zabbix_Server:\n        192.168.1.11\nsalt-minion03:\n    ----------\nsalt-minion02:\n    ----------\n\n#获取指定的key\n[root@salt-master ~]# salt 'salt-minion01' pillar.item Zabbix_Server\nsalt-minion01:\n    ----------\n    Zabbix_Server:\n        192.168.1.11\n```\n>说明：如果`Master`更新了新的数值，需要刷新`Pillar`到`Minion`才可以获取\n\n>`Pirrar`与`Grains`对比\n```\n类型     数据采集方式   应用场景                   定义位置\nGrains   静态         minion启动时收集  数据查询  目标选择  配置管理   minion\nPillar   动态         master进行自定义  目标选择  配置管理  敏感数据   master\n```","slug":"saltstack数据系统","published":1,"updated":"2019-05-17T13:23:21.439Z","_id":"cjxwlqrl2000vlctccstgkfe1","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"数据系统Grains\"><a href=\"#数据系统Grains\" class=\"headerlink\" title=\"数据系统Grains\"></a>数据系统Grains</h2><blockquote>\n<p>1、<code>Grains</code>是<code>SaltStack</code>收集的有关底层管理系统的静态信息。包括操作系统版本、域名、IP地址、内存、内核、CPU、操作系统类型以及许多其他系统属性。<code>Minion</code> 收集的信息，可以作为<code>Master</code>端匹配目标。<br>2、如果需要自定义<code>grains</code>，需要添加到<code>Salt Minion</code>的<code>/etc/salt/grains</code>文件中（配置文件中定义的默认路径），也可以直接写在配置文件<code>/etc/salt/minion</code>中</p>\n</blockquote>\n<p><a href=\"https://docs.saltstack.com/en/latest/topics/grains/\" target=\"_blank\" rel=\"noopener\">Grains官方文档</a><br>1）资产管理，信息查询<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#列出所有可用的grains状态模块</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.ls</span></span><br><span class=\"line\"><span class=\"meta\">#打印所有状态信息</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.items</span></span><br><span class=\"line\"><span class=\"meta\">#列出每台minion的本地IP地址</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.item fqdn_ip4</span></span><br><span class=\"line\"><span class=\"meta\">#列出每台minion的操作系统</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.item os</span></span><br></pre></td></tr></table></figure></p>\n<p>2）用于匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'os:CentOS'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'localhost:salt-minion01'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>minion</code>自定义<code>grains</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#1.修改配置文件，自定义grains</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># vim /etc/salt/minion</span></span><br><span class=\"line\">grains:</span><br><span class=\"line\">  roles:</span><br><span class=\"line\">    - webserver</span><br><span class=\"line\">    - memcache</span><br><span class=\"line\">  ipaddr:</span><br><span class=\"line\">    - <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#2.重启minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl restart salt-minion</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#3.master上测试</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'ipaddr:192.168.1.32'</span> test.ping </span></span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4）<code>Grains</code>优先级问题<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、Grains默认核心信息</span><br><span class=\"line\"><span class=\"number\">2</span>、自定义写在/etc/salt/grains文件中的</span><br><span class=\"line\"><span class=\"number\">3</span>、自定义写在/etc/salt/minion文件中的</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"数据系统Pillar\"><a href=\"#数据系统Pillar\" class=\"headerlink\" title=\"数据系统Pillar\"></a>数据系统Pillar</h2><blockquote>\n<p><code>Pillar</code>是动态的，<code>Pillar</code>存储在<code>master</code>上，提供给<code>minion</code>。<br><code>Pillar</code>主要记录一些加密信息，可以确保这些敏感数据不被其他<code>minion</code>看到。比如：软件版本号、用户名密码等。存储格式都是<code>YAML</code>格式</p>\n</blockquote>\n<p>1）在<code>Master</code>端定义<code>Pillar</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">pillar_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/pillar</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/pillar</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/pillar/zabbix.sls </span><br><span class=\"line\">Zabbix_Server: <span class=\"number\">192.168</span>.<span class=\"number\">1.11</span></span><br><span class=\"line\">Zabbix_Name: zabbix.examp.com</span><br></pre></td></tr></table></figure></p>\n<p>2）编写<code>TopFile</code>指定<code>Minion</code>端可以使用<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">root@salt-master ~</span>]<span class=\"meta\"># cat /srv/pillar/top.sls </span></span><br><span class=\"line\"><span class=\"keyword\">base</span>:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion01'</span>:</span><br><span class=\"line\">    - zabbix</span><br></pre></td></tr></table></figure></p>\n<p>3）刷新<code>Pillar</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> saltutil.refresh_pillar</span></span><br></pre></td></tr></table></figure></p>\n<p>4）获取对应<code>pillar</code>值<br><figure class=\"highlight moonscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> pillar.items</span><br><span class=\"line\">salt-<span class=\"name\">minion01</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">    <span class=\"name\">Zabbix_Name</span>:</span><br><span class=\"line\">        zabbix.examp.com</span><br><span class=\"line\">    <span class=\"name\">Zabbix_Server</span>:</span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.11</span></span><br><span class=\"line\">salt-<span class=\"name\">minion03</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">salt-<span class=\"name\">minion02</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\"></span><br><span class=\"line\">#获取指定的key</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'salt-minion01'</span> pillar.item Zabbix_Server</span><br><span class=\"line\">salt-<span class=\"name\">minion01</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">    <span class=\"name\">Zabbix_Server</span>:</span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.11</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>说明：如果<code>Master</code>更新了新的数值，需要刷新<code>Pillar</code>到<code>Minion</code>才可以获取</p>\n</blockquote>\n<blockquote>\n<p><code>Pirrar</code>与<code>Grains</code>对比<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">类型     数据采集方式   应用场景                   定义位置</span><br><span class=\"line\">Grains   静态         minion启动时收集  数据查询  目标选择  配置管理   minion</span><br><span class=\"line\">Pillar   动态         <span class=\"literal\">master</span>进行自定义  目标选择  配置管理  敏感数据   <span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"数据系统Grains\"><a href=\"#数据系统Grains\" class=\"headerlink\" title=\"数据系统Grains\"></a>数据系统Grains</h2><blockquote>\n<p>1、<code>Grains</code>是<code>SaltStack</code>收集的有关底层管理系统的静态信息。包括操作系统版本、域名、IP地址、内存、内核、CPU、操作系统类型以及许多其他系统属性。<code>Minion</code> 收集的信息，可以作为<code>Master</code>端匹配目标。<br>2、如果需要自定义<code>grains</code>，需要添加到<code>Salt Minion</code>的<code>/etc/salt/grains</code>文件中（配置文件中定义的默认路径），也可以直接写在配置文件<code>/etc/salt/minion</code>中</p>\n</blockquote>\n<p><a href=\"https://docs.saltstack.com/en/latest/topics/grains/\" target=\"_blank\" rel=\"noopener\">Grains官方文档</a><br>1）资产管理，信息查询<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#列出所有可用的grains状态模块</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.ls</span></span><br><span class=\"line\"><span class=\"meta\">#打印所有状态信息</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.items</span></span><br><span class=\"line\"><span class=\"meta\">#列出每台minion的本地IP地址</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.item fqdn_ip4</span></span><br><span class=\"line\"><span class=\"meta\">#列出每台minion的操作系统</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.item os</span></span><br></pre></td></tr></table></figure></p>\n<p>2）用于匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'os:CentOS'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'localhost:salt-minion01'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>minion</code>自定义<code>grains</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#1.修改配置文件，自定义grains</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># vim /etc/salt/minion</span></span><br><span class=\"line\">grains:</span><br><span class=\"line\">  roles:</span><br><span class=\"line\">    - webserver</span><br><span class=\"line\">    - memcache</span><br><span class=\"line\">  ipaddr:</span><br><span class=\"line\">    - <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#2.重启minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl restart salt-minion</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#3.master上测试</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'ipaddr:192.168.1.32'</span> test.ping </span></span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4）<code>Grains</code>优先级问题<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、Grains默认核心信息</span><br><span class=\"line\"><span class=\"number\">2</span>、自定义写在/etc/salt/grains文件中的</span><br><span class=\"line\"><span class=\"number\">3</span>、自定义写在/etc/salt/minion文件中的</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"数据系统Pillar\"><a href=\"#数据系统Pillar\" class=\"headerlink\" title=\"数据系统Pillar\"></a>数据系统Pillar</h2><blockquote>\n<p><code>Pillar</code>是动态的，<code>Pillar</code>存储在<code>master</code>上，提供给<code>minion</code>。<br><code>Pillar</code>主要记录一些加密信息，可以确保这些敏感数据不被其他<code>minion</code>看到。比如：软件版本号、用户名密码等。存储格式都是<code>YAML</code>格式</p>\n</blockquote>\n<p>1）在<code>Master</code>端定义<code>Pillar</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">pillar_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/pillar</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/pillar</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/pillar/zabbix.sls </span><br><span class=\"line\">Zabbix_Server: <span class=\"number\">192.168</span>.<span class=\"number\">1.11</span></span><br><span class=\"line\">Zabbix_Name: zabbix.examp.com</span><br></pre></td></tr></table></figure></p>\n<p>2）编写<code>TopFile</code>指定<code>Minion</code>端可以使用<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">root@salt-master ~</span>]<span class=\"meta\"># cat /srv/pillar/top.sls </span></span><br><span class=\"line\"><span class=\"keyword\">base</span>:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion01'</span>:</span><br><span class=\"line\">    - zabbix</span><br></pre></td></tr></table></figure></p>\n<p>3）刷新<code>Pillar</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> saltutil.refresh_pillar</span></span><br></pre></td></tr></table></figure></p>\n<p>4）获取对应<code>pillar</code>值<br><figure class=\"highlight moonscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> pillar.items</span><br><span class=\"line\">salt-<span class=\"name\">minion01</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">    <span class=\"name\">Zabbix_Name</span>:</span><br><span class=\"line\">        zabbix.examp.com</span><br><span class=\"line\">    <span class=\"name\">Zabbix_Server</span>:</span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.11</span></span><br><span class=\"line\">salt-<span class=\"name\">minion03</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">salt-<span class=\"name\">minion02</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\"></span><br><span class=\"line\">#获取指定的key</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'salt-minion01'</span> pillar.item Zabbix_Server</span><br><span class=\"line\">salt-<span class=\"name\">minion01</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">    <span class=\"name\">Zabbix_Server</span>:</span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.11</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>说明：如果<code>Master</code>更新了新的数值，需要刷新<code>Pillar</code>到<code>Minion</code>才可以获取</p>\n</blockquote>\n<blockquote>\n<p><code>Pirrar</code>与<code>Grains</code>对比<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">类型     数据采集方式   应用场景                   定义位置</span><br><span class=\"line\">Grains   静态         minion启动时收集  数据查询  目标选择  配置管理   minion</span><br><span class=\"line\">Pillar   动态         <span class=\"literal\">master</span>进行自定义  目标选择  配置管理  敏感数据   <span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n"},{"title":"Ansible  Module","date":"2019-05-27T15:25:22.000Z","copyright":true,"_content":"## Ansible Ad-hoc模式常用模块\nansible-doc 常用命令\n```\n# ansible-doc -h\nUsage: ansible-doc [-l|-F|-s] [options] [-t <plugin type> ] [plugin]\n-j  以json格式显示所有模块信息\n-l  列出所有的模块\n-s  查看模块常用参数\n# 直接跟模块名，显示模块所有信息\n\n[root@ansible ~]# ansible-doc -j\n[root@ansible ~]# ansible-doc -l\n[root@ansible ~]# ansible-doc -l |wc -l   #统计所有模块个数，ansible2.8共计2834个模块\n2834\n```\n### 命令相关的模块\n#### command\n>`ansible`默认的模块,执行命令，注意：shell中的`\"<\"`, `\">\"`, `\"|\"`, `\";\"`, `\"&\"`,`\"$\"`等特殊字符不能在`command`模块中使用，如果需要使用，则用`shell`模块\n\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s command\n\n# 在192.168.1.31服务器上面执行ls命令，默认是在当前用户的家目录/root\n[root@ansible ~]# ansible 192.168.1.31 -a 'ls'\n\n# chdir  先切换工作目录，再执行后面的命令，一般情况下在编译时候使用\n[root@ansible ~]# ansible 192.168.1.31 -a 'chdir=/tmp pwd'\n192.168.1.31 | CHANGED | rc=0 >>\n/tmp\n\n# creates  如果creates的文件存在，则执行后面的操作\n[root@ansible ~]# ansible 192.168.1.31 -a 'creates=/tmp ls /etc/passwd'    #tmp目录存在，则不执行后面的ls命令\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp exists\n[root@ansible ~]# ansible 192.168.1.31 -a 'creates=/tmp11 ls /etc/passwd'    # tmp11文件不存在，则执行后面的ls命令\n192.168.1.31 | CHANGED | rc=0 >>\n/etc/passwd\n\n# removes  和creates相反，如果removes的文件存在，才执行后面的操作\n[root@ansible ~]# ansible 192.168.1.31 -a 'removes=/tmp ls /etc/passwd'    #tmp文件存在，则执行了后面的ls命令\n192.168.1.31 | CHANGED | rc=0 >>\n/etc/passwd\n[root@ansible ~]# ansible 192.168.1.31 -a 'removes=/tmp11 ls /etc/passwd'  #tmp11文件不存在，则没有执行后面的ls命令\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp11 does not exist\n```\n#### shell\n>专门用来执行`shell`命令的模块，和`command`模块一样，参数基本一样，都有`chdir,creates,removes`等参数\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s shell\n\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'mkdir /tmp/test'\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'ls /tmp' \n\n#执行下面这条命令，每次执行都会更新文件的时间戳\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'cd /tmp/test && touch 1.txt && ls' \n192.168.1.31 | CHANGED | rc=0 >>\n1.txt\n\n# 由于有时候不想更新文件的创建时间戳，则如果存在就不执行creates\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'creates=/tmp/test/1.txt cd /tmp/test && touch 1.txt && ls'\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp/test/1.txt exists\n```\n#### script\n>用于在被管理机器上面执行`shell`脚本的模块，脚本无需在被管理机器上面存在\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s script\n\n# 编写shell脚本\n[root@ansible ~]# vim ansible_test.sh \n#!/bin/bash\necho `hostname`\n\n# 在所有被管理机器上执行该脚本\n[root@ansible ~]# ansible all -m script -a '/root/ansible_test.sh'\n192.168.1.32 | CHANGED => {\n    \"changed\": true, \n    \"rc\": 0, \n    \"stderr\": \"Shared connection to 192.168.1.32 closed.\\r\\n\", \n    \"stderr_lines\": [\n        \"Shared connection to 192.168.1.32 closed.\"\n    ], \n    \"stdout\": \"linux.node02.com\\r\\n\", \n    \"stdout_lines\": [\n        \"linux.node02.com\"\n    ]\n}\n......\n```\n### 文件相关的模块\n#### file\n>用于对文件的处理，创建，删除，权限控制等\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s file\npath     #要管理的文件路径\nrecurse  #递归\nstate：\n     directory  #创建目录，如果目标不存在则创建目录及其子目录\n     touch      #创建文件，如果文件存在，则修改文件 属性\n     \n     absent     #删除文件或目录\n     mode       #设置文件或目录权限\n     owner      #设置文件或目录属主信息\n     group      #设置文件或目录属组信息\n     link       #创建软连接，需要和src配合使用\n     hard       #创建硬连接，需要和src配合使用\n\n# 创建目录\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test1 state=directory'\n\n# 创建文件\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=touch'\n\n# 建立软链接（src表示源文件，path表示目标文件）\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'src=/tmp/test1 path=/tmp/test3 state=link'\n\n# 删除文件\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=absent'\n\n# 创建文件时同时设置权限等信息\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test4 state=directory mode=775 owner=root group=root'\n```\n#### copy\n> 用于管理端复制文件到远程主机，并可以设置权限，属组，属主等\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s copy\nsrc      #需要copy的文件的源路径\ndest     #需要copy的文件的目标路径\nbackup   #对copy的文件进行备份\ncontent  #直接在远程主机被管理文件中添加内容，会覆盖原文件内容\nmode     #对copy到远端的文件设置权限\nowner    #对copy到远端的文件设置属主\ngroup    #对copy到远端文件设置属组\n\n\n# 复制文件到远程主机并改名\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh'\n\n# 复制文件到远程主机，并备份远程文件,安装时间信息备份文件（当更新文件内容后，重新copy时用到）\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh backup=yes'\n\n# 直接在远程主机a.sh中添加内容\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh content=\"#!/bin/bash\\n echo `uptime`\"'\n\n# 复制文件到远程主机，并设置权限及属主与属组\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/passwd src=/etc/passwd mode=700 owner=root group=root'\n```\n#### fetch\n> 用于从被管理机器上面拉取文件，拉取下来的内容会保留目录结构，一般情况用在收集被管理机器的日志文件等\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s fetch\nsrc      #指定需要从远端机器拉取的文件路径\ndest     #指定从远端机器拉取下来的文件存放路径\n\n# 从被管理机器上拉取cron日志文件，默认会已管理节点地址创建一个目录，并存放在内\n[root@ansible ~]# ansible 192.168.1.31 -m fetch -a 'dest=/tmp src=/var/log/cron'\n\n[root@ansible ~]# tree /tmp/192.168.1.31/\n/tmp/192.168.1.31/\n└── var\n    └── log\n        └── cron\n\n2 directories, 1 file\n```\n### 用户相关的模块\n#### user\n>用于对系统用户的管理，用户的创建、删除、家目录、属组等设置\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s user\nname        #指定用户的名字\nhome        #指定用户的家目录\nuid         #指定用户的uid\ngroup       #指定用户的用户组\ngroups      #指定用户的附加组\npassword    #指定用户的密码\nshell       #指定用户的登录shell\ncreate_home #是否创建用户家目录，默认是yes\nremove      #删除用户时，指定是否删除家目录\nstate：\n      absent    #删除用户\n      \n\n# 创建用户名指定家目录，指定uid及组\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=mysql home=/opt/mysql uid=1002 group=root'\n[root@ansible ~]# ansible 192.168.1.31 -m shell  -a 'id mysql && ls -l /opt'\n192.168.1.31 | CHANGED | rc=0 >>\nuid=1002(mysql) gid=0(root) 组=0(root)\n总用量 0\ndrwx------  3 mysql root 78 5月  27 18:13 mysql\n\n# 创建用户，不创建家目录，并且不能登录\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=apache shell=/bin/nologin uid=1003 create_home=no'\n[root@ansible ~]# ansible 192.168.1.31 -m shell  -a 'id apache && tail -1 /etc/passwd'\n192.168.1.31 | CHANGED | rc=0 >>\nuid=1003(apache) gid=1003(apache) 组=1003(apache)\napache:x:1003:1003::/home/apache:/bin/nologin\n\n# 删除用户\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=apache state=absent'\n\n# 删除用户并删除家目录\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=mysql state=absent remove=yes'\n```\n#### group\n>用于创建组，当创建用户时如果需要指定组，组不存在的话就可以通过`group`先创建组\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s group\nname     #指定组的名字\ngid      #指定组的gid\nstate：\n     absent   #删除组\n     present  #创建组（默认的状态）\n\n# 创建组\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www'\n\n# 创建组并指定gid\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www1 gid=1005'\n\n# 删除组\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www1 state=absent'\n```\n### 软件包相关的模块\n#### yum\n>用于对软件包的管理，下载、安装、卸载、升级等操作\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s yum\nname            #指定要操作的软件包名字\ndownload_dir    #指定下载软件包的存放路径，需要配合download_only一起使用\ndownload_only   #只下载软件包，而不进行安装，和yum --downloadonly一样\nlist:\n    installed   #列出所有已安装的软件包\n    updates     #列出所有可以更新的软件包\n    repos       #列出所有的yum仓库\nstate:   \n    installed, present   #安装软件包(两者任选其一都可以)\n    removed, absent      #卸载软件包\n    latest      #安装最新软件包\n    \n# 列出所有已安装的软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=installed'\n\n# 列出所有可更新的软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=updates'\n\n#列出所有的yum仓库\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=repos'\n\n#只下载软件包并到指定目录下\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd download_only=yes download_dir=/tmp'\n\n#安装软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd state=installed'\n\n#卸载软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd state=removed'\n\n#安装包组，类似yum groupinstall 'Development Tools'\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=\"@Development Tools\" state=installed'\n```\n#### pip\n>用于安装python中的包\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s pip\n\n# 使用pip时，需要保证被管理机器上有python-pip软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=python-pip'\n\n# 安装pip包\n[root@ansible ~]# ansible 192.168.1.31 -m pip -a 'name=flask'\n```\n#### service\n>服务模块，用于对服务进行管理，服务的启动、关闭、开机自启等\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s service\nname       #指定需要管理的服务名\nenabled    #指定是否开机自启动\nstate:     #指定服务状态\n    started    #启动服务\n    stopped    #停止服务\n    restarted  #重启服务\n    reloaded   #重载服务\n\n# 启动服务，并设置开机自启动 \n[root@ansible ~]# ansible 192.168.1.31 -m service -a 'name=crond state=started enabled=yes'\n```\n### 计划任务相关的模块\n#### cron\n>用于指定计划任务，和`crontab -e`一样\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s cron\njob     #指定需要执行的任务\nminute   #分钟\nhour     #小时\nday      #天\nmonth    #月\nweekday  #周\nname     #对计划任务进行描述\nstate:\n    absetn   #删除计划任务\n\n\n# 创建一个计划任务，并描述是干嘛用的\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"name='这是一个测试的计划任务' minute=* hour=* day=* month=* weekday=* job='/bin/bash /root/test.sh'\"\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'crontab -l'\n192.168.1.31 | CHANGED | rc=0 >>\n#Ansible: 这是一个测试的计划任务\n* * * * * /bin/bash /root/test.sh\n\n# 创建一个没有带描述的计划任务\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"job='/bin/sh /root/test.sh'\"\n\n# 删除计划任务\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"name='None' job='/bin/sh /root/test.sh' state=absent\"\n```\n### 系统信息相关的模块\n#### setup\n>用于获取系统信息的一个模块\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s setup\n\n# 查看系统所有信息\n[root@ansible ~]# ansible 192.168.1.31 -m setup\n\n# filter 对系统信息进行过滤\n[root@ansible ~]# ansible 192.168.1.31 -m setup -a 'filter=ansible_all_ipv4_addresses'\n\n# 常用的过滤选项\nansible_all_ipv4_addresses         所有的ipv4地址\nansible_all_ipv6_addresses         所有的ipv6地址\nansible_architecture               系统的架构\nansible_date_time                  系统时间\nansible_default_ipv4               系统的默认ipv4地址\nansible_distribution               系统名称\nansible_distribution_file_variety  系统的家族\nansible_distribution_major_version 系统的版本\nansible_domain                     系统所在的域\nansible_fqdn                       系统的主机名\nansible_hostname                   系统的主机名,简写\nansible_os_family                  系统的家族\nansible_processor_cores            cpu的核数\nansible_processor_count            cpu的颗数\nansible_processor_vcpus            cpu的个数\n```","source":"_posts/Ansible Ad-hoc常用Module.md","raw":"---\ntitle: Ansible  Module \ndate: 2019-05-27 23:25:22\ntags: Ansible\ncategories: Ansible\ncopyright: true\n---\n## Ansible Ad-hoc模式常用模块\nansible-doc 常用命令\n```\n# ansible-doc -h\nUsage: ansible-doc [-l|-F|-s] [options] [-t <plugin type> ] [plugin]\n-j  以json格式显示所有模块信息\n-l  列出所有的模块\n-s  查看模块常用参数\n# 直接跟模块名，显示模块所有信息\n\n[root@ansible ~]# ansible-doc -j\n[root@ansible ~]# ansible-doc -l\n[root@ansible ~]# ansible-doc -l |wc -l   #统计所有模块个数，ansible2.8共计2834个模块\n2834\n```\n### 命令相关的模块\n#### command\n>`ansible`默认的模块,执行命令，注意：shell中的`\"<\"`, `\">\"`, `\"|\"`, `\";\"`, `\"&\"`,`\"$\"`等特殊字符不能在`command`模块中使用，如果需要使用，则用`shell`模块\n\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s command\n\n# 在192.168.1.31服务器上面执行ls命令，默认是在当前用户的家目录/root\n[root@ansible ~]# ansible 192.168.1.31 -a 'ls'\n\n# chdir  先切换工作目录，再执行后面的命令，一般情况下在编译时候使用\n[root@ansible ~]# ansible 192.168.1.31 -a 'chdir=/tmp pwd'\n192.168.1.31 | CHANGED | rc=0 >>\n/tmp\n\n# creates  如果creates的文件存在，则执行后面的操作\n[root@ansible ~]# ansible 192.168.1.31 -a 'creates=/tmp ls /etc/passwd'    #tmp目录存在，则不执行后面的ls命令\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp exists\n[root@ansible ~]# ansible 192.168.1.31 -a 'creates=/tmp11 ls /etc/passwd'    # tmp11文件不存在，则执行后面的ls命令\n192.168.1.31 | CHANGED | rc=0 >>\n/etc/passwd\n\n# removes  和creates相反，如果removes的文件存在，才执行后面的操作\n[root@ansible ~]# ansible 192.168.1.31 -a 'removes=/tmp ls /etc/passwd'    #tmp文件存在，则执行了后面的ls命令\n192.168.1.31 | CHANGED | rc=0 >>\n/etc/passwd\n[root@ansible ~]# ansible 192.168.1.31 -a 'removes=/tmp11 ls /etc/passwd'  #tmp11文件不存在，则没有执行后面的ls命令\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp11 does not exist\n```\n#### shell\n>专门用来执行`shell`命令的模块，和`command`模块一样，参数基本一样，都有`chdir,creates,removes`等参数\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s shell\n\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'mkdir /tmp/test'\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'ls /tmp' \n\n#执行下面这条命令，每次执行都会更新文件的时间戳\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'cd /tmp/test && touch 1.txt && ls' \n192.168.1.31 | CHANGED | rc=0 >>\n1.txt\n\n# 由于有时候不想更新文件的创建时间戳，则如果存在就不执行creates\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'creates=/tmp/test/1.txt cd /tmp/test && touch 1.txt && ls'\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp/test/1.txt exists\n```\n#### script\n>用于在被管理机器上面执行`shell`脚本的模块，脚本无需在被管理机器上面存在\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s script\n\n# 编写shell脚本\n[root@ansible ~]# vim ansible_test.sh \n#!/bin/bash\necho `hostname`\n\n# 在所有被管理机器上执行该脚本\n[root@ansible ~]# ansible all -m script -a '/root/ansible_test.sh'\n192.168.1.32 | CHANGED => {\n    \"changed\": true, \n    \"rc\": 0, \n    \"stderr\": \"Shared connection to 192.168.1.32 closed.\\r\\n\", \n    \"stderr_lines\": [\n        \"Shared connection to 192.168.1.32 closed.\"\n    ], \n    \"stdout\": \"linux.node02.com\\r\\n\", \n    \"stdout_lines\": [\n        \"linux.node02.com\"\n    ]\n}\n......\n```\n### 文件相关的模块\n#### file\n>用于对文件的处理，创建，删除，权限控制等\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s file\npath     #要管理的文件路径\nrecurse  #递归\nstate：\n     directory  #创建目录，如果目标不存在则创建目录及其子目录\n     touch      #创建文件，如果文件存在，则修改文件 属性\n     \n     absent     #删除文件或目录\n     mode       #设置文件或目录权限\n     owner      #设置文件或目录属主信息\n     group      #设置文件或目录属组信息\n     link       #创建软连接，需要和src配合使用\n     hard       #创建硬连接，需要和src配合使用\n\n# 创建目录\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test1 state=directory'\n\n# 创建文件\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=touch'\n\n# 建立软链接（src表示源文件，path表示目标文件）\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'src=/tmp/test1 path=/tmp/test3 state=link'\n\n# 删除文件\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=absent'\n\n# 创建文件时同时设置权限等信息\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test4 state=directory mode=775 owner=root group=root'\n```\n#### copy\n> 用于管理端复制文件到远程主机，并可以设置权限，属组，属主等\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s copy\nsrc      #需要copy的文件的源路径\ndest     #需要copy的文件的目标路径\nbackup   #对copy的文件进行备份\ncontent  #直接在远程主机被管理文件中添加内容，会覆盖原文件内容\nmode     #对copy到远端的文件设置权限\nowner    #对copy到远端的文件设置属主\ngroup    #对copy到远端文件设置属组\n\n\n# 复制文件到远程主机并改名\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh'\n\n# 复制文件到远程主机，并备份远程文件,安装时间信息备份文件（当更新文件内容后，重新copy时用到）\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh backup=yes'\n\n# 直接在远程主机a.sh中添加内容\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh content=\"#!/bin/bash\\n echo `uptime`\"'\n\n# 复制文件到远程主机，并设置权限及属主与属组\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/passwd src=/etc/passwd mode=700 owner=root group=root'\n```\n#### fetch\n> 用于从被管理机器上面拉取文件，拉取下来的内容会保留目录结构，一般情况用在收集被管理机器的日志文件等\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s fetch\nsrc      #指定需要从远端机器拉取的文件路径\ndest     #指定从远端机器拉取下来的文件存放路径\n\n# 从被管理机器上拉取cron日志文件，默认会已管理节点地址创建一个目录，并存放在内\n[root@ansible ~]# ansible 192.168.1.31 -m fetch -a 'dest=/tmp src=/var/log/cron'\n\n[root@ansible ~]# tree /tmp/192.168.1.31/\n/tmp/192.168.1.31/\n└── var\n    └── log\n        └── cron\n\n2 directories, 1 file\n```\n### 用户相关的模块\n#### user\n>用于对系统用户的管理，用户的创建、删除、家目录、属组等设置\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s user\nname        #指定用户的名字\nhome        #指定用户的家目录\nuid         #指定用户的uid\ngroup       #指定用户的用户组\ngroups      #指定用户的附加组\npassword    #指定用户的密码\nshell       #指定用户的登录shell\ncreate_home #是否创建用户家目录，默认是yes\nremove      #删除用户时，指定是否删除家目录\nstate：\n      absent    #删除用户\n      \n\n# 创建用户名指定家目录，指定uid及组\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=mysql home=/opt/mysql uid=1002 group=root'\n[root@ansible ~]# ansible 192.168.1.31 -m shell  -a 'id mysql && ls -l /opt'\n192.168.1.31 | CHANGED | rc=0 >>\nuid=1002(mysql) gid=0(root) 组=0(root)\n总用量 0\ndrwx------  3 mysql root 78 5月  27 18:13 mysql\n\n# 创建用户，不创建家目录，并且不能登录\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=apache shell=/bin/nologin uid=1003 create_home=no'\n[root@ansible ~]# ansible 192.168.1.31 -m shell  -a 'id apache && tail -1 /etc/passwd'\n192.168.1.31 | CHANGED | rc=0 >>\nuid=1003(apache) gid=1003(apache) 组=1003(apache)\napache:x:1003:1003::/home/apache:/bin/nologin\n\n# 删除用户\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=apache state=absent'\n\n# 删除用户并删除家目录\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=mysql state=absent remove=yes'\n```\n#### group\n>用于创建组，当创建用户时如果需要指定组，组不存在的话就可以通过`group`先创建组\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s group\nname     #指定组的名字\ngid      #指定组的gid\nstate：\n     absent   #删除组\n     present  #创建组（默认的状态）\n\n# 创建组\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www'\n\n# 创建组并指定gid\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www1 gid=1005'\n\n# 删除组\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www1 state=absent'\n```\n### 软件包相关的模块\n#### yum\n>用于对软件包的管理，下载、安装、卸载、升级等操作\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s yum\nname            #指定要操作的软件包名字\ndownload_dir    #指定下载软件包的存放路径，需要配合download_only一起使用\ndownload_only   #只下载软件包，而不进行安装，和yum --downloadonly一样\nlist:\n    installed   #列出所有已安装的软件包\n    updates     #列出所有可以更新的软件包\n    repos       #列出所有的yum仓库\nstate:   \n    installed, present   #安装软件包(两者任选其一都可以)\n    removed, absent      #卸载软件包\n    latest      #安装最新软件包\n    \n# 列出所有已安装的软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=installed'\n\n# 列出所有可更新的软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=updates'\n\n#列出所有的yum仓库\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=repos'\n\n#只下载软件包并到指定目录下\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd download_only=yes download_dir=/tmp'\n\n#安装软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd state=installed'\n\n#卸载软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd state=removed'\n\n#安装包组，类似yum groupinstall 'Development Tools'\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=\"@Development Tools\" state=installed'\n```\n#### pip\n>用于安装python中的包\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s pip\n\n# 使用pip时，需要保证被管理机器上有python-pip软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=python-pip'\n\n# 安装pip包\n[root@ansible ~]# ansible 192.168.1.31 -m pip -a 'name=flask'\n```\n#### service\n>服务模块，用于对服务进行管理，服务的启动、关闭、开机自启等\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s service\nname       #指定需要管理的服务名\nenabled    #指定是否开机自启动\nstate:     #指定服务状态\n    started    #启动服务\n    stopped    #停止服务\n    restarted  #重启服务\n    reloaded   #重载服务\n\n# 启动服务，并设置开机自启动 \n[root@ansible ~]# ansible 192.168.1.31 -m service -a 'name=crond state=started enabled=yes'\n```\n### 计划任务相关的模块\n#### cron\n>用于指定计划任务，和`crontab -e`一样\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s cron\njob     #指定需要执行的任务\nminute   #分钟\nhour     #小时\nday      #天\nmonth    #月\nweekday  #周\nname     #对计划任务进行描述\nstate:\n    absetn   #删除计划任务\n\n\n# 创建一个计划任务，并描述是干嘛用的\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"name='这是一个测试的计划任务' minute=* hour=* day=* month=* weekday=* job='/bin/bash /root/test.sh'\"\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'crontab -l'\n192.168.1.31 | CHANGED | rc=0 >>\n#Ansible: 这是一个测试的计划任务\n* * * * * /bin/bash /root/test.sh\n\n# 创建一个没有带描述的计划任务\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"job='/bin/sh /root/test.sh'\"\n\n# 删除计划任务\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"name='None' job='/bin/sh /root/test.sh' state=absent\"\n```\n### 系统信息相关的模块\n#### setup\n>用于获取系统信息的一个模块\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s setup\n\n# 查看系统所有信息\n[root@ansible ~]# ansible 192.168.1.31 -m setup\n\n# filter 对系统信息进行过滤\n[root@ansible ~]# ansible 192.168.1.31 -m setup -a 'filter=ansible_all_ipv4_addresses'\n\n# 常用的过滤选项\nansible_all_ipv4_addresses         所有的ipv4地址\nansible_all_ipv6_addresses         所有的ipv6地址\nansible_architecture               系统的架构\nansible_date_time                  系统时间\nansible_default_ipv4               系统的默认ipv4地址\nansible_distribution               系统名称\nansible_distribution_file_variety  系统的家族\nansible_distribution_major_version 系统的版本\nansible_domain                     系统所在的域\nansible_fqdn                       系统的主机名\nansible_hostname                   系统的主机名,简写\nansible_os_family                  系统的家族\nansible_processor_cores            cpu的核数\nansible_processor_count            cpu的颗数\nansible_processor_vcpus            cpu的个数\n```","slug":"Ansible Ad-hoc常用Module","published":1,"updated":"2019-07-10T01:46:29.880Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjxwlqrla0010lctc6qq10fec","content":"<h2 id=\"Ansible-Ad-hoc模式常用模块\"><a href=\"#Ansible-Ad-hoc模式常用模块\" class=\"headerlink\" title=\"Ansible Ad-hoc模式常用模块\"></a>Ansible Ad-hoc模式常用模块</h2><p>ansible-doc 常用命令<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ansible-doc -h</span></span><br><span class=\"line\"><span class=\"symbol\">Usage:</span> ansible-doc [-l<span class=\"params\">|-F|</span>-s] [options] [-t &lt;plugin type&gt; ] [plugin]</span><br><span class=\"line\">-j  以json格式显示所有模块信息</span><br><span class=\"line\">-l  列出所有的模块</span><br><span class=\"line\">-s  查看模块常用参数</span><br><span class=\"line\"><span class=\"comment\"># 直接跟模块名，显示模块所有信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -j</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -l</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -l |wc -l   #统计所有模块个数，ansible2.8共计2834个模块</span></span><br><span class=\"line\"><span class=\"number\">2834</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"命令相关的模块\"><a href=\"#命令相关的模块\" class=\"headerlink\" title=\"命令相关的模块\"></a>命令相关的模块</h3><h4 id=\"command\"><a href=\"#command\" class=\"headerlink\" title=\"command\"></a>command</h4><blockquote>\n<p><code>ansible</code>默认的模块,执行命令，注意：shell中的<code>&quot;&lt;&quot;</code>, <code>&quot;&gt;&quot;</code>, <code>&quot;|&quot;</code>, <code>&quot;;&quot;</code>, <code>&quot;&amp;&quot;</code>,<code>&quot;$&quot;</code>等特殊字符不能在<code>command</code>模块中使用，如果需要使用，则用<code>shell</code>模块</p>\n</blockquote>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看模块参数</span><br><span class=\"line\">[root@ansible ~]# ansible-doc -s command</span><br><span class=\"line\"></span><br><span class=\"line\"># 在<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span>服务器上面执行ls命令，默认是在当前用户的家目录/root</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'ls'</span><br><span class=\"line\"></span><br><span class=\"line\"># chdir  先切换工作目录，再执行后面的命令，一般情况下在编译时候使用</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'chdir=/tmp pwd'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/tmp</span><br><span class=\"line\"></span><br><span class=\"line\"># creates  如果creates的文件存在，则执行后面的操作</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'creates=/tmp ls /etc/passwd'    #tmp目录存在，则不执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp exists</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'creates=/tmp11 ls /etc/passwd'    # tmp11文件不存在，则执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/etc/passwd</span><br><span class=\"line\"></span><br><span class=\"line\"># removes  和creates相反，如果removes的文件存在，才执行后面的操作</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'removes=/tmp ls /etc/passwd'    #tmp文件存在，则执行了后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/etc/passwd</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'removes=/tmp11 ls /etc/passwd'  #tmp11文件不存在，则没有执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp11 does not exist</span><br></pre></td></tr></table></figure>\n<h4 id=\"shell\"><a href=\"#shell\" class=\"headerlink\" title=\"shell\"></a>shell</h4><blockquote>\n<p>专门用来执行<code>shell</code>命令的模块，和<code>command</code>模块一样，参数基本一样，都有<code>chdir,creates,removes</code>等参数</p>\n</blockquote>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看模块参数</span><br><span class=\"line\">[root@ansible ~]# ansible-doc -s shell</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'mkdir /tmp/test'</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'ls /tmp' </span><br><span class=\"line\"></span><br><span class=\"line\">#执行下面这条命令，每次执行都会更新文件的时间戳</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'cd /tmp/test &amp;&amp; <span class=\"section\">touch</span> <span class=\"number\">1.</span>txt &amp;&amp; ls' </span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\"><span class=\"number\">1.</span>txt</span><br><span class=\"line\"></span><br><span class=\"line\"># 由于有时候不想更新文件的创建时间戳，则如果存在就不执行creates</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'creates=/tmp/test/<span class=\"number\">1.</span>txt cd /tmp/test &amp;&amp; <span class=\"section\">touch</span> <span class=\"number\">1.</span>txt &amp;&amp; ls'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp/test/<span class=\"number\">1.</span>txt exists</span><br></pre></td></tr></table></figure>\n<h4 id=\"script\"><a href=\"#script\" class=\"headerlink\" title=\"script\"></a>script</h4><blockquote>\n<p>用于在被管理机器上面执行<code>shell</code>脚本的模块，脚本无需在被管理机器上面存在</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s script</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编写shell脚本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># vim ansible_test.sh </span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> `hostname`</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在所有被管理机器上执行该脚本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible all -m script -a '/root/ansible_test.sh'</span></span><br><span class=\"line\">192.168.1.32 | CHANGED =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">true</span>, </span><br><span class=\"line\">    <span class=\"string\">\"rc\"</span>: 0, </span><br><span class=\"line\">    <span class=\"string\">\"stderr\"</span>: <span class=\"string\">\"Shared connection to 192.168.1.32 closed.\\r\\n\"</span>, </span><br><span class=\"line\">    <span class=\"string\">\"stderr_lines\"</span>: [</span><br><span class=\"line\">        <span class=\"string\">\"Shared connection to 192.168.1.32 closed.\"</span></span><br><span class=\"line\">    ], </span><br><span class=\"line\">    <span class=\"string\">\"stdout\"</span>: <span class=\"string\">\"linux.node02.com\\r\\n\"</span>, </span><br><span class=\"line\">    <span class=\"string\">\"stdout_lines\"</span>: [</span><br><span class=\"line\">        <span class=\"string\">\"linux.node02.com\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">......</span><br></pre></td></tr></table></figure>\n<h3 id=\"文件相关的模块\"><a href=\"#文件相关的模块\" class=\"headerlink\" title=\"文件相关的模块\"></a>文件相关的模块</h3><h4 id=\"file\"><a href=\"#file\" class=\"headerlink\" title=\"file\"></a>file</h4><blockquote>\n<p>用于对文件的处理，创建，删除，权限控制等</p>\n</blockquote>\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s file</span></span><br><span class=\"line\">path     <span class=\"comment\">#要管理的文件路径</span></span><br><span class=\"line\">recurse  <span class=\"comment\">#递归</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>：</span><br><span class=\"line\">     directory  <span class=\"comment\">#创建目录，如果目标不存在则创建目录及其子目录</span></span><br><span class=\"line\">     touch      <span class=\"comment\">#创建文件，如果文件存在，则修改文件 属性</span></span><br><span class=\"line\">     </span><br><span class=\"line\">     absent     <span class=\"comment\">#删除文件或目录</span></span><br><span class=\"line\">     mode       <span class=\"comment\">#设置文件或目录权限</span></span><br><span class=\"line\">     owner      <span class=\"comment\">#设置文件或目录属主信息</span></span><br><span class=\"line\">     group      <span class=\"comment\">#设置文件或目录属组信息</span></span><br><span class=\"line\">     <span class=\"keyword\">link</span>       <span class=\"comment\">#创建软连接，需要和src配合使用</span></span><br><span class=\"line\">     hard       <span class=\"comment\">#创建硬连接，需要和src配合使用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建目录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test1 state=directory'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建文件</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=touch'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 建立软链接（src表示源文件，path表示目标文件）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'src=/tmp/test1 path=/tmp/test3 state=link'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除文件</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=absent'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建文件时同时设置权限等信息</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test4 state=directory mode=775 owner=root group=root'</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"copy\"><a href=\"#copy\" class=\"headerlink\" title=\"copy\"></a>copy</h4><blockquote>\n<p>用于管理端复制文件到远程主机，并可以设置权限，属组，属主等</p>\n</blockquote>\n<figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s copy</span></span><br><span class=\"line\">src      <span class=\"comment\">#需要copy的文件的源路径</span></span><br><span class=\"line\">dest     <span class=\"comment\">#需要copy的文件的目标路径</span></span><br><span class=\"line\">backup   <span class=\"comment\">#对copy的文件进行备份</span></span><br><span class=\"line\">content  <span class=\"comment\">#直接在远程主机被管理文件中添加内容，会覆盖原文件内容</span></span><br><span class=\"line\">mode     <span class=\"comment\">#对copy到远端的文件设置权限</span></span><br><span class=\"line\">owner    <span class=\"comment\">#对copy到远端的文件设置属主</span></span><br><span class=\"line\">group    <span class=\"comment\">#对copy到远端文件设置属组</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机并改名</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机，并备份远程文件,安装时间信息备份文件（当更新文件内容后，重新copy时用到）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh backup=yes'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 直接在远程主机a.sh中添加内容</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh content=\"#!/bin/bash\\n echo `uptime`\"'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机，并设置权限及属主与属组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/passwd src=/etc/passwd mode=700 owner=root group=root'</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"fetch\"><a href=\"#fetch\" class=\"headerlink\" title=\"fetch\"></a>fetch</h4><blockquote>\n<p>用于从被管理机器上面拉取文件，拉取下来的内容会保留目录结构，一般情况用在收集被管理机器的日志文件等</p>\n</blockquote>\n<figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s fetch</span></span><br><span class=\"line\">src      <span class=\"comment\">#指定需要从远端机器拉取的文件路径</span></span><br><span class=\"line\">dest     <span class=\"comment\">#指定从远端机器拉取下来的文件存放路径</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从被管理机器上拉取cron日志文件，默认会已管理节点地址创建一个目录，并存放在内</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m fetch -a 'dest=/tmp src=/var/log/cron'</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># tree /tmp/192.168.1.31/</span></span><br><span class=\"line\"><span class=\"regexp\">/tmp/192.168.1.31/</span></span><br><span class=\"line\">└── <span class=\"keyword\">var</span></span><br><span class=\"line\">    └── log</span><br><span class=\"line\">        └── cron</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span> directories, <span class=\"number\">1</span> file</span><br></pre></td></tr></table></figure>\n<h3 id=\"用户相关的模块\"><a href=\"#用户相关的模块\" class=\"headerlink\" title=\"用户相关的模块\"></a>用户相关的模块</h3><h4 id=\"user\"><a href=\"#user\" class=\"headerlink\" title=\"user\"></a>user</h4><blockquote>\n<p>用于对系统用户的管理，用户的创建、删除、家目录、属组等设置</p>\n</blockquote>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s user</span></span><br><span class=\"line\">name        <span class=\"comment\">#指定用户的名字</span></span><br><span class=\"line\">home        <span class=\"comment\">#指定用户的家目录</span></span><br><span class=\"line\">uid         <span class=\"comment\">#指定用户的uid</span></span><br><span class=\"line\">group       <span class=\"comment\">#指定用户的用户组</span></span><br><span class=\"line\">groups      <span class=\"comment\">#指定用户的附加组</span></span><br><span class=\"line\">password    <span class=\"comment\">#指定用户的密码</span></span><br><span class=\"line\">shell       <span class=\"comment\">#指定用户的登录shell</span></span><br><span class=\"line\">create_home <span class=\"comment\">#是否创建用户家目录，默认是yes</span></span><br><span class=\"line\">remove      <span class=\"comment\">#删除用户时，指定是否删除家目录</span></span><br><span class=\"line\">state：</span><br><span class=\"line\">      absent    <span class=\"comment\">#删除用户</span></span><br><span class=\"line\">      </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建用户名指定家目录，指定uid及组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=mysql home=/opt/mysql uid=1002 group=root'</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell  -a 'id mysql &amp;&amp; ls -l /opt'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\">uid=<span class=\"number\">1002</span>(mysql) gid=<span class=\"number\">0</span>(root) 组=<span class=\"number\">0</span>(root)</span><br><span class=\"line\">总用量 <span class=\"number\">0</span></span><br><span class=\"line\">drwx------  <span class=\"number\">3</span> mysql root <span class=\"number\">78</span> <span class=\"number\">5</span>月  <span class=\"number\">27</span> <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">13</span> mysql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建用户，不创建家目录，并且不能登录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=apache shell=/bin/nologin uid=1003 create_home=no'</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell  -a 'id apache &amp;&amp; tail -1 /etc/passwd'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\">uid=<span class=\"number\">1003</span>(apache) gid=<span class=\"number\">1003</span>(apache) 组=<span class=\"number\">1003</span>(apache)</span><br><span class=\"line\"><span class=\"symbol\">apache:</span><span class=\"symbol\">x:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/apache</span><span class=\"symbol\">:/bin/nologin</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除用户</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=apache state=absent'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除用户并删除家目录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=mysql state=absent remove=yes'</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"group\"><a href=\"#group\" class=\"headerlink\" title=\"group\"></a>group</h4><blockquote>\n<p>用于创建组，当创建用户时如果需要指定组，组不存在的话就可以通过<code>group</code>先创建组</p>\n</blockquote>\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s group</span></span><br><span class=\"line\">name     <span class=\"comment\">#指定组的名字</span></span><br><span class=\"line\">gid      <span class=\"comment\">#指定组的gid</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>：</span><br><span class=\"line\">     absent   <span class=\"comment\">#删除组</span></span><br><span class=\"line\">     present  <span class=\"comment\">#创建组（默认的状态）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建组并指定gid</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www1 gid=1005'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www1 state=absent'</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"软件包相关的模块\"><a href=\"#软件包相关的模块\" class=\"headerlink\" title=\"软件包相关的模块\"></a>软件包相关的模块</h3><h4 id=\"yum\"><a href=\"#yum\" class=\"headerlink\" title=\"yum\"></a>yum</h4><blockquote>\n<p>用于对软件包的管理，下载、安装、卸载、升级等操作</p>\n</blockquote>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s yum</span></span><br><span class=\"line\">name            <span class=\"meta\">#指定要操作的软件包名字</span></span><br><span class=\"line\">download_dir    <span class=\"meta\">#指定下载软件包的存放路径，需要配合download_only一起使用</span></span><br><span class=\"line\">download_only   <span class=\"meta\">#只下载软件包，而不进行安装，和yum --downloadonly一样</span></span><br><span class=\"line\">list:</span><br><span class=\"line\">    installed   <span class=\"meta\">#列出所有已安装的软件包</span></span><br><span class=\"line\">    updates     <span class=\"meta\">#列出所有可以更新的软件包</span></span><br><span class=\"line\">    repos       <span class=\"meta\">#列出所有的yum仓库</span></span><br><span class=\"line\">state:   </span><br><span class=\"line\">    installed, present   <span class=\"meta\">#安装软件包(两者任选其一都可以)</span></span><br><span class=\"line\">    removed, absent      <span class=\"meta\">#卸载软件包</span></span><br><span class=\"line\">    latest      <span class=\"meta\">#安装最新软件包</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\"># 列出所有已安装的软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=installed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 列出所有可更新的软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=updates'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#列出所有的yum仓库</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=repos'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#只下载软件包并到指定目录下</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd download_only=yes download_dir=/tmp'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd state=installed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#卸载软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd state=removed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装包组，类似yum groupinstall <span class=\"string\">'Development Tools'</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=\"@Development Tools\" state=installed'</span></span></span><br></pre></td></tr></table></figure>\n<h4 id=\"pip\"><a href=\"#pip\" class=\"headerlink\" title=\"pip\"></a>pip</h4><blockquote>\n<p>用于安装python中的包</p>\n</blockquote>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s pip</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 使用pip时，需要保证被管理机器上有python-pip软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=python-pip'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 安装pip包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m pip -a <span class=\"string\">'name=flask'</span></span></span><br></pre></td></tr></table></figure>\n<h4 id=\"service\"><a href=\"#service\" class=\"headerlink\" title=\"service\"></a>service</h4><blockquote>\n<p>服务模块，用于对服务进行管理，服务的启动、关闭、开机自启等</p>\n</blockquote>\n<figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s service</span></span><br><span class=\"line\">name       <span class=\"comment\">#指定需要管理的服务名</span></span><br><span class=\"line\">enabled    <span class=\"comment\">#指定是否开机自启动</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>:     <span class=\"comment\">#指定服务状态</span></span><br><span class=\"line\">    started    <span class=\"comment\">#启动服务</span></span><br><span class=\"line\">    stopped    <span class=\"comment\">#停止服务</span></span><br><span class=\"line\">    restarted  <span class=\"comment\">#重启服务</span></span><br><span class=\"line\">    reloaded   <span class=\"comment\">#重载服务</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动服务，并设置开机自启动 </span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m service -a 'name=crond state=started enabled=yes'</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"计划任务相关的模块\"><a href=\"#计划任务相关的模块\" class=\"headerlink\" title=\"计划任务相关的模块\"></a>计划任务相关的模块</h3><h4 id=\"cron\"><a href=\"#cron\" class=\"headerlink\" title=\"cron\"></a>cron</h4><blockquote>\n<p>用于指定计划任务，和<code>crontab -e</code>一样</p>\n</blockquote>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s cron</span></span><br><span class=\"line\">job     <span class=\"comment\">#指定需要执行的任务</span></span><br><span class=\"line\">minute   <span class=\"comment\">#分钟</span></span><br><span class=\"line\">hour     <span class=\"comment\">#小时</span></span><br><span class=\"line\">day      <span class=\"comment\">#天</span></span><br><span class=\"line\">month    <span class=\"comment\">#月</span></span><br><span class=\"line\">weekday  <span class=\"comment\">#周</span></span><br><span class=\"line\">name     <span class=\"comment\">#对计划任务进行描述</span></span><br><span class=\"line\"><span class=\"symbol\">state:</span></span><br><span class=\"line\">    absetn   <span class=\"comment\">#删除计划任务</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个计划任务，并描述是干嘛用的</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"name='这是一个测试的计划任务' minute=* hour=* day=* month=* weekday=* job='/bin/bash /root/test.sh'\"</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell -a 'crontab -l'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"comment\">#Ansible: 这是一个测试的计划任务</span></span><br><span class=\"line\">* * * * * <span class=\"regexp\">/bin/bash</span> /root/test.sh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个没有带描述的计划任务</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"job='/bin/sh /root/test.sh'\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除计划任务</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"name='None' job='/bin/sh /root/test.sh' state=absent\"</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"系统信息相关的模块\"><a href=\"#系统信息相关的模块\" class=\"headerlink\" title=\"系统信息相关的模块\"></a>系统信息相关的模块</h3><h4 id=\"setup\"><a href=\"#setup\" class=\"headerlink\" title=\"setup\"></a>setup</h4><blockquote>\n<p>用于获取系统信息的一个模块</p>\n</blockquote>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s setup</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 查看系统所有信息</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m setup</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># filter 对系统信息进行过滤</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m setup -a <span class=\"string\">'filter=ansible_all_ipv4_addresses'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 常用的过滤选项</span></span><br><span class=\"line\">ansible_all_ipv4_addresses         所有的ipv4地址</span><br><span class=\"line\">ansible_all_ipv6_addresses         所有的ipv6地址</span><br><span class=\"line\">ansible_architecture               系统的架构</span><br><span class=\"line\">ansible_date_time                  系统时间</span><br><span class=\"line\">ansible_default_ipv4               系统的默认ipv4地址</span><br><span class=\"line\">ansible_distribution               系统名称</span><br><span class=\"line\">ansible_distribution_file_variety  系统的家族</span><br><span class=\"line\">ansible_distribution_major_version 系统的版本</span><br><span class=\"line\">ansible_domain                     系统所在的域</span><br><span class=\"line\">ansible_fqdn                       系统的主机名</span><br><span class=\"line\">ansible_hostname                   系统的主机名,简写</span><br><span class=\"line\">ansible_os_family                  系统的家族</span><br><span class=\"line\">ansible_processor_cores            cpu的核数</span><br><span class=\"line\">ansible_processor_count            cpu的颗数</span><br><span class=\"line\">ansible_processor_vcpus            cpu的个数</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Ansible-Ad-hoc模式常用模块\"><a href=\"#Ansible-Ad-hoc模式常用模块\" class=\"headerlink\" title=\"Ansible Ad-hoc模式常用模块\"></a>Ansible Ad-hoc模式常用模块</h2><p>ansible-doc 常用命令<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ansible-doc -h</span></span><br><span class=\"line\"><span class=\"symbol\">Usage:</span> ansible-doc [-l<span class=\"params\">|-F|</span>-s] [options] [-t &lt;plugin type&gt; ] [plugin]</span><br><span class=\"line\">-j  以json格式显示所有模块信息</span><br><span class=\"line\">-l  列出所有的模块</span><br><span class=\"line\">-s  查看模块常用参数</span><br><span class=\"line\"><span class=\"comment\"># 直接跟模块名，显示模块所有信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -j</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -l</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -l |wc -l   #统计所有模块个数，ansible2.8共计2834个模块</span></span><br><span class=\"line\"><span class=\"number\">2834</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"命令相关的模块\"><a href=\"#命令相关的模块\" class=\"headerlink\" title=\"命令相关的模块\"></a>命令相关的模块</h3><h4 id=\"command\"><a href=\"#command\" class=\"headerlink\" title=\"command\"></a>command</h4><blockquote>\n<p><code>ansible</code>默认的模块,执行命令，注意：shell中的<code>&quot;&lt;&quot;</code>, <code>&quot;&gt;&quot;</code>, <code>&quot;|&quot;</code>, <code>&quot;;&quot;</code>, <code>&quot;&amp;&quot;</code>,<code>&quot;$&quot;</code>等特殊字符不能在<code>command</code>模块中使用，如果需要使用，则用<code>shell</code>模块</p>\n</blockquote>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看模块参数</span><br><span class=\"line\">[root@ansible ~]# ansible-doc -s command</span><br><span class=\"line\"></span><br><span class=\"line\"># 在<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span>服务器上面执行ls命令，默认是在当前用户的家目录/root</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'ls'</span><br><span class=\"line\"></span><br><span class=\"line\"># chdir  先切换工作目录，再执行后面的命令，一般情况下在编译时候使用</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'chdir=/tmp pwd'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/tmp</span><br><span class=\"line\"></span><br><span class=\"line\"># creates  如果creates的文件存在，则执行后面的操作</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'creates=/tmp ls /etc/passwd'    #tmp目录存在，则不执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp exists</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'creates=/tmp11 ls /etc/passwd'    # tmp11文件不存在，则执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/etc/passwd</span><br><span class=\"line\"></span><br><span class=\"line\"># removes  和creates相反，如果removes的文件存在，才执行后面的操作</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'removes=/tmp ls /etc/passwd'    #tmp文件存在，则执行了后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/etc/passwd</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'removes=/tmp11 ls /etc/passwd'  #tmp11文件不存在，则没有执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp11 does not exist</span><br></pre></td></tr></table></figure>\n<h4 id=\"shell\"><a href=\"#shell\" class=\"headerlink\" title=\"shell\"></a>shell</h4><blockquote>\n<p>专门用来执行<code>shell</code>命令的模块，和<code>command</code>模块一样，参数基本一样，都有<code>chdir,creates,removes</code>等参数</p>\n</blockquote>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看模块参数</span><br><span class=\"line\">[root@ansible ~]# ansible-doc -s shell</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'mkdir /tmp/test'</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'ls /tmp' </span><br><span class=\"line\"></span><br><span class=\"line\">#执行下面这条命令，每次执行都会更新文件的时间戳</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'cd /tmp/test &amp;&amp; <span class=\"section\">touch</span> <span class=\"number\">1.</span>txt &amp;&amp; ls' </span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\"><span class=\"number\">1.</span>txt</span><br><span class=\"line\"></span><br><span class=\"line\"># 由于有时候不想更新文件的创建时间戳，则如果存在就不执行creates</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'creates=/tmp/test/<span class=\"number\">1.</span>txt cd /tmp/test &amp;&amp; <span class=\"section\">touch</span> <span class=\"number\">1.</span>txt &amp;&amp; ls'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp/test/<span class=\"number\">1.</span>txt exists</span><br></pre></td></tr></table></figure>\n<h4 id=\"script\"><a href=\"#script\" class=\"headerlink\" title=\"script\"></a>script</h4><blockquote>\n<p>用于在被管理机器上面执行<code>shell</code>脚本的模块，脚本无需在被管理机器上面存在</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s script</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编写shell脚本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># vim ansible_test.sh </span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> `hostname`</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在所有被管理机器上执行该脚本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible all -m script -a '/root/ansible_test.sh'</span></span><br><span class=\"line\">192.168.1.32 | CHANGED =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">true</span>, </span><br><span class=\"line\">    <span class=\"string\">\"rc\"</span>: 0, </span><br><span class=\"line\">    <span class=\"string\">\"stderr\"</span>: <span class=\"string\">\"Shared connection to 192.168.1.32 closed.\\r\\n\"</span>, </span><br><span class=\"line\">    <span class=\"string\">\"stderr_lines\"</span>: [</span><br><span class=\"line\">        <span class=\"string\">\"Shared connection to 192.168.1.32 closed.\"</span></span><br><span class=\"line\">    ], </span><br><span class=\"line\">    <span class=\"string\">\"stdout\"</span>: <span class=\"string\">\"linux.node02.com\\r\\n\"</span>, </span><br><span class=\"line\">    <span class=\"string\">\"stdout_lines\"</span>: [</span><br><span class=\"line\">        <span class=\"string\">\"linux.node02.com\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">......</span><br></pre></td></tr></table></figure>\n<h3 id=\"文件相关的模块\"><a href=\"#文件相关的模块\" class=\"headerlink\" title=\"文件相关的模块\"></a>文件相关的模块</h3><h4 id=\"file\"><a href=\"#file\" class=\"headerlink\" title=\"file\"></a>file</h4><blockquote>\n<p>用于对文件的处理，创建，删除，权限控制等</p>\n</blockquote>\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s file</span></span><br><span class=\"line\">path     <span class=\"comment\">#要管理的文件路径</span></span><br><span class=\"line\">recurse  <span class=\"comment\">#递归</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>：</span><br><span class=\"line\">     directory  <span class=\"comment\">#创建目录，如果目标不存在则创建目录及其子目录</span></span><br><span class=\"line\">     touch      <span class=\"comment\">#创建文件，如果文件存在，则修改文件 属性</span></span><br><span class=\"line\">     </span><br><span class=\"line\">     absent     <span class=\"comment\">#删除文件或目录</span></span><br><span class=\"line\">     mode       <span class=\"comment\">#设置文件或目录权限</span></span><br><span class=\"line\">     owner      <span class=\"comment\">#设置文件或目录属主信息</span></span><br><span class=\"line\">     group      <span class=\"comment\">#设置文件或目录属组信息</span></span><br><span class=\"line\">     <span class=\"keyword\">link</span>       <span class=\"comment\">#创建软连接，需要和src配合使用</span></span><br><span class=\"line\">     hard       <span class=\"comment\">#创建硬连接，需要和src配合使用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建目录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test1 state=directory'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建文件</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=touch'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 建立软链接（src表示源文件，path表示目标文件）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'src=/tmp/test1 path=/tmp/test3 state=link'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除文件</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=absent'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建文件时同时设置权限等信息</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test4 state=directory mode=775 owner=root group=root'</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"copy\"><a href=\"#copy\" class=\"headerlink\" title=\"copy\"></a>copy</h4><blockquote>\n<p>用于管理端复制文件到远程主机，并可以设置权限，属组，属主等</p>\n</blockquote>\n<figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s copy</span></span><br><span class=\"line\">src      <span class=\"comment\">#需要copy的文件的源路径</span></span><br><span class=\"line\">dest     <span class=\"comment\">#需要copy的文件的目标路径</span></span><br><span class=\"line\">backup   <span class=\"comment\">#对copy的文件进行备份</span></span><br><span class=\"line\">content  <span class=\"comment\">#直接在远程主机被管理文件中添加内容，会覆盖原文件内容</span></span><br><span class=\"line\">mode     <span class=\"comment\">#对copy到远端的文件设置权限</span></span><br><span class=\"line\">owner    <span class=\"comment\">#对copy到远端的文件设置属主</span></span><br><span class=\"line\">group    <span class=\"comment\">#对copy到远端文件设置属组</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机并改名</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机，并备份远程文件,安装时间信息备份文件（当更新文件内容后，重新copy时用到）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh backup=yes'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 直接在远程主机a.sh中添加内容</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh content=\"#!/bin/bash\\n echo `uptime`\"'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机，并设置权限及属主与属组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/passwd src=/etc/passwd mode=700 owner=root group=root'</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"fetch\"><a href=\"#fetch\" class=\"headerlink\" title=\"fetch\"></a>fetch</h4><blockquote>\n<p>用于从被管理机器上面拉取文件，拉取下来的内容会保留目录结构，一般情况用在收集被管理机器的日志文件等</p>\n</blockquote>\n<figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s fetch</span></span><br><span class=\"line\">src      <span class=\"comment\">#指定需要从远端机器拉取的文件路径</span></span><br><span class=\"line\">dest     <span class=\"comment\">#指定从远端机器拉取下来的文件存放路径</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从被管理机器上拉取cron日志文件，默认会已管理节点地址创建一个目录，并存放在内</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m fetch -a 'dest=/tmp src=/var/log/cron'</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># tree /tmp/192.168.1.31/</span></span><br><span class=\"line\"><span class=\"regexp\">/tmp/192.168.1.31/</span></span><br><span class=\"line\">└── <span class=\"keyword\">var</span></span><br><span class=\"line\">    └── log</span><br><span class=\"line\">        └── cron</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span> directories, <span class=\"number\">1</span> file</span><br></pre></td></tr></table></figure>\n<h3 id=\"用户相关的模块\"><a href=\"#用户相关的模块\" class=\"headerlink\" title=\"用户相关的模块\"></a>用户相关的模块</h3><h4 id=\"user\"><a href=\"#user\" class=\"headerlink\" title=\"user\"></a>user</h4><blockquote>\n<p>用于对系统用户的管理，用户的创建、删除、家目录、属组等设置</p>\n</blockquote>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s user</span></span><br><span class=\"line\">name        <span class=\"comment\">#指定用户的名字</span></span><br><span class=\"line\">home        <span class=\"comment\">#指定用户的家目录</span></span><br><span class=\"line\">uid         <span class=\"comment\">#指定用户的uid</span></span><br><span class=\"line\">group       <span class=\"comment\">#指定用户的用户组</span></span><br><span class=\"line\">groups      <span class=\"comment\">#指定用户的附加组</span></span><br><span class=\"line\">password    <span class=\"comment\">#指定用户的密码</span></span><br><span class=\"line\">shell       <span class=\"comment\">#指定用户的登录shell</span></span><br><span class=\"line\">create_home <span class=\"comment\">#是否创建用户家目录，默认是yes</span></span><br><span class=\"line\">remove      <span class=\"comment\">#删除用户时，指定是否删除家目录</span></span><br><span class=\"line\">state：</span><br><span class=\"line\">      absent    <span class=\"comment\">#删除用户</span></span><br><span class=\"line\">      </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建用户名指定家目录，指定uid及组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=mysql home=/opt/mysql uid=1002 group=root'</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell  -a 'id mysql &amp;&amp; ls -l /opt'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\">uid=<span class=\"number\">1002</span>(mysql) gid=<span class=\"number\">0</span>(root) 组=<span class=\"number\">0</span>(root)</span><br><span class=\"line\">总用量 <span class=\"number\">0</span></span><br><span class=\"line\">drwx------  <span class=\"number\">3</span> mysql root <span class=\"number\">78</span> <span class=\"number\">5</span>月  <span class=\"number\">27</span> <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">13</span> mysql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建用户，不创建家目录，并且不能登录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=apache shell=/bin/nologin uid=1003 create_home=no'</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell  -a 'id apache &amp;&amp; tail -1 /etc/passwd'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\">uid=<span class=\"number\">1003</span>(apache) gid=<span class=\"number\">1003</span>(apache) 组=<span class=\"number\">1003</span>(apache)</span><br><span class=\"line\"><span class=\"symbol\">apache:</span><span class=\"symbol\">x:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/apache</span><span class=\"symbol\">:/bin/nologin</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除用户</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=apache state=absent'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除用户并删除家目录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=mysql state=absent remove=yes'</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"group\"><a href=\"#group\" class=\"headerlink\" title=\"group\"></a>group</h4><blockquote>\n<p>用于创建组，当创建用户时如果需要指定组，组不存在的话就可以通过<code>group</code>先创建组</p>\n</blockquote>\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s group</span></span><br><span class=\"line\">name     <span class=\"comment\">#指定组的名字</span></span><br><span class=\"line\">gid      <span class=\"comment\">#指定组的gid</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>：</span><br><span class=\"line\">     absent   <span class=\"comment\">#删除组</span></span><br><span class=\"line\">     present  <span class=\"comment\">#创建组（默认的状态）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建组并指定gid</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www1 gid=1005'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www1 state=absent'</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"软件包相关的模块\"><a href=\"#软件包相关的模块\" class=\"headerlink\" title=\"软件包相关的模块\"></a>软件包相关的模块</h3><h4 id=\"yum\"><a href=\"#yum\" class=\"headerlink\" title=\"yum\"></a>yum</h4><blockquote>\n<p>用于对软件包的管理，下载、安装、卸载、升级等操作</p>\n</blockquote>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s yum</span></span><br><span class=\"line\">name            <span class=\"meta\">#指定要操作的软件包名字</span></span><br><span class=\"line\">download_dir    <span class=\"meta\">#指定下载软件包的存放路径，需要配合download_only一起使用</span></span><br><span class=\"line\">download_only   <span class=\"meta\">#只下载软件包，而不进行安装，和yum --downloadonly一样</span></span><br><span class=\"line\">list:</span><br><span class=\"line\">    installed   <span class=\"meta\">#列出所有已安装的软件包</span></span><br><span class=\"line\">    updates     <span class=\"meta\">#列出所有可以更新的软件包</span></span><br><span class=\"line\">    repos       <span class=\"meta\">#列出所有的yum仓库</span></span><br><span class=\"line\">state:   </span><br><span class=\"line\">    installed, present   <span class=\"meta\">#安装软件包(两者任选其一都可以)</span></span><br><span class=\"line\">    removed, absent      <span class=\"meta\">#卸载软件包</span></span><br><span class=\"line\">    latest      <span class=\"meta\">#安装最新软件包</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\"># 列出所有已安装的软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=installed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 列出所有可更新的软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=updates'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#列出所有的yum仓库</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=repos'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#只下载软件包并到指定目录下</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd download_only=yes download_dir=/tmp'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd state=installed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#卸载软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd state=removed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装包组，类似yum groupinstall <span class=\"string\">'Development Tools'</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=\"@Development Tools\" state=installed'</span></span></span><br></pre></td></tr></table></figure>\n<h4 id=\"pip\"><a href=\"#pip\" class=\"headerlink\" title=\"pip\"></a>pip</h4><blockquote>\n<p>用于安装python中的包</p>\n</blockquote>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s pip</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 使用pip时，需要保证被管理机器上有python-pip软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=python-pip'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 安装pip包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m pip -a <span class=\"string\">'name=flask'</span></span></span><br></pre></td></tr></table></figure>\n<h4 id=\"service\"><a href=\"#service\" class=\"headerlink\" title=\"service\"></a>service</h4><blockquote>\n<p>服务模块，用于对服务进行管理，服务的启动、关闭、开机自启等</p>\n</blockquote>\n<figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s service</span></span><br><span class=\"line\">name       <span class=\"comment\">#指定需要管理的服务名</span></span><br><span class=\"line\">enabled    <span class=\"comment\">#指定是否开机自启动</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>:     <span class=\"comment\">#指定服务状态</span></span><br><span class=\"line\">    started    <span class=\"comment\">#启动服务</span></span><br><span class=\"line\">    stopped    <span class=\"comment\">#停止服务</span></span><br><span class=\"line\">    restarted  <span class=\"comment\">#重启服务</span></span><br><span class=\"line\">    reloaded   <span class=\"comment\">#重载服务</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动服务，并设置开机自启动 </span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m service -a 'name=crond state=started enabled=yes'</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"计划任务相关的模块\"><a href=\"#计划任务相关的模块\" class=\"headerlink\" title=\"计划任务相关的模块\"></a>计划任务相关的模块</h3><h4 id=\"cron\"><a href=\"#cron\" class=\"headerlink\" title=\"cron\"></a>cron</h4><blockquote>\n<p>用于指定计划任务，和<code>crontab -e</code>一样</p>\n</blockquote>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s cron</span></span><br><span class=\"line\">job     <span class=\"comment\">#指定需要执行的任务</span></span><br><span class=\"line\">minute   <span class=\"comment\">#分钟</span></span><br><span class=\"line\">hour     <span class=\"comment\">#小时</span></span><br><span class=\"line\">day      <span class=\"comment\">#天</span></span><br><span class=\"line\">month    <span class=\"comment\">#月</span></span><br><span class=\"line\">weekday  <span class=\"comment\">#周</span></span><br><span class=\"line\">name     <span class=\"comment\">#对计划任务进行描述</span></span><br><span class=\"line\"><span class=\"symbol\">state:</span></span><br><span class=\"line\">    absetn   <span class=\"comment\">#删除计划任务</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个计划任务，并描述是干嘛用的</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"name='这是一个测试的计划任务' minute=* hour=* day=* month=* weekday=* job='/bin/bash /root/test.sh'\"</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell -a 'crontab -l'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"comment\">#Ansible: 这是一个测试的计划任务</span></span><br><span class=\"line\">* * * * * <span class=\"regexp\">/bin/bash</span> /root/test.sh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个没有带描述的计划任务</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"job='/bin/sh /root/test.sh'\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除计划任务</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"name='None' job='/bin/sh /root/test.sh' state=absent\"</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"系统信息相关的模块\"><a href=\"#系统信息相关的模块\" class=\"headerlink\" title=\"系统信息相关的模块\"></a>系统信息相关的模块</h3><h4 id=\"setup\"><a href=\"#setup\" class=\"headerlink\" title=\"setup\"></a>setup</h4><blockquote>\n<p>用于获取系统信息的一个模块</p>\n</blockquote>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s setup</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 查看系统所有信息</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m setup</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># filter 对系统信息进行过滤</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m setup -a <span class=\"string\">'filter=ansible_all_ipv4_addresses'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 常用的过滤选项</span></span><br><span class=\"line\">ansible_all_ipv4_addresses         所有的ipv4地址</span><br><span class=\"line\">ansible_all_ipv6_addresses         所有的ipv6地址</span><br><span class=\"line\">ansible_architecture               系统的架构</span><br><span class=\"line\">ansible_date_time                  系统时间</span><br><span class=\"line\">ansible_default_ipv4               系统的默认ipv4地址</span><br><span class=\"line\">ansible_distribution               系统名称</span><br><span class=\"line\">ansible_distribution_file_variety  系统的家族</span><br><span class=\"line\">ansible_distribution_major_version 系统的版本</span><br><span class=\"line\">ansible_domain                     系统所在的域</span><br><span class=\"line\">ansible_fqdn                       系统的主机名</span><br><span class=\"line\">ansible_hostname                   系统的主机名,简写</span><br><span class=\"line\">ansible_os_family                  系统的家族</span><br><span class=\"line\">ansible_processor_cores            cpu的核数</span><br><span class=\"line\">ansible_processor_count            cpu的颗数</span><br><span class=\"line\">ansible_processor_vcpus            cpu的个数</span><br></pre></td></tr></table></figure>"},{"title":"Ansible之Roles","date":"2019-06-03T02:35:22.000Z","copyright":true,"_content":"## Roles介绍\n> `ansible`自`1.2`版本引入的新特性，用于层次性、结构化地组织`playbook`。`roles`能够根据层次型结构自动装载变量文件、`tasks`以及`handlers`等。要使用`roles`只需要在`playbook`中使用`include`指令引入即可。简单来讲，`roles`就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷的`include`它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。主要使用场景代码复用度较高的情况下。\n\n## Roles目录结构\n![rolesdir.png](Ansible之Roles/rolesdir.png)\n\n**各目录含义解释**\n```\nroles:          <--所有的角色必须放在roles目录下，这个目录可以自定义位置，默认的位置在/etc/ansible/roles\n  project:      <---具体的角色项目名称，比如nginx、tomcat、php\n    files：     <--用来存放由copy模块或script模块调用的文件。\n    templates：\t<--用来存放jinjia2模板，template模块会自动在此目录中寻找jinjia2模板文件。\n    tasks：     <--此目录应当包含一个main.yml文件，用于定义此角色的任务列表，此文件可以使用include包含其它的位于此目录的task文件。\n\t  main.yml\n    handlers：\t<--此目录应当包含一个main.yml文件，用于定义此角色中触发条件时执行的动作。\n\t  main.yml\n    vars：\t <--此目录应当包含一个main.yml文件，用于定义此角色用到的变量。\n\t  main.yml\n    defaults：\t<--此目录应当包含一个main.yml文件，用于为当前角色设定默认变量。\n\t  main.yml\n    meta：\t<--此目录应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系。\n\t  main.yml\n```\n## Roles示例\n>通过`ansible roles`安装配置`httpd`服务，此处的`roles`使用默认的路径`/etc/ansible/roles`\n\n1）创建目录\n```\n[root@ansible ~]# cd /etc/ansible/roles/\n# 创建需要用到的目录\n[root@ansible roles]# mkdir -p httpd/{handlers,tasks,templates,vars}\n[root@ansible roles]# cd httpd/\n[root@ansible httpd]# tree .\n.\n├── handlers\n├── tasks\n├── templates\n└── vars\n\n4 directories, 0 file\n```\n2）变量文件准备`vars/main.yml`\n```\n[root@ansible httpd]# vim vars/main.yml\nPORT: 8088        #指定httpd监听的端口\nUSERNAME: www     #指定httpd运行用户\nGROUPNAME: www    #指定httpd运行组\n```\n3）配置文件模板准备`templates/httpd.conf.j2`\n```\n# copy一个本地的配置文件放在templates/下并已j2为后缀\n[root@ansible httpd]# cp /etc/httpd/conf/httpd.conf templates/httpd.conf.j2\n\n# 进行一些修改，调用上面定义的变量\n[root@ansible httpd]# vim templates/httpd.conf.j2\nListen {{ PORT }} \nUser {{ USERNAME }}\nGroup {{ GROUPNAME }}\n```\n4）任务剧本编写，创建用户、创建组、安装软件、配置、启动等\n```\n# 创建组的task\n[root@ansible httpd]# vim tasks/group.yml\n- name: Create a Startup Group\n  group: name=www gid=60 system=yes\n\n# 创建用户的task\n[root@ansible httpd]# vim tasks/user.yml\n- name: Create Startup Users\n  user: name=www uid=60 system=yes shell=/sbin/nologin\n\n# 安装软件的task\n[root@ansible httpd]# vim tasks/install.yml\n- name: Install Package Httpd\n  yum: name=httpd state=installed\n\n# 配置软件的task\n[root@ansible httpd]# vim tasks/config.yml\n- name: Copy Httpd Template File\n  template: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf\n  notify: Restart Httpd\n\n# 启动软件的task\n[root@ansible httpd]# vim tasks/start.yml\n- name: Start Httpd Service\n  service: name=httpd state=started enabled=yes\n\n# 编写main.yml，将上面的这些task引入进来\n[root@ansible httpd]# vim tasks/main.yml\n- include: group.yml\n- include: user.yml\n- include: install.yml\n- include: config.yml\n- include: start.ym\n```\n5）编写重启httpd的`handlers`，`handlers/main.yml`\n```\n[root@ansible httpd]# vim handlers/main.yml\n# 这里的名字需要和task中的notify保持一致\n- name: Restart Httpd\n  service: name=httpd state=restarted\n```\n6）编写主的`httpd_roles.yml`文件调用httpd角色\n```\n[root@ansible httpd]# cd ..\n[root@ansible roles]# vim httpd_roles.yml\n---\n- hosts: all\n  remote_user: root\n  roles:\n    - role: httpd        #指定角色名称\n```\n7）整体的一个目录结构查看\n```\n[root@ansible roles]# tree .\n.\n├── httpd\n│   ├── handlers\n│   │   └── main.yml\n│   ├── tasks\n│   │   ├── config.yml\n│   │   ├── group.yml\n│   │   ├── install.yml\n│   │   ├── main.yml\n│   │   ├── start.yml\n│   │   └── user.yml\n│   ├── templates\n│   │   └── httpd.conf.j2\n│   └── vars\n│       └── main.yml\n└── httpd_roles.yml\n\n5 directories, 10 files\n```\n8）测试`playbook`语法是否正确\n```\n[root@ansible roles]# ansible-playbook -C httpd_roles.yml \n\nPLAY [all] **************************************************************************************************\n\nTASK [Gathering Facts] **************************************************************************************\nok: [192.168.1.33]\nok: [192.168.1.32]\nok: [192.168.1.31]\nok: [192.168.1.36]\n\nTASK [httpd : Create a Startup Group] ***********************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.36]\nchanged: [192.168.1.32]\n\nTASK [httpd : Create Startup Users] *************************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.36]\n\nTASK [httpd : Install Package Httpd] ************************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.36]\n\nTASK [httpd : Copy Httpd Template File] *********************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.36]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nTASK [httpd : Start Httpd Service] **************************************************************************\nchanged: [192.168.1.36]\nchanged: [192.168.1.31]\nchanged: [192.168.1.32]\nchanged: [192.168.1.33]\n\nRUNNING HANDLER [httpd : Restart Httpd] *********************************************************************\nchanged: [192.168.1.36]\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nPLAY RECAP **************************************************************************************************\n192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 \n```\n9）上面的测试没有问题，正式执行`playbook`\n```\n[root@ansible roles]# ansible-playbook -C httpd_roles.yml \n\nPLAY [all] **************************************************************************************************\n\nTASK [Gathering Facts] **************************************************************************************\nok: [192.168.1.33]\nok: [192.168.1.32]\nok: [192.168.1.31]\nok: [192.168.1.36]\n\nTASK [httpd : Create a Startup Group] ***********************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.36]\nchanged: [192.168.1.32]\n\nTASK [httpd : Create Startup Users] *************************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.36]\n\nTASK [httpd : Install Package Httpd] ************************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.36]\n\nTASK [httpd : Copy Httpd Template File] *********************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.36]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nTASK [httpd : Start Httpd Service] **************************************************************************\nchanged: [192.168.1.36]\nchanged: [192.168.1.31]\nchanged: [192.168.1.32]\nchanged: [192.168.1.33]\n\nRUNNING HANDLER [httpd : Restart Httpd] *********************************************************************\nchanged: [192.168.1.36]\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nPLAY RECAP **************************************************************************************************\n192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n\n[root@ansible roles]# ansible-playbook httpd_roles.yml \n\nPLAY [all] **************************************************************************************************\n\nTASK [Gathering Facts] **************************************************************************************\nok: [192.168.1.32]\nok: [192.168.1.33]\nok: [192.168.1.31]\nok: [192.168.1.36]\n\nTASK [httpd : Create a Startup Group] ***********************************************************************\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.36]\n\nTASK [httpd : Create Startup Users] *************************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.36]\n\nTASK [httpd : Install Package Httpd] ************************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.36]\n\nTASK [httpd : Copy Httpd Template File] *********************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.36]\n\nTASK [httpd : Start Httpd Service] **************************************************************************\nfatal: [192.168.1.36]: FAILED! => {\"changed\": false, \"msg\": \"httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\\n\"}\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nRUNNING HANDLER [httpd : Restart Httpd] *********************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nPLAY RECAP **************************************************************************************************\n192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.36               : ok=5    changed=4    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0\n```\n这里有看到报错，其原因是因为`192.168.1.36`这台机器是`centos6`系统，别的都是`centos7`系统，两个系统安装的`httpd`默认版本是不一样的，所以报错。如果需要优化。[参考这里](https://buji595.github.io/2019/05/29/Ansible%E4%B9%8BPlaybook/#template%E4%B9%8Bwhen)\n## ansible roles总结\n>1、编写任务(`task`)的时候，里面不需要写需要执行的主机，单纯的写某个任务是干什么的即可，装软件的就是装软件的，启动的就是启动的。单独做某一件事即可，最后通过`main.yml`将这些单独的任务安装执行顺序`include`进来即可，这样方便维护且一目了然。\n>2、定义变量时候直接安装`k:v`格式将变量写在`vars/main.yml`文件即可，然后`task`或者`template`直接调用即可，会自动去`vars/main.yml`文件里面去找。\n>3、定义`handlers`时候，直接在`handlers/main.yml`文件中写需要做什么事情即可，多可的话可以全部写在该文件里面，也可以像`task`那样分开来写，通过`include`引入一样的可以。在`task`调用`notify`时直接写与`handlers`名字对应即可(二者必须高度一直)。\n>4、模板文件一样放在`templates`目录下即可，task调用的时后直接写文件名字即可，会自动去到`templates`里面找。注意：如果是一个角色调用另外一个角色的单个`task`时后，那么`task`中如果有些模板或者文件，就得写绝对路径了。","source":"_posts/Ansible之Roles.md","raw":"---\ntitle: Ansible之Roles\ndate: 2019-06-03 10:35:22\ntags: Ansible\ncategories: Ansible\ncopyright: true\n---\n## Roles介绍\n> `ansible`自`1.2`版本引入的新特性，用于层次性、结构化地组织`playbook`。`roles`能够根据层次型结构自动装载变量文件、`tasks`以及`handlers`等。要使用`roles`只需要在`playbook`中使用`include`指令引入即可。简单来讲，`roles`就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷的`include`它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。主要使用场景代码复用度较高的情况下。\n\n## Roles目录结构\n![rolesdir.png](Ansible之Roles/rolesdir.png)\n\n**各目录含义解释**\n```\nroles:          <--所有的角色必须放在roles目录下，这个目录可以自定义位置，默认的位置在/etc/ansible/roles\n  project:      <---具体的角色项目名称，比如nginx、tomcat、php\n    files：     <--用来存放由copy模块或script模块调用的文件。\n    templates：\t<--用来存放jinjia2模板，template模块会自动在此目录中寻找jinjia2模板文件。\n    tasks：     <--此目录应当包含一个main.yml文件，用于定义此角色的任务列表，此文件可以使用include包含其它的位于此目录的task文件。\n\t  main.yml\n    handlers：\t<--此目录应当包含一个main.yml文件，用于定义此角色中触发条件时执行的动作。\n\t  main.yml\n    vars：\t <--此目录应当包含一个main.yml文件，用于定义此角色用到的变量。\n\t  main.yml\n    defaults：\t<--此目录应当包含一个main.yml文件，用于为当前角色设定默认变量。\n\t  main.yml\n    meta：\t<--此目录应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系。\n\t  main.yml\n```\n## Roles示例\n>通过`ansible roles`安装配置`httpd`服务，此处的`roles`使用默认的路径`/etc/ansible/roles`\n\n1）创建目录\n```\n[root@ansible ~]# cd /etc/ansible/roles/\n# 创建需要用到的目录\n[root@ansible roles]# mkdir -p httpd/{handlers,tasks,templates,vars}\n[root@ansible roles]# cd httpd/\n[root@ansible httpd]# tree .\n.\n├── handlers\n├── tasks\n├── templates\n└── vars\n\n4 directories, 0 file\n```\n2）变量文件准备`vars/main.yml`\n```\n[root@ansible httpd]# vim vars/main.yml\nPORT: 8088        #指定httpd监听的端口\nUSERNAME: www     #指定httpd运行用户\nGROUPNAME: www    #指定httpd运行组\n```\n3）配置文件模板准备`templates/httpd.conf.j2`\n```\n# copy一个本地的配置文件放在templates/下并已j2为后缀\n[root@ansible httpd]# cp /etc/httpd/conf/httpd.conf templates/httpd.conf.j2\n\n# 进行一些修改，调用上面定义的变量\n[root@ansible httpd]# vim templates/httpd.conf.j2\nListen {{ PORT }} \nUser {{ USERNAME }}\nGroup {{ GROUPNAME }}\n```\n4）任务剧本编写，创建用户、创建组、安装软件、配置、启动等\n```\n# 创建组的task\n[root@ansible httpd]# vim tasks/group.yml\n- name: Create a Startup Group\n  group: name=www gid=60 system=yes\n\n# 创建用户的task\n[root@ansible httpd]# vim tasks/user.yml\n- name: Create Startup Users\n  user: name=www uid=60 system=yes shell=/sbin/nologin\n\n# 安装软件的task\n[root@ansible httpd]# vim tasks/install.yml\n- name: Install Package Httpd\n  yum: name=httpd state=installed\n\n# 配置软件的task\n[root@ansible httpd]# vim tasks/config.yml\n- name: Copy Httpd Template File\n  template: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf\n  notify: Restart Httpd\n\n# 启动软件的task\n[root@ansible httpd]# vim tasks/start.yml\n- name: Start Httpd Service\n  service: name=httpd state=started enabled=yes\n\n# 编写main.yml，将上面的这些task引入进来\n[root@ansible httpd]# vim tasks/main.yml\n- include: group.yml\n- include: user.yml\n- include: install.yml\n- include: config.yml\n- include: start.ym\n```\n5）编写重启httpd的`handlers`，`handlers/main.yml`\n```\n[root@ansible httpd]# vim handlers/main.yml\n# 这里的名字需要和task中的notify保持一致\n- name: Restart Httpd\n  service: name=httpd state=restarted\n```\n6）编写主的`httpd_roles.yml`文件调用httpd角色\n```\n[root@ansible httpd]# cd ..\n[root@ansible roles]# vim httpd_roles.yml\n---\n- hosts: all\n  remote_user: root\n  roles:\n    - role: httpd        #指定角色名称\n```\n7）整体的一个目录结构查看\n```\n[root@ansible roles]# tree .\n.\n├── httpd\n│   ├── handlers\n│   │   └── main.yml\n│   ├── tasks\n│   │   ├── config.yml\n│   │   ├── group.yml\n│   │   ├── install.yml\n│   │   ├── main.yml\n│   │   ├── start.yml\n│   │   └── user.yml\n│   ├── templates\n│   │   └── httpd.conf.j2\n│   └── vars\n│       └── main.yml\n└── httpd_roles.yml\n\n5 directories, 10 files\n```\n8）测试`playbook`语法是否正确\n```\n[root@ansible roles]# ansible-playbook -C httpd_roles.yml \n\nPLAY [all] **************************************************************************************************\n\nTASK [Gathering Facts] **************************************************************************************\nok: [192.168.1.33]\nok: [192.168.1.32]\nok: [192.168.1.31]\nok: [192.168.1.36]\n\nTASK [httpd : Create a Startup Group] ***********************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.36]\nchanged: [192.168.1.32]\n\nTASK [httpd : Create Startup Users] *************************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.36]\n\nTASK [httpd : Install Package Httpd] ************************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.36]\n\nTASK [httpd : Copy Httpd Template File] *********************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.36]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nTASK [httpd : Start Httpd Service] **************************************************************************\nchanged: [192.168.1.36]\nchanged: [192.168.1.31]\nchanged: [192.168.1.32]\nchanged: [192.168.1.33]\n\nRUNNING HANDLER [httpd : Restart Httpd] *********************************************************************\nchanged: [192.168.1.36]\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nPLAY RECAP **************************************************************************************************\n192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 \n```\n9）上面的测试没有问题，正式执行`playbook`\n```\n[root@ansible roles]# ansible-playbook -C httpd_roles.yml \n\nPLAY [all] **************************************************************************************************\n\nTASK [Gathering Facts] **************************************************************************************\nok: [192.168.1.33]\nok: [192.168.1.32]\nok: [192.168.1.31]\nok: [192.168.1.36]\n\nTASK [httpd : Create a Startup Group] ***********************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.36]\nchanged: [192.168.1.32]\n\nTASK [httpd : Create Startup Users] *************************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.36]\n\nTASK [httpd : Install Package Httpd] ************************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.36]\n\nTASK [httpd : Copy Httpd Template File] *********************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.36]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nTASK [httpd : Start Httpd Service] **************************************************************************\nchanged: [192.168.1.36]\nchanged: [192.168.1.31]\nchanged: [192.168.1.32]\nchanged: [192.168.1.33]\n\nRUNNING HANDLER [httpd : Restart Httpd] *********************************************************************\nchanged: [192.168.1.36]\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nPLAY RECAP **************************************************************************************************\n192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n\n[root@ansible roles]# ansible-playbook httpd_roles.yml \n\nPLAY [all] **************************************************************************************************\n\nTASK [Gathering Facts] **************************************************************************************\nok: [192.168.1.32]\nok: [192.168.1.33]\nok: [192.168.1.31]\nok: [192.168.1.36]\n\nTASK [httpd : Create a Startup Group] ***********************************************************************\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.36]\n\nTASK [httpd : Create Startup Users] *************************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.36]\n\nTASK [httpd : Install Package Httpd] ************************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.36]\n\nTASK [httpd : Copy Httpd Template File] *********************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\nchanged: [192.168.1.36]\n\nTASK [httpd : Start Httpd Service] **************************************************************************\nfatal: [192.168.1.36]: FAILED! => {\"changed\": false, \"msg\": \"httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\\n\"}\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nRUNNING HANDLER [httpd : Restart Httpd] *********************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.31]\n\nPLAY RECAP **************************************************************************************************\n192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.36               : ok=5    changed=4    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0\n```\n这里有看到报错，其原因是因为`192.168.1.36`这台机器是`centos6`系统，别的都是`centos7`系统，两个系统安装的`httpd`默认版本是不一样的，所以报错。如果需要优化。[参考这里](https://buji595.github.io/2019/05/29/Ansible%E4%B9%8BPlaybook/#template%E4%B9%8Bwhen)\n## ansible roles总结\n>1、编写任务(`task`)的时候，里面不需要写需要执行的主机，单纯的写某个任务是干什么的即可，装软件的就是装软件的，启动的就是启动的。单独做某一件事即可，最后通过`main.yml`将这些单独的任务安装执行顺序`include`进来即可，这样方便维护且一目了然。\n>2、定义变量时候直接安装`k:v`格式将变量写在`vars/main.yml`文件即可，然后`task`或者`template`直接调用即可，会自动去`vars/main.yml`文件里面去找。\n>3、定义`handlers`时候，直接在`handlers/main.yml`文件中写需要做什么事情即可，多可的话可以全部写在该文件里面，也可以像`task`那样分开来写，通过`include`引入一样的可以。在`task`调用`notify`时直接写与`handlers`名字对应即可(二者必须高度一直)。\n>4、模板文件一样放在`templates`目录下即可，task调用的时后直接写文件名字即可，会自动去到`templates`里面找。注意：如果是一个角色调用另外一个角色的单个`task`时后，那么`task`中如果有些模板或者文件，就得写绝对路径了。","slug":"Ansible之Roles","published":1,"updated":"2019-07-10T01:46:29.892Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjxwlqrlf0012lctccjytlut2","content":"<h2 id=\"Roles介绍\"><a href=\"#Roles介绍\" class=\"headerlink\" title=\"Roles介绍\"></a>Roles介绍</h2><blockquote>\n<p><code>ansible</code>自<code>1.2</code>版本引入的新特性，用于层次性、结构化地组织<code>playbook</code>。<code>roles</code>能够根据层次型结构自动装载变量文件、<code>tasks</code>以及<code>handlers</code>等。要使用<code>roles</code>只需要在<code>playbook</code>中使用<code>include</code>指令引入即可。简单来讲，<code>roles</code>就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷的<code>include</code>它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。主要使用场景代码复用度较高的情况下。</p>\n</blockquote>\n<h2 id=\"Roles目录结构\"><a href=\"#Roles目录结构\" class=\"headerlink\" title=\"Roles目录结构\"></a>Roles目录结构</h2><p><img src=\"/2019/06/03/Ansible之Roles/rolesdir.png\" alt=\"rolesdir.png\"></p>\n<p><strong>各目录含义解释</strong><br><figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title\">roles</span>:          &lt;--所有的角色必须放在roles目录下，这个目录可以自定义位置，默认的位置在/etc/ansible/roles</span><br><span class=\"line\">  project:      &lt;-<span class=\"comment\">--具体的角色项目名称，比如nginx、tomcat、php</span></span><br><span class=\"line\">    files：     &lt;--用来存放由copy模块或script模块调用的文件。</span><br><span class=\"line\">    templates：\t&lt;--用来存放jinjia2模板，template模块会自动在此目录中寻找jinjia2模板文件。</span><br><span class=\"line\">    tasks：     &lt;--此目录应当包含一个main.yml文件，用于定义此角色的任务列表，此文件可以使用include包含其它的位于此目录的task文件。</span><br><span class=\"line\">\t  main.yml</span><br><span class=\"line\">    handlers：\t&lt;--此目录应当包含一个main.yml文件，用于定义此角色中触发条件时执行的动作。</span><br><span class=\"line\">\t  main.yml</span><br><span class=\"line\">    vars：\t &lt;--此目录应当包含一个main.yml文件，用于定义此角色用到的变量。</span><br><span class=\"line\">\t  main.yml</span><br><span class=\"line\">    defaults：\t&lt;--此目录应当包含一个main.yml文件，用于为当前角色设定默认变量。</span><br><span class=\"line\">\t  main.yml</span><br><span class=\"line\">    meta：\t&lt;--此目录应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系。</span><br><span class=\"line\">\t  main.yml</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Roles示例\"><a href=\"#Roles示例\" class=\"headerlink\" title=\"Roles示例\"></a>Roles示例</h2><blockquote>\n<p>通过<code>ansible roles</code>安装配置<code>httpd</code>服务，此处的<code>roles</code>使用默认的路径<code>/etc/ansible/roles</code></p>\n</blockquote>\n<p>1）创建目录<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># cd /etc/ansible/roles/</span></span><br><span class=\"line\"><span class=\"meta\"># 创建需要用到的目录</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># mkdir -p httpd/&#123;handlers,tasks,templates,vars&#125;</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># cd httpd/</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> httpd]<span class=\"meta\"># tree .</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── handlers</span><br><span class=\"line\">├── tasks</span><br><span class=\"line\">├── templates</span><br><span class=\"line\">└── vars</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4</span> directories, <span class=\"number\">0</span> file</span><br></pre></td></tr></table></figure></p>\n<p>2）变量文件准备<code>vars/main.yml</code><br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible httpd]<span class=\"meta\"># vim vars/main.yml</span></span><br><span class=\"line\"><span class=\"symbol\">PORT:</span> <span class=\"number\">8088</span>        <span class=\"meta\">#指定httpd监听的端口</span></span><br><span class=\"line\"><span class=\"symbol\">USERNAME:</span> www     <span class=\"meta\">#指定httpd运行用户</span></span><br><span class=\"line\"><span class=\"symbol\">GROUPNAME:</span> www    <span class=\"meta\">#指定httpd运行组</span></span><br></pre></td></tr></table></figure></p>\n<p>3）配置文件模板准备<code>templates/httpd.conf.j2</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># copy一个本地的配置文件放在templates/下并已j2为后缀</span></span><br><span class=\"line\">[root@ansible httpd]# cp /etc/httpd/conf/httpd.conf templates/httpd.conf.j2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 进行一些修改，调用上面定义的变量</span></span><br><span class=\"line\">[root@ansible httpd]# vim templates/httpd.conf.j2</span><br><span class=\"line\">Listen &#123;&#123;<span class=\"built_in\"> PORT </span>&#125;&#125; </span><br><span class=\"line\">User &#123;&#123; USERNAME &#125;&#125;</span><br><span class=\"line\">Group &#123;&#123; GROUPNAME &#125;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>4）任务剧本编写，创建用户、创建组、安装软件、配置、启动等<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建组的task</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/group.yml</span><br><span class=\"line\">- name: Create a Startup Group</span><br><span class=\"line\">  group: <span class=\"attribute\">name</span>=www <span class=\"attribute\">gid</span>=60 <span class=\"attribute\">system</span>=<span class=\"literal\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建用户的task</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/user.yml</span><br><span class=\"line\">- name: Create Startup Users</span><br><span class=\"line\">  user: <span class=\"attribute\">name</span>=www <span class=\"attribute\">uid</span>=60 <span class=\"attribute\">system</span>=<span class=\"literal\">yes</span> <span class=\"attribute\">shell</span>=/sbin/nologin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装软件的task</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/install.yml</span><br><span class=\"line\">- name: Install Package Httpd</span><br><span class=\"line\">  yum: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=installed</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置软件的task</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/config.yml</span><br><span class=\"line\">- name: Copy Httpd Template File</span><br><span class=\"line\">  template: <span class=\"attribute\">src</span>=httpd.conf.j2 <span class=\"attribute\">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class=\"line\">  notify: Restart Httpd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动软件的task</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/start.yml</span><br><span class=\"line\">- name: Start Httpd Service</span><br><span class=\"line\">  service: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=started <span class=\"attribute\">enabled</span>=<span class=\"literal\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编写main.yml，将上面的这些task引入进来</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/main.yml</span><br><span class=\"line\">- include: group.yml</span><br><span class=\"line\">- include: user.yml</span><br><span class=\"line\">- include: install.yml</span><br><span class=\"line\">- include: config.yml</span><br><span class=\"line\">- include: start.ym</span><br></pre></td></tr></table></figure></p>\n<p>5）编写重启httpd的<code>handlers</code>，<code>handlers/main.yml</code><br><figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible httpd]<span class=\"comment\"># vim handlers/main.yml</span></span><br><span class=\"line\"><span class=\"comment\"># 这里的名字需要和task中的notify保持一致</span></span><br><span class=\"line\">- name: Restart Httpd</span><br><span class=\"line\">  service: name=httpd <span class=\"keyword\">state</span>=restarted</span><br></pre></td></tr></table></figure></p>\n<p>6）编写主的<code>httpd_roles.yml</code>文件调用httpd角色<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">httpd]#</span> <span class=\"string\">cd</span> <span class=\"string\">..</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">vim</span> <span class=\"string\">httpd_roles.yml</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  roles:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">httpd</span>        <span class=\"comment\">#指定角色名称</span></span><br></pre></td></tr></table></figure></p>\n<p>7）整体的一个目录结构查看<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">tree</span> .</span><br><span class=\"line\">.</span><br><span class=\"line\">├── <span class=\"selector-tag\">httpd</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">group</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">start</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">user</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">httpd</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">│       └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">httpd_roles</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\">5 <span class=\"selector-tag\">directories</span>, 10 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure></p>\n<p>8）测试<code>playbook</code>语法是否正确<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible roles]# ansible-playbook -C httpd_roles.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [all] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create a Startup Group] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create Startup Users] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Install Package Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Copy Httpd Template File] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Start Httpd Service] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [httpd : Restart Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<p>9）上面的测试没有问题，正式执行<code>playbook</code><br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible roles]# ansible-playbook -C httpd_roles.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [all] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create a Startup Group] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create Startup Users] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Install Package Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Copy Httpd Template File] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Start Httpd Service] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [httpd : Restart Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible roles]# ansible-playbook httpd_roles.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [all] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create a Startup Group] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create Startup Users] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Install Package Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Copy Httpd Template File] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Start Httpd Service] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">fatal: [192.168.1.36]: FAILED! =&gt; &#123;\"changed\": false, \"msg\": \"httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\\n\"&#125;</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [httpd : Restart Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.36               : ok=5    changed=4    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<p>这里有看到报错，其原因是因为<code>192.168.1.36</code>这台机器是<code>centos6</code>系统，别的都是<code>centos7</code>系统，两个系统安装的<code>httpd</code>默认版本是不一样的，所以报错。如果需要优化。<a href=\"https://buji595.github.io/2019/05/29/Ansible%E4%B9%8BPlaybook/#template%E4%B9%8Bwhen\" target=\"_blank\" rel=\"noopener\">参考这里</a></p>\n<h2 id=\"ansible-roles总结\"><a href=\"#ansible-roles总结\" class=\"headerlink\" title=\"ansible roles总结\"></a>ansible roles总结</h2><blockquote>\n<p>1、编写任务(<code>task</code>)的时候，里面不需要写需要执行的主机，单纯的写某个任务是干什么的即可，装软件的就是装软件的，启动的就是启动的。单独做某一件事即可，最后通过<code>main.yml</code>将这些单独的任务安装执行顺序<code>include</code>进来即可，这样方便维护且一目了然。<br>2、定义变量时候直接安装<code>k:v</code>格式将变量写在<code>vars/main.yml</code>文件即可，然后<code>task</code>或者<code>template</code>直接调用即可，会自动去<code>vars/main.yml</code>文件里面去找。<br>3、定义<code>handlers</code>时候，直接在<code>handlers/main.yml</code>文件中写需要做什么事情即可，多可的话可以全部写在该文件里面，也可以像<code>task</code>那样分开来写，通过<code>include</code>引入一样的可以。在<code>task</code>调用<code>notify</code>时直接写与<code>handlers</code>名字对应即可(二者必须高度一直)。<br>4、模板文件一样放在<code>templates</code>目录下即可，task调用的时后直接写文件名字即可，会自动去到<code>templates</code>里面找。注意：如果是一个角色调用另外一个角色的单个<code>task</code>时后，那么<code>task</code>中如果有些模板或者文件，就得写绝对路径了。</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Roles介绍\"><a href=\"#Roles介绍\" class=\"headerlink\" title=\"Roles介绍\"></a>Roles介绍</h2><blockquote>\n<p><code>ansible</code>自<code>1.2</code>版本引入的新特性，用于层次性、结构化地组织<code>playbook</code>。<code>roles</code>能够根据层次型结构自动装载变量文件、<code>tasks</code>以及<code>handlers</code>等。要使用<code>roles</code>只需要在<code>playbook</code>中使用<code>include</code>指令引入即可。简单来讲，<code>roles</code>就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷的<code>include</code>它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。主要使用场景代码复用度较高的情况下。</p>\n</blockquote>\n<h2 id=\"Roles目录结构\"><a href=\"#Roles目录结构\" class=\"headerlink\" title=\"Roles目录结构\"></a>Roles目录结构</h2><p><img src=\"/2019/06/03/Ansible之Roles/rolesdir.png\" alt=\"rolesdir.png\"></p>\n<p><strong>各目录含义解释</strong><br><figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title\">roles</span>:          &lt;--所有的角色必须放在roles目录下，这个目录可以自定义位置，默认的位置在/etc/ansible/roles</span><br><span class=\"line\">  project:      &lt;-<span class=\"comment\">--具体的角色项目名称，比如nginx、tomcat、php</span></span><br><span class=\"line\">    files：     &lt;--用来存放由copy模块或script模块调用的文件。</span><br><span class=\"line\">    templates：\t&lt;--用来存放jinjia2模板，template模块会自动在此目录中寻找jinjia2模板文件。</span><br><span class=\"line\">    tasks：     &lt;--此目录应当包含一个main.yml文件，用于定义此角色的任务列表，此文件可以使用include包含其它的位于此目录的task文件。</span><br><span class=\"line\">\t  main.yml</span><br><span class=\"line\">    handlers：\t&lt;--此目录应当包含一个main.yml文件，用于定义此角色中触发条件时执行的动作。</span><br><span class=\"line\">\t  main.yml</span><br><span class=\"line\">    vars：\t &lt;--此目录应当包含一个main.yml文件，用于定义此角色用到的变量。</span><br><span class=\"line\">\t  main.yml</span><br><span class=\"line\">    defaults：\t&lt;--此目录应当包含一个main.yml文件，用于为当前角色设定默认变量。</span><br><span class=\"line\">\t  main.yml</span><br><span class=\"line\">    meta：\t&lt;--此目录应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系。</span><br><span class=\"line\">\t  main.yml</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Roles示例\"><a href=\"#Roles示例\" class=\"headerlink\" title=\"Roles示例\"></a>Roles示例</h2><blockquote>\n<p>通过<code>ansible roles</code>安装配置<code>httpd</code>服务，此处的<code>roles</code>使用默认的路径<code>/etc/ansible/roles</code></p>\n</blockquote>\n<p>1）创建目录<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># cd /etc/ansible/roles/</span></span><br><span class=\"line\"><span class=\"meta\"># 创建需要用到的目录</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># mkdir -p httpd/&#123;handlers,tasks,templates,vars&#125;</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># cd httpd/</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> httpd]<span class=\"meta\"># tree .</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── handlers</span><br><span class=\"line\">├── tasks</span><br><span class=\"line\">├── templates</span><br><span class=\"line\">└── vars</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4</span> directories, <span class=\"number\">0</span> file</span><br></pre></td></tr></table></figure></p>\n<p>2）变量文件准备<code>vars/main.yml</code><br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible httpd]<span class=\"meta\"># vim vars/main.yml</span></span><br><span class=\"line\"><span class=\"symbol\">PORT:</span> <span class=\"number\">8088</span>        <span class=\"meta\">#指定httpd监听的端口</span></span><br><span class=\"line\"><span class=\"symbol\">USERNAME:</span> www     <span class=\"meta\">#指定httpd运行用户</span></span><br><span class=\"line\"><span class=\"symbol\">GROUPNAME:</span> www    <span class=\"meta\">#指定httpd运行组</span></span><br></pre></td></tr></table></figure></p>\n<p>3）配置文件模板准备<code>templates/httpd.conf.j2</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># copy一个本地的配置文件放在templates/下并已j2为后缀</span></span><br><span class=\"line\">[root@ansible httpd]# cp /etc/httpd/conf/httpd.conf templates/httpd.conf.j2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 进行一些修改，调用上面定义的变量</span></span><br><span class=\"line\">[root@ansible httpd]# vim templates/httpd.conf.j2</span><br><span class=\"line\">Listen &#123;&#123;<span class=\"built_in\"> PORT </span>&#125;&#125; </span><br><span class=\"line\">User &#123;&#123; USERNAME &#125;&#125;</span><br><span class=\"line\">Group &#123;&#123; GROUPNAME &#125;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>4）任务剧本编写，创建用户、创建组、安装软件、配置、启动等<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建组的task</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/group.yml</span><br><span class=\"line\">- name: Create a Startup Group</span><br><span class=\"line\">  group: <span class=\"attribute\">name</span>=www <span class=\"attribute\">gid</span>=60 <span class=\"attribute\">system</span>=<span class=\"literal\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建用户的task</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/user.yml</span><br><span class=\"line\">- name: Create Startup Users</span><br><span class=\"line\">  user: <span class=\"attribute\">name</span>=www <span class=\"attribute\">uid</span>=60 <span class=\"attribute\">system</span>=<span class=\"literal\">yes</span> <span class=\"attribute\">shell</span>=/sbin/nologin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装软件的task</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/install.yml</span><br><span class=\"line\">- name: Install Package Httpd</span><br><span class=\"line\">  yum: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=installed</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置软件的task</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/config.yml</span><br><span class=\"line\">- name: Copy Httpd Template File</span><br><span class=\"line\">  template: <span class=\"attribute\">src</span>=httpd.conf.j2 <span class=\"attribute\">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class=\"line\">  notify: Restart Httpd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动软件的task</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/start.yml</span><br><span class=\"line\">- name: Start Httpd Service</span><br><span class=\"line\">  service: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=started <span class=\"attribute\">enabled</span>=<span class=\"literal\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编写main.yml，将上面的这些task引入进来</span></span><br><span class=\"line\">[root@ansible httpd]# vim tasks/main.yml</span><br><span class=\"line\">- include: group.yml</span><br><span class=\"line\">- include: user.yml</span><br><span class=\"line\">- include: install.yml</span><br><span class=\"line\">- include: config.yml</span><br><span class=\"line\">- include: start.ym</span><br></pre></td></tr></table></figure></p>\n<p>5）编写重启httpd的<code>handlers</code>，<code>handlers/main.yml</code><br><figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible httpd]<span class=\"comment\"># vim handlers/main.yml</span></span><br><span class=\"line\"><span class=\"comment\"># 这里的名字需要和task中的notify保持一致</span></span><br><span class=\"line\">- name: Restart Httpd</span><br><span class=\"line\">  service: name=httpd <span class=\"keyword\">state</span>=restarted</span><br></pre></td></tr></table></figure></p>\n<p>6）编写主的<code>httpd_roles.yml</code>文件调用httpd角色<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">httpd]#</span> <span class=\"string\">cd</span> <span class=\"string\">..</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">vim</span> <span class=\"string\">httpd_roles.yml</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  roles:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">httpd</span>        <span class=\"comment\">#指定角色名称</span></span><br></pre></td></tr></table></figure></p>\n<p>7）整体的一个目录结构查看<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">tree</span> .</span><br><span class=\"line\">.</span><br><span class=\"line\">├── <span class=\"selector-tag\">httpd</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">group</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">start</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">user</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">httpd</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">│       └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">httpd_roles</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\">5 <span class=\"selector-tag\">directories</span>, 10 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure></p>\n<p>8）测试<code>playbook</code>语法是否正确<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible roles]# ansible-playbook -C httpd_roles.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [all] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create a Startup Group] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create Startup Users] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Install Package Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Copy Httpd Template File] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Start Httpd Service] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [httpd : Restart Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<p>9）上面的测试没有问题，正式执行<code>playbook</code><br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible roles]# ansible-playbook -C httpd_roles.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [all] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create a Startup Group] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create Startup Users] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Install Package Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Copy Httpd Template File] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Start Httpd Service] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [httpd : Restart Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.36               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible roles]# ansible-playbook httpd_roles.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [all] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create a Startup Group] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Create Startup Users] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Install Package Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Copy Httpd Template File] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [httpd : Start Httpd Service] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">fatal: [192.168.1.36]: FAILED! =&gt; &#123;\"changed\": false, \"msg\": \"httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\\n\"&#125;</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [httpd : Restart Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.32               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.33               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.36               : ok=5    changed=4    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<p>这里有看到报错，其原因是因为<code>192.168.1.36</code>这台机器是<code>centos6</code>系统，别的都是<code>centos7</code>系统，两个系统安装的<code>httpd</code>默认版本是不一样的，所以报错。如果需要优化。<a href=\"https://buji595.github.io/2019/05/29/Ansible%E4%B9%8BPlaybook/#template%E4%B9%8Bwhen\" target=\"_blank\" rel=\"noopener\">参考这里</a></p>\n<h2 id=\"ansible-roles总结\"><a href=\"#ansible-roles总结\" class=\"headerlink\" title=\"ansible roles总结\"></a>ansible roles总结</h2><blockquote>\n<p>1、编写任务(<code>task</code>)的时候，里面不需要写需要执行的主机，单纯的写某个任务是干什么的即可，装软件的就是装软件的，启动的就是启动的。单独做某一件事即可，最后通过<code>main.yml</code>将这些单独的任务安装执行顺序<code>include</code>进来即可，这样方便维护且一目了然。<br>2、定义变量时候直接安装<code>k:v</code>格式将变量写在<code>vars/main.yml</code>文件即可，然后<code>task</code>或者<code>template</code>直接调用即可，会自动去<code>vars/main.yml</code>文件里面去找。<br>3、定义<code>handlers</code>时候，直接在<code>handlers/main.yml</code>文件中写需要做什么事情即可，多可的话可以全部写在该文件里面，也可以像<code>task</code>那样分开来写，通过<code>include</code>引入一样的可以。在<code>task</code>调用<code>notify</code>时直接写与<code>handlers</code>名字对应即可(二者必须高度一直)。<br>4、模板文件一样放在<code>templates</code>目录下即可，task调用的时后直接写文件名字即可，会自动去到<code>templates</code>里面找。注意：如果是一个角色调用另外一个角色的单个<code>task</code>时后，那么<code>task</code>中如果有些模板或者文件，就得写绝对路径了。</p>\n</blockquote>\n"},{"title":"Ansible快速入门","date":"2019-05-26T14:35:22.000Z","copyright":true,"_content":"## 介绍\n>`Ansible`是一款简单的运维自动化工具，只需要使用`ssh`协议连接就可以来进行系统管理，自动化执行命令，部署等任务。\n\n**Ansible的特点**\n>1、ansible不需要单独安装客户端，也不需要启动任何服务\n>2、ansible是python中的一套完整的自动化执行任务模块\n>3、ansible playbook 采用yaml配置，对于自动化任务执行过一目了然\n\n**Ansible组成结构**\n- Ansible\n  是`Ansible`的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。\n- Ansible Playbook\n  任务剧本（又称任务集），编排定义`Ansible`任务集的配置文件，由`Ansible`顺序依次执行，`yaml`格式。\n- Inventory\n  `Ansible`管理主机的清单，默认是`/etc/ansible/hosts`文件。\n- Modules\n  `Ansible`执行命令的功能模块，`Ansible2.3`版本为止，共有`1039`个模块。还可以自定义模块。\n- Plugins\n  插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。\n- API\n  提供给第三方程序调用的应用程序编程接口。\n\n\n## 环境准备\n|      IP      |  系统   |      主机名      |      描述       |\n| :----------: | :-----: | :--------------: | :-------------: |\n| 192.168.1.30 | CentOS7 |     ansible      | ansible管理节点 |\n| 192.168.1.31 | CentOS7 | linux.node01.com |   被管理节点1   |\n| 192.168.1.32 | CentOS7 | linux.node02.com |   被管理节点2   |\n| 192.168.1.33 | CentOS7 | linux.node03.com |   被管理节点3   |\n| 192.168.1.36 | CentOS6 | linux.node06.com |   被管理节点6   |\n\n## Ansible安装\n1）配置`epel`源\n```\n[root@ansible ~]# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n[root@ansible ~]# yum clean all\n[root@ansible ~]# yum makecache\n```\n2）安装`ansible`\n```\n[root@ansible ~]# yum -y install ansible\n\n# 查看ansible版本\n[root@ansible ~]# ansible --version\nansible 2.8.0\n  config file = /etc/ansible/ansible.cfg\n  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']\n  ansible python module location = /usr/lib/python2.7/site-packages/ansible\n  executable location = /usr/bin/ansible\n  python version = 2.7.5 (default, Aug  4 2017, 00:39:18) [GCC 4.8.5 20150623 (Red Hat 4.8.5-16)]\n```\n## Ansible Inventory文件\n[Inventory中文文档](http://www.ansible.com.cn/docs/intro_inventory.html)\n>`Inventory`文件通常用于定义要管理的主机的认证信息，例如`ssh`登录用户名、密码以及`key`相关信息。可以同时操作一个组的多台主机，组与主机组之间的关系都是通过`inventory`文件配置。配置文件路径为：`/etc/ansible/hosts`\n### 基于密码连接\n```\n[root@ansible ~]# vim /etc/ansible/hosts\n# 方法一 主机+端口+密码\n[webserver]\n192.168.1.31 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.32 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.33 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.36 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n\n\n# 方法二 主机+端口+密码\n[webserver]\n192.168.1.3[1:3] ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n\n\n# 方法二 主机+端口+密码\n[webserver]\n192.168.1.3[1:3]\n[webserver:vars]\nansible_ssh_pass=\"123456\"\n```\n### 基于秘钥连接\n>基于秘钥连接需要先创建公钥和私钥，并发送给被管理机器\n\n1）生成公私钥\n```\n[root@ansible ~]# ssh-keygen\n[root@ansible ~]# for i in {1,2,3,6}; do ssh-copy-id -i 192.168.1.3$i ; done\n```\n2）配置连接\n```\n[root@ansible ~]# vim /etc/ansible/hosts\n# 方法一 主机+端口+密钥\n[webserver]\n192.168.1.31:22\n192.168.1.32\n192.168.1.33\n192.168.1.36\n\n# 方法一 别名主机+端口+密钥\n[webserver]\nnode1 ansible_ssh_host=192.168.1.31 ansible_ssh_port=22\nnode2 ansible_ssh_host=192.168.1.32 ansible_ssh_port=22\nnode3 ansible_ssh_host=192.168.1.33 ansible_ssh_port=22\nnode6 ansible_ssh_host=192.168.1.36 ansible_ssh_port=22\n```\n### 主机组的使用\n```\n# 主机组变量名+主机+密码\n[apache]\n192.168.1.36\n192.168.1.33\n[apache.vars]\nansible_ssh_pass='123456'\n\n# 主机组变量名+主机+密钥\n[nginx]\n192.168.1.3[1:2]\n\n# 定义多个组，把一个组当另外一个组的组员\n[webserver:children]  #webserver组包括两个子组：apache nginx\napache\nnginx\n```\n### 临时指定inventory\n1）先编辑一个主机定义清单\n```\n[root@ansible ~]# vim /etc/dockers\n[dockers]\n192.168.1.31 ansible_ssh_pass='123456'\n192.168.1.32\n192.168.1.33\n```\n2）在执行命令是指定`inventory`\n```\n[root@ansible ~]# ansible dockers -m ping -i /etc/dockers -o \n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.31 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n```\n### Inventory内置参数\n![ansible inventory内置参数](Ansible快速入门/ansible01.png)\n\n## Ansible Ad-Hoc\n[Ad-Hoc中文文档](http://www.ansible.com.cn/docs/intro_adhoc.html)\n>ad hoc —— 临时的，在`ansible`中是指需要快速执行，并且不需要保存的命令。说白了就是执行简单的命令——一条命令。对于复杂的命令则为`playbook`，类似于`saltstack`的`state sls`状态文件。\n\n### ansible命令格式\n1）常用命令参数\n```\n[root@ansible ~]# ansible -h\nUsage: ansible <host-pattern> [options]\n-a MODULE_ARGS   #模块参数\n-C, --check  #检查语法\n-f FORKS #并发\n--list-hosts #列出主机列表\n-m MODULE_NAME #模块名字\n-o 使用精简的输出\n```\n2）示例\n```\n[root@ansible ~]# ansible webserver -m shell -a 'uptime' -o\n192.168.1.36 | CHANGED | rc=0 | (stdout)  13:46:14 up 1 day,  9:20,  4 users,  load average: 0.00, 0.00, 0.00\n192.168.1.33 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:51,  3 users,  load average: 0.00, 0.01, 0.05\n192.168.1.31 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:50,  3 users,  load average: 0.00, 0.01, 0.05\n192.168.1.32 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:59,  3 users,  load average: 0.00, 0.01, 0.05\n```\n3）命令说明\n![ansible command](Ansible快速入门/ansible02.png)\n\n### host-pattern格式\n目标`target`主机，主机组匹配方式\n#### 主机的匹配\n```\n#  一台目标主机\n[root@ansible ~]# ansible 192.168.1.31 -m ping\n\n# 多台目标主机\n[root@ansible ~]# ansible 192.168.1.31,192.168.1.32 -m ping\n\n# 所有目标主机\n[root@ansible ~]# ansible all -m ping\n```\n#### 组的匹配\n```\n# 组的配置信息如下：这里定义了一个nginx组和一个apache组\n[root@ansible ~]# ansible nginx --list\n  hosts (2):\n    192.168.1.31\n    192.168.1.32\n[root@ansible ~]# ansible apache --list\n  hosts (3):\n    192.168.1.36\n    192.168.1.33\n    192.168.1.32\n\n# 一个组的所有主机匹配\n[root@ansible ~]# ansible apache -m ping\n\n# 匹配apache组中有，但是nginx组中没有的所有主机\n[root@ansible ~]# ansible 'apache:!nginx' -m ping -o\n192.168.1.36 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n\n# 匹配apache组和nginx组中都有的机器（并集）\n[root@ansible ~]# ansible 'apache:&nginx' -m ping -o\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n\n# 匹配apache组nginx组两个组所有的机器（并集）；等于ansible apache,nginx -m ping\n[root@ansible ~]# ansible 'apache:nginx' -m ping -o\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.31 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.36 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n```\n\n\n","source":"_posts/Ansible快速入门.md","raw":"---\ntitle: Ansible快速入门\ndate: 2019-05-26 22:35:22\ntags: Ansible\ncategories: Ansible\ncopyright: true\n---\n## 介绍\n>`Ansible`是一款简单的运维自动化工具，只需要使用`ssh`协议连接就可以来进行系统管理，自动化执行命令，部署等任务。\n\n**Ansible的特点**\n>1、ansible不需要单独安装客户端，也不需要启动任何服务\n>2、ansible是python中的一套完整的自动化执行任务模块\n>3、ansible playbook 采用yaml配置，对于自动化任务执行过一目了然\n\n**Ansible组成结构**\n- Ansible\n  是`Ansible`的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。\n- Ansible Playbook\n  任务剧本（又称任务集），编排定义`Ansible`任务集的配置文件，由`Ansible`顺序依次执行，`yaml`格式。\n- Inventory\n  `Ansible`管理主机的清单，默认是`/etc/ansible/hosts`文件。\n- Modules\n  `Ansible`执行命令的功能模块，`Ansible2.3`版本为止，共有`1039`个模块。还可以自定义模块。\n- Plugins\n  插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。\n- API\n  提供给第三方程序调用的应用程序编程接口。\n\n\n## 环境准备\n|      IP      |  系统   |      主机名      |      描述       |\n| :----------: | :-----: | :--------------: | :-------------: |\n| 192.168.1.30 | CentOS7 |     ansible      | ansible管理节点 |\n| 192.168.1.31 | CentOS7 | linux.node01.com |   被管理节点1   |\n| 192.168.1.32 | CentOS7 | linux.node02.com |   被管理节点2   |\n| 192.168.1.33 | CentOS7 | linux.node03.com |   被管理节点3   |\n| 192.168.1.36 | CentOS6 | linux.node06.com |   被管理节点6   |\n\n## Ansible安装\n1）配置`epel`源\n```\n[root@ansible ~]# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n[root@ansible ~]# yum clean all\n[root@ansible ~]# yum makecache\n```\n2）安装`ansible`\n```\n[root@ansible ~]# yum -y install ansible\n\n# 查看ansible版本\n[root@ansible ~]# ansible --version\nansible 2.8.0\n  config file = /etc/ansible/ansible.cfg\n  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']\n  ansible python module location = /usr/lib/python2.7/site-packages/ansible\n  executable location = /usr/bin/ansible\n  python version = 2.7.5 (default, Aug  4 2017, 00:39:18) [GCC 4.8.5 20150623 (Red Hat 4.8.5-16)]\n```\n## Ansible Inventory文件\n[Inventory中文文档](http://www.ansible.com.cn/docs/intro_inventory.html)\n>`Inventory`文件通常用于定义要管理的主机的认证信息，例如`ssh`登录用户名、密码以及`key`相关信息。可以同时操作一个组的多台主机，组与主机组之间的关系都是通过`inventory`文件配置。配置文件路径为：`/etc/ansible/hosts`\n### 基于密码连接\n```\n[root@ansible ~]# vim /etc/ansible/hosts\n# 方法一 主机+端口+密码\n[webserver]\n192.168.1.31 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.32 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.33 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.36 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n\n\n# 方法二 主机+端口+密码\n[webserver]\n192.168.1.3[1:3] ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n\n\n# 方法二 主机+端口+密码\n[webserver]\n192.168.1.3[1:3]\n[webserver:vars]\nansible_ssh_pass=\"123456\"\n```\n### 基于秘钥连接\n>基于秘钥连接需要先创建公钥和私钥，并发送给被管理机器\n\n1）生成公私钥\n```\n[root@ansible ~]# ssh-keygen\n[root@ansible ~]# for i in {1,2,3,6}; do ssh-copy-id -i 192.168.1.3$i ; done\n```\n2）配置连接\n```\n[root@ansible ~]# vim /etc/ansible/hosts\n# 方法一 主机+端口+密钥\n[webserver]\n192.168.1.31:22\n192.168.1.32\n192.168.1.33\n192.168.1.36\n\n# 方法一 别名主机+端口+密钥\n[webserver]\nnode1 ansible_ssh_host=192.168.1.31 ansible_ssh_port=22\nnode2 ansible_ssh_host=192.168.1.32 ansible_ssh_port=22\nnode3 ansible_ssh_host=192.168.1.33 ansible_ssh_port=22\nnode6 ansible_ssh_host=192.168.1.36 ansible_ssh_port=22\n```\n### 主机组的使用\n```\n# 主机组变量名+主机+密码\n[apache]\n192.168.1.36\n192.168.1.33\n[apache.vars]\nansible_ssh_pass='123456'\n\n# 主机组变量名+主机+密钥\n[nginx]\n192.168.1.3[1:2]\n\n# 定义多个组，把一个组当另外一个组的组员\n[webserver:children]  #webserver组包括两个子组：apache nginx\napache\nnginx\n```\n### 临时指定inventory\n1）先编辑一个主机定义清单\n```\n[root@ansible ~]# vim /etc/dockers\n[dockers]\n192.168.1.31 ansible_ssh_pass='123456'\n192.168.1.32\n192.168.1.33\n```\n2）在执行命令是指定`inventory`\n```\n[root@ansible ~]# ansible dockers -m ping -i /etc/dockers -o \n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.31 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n```\n### Inventory内置参数\n![ansible inventory内置参数](Ansible快速入门/ansible01.png)\n\n## Ansible Ad-Hoc\n[Ad-Hoc中文文档](http://www.ansible.com.cn/docs/intro_adhoc.html)\n>ad hoc —— 临时的，在`ansible`中是指需要快速执行，并且不需要保存的命令。说白了就是执行简单的命令——一条命令。对于复杂的命令则为`playbook`，类似于`saltstack`的`state sls`状态文件。\n\n### ansible命令格式\n1）常用命令参数\n```\n[root@ansible ~]# ansible -h\nUsage: ansible <host-pattern> [options]\n-a MODULE_ARGS   #模块参数\n-C, --check  #检查语法\n-f FORKS #并发\n--list-hosts #列出主机列表\n-m MODULE_NAME #模块名字\n-o 使用精简的输出\n```\n2）示例\n```\n[root@ansible ~]# ansible webserver -m shell -a 'uptime' -o\n192.168.1.36 | CHANGED | rc=0 | (stdout)  13:46:14 up 1 day,  9:20,  4 users,  load average: 0.00, 0.00, 0.00\n192.168.1.33 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:51,  3 users,  load average: 0.00, 0.01, 0.05\n192.168.1.31 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:50,  3 users,  load average: 0.00, 0.01, 0.05\n192.168.1.32 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:59,  3 users,  load average: 0.00, 0.01, 0.05\n```\n3）命令说明\n![ansible command](Ansible快速入门/ansible02.png)\n\n### host-pattern格式\n目标`target`主机，主机组匹配方式\n#### 主机的匹配\n```\n#  一台目标主机\n[root@ansible ~]# ansible 192.168.1.31 -m ping\n\n# 多台目标主机\n[root@ansible ~]# ansible 192.168.1.31,192.168.1.32 -m ping\n\n# 所有目标主机\n[root@ansible ~]# ansible all -m ping\n```\n#### 组的匹配\n```\n# 组的配置信息如下：这里定义了一个nginx组和一个apache组\n[root@ansible ~]# ansible nginx --list\n  hosts (2):\n    192.168.1.31\n    192.168.1.32\n[root@ansible ~]# ansible apache --list\n  hosts (3):\n    192.168.1.36\n    192.168.1.33\n    192.168.1.32\n\n# 一个组的所有主机匹配\n[root@ansible ~]# ansible apache -m ping\n\n# 匹配apache组中有，但是nginx组中没有的所有主机\n[root@ansible ~]# ansible 'apache:!nginx' -m ping -o\n192.168.1.36 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n\n# 匹配apache组和nginx组中都有的机器（并集）\n[root@ansible ~]# ansible 'apache:&nginx' -m ping -o\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n\n# 匹配apache组nginx组两个组所有的机器（并集）；等于ansible apache,nginx -m ping\n[root@ansible ~]# ansible 'apache:nginx' -m ping -o\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.31 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.36 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n```\n\n\n","slug":"Ansible快速入门","published":1,"updated":"2019-07-10T01:46:29.899Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjxwlqrlm0017lctc4yfk9i80","content":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><blockquote>\n<p><code>Ansible</code>是一款简单的运维自动化工具，只需要使用<code>ssh</code>协议连接就可以来进行系统管理，自动化执行命令，部署等任务。</p>\n</blockquote>\n<p><strong>Ansible的特点</strong></p>\n<blockquote>\n<p>1、ansible不需要单独安装客户端，也不需要启动任何服务<br>2、ansible是python中的一套完整的自动化执行任务模块<br>3、ansible playbook 采用yaml配置，对于自动化任务执行过一目了然</p>\n</blockquote>\n<p><strong>Ansible组成结构</strong></p>\n<ul>\n<li>Ansible<br>是<code>Ansible</code>的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。</li>\n<li>Ansible Playbook<br>任务剧本（又称任务集），编排定义<code>Ansible</code>任务集的配置文件，由<code>Ansible</code>顺序依次执行，<code>yaml</code>格式。</li>\n<li>Inventory<br><code>Ansible</code>管理主机的清单，默认是<code>/etc/ansible/hosts</code>文件。</li>\n<li>Modules<br><code>Ansible</code>执行命令的功能模块，<code>Ansible2.3</code>版本为止，共有<code>1039</code>个模块。还可以自定义模块。</li>\n<li>Plugins<br>插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。</li>\n<li>API<br>提供给第三方程序调用的应用程序编程接口。</li>\n</ul>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><table>\n<thead>\n<tr>\n<th style=\"text-align:center\">IP</th>\n<th style=\"text-align:center\">系统</th>\n<th style=\"text-align:center\">主机名</th>\n<th style=\"text-align:center\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">192.168.1.30</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">ansible</td>\n<td style=\"text-align:center\">ansible管理节点</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.31</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node01.com</td>\n<td style=\"text-align:center\">被管理节点1</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.32</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node02.com</td>\n<td style=\"text-align:center\">被管理节点2</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.33</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node03.com</td>\n<td style=\"text-align:center\">被管理节点3</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.36</td>\n<td style=\"text-align:center\">CentOS6</td>\n<td style=\"text-align:center\">linux.node06.com</td>\n<td style=\"text-align:center\">被管理节点6</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Ansible安装\"><a href=\"#Ansible安装\" class=\"headerlink\" title=\"Ansible安装\"></a>Ansible安装</h2><p>1）配置<code>epel</code>源<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># yum clean all</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># yum makecache</span></span><br></pre></td></tr></table></figure></p>\n<p>2）安装<code>ansible</code><br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]<span class=\"comment\"># yum -y install ansible</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看ansible版本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible --version</span></span><br><span class=\"line\">ansible <span class=\"number\">2.8</span><span class=\"number\">.0</span></span><br><span class=\"line\">  config file = /etc/ansible/ansible.cfg</span><br><span class=\"line\">  configured module search path = [<span class=\"string\">u'/root/.ansible/plugins/modules'</span>, <span class=\"string\">u'/usr/share/ansible/plugins/modules'</span>]</span><br><span class=\"line\">  ansible python module location = /usr/lib/python2<span class=\"number\">.7</span>/site-packages/ansible</span><br><span class=\"line\">  executable location = /usr/bin/ansible</span><br><span class=\"line\">  python version = <span class=\"number\">2.7</span><span class=\"number\">.5</span> (default, Aug  <span class=\"number\">4</span> <span class=\"number\">2017</span>, <span class=\"number\">00</span>:<span class=\"number\">39</span>:<span class=\"number\">18</span>) [GCC <span class=\"number\">4.8</span><span class=\"number\">.5</span> <span class=\"number\">20150623</span> (Red Hat <span class=\"number\">4.8</span><span class=\"number\">.5</span><span class=\"number\">-16</span>)]</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Ansible-Inventory文件\"><a href=\"#Ansible-Inventory文件\" class=\"headerlink\" title=\"Ansible Inventory文件\"></a>Ansible Inventory文件</h2><p><a href=\"http://www.ansible.com.cn/docs/intro_inventory.html\" target=\"_blank\" rel=\"noopener\">Inventory中文文档</a></p>\n<blockquote>\n<p><code>Inventory</code>文件通常用于定义要管理的主机的认证信息，例如<code>ssh</code>登录用户名、密码以及<code>key</code>相关信息。可以同时操作一个组的多台主机，组与主机组之间的关系都是通过<code>inventory</code>文件配置。配置文件路径为：<code>/etc/ansible/hosts</code></p>\n</blockquote>\n<h3 id=\"基于密码连接\"><a href=\"#基于密码连接\" class=\"headerlink\" title=\"基于密码连接\"></a>基于密码连接</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"comment\"># 方法一 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.31 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.32 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.33 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.36 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法二 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.3[1:3] <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法二 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.3[1:3]</span><br><span class=\"line\">[webserver:vars]</span><br><span class=\"line\"><span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"基于秘钥连接\"><a href=\"#基于秘钥连接\" class=\"headerlink\" title=\"基于秘钥连接\"></a>基于秘钥连接</h3><blockquote>\n<p>基于秘钥连接需要先创建公钥和私钥，并发送给被管理机器</p>\n</blockquote>\n<p>1）生成公私钥<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ssh-keygen</span><br><span class=\"line\">[root@ansible ~]# for i in &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">6</span>&#125;; do ssh-copy-id -i <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.3</span>$i ; done</span><br></pre></td></tr></table></figure></p>\n<p>2）配置连接<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"comment\"># 方法一 主机+端口+密钥</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.31:22</span><br><span class=\"line\">192.168.1.32</span><br><span class=\"line\">192.168.1.33</span><br><span class=\"line\">192.168.1.36</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法一 别名主机+端口+密钥</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">node1 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.31 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node2 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.32 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node3 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.33 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node6 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.36 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"主机组的使用\"><a href=\"#主机组的使用\" class=\"headerlink\" title=\"主机组的使用\"></a>主机组的使用</h3><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 主机组变量名+主机+密码</span></span><br><span class=\"line\">[<span class=\"meta\">apache</span>]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.36</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br><span class=\"line\">[<span class=\"meta\">apache.vars</span>]</span><br><span class=\"line\">ansible_ssh_pass=<span class=\"string\">'123456'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 主机组变量名+主机+密钥</span></span><br><span class=\"line\">[<span class=\"meta\">nginx</span>]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.3</span>[<span class=\"number\">1</span>:<span class=\"number\">2</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 定义多个组，把一个组当另外一个组的组员</span></span><br><span class=\"line\">[<span class=\"meta\">webserver:children</span>]  <span class=\"meta\">#webserver组包括两个子组：apache nginx</span></span><br><span class=\"line\">apache</span><br><span class=\"line\">nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"临时指定inventory\"><a href=\"#临时指定inventory\" class=\"headerlink\" title=\"临时指定inventory\"></a>临时指定inventory</h3><p>1）先编辑一个主机定义清单<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/dockers</span><br><span class=\"line\">[dockers]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> ansible_ssh_pass='<span class=\"number\">123456</span>'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br></pre></td></tr></table></figure></p>\n<p>2）在执行命令是指定<code>inventory</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ansible dockers -m<span class=\"built_in\"> ping </span>-i /etc/dockers -o </span><br><span class=\"line\">192.168.1.33 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\">192.168.1.32 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\">192.168.1.31 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Inventory内置参数\"><a href=\"#Inventory内置参数\" class=\"headerlink\" title=\"Inventory内置参数\"></a>Inventory内置参数</h3><p><img src=\"/2019/05/26/Ansible快速入门/ansible01.png\" alt=\"ansible inventory内置参数\"></p>\n<h2 id=\"Ansible-Ad-Hoc\"><a href=\"#Ansible-Ad-Hoc\" class=\"headerlink\" title=\"Ansible Ad-Hoc\"></a>Ansible Ad-Hoc</h2><p><a href=\"http://www.ansible.com.cn/docs/intro_adhoc.html\" target=\"_blank\" rel=\"noopener\">Ad-Hoc中文文档</a></p>\n<blockquote>\n<p>ad hoc —— 临时的，在<code>ansible</code>中是指需要快速执行，并且不需要保存的命令。说白了就是执行简单的命令——一条命令。对于复杂的命令则为<code>playbook</code>，类似于<code>saltstack</code>的<code>state sls</code>状态文件。</p>\n</blockquote>\n<h3 id=\"ansible命令格式\"><a href=\"#ansible命令格式\" class=\"headerlink\" title=\"ansible命令格式\"></a>ansible命令格式</h3><p>1）常用命令参数<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ansible -h</span><br><span class=\"line\">Usage: ansible &lt;host-pattern&gt; [options]</span><br><span class=\"line\">-<span class=\"ruby\">a MODULE_ARGS   <span class=\"comment\">#模块参数</span></span></span><br><span class=\"line\"><span class=\"ruby\">-C, --check  <span class=\"comment\">#检查语法</span></span></span><br><span class=\"line\"><span class=\"ruby\">-f FORKS <span class=\"comment\">#并发</span></span></span><br><span class=\"line\"><span class=\"ruby\">--list-hosts <span class=\"comment\">#列出主机列表</span></span></span><br><span class=\"line\"><span class=\"ruby\">-m MODULE_NAME <span class=\"comment\">#模块名字</span></span></span><br><span class=\"line\"><span class=\"ruby\">-o 使用精简的输出</span></span><br></pre></td></tr></table></figure></p>\n<p>2）示例<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"meta\">@ansible</span> ~]<span class=\"comment\"># ansible webserver -m shell -a 'uptime' -o</span></span><br><span class=\"line\">192.168.1.36 |<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  13:46:14 up 1 day,  9:20,  4 users,  load average: 0.00, 0.00, 0.00</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.33 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:51,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.31 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:50,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.32 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:59,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br></pre></td></tr></table></figure></p>\n<p>3）命令说明<br><img src=\"/2019/05/26/Ansible快速入门/ansible02.png\" alt=\"ansible command\"></p>\n<h3 id=\"host-pattern格式\"><a href=\"#host-pattern格式\" class=\"headerlink\" title=\"host-pattern格式\"></a>host-pattern格式</h3><p>目标<code>target</code>主机，主机组匹配方式</p>\n<h4 id=\"主机的匹配\"><a href=\"#主机的匹配\" class=\"headerlink\" title=\"主机的匹配\"></a>主机的匹配</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  一台目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible 192.168.1.31 -m ping</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 多台目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible 192.168.1.31,192.168.1.32 -m ping</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 所有目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible all -m ping</span><br></pre></td></tr></table></figure>\n<h4 id=\"组的匹配\"><a href=\"#组的匹配\" class=\"headerlink\" title=\"组的匹配\"></a>组的匹配</h4><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 组的配置信息如下：这里定义了一个nginx组和一个apache组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible nginx --list</span></span><br><span class=\"line\">  hosts (<span class=\"number\">2</span>)<span class=\"symbol\">:</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible apache --list</span></span><br><span class=\"line\">  hosts (<span class=\"number\">3</span>)<span class=\"symbol\">:</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.36</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.33</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 一个组的所有主机匹配</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible apache -m ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组中有，但是nginx组中没有的所有主机</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:!nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组和nginx组中都有的机器（并集）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:&amp;nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组nginx组两个组所有的机器（并集）；等于ansible apache,nginx -m ping</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><blockquote>\n<p><code>Ansible</code>是一款简单的运维自动化工具，只需要使用<code>ssh</code>协议连接就可以来进行系统管理，自动化执行命令，部署等任务。</p>\n</blockquote>\n<p><strong>Ansible的特点</strong></p>\n<blockquote>\n<p>1、ansible不需要单独安装客户端，也不需要启动任何服务<br>2、ansible是python中的一套完整的自动化执行任务模块<br>3、ansible playbook 采用yaml配置，对于自动化任务执行过一目了然</p>\n</blockquote>\n<p><strong>Ansible组成结构</strong></p>\n<ul>\n<li>Ansible<br>是<code>Ansible</code>的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。</li>\n<li>Ansible Playbook<br>任务剧本（又称任务集），编排定义<code>Ansible</code>任务集的配置文件，由<code>Ansible</code>顺序依次执行，<code>yaml</code>格式。</li>\n<li>Inventory<br><code>Ansible</code>管理主机的清单，默认是<code>/etc/ansible/hosts</code>文件。</li>\n<li>Modules<br><code>Ansible</code>执行命令的功能模块，<code>Ansible2.3</code>版本为止，共有<code>1039</code>个模块。还可以自定义模块。</li>\n<li>Plugins<br>插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。</li>\n<li>API<br>提供给第三方程序调用的应用程序编程接口。</li>\n</ul>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><table>\n<thead>\n<tr>\n<th style=\"text-align:center\">IP</th>\n<th style=\"text-align:center\">系统</th>\n<th style=\"text-align:center\">主机名</th>\n<th style=\"text-align:center\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">192.168.1.30</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">ansible</td>\n<td style=\"text-align:center\">ansible管理节点</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.31</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node01.com</td>\n<td style=\"text-align:center\">被管理节点1</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.32</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node02.com</td>\n<td style=\"text-align:center\">被管理节点2</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.33</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node03.com</td>\n<td style=\"text-align:center\">被管理节点3</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.36</td>\n<td style=\"text-align:center\">CentOS6</td>\n<td style=\"text-align:center\">linux.node06.com</td>\n<td style=\"text-align:center\">被管理节点6</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Ansible安装\"><a href=\"#Ansible安装\" class=\"headerlink\" title=\"Ansible安装\"></a>Ansible安装</h2><p>1）配置<code>epel</code>源<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># yum clean all</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># yum makecache</span></span><br></pre></td></tr></table></figure></p>\n<p>2）安装<code>ansible</code><br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]<span class=\"comment\"># yum -y install ansible</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看ansible版本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible --version</span></span><br><span class=\"line\">ansible <span class=\"number\">2.8</span><span class=\"number\">.0</span></span><br><span class=\"line\">  config file = /etc/ansible/ansible.cfg</span><br><span class=\"line\">  configured module search path = [<span class=\"string\">u'/root/.ansible/plugins/modules'</span>, <span class=\"string\">u'/usr/share/ansible/plugins/modules'</span>]</span><br><span class=\"line\">  ansible python module location = /usr/lib/python2<span class=\"number\">.7</span>/site-packages/ansible</span><br><span class=\"line\">  executable location = /usr/bin/ansible</span><br><span class=\"line\">  python version = <span class=\"number\">2.7</span><span class=\"number\">.5</span> (default, Aug  <span class=\"number\">4</span> <span class=\"number\">2017</span>, <span class=\"number\">00</span>:<span class=\"number\">39</span>:<span class=\"number\">18</span>) [GCC <span class=\"number\">4.8</span><span class=\"number\">.5</span> <span class=\"number\">20150623</span> (Red Hat <span class=\"number\">4.8</span><span class=\"number\">.5</span><span class=\"number\">-16</span>)]</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Ansible-Inventory文件\"><a href=\"#Ansible-Inventory文件\" class=\"headerlink\" title=\"Ansible Inventory文件\"></a>Ansible Inventory文件</h2><p><a href=\"http://www.ansible.com.cn/docs/intro_inventory.html\" target=\"_blank\" rel=\"noopener\">Inventory中文文档</a></p>\n<blockquote>\n<p><code>Inventory</code>文件通常用于定义要管理的主机的认证信息，例如<code>ssh</code>登录用户名、密码以及<code>key</code>相关信息。可以同时操作一个组的多台主机，组与主机组之间的关系都是通过<code>inventory</code>文件配置。配置文件路径为：<code>/etc/ansible/hosts</code></p>\n</blockquote>\n<h3 id=\"基于密码连接\"><a href=\"#基于密码连接\" class=\"headerlink\" title=\"基于密码连接\"></a>基于密码连接</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"comment\"># 方法一 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.31 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.32 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.33 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.36 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法二 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.3[1:3] <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法二 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.3[1:3]</span><br><span class=\"line\">[webserver:vars]</span><br><span class=\"line\"><span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"基于秘钥连接\"><a href=\"#基于秘钥连接\" class=\"headerlink\" title=\"基于秘钥连接\"></a>基于秘钥连接</h3><blockquote>\n<p>基于秘钥连接需要先创建公钥和私钥，并发送给被管理机器</p>\n</blockquote>\n<p>1）生成公私钥<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ssh-keygen</span><br><span class=\"line\">[root@ansible ~]# for i in &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">6</span>&#125;; do ssh-copy-id -i <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.3</span>$i ; done</span><br></pre></td></tr></table></figure></p>\n<p>2）配置连接<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"comment\"># 方法一 主机+端口+密钥</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.31:22</span><br><span class=\"line\">192.168.1.32</span><br><span class=\"line\">192.168.1.33</span><br><span class=\"line\">192.168.1.36</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法一 别名主机+端口+密钥</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">node1 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.31 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node2 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.32 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node3 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.33 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node6 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.36 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"主机组的使用\"><a href=\"#主机组的使用\" class=\"headerlink\" title=\"主机组的使用\"></a>主机组的使用</h3><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 主机组变量名+主机+密码</span></span><br><span class=\"line\">[<span class=\"meta\">apache</span>]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.36</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br><span class=\"line\">[<span class=\"meta\">apache.vars</span>]</span><br><span class=\"line\">ansible_ssh_pass=<span class=\"string\">'123456'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 主机组变量名+主机+密钥</span></span><br><span class=\"line\">[<span class=\"meta\">nginx</span>]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.3</span>[<span class=\"number\">1</span>:<span class=\"number\">2</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 定义多个组，把一个组当另外一个组的组员</span></span><br><span class=\"line\">[<span class=\"meta\">webserver:children</span>]  <span class=\"meta\">#webserver组包括两个子组：apache nginx</span></span><br><span class=\"line\">apache</span><br><span class=\"line\">nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"临时指定inventory\"><a href=\"#临时指定inventory\" class=\"headerlink\" title=\"临时指定inventory\"></a>临时指定inventory</h3><p>1）先编辑一个主机定义清单<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/dockers</span><br><span class=\"line\">[dockers]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> ansible_ssh_pass='<span class=\"number\">123456</span>'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br></pre></td></tr></table></figure></p>\n<p>2）在执行命令是指定<code>inventory</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ansible dockers -m<span class=\"built_in\"> ping </span>-i /etc/dockers -o </span><br><span class=\"line\">192.168.1.33 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\">192.168.1.32 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\">192.168.1.31 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Inventory内置参数\"><a href=\"#Inventory内置参数\" class=\"headerlink\" title=\"Inventory内置参数\"></a>Inventory内置参数</h3><p><img src=\"/2019/05/26/Ansible快速入门/ansible01.png\" alt=\"ansible inventory内置参数\"></p>\n<h2 id=\"Ansible-Ad-Hoc\"><a href=\"#Ansible-Ad-Hoc\" class=\"headerlink\" title=\"Ansible Ad-Hoc\"></a>Ansible Ad-Hoc</h2><p><a href=\"http://www.ansible.com.cn/docs/intro_adhoc.html\" target=\"_blank\" rel=\"noopener\">Ad-Hoc中文文档</a></p>\n<blockquote>\n<p>ad hoc —— 临时的，在<code>ansible</code>中是指需要快速执行，并且不需要保存的命令。说白了就是执行简单的命令——一条命令。对于复杂的命令则为<code>playbook</code>，类似于<code>saltstack</code>的<code>state sls</code>状态文件。</p>\n</blockquote>\n<h3 id=\"ansible命令格式\"><a href=\"#ansible命令格式\" class=\"headerlink\" title=\"ansible命令格式\"></a>ansible命令格式</h3><p>1）常用命令参数<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ansible -h</span><br><span class=\"line\">Usage: ansible &lt;host-pattern&gt; [options]</span><br><span class=\"line\">-<span class=\"ruby\">a MODULE_ARGS   <span class=\"comment\">#模块参数</span></span></span><br><span class=\"line\"><span class=\"ruby\">-C, --check  <span class=\"comment\">#检查语法</span></span></span><br><span class=\"line\"><span class=\"ruby\">-f FORKS <span class=\"comment\">#并发</span></span></span><br><span class=\"line\"><span class=\"ruby\">--list-hosts <span class=\"comment\">#列出主机列表</span></span></span><br><span class=\"line\"><span class=\"ruby\">-m MODULE_NAME <span class=\"comment\">#模块名字</span></span></span><br><span class=\"line\"><span class=\"ruby\">-o 使用精简的输出</span></span><br></pre></td></tr></table></figure></p>\n<p>2）示例<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"meta\">@ansible</span> ~]<span class=\"comment\"># ansible webserver -m shell -a 'uptime' -o</span></span><br><span class=\"line\">192.168.1.36 |<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  13:46:14 up 1 day,  9:20,  4 users,  load average: 0.00, 0.00, 0.00</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.33 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:51,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.31 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:50,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.32 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:59,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br></pre></td></tr></table></figure></p>\n<p>3）命令说明<br><img src=\"/2019/05/26/Ansible快速入门/ansible02.png\" alt=\"ansible command\"></p>\n<h3 id=\"host-pattern格式\"><a href=\"#host-pattern格式\" class=\"headerlink\" title=\"host-pattern格式\"></a>host-pattern格式</h3><p>目标<code>target</code>主机，主机组匹配方式</p>\n<h4 id=\"主机的匹配\"><a href=\"#主机的匹配\" class=\"headerlink\" title=\"主机的匹配\"></a>主机的匹配</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  一台目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible 192.168.1.31 -m ping</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 多台目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible 192.168.1.31,192.168.1.32 -m ping</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 所有目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible all -m ping</span><br></pre></td></tr></table></figure>\n<h4 id=\"组的匹配\"><a href=\"#组的匹配\" class=\"headerlink\" title=\"组的匹配\"></a>组的匹配</h4><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 组的配置信息如下：这里定义了一个nginx组和一个apache组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible nginx --list</span></span><br><span class=\"line\">  hosts (<span class=\"number\">2</span>)<span class=\"symbol\">:</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible apache --list</span></span><br><span class=\"line\">  hosts (<span class=\"number\">3</span>)<span class=\"symbol\">:</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.36</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.33</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 一个组的所有主机匹配</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible apache -m ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组中有，但是nginx组中没有的所有主机</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:!nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组和nginx组中都有的机器（并集）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:&amp;nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组nginx组两个组所有的机器（并集）；等于ansible apache,nginx -m ping</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br></pre></td></tr></table></figure>\n"},{"title":"Ansible项目实战lnmp","date":"2019-06-05T04:10:22.000Z","copyright":true,"_content":"## 项目规划\n> 通过`ansible roles`配置`lnmp`环境，`nginx`通过源码编译安装，`php`通过源码编译安装，`mysql`通过`yum`安装（`mysql`源码编译超级慢）支持系统（`centos6.x`和`centos7.x`系列）\n\n>**说明:**将nginx和php源码包放到对应的角色文件下的files目录下，通过vars/main.yml控制安装的版本和路径。如下：\n\n```\n[root@ansible roles]# cat nginx/vars/main.yml \nDOWNLOAD_DIR: \"/usr/local/src/\"  #软件包拷贝到目标主机的存放路径\nINSTALL_DIR: \"/usr/local/\"       #安装路径\nNGINX_VERSION: \"1.12.2\"          #软件包版本\nUSER: \"nginx\"                    #运行的用户\nGROUP: \"nginx\"                   #运行的组\n```\n\n[环境配置参考](https://buji595.github.io/2019/05/26/Ansible%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/)\n\n## 角色编写\n> 这里角色都统一放在了`/etc/ansible/roles`下\n\n安装编译时所需要用到的依赖包\n```\n[root@ansible roles]# cat init_pkg.yml \n#安装源码编译php、nginx时所需要用到的依赖包\n---\n- hosts: all \n  remote_user: root\n\n  tasks:\n    - name: Install Package\n      yum: name={{ item }} state=installed\n      with_items:\n        - gcc-c++\n        - glibc\n        - glibc-devel\n        - glib2\n        - glib2-devel\n        - pcre\n        - pcre-devel\n        - zlib\n        - zlib-devel\n        - openssl\n        - openssl-devel\n        - libpng\n        - libpng-devel\n        - freetype\n        - freetype-devel\n        - libxml2\n        - libxml2-devel\n        - bzip2\n        - bzip2-devel\n        - ncurses\n        - curl\n        - gdbm-devel\n        - libXpm-devel\n        - libX11-devel\n        - gd-devel\n        - gmp-devel\n        - readline-devel\n        - libxslt-devel\n        - expat-devel\n        - xmlrpc-c\n        - libcurl-devel\n```\n```\n[root@ansible ~]# cd /etc/ansible/roles/\n```\n### nginx roles\n1）创建相应文件夹\n```\n[root@ansible roles]# mkdir -p nginx/{files,handlers,tasks,templates,vars}\n```\n2）最终编写效果\n```\n[root@ansible roles]# tree nginx\nnginx\n├── files\n│   ├── nginx-1.12.2.tar.gz\n│   └── nginx-1.16.0.tar.gz\n├── handlers\n│   └── main.yml\n├── tasks\n│   ├── config.yml\n│   ├── copypkg.yml\n│   ├── group.yml\n│   ├── install.yml\n│   ├── main.yml\n│   ├── service.yml\n│   └── user.yml\n├── templates\n│   ├── nginx.conf.j2\n│   ├── nginx_init.j2\n│   └── nginx.service.j2\n└── vars\n    └── main.yml\n\n5 directories, 14 files\n```\n\n### php roles\n1）创建相应文件夹\n```\n[root@ansible roles]# mkdir -p php/{files,handlers,tasks,templates,vars}\n```\n2）最终编写效果\n```\n[root@ansible roles]# tree php\nphp\n├── files\n│   └── php-5.6.40.tar.gz\n├── handlers\n│   └── main.yml\n├── tasks\n│   ├── config.yml\n│   ├── copypkg.yml\n│   ├── group.yml\n│   ├── install.yml\n│   ├── main.yml\n│   ├── service.yml\n│   └── user.yml\n├── templates\n│   ├── php-fpm.conf.j2\n│   ├── php-fpm.init.j2\n│   ├── php-fpm.service.j2\n│   └── php.ini.j2\n└── vars\n    └── main.yml\n\n5 directories, 14 files\n```\n\n\n\n\n### mysql roles\n1）创建相应文件夹\n```\n[root@ansible roles]# mkdir -p mysql/{files,handlers,tasks,templates,vars}\n```\n2）最终编写效果\n```\n[root@ansible roles]# tree mysql\nmysql\n├── files\n├── handlers\n│   └── main.yml\n├── tasks\n│   ├── config.yml\n│   ├── install.yml\n│   ├── main.yml\n│   └── service.yml\n├── templates\n│   ├── my.cnf6.j2\n│   └── my.cnf7.j2\n└── vars\n\n5 directories, 7 files\n```\n### 角色执行playbook文件编写\n```\n[root@ansible roles]# cat nginx_roles.yml \n#源码编译安装nginx\n---\n- hosts: all\n  remote_user: root\n  roles:\n    - role: nginx\n\n\n[root@ansible roles]# cat php_roles.yml \n#源码编译安装nginx\n---\n- hosts: all\n  remote_user: root\n  roles:\n    - role: php\n\n\n[root@ansible roles]# cat mysql_roles.yml \n#yum安装MySQL\n---\n- hosts: all\n  remote_user: root\n  roles:\n    - role: mysql \n\n\n[root@ansible roles]# cat lnmp.yml \n#配置lnmp,创建虚拟主机\n---\n- hosts: all\n  remote_user: root\n  roles:\n    - role: nginx\n    - role: php \n    - role: mysql\n  \n  vars:\n    PORT: 8081\n    WEBDIR: \"/opt/www\"\n    CONFIGDIR: \"/usr/local/nginx/conf/conf.d\"\n\n  tasks:\n    - name: create vhost dir\n      file: name={{ WEBDIR }} state=directory owner=www group=www mode=755\n\n    - name: create vhost conf\n      template: src=vhost.conf.j2 dest={{ CONFIGDIR }}/vhost.conf\n      notify: Restart Nginx\n\n    - name: create index.php\n      shell: \"echo '<?php phpinfo(); ?>' > {{ WEBDIR }}/index.php\"\n    \n  handlers:\n    - name: Restart Nginx\n      service: name=nginx state=restarted\n\n\n# hostslist文件准备，这样方便执行，可以在执行playbook时指定某台机器上运行\n[root@ansible roles]# cat hostlist \n192.168.1.31\n192.168.1.32\n192.168.1.33\n192.168.1.36\n\n\n#所有文件查看\n[root@ansible roles]# ll \n总用量 28\n-rw-r--r--. 1 root root  53 6月   4 22:37 hostlist\n-rw-r--r--. 1 root root 824 6月   5 10:53 init_pkg.yml\n-rw-r--r--. 1 root root 646 6月   5 12:05 lnmp.yml\ndrwxr-xr-x. 7 root root  77 6月   5 10:44 mysql\n-rw-r--r--. 1 root root  81 6月   5 10:06 mysql_roles.yml\ndrwxr-xr-x. 7 root root  77 6月   4 15:37 nginx\n-rw-r--r--. 1 root root  89 6月   4 17:10 nginx_roles.yml\ndrwxr-xr-x. 7 root root  77 6月   4 17:18 php\n-rw-r--r--. 1 root root  87 6月   4 17:37 php_roles.yml\n-rw-r--r--. 1 root root 811 6月   5 11:53 vhost.conf.j2\n```\n## 所有文件查看\n\n```\n[root@ansible roles]# tree \n.\n├── hostlist\n├── init_pkg.yml\n├── lnmp.yml\n├── mysql\n│   ├── files\n│   ├── handlers\n│   │   └── main.yml\n│   ├── tasks\n│   │   ├── config.yml\n│   │   ├── install.yml\n│   │   ├── main.yml\n│   │   └── service.yml\n│   ├── templates\n│   │   ├── my.cnf6.j2\n│   │   └── my.cnf7.j2\n│   └── vars\n├── mysql_roles.yml\n├── nginx\n│   ├── files\n│   │   ├── nginx-1.12.2.tar.gz\n│   │   └── nginx-1.16.0.tar.gz\n│   ├── handlers\n│   │   └── main.yml\n│   ├── tasks\n│   │   ├── config.yml\n│   │   ├── copypkg.yml\n│   │   ├── group.yml\n│   │   ├── install.yml\n│   │   ├── main.yml\n│   │   ├── service.yml\n│   │   └── user.yml\n│   ├── templates\n│   │   ├── nginx.conf.j2\n│   │   ├── nginx_init.j2\n│   │   └── nginx.service.j2\n│   └── vars\n│       └── main.yml\n├── nginx_roles.yml\n├── php\n│   ├── files\n│   │   └── php-5.6.40.tar.gz\n│   ├── handlers\n│   │   └── main.yml\n│   ├── tasks\n│   │   ├── config.yml\n│   │   ├── copypkg.yml\n│   │   ├── group.yml\n│   │   ├── install.yml\n│   │   ├── main.yml\n│   │   ├── service.yml\n│   │   └── user.yml\n│   ├── templates\n│   │   ├── php-fpm.conf.j2\n│   │   ├── php-fpm.init.j2\n│   │   ├── php-fpm.service.j2\n│   │   └── php.ini.j2\n│   └── vars\n│       └── main.yml\n├── php_roles.yml\n└── vhost.conf.j2\n\n18 directories, 42 files\n```\n## 执行说明\n1）单独某一台机器安装nginx\n```\n[root@ansible roles]# ansible-playbook -i hostlist nginx_roles.yml --limit 192.168.1.31\n```\n2）单独某一台机器安装php\n```\n[root@ansible roles]# ansible-playbook -i hostlist php_roles.yml --limit 192.168.1.31\n```\n3）单独某一台机器安装mysql\n```\n[root@ansible roles]# ansible-playbook -i hostlist mysql_roles.yml --limit 192.168.1.31\n```\n4）单独某一台机器部署lnmp\n```\n[root@ansible roles]# ansible-playbook -i hostlist lnmp.yml --limit 192.168.1.31\n```\n5）所有机器部署php\n```\n[root@ansible roles]# ansible-playbook php_roles.yml\n```\n6）所有机器部署nginx\n```\n[root@ansible roles]# ansible-playbook nginx_roles.yml\n```\n7）所有机器部署mysql\n```\n[root@ansible roles]# ansible-playbook mysql_roles.yml\n```\n8）所有机器部署lnmp\n```\n[root@ansible roles]# ansible-playbook lnmp.yml\n```\n\n![](Ansible项目实战lnmp/01.png)\n\n\n\n\n\n\n\n\n","source":"_posts/Ansible项目实战lnmp.md","raw":"---\ntitle: Ansible项目实战lnmp\ndate: 2019-06-05 12:10:22\ntags: Ansible\ncategories: Ansible\ncopyright: true\n---\n## 项目规划\n> 通过`ansible roles`配置`lnmp`环境，`nginx`通过源码编译安装，`php`通过源码编译安装，`mysql`通过`yum`安装（`mysql`源码编译超级慢）支持系统（`centos6.x`和`centos7.x`系列）\n\n>**说明:**将nginx和php源码包放到对应的角色文件下的files目录下，通过vars/main.yml控制安装的版本和路径。如下：\n\n```\n[root@ansible roles]# cat nginx/vars/main.yml \nDOWNLOAD_DIR: \"/usr/local/src/\"  #软件包拷贝到目标主机的存放路径\nINSTALL_DIR: \"/usr/local/\"       #安装路径\nNGINX_VERSION: \"1.12.2\"          #软件包版本\nUSER: \"nginx\"                    #运行的用户\nGROUP: \"nginx\"                   #运行的组\n```\n\n[环境配置参考](https://buji595.github.io/2019/05/26/Ansible%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/)\n\n## 角色编写\n> 这里角色都统一放在了`/etc/ansible/roles`下\n\n安装编译时所需要用到的依赖包\n```\n[root@ansible roles]# cat init_pkg.yml \n#安装源码编译php、nginx时所需要用到的依赖包\n---\n- hosts: all \n  remote_user: root\n\n  tasks:\n    - name: Install Package\n      yum: name={{ item }} state=installed\n      with_items:\n        - gcc-c++\n        - glibc\n        - glibc-devel\n        - glib2\n        - glib2-devel\n        - pcre\n        - pcre-devel\n        - zlib\n        - zlib-devel\n        - openssl\n        - openssl-devel\n        - libpng\n        - libpng-devel\n        - freetype\n        - freetype-devel\n        - libxml2\n        - libxml2-devel\n        - bzip2\n        - bzip2-devel\n        - ncurses\n        - curl\n        - gdbm-devel\n        - libXpm-devel\n        - libX11-devel\n        - gd-devel\n        - gmp-devel\n        - readline-devel\n        - libxslt-devel\n        - expat-devel\n        - xmlrpc-c\n        - libcurl-devel\n```\n```\n[root@ansible ~]# cd /etc/ansible/roles/\n```\n### nginx roles\n1）创建相应文件夹\n```\n[root@ansible roles]# mkdir -p nginx/{files,handlers,tasks,templates,vars}\n```\n2）最终编写效果\n```\n[root@ansible roles]# tree nginx\nnginx\n├── files\n│   ├── nginx-1.12.2.tar.gz\n│   └── nginx-1.16.0.tar.gz\n├── handlers\n│   └── main.yml\n├── tasks\n│   ├── config.yml\n│   ├── copypkg.yml\n│   ├── group.yml\n│   ├── install.yml\n│   ├── main.yml\n│   ├── service.yml\n│   └── user.yml\n├── templates\n│   ├── nginx.conf.j2\n│   ├── nginx_init.j2\n│   └── nginx.service.j2\n└── vars\n    └── main.yml\n\n5 directories, 14 files\n```\n\n### php roles\n1）创建相应文件夹\n```\n[root@ansible roles]# mkdir -p php/{files,handlers,tasks,templates,vars}\n```\n2）最终编写效果\n```\n[root@ansible roles]# tree php\nphp\n├── files\n│   └── php-5.6.40.tar.gz\n├── handlers\n│   └── main.yml\n├── tasks\n│   ├── config.yml\n│   ├── copypkg.yml\n│   ├── group.yml\n│   ├── install.yml\n│   ├── main.yml\n│   ├── service.yml\n│   └── user.yml\n├── templates\n│   ├── php-fpm.conf.j2\n│   ├── php-fpm.init.j2\n│   ├── php-fpm.service.j2\n│   └── php.ini.j2\n└── vars\n    └── main.yml\n\n5 directories, 14 files\n```\n\n\n\n\n### mysql roles\n1）创建相应文件夹\n```\n[root@ansible roles]# mkdir -p mysql/{files,handlers,tasks,templates,vars}\n```\n2）最终编写效果\n```\n[root@ansible roles]# tree mysql\nmysql\n├── files\n├── handlers\n│   └── main.yml\n├── tasks\n│   ├── config.yml\n│   ├── install.yml\n│   ├── main.yml\n│   └── service.yml\n├── templates\n│   ├── my.cnf6.j2\n│   └── my.cnf7.j2\n└── vars\n\n5 directories, 7 files\n```\n### 角色执行playbook文件编写\n```\n[root@ansible roles]# cat nginx_roles.yml \n#源码编译安装nginx\n---\n- hosts: all\n  remote_user: root\n  roles:\n    - role: nginx\n\n\n[root@ansible roles]# cat php_roles.yml \n#源码编译安装nginx\n---\n- hosts: all\n  remote_user: root\n  roles:\n    - role: php\n\n\n[root@ansible roles]# cat mysql_roles.yml \n#yum安装MySQL\n---\n- hosts: all\n  remote_user: root\n  roles:\n    - role: mysql \n\n\n[root@ansible roles]# cat lnmp.yml \n#配置lnmp,创建虚拟主机\n---\n- hosts: all\n  remote_user: root\n  roles:\n    - role: nginx\n    - role: php \n    - role: mysql\n  \n  vars:\n    PORT: 8081\n    WEBDIR: \"/opt/www\"\n    CONFIGDIR: \"/usr/local/nginx/conf/conf.d\"\n\n  tasks:\n    - name: create vhost dir\n      file: name={{ WEBDIR }} state=directory owner=www group=www mode=755\n\n    - name: create vhost conf\n      template: src=vhost.conf.j2 dest={{ CONFIGDIR }}/vhost.conf\n      notify: Restart Nginx\n\n    - name: create index.php\n      shell: \"echo '<?php phpinfo(); ?>' > {{ WEBDIR }}/index.php\"\n    \n  handlers:\n    - name: Restart Nginx\n      service: name=nginx state=restarted\n\n\n# hostslist文件准备，这样方便执行，可以在执行playbook时指定某台机器上运行\n[root@ansible roles]# cat hostlist \n192.168.1.31\n192.168.1.32\n192.168.1.33\n192.168.1.36\n\n\n#所有文件查看\n[root@ansible roles]# ll \n总用量 28\n-rw-r--r--. 1 root root  53 6月   4 22:37 hostlist\n-rw-r--r--. 1 root root 824 6月   5 10:53 init_pkg.yml\n-rw-r--r--. 1 root root 646 6月   5 12:05 lnmp.yml\ndrwxr-xr-x. 7 root root  77 6月   5 10:44 mysql\n-rw-r--r--. 1 root root  81 6月   5 10:06 mysql_roles.yml\ndrwxr-xr-x. 7 root root  77 6月   4 15:37 nginx\n-rw-r--r--. 1 root root  89 6月   4 17:10 nginx_roles.yml\ndrwxr-xr-x. 7 root root  77 6月   4 17:18 php\n-rw-r--r--. 1 root root  87 6月   4 17:37 php_roles.yml\n-rw-r--r--. 1 root root 811 6月   5 11:53 vhost.conf.j2\n```\n## 所有文件查看\n\n```\n[root@ansible roles]# tree \n.\n├── hostlist\n├── init_pkg.yml\n├── lnmp.yml\n├── mysql\n│   ├── files\n│   ├── handlers\n│   │   └── main.yml\n│   ├── tasks\n│   │   ├── config.yml\n│   │   ├── install.yml\n│   │   ├── main.yml\n│   │   └── service.yml\n│   ├── templates\n│   │   ├── my.cnf6.j2\n│   │   └── my.cnf7.j2\n│   └── vars\n├── mysql_roles.yml\n├── nginx\n│   ├── files\n│   │   ├── nginx-1.12.2.tar.gz\n│   │   └── nginx-1.16.0.tar.gz\n│   ├── handlers\n│   │   └── main.yml\n│   ├── tasks\n│   │   ├── config.yml\n│   │   ├── copypkg.yml\n│   │   ├── group.yml\n│   │   ├── install.yml\n│   │   ├── main.yml\n│   │   ├── service.yml\n│   │   └── user.yml\n│   ├── templates\n│   │   ├── nginx.conf.j2\n│   │   ├── nginx_init.j2\n│   │   └── nginx.service.j2\n│   └── vars\n│       └── main.yml\n├── nginx_roles.yml\n├── php\n│   ├── files\n│   │   └── php-5.6.40.tar.gz\n│   ├── handlers\n│   │   └── main.yml\n│   ├── tasks\n│   │   ├── config.yml\n│   │   ├── copypkg.yml\n│   │   ├── group.yml\n│   │   ├── install.yml\n│   │   ├── main.yml\n│   │   ├── service.yml\n│   │   └── user.yml\n│   ├── templates\n│   │   ├── php-fpm.conf.j2\n│   │   ├── php-fpm.init.j2\n│   │   ├── php-fpm.service.j2\n│   │   └── php.ini.j2\n│   └── vars\n│       └── main.yml\n├── php_roles.yml\n└── vhost.conf.j2\n\n18 directories, 42 files\n```\n## 执行说明\n1）单独某一台机器安装nginx\n```\n[root@ansible roles]# ansible-playbook -i hostlist nginx_roles.yml --limit 192.168.1.31\n```\n2）单独某一台机器安装php\n```\n[root@ansible roles]# ansible-playbook -i hostlist php_roles.yml --limit 192.168.1.31\n```\n3）单独某一台机器安装mysql\n```\n[root@ansible roles]# ansible-playbook -i hostlist mysql_roles.yml --limit 192.168.1.31\n```\n4）单独某一台机器部署lnmp\n```\n[root@ansible roles]# ansible-playbook -i hostlist lnmp.yml --limit 192.168.1.31\n```\n5）所有机器部署php\n```\n[root@ansible roles]# ansible-playbook php_roles.yml\n```\n6）所有机器部署nginx\n```\n[root@ansible roles]# ansible-playbook nginx_roles.yml\n```\n7）所有机器部署mysql\n```\n[root@ansible roles]# ansible-playbook mysql_roles.yml\n```\n8）所有机器部署lnmp\n```\n[root@ansible roles]# ansible-playbook lnmp.yml\n```\n\n![](Ansible项目实战lnmp/01.png)\n\n\n\n\n\n\n\n\n","slug":"Ansible项目实战lnmp","published":1,"updated":"2019-07-10T01:46:29.906Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjxwlqrlq0019lctch80rsqyt","content":"<h2 id=\"项目规划\"><a href=\"#项目规划\" class=\"headerlink\" title=\"项目规划\"></a>项目规划</h2><blockquote>\n<p>通过<code>ansible roles</code>配置<code>lnmp</code>环境，<code>nginx</code>通过源码编译安装，<code>php</code>通过源码编译安装，<code>mysql</code>通过<code>yum</code>安装（<code>mysql</code>源码编译超级慢）支持系统（<code>centos6.x</code>和<code>centos7.x</code>系列）</p>\n</blockquote>\n<blockquote>\n<p><strong>说明:</strong>将nginx和php源码包放到对应的角色文件下的files目录下，通过vars/main.yml控制安装的版本和路径。如下：</p>\n</blockquote>\n<figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible roles]<span class=\"meta\"># cat nginx/vars/main.yml </span></span><br><span class=\"line\"><span class=\"symbol\">DOWNLOAD_DIR:</span> <span class=\"string\">\"/usr/local/src/\"</span>  <span class=\"meta\">#软件包拷贝到目标主机的存放路径</span></span><br><span class=\"line\"><span class=\"symbol\">INSTALL_DIR:</span> <span class=\"string\">\"/usr/local/\"</span>       <span class=\"meta\">#安装路径</span></span><br><span class=\"line\"><span class=\"symbol\">NGINX_VERSION:</span> <span class=\"string\">\"1.12.2\"</span>          <span class=\"meta\">#软件包版本</span></span><br><span class=\"line\"><span class=\"symbol\">USER:</span> <span class=\"string\">\"nginx\"</span>                    <span class=\"meta\">#运行的用户</span></span><br><span class=\"line\"><span class=\"symbol\">GROUP:</span> <span class=\"string\">\"nginx\"</span>                   <span class=\"meta\">#运行的组</span></span><br></pre></td></tr></table></figure>\n<p><a href=\"https://buji595.github.io/2019/05/26/Ansible%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/\" target=\"_blank\" rel=\"noopener\">环境配置参考</a></p>\n<h2 id=\"角色编写\"><a href=\"#角色编写\" class=\"headerlink\" title=\"角色编写\"></a>角色编写</h2><blockquote>\n<p>这里角色都统一放在了<code>/etc/ansible/roles</code>下</p>\n</blockquote>\n<p>安装编译时所需要用到的依赖包<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible roles]# cat init_pkg.yml </span><br><span class=\"line\">#安装源码编译php、nginx时所需要用到的依赖包</span><br><span class=\"line\">-<span class=\"ruby\">--</span></span><br><span class=\"line\"><span class=\"ruby\">- <span class=\"symbol\">hosts:</span> all </span></span><br><span class=\"line\"><span class=\"ruby\">  <span class=\"symbol\">remote_user:</span> root</span></span><br><span class=\"line\"><span class=\"ruby\"></span></span><br><span class=\"line\"><span class=\"ruby\">  <span class=\"symbol\">tasks:</span></span></span><br><span class=\"line\"><span class=\"ruby\">    - <span class=\"symbol\">name:</span> Install Package</span></span><br><span class=\"line\"><span class=\"ruby\">      <span class=\"symbol\">yum:</span> name=&#123;&#123; item &#125;&#125; state=installed</span></span><br><span class=\"line\"><span class=\"ruby\">      <span class=\"symbol\">with_items:</span></span></span><br><span class=\"line\"><span class=\"ruby\">        - gcc-c++</span></span><br><span class=\"line\"><span class=\"ruby\">        - glibc</span></span><br><span class=\"line\"><span class=\"ruby\">        - glibc-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - glib2</span></span><br><span class=\"line\"><span class=\"ruby\">        - glib2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - pcre</span></span><br><span class=\"line\"><span class=\"ruby\">        - pcre-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - zlib</span></span><br><span class=\"line\"><span class=\"ruby\">        - zlib-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - openssl</span></span><br><span class=\"line\"><span class=\"ruby\">        - openssl-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - libpng</span></span><br><span class=\"line\"><span class=\"ruby\">        - libpng-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - freetype</span></span><br><span class=\"line\"><span class=\"ruby\">        - freetype-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - libxml2</span></span><br><span class=\"line\"><span class=\"ruby\">        - libxml2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - bzip2</span></span><br><span class=\"line\"><span class=\"ruby\">        - bzip2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - ncurses</span></span><br><span class=\"line\"><span class=\"ruby\">        - curl</span></span><br><span class=\"line\"><span class=\"ruby\">        - gdbm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - libXpm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - libX11-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - gd-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - gmp-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - readline-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - libxslt-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - expat-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - xmlrpc-c</span></span><br><span class=\"line\"><span class=\"ruby\">        - libcurl-devel</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># cd /etc/ansible/roles/</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"nginx-roles\"><a href=\"#nginx-roles\" class=\"headerlink\" title=\"nginx roles\"></a>nginx roles</h3><p>1）创建相应文件夹<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># mkdir -p nginx/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>2）最终编写效果<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">tree</span> <span class=\"selector-tag\">nginx</span></span><br><span class=\"line\"><span class=\"selector-tag\">nginx</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">nginx-1</span><span class=\"selector-class\">.12</span><span class=\"selector-class\">.2</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">nginx-1</span><span class=\"selector-class\">.16</span><span class=\"selector-class\">.0</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">copypkg</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">group</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">user</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">nginx</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">nginx_init</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">nginx</span><span class=\"selector-class\">.service</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">    └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\">5 <span class=\"selector-tag\">directories</span>, 14 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"php-roles\"><a href=\"#php-roles\" class=\"headerlink\" title=\"php roles\"></a>php roles</h3><p>1）创建相应文件夹<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># mkdir -p php/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>2）最终编写效果<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">tree</span> <span class=\"selector-tag\">php</span></span><br><span class=\"line\"><span class=\"selector-tag\">php</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">php-5</span><span class=\"selector-class\">.6</span><span class=\"selector-class\">.40</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">copypkg</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">group</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">user</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.init</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.service</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">php</span><span class=\"selector-class\">.ini</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">    └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\">5 <span class=\"selector-tag\">directories</span>, 14 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"mysql-roles\"><a href=\"#mysql-roles\" class=\"headerlink\" title=\"mysql roles\"></a>mysql roles</h3><p>1）创建相应文件夹<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># mkdir -p mysql/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>2）最终编写效果<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">tree</span> <span class=\"selector-tag\">mysql</span></span><br><span class=\"line\"><span class=\"selector-tag\">mysql</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">my</span><span class=\"selector-class\">.cnf6</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">my</span><span class=\"selector-class\">.cnf7</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\"></span><br><span class=\"line\">5 <span class=\"selector-tag\">directories</span>, 7 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"角色执行playbook文件编写\"><a href=\"#角色执行playbook文件编写\" class=\"headerlink\" title=\"角色执行playbook文件编写\"></a>角色执行playbook文件编写</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">cat</span> <span class=\"string\">nginx_roles.yml</span> </span><br><span class=\"line\"><span class=\"comment\">#源码编译安装nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  roles:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">cat</span> <span class=\"string\">php_roles.yml</span> </span><br><span class=\"line\"><span class=\"comment\">#源码编译安装nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  roles:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">php</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">cat</span> <span class=\"string\">mysql_roles.yml</span> </span><br><span class=\"line\"><span class=\"comment\">#yum安装MySQL</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  roles:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">mysql</span> </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">cat</span> <span class=\"string\">lnmp.yml</span> </span><br><span class=\"line\"><span class=\"comment\">#配置lnmp,创建虚拟主机</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  roles:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">php</span> </span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    PORT:</span> <span class=\"number\">8081</span></span><br><span class=\"line\"><span class=\"attr\">    WEBDIR:</span> <span class=\"string\">\"/opt/www\"</span></span><br><span class=\"line\"><span class=\"attr\">    CONFIGDIR:</span> <span class=\"string\">\"/usr/local/nginx/conf/conf.d\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">vhost</span> <span class=\"string\">dir</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">WEBDIR</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=directory</span> <span class=\"string\">owner=www</span> <span class=\"string\">group=www</span> <span class=\"string\">mode=755</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">vhost</span> <span class=\"string\">conf</span></span><br><span class=\"line\"><span class=\"attr\">      template:</span> <span class=\"string\">src=vhost.conf.j2</span> <span class=\"string\">dest=&#123;&#123;</span> <span class=\"string\">CONFIGDIR</span> <span class=\"string\">&#125;&#125;/vhost.conf</span></span><br><span class=\"line\"><span class=\"attr\">      notify:</span> <span class=\"string\">Restart</span> <span class=\"string\">Nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">index.php</span></span><br><span class=\"line\"><span class=\"attr\">      shell:</span> <span class=\"string\">\"echo '&lt;?php phpinfo(); ?&gt;' &gt; <span class=\"template-variable\">&#123;&#123; WEBDIR &#125;&#125;</span>/index.php\"</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"attr\">  handlers:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Restart</span> <span class=\"string\">Nginx</span></span><br><span class=\"line\"><span class=\"attr\">      service:</span> <span class=\"string\">name=nginx</span> <span class=\"string\">state=restarted</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># hostslist文件准备，这样方便执行，可以在执行playbook时指定某台机器上运行</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">cat</span> <span class=\"string\">hostlist</span> </span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.36</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#所有文件查看</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">ll</span> </span><br><span class=\"line\"><span class=\"string\">总用量</span> <span class=\"number\">28</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">53</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">4</span> <span class=\"number\">22</span><span class=\"string\">:37</span> <span class=\"string\">hostlist</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span> <span class=\"number\">824</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">5</span> <span class=\"number\">10</span><span class=\"string\">:53</span> <span class=\"string\">init_pkg.yml</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span> <span class=\"number\">646</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">5</span> <span class=\"number\">12</span><span class=\"string\">:05</span> <span class=\"string\">lnmp.yml</span></span><br><span class=\"line\"><span class=\"string\">drwxr-xr-x.</span> <span class=\"number\">7</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">77</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">5</span> <span class=\"number\">10</span><span class=\"string\">:44</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">81</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">5</span> <span class=\"number\">10</span><span class=\"string\">:06</span> <span class=\"string\">mysql_roles.yml</span></span><br><span class=\"line\"><span class=\"string\">drwxr-xr-x.</span> <span class=\"number\">7</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">77</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">4</span> <span class=\"number\">15</span><span class=\"string\">:37</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">89</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">4</span> <span class=\"number\">17</span><span class=\"string\">:10</span> <span class=\"string\">nginx_roles.yml</span></span><br><span class=\"line\"><span class=\"string\">drwxr-xr-x.</span> <span class=\"number\">7</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">77</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">4</span> <span class=\"number\">17</span><span class=\"string\">:18</span> <span class=\"string\">php</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">87</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">4</span> <span class=\"number\">17</span><span class=\"string\">:37</span> <span class=\"string\">php_roles.yml</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span> <span class=\"number\">811</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">5</span> <span class=\"number\">11</span><span class=\"string\">:53</span> <span class=\"string\">vhost.conf.j2</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"所有文件查看\"><a href=\"#所有文件查看\" class=\"headerlink\" title=\"所有文件查看\"></a>所有文件查看</h2><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">tree</span> </span><br><span class=\"line\">.</span><br><span class=\"line\">├── <span class=\"selector-tag\">hostlist</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">init_pkg</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">lnmp</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">mysql</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">my</span><span class=\"selector-class\">.cnf6</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">my</span><span class=\"selector-class\">.cnf7</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">mysql_roles</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">nginx</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">nginx-1</span><span class=\"selector-class\">.12</span><span class=\"selector-class\">.2</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">nginx-1</span><span class=\"selector-class\">.16</span><span class=\"selector-class\">.0</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">copypkg</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">group</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">user</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">nginx</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">nginx_init</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">nginx</span><span class=\"selector-class\">.service</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">│       └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">nginx_roles</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">php</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">php-5</span><span class=\"selector-class\">.6</span><span class=\"selector-class\">.40</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">copypkg</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">group</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">user</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.init</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.service</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">php</span><span class=\"selector-class\">.ini</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">│       └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">php_roles</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">vhost</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\"></span><br><span class=\"line\">18 <span class=\"selector-tag\">directories</span>, 42 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"执行说明\"><a href=\"#执行说明\" class=\"headerlink\" title=\"执行说明\"></a>执行说明</h2><p>1）单独某一台机器安装nginx<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">ansible-playbook</span> <span class=\"selector-tag\">-i</span> <span class=\"selector-tag\">hostlist</span> <span class=\"selector-tag\">nginx_roles</span><span class=\"selector-class\">.yml</span> <span class=\"selector-tag\">--limit</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.31</span></span><br></pre></td></tr></table></figure></p>\n<p>2）单独某一台机器安装php<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">ansible-playbook</span> <span class=\"selector-tag\">-i</span> <span class=\"selector-tag\">hostlist</span> <span class=\"selector-tag\">php_roles</span><span class=\"selector-class\">.yml</span> <span class=\"selector-tag\">--limit</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.31</span></span><br></pre></td></tr></table></figure></p>\n<p>3）单独某一台机器安装mysql<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">ansible-playbook</span> <span class=\"selector-tag\">-i</span> <span class=\"selector-tag\">hostlist</span> <span class=\"selector-tag\">mysql_roles</span><span class=\"selector-class\">.yml</span> <span class=\"selector-tag\">--limit</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.31</span></span><br></pre></td></tr></table></figure></p>\n<p>4）单独某一台机器部署lnmp<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">ansible-playbook</span> <span class=\"selector-tag\">-i</span> <span class=\"selector-tag\">hostlist</span> <span class=\"selector-tag\">lnmp</span><span class=\"selector-class\">.yml</span> <span class=\"selector-tag\">--limit</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.31</span></span><br></pre></td></tr></table></figure></p>\n<p>5）所有机器部署php<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># ansible-playbook php_roles.yml</span></span><br></pre></td></tr></table></figure></p>\n<p>6）所有机器部署nginx<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># ansible-playbook nginx_roles.yml</span></span><br></pre></td></tr></table></figure></p>\n<p>7）所有机器部署mysql<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># ansible-playbook mysql_roles.yml</span></span><br></pre></td></tr></table></figure></p>\n<p>8）所有机器部署lnmp<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># ansible-playbook lnmp.yml</span></span><br></pre></td></tr></table></figure></p>\n<p><img src=\"/2019/06/05/Ansible项目实战lnmp/01.png\" alt></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"项目规划\"><a href=\"#项目规划\" class=\"headerlink\" title=\"项目规划\"></a>项目规划</h2><blockquote>\n<p>通过<code>ansible roles</code>配置<code>lnmp</code>环境，<code>nginx</code>通过源码编译安装，<code>php</code>通过源码编译安装，<code>mysql</code>通过<code>yum</code>安装（<code>mysql</code>源码编译超级慢）支持系统（<code>centos6.x</code>和<code>centos7.x</code>系列）</p>\n</blockquote>\n<blockquote>\n<p><strong>说明:</strong>将nginx和php源码包放到对应的角色文件下的files目录下，通过vars/main.yml控制安装的版本和路径。如下：</p>\n</blockquote>\n<figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible roles]<span class=\"meta\"># cat nginx/vars/main.yml </span></span><br><span class=\"line\"><span class=\"symbol\">DOWNLOAD_DIR:</span> <span class=\"string\">\"/usr/local/src/\"</span>  <span class=\"meta\">#软件包拷贝到目标主机的存放路径</span></span><br><span class=\"line\"><span class=\"symbol\">INSTALL_DIR:</span> <span class=\"string\">\"/usr/local/\"</span>       <span class=\"meta\">#安装路径</span></span><br><span class=\"line\"><span class=\"symbol\">NGINX_VERSION:</span> <span class=\"string\">\"1.12.2\"</span>          <span class=\"meta\">#软件包版本</span></span><br><span class=\"line\"><span class=\"symbol\">USER:</span> <span class=\"string\">\"nginx\"</span>                    <span class=\"meta\">#运行的用户</span></span><br><span class=\"line\"><span class=\"symbol\">GROUP:</span> <span class=\"string\">\"nginx\"</span>                   <span class=\"meta\">#运行的组</span></span><br></pre></td></tr></table></figure>\n<p><a href=\"https://buji595.github.io/2019/05/26/Ansible%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/\" target=\"_blank\" rel=\"noopener\">环境配置参考</a></p>\n<h2 id=\"角色编写\"><a href=\"#角色编写\" class=\"headerlink\" title=\"角色编写\"></a>角色编写</h2><blockquote>\n<p>这里角色都统一放在了<code>/etc/ansible/roles</code>下</p>\n</blockquote>\n<p>安装编译时所需要用到的依赖包<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible roles]# cat init_pkg.yml </span><br><span class=\"line\">#安装源码编译php、nginx时所需要用到的依赖包</span><br><span class=\"line\">-<span class=\"ruby\">--</span></span><br><span class=\"line\"><span class=\"ruby\">- <span class=\"symbol\">hosts:</span> all </span></span><br><span class=\"line\"><span class=\"ruby\">  <span class=\"symbol\">remote_user:</span> root</span></span><br><span class=\"line\"><span class=\"ruby\"></span></span><br><span class=\"line\"><span class=\"ruby\">  <span class=\"symbol\">tasks:</span></span></span><br><span class=\"line\"><span class=\"ruby\">    - <span class=\"symbol\">name:</span> Install Package</span></span><br><span class=\"line\"><span class=\"ruby\">      <span class=\"symbol\">yum:</span> name=&#123;&#123; item &#125;&#125; state=installed</span></span><br><span class=\"line\"><span class=\"ruby\">      <span class=\"symbol\">with_items:</span></span></span><br><span class=\"line\"><span class=\"ruby\">        - gcc-c++</span></span><br><span class=\"line\"><span class=\"ruby\">        - glibc</span></span><br><span class=\"line\"><span class=\"ruby\">        - glibc-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - glib2</span></span><br><span class=\"line\"><span class=\"ruby\">        - glib2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - pcre</span></span><br><span class=\"line\"><span class=\"ruby\">        - pcre-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - zlib</span></span><br><span class=\"line\"><span class=\"ruby\">        - zlib-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - openssl</span></span><br><span class=\"line\"><span class=\"ruby\">        - openssl-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - libpng</span></span><br><span class=\"line\"><span class=\"ruby\">        - libpng-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - freetype</span></span><br><span class=\"line\"><span class=\"ruby\">        - freetype-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - libxml2</span></span><br><span class=\"line\"><span class=\"ruby\">        - libxml2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - bzip2</span></span><br><span class=\"line\"><span class=\"ruby\">        - bzip2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - ncurses</span></span><br><span class=\"line\"><span class=\"ruby\">        - curl</span></span><br><span class=\"line\"><span class=\"ruby\">        - gdbm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - libXpm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - libX11-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - gd-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - gmp-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - readline-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - libxslt-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - expat-devel</span></span><br><span class=\"line\"><span class=\"ruby\">        - xmlrpc-c</span></span><br><span class=\"line\"><span class=\"ruby\">        - libcurl-devel</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># cd /etc/ansible/roles/</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"nginx-roles\"><a href=\"#nginx-roles\" class=\"headerlink\" title=\"nginx roles\"></a>nginx roles</h3><p>1）创建相应文件夹<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># mkdir -p nginx/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>2）最终编写效果<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">tree</span> <span class=\"selector-tag\">nginx</span></span><br><span class=\"line\"><span class=\"selector-tag\">nginx</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">nginx-1</span><span class=\"selector-class\">.12</span><span class=\"selector-class\">.2</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">nginx-1</span><span class=\"selector-class\">.16</span><span class=\"selector-class\">.0</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">copypkg</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">group</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">user</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">nginx</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">nginx_init</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">nginx</span><span class=\"selector-class\">.service</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">    └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\">5 <span class=\"selector-tag\">directories</span>, 14 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"php-roles\"><a href=\"#php-roles\" class=\"headerlink\" title=\"php roles\"></a>php roles</h3><p>1）创建相应文件夹<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># mkdir -p php/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>2）最终编写效果<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">tree</span> <span class=\"selector-tag\">php</span></span><br><span class=\"line\"><span class=\"selector-tag\">php</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">php-5</span><span class=\"selector-class\">.6</span><span class=\"selector-class\">.40</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">copypkg</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">group</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">user</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.init</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.service</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">php</span><span class=\"selector-class\">.ini</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">    └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\">5 <span class=\"selector-tag\">directories</span>, 14 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"mysql-roles\"><a href=\"#mysql-roles\" class=\"headerlink\" title=\"mysql roles\"></a>mysql roles</h3><p>1）创建相应文件夹<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># mkdir -p mysql/&#123;files,handlers,tasks,templates,vars&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>2）最终编写效果<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">tree</span> <span class=\"selector-tag\">mysql</span></span><br><span class=\"line\"><span class=\"selector-tag\">mysql</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">my</span><span class=\"selector-class\">.cnf6</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">my</span><span class=\"selector-class\">.cnf7</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\"></span><br><span class=\"line\">5 <span class=\"selector-tag\">directories</span>, 7 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"角色执行playbook文件编写\"><a href=\"#角色执行playbook文件编写\" class=\"headerlink\" title=\"角色执行playbook文件编写\"></a>角色执行playbook文件编写</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">cat</span> <span class=\"string\">nginx_roles.yml</span> </span><br><span class=\"line\"><span class=\"comment\">#源码编译安装nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  roles:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">cat</span> <span class=\"string\">php_roles.yml</span> </span><br><span class=\"line\"><span class=\"comment\">#源码编译安装nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  roles:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">php</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">cat</span> <span class=\"string\">mysql_roles.yml</span> </span><br><span class=\"line\"><span class=\"comment\">#yum安装MySQL</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  roles:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">mysql</span> </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">cat</span> <span class=\"string\">lnmp.yml</span> </span><br><span class=\"line\"><span class=\"comment\">#配置lnmp,创建虚拟主机</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  roles:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">php</span> </span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    PORT:</span> <span class=\"number\">8081</span></span><br><span class=\"line\"><span class=\"attr\">    WEBDIR:</span> <span class=\"string\">\"/opt/www\"</span></span><br><span class=\"line\"><span class=\"attr\">    CONFIGDIR:</span> <span class=\"string\">\"/usr/local/nginx/conf/conf.d\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">vhost</span> <span class=\"string\">dir</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">WEBDIR</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=directory</span> <span class=\"string\">owner=www</span> <span class=\"string\">group=www</span> <span class=\"string\">mode=755</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">vhost</span> <span class=\"string\">conf</span></span><br><span class=\"line\"><span class=\"attr\">      template:</span> <span class=\"string\">src=vhost.conf.j2</span> <span class=\"string\">dest=&#123;&#123;</span> <span class=\"string\">CONFIGDIR</span> <span class=\"string\">&#125;&#125;/vhost.conf</span></span><br><span class=\"line\"><span class=\"attr\">      notify:</span> <span class=\"string\">Restart</span> <span class=\"string\">Nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">index.php</span></span><br><span class=\"line\"><span class=\"attr\">      shell:</span> <span class=\"string\">\"echo '&lt;?php phpinfo(); ?&gt;' &gt; <span class=\"template-variable\">&#123;&#123; WEBDIR &#125;&#125;</span>/index.php\"</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"attr\">  handlers:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Restart</span> <span class=\"string\">Nginx</span></span><br><span class=\"line\"><span class=\"attr\">      service:</span> <span class=\"string\">name=nginx</span> <span class=\"string\">state=restarted</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># hostslist文件准备，这样方便执行，可以在执行playbook时指定某台机器上运行</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">cat</span> <span class=\"string\">hostlist</span> </span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.36</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#所有文件查看</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">roles]#</span> <span class=\"string\">ll</span> </span><br><span class=\"line\"><span class=\"string\">总用量</span> <span class=\"number\">28</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">53</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">4</span> <span class=\"number\">22</span><span class=\"string\">:37</span> <span class=\"string\">hostlist</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span> <span class=\"number\">824</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">5</span> <span class=\"number\">10</span><span class=\"string\">:53</span> <span class=\"string\">init_pkg.yml</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span> <span class=\"number\">646</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">5</span> <span class=\"number\">12</span><span class=\"string\">:05</span> <span class=\"string\">lnmp.yml</span></span><br><span class=\"line\"><span class=\"string\">drwxr-xr-x.</span> <span class=\"number\">7</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">77</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">5</span> <span class=\"number\">10</span><span class=\"string\">:44</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">81</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">5</span> <span class=\"number\">10</span><span class=\"string\">:06</span> <span class=\"string\">mysql_roles.yml</span></span><br><span class=\"line\"><span class=\"string\">drwxr-xr-x.</span> <span class=\"number\">7</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">77</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">4</span> <span class=\"number\">15</span><span class=\"string\">:37</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">89</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">4</span> <span class=\"number\">17</span><span class=\"string\">:10</span> <span class=\"string\">nginx_roles.yml</span></span><br><span class=\"line\"><span class=\"string\">drwxr-xr-x.</span> <span class=\"number\">7</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">77</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">4</span> <span class=\"number\">17</span><span class=\"string\">:18</span> <span class=\"string\">php</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span>  <span class=\"number\">87</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">4</span> <span class=\"number\">17</span><span class=\"string\">:37</span> <span class=\"string\">php_roles.yml</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">rw-r--r--.</span> <span class=\"number\">1</span> <span class=\"string\">root</span> <span class=\"string\">root</span> <span class=\"number\">811</span> <span class=\"number\">6</span><span class=\"string\">月</span>   <span class=\"number\">5</span> <span class=\"number\">11</span><span class=\"string\">:53</span> <span class=\"string\">vhost.conf.j2</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"所有文件查看\"><a href=\"#所有文件查看\" class=\"headerlink\" title=\"所有文件查看\"></a>所有文件查看</h2><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">tree</span> </span><br><span class=\"line\">.</span><br><span class=\"line\">├── <span class=\"selector-tag\">hostlist</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">init_pkg</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">lnmp</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">mysql</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">my</span><span class=\"selector-class\">.cnf6</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">my</span><span class=\"selector-class\">.cnf7</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">mysql_roles</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">nginx</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">nginx-1</span><span class=\"selector-class\">.12</span><span class=\"selector-class\">.2</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">nginx-1</span><span class=\"selector-class\">.16</span><span class=\"selector-class\">.0</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">copypkg</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">group</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">user</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">nginx</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">nginx_init</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">nginx</span><span class=\"selector-class\">.service</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">│       └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">nginx_roles</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">php</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">files</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">php-5</span><span class=\"selector-class\">.6</span><span class=\"selector-class\">.40</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">handlers</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">tasks</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">config</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">copypkg</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">group</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">install</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">service</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">user</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">│   ├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.init</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   ├── <span class=\"selector-tag\">php-fpm</span><span class=\"selector-class\">.service</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   │   └── <span class=\"selector-tag\">php</span><span class=\"selector-class\">.ini</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">vars</span></span><br><span class=\"line\">│       └── <span class=\"selector-tag\">main</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">├── <span class=\"selector-tag\">php_roles</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">vhost</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\"></span><br><span class=\"line\">18 <span class=\"selector-tag\">directories</span>, 42 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"执行说明\"><a href=\"#执行说明\" class=\"headerlink\" title=\"执行说明\"></a>执行说明</h2><p>1）单独某一台机器安装nginx<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">ansible-playbook</span> <span class=\"selector-tag\">-i</span> <span class=\"selector-tag\">hostlist</span> <span class=\"selector-tag\">nginx_roles</span><span class=\"selector-class\">.yml</span> <span class=\"selector-tag\">--limit</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.31</span></span><br></pre></td></tr></table></figure></p>\n<p>2）单独某一台机器安装php<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">ansible-playbook</span> <span class=\"selector-tag\">-i</span> <span class=\"selector-tag\">hostlist</span> <span class=\"selector-tag\">php_roles</span><span class=\"selector-class\">.yml</span> <span class=\"selector-tag\">--limit</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.31</span></span><br></pre></td></tr></table></figure></p>\n<p>3）单独某一台机器安装mysql<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">ansible-playbook</span> <span class=\"selector-tag\">-i</span> <span class=\"selector-tag\">hostlist</span> <span class=\"selector-tag\">mysql_roles</span><span class=\"selector-class\">.yml</span> <span class=\"selector-tag\">--limit</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.31</span></span><br></pre></td></tr></table></figure></p>\n<p>4）单独某一台机器部署lnmp<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@ansible roles]</span># <span class=\"selector-tag\">ansible-playbook</span> <span class=\"selector-tag\">-i</span> <span class=\"selector-tag\">hostlist</span> <span class=\"selector-tag\">lnmp</span><span class=\"selector-class\">.yml</span> <span class=\"selector-tag\">--limit</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.31</span></span><br></pre></td></tr></table></figure></p>\n<p>5）所有机器部署php<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># ansible-playbook php_roles.yml</span></span><br></pre></td></tr></table></figure></p>\n<p>6）所有机器部署nginx<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># ansible-playbook nginx_roles.yml</span></span><br></pre></td></tr></table></figure></p>\n<p>7）所有机器部署mysql<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># ansible-playbook mysql_roles.yml</span></span><br></pre></td></tr></table></figure></p>\n<p>8）所有机器部署lnmp<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> roles]<span class=\"meta\"># ansible-playbook lnmp.yml</span></span><br></pre></td></tr></table></figure></p>\n<p><img src=\"/2019/06/05/Ansible项目实战lnmp/01.png\" alt></p>\n"},{"title":"Tomcat+Nginx+Memcached综合案例","date":"2019-06-27T09:36:22.000Z","copyright":true,"_content":"\n## 说明\n>通过`Nginx`解析静态页面并将动态负载均衡调度给后面的多个`Tomcat`，`Tomcat`解析`java`动态程序。\n\n>由于http是无状态的协议，你访问了页面A，然后在访问B，http无法确定这2个访问来自一个人\n>，因此要用cookie或session来跟踪用户，根据授权和用户身份来显示不同的页面。\n>比如用户A登陆了，那么能看到自己的个人信息，而B没登陆，无法看到个人信息。\n>还有A可能在购物，把商品放入购物车，此时B也有这个过程，你无法确定A，B的身份和购物信息，所以需要一个session ID来维持这个过程。所以就用到了session管理。\n\n[官网文档](https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration)\n\n## 环境规划\n| 主机         | hostname              | 环境                 |      |\n| ------------ | --------------------- | -------------------- | ---- |\n| 192.168.1.31 | nginx.cluster.com     | nginx（yum安装）     |      |\n| 192.168.1.32 | tomcat1.cluster.com   | tomcat-9.0           |      |\n| 192.168.1.33 | tomcat2.cluster.com   | tomcat-9.0           |      |\n| 192.168.1.34 | memcached.cluster.com | memcached（yum安装） |      |\n\n>关闭防火墙，selinux；时间同步；host绑定等基本配置 (步骤略)\n\n## 具体步骤\n本案例所使用的`tomcat`、`jdk`、和`tomcat-session`相关的jar包下载地址\n链接：https://pan.baidu.com/s/1ESm_RSrFx77kWObmCt1DQw \n提取码：f64n \n\n### memcached部署\n>说明：memcached这里不需要配置太多，安装即可，然后检查端口是否处于监听中。tomcat服务器能成功连接即可\n```\n[root@memcached ~]# yum -y install memcached\n[root@memcached ~]# systemctl enable memcached\n[root@memcached ~]# systemctl start memcached\n\n[root@memcached ~]# lsof -i:11211\nCOMMAND    PID      USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nmemcached 4419 memcached   26u  IPv4  51021      0t0  TCP *:memcache (LISTEN)\nmemcached 4419 memcached   27u  IPv6  51022      0t0  TCP *:memcache (LISTEN)\nmemcached 4419 memcached   28u  IPv4  51025      0t0  UDP *:memcache \nmemcached 4419 memcached   29u  IPv6  51026      0t0  UDP *:memcache\n```\n\n### nginx部署\n1）安装nginx\n```\n[root@nginx ~]# yum -y install nginx\n[root@nginx ~]# nginx -v\nnginx version: nginx/1.12.2\n```\n2）配置文件配置\n```\n# 创建一个虚拟主机\n[root@nginx ~]# vim /etc/nginx/conf.d/www.conf\nupstream tomcat {\n    server 192.168.1.32:8080 weight=1;\n    server 192.168.1.33:8080 weight=1;\n}\n\nserver {\n    listen       88 default_server;\n    server_name  localhost;\n    root         /opt/project;\n\n#已jsp结尾的动态程序调度给tomcat去处理\n    location ~.*\\.jsp$ {\n        proxy_pass http://tomcat;\n        proxy_set_header Host $host;\n        proxy_set_header X-Forwarded-For $remote_addr;\n    }\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n}\n\n\n# 创建测试文件\n[root@nginx ~]# mkdir /opt/project\n[root@nginx ~]# echo \"<h1>Nginx IP:192.168.1.31</h1>\" >> /opt/project/index.html\n```\n\n### tomcat部署\n详细安装参考：https://www.cnblogs.com/yanjieli/p/11092350.html\n**两台tomcat服务器都要执行下面的所有操作，也可以在一台上面执行，然后copy过去。**\n1）上传软件包到服务器，编写一个临时使用的安装脚本\n```\n[root@tomcat1 ~]# cat install_tomcat.sh \n#!/bin/bash\n\n#----安装java环境\nfunction InstallJava (){\n    tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/\n    ln -s /usr/local/jdk1.8.0_211 /usr/local/java\n    sed -i.ori '$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile\n    source /etc/profile\n    java -version\n}\n\n#----安装tomcat环境\nfunction InstallTomcat (){\n    tar xf apache-tomcat-9.0.21.tar.gz -C /usr/local/\n    ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat\n    echo \"export TOMCAT_HOME=/usr/local/tomcat\" >> /etc/profile\n    source /etc/profile\n}\nInstallJava\nInstallTomcat\n\n/usr/local/tomcat/bin/startup.sh\n```\n2）执行脚本\n```\n[root@tomcat1 ~]# bash install_tomcat.sh \njava version \"1.8.0_211\"\nJava(TM) SE Runtime Environment (build 1.8.0_211-b12)\nJava HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)\nUsing CATALINA_BASE:   /usr/local/tomcat\nUsing CATALINA_HOME:   /usr/local/tomcat\nUsing CATALINA_TMPDIR: /usr/local/tomcat/temp\nUsing JRE_HOME:        /usr/local/java\nUsing CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar\nTomcat started.\n\n[root@tomcat1 ~]# ss -nltp |grep :80\nLISTEN     0      100         :::8080                    :::*                   users:((\"java\",pid=2993,fd=54))\nLISTEN     0      1         ::ffff:127.0.0.1:8005                    :::*                   users:((\"java\",pid=2993,fd=74))\nLISTEN     0      100         :::8009                    :::*                   users:((\"java\",pid=2993,fd=59))\n```\n3）下载`memcached-session-manager`等相关软件包并`copy`到`tomcat`安装目录的`lib`目录中\n```\n[root@tomcat1 ~]# mkdir tools && cd tools\n\n[root@tomcat1 ~]# wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar\n[root@tomcat1 ~]# wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar\n[root@tomcat1 ~]# wget http://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar\n[root@tomcat1 ~]# wget http://repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar\n[root@tomcat1 ~]# wget https://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar\n[root@tomcat1 ~]# wget https://repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar\n[root@tomcat1 ~]# wget https://repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar\n[root@tomcat1 ~]# wget https://repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar\n[root@tomcat1 ~]# wget https://repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar\n[root@tomcat1 ~]# wget http://repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar\n\n[root@tomcat1 tools]# cp ./* /usr/local/tomcat/lib/\n```\n4）编辑配置文件，添加连接`memcached`\n```\n# No-Stick模式\n[root@tomcat1 ~]# vim /usr/local/tomcat/conf/context.xml\n# 在<Context>和</Context>里面加上下面一段\n<!-- 这里的ip为memcached服务器的IP,如果有多个memcached服务器，用逗号隔开 -->\n    <Manager className=\"de.javakaffee.web.msm.MemcachedBackupSessionManager\"\n        memcachedNodes=\"n1:192.168.1.34:11211\" \n        lockingMode=\"auto\"\n        sticky=\"false\"\n        requestUriIgnorePattern= \".*\\.(png|gif|jpg|css|js)$\"  \n        sessionBackupAsync= \"false\"  \n        sessionBackupTimeout= \"100\"  \n        copyCollectionsForSerialization=\"true\"  \n        transcoderFactoryClass=\"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory\" />\n```\n5）准备测试文件\n```\n[root@tomcat1 ~]# rm -rf /usr/local/tomcat/webapps/*\n[root@tomcat1 ~]# mkdir /usr/local/tomcat/webapps/ROOT\n[root@tomcat1 ~]# vim /usr/local/tomcat/webapps/ROOT/index.jsp\nSessionID:<%=session.getId()%> <BR>\nSessionIP:<%=request.getServerName()%> <BR>\nSessionPort:<%=request.getServerPort()%>\n```\n6）重启`tomcat`\n```\n[root@tomcat1 ~]# /usr/local/tomcat/bin/shutdown.sh\n[root@tomcat1 ~]# /usr/local/tomcat/bin/startup.sh\n[root@tomcat1 ~]# lsof -i:8080\nCOMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\njava    4672 root   63u  IPv6  52084      0t0  TCP *:webcache (LISTEN)\n```\n7）测试\n访问tomcat1：\n![](Tomcat+Nginx+Memcached综合案例/tomcat1.png)\n访问tomcat2：\n![](Tomcat+Nginx+Memcached综合案例/tomcat2.png)\n访问nginx默认页面：\n![](Tomcat+Nginx+Memcached综合案例/tomcat4.png)\n访问jsp动态程序：\n![](Tomcat+Nginx+Memcached综合案例/tomcat3.png)\n通过上面的访问可以看出，访问静态页面时nginx自身处理，当访问jsp动态的时候会调度给tomcat去处理。并且当一个浏览器访问后，便会一直访问这一个，so，这样就达到了session会话保持。\n\n----\n**补充**\nmemcached-session-manager 参数说明：\n```\nmemcachedNodes 必选项，memcached的节点信息，多个memcached节点,中间需要使用空格\n\nfailoverNodes=\"n2\"  表示当前session保持到n1的memcached节点上\nfailoverNodes  可选项，不能使用在non-sticky sessions模式。故障转移配置节点，多个使用空格或逗号分开，配置某个节点为备份节点，\n当其他节点都不可用时才会存储到备份节点，官方建议配置为和tomcat同服务器的节点。\n理由如下:\n假如有两台服务器m1,m2，其中m1部署tomcat和memcached节点n1，m2部署memcached节点n2。\n如果配置tomcat的failoverNodes值为n2或者不配置，则当服务器m1挂掉后n1和tomcat中保存的session会丢失，而n2中未保存或者只保存了部分session，\n这就造成 部分用户状态丢失。\n如果配置tomcat的failoverNodes值为n1，则当m1挂掉后因为n2中保存了所有的session，所以重启tomcat的时候用户状态不会丢失。\n为什么n2中保存了所有的session? 因为failoverNodes配置的值是n1，只有当n2节点不可用时才会把session存储到n1，所以这个时候n1中是没有保存任何session的。\nlockingMode  可选值，默认none，只对non-sticky有效。\nrequestUriIgnorePattern  可选值，制定忽略那些请求的session操作，一般制定静态资源如css,js一类的。\nsessionBackupAsync    可选值，默认true，是否异步的方式存储到memcached。\nsessionBackupTimeout  可选项，默认100毫秒，异步存储session的超时时间。\n```\n\n相关软件包jar包下载：\n```\nmemcached-session-manager 下载地址：http://repo1.maven.org/maven2/de/javakaffee/msm/\nhttp://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar\nhttp://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar\n\nmsm-kryo-serializer    下载地址：http://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/\nhttp://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar\n\nspymemcached    下载地址：http://repo1.maven.org/maven2/net/spy/spymemcached/\nhttp://repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar\n\nserializers    下载地址：https://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/\nhttps://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar\n\nreflectasm    下载地址：https://repo1.maven.org/maven2/com/esotericsoftware/reflectasm\nhttps://repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar\n\nminlog    下载地址：https://repo1.maven.org/maven2/com/esotericsoftware/minlog\nhttps://repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar\n\nkryo    下载地址：https://repo1.maven.org/maven2/com/esotericsoftware/kryo\nhttps://repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar\n\nasm    下载地址：https://repo1.maven.org/maven2/org/ow2/asm/asm/\nhttps://repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar     \n\nobjenesis    下载地址：http://repo1.maven.org/maven2/org/objenesis/objenesis/\nhttp://repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar\n```\n\n","source":"_posts/Tomcat+Nginx+Memcached综合案例.md","raw":"---\ntitle: Tomcat+Nginx+Memcached综合案例\ndate: 2019-06-27 17:36:22\ntags: Tomcat\ncategories: Tomcat\ncopyright: true\n---\n\n## 说明\n>通过`Nginx`解析静态页面并将动态负载均衡调度给后面的多个`Tomcat`，`Tomcat`解析`java`动态程序。\n\n>由于http是无状态的协议，你访问了页面A，然后在访问B，http无法确定这2个访问来自一个人\n>，因此要用cookie或session来跟踪用户，根据授权和用户身份来显示不同的页面。\n>比如用户A登陆了，那么能看到自己的个人信息，而B没登陆，无法看到个人信息。\n>还有A可能在购物，把商品放入购物车，此时B也有这个过程，你无法确定A，B的身份和购物信息，所以需要一个session ID来维持这个过程。所以就用到了session管理。\n\n[官网文档](https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration)\n\n## 环境规划\n| 主机         | hostname              | 环境                 |      |\n| ------------ | --------------------- | -------------------- | ---- |\n| 192.168.1.31 | nginx.cluster.com     | nginx（yum安装）     |      |\n| 192.168.1.32 | tomcat1.cluster.com   | tomcat-9.0           |      |\n| 192.168.1.33 | tomcat2.cluster.com   | tomcat-9.0           |      |\n| 192.168.1.34 | memcached.cluster.com | memcached（yum安装） |      |\n\n>关闭防火墙，selinux；时间同步；host绑定等基本配置 (步骤略)\n\n## 具体步骤\n本案例所使用的`tomcat`、`jdk`、和`tomcat-session`相关的jar包下载地址\n链接：https://pan.baidu.com/s/1ESm_RSrFx77kWObmCt1DQw \n提取码：f64n \n\n### memcached部署\n>说明：memcached这里不需要配置太多，安装即可，然后检查端口是否处于监听中。tomcat服务器能成功连接即可\n```\n[root@memcached ~]# yum -y install memcached\n[root@memcached ~]# systemctl enable memcached\n[root@memcached ~]# systemctl start memcached\n\n[root@memcached ~]# lsof -i:11211\nCOMMAND    PID      USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nmemcached 4419 memcached   26u  IPv4  51021      0t0  TCP *:memcache (LISTEN)\nmemcached 4419 memcached   27u  IPv6  51022      0t0  TCP *:memcache (LISTEN)\nmemcached 4419 memcached   28u  IPv4  51025      0t0  UDP *:memcache \nmemcached 4419 memcached   29u  IPv6  51026      0t0  UDP *:memcache\n```\n\n### nginx部署\n1）安装nginx\n```\n[root@nginx ~]# yum -y install nginx\n[root@nginx ~]# nginx -v\nnginx version: nginx/1.12.2\n```\n2）配置文件配置\n```\n# 创建一个虚拟主机\n[root@nginx ~]# vim /etc/nginx/conf.d/www.conf\nupstream tomcat {\n    server 192.168.1.32:8080 weight=1;\n    server 192.168.1.33:8080 weight=1;\n}\n\nserver {\n    listen       88 default_server;\n    server_name  localhost;\n    root         /opt/project;\n\n#已jsp结尾的动态程序调度给tomcat去处理\n    location ~.*\\.jsp$ {\n        proxy_pass http://tomcat;\n        proxy_set_header Host $host;\n        proxy_set_header X-Forwarded-For $remote_addr;\n    }\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n}\n\n\n# 创建测试文件\n[root@nginx ~]# mkdir /opt/project\n[root@nginx ~]# echo \"<h1>Nginx IP:192.168.1.31</h1>\" >> /opt/project/index.html\n```\n\n### tomcat部署\n详细安装参考：https://www.cnblogs.com/yanjieli/p/11092350.html\n**两台tomcat服务器都要执行下面的所有操作，也可以在一台上面执行，然后copy过去。**\n1）上传软件包到服务器，编写一个临时使用的安装脚本\n```\n[root@tomcat1 ~]# cat install_tomcat.sh \n#!/bin/bash\n\n#----安装java环境\nfunction InstallJava (){\n    tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/\n    ln -s /usr/local/jdk1.8.0_211 /usr/local/java\n    sed -i.ori '$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile\n    source /etc/profile\n    java -version\n}\n\n#----安装tomcat环境\nfunction InstallTomcat (){\n    tar xf apache-tomcat-9.0.21.tar.gz -C /usr/local/\n    ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat\n    echo \"export TOMCAT_HOME=/usr/local/tomcat\" >> /etc/profile\n    source /etc/profile\n}\nInstallJava\nInstallTomcat\n\n/usr/local/tomcat/bin/startup.sh\n```\n2）执行脚本\n```\n[root@tomcat1 ~]# bash install_tomcat.sh \njava version \"1.8.0_211\"\nJava(TM) SE Runtime Environment (build 1.8.0_211-b12)\nJava HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)\nUsing CATALINA_BASE:   /usr/local/tomcat\nUsing CATALINA_HOME:   /usr/local/tomcat\nUsing CATALINA_TMPDIR: /usr/local/tomcat/temp\nUsing JRE_HOME:        /usr/local/java\nUsing CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar\nTomcat started.\n\n[root@tomcat1 ~]# ss -nltp |grep :80\nLISTEN     0      100         :::8080                    :::*                   users:((\"java\",pid=2993,fd=54))\nLISTEN     0      1         ::ffff:127.0.0.1:8005                    :::*                   users:((\"java\",pid=2993,fd=74))\nLISTEN     0      100         :::8009                    :::*                   users:((\"java\",pid=2993,fd=59))\n```\n3）下载`memcached-session-manager`等相关软件包并`copy`到`tomcat`安装目录的`lib`目录中\n```\n[root@tomcat1 ~]# mkdir tools && cd tools\n\n[root@tomcat1 ~]# wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar\n[root@tomcat1 ~]# wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar\n[root@tomcat1 ~]# wget http://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar\n[root@tomcat1 ~]# wget http://repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar\n[root@tomcat1 ~]# wget https://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar\n[root@tomcat1 ~]# wget https://repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar\n[root@tomcat1 ~]# wget https://repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar\n[root@tomcat1 ~]# wget https://repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar\n[root@tomcat1 ~]# wget https://repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar\n[root@tomcat1 ~]# wget http://repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar\n\n[root@tomcat1 tools]# cp ./* /usr/local/tomcat/lib/\n```\n4）编辑配置文件，添加连接`memcached`\n```\n# No-Stick模式\n[root@tomcat1 ~]# vim /usr/local/tomcat/conf/context.xml\n# 在<Context>和</Context>里面加上下面一段\n<!-- 这里的ip为memcached服务器的IP,如果有多个memcached服务器，用逗号隔开 -->\n    <Manager className=\"de.javakaffee.web.msm.MemcachedBackupSessionManager\"\n        memcachedNodes=\"n1:192.168.1.34:11211\" \n        lockingMode=\"auto\"\n        sticky=\"false\"\n        requestUriIgnorePattern= \".*\\.(png|gif|jpg|css|js)$\"  \n        sessionBackupAsync= \"false\"  \n        sessionBackupTimeout= \"100\"  \n        copyCollectionsForSerialization=\"true\"  \n        transcoderFactoryClass=\"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory\" />\n```\n5）准备测试文件\n```\n[root@tomcat1 ~]# rm -rf /usr/local/tomcat/webapps/*\n[root@tomcat1 ~]# mkdir /usr/local/tomcat/webapps/ROOT\n[root@tomcat1 ~]# vim /usr/local/tomcat/webapps/ROOT/index.jsp\nSessionID:<%=session.getId()%> <BR>\nSessionIP:<%=request.getServerName()%> <BR>\nSessionPort:<%=request.getServerPort()%>\n```\n6）重启`tomcat`\n```\n[root@tomcat1 ~]# /usr/local/tomcat/bin/shutdown.sh\n[root@tomcat1 ~]# /usr/local/tomcat/bin/startup.sh\n[root@tomcat1 ~]# lsof -i:8080\nCOMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\njava    4672 root   63u  IPv6  52084      0t0  TCP *:webcache (LISTEN)\n```\n7）测试\n访问tomcat1：\n![](Tomcat+Nginx+Memcached综合案例/tomcat1.png)\n访问tomcat2：\n![](Tomcat+Nginx+Memcached综合案例/tomcat2.png)\n访问nginx默认页面：\n![](Tomcat+Nginx+Memcached综合案例/tomcat4.png)\n访问jsp动态程序：\n![](Tomcat+Nginx+Memcached综合案例/tomcat3.png)\n通过上面的访问可以看出，访问静态页面时nginx自身处理，当访问jsp动态的时候会调度给tomcat去处理。并且当一个浏览器访问后，便会一直访问这一个，so，这样就达到了session会话保持。\n\n----\n**补充**\nmemcached-session-manager 参数说明：\n```\nmemcachedNodes 必选项，memcached的节点信息，多个memcached节点,中间需要使用空格\n\nfailoverNodes=\"n2\"  表示当前session保持到n1的memcached节点上\nfailoverNodes  可选项，不能使用在non-sticky sessions模式。故障转移配置节点，多个使用空格或逗号分开，配置某个节点为备份节点，\n当其他节点都不可用时才会存储到备份节点，官方建议配置为和tomcat同服务器的节点。\n理由如下:\n假如有两台服务器m1,m2，其中m1部署tomcat和memcached节点n1，m2部署memcached节点n2。\n如果配置tomcat的failoverNodes值为n2或者不配置，则当服务器m1挂掉后n1和tomcat中保存的session会丢失，而n2中未保存或者只保存了部分session，\n这就造成 部分用户状态丢失。\n如果配置tomcat的failoverNodes值为n1，则当m1挂掉后因为n2中保存了所有的session，所以重启tomcat的时候用户状态不会丢失。\n为什么n2中保存了所有的session? 因为failoverNodes配置的值是n1，只有当n2节点不可用时才会把session存储到n1，所以这个时候n1中是没有保存任何session的。\nlockingMode  可选值，默认none，只对non-sticky有效。\nrequestUriIgnorePattern  可选值，制定忽略那些请求的session操作，一般制定静态资源如css,js一类的。\nsessionBackupAsync    可选值，默认true，是否异步的方式存储到memcached。\nsessionBackupTimeout  可选项，默认100毫秒，异步存储session的超时时间。\n```\n\n相关软件包jar包下载：\n```\nmemcached-session-manager 下载地址：http://repo1.maven.org/maven2/de/javakaffee/msm/\nhttp://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar\nhttp://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar\n\nmsm-kryo-serializer    下载地址：http://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/\nhttp://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar\n\nspymemcached    下载地址：http://repo1.maven.org/maven2/net/spy/spymemcached/\nhttp://repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar\n\nserializers    下载地址：https://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/\nhttps://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar\n\nreflectasm    下载地址：https://repo1.maven.org/maven2/com/esotericsoftware/reflectasm\nhttps://repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar\n\nminlog    下载地址：https://repo1.maven.org/maven2/com/esotericsoftware/minlog\nhttps://repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar\n\nkryo    下载地址：https://repo1.maven.org/maven2/com/esotericsoftware/kryo\nhttps://repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar\n\nasm    下载地址：https://repo1.maven.org/maven2/org/ow2/asm/asm/\nhttps://repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar     \n\nobjenesis    下载地址：http://repo1.maven.org/maven2/org/objenesis/objenesis/\nhttp://repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar\n```\n\n","slug":"Tomcat+Nginx+Memcached综合案例","published":1,"updated":"2019-07-10T01:46:29.979Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjxwlqrm0001elctctc1lfs4w","content":"<h2 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h2><blockquote>\n<p>通过<code>Nginx</code>解析静态页面并将动态负载均衡调度给后面的多个<code>Tomcat</code>，<code>Tomcat</code>解析<code>java</code>动态程序。</p>\n</blockquote>\n<blockquote>\n<p>由于http是无状态的协议，你访问了页面A，然后在访问B，http无法确定这2个访问来自一个人<br>，因此要用cookie或session来跟踪用户，根据授权和用户身份来显示不同的页面。<br>比如用户A登陆了，那么能看到自己的个人信息，而B没登陆，无法看到个人信息。<br>还有A可能在购物，把商品放入购物车，此时B也有这个过程，你无法确定A，B的身份和购物信息，所以需要一个session ID来维持这个过程。所以就用到了session管理。</p>\n</blockquote>\n<p><a href=\"https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration\" target=\"_blank\" rel=\"noopener\">官网文档</a></p>\n<h2 id=\"环境规划\"><a href=\"#环境规划\" class=\"headerlink\" title=\"环境规划\"></a>环境规划</h2><table>\n<thead>\n<tr>\n<th>主机</th>\n<th>hostname</th>\n<th>环境</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>192.168.1.31</td>\n<td>nginx.cluster.com</td>\n<td>nginx（yum安装）</td>\n<td></td>\n</tr>\n<tr>\n<td>192.168.1.32</td>\n<td>tomcat1.cluster.com</td>\n<td>tomcat-9.0</td>\n<td></td>\n</tr>\n<tr>\n<td>192.168.1.33</td>\n<td>tomcat2.cluster.com</td>\n<td>tomcat-9.0</td>\n<td></td>\n</tr>\n<tr>\n<td>192.168.1.34</td>\n<td>memcached.cluster.com</td>\n<td>memcached（yum安装）</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>关闭防火墙，selinux；时间同步；host绑定等基本配置 (步骤略)</p>\n</blockquote>\n<h2 id=\"具体步骤\"><a href=\"#具体步骤\" class=\"headerlink\" title=\"具体步骤\"></a>具体步骤</h2><p>本案例所使用的<code>tomcat</code>、<code>jdk</code>、和<code>tomcat-session</code>相关的jar包下载地址<br>链接：<a href=\"https://pan.baidu.com/s/1ESm_RSrFx77kWObmCt1DQw\" target=\"_blank\" rel=\"noopener\">https://pan.baidu.com/s/1ESm_RSrFx77kWObmCt1DQw</a><br>提取码：f64n </p>\n<h3 id=\"memcached部署\"><a href=\"#memcached部署\" class=\"headerlink\" title=\"memcached部署\"></a>memcached部署</h3><blockquote>\n<p>说明：memcached这里不需要配置太多，安装即可，然后检查端口是否处于监听中。tomcat服务器能成功连接即可<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@memcached ~]# yum -y install memcached</span><br><span class=\"line\">[root@memcached ~]# systemctl <span class=\"builtin-name\">enable</span> memcached</span><br><span class=\"line\">[root@memcached ~]# systemctl start memcached</span><br><span class=\"line\"></span><br><span class=\"line\">[root@memcached ~]# lsof -i:11211</span><br><span class=\"line\">COMMAND    PID     <span class=\"built_in\"> USER </span>  FD  <span class=\"built_in\"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">memcached 4419 memcached   26u  IPv4  51021      0t0  TCP *:memcache (LISTEN)</span><br><span class=\"line\">memcached 4419 memcached   27u <span class=\"built_in\"> IPv6 </span> 51022      0t0  TCP *:memcache (LISTEN)</span><br><span class=\"line\">memcached 4419 memcached   28u  IPv4  51025      0t0  UDP *:memcache </span><br><span class=\"line\">memcached 4419 memcached   29u <span class=\"built_in\"> IPv6 </span> 51026      0t0  UDP *:memcache</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"nginx部署\"><a href=\"#nginx部署\" class=\"headerlink\" title=\"nginx部署\"></a>nginx部署</h3><p>1）安装nginx<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@nginx</span> ~]<span class=\"meta\"># yum -y install nginx</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nginx</span> ~]<span class=\"meta\"># nginx -v</span></span><br><span class=\"line\">nginx version: nginx/<span class=\"number\">1.12</span><span class=\"number\">.2</span></span><br></pre></td></tr></table></figure></p>\n<p>2）配置文件配置<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建一个虚拟主机</span></span><br><span class=\"line\">[root@nginx ~]<span class=\"comment\"># vim /etc/nginx/conf.d/www.conf</span></span><br><span class=\"line\">upstream <span class=\"keyword\">tomcat</span> &#123;</span><br><span class=\"line\">    server <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span>:<span class=\"number\">8080</span> weight=<span class=\"number\">1</span>;</span><br><span class=\"line\">    server <span class=\"number\">192.168</span>.<span class=\"number\">1.33</span>:<span class=\"number\">8080</span> weight=<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">server</span> &#123;</span><br><span class=\"line\">    listen       <span class=\"number\">88</span> default_server;</span><br><span class=\"line\">    server_name  localhost;</span><br><span class=\"line\">    <span class=\"literal\">root</span>         /opt/<span class=\"literal\">project</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#已jsp结尾的动态程序调度给tomcat去处理</span></span><br><span class=\"line\">    location ~.*\\.jsp$ &#123;</span><br><span class=\"line\">        proxy_pass http://tomcat;</span><br><span class=\"line\">        proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">error_page</span> 404 /404.html;</span><br><span class=\"line\">        location = /40x.<span class=\"keyword\">html</span> &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">error_page</span> 500 502 503 504 /50x.html;</span><br><span class=\"line\">        location = /50x.<span class=\"keyword\">html</span> &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建测试文件</span></span><br><span class=\"line\">[root@nginx ~]<span class=\"comment\"># mkdir /opt/project</span></span><br><span class=\"line\">[root@nginx ~]<span class=\"comment\"># echo \"&lt;h1&gt;Nginx IP:192.168.1.31&lt;/h1&gt;\" &gt;&gt; /opt/project/index.html</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"tomcat部署\"><a href=\"#tomcat部署\" class=\"headerlink\" title=\"tomcat部署\"></a>tomcat部署</h3><p>详细安装参考：<a href=\"https://www.cnblogs.com/yanjieli/p/11092350.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/yanjieli/p/11092350.html</a><br><strong>两台tomcat服务器都要执行下面的所有操作，也可以在一台上面执行，然后copy过去。</strong><br>1）上传软件包到服务器，编写一个临时使用的安装脚本<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat1 ~]<span class=\"comment\"># cat install_tomcat.sh </span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#----安装java环境</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">InstallJava</span></span> ()&#123;</span><br><span class=\"line\">    tar xf jdk-8u211-linux-x64.tar.gz -C /usr/<span class=\"built_in\">local</span>/</span><br><span class=\"line\">    ln -s /usr/<span class=\"built_in\">local</span>/jdk1.8.0_211 /usr/<span class=\"built_in\">local</span>/java</span><br><span class=\"line\">    sed -i.ori <span class=\"string\">'$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar'</span> /etc/profile</span><br><span class=\"line\">    <span class=\"built_in\">source</span> /etc/profile</span><br><span class=\"line\">    java -version</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#----安装tomcat环境</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">InstallTomcat</span></span> ()&#123;</span><br><span class=\"line\">    tar xf apache-tomcat-9.0.21.tar.gz -C /usr/<span class=\"built_in\">local</span>/</span><br><span class=\"line\">    ln -s /usr/<span class=\"built_in\">local</span>/apache-tomcat-9.0.21 /usr/<span class=\"built_in\">local</span>/tomcat</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"export TOMCAT_HOME=/usr/local/tomcat\"</span> &gt;&gt; /etc/profile</span><br><span class=\"line\">    <span class=\"built_in\">source</span> /etc/profile</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">InstallJava</span><br><span class=\"line\">InstallTomcat</span><br><span class=\"line\"></span><br><span class=\"line\">/usr/<span class=\"built_in\">local</span>/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure></p>\n<p>2）执行脚本<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat1 ~]# bash install_tomcat.sh </span><br><span class=\"line\">java version <span class=\"string\">\"1.8.0_211\"</span></span><br><span class=\"line\">Java(TM) SE Runtime Environment (build 1.8.0_211-b12)</span><br><span class=\"line\">Java HotSpot(TM) 64-Bit<span class=\"built_in\"> Server </span>VM (build 25.211-b12, mixed mode)</span><br><span class=\"line\">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class=\"line\">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class=\"line\">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class=\"line\">Using JRE_HOME:        /usr/local/java</span><br><span class=\"line\">Using CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class=\"line\">Tomcat started.</span><br><span class=\"line\"></span><br><span class=\"line\">[root@tomcat1 ~]# ss -nltp |grep :80</span><br><span class=\"line\">LISTEN     0      100         :::8080                    :::*                   users:((<span class=\"string\">\"java\"</span>,<span class=\"attribute\">pid</span>=2993,fd=54))</span><br><span class=\"line\">LISTEN     0      1         ::ffff:127.0.0.1:8005                    :::*                   users:((<span class=\"string\">\"java\"</span>,<span class=\"attribute\">pid</span>=2993,fd=74))</span><br><span class=\"line\">LISTEN     0      100         :::8009                    :::*                   users:((<span class=\"string\">\"java\"</span>,<span class=\"attribute\">pid</span>=2993,fd=59))</span><br></pre></td></tr></table></figure></p>\n<p>3）下载<code>memcached-session-manager</code>等相关软件包并<code>copy</code>到<code>tomcat</code>安装目录的<code>lib</code>目录中<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># mkdir tools &amp;&amp; cd tools</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget http://repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget https://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget https://repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget https://repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget https://repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget https://repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget http://repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> tools]<span class=\"meta\"># cp ./* /usr/local/tomcat/lib/</span></span><br></pre></td></tr></table></figure></p>\n<p>4）编辑配置文件，添加连接<code>memcached</code><br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># No-Stick模式</span><br><span class=\"line\">[root@tomcat1 ~]# vim /usr/local/tomcat/conf/context.xml</span><br><span class=\"line\"># 在<span class=\"tag\">&lt;<span class=\"name\">Context</span>&gt;</span>和<span class=\"tag\">&lt;/<span class=\"name\">Context</span>&gt;</span>里面加上下面一段</span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 这里的ip为memcached服务器的IP,如果有多个memcached服务器，用逗号隔开 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Manager</span> <span class=\"attr\">className</span>=<span class=\"string\">\"de.javakaffee.web.msm.MemcachedBackupSessionManager\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">memcachedNodes</span>=<span class=\"string\">\"n1:192.168.1.34:11211\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">lockingMode</span>=<span class=\"string\">\"auto\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">sticky</span>=<span class=\"string\">\"false\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">requestUriIgnorePattern</span>= <span class=\"string\">\".*\\.(png|gif|jpg|css|js)$\"</span>  </span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">sessionBackupAsync</span>= <span class=\"string\">\"false\"</span>  </span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">sessionBackupTimeout</span>= <span class=\"string\">\"100\"</span>  </span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">copyCollectionsForSerialization</span>=<span class=\"string\">\"true\"</span>  </span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">transcoderFactoryClass</span>=<span class=\"string\">\"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory\"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>5）准备测试文件<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"meta\">@tomcat1</span> ~]<span class=\"comment\"># rm -rf /usr/local/tomcat/webapps/*</span></span><br><span class=\"line\">[root<span class=\"meta\">@tomcat1</span> ~]<span class=\"comment\"># mkdir /usr/local/tomcat/webapps/ROOT</span></span><br><span class=\"line\">[root<span class=\"meta\">@tomcat1</span> ~]<span class=\"comment\"># vim /usr/local/tomcat/webapps/ROOT/index.jsp</span></span><br><span class=\"line\">SessionID:<span class=\"variable\">&lt;%=session.getId()%&gt;</span> <span class=\"variable\">&lt;BR&gt;</span></span><br><span class=\"line\">SessionIP:<span class=\"variable\">&lt;%=request.getServerName()%&gt;</span> <span class=\"variable\">&lt;BR&gt;</span></span><br><span class=\"line\">SessionPort:<span class=\"variable\">&lt;%=request.getServerPort()%&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>6）重启<code>tomcat</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat1 ~]# /usr/local/tomcat/bin/shutdown.sh</span><br><span class=\"line\">[root@tomcat1 ~]# /usr/local/tomcat/bin/startup.sh</span><br><span class=\"line\">[root@tomcat1 ~]# lsof -i:8080</span><br><span class=\"line\">COMMAND  PID<span class=\"built_in\"> USER </span>  FD  <span class=\"built_in\"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">java    4672 root   63u <span class=\"built_in\"> IPv6 </span> 52084      0t0  TCP *:webcache (LISTEN)</span><br></pre></td></tr></table></figure></p>\n<p>7）测试<br>访问tomcat1：<br><img src=\"/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat1.png\" alt><br>访问tomcat2：<br><img src=\"/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat2.png\" alt><br>访问nginx默认页面：<br><img src=\"/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat4.png\" alt><br>访问jsp动态程序：<br><img src=\"/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat3.png\" alt><br>通过上面的访问可以看出，访问静态页面时nginx自身处理，当访问jsp动态的时候会调度给tomcat去处理。并且当一个浏览器访问后，便会一直访问这一个，so，这样就达到了session会话保持。</p>\n<hr>\n<p><strong>补充</strong><br>memcached-session-manager 参数说明：<br><figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memcachedNodes 必选项，memcached的节点信息，多个memcached节点,中间需要使用空格</span><br><span class=\"line\"></span><br><span class=\"line\">failoverNodes=<span class=\"string\">\"n2\"</span>  表示当前session保持到n1的memcached节点上</span><br><span class=\"line\">failoverNodes  可选项，不能使用在non-sticky sessions模式。故障转移配置节点，多个使用空格或逗号分开，配置某个节点为备份节点，</span><br><span class=\"line\">当其他节点都不可用时才会存储到备份节点，官方建议配置为和tomcat同服务器的节点。</span><br><span class=\"line\"><span class=\"section\">理由如下:</span></span><br><span class=\"line\">假如有两台服务器m1,m2，其中m1部署tomcat和memcached节点n1，m2部署memcached节点n2。</span><br><span class=\"line\">如果配置tomcat的failoverNodes值为n2或者不配置，则当服务器m1挂掉后n1和tomcat中保存的session会丢失，而n2中未保存或者只保存了部分session，</span><br><span class=\"line\">这就造成 部分用户状态丢失。</span><br><span class=\"line\">如果配置tomcat的failoverNodes值为n1，则当m1挂掉后因为n2中保存了所有的session，所以重启tomcat的时候用户状态不会丢失。</span><br><span class=\"line\">为什么n2中保存了所有的session? 因为failoverNodes配置的值是n1，只有当n2节点不可用时才会把session存储到n1，所以这个时候n1中是没有保存任何session的。</span><br><span class=\"line\">lockingMode  可选值，默认none，只对non-sticky有效。</span><br><span class=\"line\">requestUriIgnorePattern  可选值，制定忽略那些请求的session操作，一般制定静态资源如css,js一类的。</span><br><span class=\"line\">sessionBackupAsync    可选值，默认true，是否异步的方式存储到memcached。</span><br><span class=\"line\">sessionBackupTimeout  可选项，默认100毫秒，异步存储session的超时时间。</span><br></pre></td></tr></table></figure></p>\n<p>相关软件包jar包下载：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memcached-session-manager 下载地址：<span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/msm/</span></span><br><span class=\"line\"><span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar</span></span><br><span class=\"line\"><span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">msm-kryo-serializer    下载地址：<span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/</span></span><br><span class=\"line\"><span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">spymemcached    下载地址：<span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/net/spy/spymemcached/</span></span><br><span class=\"line\"><span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">serializers    下载地址：<span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/kryo-serializers/</span></span><br><span class=\"line\"><span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">reflectasm    下载地址：<span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/reflectasm</span></span><br><span class=\"line\"><span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">minlog    下载地址：<span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/minlog</span></span><br><span class=\"line\"><span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">kryo    下载地址：<span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/kryo</span></span><br><span class=\"line\"><span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">asm    下载地址：<span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/org/ow2/asm/asm/</span></span><br><span class=\"line\"><span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar     </span></span><br><span class=\"line\"></span><br><span class=\"line\">objenesis    下载地址：<span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/org/objenesis/objenesis/</span></span><br><span class=\"line\"><span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h2><blockquote>\n<p>通过<code>Nginx</code>解析静态页面并将动态负载均衡调度给后面的多个<code>Tomcat</code>，<code>Tomcat</code>解析<code>java</code>动态程序。</p>\n</blockquote>\n<blockquote>\n<p>由于http是无状态的协议，你访问了页面A，然后在访问B，http无法确定这2个访问来自一个人<br>，因此要用cookie或session来跟踪用户，根据授权和用户身份来显示不同的页面。<br>比如用户A登陆了，那么能看到自己的个人信息，而B没登陆，无法看到个人信息。<br>还有A可能在购物，把商品放入购物车，此时B也有这个过程，你无法确定A，B的身份和购物信息，所以需要一个session ID来维持这个过程。所以就用到了session管理。</p>\n</blockquote>\n<p><a href=\"https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration\" target=\"_blank\" rel=\"noopener\">官网文档</a></p>\n<h2 id=\"环境规划\"><a href=\"#环境规划\" class=\"headerlink\" title=\"环境规划\"></a>环境规划</h2><table>\n<thead>\n<tr>\n<th>主机</th>\n<th>hostname</th>\n<th>环境</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>192.168.1.31</td>\n<td>nginx.cluster.com</td>\n<td>nginx（yum安装）</td>\n<td></td>\n</tr>\n<tr>\n<td>192.168.1.32</td>\n<td>tomcat1.cluster.com</td>\n<td>tomcat-9.0</td>\n<td></td>\n</tr>\n<tr>\n<td>192.168.1.33</td>\n<td>tomcat2.cluster.com</td>\n<td>tomcat-9.0</td>\n<td></td>\n</tr>\n<tr>\n<td>192.168.1.34</td>\n<td>memcached.cluster.com</td>\n<td>memcached（yum安装）</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>关闭防火墙，selinux；时间同步；host绑定等基本配置 (步骤略)</p>\n</blockquote>\n<h2 id=\"具体步骤\"><a href=\"#具体步骤\" class=\"headerlink\" title=\"具体步骤\"></a>具体步骤</h2><p>本案例所使用的<code>tomcat</code>、<code>jdk</code>、和<code>tomcat-session</code>相关的jar包下载地址<br>链接：<a href=\"https://pan.baidu.com/s/1ESm_RSrFx77kWObmCt1DQw\" target=\"_blank\" rel=\"noopener\">https://pan.baidu.com/s/1ESm_RSrFx77kWObmCt1DQw</a><br>提取码：f64n </p>\n<h3 id=\"memcached部署\"><a href=\"#memcached部署\" class=\"headerlink\" title=\"memcached部署\"></a>memcached部署</h3><blockquote>\n<p>说明：memcached这里不需要配置太多，安装即可，然后检查端口是否处于监听中。tomcat服务器能成功连接即可<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@memcached ~]# yum -y install memcached</span><br><span class=\"line\">[root@memcached ~]# systemctl <span class=\"builtin-name\">enable</span> memcached</span><br><span class=\"line\">[root@memcached ~]# systemctl start memcached</span><br><span class=\"line\"></span><br><span class=\"line\">[root@memcached ~]# lsof -i:11211</span><br><span class=\"line\">COMMAND    PID     <span class=\"built_in\"> USER </span>  FD  <span class=\"built_in\"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">memcached 4419 memcached   26u  IPv4  51021      0t0  TCP *:memcache (LISTEN)</span><br><span class=\"line\">memcached 4419 memcached   27u <span class=\"built_in\"> IPv6 </span> 51022      0t0  TCP *:memcache (LISTEN)</span><br><span class=\"line\">memcached 4419 memcached   28u  IPv4  51025      0t0  UDP *:memcache </span><br><span class=\"line\">memcached 4419 memcached   29u <span class=\"built_in\"> IPv6 </span> 51026      0t0  UDP *:memcache</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"nginx部署\"><a href=\"#nginx部署\" class=\"headerlink\" title=\"nginx部署\"></a>nginx部署</h3><p>1）安装nginx<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@nginx</span> ~]<span class=\"meta\"># yum -y install nginx</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nginx</span> ~]<span class=\"meta\"># nginx -v</span></span><br><span class=\"line\">nginx version: nginx/<span class=\"number\">1.12</span><span class=\"number\">.2</span></span><br></pre></td></tr></table></figure></p>\n<p>2）配置文件配置<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建一个虚拟主机</span></span><br><span class=\"line\">[root@nginx ~]<span class=\"comment\"># vim /etc/nginx/conf.d/www.conf</span></span><br><span class=\"line\">upstream <span class=\"keyword\">tomcat</span> &#123;</span><br><span class=\"line\">    server <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span>:<span class=\"number\">8080</span> weight=<span class=\"number\">1</span>;</span><br><span class=\"line\">    server <span class=\"number\">192.168</span>.<span class=\"number\">1.33</span>:<span class=\"number\">8080</span> weight=<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">server</span> &#123;</span><br><span class=\"line\">    listen       <span class=\"number\">88</span> default_server;</span><br><span class=\"line\">    server_name  localhost;</span><br><span class=\"line\">    <span class=\"literal\">root</span>         /opt/<span class=\"literal\">project</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#已jsp结尾的动态程序调度给tomcat去处理</span></span><br><span class=\"line\">    location ~.*\\.jsp$ &#123;</span><br><span class=\"line\">        proxy_pass http://tomcat;</span><br><span class=\"line\">        proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">error_page</span> 404 /404.html;</span><br><span class=\"line\">        location = /40x.<span class=\"keyword\">html</span> &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">error_page</span> 500 502 503 504 /50x.html;</span><br><span class=\"line\">        location = /50x.<span class=\"keyword\">html</span> &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建测试文件</span></span><br><span class=\"line\">[root@nginx ~]<span class=\"comment\"># mkdir /opt/project</span></span><br><span class=\"line\">[root@nginx ~]<span class=\"comment\"># echo \"&lt;h1&gt;Nginx IP:192.168.1.31&lt;/h1&gt;\" &gt;&gt; /opt/project/index.html</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"tomcat部署\"><a href=\"#tomcat部署\" class=\"headerlink\" title=\"tomcat部署\"></a>tomcat部署</h3><p>详细安装参考：<a href=\"https://www.cnblogs.com/yanjieli/p/11092350.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/yanjieli/p/11092350.html</a><br><strong>两台tomcat服务器都要执行下面的所有操作，也可以在一台上面执行，然后copy过去。</strong><br>1）上传软件包到服务器，编写一个临时使用的安装脚本<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat1 ~]<span class=\"comment\"># cat install_tomcat.sh </span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#----安装java环境</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">InstallJava</span></span> ()&#123;</span><br><span class=\"line\">    tar xf jdk-8u211-linux-x64.tar.gz -C /usr/<span class=\"built_in\">local</span>/</span><br><span class=\"line\">    ln -s /usr/<span class=\"built_in\">local</span>/jdk1.8.0_211 /usr/<span class=\"built_in\">local</span>/java</span><br><span class=\"line\">    sed -i.ori <span class=\"string\">'$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar'</span> /etc/profile</span><br><span class=\"line\">    <span class=\"built_in\">source</span> /etc/profile</span><br><span class=\"line\">    java -version</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#----安装tomcat环境</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">InstallTomcat</span></span> ()&#123;</span><br><span class=\"line\">    tar xf apache-tomcat-9.0.21.tar.gz -C /usr/<span class=\"built_in\">local</span>/</span><br><span class=\"line\">    ln -s /usr/<span class=\"built_in\">local</span>/apache-tomcat-9.0.21 /usr/<span class=\"built_in\">local</span>/tomcat</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"export TOMCAT_HOME=/usr/local/tomcat\"</span> &gt;&gt; /etc/profile</span><br><span class=\"line\">    <span class=\"built_in\">source</span> /etc/profile</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">InstallJava</span><br><span class=\"line\">InstallTomcat</span><br><span class=\"line\"></span><br><span class=\"line\">/usr/<span class=\"built_in\">local</span>/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure></p>\n<p>2）执行脚本<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat1 ~]# bash install_tomcat.sh </span><br><span class=\"line\">java version <span class=\"string\">\"1.8.0_211\"</span></span><br><span class=\"line\">Java(TM) SE Runtime Environment (build 1.8.0_211-b12)</span><br><span class=\"line\">Java HotSpot(TM) 64-Bit<span class=\"built_in\"> Server </span>VM (build 25.211-b12, mixed mode)</span><br><span class=\"line\">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class=\"line\">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class=\"line\">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class=\"line\">Using JRE_HOME:        /usr/local/java</span><br><span class=\"line\">Using CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class=\"line\">Tomcat started.</span><br><span class=\"line\"></span><br><span class=\"line\">[root@tomcat1 ~]# ss -nltp |grep :80</span><br><span class=\"line\">LISTEN     0      100         :::8080                    :::*                   users:((<span class=\"string\">\"java\"</span>,<span class=\"attribute\">pid</span>=2993,fd=54))</span><br><span class=\"line\">LISTEN     0      1         ::ffff:127.0.0.1:8005                    :::*                   users:((<span class=\"string\">\"java\"</span>,<span class=\"attribute\">pid</span>=2993,fd=74))</span><br><span class=\"line\">LISTEN     0      100         :::8009                    :::*                   users:((<span class=\"string\">\"java\"</span>,<span class=\"attribute\">pid</span>=2993,fd=59))</span><br></pre></td></tr></table></figure></p>\n<p>3）下载<code>memcached-session-manager</code>等相关软件包并<code>copy</code>到<code>tomcat</code>安装目录的<code>lib</code>目录中<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># mkdir tools &amp;&amp; cd tools</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget http://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget http://repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget https://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget https://repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget https://repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget https://repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget https://repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> ~]<span class=\"meta\"># wget http://repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat1</span> tools]<span class=\"meta\"># cp ./* /usr/local/tomcat/lib/</span></span><br></pre></td></tr></table></figure></p>\n<p>4）编辑配置文件，添加连接<code>memcached</code><br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># No-Stick模式</span><br><span class=\"line\">[root@tomcat1 ~]# vim /usr/local/tomcat/conf/context.xml</span><br><span class=\"line\"># 在<span class=\"tag\">&lt;<span class=\"name\">Context</span>&gt;</span>和<span class=\"tag\">&lt;/<span class=\"name\">Context</span>&gt;</span>里面加上下面一段</span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 这里的ip为memcached服务器的IP,如果有多个memcached服务器，用逗号隔开 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Manager</span> <span class=\"attr\">className</span>=<span class=\"string\">\"de.javakaffee.web.msm.MemcachedBackupSessionManager\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">memcachedNodes</span>=<span class=\"string\">\"n1:192.168.1.34:11211\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">lockingMode</span>=<span class=\"string\">\"auto\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">sticky</span>=<span class=\"string\">\"false\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">requestUriIgnorePattern</span>= <span class=\"string\">\".*\\.(png|gif|jpg|css|js)$\"</span>  </span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">sessionBackupAsync</span>= <span class=\"string\">\"false\"</span>  </span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">sessionBackupTimeout</span>= <span class=\"string\">\"100\"</span>  </span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">copyCollectionsForSerialization</span>=<span class=\"string\">\"true\"</span>  </span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">transcoderFactoryClass</span>=<span class=\"string\">\"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory\"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>5）准备测试文件<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"meta\">@tomcat1</span> ~]<span class=\"comment\"># rm -rf /usr/local/tomcat/webapps/*</span></span><br><span class=\"line\">[root<span class=\"meta\">@tomcat1</span> ~]<span class=\"comment\"># mkdir /usr/local/tomcat/webapps/ROOT</span></span><br><span class=\"line\">[root<span class=\"meta\">@tomcat1</span> ~]<span class=\"comment\"># vim /usr/local/tomcat/webapps/ROOT/index.jsp</span></span><br><span class=\"line\">SessionID:<span class=\"variable\">&lt;%=session.getId()%&gt;</span> <span class=\"variable\">&lt;BR&gt;</span></span><br><span class=\"line\">SessionIP:<span class=\"variable\">&lt;%=request.getServerName()%&gt;</span> <span class=\"variable\">&lt;BR&gt;</span></span><br><span class=\"line\">SessionPort:<span class=\"variable\">&lt;%=request.getServerPort()%&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>6）重启<code>tomcat</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat1 ~]# /usr/local/tomcat/bin/shutdown.sh</span><br><span class=\"line\">[root@tomcat1 ~]# /usr/local/tomcat/bin/startup.sh</span><br><span class=\"line\">[root@tomcat1 ~]# lsof -i:8080</span><br><span class=\"line\">COMMAND  PID<span class=\"built_in\"> USER </span>  FD  <span class=\"built_in\"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">java    4672 root   63u <span class=\"built_in\"> IPv6 </span> 52084      0t0  TCP *:webcache (LISTEN)</span><br></pre></td></tr></table></figure></p>\n<p>7）测试<br>访问tomcat1：<br><img src=\"/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat1.png\" alt><br>访问tomcat2：<br><img src=\"/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat2.png\" alt><br>访问nginx默认页面：<br><img src=\"/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat4.png\" alt><br>访问jsp动态程序：<br><img src=\"/2019/06/27/Tomcat+Nginx+Memcached综合案例/tomcat3.png\" alt><br>通过上面的访问可以看出，访问静态页面时nginx自身处理，当访问jsp动态的时候会调度给tomcat去处理。并且当一个浏览器访问后，便会一直访问这一个，so，这样就达到了session会话保持。</p>\n<hr>\n<p><strong>补充</strong><br>memcached-session-manager 参数说明：<br><figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memcachedNodes 必选项，memcached的节点信息，多个memcached节点,中间需要使用空格</span><br><span class=\"line\"></span><br><span class=\"line\">failoverNodes=<span class=\"string\">\"n2\"</span>  表示当前session保持到n1的memcached节点上</span><br><span class=\"line\">failoverNodes  可选项，不能使用在non-sticky sessions模式。故障转移配置节点，多个使用空格或逗号分开，配置某个节点为备份节点，</span><br><span class=\"line\">当其他节点都不可用时才会存储到备份节点，官方建议配置为和tomcat同服务器的节点。</span><br><span class=\"line\"><span class=\"section\">理由如下:</span></span><br><span class=\"line\">假如有两台服务器m1,m2，其中m1部署tomcat和memcached节点n1，m2部署memcached节点n2。</span><br><span class=\"line\">如果配置tomcat的failoverNodes值为n2或者不配置，则当服务器m1挂掉后n1和tomcat中保存的session会丢失，而n2中未保存或者只保存了部分session，</span><br><span class=\"line\">这就造成 部分用户状态丢失。</span><br><span class=\"line\">如果配置tomcat的failoverNodes值为n1，则当m1挂掉后因为n2中保存了所有的session，所以重启tomcat的时候用户状态不会丢失。</span><br><span class=\"line\">为什么n2中保存了所有的session? 因为failoverNodes配置的值是n1，只有当n2节点不可用时才会把session存储到n1，所以这个时候n1中是没有保存任何session的。</span><br><span class=\"line\">lockingMode  可选值，默认none，只对non-sticky有效。</span><br><span class=\"line\">requestUriIgnorePattern  可选值，制定忽略那些请求的session操作，一般制定静态资源如css,js一类的。</span><br><span class=\"line\">sessionBackupAsync    可选值，默认true，是否异步的方式存储到memcached。</span><br><span class=\"line\">sessionBackupTimeout  可选项，默认100毫秒，异步存储session的超时时间。</span><br></pre></td></tr></table></figure></p>\n<p>相关软件包jar包下载：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memcached-session-manager 下载地址：<span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/msm/</span></span><br><span class=\"line\"><span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/memcached-session-manager-2.3.0.jar</span></span><br><span class=\"line\"><span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc9/2.3.0/memcached-session-manager-tc9-2.3.0.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">msm-kryo-serializer    下载地址：<span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/</span></span><br><span class=\"line\"><span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.0/msm-kryo-serializer-2.3.0.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">spymemcached    下载地址：<span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/net/spy/spymemcached/</span></span><br><span class=\"line\"><span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/net/spy/spymemcached/2.12.2/spymemcached-2.12.2.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">serializers    下载地址：<span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/kryo-serializers/</span></span><br><span class=\"line\"><span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.42/kryo-serializers-0.42.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">reflectasm    下载地址：<span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/reflectasm</span></span><br><span class=\"line\"><span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.0/reflectasm-1.11.0.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">minlog    下载地址：<span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/minlog</span></span><br><span class=\"line\"><span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.0/minlog-1.3.0.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">kryo    下载地址：<span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/kryo</span></span><br><span class=\"line\"><span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/com/esotericsoftware/kryo/4.0.0/kryo-4.0.0.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\">asm    下载地址：<span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/org/ow2/asm/asm/</span></span><br><span class=\"line\"><span class=\"string\">https:</span><span class=\"comment\">//repo1.maven.org/maven2/org/ow2/asm/asm/7.0/asm-7.0.jar     </span></span><br><span class=\"line\"></span><br><span class=\"line\">objenesis    下载地址：<span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/org/objenesis/objenesis/</span></span><br><span class=\"line\"><span class=\"string\">http:</span><span class=\"comment\">//repo1.maven.org/maven2/org/objenesis/objenesis/3.0.1/objenesis-3.0.1.jar</span></span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack基本入门","date":"2019-05-13T07:47:05.000Z","copyright":true,"_content":"## saltstack介绍\n<div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n**主要功能**\n远程执行\n配置管理\n[Stalstack官方文档](http://docs.saltstack.cn/)\n## Saltstack原理\n>`Salt`使用`server-agent`通信模型，服务端组件被称为`Salt master`，`agent`被称为`Salt minion`\n`Salt master`主要负责向`Salt minions`发送命令，然后聚合并显示这些命令的结果。一个`Salt master`可以管理多个`minion`系统\n`Salt server`与`Salt minion`通信的连接由`Salt minion`发起，这也意味着`Salt minion`上不需要打开任何传入端口（从而减少攻击）。`Salt server`使用端口`4505`和`4506`，必须打开端口才能接收到访问连接\n\n![通信示例图](saltstack基本入门/01.png)\n\n- **Publisher** （端口4505）所有`Salt minions`都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。\n- **Request Server** （端口4506）`Salt minios`根据需要连接到请求服务器，将结果发送给`Salt master`，并安全地获取请求的文件或特定`minion`相关的数据值（称为`Salt pillar`）。连接到这个端口的连接在`Salt master`和`Salt minion`之间是1:1（不是异步）。\n\n```\n[root@salt-master ~]# lsof -i:4505\nCOMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nsalt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)\nsalt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505->salt-minion03:37240 (ESTABLISHED)\nsalt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505->salt-minion01:47804 (ESTABLISHED)\nsalt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505->salt-minion02:58594 (ESTABLISHED)\n```\n\n## 快速安装\n1.1 配置 yum 仓库\n```\n# 使用官方自带yum\n[root@salt-master ~]# yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm\n# 或者使用阿里云的yum（建议使用阿里云的，速度快一点）\n[root@salt-master ~]# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n[root@salt-master ~]# sed -i \"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\" /etc/yum.repos.d/salt-latest.repo\n[root@salt-master ~]# yum clean all\n[root@salt-master ~]# yum makecache\n```\n1.2 安装Master，并启动服务\n```\n[root@salt-master ~]# yum -y install salt-master\n[root@salt-master ~]# systemctl enable salt-master\n[root@salt-master ~]# systemctl start salt-master\n```\n1.3 安装 Salt-Minion 指向 Salt-Master 网络地址\n```\n[root@salt-minion01 ~]# yum -y install salt-minion\n# 可以使用主机名，也可以使用IP地址\n[root@salt-minion01 ~]# cp /etc/salt/minion{,.back}\n[root@salt-minion01 ~]# sed -i '/#master: /c\\master: salt-master' /etc/salt/minion\n[root@salt-minion01 ~]# systemctl enable salt-minion\n[root@salt-minion01 ~]# systemctl start salt-minion\n```\n##  SaltStack认证方式\n![master与minion之间的架构关系图](saltstack基本入门/02.png)\n<div class=\"note success\"><p> `Salt` 的数据传输是通过 `AES` 加密，`Master` 和 `Minion` 之前在通信之前，需要进行认证。\n`Salt` 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  `minion` 在第一次启动时候，会在 `/etc/salt/pki/minion/` 下自动生成 `minion.pem(private key)` 和 `minion.pub(public key) `, 然后将 `minion.pub` 发送给 `master `\n2. `master` 在第一次启动时，会在 `/etc/salt/pki/master/` 下自动生成 `master.pem` 和 `master.pub` ；并且会接收到 `minion` 的 `public key` , 通过 `salt-key` 命令接收 `minion public key`， 会在 `master` 的 `/etc/salt/pki/master/minions` 目录下存放以 `minion id` 命令的 `public key` ；验证成功后同时 `minion` 会保存一份 `master public key` 在 minion的 `/etc/salt/pki/minion/minion_master.pub`里。</p></div>\n\n**Salt认证原理总结**\n> `minion`将自己的公钥发送给`master`\n`master`认证后再将自己的公钥也发送给`minion`端\n\n**Master端认证示例**\n根据上面提到的认证原理，先看下未认证前的`master`和`minion`的`pki`目录\n```\n# master上查看\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   │   └── salt-minion01\n│   └── minions_rejected\n└── minion\n\n# minion上查看\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion.pem\n    └── minion.pub\n```\n`salt-key`命令解释：\n```\n[root@salt-master ~]# salt-key -L \nAccepted Keys:        #已经接受的key\nDenied Keys:          #拒绝的key\nUnaccepted Keys:      #未加入的key\nRejected Keys:        #吊销的key\n\n#常用参数\n-L  #查看KEY状态\n-A  #允许所有\n-D  #删除所有\n-a  #认证指定的key\n-d  #删除指定的key\n-r  #注销掉指定key（该状态为未被认证）\n\n#配置master自动接受请求认证(master上配置 /etc/salt/master)\nauto_accept: True\n```\n`salt-key`认证\n```\n#列出当前所有的key\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nDenied Keys:\nUnaccepted Keys:\nsalt-minion01\nRejected Keys:\n\n#添加指定minion的key\n[root@salt-master ~]# salt-key -a salt-minion01 -y\nThe following keys are going to be accepted:\nUnaccepted Keys:\nsalt-minion01\nKey for minion salt-minion01 accepted.\n#添加所有minion的key\n[root@salt-master ~]# salt-key -A -y\n\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nsalt-minion01\nDenied Keys:\nUnaccepted Keys:\nRejected Keys:\n```\n上面认证完成后再次查看`master`和`minion`的`pki`目录\n```\n# master上\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   │   └── salt-minion01\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   └── minions_rejected\n└── minion\n\n# minion上\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion_master.pub\n    ├── minion.pem\n    └── minion.pub\n```\n## Saltstack远程执行\n>远程执行是 `Saltstack` 的核心功能之一。主要使用 `salt` 模块批量给选定的 `minion` 端执行相应的命令，并获得返回结果。\n\n1、判断 `salt` 的 `minion` 主机是否存活\n```\n[root@salt-master ~]# salt '*' test.ping\nsalt-minion02:\n    True\nsalt-minion03:\n    True\nsalt-minion01:\n    True\n\n# salt saltstack自带的一个命令\n# * 表示目标主机，这里表示所有目标主机\n# test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法\n```\n2、`saltstack`使用 `cmd.run`模块远程执行shell命令\n```\n#在指定目标minion节点运行uptime命令\n[root@salt-master ~]# salt 'salt-minion02' cmd.run 'uptime'\nsalt-minion02:\n     18:13:08 up 28 min,  2 users,  load average: 0.00, 0.04, 0.13\n```\n## Saltstack配置管理\n<div class=\"note success\"><p>`Salt` 通过`State`模块来进行文件的管理；通过`YAML`语法来描述，后缀是`.sls`的文件</p></div>1、了解 `YAML` 参考：http://docs.saltstack.cn/topics/yaml/index.html\n```\nremove vim:\n  pkg.removed:\n    - name: vim\n```\n- 带有ID和每个函数调用的行都以冒号（:)结束。\n- 每个函数调用在ID下面缩进两个空格。\n- 参数作为列表传递给每个函数。\n- 每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。\n- 如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。\n- 如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格\n\n2、配置`sals` ,定义环境   [参考文档](https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md)\n```\n# 定义环境目录\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n# 创建上面定义的目录\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n# 重启服务\n[root@salt-master ~]# systemctl restart salt-master\n```\n3、编写第一个`sls`文件\n```\n# 在base环境下编写第一个安装apache的sls文件\n[root@salt-master ~]# cd /srv/salt/base/\n[root@salt-master base]# cat apache.sls \napache-install:\n  pkg.installed:\n    - name: httpd\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n# 在dev环境下编写一个安装ftp的sls文件\n[root@salt-master base]# cd /srv/salt/dev/\n[root@salt-master dev]# cat vsftpd.sls \nvsftpd-install:\n  pkg.installed:\n    - name: vsftpd\n\nvsftpd-service:\n  service.running:\n    - name: vsftpd\n    - enable: True\n```\n4、使用`salt`命令的`state`状态模块让`minion`应用配置\n```\n# 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）\n[root@salt-master ~]# salt '*' state.sls apache\n\n# 让所有的minion都安装vsftpd（saltenv指定环境）\n[root@salt-master ~]# salt '*' state.sls vsftpd saltenv=dev\n```\n5、使用`salt`的高级状态使不同主机应用不同的配置\n```\n# topfile入口文件只能放在base环境\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nbase:\n  'salt-minion01':\n    - apache\n  'salt-minion03':\n    - apache\ndev:\n  'salt-minion02':\n    - vsftpd\n  'salt-minion03':\n    - vsftpd\n```\n6、使用`salt`命令执行高级状态，会将`top.sls`当做入口文件，进行调用\n```\n# 将高级状态应用到所有主机\n[root@salt-master ~]# salt '*' state.highstate\n```\n## Saltstack常用配置\n1、**Salt Master配置**\n`Salt Master`端的配置文件`/etc/salt/master`，常用配置如下：\n```\ninterface: \t//指定bind 的地址(默认为0.0.0.0)\npublish_port: //指定发布端口(默认为4505)\nret_port: //指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)\nuser: //指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)\ntimeout: //指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)\nkeep_jobs: //minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)\njob_cache: //master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)\nfile_recv : //是否允许minion传送文件到master 上(默认是Flase)\nfile_roots: //指定file server目录,  默认为:\n    file_roots:    \n       base:    \n        - /srv/salt     \npillar_roots : //指定pillar 目录,  默认为:\n    pillar_roots:     \n      base:     \n        - /srv/pillar     \nlog_level: //日志级别\n支持的日志级别有'garbage', 'trace', 'debug', info', 'warning', 'error', ‘critical ’ ( 默认为’warning’)\n```\n2、`Salt Minion`端的配置文件`/etc/salt/minion`，常用配置如下：\n```\nmaster: //指定master 主机(默认为salt)\nmaster_port: //指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)\nid: //指定本minion的标识, salt内部使用id作为标识(默认为主机名)\nuser: //指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)\ncache_jobs : //minion是否缓存执行结果(默认为False)\nbackup_mode: //在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效\nproviders : //指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5\nrenderer: //指定配置管理系统中的渲染器(默认值为:yaml_jinja )\nfile_client : //指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)\nloglevel: //指定日志级别(默认为warning)\ntcp_keepalive : //minion 是否与master 保持keepalive 检查, zeromq3(默认为True)\n```\n","source":"_posts/saltstack基本入门.md","raw":"---\ntitle: saltstack基本入门\ndate: 2019-05-13 15:47:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## saltstack介绍\n<div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n**主要功能**\n远程执行\n配置管理\n[Stalstack官方文档](http://docs.saltstack.cn/)\n## Saltstack原理\n>`Salt`使用`server-agent`通信模型，服务端组件被称为`Salt master`，`agent`被称为`Salt minion`\n`Salt master`主要负责向`Salt minions`发送命令，然后聚合并显示这些命令的结果。一个`Salt master`可以管理多个`minion`系统\n`Salt server`与`Salt minion`通信的连接由`Salt minion`发起，这也意味着`Salt minion`上不需要打开任何传入端口（从而减少攻击）。`Salt server`使用端口`4505`和`4506`，必须打开端口才能接收到访问连接\n\n![通信示例图](saltstack基本入门/01.png)\n\n- **Publisher** （端口4505）所有`Salt minions`都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。\n- **Request Server** （端口4506）`Salt minios`根据需要连接到请求服务器，将结果发送给`Salt master`，并安全地获取请求的文件或特定`minion`相关的数据值（称为`Salt pillar`）。连接到这个端口的连接在`Salt master`和`Salt minion`之间是1:1（不是异步）。\n\n```\n[root@salt-master ~]# lsof -i:4505\nCOMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nsalt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)\nsalt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505->salt-minion03:37240 (ESTABLISHED)\nsalt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505->salt-minion01:47804 (ESTABLISHED)\nsalt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505->salt-minion02:58594 (ESTABLISHED)\n```\n\n## 快速安装\n1.1 配置 yum 仓库\n```\n# 使用官方自带yum\n[root@salt-master ~]# yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm\n# 或者使用阿里云的yum（建议使用阿里云的，速度快一点）\n[root@salt-master ~]# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n[root@salt-master ~]# sed -i \"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\" /etc/yum.repos.d/salt-latest.repo\n[root@salt-master ~]# yum clean all\n[root@salt-master ~]# yum makecache\n```\n1.2 安装Master，并启动服务\n```\n[root@salt-master ~]# yum -y install salt-master\n[root@salt-master ~]# systemctl enable salt-master\n[root@salt-master ~]# systemctl start salt-master\n```\n1.3 安装 Salt-Minion 指向 Salt-Master 网络地址\n```\n[root@salt-minion01 ~]# yum -y install salt-minion\n# 可以使用主机名，也可以使用IP地址\n[root@salt-minion01 ~]# cp /etc/salt/minion{,.back}\n[root@salt-minion01 ~]# sed -i '/#master: /c\\master: salt-master' /etc/salt/minion\n[root@salt-minion01 ~]# systemctl enable salt-minion\n[root@salt-minion01 ~]# systemctl start salt-minion\n```\n##  SaltStack认证方式\n![master与minion之间的架构关系图](saltstack基本入门/02.png)\n<div class=\"note success\"><p> `Salt` 的数据传输是通过 `AES` 加密，`Master` 和 `Minion` 之前在通信之前，需要进行认证。\n`Salt` 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  `minion` 在第一次启动时候，会在 `/etc/salt/pki/minion/` 下自动生成 `minion.pem(private key)` 和 `minion.pub(public key) `, 然后将 `minion.pub` 发送给 `master `\n2. `master` 在第一次启动时，会在 `/etc/salt/pki/master/` 下自动生成 `master.pem` 和 `master.pub` ；并且会接收到 `minion` 的 `public key` , 通过 `salt-key` 命令接收 `minion public key`， 会在 `master` 的 `/etc/salt/pki/master/minions` 目录下存放以 `minion id` 命令的 `public key` ；验证成功后同时 `minion` 会保存一份 `master public key` 在 minion的 `/etc/salt/pki/minion/minion_master.pub`里。</p></div>\n\n**Salt认证原理总结**\n> `minion`将自己的公钥发送给`master`\n`master`认证后再将自己的公钥也发送给`minion`端\n\n**Master端认证示例**\n根据上面提到的认证原理，先看下未认证前的`master`和`minion`的`pki`目录\n```\n# master上查看\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   │   └── salt-minion01\n│   └── minions_rejected\n└── minion\n\n# minion上查看\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion.pem\n    └── minion.pub\n```\n`salt-key`命令解释：\n```\n[root@salt-master ~]# salt-key -L \nAccepted Keys:        #已经接受的key\nDenied Keys:          #拒绝的key\nUnaccepted Keys:      #未加入的key\nRejected Keys:        #吊销的key\n\n#常用参数\n-L  #查看KEY状态\n-A  #允许所有\n-D  #删除所有\n-a  #认证指定的key\n-d  #删除指定的key\n-r  #注销掉指定key（该状态为未被认证）\n\n#配置master自动接受请求认证(master上配置 /etc/salt/master)\nauto_accept: True\n```\n`salt-key`认证\n```\n#列出当前所有的key\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nDenied Keys:\nUnaccepted Keys:\nsalt-minion01\nRejected Keys:\n\n#添加指定minion的key\n[root@salt-master ~]# salt-key -a salt-minion01 -y\nThe following keys are going to be accepted:\nUnaccepted Keys:\nsalt-minion01\nKey for minion salt-minion01 accepted.\n#添加所有minion的key\n[root@salt-master ~]# salt-key -A -y\n\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nsalt-minion01\nDenied Keys:\nUnaccepted Keys:\nRejected Keys:\n```\n上面认证完成后再次查看`master`和`minion`的`pki`目录\n```\n# master上\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   │   └── salt-minion01\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   └── minions_rejected\n└── minion\n\n# minion上\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion_master.pub\n    ├── minion.pem\n    └── minion.pub\n```\n## Saltstack远程执行\n>远程执行是 `Saltstack` 的核心功能之一。主要使用 `salt` 模块批量给选定的 `minion` 端执行相应的命令，并获得返回结果。\n\n1、判断 `salt` 的 `minion` 主机是否存活\n```\n[root@salt-master ~]# salt '*' test.ping\nsalt-minion02:\n    True\nsalt-minion03:\n    True\nsalt-minion01:\n    True\n\n# salt saltstack自带的一个命令\n# * 表示目标主机，这里表示所有目标主机\n# test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法\n```\n2、`saltstack`使用 `cmd.run`模块远程执行shell命令\n```\n#在指定目标minion节点运行uptime命令\n[root@salt-master ~]# salt 'salt-minion02' cmd.run 'uptime'\nsalt-minion02:\n     18:13:08 up 28 min,  2 users,  load average: 0.00, 0.04, 0.13\n```\n## Saltstack配置管理\n<div class=\"note success\"><p>`Salt` 通过`State`模块来进行文件的管理；通过`YAML`语法来描述，后缀是`.sls`的文件</p></div>1、了解 `YAML` 参考：http://docs.saltstack.cn/topics/yaml/index.html\n```\nremove vim:\n  pkg.removed:\n    - name: vim\n```\n- 带有ID和每个函数调用的行都以冒号（:)结束。\n- 每个函数调用在ID下面缩进两个空格。\n- 参数作为列表传递给每个函数。\n- 每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。\n- 如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。\n- 如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格\n\n2、配置`sals` ,定义环境   [参考文档](https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md)\n```\n# 定义环境目录\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n# 创建上面定义的目录\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n# 重启服务\n[root@salt-master ~]# systemctl restart salt-master\n```\n3、编写第一个`sls`文件\n```\n# 在base环境下编写第一个安装apache的sls文件\n[root@salt-master ~]# cd /srv/salt/base/\n[root@salt-master base]# cat apache.sls \napache-install:\n  pkg.installed:\n    - name: httpd\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n# 在dev环境下编写一个安装ftp的sls文件\n[root@salt-master base]# cd /srv/salt/dev/\n[root@salt-master dev]# cat vsftpd.sls \nvsftpd-install:\n  pkg.installed:\n    - name: vsftpd\n\nvsftpd-service:\n  service.running:\n    - name: vsftpd\n    - enable: True\n```\n4、使用`salt`命令的`state`状态模块让`minion`应用配置\n```\n# 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）\n[root@salt-master ~]# salt '*' state.sls apache\n\n# 让所有的minion都安装vsftpd（saltenv指定环境）\n[root@salt-master ~]# salt '*' state.sls vsftpd saltenv=dev\n```\n5、使用`salt`的高级状态使不同主机应用不同的配置\n```\n# topfile入口文件只能放在base环境\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nbase:\n  'salt-minion01':\n    - apache\n  'salt-minion03':\n    - apache\ndev:\n  'salt-minion02':\n    - vsftpd\n  'salt-minion03':\n    - vsftpd\n```\n6、使用`salt`命令执行高级状态，会将`top.sls`当做入口文件，进行调用\n```\n# 将高级状态应用到所有主机\n[root@salt-master ~]# salt '*' state.highstate\n```\n## Saltstack常用配置\n1、**Salt Master配置**\n`Salt Master`端的配置文件`/etc/salt/master`，常用配置如下：\n```\ninterface: \t//指定bind 的地址(默认为0.0.0.0)\npublish_port: //指定发布端口(默认为4505)\nret_port: //指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)\nuser: //指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)\ntimeout: //指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)\nkeep_jobs: //minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)\njob_cache: //master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)\nfile_recv : //是否允许minion传送文件到master 上(默认是Flase)\nfile_roots: //指定file server目录,  默认为:\n    file_roots:    \n       base:    \n        - /srv/salt     \npillar_roots : //指定pillar 目录,  默认为:\n    pillar_roots:     \n      base:     \n        - /srv/pillar     \nlog_level: //日志级别\n支持的日志级别有'garbage', 'trace', 'debug', info', 'warning', 'error', ‘critical ’ ( 默认为’warning’)\n```\n2、`Salt Minion`端的配置文件`/etc/salt/minion`，常用配置如下：\n```\nmaster: //指定master 主机(默认为salt)\nmaster_port: //指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)\nid: //指定本minion的标识, salt内部使用id作为标识(默认为主机名)\nuser: //指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)\ncache_jobs : //minion是否缓存执行结果(默认为False)\nbackup_mode: //在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效\nproviders : //指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5\nrenderer: //指定配置管理系统中的渲染器(默认值为:yaml_jinja )\nfile_client : //指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)\nloglevel: //指定日志级别(默认为warning)\ntcp_keepalive : //minion 是否与master 保持keepalive 检查, zeromq3(默认为True)\n```\n","slug":"saltstack基本入门","published":1,"updated":"2019-05-28T13:43:07.955Z","_id":"cjxwlqrnq0024lctcyia0ow5a","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"saltstack介绍\"><a href=\"#saltstack介绍\" class=\"headerlink\" title=\"saltstack介绍\"></a>saltstack介绍</h2><div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n<p><strong>主要功能</strong><br>远程执行<br>配置管理<br><a href=\"http://docs.saltstack.cn/\" target=\"_blank\" rel=\"noopener\">Stalstack官方文档</a></p>\n<h2 id=\"Saltstack原理\"><a href=\"#Saltstack原理\" class=\"headerlink\" title=\"Saltstack原理\"></a>Saltstack原理</h2><blockquote>\n<p><code>Salt</code>使用<code>server-agent</code>通信模型，服务端组件被称为<code>Salt master</code>，<code>agent</code>被称为<code>Salt minion</code><br><code>Salt master</code>主要负责向<code>Salt minions</code>发送命令，然后聚合并显示这些命令的结果。一个<code>Salt master</code>可以管理多个<code>minion</code>系统<br><code>Salt server</code>与<code>Salt minion</code>通信的连接由<code>Salt minion</code>发起，这也意味着<code>Salt minion</code>上不需要打开任何传入端口（从而减少攻击）。<code>Salt server</code>使用端口<code>4505</code>和<code>4506</code>，必须打开端口才能接收到访问连接</p>\n</blockquote>\n<p><img src=\"/2019/05/13/saltstack基本入门/01.png\" alt=\"通信示例图\"></p>\n<ul>\n<li><strong>Publisher</strong> （端口4505）所有<code>Salt minions</code>都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。</li>\n<li><strong>Request Server</strong> （端口4506）<code>Salt minios</code>根据需要连接到请求服务器，将结果发送给<code>Salt master</code>，并安全地获取请求的文件或特定<code>minion</code>相关的数据值（称为<code>Salt pillar</code>）。连接到这个端口的连接在<code>Salt master</code>和<code>Salt minion</code>之间是1:1（不是异步）。</li>\n</ul>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# lsof -i:4505</span><br><span class=\"line\">COMMAND     PID<span class=\"built_in\"> USER </span>  FD  <span class=\"built_in\"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">salt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)</span><br><span class=\"line\">salt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505-&gt;salt-minion03:37240 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505-&gt;salt-minion01:47804 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505-&gt;salt-minion02:58594 (ESTABLISHED)</span><br></pre></td></tr></table></figure>\n<h2 id=\"快速安装\"><a href=\"#快速安装\" class=\"headerlink\" title=\"快速安装\"></a>快速安装</h2><p>1.1 配置 yum 仓库<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用官方自带yum</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm</span><br><span class=\"line\"><span class=\"comment\"># 或者使用阿里云的yum（建议使用阿里云的，速度快一点）</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class=\"number\">2</span>.el7.noarch.rpm</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# sed</span> -i <span class=\"string\">\"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> clean all</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> makecache</span><br></pre></td></tr></table></figure></p>\n<p>1.2 安装Master，并启动服务<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> enable salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>1.3 安装 Salt-Minion 指向 Salt-Master 网络地址<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># yum -y install salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># 可以使用主机名，也可以使用IP地址</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># sed -i <span class=\"string\">'/#master: /c\\master: salt-master'</span> /etc/salt/minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl enable salt-minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"SaltStack认证方式\"><a href=\"#SaltStack认证方式\" class=\"headerlink\" title=\"SaltStack认证方式\"></a>SaltStack认证方式</h2><p><img src=\"/2019/05/13/saltstack基本入门/02.png\" alt=\"master与minion之间的架构关系图\"></p>\n<div class=\"note success\"><p> <code>Salt</code> 的数据传输是通过 <code>AES</code> 加密，<code>Master</code> 和 <code>Minion</code> 之前在通信之前，需要进行认证。<br><code>Salt</code> 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  <code>minion</code> 在第一次启动时候，会在 <code>/etc/salt/pki/minion/</code> 下自动生成 <code>minion.pem(private key)</code> 和 <code>minion.pub(public key)</code>, 然后将 <code>minion.pub</code> 发送给 <code>master</code><br>2. <code>master</code> 在第一次启动时，会在 <code>/etc/salt/pki/master/</code> 下自动生成 <code>master.pem</code> 和 <code>master.pub</code> ；并且会接收到 <code>minion</code> 的 <code>public key</code> , 通过 <code>salt-key</code> 命令接收 <code>minion public key</code>， 会在 <code>master</code> 的 <code>/etc/salt/pki/master/minions</code> 目录下存放以 <code>minion id</code> 命令的 <code>public key</code> ；验证成功后同时 <code>minion</code> 会保存一份 <code>master public key</code> 在 minion的 <code>/etc/salt/pki/minion/minion_master.pub</code>里。</p></div>\n\n<p><strong>Salt认证原理总结</strong></p>\n<blockquote>\n<p><code>minion</code>将自己的公钥发送给<code>master</code><br><code>master</code>认证后再将自己的公钥也发送给<code>minion</code>端</p>\n</blockquote>\n<p><strong>Master端认证示例</strong><br>根据上面提到的认证原理，先看下未认证前的<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上查看</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上查看</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>命令解释：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-key</span> <span class=\"bullet\">-L</span> </span><br><span class=\"line\"><span class=\"string\">Accepted</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#已经接受的key</span></span><br><span class=\"line\"><span class=\"string\">Denied</span> <span class=\"attr\">Keys:</span>          <span class=\"comment\">#拒绝的key</span></span><br><span class=\"line\"><span class=\"string\">Unaccepted</span> <span class=\"attr\">Keys:</span>      <span class=\"comment\">#未加入的key</span></span><br><span class=\"line\"><span class=\"string\">Rejected</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#吊销的key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#常用参数</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">L</span>  <span class=\"comment\">#查看KEY状态</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">A</span>  <span class=\"comment\">#允许所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">D</span>  <span class=\"comment\">#删除所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">a</span>  <span class=\"comment\">#认证指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">d</span>  <span class=\"comment\">#删除指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">r</span>  <span class=\"comment\">#注销掉指定key（该状态为未被认证）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置master自动接受请求认证(master上配置 /etc/salt/master)</span></span><br><span class=\"line\"><span class=\"attr\">auto_accept:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>认证<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#列出当前所有的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加指定minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -a salt-minion01 -y</span><br><span class=\"line\">The following keys are going to be accepted:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Key for minion salt-minion01 accepted.</span><br><span class=\"line\"><span class=\"comment\">#添加所有minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -A -y</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">Rejected Keys:</span><br></pre></td></tr></table></figure></p>\n<p>上面认证完成后再次查看<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion_master.pub</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack远程执行\"><a href=\"#Saltstack远程执行\" class=\"headerlink\" title=\"Saltstack远程执行\"></a>Saltstack远程执行</h2><blockquote>\n<p>远程执行是 <code>Saltstack</code> 的核心功能之一。主要使用 <code>salt</code> 模块批量给选定的 <code>minion</code> 端执行相应的命令，并获得返回结果。</p>\n</blockquote>\n<p>1、判断 <code>salt</code> 的 <code>minion</code> 主机是否存活<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt</span> <span class=\"string\">'*'</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion03:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># salt saltstack自带的一个命令</span></span><br><span class=\"line\"><span class=\"comment\"># * 表示目标主机，这里表示所有目标主机</span></span><br><span class=\"line\"><span class=\"comment\"># test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法</span></span><br></pre></td></tr></table></figure></p>\n<p>2、<code>saltstack</code>使用 <code>cmd.run</code>模块远程执行shell命令<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#在指定目标minion节点运行uptime命令</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion02'</span> cmd.run <span class=\"string\">'uptime'</span></span></span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">     <span class=\"number\">18</span>:<span class=\"number\">13</span>:<span class=\"number\">08</span> up <span class=\"number\">28</span> min,  <span class=\"number\">2</span> users,  load average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.13</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack配置管理\"><a href=\"#Saltstack配置管理\" class=\"headerlink\" title=\"Saltstack配置管理\"></a>Saltstack配置管理</h2><p><div class=\"note success\"><p><code>Salt</code> 通过<code>State</code>模块来进行文件的管理；通过<code>YAML</code>语法来描述，后缀是<code>.sls</code>的文件</p></div>1、了解 <code>YAML</code> 参考：<a href=\"http://docs.saltstack.cn/topics/yaml/index.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/yaml/index.html</a><br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">remove <span class=\"string\">vim:</span></span><br><span class=\"line\">  pkg.<span class=\"string\">removed:</span></span><br><span class=\"line\">    - <span class=\"string\">name:</span> vim</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>带有ID和每个函数调用的行都以冒号（:)结束。</li>\n<li>每个函数调用在ID下面缩进两个空格。</li>\n<li>参数作为列表传递给每个函数。</li>\n<li>每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。</li>\n<li>如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。</li>\n<li>如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格</li>\n</ul>\n<p>2、配置<code>sals</code> ,定义环境   <a href=\"https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md\" target=\"_blank\" rel=\"noopener\">参考文档</a><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义环境目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">file_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/salt/base</span><br><span class=\"line\">  dev:</span><br><span class=\"line\">    - /srv/salt/dev</span><br><span class=\"line\">  prod:</span><br><span class=\"line\">    - /srv/salt/prod</span><br><span class=\"line\"><span class=\"comment\"># 创建上面定义的目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\"><span class=\"comment\"># 重启服务</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>3、编写第一个<code>sls</code>文件<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在base环境下编写第一个安装apache的sls文件</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cd /srv/salt/base/</span></span><br><span class=\"line\">[root@salt-master base]<span class=\"comment\"># cat apache.sls </span></span><br><span class=\"line\">apache-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在dev环境下编写一个安装ftp的sls文件</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> base]<span class=\"comment\"># cd /srv/salt/dev/</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> dev]<span class=\"comment\"># cat vsftpd.sls </span></span><br><span class=\"line\">vsftpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\"></span><br><span class=\"line\">vsftpd-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4、使用<code>salt</code>命令的<code>state</code>状态模块让<code>minion</code>应用配置<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls apache</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装vsftpd（saltenv指定环境）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls vsftpd saltenv=dev</span></span><br></pre></td></tr></table></figure></p>\n<p>5、使用<code>salt</code>的高级状态使不同主机应用不同的配置<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># topfile入口文件只能放在base环境</span></span><br><span class=\"line\">[<span class=\"meta\">root@salt-master ~</span>]<span class=\"meta\"># cat /srv/salt/base/top.sls </span></span><br><span class=\"line\"><span class=\"keyword\">base</span>:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion01'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">dev:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion02'</span>:</span><br><span class=\"line\">    - vsftpd</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - vsftpd</span><br></pre></td></tr></table></figure></p>\n<p>6、使用<code>salt</code>命令执行高级状态，会将<code>top.sls</code>当做入口文件，进行调用<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 将高级状态应用到所有主机</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack常用配置\"><a href=\"#Saltstack常用配置\" class=\"headerlink\" title=\"Saltstack常用配置\"></a>Saltstack常用配置</h2><p>1、<strong>Salt Master配置</strong><br><code>Salt Master</code>端的配置文件<code>/etc/salt/master</code>，常用配置如下：<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">interface</span>: \t<span class=\"comment\">//指定bind 的地址(默认为0.0.0.0)</span></span><br><span class=\"line\"><span class=\"attribute\">publish_port</span>: <span class=\"comment\">//指定发布端口(默认为4505)</span></span><br><span class=\"line\"><span class=\"attribute\">ret_port</span>: <span class=\"comment\">//指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"attribute\">user</span>: <span class=\"comment\">//指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)</span></span><br><span class=\"line\"><span class=\"attribute\">timeout</span>: <span class=\"comment\">//指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)</span></span><br><span class=\"line\"><span class=\"attribute\">keep_jobs</span>: <span class=\"comment\">//minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)</span></span><br><span class=\"line\"><span class=\"attribute\">job_cache</span>: <span class=\"comment\">//master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)</span></span><br><span class=\"line\"><span class=\"attribute\">file_recv </span>: <span class=\"comment\">//是否允许minion传送文件到master 上(默认是Flase)</span></span><br><span class=\"line\"><span class=\"attribute\">file_roots</span>: <span class=\"comment\">//指定file server目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">file_roots</span>:    </span><br><span class=\"line\">       <span class=\"attribute\">base</span>:    </span><br><span class=\"line\">        - /srv/salt     </span><br><span class=\"line\"><span class=\"attribute\">pillar_roots </span>: <span class=\"comment\">//指定pillar 目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">pillar_roots</span>:     </span><br><span class=\"line\">      <span class=\"attribute\">base</span>:     </span><br><span class=\"line\">        - /srv/pillar     </span><br><span class=\"line\"><span class=\"attribute\">log_level</span>: <span class=\"comment\">//日志级别</span></span><br><span class=\"line\">支持的日志级别有<span class=\"string\">'garbage'</span>, <span class=\"string\">'trace'</span>, <span class=\"string\">'debug'</span>, info<span class=\"string\">', '</span>warning<span class=\"string\">', '</span>error', ‘critical ’ ( 默认为’warning’)</span><br></pre></td></tr></table></figure></p>\n<p>2、<code>Salt Minion</code>端的配置文件<code>/etc/salt/minion</code>，常用配置如下：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">master:</span> <span class=\"comment\">//指定master 主机(默认为salt)</span></span><br><span class=\"line\"><span class=\"string\">master_port:</span> <span class=\"comment\">//指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"string\">id:</span> <span class=\"comment\">//指定本minion的标识, salt内部使用id作为标识(默认为主机名)</span></span><br><span class=\"line\"><span class=\"string\">user:</span> <span class=\"comment\">//指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)</span></span><br><span class=\"line\"><span class=\"string\">cache_jobs :</span> <span class=\"comment\">//minion是否缓存执行结果(默认为False)</span></span><br><span class=\"line\"><span class=\"string\">backup_mode:</span> <span class=\"comment\">//在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效</span></span><br><span class=\"line\"><span class=\"string\">providers :</span> <span class=\"comment\">//指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5</span></span><br><span class=\"line\"><span class=\"string\">renderer:</span> <span class=\"comment\">//指定配置管理系统中的渲染器(默认值为:yaml_jinja )</span></span><br><span class=\"line\"><span class=\"string\">file_client :</span> <span class=\"comment\">//指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)</span></span><br><span class=\"line\"><span class=\"string\">loglevel:</span> <span class=\"comment\">//指定日志级别(默认为warning)</span></span><br><span class=\"line\"><span class=\"string\">tcp_keepalive :</span> <span class=\"comment\">//minion 是否与master 保持keepalive 检查, zeromq3(默认为True)</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"saltstack介绍\"><a href=\"#saltstack介绍\" class=\"headerlink\" title=\"saltstack介绍\"></a>saltstack介绍</h2><div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n<p><strong>主要功能</strong><br>远程执行<br>配置管理<br><a href=\"http://docs.saltstack.cn/\" target=\"_blank\" rel=\"noopener\">Stalstack官方文档</a></p>\n<h2 id=\"Saltstack原理\"><a href=\"#Saltstack原理\" class=\"headerlink\" title=\"Saltstack原理\"></a>Saltstack原理</h2><blockquote>\n<p><code>Salt</code>使用<code>server-agent</code>通信模型，服务端组件被称为<code>Salt master</code>，<code>agent</code>被称为<code>Salt minion</code><br><code>Salt master</code>主要负责向<code>Salt minions</code>发送命令，然后聚合并显示这些命令的结果。一个<code>Salt master</code>可以管理多个<code>minion</code>系统<br><code>Salt server</code>与<code>Salt minion</code>通信的连接由<code>Salt minion</code>发起，这也意味着<code>Salt minion</code>上不需要打开任何传入端口（从而减少攻击）。<code>Salt server</code>使用端口<code>4505</code>和<code>4506</code>，必须打开端口才能接收到访问连接</p>\n</blockquote>\n<p><img src=\"/2019/05/13/saltstack基本入门/01.png\" alt=\"通信示例图\"></p>\n<ul>\n<li><strong>Publisher</strong> （端口4505）所有<code>Salt minions</code>都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。</li>\n<li><strong>Request Server</strong> （端口4506）<code>Salt minios</code>根据需要连接到请求服务器，将结果发送给<code>Salt master</code>，并安全地获取请求的文件或特定<code>minion</code>相关的数据值（称为<code>Salt pillar</code>）。连接到这个端口的连接在<code>Salt master</code>和<code>Salt minion</code>之间是1:1（不是异步）。</li>\n</ul>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# lsof -i:4505</span><br><span class=\"line\">COMMAND     PID<span class=\"built_in\"> USER </span>  FD  <span class=\"built_in\"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">salt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)</span><br><span class=\"line\">salt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505-&gt;salt-minion03:37240 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505-&gt;salt-minion01:47804 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505-&gt;salt-minion02:58594 (ESTABLISHED)</span><br></pre></td></tr></table></figure>\n<h2 id=\"快速安装\"><a href=\"#快速安装\" class=\"headerlink\" title=\"快速安装\"></a>快速安装</h2><p>1.1 配置 yum 仓库<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用官方自带yum</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm</span><br><span class=\"line\"><span class=\"comment\"># 或者使用阿里云的yum（建议使用阿里云的，速度快一点）</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class=\"number\">2</span>.el7.noarch.rpm</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# sed</span> -i <span class=\"string\">\"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> clean all</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> makecache</span><br></pre></td></tr></table></figure></p>\n<p>1.2 安装Master，并启动服务<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> enable salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>1.3 安装 Salt-Minion 指向 Salt-Master 网络地址<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># yum -y install salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># 可以使用主机名，也可以使用IP地址</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># sed -i <span class=\"string\">'/#master: /c\\master: salt-master'</span> /etc/salt/minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl enable salt-minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"SaltStack认证方式\"><a href=\"#SaltStack认证方式\" class=\"headerlink\" title=\"SaltStack认证方式\"></a>SaltStack认证方式</h2><p><img src=\"/2019/05/13/saltstack基本入门/02.png\" alt=\"master与minion之间的架构关系图\"></p>\n<div class=\"note success\"><p> <code>Salt</code> 的数据传输是通过 <code>AES</code> 加密，<code>Master</code> 和 <code>Minion</code> 之前在通信之前，需要进行认证。<br><code>Salt</code> 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  <code>minion</code> 在第一次启动时候，会在 <code>/etc/salt/pki/minion/</code> 下自动生成 <code>minion.pem(private key)</code> 和 <code>minion.pub(public key)</code>, 然后将 <code>minion.pub</code> 发送给 <code>master</code><br>2. <code>master</code> 在第一次启动时，会在 <code>/etc/salt/pki/master/</code> 下自动生成 <code>master.pem</code> 和 <code>master.pub</code> ；并且会接收到 <code>minion</code> 的 <code>public key</code> , 通过 <code>salt-key</code> 命令接收 <code>minion public key</code>， 会在 <code>master</code> 的 <code>/etc/salt/pki/master/minions</code> 目录下存放以 <code>minion id</code> 命令的 <code>public key</code> ；验证成功后同时 <code>minion</code> 会保存一份 <code>master public key</code> 在 minion的 <code>/etc/salt/pki/minion/minion_master.pub</code>里。</p></div>\n\n<p><strong>Salt认证原理总结</strong></p>\n<blockquote>\n<p><code>minion</code>将自己的公钥发送给<code>master</code><br><code>master</code>认证后再将自己的公钥也发送给<code>minion</code>端</p>\n</blockquote>\n<p><strong>Master端认证示例</strong><br>根据上面提到的认证原理，先看下未认证前的<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上查看</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上查看</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>命令解释：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-key</span> <span class=\"bullet\">-L</span> </span><br><span class=\"line\"><span class=\"string\">Accepted</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#已经接受的key</span></span><br><span class=\"line\"><span class=\"string\">Denied</span> <span class=\"attr\">Keys:</span>          <span class=\"comment\">#拒绝的key</span></span><br><span class=\"line\"><span class=\"string\">Unaccepted</span> <span class=\"attr\">Keys:</span>      <span class=\"comment\">#未加入的key</span></span><br><span class=\"line\"><span class=\"string\">Rejected</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#吊销的key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#常用参数</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">L</span>  <span class=\"comment\">#查看KEY状态</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">A</span>  <span class=\"comment\">#允许所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">D</span>  <span class=\"comment\">#删除所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">a</span>  <span class=\"comment\">#认证指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">d</span>  <span class=\"comment\">#删除指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">r</span>  <span class=\"comment\">#注销掉指定key（该状态为未被认证）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置master自动接受请求认证(master上配置 /etc/salt/master)</span></span><br><span class=\"line\"><span class=\"attr\">auto_accept:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>认证<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#列出当前所有的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加指定minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -a salt-minion01 -y</span><br><span class=\"line\">The following keys are going to be accepted:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Key for minion salt-minion01 accepted.</span><br><span class=\"line\"><span class=\"comment\">#添加所有minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -A -y</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">Rejected Keys:</span><br></pre></td></tr></table></figure></p>\n<p>上面认证完成后再次查看<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion_master.pub</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack远程执行\"><a href=\"#Saltstack远程执行\" class=\"headerlink\" title=\"Saltstack远程执行\"></a>Saltstack远程执行</h2><blockquote>\n<p>远程执行是 <code>Saltstack</code> 的核心功能之一。主要使用 <code>salt</code> 模块批量给选定的 <code>minion</code> 端执行相应的命令，并获得返回结果。</p>\n</blockquote>\n<p>1、判断 <code>salt</code> 的 <code>minion</code> 主机是否存活<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt</span> <span class=\"string\">'*'</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion03:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># salt saltstack自带的一个命令</span></span><br><span class=\"line\"><span class=\"comment\"># * 表示目标主机，这里表示所有目标主机</span></span><br><span class=\"line\"><span class=\"comment\"># test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法</span></span><br></pre></td></tr></table></figure></p>\n<p>2、<code>saltstack</code>使用 <code>cmd.run</code>模块远程执行shell命令<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#在指定目标minion节点运行uptime命令</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion02'</span> cmd.run <span class=\"string\">'uptime'</span></span></span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">     <span class=\"number\">18</span>:<span class=\"number\">13</span>:<span class=\"number\">08</span> up <span class=\"number\">28</span> min,  <span class=\"number\">2</span> users,  load average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.13</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack配置管理\"><a href=\"#Saltstack配置管理\" class=\"headerlink\" title=\"Saltstack配置管理\"></a>Saltstack配置管理</h2><p><div class=\"note success\"><p><code>Salt</code> 通过<code>State</code>模块来进行文件的管理；通过<code>YAML</code>语法来描述，后缀是<code>.sls</code>的文件</p></div>1、了解 <code>YAML</code> 参考：<a href=\"http://docs.saltstack.cn/topics/yaml/index.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/yaml/index.html</a><br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">remove <span class=\"string\">vim:</span></span><br><span class=\"line\">  pkg.<span class=\"string\">removed:</span></span><br><span class=\"line\">    - <span class=\"string\">name:</span> vim</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>带有ID和每个函数调用的行都以冒号（:)结束。</li>\n<li>每个函数调用在ID下面缩进两个空格。</li>\n<li>参数作为列表传递给每个函数。</li>\n<li>每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。</li>\n<li>如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。</li>\n<li>如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格</li>\n</ul>\n<p>2、配置<code>sals</code> ,定义环境   <a href=\"https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md\" target=\"_blank\" rel=\"noopener\">参考文档</a><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义环境目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">file_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/salt/base</span><br><span class=\"line\">  dev:</span><br><span class=\"line\">    - /srv/salt/dev</span><br><span class=\"line\">  prod:</span><br><span class=\"line\">    - /srv/salt/prod</span><br><span class=\"line\"><span class=\"comment\"># 创建上面定义的目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\"><span class=\"comment\"># 重启服务</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>3、编写第一个<code>sls</code>文件<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在base环境下编写第一个安装apache的sls文件</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cd /srv/salt/base/</span></span><br><span class=\"line\">[root@salt-master base]<span class=\"comment\"># cat apache.sls </span></span><br><span class=\"line\">apache-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在dev环境下编写一个安装ftp的sls文件</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> base]<span class=\"comment\"># cd /srv/salt/dev/</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> dev]<span class=\"comment\"># cat vsftpd.sls </span></span><br><span class=\"line\">vsftpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\"></span><br><span class=\"line\">vsftpd-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4、使用<code>salt</code>命令的<code>state</code>状态模块让<code>minion</code>应用配置<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls apache</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装vsftpd（saltenv指定环境）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls vsftpd saltenv=dev</span></span><br></pre></td></tr></table></figure></p>\n<p>5、使用<code>salt</code>的高级状态使不同主机应用不同的配置<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># topfile入口文件只能放在base环境</span></span><br><span class=\"line\">[<span class=\"meta\">root@salt-master ~</span>]<span class=\"meta\"># cat /srv/salt/base/top.sls </span></span><br><span class=\"line\"><span class=\"keyword\">base</span>:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion01'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">dev:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion02'</span>:</span><br><span class=\"line\">    - vsftpd</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - vsftpd</span><br></pre></td></tr></table></figure></p>\n<p>6、使用<code>salt</code>命令执行高级状态，会将<code>top.sls</code>当做入口文件，进行调用<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 将高级状态应用到所有主机</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack常用配置\"><a href=\"#Saltstack常用配置\" class=\"headerlink\" title=\"Saltstack常用配置\"></a>Saltstack常用配置</h2><p>1、<strong>Salt Master配置</strong><br><code>Salt Master</code>端的配置文件<code>/etc/salt/master</code>，常用配置如下：<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">interface</span>: \t<span class=\"comment\">//指定bind 的地址(默认为0.0.0.0)</span></span><br><span class=\"line\"><span class=\"attribute\">publish_port</span>: <span class=\"comment\">//指定发布端口(默认为4505)</span></span><br><span class=\"line\"><span class=\"attribute\">ret_port</span>: <span class=\"comment\">//指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"attribute\">user</span>: <span class=\"comment\">//指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)</span></span><br><span class=\"line\"><span class=\"attribute\">timeout</span>: <span class=\"comment\">//指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)</span></span><br><span class=\"line\"><span class=\"attribute\">keep_jobs</span>: <span class=\"comment\">//minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)</span></span><br><span class=\"line\"><span class=\"attribute\">job_cache</span>: <span class=\"comment\">//master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)</span></span><br><span class=\"line\"><span class=\"attribute\">file_recv </span>: <span class=\"comment\">//是否允许minion传送文件到master 上(默认是Flase)</span></span><br><span class=\"line\"><span class=\"attribute\">file_roots</span>: <span class=\"comment\">//指定file server目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">file_roots</span>:    </span><br><span class=\"line\">       <span class=\"attribute\">base</span>:    </span><br><span class=\"line\">        - /srv/salt     </span><br><span class=\"line\"><span class=\"attribute\">pillar_roots </span>: <span class=\"comment\">//指定pillar 目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">pillar_roots</span>:     </span><br><span class=\"line\">      <span class=\"attribute\">base</span>:     </span><br><span class=\"line\">        - /srv/pillar     </span><br><span class=\"line\"><span class=\"attribute\">log_level</span>: <span class=\"comment\">//日志级别</span></span><br><span class=\"line\">支持的日志级别有<span class=\"string\">'garbage'</span>, <span class=\"string\">'trace'</span>, <span class=\"string\">'debug'</span>, info<span class=\"string\">', '</span>warning<span class=\"string\">', '</span>error', ‘critical ’ ( 默认为’warning’)</span><br></pre></td></tr></table></figure></p>\n<p>2、<code>Salt Minion</code>端的配置文件<code>/etc/salt/minion</code>，常用配置如下：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">master:</span> <span class=\"comment\">//指定master 主机(默认为salt)</span></span><br><span class=\"line\"><span class=\"string\">master_port:</span> <span class=\"comment\">//指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"string\">id:</span> <span class=\"comment\">//指定本minion的标识, salt内部使用id作为标识(默认为主机名)</span></span><br><span class=\"line\"><span class=\"string\">user:</span> <span class=\"comment\">//指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)</span></span><br><span class=\"line\"><span class=\"string\">cache_jobs :</span> <span class=\"comment\">//minion是否缓存执行结果(默认为False)</span></span><br><span class=\"line\"><span class=\"string\">backup_mode:</span> <span class=\"comment\">//在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效</span></span><br><span class=\"line\"><span class=\"string\">providers :</span> <span class=\"comment\">//指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5</span></span><br><span class=\"line\"><span class=\"string\">renderer:</span> <span class=\"comment\">//指定配置管理系统中的渲染器(默认值为:yaml_jinja )</span></span><br><span class=\"line\"><span class=\"string\">file_client :</span> <span class=\"comment\">//指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)</span></span><br><span class=\"line\"><span class=\"string\">loglevel:</span> <span class=\"comment\">//指定日志级别(默认为warning)</span></span><br><span class=\"line\"><span class=\"string\">tcp_keepalive :</span> <span class=\"comment\">//minion 是否与master 保持keepalive 检查, zeromq3(默认为True)</span></span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack配置管理","date":"2019-05-15T15:42:05.000Z","copyright":true,"_content":"## Saltstack状态模块\n>远程执行模块的执行是过程式，而状态是对`minion`的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述`minion`的状态描述。\n它的和兴是写`sls(Salt State file)`文件，`sls`文件默认格式为`YAML`格式，并默认使用`jinja`模板，`jinja`是根据`django`的模板语言发展而来的语言，简单并强大，支持`for if `等循环语句。`salt state`主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。\n\n```\nmysql-install:   #ID声明，必须唯一\n  pkg.installed:   #state状态声明\n    - pkgs:   #选项声明\n      - mariadb:   #选项列表\n      - mariadb-server\n\n说明：\n一个ID只能出现一次\n一个ID下相同模块只能使用一次\n一个ID下不可以使用多个不同模块\n```\n模块帮助手册\n```\n#列出所有状态模块\n[root@salt-master ~]# salt '*' sys.list_modules\n#查看指定模块的所有方法\n[root@salt-master ~]# salt '*' sys.list_state_functions pkg\n#查看指定模块的使用方法\n[root@salt-master ~]# salt '*' sys.state_doc pkg\n#查看指定模块的指定方法的用法\n[root@salt-master ~]# salt '*' sys.state_doc pkg.installed\n```\n### pkg软件模块\n[pkg模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html)\n`pkg.installed` 软件安装\n```\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql: \">=5.4.16\"    #指定安装版本\n      - php-pdo\n      - php-cli\n```\n指定安装最新版本的软件\n```\nphp-install:\n  pkg.latest:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n```\n### file文件模块\n[file模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html)\n`file.managed` 下发文件，确保文件存在\n```\n[root@salt-master ~]# mkdir /srv/salt/base/files\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/base/files/\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\n说明：\n- name: 表示存放目的地址\n- source: 表示这个文件来自哪里（说明这个文件得提前准备）\n\n或者这样写，直接已目的地址命令ID，这样ID也表示目的地址\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\n/etc/httpd/conf/httpd.conf:\n  file.managed:\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n```\n```\n小示例：\n[root@salt-master ~]# cat /srv/salt/base/test.sls\n/tmp/passwd_back:\n  file.managed:\n    - source: salt://files/passwd\n    - user: root\n    - group: root\n    - mode: 644\n[root@salt-master ~]# cp /etc/passwd /srv/salt/base/files/\n[root@salt-master ~]# salt '*' state.sls test\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /tmp/passwd_back\"\nsalt-minion03:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion02:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion01:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\n```\n`file.directory` 建立目录\n```\n[root@salt-master ~]# cat /srv/salt/base/directory.sls\n/tmp/saltdir:\n  file.directory:\n    - user: root\n    - group: root\n    - mode: 755\n    - makedirs: True   #如果上一级目录不存在自动创建；类似（mkdir -p）\n\n[root@salt-master ~]# salt '*' state.sls directory\n[root@salt-master ~]# salt '*' cmd.run \"ls -d /tmp/saltdir\"\nsalt-minion03:\n    /tmp/saltdir\nsalt-minion02:\n    /tmp/saltdir\nsalt-minion01:\n    /tmp/saltdir\n```\n`file.recurse` 下发整个目录\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd_conf_dir.sls\nhttpd_conf_dir:\n  file.recurse:\n    - name: /etc/httpd/conf.d\n    - source: salt://files/conf.d\n    - file_mode: 600    #文件权限\n    - dir_mode: 755    #目录权限\n    - include_empty: True   #同步空目录\n    - clean: True    #使用后minion与master保持一致\n\n[root@salt-master ~]# rsync -avh /etc/httpd/conf.d /srv/salt/base/files/\n```\n`file.symlink` 建立软链接\n```\n[root@salt-master ~]# cat /srv/salt/base/target_link.sls\n/etc/grub.cfg:\n  file.symlink:\n    - target: /etc/grub2.cfg\n\n[root@salt-master ~]# salt '*' state.sls target_link\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /etc/grub.cfg\"\nsalt-minion03:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion01:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion02:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\n```\n### service服务模块\n[service模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html)\n```\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:\n  service.running:\n    - name: httpd   #服务名称\n    - enable: True    #开机自启动\n    - reload: True    #允许重载配置文件，不写则是restart\n\n或者这样写\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:   #即表示ID，又表示服务名\n  service.running:\n    - enable: True\n    - reload: True\n```\n\n## 高级状态模块\n>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 `top file`\n来进行管理。可以通过正则，`grain`模块，或分组名，来进行匹配，再下一级是要执行的`state`文件\n\n可以将我们的配置需求转换为`YAML`并在`Top file`文件中表示：\n![](saltstack配置管理/01.png)\n\n`Top file`示例\n```\nbase:\n  '*': #通过正则去匹配所有minion\n    - app.nginx\n\n  webserver: #定义的分组名称\n    - match: nodegroup\n    - app.cron\n\n  'os:centos':  #通过grains模块匹配\n    - match: grains\n    - nginx \n```\n`Top file` 高级状态的执行\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## LAMP架构案例\n说明：该案例在`prod`环境配置\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir /srv/salt/prod/{httpd,php,mysql,files}\n```\n3）配置文件准备及测试文件准备\n```\n[root@salt-master ~]# cp /etc/my.cnf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/php.ini  /srv/salt/prod/files/\n[root@salt-master ~]# echo \"<h1>LAMP html</h1>\" >>/srv/salt/prod/files/index.html\n[root@salt-master ~]# echo \"<?php phpinfo(); ?>\" >> /srv/salt/prod/files/index.php\n```\n4）编写`state sls`状态文件\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n\n#测试文件\n[root@salt-master ~]# cat /srv/salt/prod/testfile.sls\n/var/www/html/index.html:\n  file.managed:\n    - source: salt://files/index.html\n\n/var/www/html/index.php:\n  file.managed:\n    - source: salt://files/index.php\n```\n6）`topfile`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - httpd.init\n    - php.init\n    - mysql.init\n    - testfile\n```\n7）部署`LAMP`整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n```\n8）执行`topfile`\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## States状态依赖\n通过上面的`lamp`可以看出已经可以使用`state`模块来定义`minion`的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用`requisites`来进行控制\n>关系说明：\n1、`require` 我依赖某个状态，我依赖谁\n2、`require_in` 我被某个状态依赖，谁依赖我\n3、`watch` 我关注某个状态，当状态发生改变，进行`restart`或者`reload`操作\n4、`watch_in` 我被某个状态关注\n5、`include` 我引用谁\n\n1）修改上面`lamp`状态间依赖关系\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: apache-install   #表示上面apache-install执行成功，才能执行apache-config\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n    - require:\n      - file: apache-config\n    - watch:\n      - file: apache-config\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n    - reqiure_in:\n      - file: php-config\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: mariadb-install\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n    - reload: True\n    - require:\n      - file: mariadb-config\n    - watch:\n      - file: mariadb-config\n```\n2）修改引用关系后`include`\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── lamp.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n\n[root@salt-master ~]# cat /srv/salt/prod/lamp.sls\ninclude:\n  - httpd.init\n  - php.init\n  - mysql.init\n  - testfile\n\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - lamp\n```\n3）编写`SLS`技巧\n>1、按照状态分类，如果单独使用，清晰明了\n2、按照服务分类，可以被其它`SLS`引用\n\n## Jinja模板使用\n>配置文件一般灵活多变，比如配置`apache`的`IP`地址或者端口`PORT`等，则可以动态传值。\n[Jinja官档](http://docs.jinkan.org/docs/jinja2/)\n[salt jinja官档](https://docs.saltstack.com/en/latest/topics/jinja/index.html)\n\n`Jinja2` 模板包含变量和表达式，变量用 &#123;&#123; ... &#125;&#125; 包围，表达式用 &#123;&#37; ... &#37;&#125; 包围。变量使用示例：\n```\n[root@salt-master ~]# cat /srv/salt/base/var.sls \n{% set var= 'hello world!' %}\ntest_var:\n  cmd.run:\n    - name: echo \"测试变量 {{ var }}\"\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls var\nsalt-minion01:\n----------\n          ID: test_var\n    Function: cmd.run\n        Name: echo \"测试变量 hello world!\"\n      Result: True\n     Comment: Command \"echo \"测试变量 hello world!\"\" run\n     Started: 14:50:58.302424\n    Duration: 12.358 ms\n     Changes:   \n              ----------\n              pid:\n                  22510\n              retcode:\n                  0\n              stderr:\n              stdout:\n                  测试变量 hello world!\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  12.358 ms\n```\n`jinja2` 常用变量\n1、字符串类型\n```\n{% set var = 'test' %}  #定义变量\n{{ var }}  #调用变量\n```\n2、列表类型\n```\n{% set list = ['one', 'two', 'three'] %}\n{{ list[1] }}  #获取变量的第一个值\n```\n3、字典类型\n```\n{% set dict = {'key1':'value1', 'key2':'value2'} %}\n{{ dict['key1'] }}  #获取'key1'的值\n```\n示例1：`Saltstack`使用`jinja`模块配置`apache`监听端口\n```\n#1.告诉file状态模块，需要使用jinja\n    - template: jinja\n#2.列出参数列表\n    - defaults:\n      PORT: 8000\n#3.配置文件引用jinja模板\n{{ PORT }}\n\n# 配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n\n# 修改httpd.conf配置文件引用变量\nListen {{ PORT }}\n```\n示例2：使用`grinas` 方式进行赋值\n```\n#配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n      IPADDR: {{ grains['fqdn_ip4'][0] }}\n\n# 修改httpd.conf配置文件引用变量\nListen {{ IPADDR }}:{{ PORT }}\n```\n示例3：通过`jinja+grains`根据系统不同安装`apache`\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd.sls\n#根据grains获取的值判别系统后安装软件\nhttpd-install:\n  pkg.installed:\n{% if grains['os'] == 'CentOS' %}\n    - name: httpd\n{% elif grains['OS'] == 'Debin' %}\n    - name: apache2\n{% endif %}\n```\n\n\n","source":"_posts/saltstack配置管理.md","raw":"---\ntitle: saltstack配置管理\ndate: 2019-05-15 23:42:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## Saltstack状态模块\n>远程执行模块的执行是过程式，而状态是对`minion`的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述`minion`的状态描述。\n它的和兴是写`sls(Salt State file)`文件，`sls`文件默认格式为`YAML`格式，并默认使用`jinja`模板，`jinja`是根据`django`的模板语言发展而来的语言，简单并强大，支持`for if `等循环语句。`salt state`主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。\n\n```\nmysql-install:   #ID声明，必须唯一\n  pkg.installed:   #state状态声明\n    - pkgs:   #选项声明\n      - mariadb:   #选项列表\n      - mariadb-server\n\n说明：\n一个ID只能出现一次\n一个ID下相同模块只能使用一次\n一个ID下不可以使用多个不同模块\n```\n模块帮助手册\n```\n#列出所有状态模块\n[root@salt-master ~]# salt '*' sys.list_modules\n#查看指定模块的所有方法\n[root@salt-master ~]# salt '*' sys.list_state_functions pkg\n#查看指定模块的使用方法\n[root@salt-master ~]# salt '*' sys.state_doc pkg\n#查看指定模块的指定方法的用法\n[root@salt-master ~]# salt '*' sys.state_doc pkg.installed\n```\n### pkg软件模块\n[pkg模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html)\n`pkg.installed` 软件安装\n```\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql: \">=5.4.16\"    #指定安装版本\n      - php-pdo\n      - php-cli\n```\n指定安装最新版本的软件\n```\nphp-install:\n  pkg.latest:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n```\n### file文件模块\n[file模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html)\n`file.managed` 下发文件，确保文件存在\n```\n[root@salt-master ~]# mkdir /srv/salt/base/files\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/base/files/\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\n说明：\n- name: 表示存放目的地址\n- source: 表示这个文件来自哪里（说明这个文件得提前准备）\n\n或者这样写，直接已目的地址命令ID，这样ID也表示目的地址\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\n/etc/httpd/conf/httpd.conf:\n  file.managed:\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n```\n```\n小示例：\n[root@salt-master ~]# cat /srv/salt/base/test.sls\n/tmp/passwd_back:\n  file.managed:\n    - source: salt://files/passwd\n    - user: root\n    - group: root\n    - mode: 644\n[root@salt-master ~]# cp /etc/passwd /srv/salt/base/files/\n[root@salt-master ~]# salt '*' state.sls test\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /tmp/passwd_back\"\nsalt-minion03:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion02:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion01:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\n```\n`file.directory` 建立目录\n```\n[root@salt-master ~]# cat /srv/salt/base/directory.sls\n/tmp/saltdir:\n  file.directory:\n    - user: root\n    - group: root\n    - mode: 755\n    - makedirs: True   #如果上一级目录不存在自动创建；类似（mkdir -p）\n\n[root@salt-master ~]# salt '*' state.sls directory\n[root@salt-master ~]# salt '*' cmd.run \"ls -d /tmp/saltdir\"\nsalt-minion03:\n    /tmp/saltdir\nsalt-minion02:\n    /tmp/saltdir\nsalt-minion01:\n    /tmp/saltdir\n```\n`file.recurse` 下发整个目录\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd_conf_dir.sls\nhttpd_conf_dir:\n  file.recurse:\n    - name: /etc/httpd/conf.d\n    - source: salt://files/conf.d\n    - file_mode: 600    #文件权限\n    - dir_mode: 755    #目录权限\n    - include_empty: True   #同步空目录\n    - clean: True    #使用后minion与master保持一致\n\n[root@salt-master ~]# rsync -avh /etc/httpd/conf.d /srv/salt/base/files/\n```\n`file.symlink` 建立软链接\n```\n[root@salt-master ~]# cat /srv/salt/base/target_link.sls\n/etc/grub.cfg:\n  file.symlink:\n    - target: /etc/grub2.cfg\n\n[root@salt-master ~]# salt '*' state.sls target_link\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /etc/grub.cfg\"\nsalt-minion03:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion01:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion02:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\n```\n### service服务模块\n[service模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html)\n```\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:\n  service.running:\n    - name: httpd   #服务名称\n    - enable: True    #开机自启动\n    - reload: True    #允许重载配置文件，不写则是restart\n\n或者这样写\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:   #即表示ID，又表示服务名\n  service.running:\n    - enable: True\n    - reload: True\n```\n\n## 高级状态模块\n>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 `top file`\n来进行管理。可以通过正则，`grain`模块，或分组名，来进行匹配，再下一级是要执行的`state`文件\n\n可以将我们的配置需求转换为`YAML`并在`Top file`文件中表示：\n![](saltstack配置管理/01.png)\n\n`Top file`示例\n```\nbase:\n  '*': #通过正则去匹配所有minion\n    - app.nginx\n\n  webserver: #定义的分组名称\n    - match: nodegroup\n    - app.cron\n\n  'os:centos':  #通过grains模块匹配\n    - match: grains\n    - nginx \n```\n`Top file` 高级状态的执行\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## LAMP架构案例\n说明：该案例在`prod`环境配置\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir /srv/salt/prod/{httpd,php,mysql,files}\n```\n3）配置文件准备及测试文件准备\n```\n[root@salt-master ~]# cp /etc/my.cnf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/php.ini  /srv/salt/prod/files/\n[root@salt-master ~]# echo \"<h1>LAMP html</h1>\" >>/srv/salt/prod/files/index.html\n[root@salt-master ~]# echo \"<?php phpinfo(); ?>\" >> /srv/salt/prod/files/index.php\n```\n4）编写`state sls`状态文件\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n\n#测试文件\n[root@salt-master ~]# cat /srv/salt/prod/testfile.sls\n/var/www/html/index.html:\n  file.managed:\n    - source: salt://files/index.html\n\n/var/www/html/index.php:\n  file.managed:\n    - source: salt://files/index.php\n```\n6）`topfile`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - httpd.init\n    - php.init\n    - mysql.init\n    - testfile\n```\n7）部署`LAMP`整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n```\n8）执行`topfile`\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## States状态依赖\n通过上面的`lamp`可以看出已经可以使用`state`模块来定义`minion`的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用`requisites`来进行控制\n>关系说明：\n1、`require` 我依赖某个状态，我依赖谁\n2、`require_in` 我被某个状态依赖，谁依赖我\n3、`watch` 我关注某个状态，当状态发生改变，进行`restart`或者`reload`操作\n4、`watch_in` 我被某个状态关注\n5、`include` 我引用谁\n\n1）修改上面`lamp`状态间依赖关系\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: apache-install   #表示上面apache-install执行成功，才能执行apache-config\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n    - require:\n      - file: apache-config\n    - watch:\n      - file: apache-config\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n    - reqiure_in:\n      - file: php-config\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: mariadb-install\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n    - reload: True\n    - require:\n      - file: mariadb-config\n    - watch:\n      - file: mariadb-config\n```\n2）修改引用关系后`include`\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── lamp.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n\n[root@salt-master ~]# cat /srv/salt/prod/lamp.sls\ninclude:\n  - httpd.init\n  - php.init\n  - mysql.init\n  - testfile\n\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - lamp\n```\n3）编写`SLS`技巧\n>1、按照状态分类，如果单独使用，清晰明了\n2、按照服务分类，可以被其它`SLS`引用\n\n## Jinja模板使用\n>配置文件一般灵活多变，比如配置`apache`的`IP`地址或者端口`PORT`等，则可以动态传值。\n[Jinja官档](http://docs.jinkan.org/docs/jinja2/)\n[salt jinja官档](https://docs.saltstack.com/en/latest/topics/jinja/index.html)\n\n`Jinja2` 模板包含变量和表达式，变量用 &#123;&#123; ... &#125;&#125; 包围，表达式用 &#123;&#37; ... &#37;&#125; 包围。变量使用示例：\n```\n[root@salt-master ~]# cat /srv/salt/base/var.sls \n{% set var= 'hello world!' %}\ntest_var:\n  cmd.run:\n    - name: echo \"测试变量 {{ var }}\"\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls var\nsalt-minion01:\n----------\n          ID: test_var\n    Function: cmd.run\n        Name: echo \"测试变量 hello world!\"\n      Result: True\n     Comment: Command \"echo \"测试变量 hello world!\"\" run\n     Started: 14:50:58.302424\n    Duration: 12.358 ms\n     Changes:   \n              ----------\n              pid:\n                  22510\n              retcode:\n                  0\n              stderr:\n              stdout:\n                  测试变量 hello world!\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  12.358 ms\n```\n`jinja2` 常用变量\n1、字符串类型\n```\n{% set var = 'test' %}  #定义变量\n{{ var }}  #调用变量\n```\n2、列表类型\n```\n{% set list = ['one', 'two', 'three'] %}\n{{ list[1] }}  #获取变量的第一个值\n```\n3、字典类型\n```\n{% set dict = {'key1':'value1', 'key2':'value2'} %}\n{{ dict['key1'] }}  #获取'key1'的值\n```\n示例1：`Saltstack`使用`jinja`模块配置`apache`监听端口\n```\n#1.告诉file状态模块，需要使用jinja\n    - template: jinja\n#2.列出参数列表\n    - defaults:\n      PORT: 8000\n#3.配置文件引用jinja模板\n{{ PORT }}\n\n# 配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n\n# 修改httpd.conf配置文件引用变量\nListen {{ PORT }}\n```\n示例2：使用`grinas` 方式进行赋值\n```\n#配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n      IPADDR: {{ grains['fqdn_ip4'][0] }}\n\n# 修改httpd.conf配置文件引用变量\nListen {{ IPADDR }}:{{ PORT }}\n```\n示例3：通过`jinja+grains`根据系统不同安装`apache`\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd.sls\n#根据grains获取的值判别系统后安装软件\nhttpd-install:\n  pkg.installed:\n{% if grains['os'] == 'CentOS' %}\n    - name: httpd\n{% elif grains['OS'] == 'Debin' %}\n    - name: apache2\n{% endif %}\n```\n\n\n","slug":"saltstack配置管理","published":1,"updated":"2019-05-28T13:52:15.398Z","_id":"cjxwlqrns0025lctcy7gtwsxy","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"Saltstack状态模块\"><a href=\"#Saltstack状态模块\" class=\"headerlink\" title=\"Saltstack状态模块\"></a>Saltstack状态模块</h2><blockquote>\n<p>远程执行模块的执行是过程式，而状态是对<code>minion</code>的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述<code>minion</code>的状态描述。<br>它的和兴是写<code>sls(Salt State file)</code>文件，<code>sls</code>文件默认格式为<code>YAML</code>格式，并默认使用<code>jinja</code>模板，<code>jinja</code>是根据<code>django</code>的模板语言发展而来的语言，简单并强大，支持<code>for if</code>等循环语句。<code>salt state</code>主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql-<span class=\"keyword\">install</span>:   <span class=\"comment\">#ID声明，必须唯一</span></span><br><span class=\"line\">  pkg.installed:   <span class=\"comment\">#state状态声明</span></span><br><span class=\"line\">    - pkgs:   <span class=\"comment\">#选项声明</span></span><br><span class=\"line\">      - mariadb:   <span class=\"comment\">#选项列表</span></span><br><span class=\"line\">      - mariadb-<span class=\"keyword\">server</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>只能出现一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下相同模块只能使用一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下不可以使用多个不同模块</span><br></pre></td></tr></table></figure>\n<p>模块帮助手册<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#列出所有状态模块</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_modules</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的所有方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_state_functions pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的使用方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的指定方法的用法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg.installed</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"pkg软件模块\"><a href=\"#pkg软件模块\" class=\"headerlink\" title=\"pkg软件模块\"></a>pkg软件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html\" target=\"_blank\" rel=\"noopener\">pkg模块官档</a><br><code>pkg.installed</code> 软件安装<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-<span class=\"symbol\">mysql:</span> <span class=\"string\">\"&gt;=5.4.16\"</span>    <span class=\"comment\">#指定安装版本</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<p>指定安装最新版本的软件<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.latest:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-mysql</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"file文件模块\"><a href=\"#file文件模块\" class=\"headerlink\" title=\"file文件模块\"></a>file文件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html\" target=\"_blank\" rel=\"noopener\">file模块官档</a><br><code>file.managed</code> 下发文件，确保文件存在<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"built_in\">mkdir</span> /srv/salt/base/<span class=\"keyword\">files</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cp</span> /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span> /srv/salt/base/<span class=\"keyword\">files</span>/</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">- name: 表示存放目的地址</span><br><span class=\"line\">- <span class=\"keyword\">source</span>: 表示这个文件来自哪里（说明这个文件得提前准备）</span><br><span class=\"line\"></span><br><span class=\"line\">或者这样写，直接已目的地址命令ID，这样ID也表示目的地址</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">/etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span>:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">小示例：</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/test.sls</span><br><span class=\"line\">/tmp/passwd_back:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - source: salt://files/passwd</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/passwd /srv/salt/base/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls test</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -l /tmp/passwd_back\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br></pre></td></tr></table></figure>\n<p><code>file.directory</code> 建立目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/directory.sls</span><br><span class=\"line\">/tmp/saltdir:</span><br><span class=\"line\">  file.directory:</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">755</span></span><br><span class=\"line\">    - makedirs: <span class=\"literal\">True</span>   <span class=\"comment\">#如果上一级目录不存在自动创建；类似（mkdir -p）</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls directory</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -d /tmp/saltdir\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    /tmp/saltdir</span><br></pre></td></tr></table></figure></p>\n<p><code>file.recurse</code> 下发整个目录<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/httpd_conf_dir.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd_conf_dir:</span></span><br><span class=\"line\">  <span class=\"string\">file.recurse:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - file_mode:</span> <span class=\"number\">600</span>    <span class=\"comment\">#文件权限</span></span><br><span class=\"line\"><span class=\"attr\">    - dir_mode:</span> <span class=\"number\">755</span>    <span class=\"comment\">#目录权限</span></span><br><span class=\"line\"><span class=\"attr\">    - include_empty:</span> <span class=\"literal\">True</span>   <span class=\"comment\">#同步空目录</span></span><br><span class=\"line\"><span class=\"attr\">    - clean:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#使用后minion与master保持一致</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">rsync</span> <span class=\"bullet\">-avh</span> <span class=\"string\">/etc/httpd/conf.d</span> <span class=\"string\">/srv/salt/base/files/</span></span><br></pre></td></tr></table></figure></p>\n<p><code>file.symlink</code> 建立软链接<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># cat /srv/salt/base/target_link.sls</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>grub.cfg:</span><br><span class=\"line\">  file.symlink:</span><br><span class=\"line\">    - target: <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls target_link</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"ls -l /etc/grub.cfg\"</span></span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"service服务模块\"><a href=\"#service服务模块\" class=\"headerlink\" title=\"service服务模块\"></a>service服务模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html\" target=\"_blank\" rel=\"noopener\">service模块官档</a><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span>   <span class=\"comment\">#服务名称</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#开机自启动</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#允许重载配置文件，不写则是restart</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">或者这样写</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span>   <span class=\"comment\">#即表示ID，又表示服务名</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"高级状态模块\"><a href=\"#高级状态模块\" class=\"headerlink\" title=\"高级状态模块\"></a>高级状态模块</h2><blockquote>\n<p>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 <code>top file</code><br>来进行管理。可以通过正则，<code>grain</code>模块，或分组名，来进行匹配，再下一级是要执行的<code>state</code>文件</p>\n</blockquote>\n<p>可以将我们的配置需求转换为<code>YAML</code>并在<code>Top file</code>文件中表示：<br><img src=\"/2019/05/15/saltstack配置管理/01.png\" alt></p>\n<p><code>Top file</code>示例<br><figure class=\"highlight rsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base:</span><br><span class=\"line\">  <span class=\"string\">'*'</span>: <span class=\"meta\">#通过正则去匹配所有minion</span></span><br><span class=\"line\">    - app.nginx</span><br><span class=\"line\"></span><br><span class=\"line\">  webserver: <span class=\"meta\">#定义的分组名称</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: nodegroup</span><br><span class=\"line\">    - app.cron</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">'os:centos'</span>:  <span class=\"meta\">#通过grains模块匹配</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: grains</span><br><span class=\"line\">    - nginx</span><br></pre></td></tr></table></figure></p>\n<p><code>Top file</code> 高级状态的执行<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"LAMP架构案例\"><a href=\"#LAMP架构案例\" class=\"headerlink\" title=\"LAMP架构案例\"></a>LAMP架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/salt/prod/&#123;httpd,php,mysql,files&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）配置文件准备及测试文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/my.cnf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/httpd/conf/httpd.conf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/php.ini  /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;h1&gt;LAMP html&lt;/h1&gt;\"</span> &gt;&gt;/srv/salt/prod/files/index.html</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;?php phpinfo(); ?&gt;\"</span> &gt;&gt; /srv/salt/prod/files/index.php</span><br></pre></td></tr></table></figure></p>\n<p>4）编写<code>state sls</code>状态文件<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#httpd</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/httpd/init.sls</span><br><span class=\"line\">apache-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - httpd</span><br><span class=\"line\">      - httpd-tools</span><br><span class=\"line\"></span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: httpd</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#php</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/php/init.sls</span><br><span class=\"line\">php-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - php</span><br><span class=\"line\">      - php-mysql</span><br><span class=\"line\">      - php-pdo</span><br><span class=\"line\">      - php-cli</span><br><span class=\"line\"></span><br><span class=\"line\">php-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/php.ini</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/php.ini</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#mysql</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/mysql/init.sls</span><br><span class=\"line\">mariadb-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - mariadb-server</span><br><span class=\"line\">      - mariadb</span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: mariadb</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#测试文件</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/testfile.sls</span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.htm<span class=\"variable\">l:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.html</span><br><span class=\"line\"></span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.php:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.php</span><br></pre></td></tr></table></figure></p>\n<p>6）<code>topfile</code>文件编写<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - testfile</span><br></pre></td></tr></table></figure></p>\n<p>7）部署<code>LAMP</code>整体<code>state</code>文件查看<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">    │   ├── httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.html</span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.php</span><br><span class=\"line\">    │   ├── my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    └── testfile.sls</span><br></pre></td></tr></table></figure></p>\n<p>8）执行<code>topfile</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"States状态依赖\"><a href=\"#States状态依赖\" class=\"headerlink\" title=\"States状态依赖\"></a>States状态依赖</h2><p>通过上面的<code>lamp</code>可以看出已经可以使用<code>state</code>模块来定义<code>minion</code>的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用<code>requisites</code>来进行控制</p>\n<blockquote>\n<p>关系说明：<br>1、<code>require</code> 我依赖某个状态，我依赖谁<br>2、<code>require_in</code> 我被某个状态依赖，谁依赖我<br>3、<code>watch</code> 我关注某个状态，当状态发生改变，进行<code>restart</code>或者<code>reload</code>操作<br>4、<code>watch_in</code> 我被某个状态关注<br>5、<code>include</code> 我引用谁</p>\n</blockquote>\n<p>1）修改上面<code>lamp</code>状态间依赖关系<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#httpd</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/httpd/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">apache-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd-tools</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">apache-install</span>   <span class=\"comment\">#表示上面apache-install执行成功，才能执行apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/php/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">php-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-mysql</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-pdo</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-cli</span></span><br><span class=\"line\"><span class=\"attr\">    - reqiure_in:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">php-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#mysql</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/mysql/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb-server</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br></pre></td></tr></table></figure></p>\n<p>2）修改引用关系后<code>include</code><br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── files</span><br><span class=\"line\">    │   ├── httpd.conf</span><br><span class=\"line\">    │   ├── index.html</span><br><span class=\"line\">    │   ├── index.php</span><br><span class=\"line\">    │   ├── my.cnf</span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── lamp.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    └── testfile.sls</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/prod/lamp.sls</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - testfile</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - lamp</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>SLS</code>技巧</p>\n<blockquote>\n<p>1、按照状态分类，如果单独使用，清晰明了<br>2、按照服务分类，可以被其它<code>SLS</code>引用</p>\n</blockquote>\n<h2 id=\"Jinja模板使用\"><a href=\"#Jinja模板使用\" class=\"headerlink\" title=\"Jinja模板使用\"></a>Jinja模板使用</h2><blockquote>\n<p>配置文件一般灵活多变，比如配置<code>apache</code>的<code>IP</code>地址或者端口<code>PORT</code>等，则可以动态传值。<br><a href=\"http://docs.jinkan.org/docs/jinja2/\" target=\"_blank\" rel=\"noopener\">Jinja官档</a><br><a href=\"https://docs.saltstack.com/en/latest/topics/jinja/index.html\" target=\"_blank\" rel=\"noopener\">salt jinja官档</a></p>\n</blockquote>\n<p><code>Jinja2</code> 模板包含变量和表达式，变量用 &#123;&#123; … &#125;&#125; 包围，表达式用 &#123;&#37; … &#37;&#125; 包围。变量使用示例：<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/base/var.sls </span><br><span class=\"line\">&#123;% set var= <span class=\"emphasis\">'hello world!'</span> %&#125;</span><br><span class=\"line\">test<span class=\"emphasis\">_var:</span></span><br><span class=\"line\"><span class=\"emphasis\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"emphasis\">    - name: echo \"测试变量 &#123;&#123; var &#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"emphasis\"></span></span><br><span class=\"line\"><span class=\"emphasis\">[root@salt-master ~]# salt 'salt-minion01' state.sls var</span></span><br><span class=\"line\"><span class=\"emphasis\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"emphasis\">----------</span></span><br><span class=\"line\"><span class=\"emphasis\">          ID: test_</span>var</span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: echo \"测试变量 hello world!\"</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"echo \"测试变量 hello world!\"\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 14:50:58.302424</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 12.358 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  22510</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"><span class=\"code\">                  测试变量 hello world!</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  12.358 ms</span><br></pre></td></tr></table></figure></p>\n<p><code>jinja2</code> 常用变量<br>1、字符串类型<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> <span class=\"keyword\">var</span> = <span class=\"string\">'test'</span> %&#125;  <span class=\"meta\">#定义变量</span></span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">var</span> &#125;&#125;  <span class=\"meta\">#调用变量</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表类型<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% set <span class=\"keyword\">list</span> = [<span class=\"string\">'one'</span>, <span class=\"string\">'two'</span>, <span class=\"string\">'three'</span>] %&#125;</span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">list</span>[<span class=\"number\">1</span>] &#125;&#125;  <span class=\"comment\">#获取变量的第一个值</span></span><br></pre></td></tr></table></figure></p>\n<p>3、字典类型<br><figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> dict <span class=\"comment\">= &#123;</span><span class=\"comment\">'key1'</span><span class=\"comment\">:</span><span class=\"comment\">'value1'</span><span class=\"comment\">,</span> <span class=\"comment\">'key2'</span><span class=\"comment\">:</span><span class=\"comment\">'value2'</span><span class=\"comment\">&#125; %&#125;</span></span><br><span class=\"line\">&#123;&#123; dict[<span class=\"string\">'key1'</span>] &#125;&#125;  #获取<span class=\"string\">'key1'</span>的值</span><br></pre></td></tr></table></figure></p>\n<p>示例1：<code>Saltstack</code>使用<code>jinja</code>模块配置<code>apache</code>监听端口<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.告诉file状态模块，需要使用jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"comment\">#2.列出参数列表</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"comment\">#3.配置文件引用jinja模板</span></span><br><span class=\"line\"><span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例2：使用<code>grinas</code> 方式进行赋值<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"attr\">      IPADDR:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">IPADDR</span> <span class=\"string\">&#125;&#125;:&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例3：通过<code>jinja+grains</code>根据系统不同安装<code>apache</code><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cat /srv/salt/base/httpd.sls</span></span><br><span class=\"line\"><span class=\"comment\">#根据grains获取的值判别系统后安装软件</span></span><br><span class=\"line\">httpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">&#123;% <span class=\"keyword\">if</span> grains[<span class=\"string\">'os'</span>] == <span class=\"string\">'CentOS'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">&#123;% elif grains[<span class=\"string\">'OS'</span>] == <span class=\"string\">'Debin'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: apache2</span><br><span class=\"line\">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Saltstack状态模块\"><a href=\"#Saltstack状态模块\" class=\"headerlink\" title=\"Saltstack状态模块\"></a>Saltstack状态模块</h2><blockquote>\n<p>远程执行模块的执行是过程式，而状态是对<code>minion</code>的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述<code>minion</code>的状态描述。<br>它的和兴是写<code>sls(Salt State file)</code>文件，<code>sls</code>文件默认格式为<code>YAML</code>格式，并默认使用<code>jinja</code>模板，<code>jinja</code>是根据<code>django</code>的模板语言发展而来的语言，简单并强大，支持<code>for if</code>等循环语句。<code>salt state</code>主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql-<span class=\"keyword\">install</span>:   <span class=\"comment\">#ID声明，必须唯一</span></span><br><span class=\"line\">  pkg.installed:   <span class=\"comment\">#state状态声明</span></span><br><span class=\"line\">    - pkgs:   <span class=\"comment\">#选项声明</span></span><br><span class=\"line\">      - mariadb:   <span class=\"comment\">#选项列表</span></span><br><span class=\"line\">      - mariadb-<span class=\"keyword\">server</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>只能出现一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下相同模块只能使用一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下不可以使用多个不同模块</span><br></pre></td></tr></table></figure>\n<p>模块帮助手册<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#列出所有状态模块</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_modules</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的所有方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_state_functions pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的使用方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的指定方法的用法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg.installed</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"pkg软件模块\"><a href=\"#pkg软件模块\" class=\"headerlink\" title=\"pkg软件模块\"></a>pkg软件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html\" target=\"_blank\" rel=\"noopener\">pkg模块官档</a><br><code>pkg.installed</code> 软件安装<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-<span class=\"symbol\">mysql:</span> <span class=\"string\">\"&gt;=5.4.16\"</span>    <span class=\"comment\">#指定安装版本</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<p>指定安装最新版本的软件<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.latest:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-mysql</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"file文件模块\"><a href=\"#file文件模块\" class=\"headerlink\" title=\"file文件模块\"></a>file文件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html\" target=\"_blank\" rel=\"noopener\">file模块官档</a><br><code>file.managed</code> 下发文件，确保文件存在<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"built_in\">mkdir</span> /srv/salt/base/<span class=\"keyword\">files</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cp</span> /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span> /srv/salt/base/<span class=\"keyword\">files</span>/</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">- name: 表示存放目的地址</span><br><span class=\"line\">- <span class=\"keyword\">source</span>: 表示这个文件来自哪里（说明这个文件得提前准备）</span><br><span class=\"line\"></span><br><span class=\"line\">或者这样写，直接已目的地址命令ID，这样ID也表示目的地址</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">/etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span>:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">小示例：</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/test.sls</span><br><span class=\"line\">/tmp/passwd_back:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - source: salt://files/passwd</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/passwd /srv/salt/base/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls test</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -l /tmp/passwd_back\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br></pre></td></tr></table></figure>\n<p><code>file.directory</code> 建立目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/directory.sls</span><br><span class=\"line\">/tmp/saltdir:</span><br><span class=\"line\">  file.directory:</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">755</span></span><br><span class=\"line\">    - makedirs: <span class=\"literal\">True</span>   <span class=\"comment\">#如果上一级目录不存在自动创建；类似（mkdir -p）</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls directory</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -d /tmp/saltdir\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    /tmp/saltdir</span><br></pre></td></tr></table></figure></p>\n<p><code>file.recurse</code> 下发整个目录<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/httpd_conf_dir.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd_conf_dir:</span></span><br><span class=\"line\">  <span class=\"string\">file.recurse:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - file_mode:</span> <span class=\"number\">600</span>    <span class=\"comment\">#文件权限</span></span><br><span class=\"line\"><span class=\"attr\">    - dir_mode:</span> <span class=\"number\">755</span>    <span class=\"comment\">#目录权限</span></span><br><span class=\"line\"><span class=\"attr\">    - include_empty:</span> <span class=\"literal\">True</span>   <span class=\"comment\">#同步空目录</span></span><br><span class=\"line\"><span class=\"attr\">    - clean:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#使用后minion与master保持一致</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">rsync</span> <span class=\"bullet\">-avh</span> <span class=\"string\">/etc/httpd/conf.d</span> <span class=\"string\">/srv/salt/base/files/</span></span><br></pre></td></tr></table></figure></p>\n<p><code>file.symlink</code> 建立软链接<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># cat /srv/salt/base/target_link.sls</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>grub.cfg:</span><br><span class=\"line\">  file.symlink:</span><br><span class=\"line\">    - target: <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls target_link</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"ls -l /etc/grub.cfg\"</span></span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"service服务模块\"><a href=\"#service服务模块\" class=\"headerlink\" title=\"service服务模块\"></a>service服务模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html\" target=\"_blank\" rel=\"noopener\">service模块官档</a><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span>   <span class=\"comment\">#服务名称</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#开机自启动</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#允许重载配置文件，不写则是restart</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">或者这样写</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span>   <span class=\"comment\">#即表示ID，又表示服务名</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"高级状态模块\"><a href=\"#高级状态模块\" class=\"headerlink\" title=\"高级状态模块\"></a>高级状态模块</h2><blockquote>\n<p>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 <code>top file</code><br>来进行管理。可以通过正则，<code>grain</code>模块，或分组名，来进行匹配，再下一级是要执行的<code>state</code>文件</p>\n</blockquote>\n<p>可以将我们的配置需求转换为<code>YAML</code>并在<code>Top file</code>文件中表示：<br><img src=\"/2019/05/15/saltstack配置管理/01.png\" alt></p>\n<p><code>Top file</code>示例<br><figure class=\"highlight rsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base:</span><br><span class=\"line\">  <span class=\"string\">'*'</span>: <span class=\"meta\">#通过正则去匹配所有minion</span></span><br><span class=\"line\">    - app.nginx</span><br><span class=\"line\"></span><br><span class=\"line\">  webserver: <span class=\"meta\">#定义的分组名称</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: nodegroup</span><br><span class=\"line\">    - app.cron</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">'os:centos'</span>:  <span class=\"meta\">#通过grains模块匹配</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: grains</span><br><span class=\"line\">    - nginx</span><br></pre></td></tr></table></figure></p>\n<p><code>Top file</code> 高级状态的执行<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"LAMP架构案例\"><a href=\"#LAMP架构案例\" class=\"headerlink\" title=\"LAMP架构案例\"></a>LAMP架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/salt/prod/&#123;httpd,php,mysql,files&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）配置文件准备及测试文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/my.cnf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/httpd/conf/httpd.conf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/php.ini  /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;h1&gt;LAMP html&lt;/h1&gt;\"</span> &gt;&gt;/srv/salt/prod/files/index.html</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;?php phpinfo(); ?&gt;\"</span> &gt;&gt; /srv/salt/prod/files/index.php</span><br></pre></td></tr></table></figure></p>\n<p>4）编写<code>state sls</code>状态文件<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#httpd</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/httpd/init.sls</span><br><span class=\"line\">apache-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - httpd</span><br><span class=\"line\">      - httpd-tools</span><br><span class=\"line\"></span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: httpd</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#php</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/php/init.sls</span><br><span class=\"line\">php-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - php</span><br><span class=\"line\">      - php-mysql</span><br><span class=\"line\">      - php-pdo</span><br><span class=\"line\">      - php-cli</span><br><span class=\"line\"></span><br><span class=\"line\">php-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/php.ini</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/php.ini</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#mysql</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/mysql/init.sls</span><br><span class=\"line\">mariadb-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - mariadb-server</span><br><span class=\"line\">      - mariadb</span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: mariadb</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#测试文件</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/testfile.sls</span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.htm<span class=\"variable\">l:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.html</span><br><span class=\"line\"></span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.php:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.php</span><br></pre></td></tr></table></figure></p>\n<p>6）<code>topfile</code>文件编写<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - testfile</span><br></pre></td></tr></table></figure></p>\n<p>7）部署<code>LAMP</code>整体<code>state</code>文件查看<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">    │   ├── httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.html</span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.php</span><br><span class=\"line\">    │   ├── my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    └── testfile.sls</span><br></pre></td></tr></table></figure></p>\n<p>8）执行<code>topfile</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"States状态依赖\"><a href=\"#States状态依赖\" class=\"headerlink\" title=\"States状态依赖\"></a>States状态依赖</h2><p>通过上面的<code>lamp</code>可以看出已经可以使用<code>state</code>模块来定义<code>minion</code>的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用<code>requisites</code>来进行控制</p>\n<blockquote>\n<p>关系说明：<br>1、<code>require</code> 我依赖某个状态，我依赖谁<br>2、<code>require_in</code> 我被某个状态依赖，谁依赖我<br>3、<code>watch</code> 我关注某个状态，当状态发生改变，进行<code>restart</code>或者<code>reload</code>操作<br>4、<code>watch_in</code> 我被某个状态关注<br>5、<code>include</code> 我引用谁</p>\n</blockquote>\n<p>1）修改上面<code>lamp</code>状态间依赖关系<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#httpd</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/httpd/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">apache-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd-tools</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">apache-install</span>   <span class=\"comment\">#表示上面apache-install执行成功，才能执行apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/php/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">php-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-mysql</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-pdo</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-cli</span></span><br><span class=\"line\"><span class=\"attr\">    - reqiure_in:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">php-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#mysql</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/mysql/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb-server</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br></pre></td></tr></table></figure></p>\n<p>2）修改引用关系后<code>include</code><br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── files</span><br><span class=\"line\">    │   ├── httpd.conf</span><br><span class=\"line\">    │   ├── index.html</span><br><span class=\"line\">    │   ├── index.php</span><br><span class=\"line\">    │   ├── my.cnf</span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── lamp.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    └── testfile.sls</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/prod/lamp.sls</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - testfile</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - lamp</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>SLS</code>技巧</p>\n<blockquote>\n<p>1、按照状态分类，如果单独使用，清晰明了<br>2、按照服务分类，可以被其它<code>SLS</code>引用</p>\n</blockquote>\n<h2 id=\"Jinja模板使用\"><a href=\"#Jinja模板使用\" class=\"headerlink\" title=\"Jinja模板使用\"></a>Jinja模板使用</h2><blockquote>\n<p>配置文件一般灵活多变，比如配置<code>apache</code>的<code>IP</code>地址或者端口<code>PORT</code>等，则可以动态传值。<br><a href=\"http://docs.jinkan.org/docs/jinja2/\" target=\"_blank\" rel=\"noopener\">Jinja官档</a><br><a href=\"https://docs.saltstack.com/en/latest/topics/jinja/index.html\" target=\"_blank\" rel=\"noopener\">salt jinja官档</a></p>\n</blockquote>\n<p><code>Jinja2</code> 模板包含变量和表达式，变量用 &#123;&#123; … &#125;&#125; 包围，表达式用 &#123;&#37; … &#37;&#125; 包围。变量使用示例：<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/base/var.sls </span><br><span class=\"line\">&#123;% set var= <span class=\"emphasis\">'hello world!'</span> %&#125;</span><br><span class=\"line\">test<span class=\"emphasis\">_var:</span></span><br><span class=\"line\"><span class=\"emphasis\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"emphasis\">    - name: echo \"测试变量 &#123;&#123; var &#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"emphasis\"></span></span><br><span class=\"line\"><span class=\"emphasis\">[root@salt-master ~]# salt 'salt-minion01' state.sls var</span></span><br><span class=\"line\"><span class=\"emphasis\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"emphasis\">----------</span></span><br><span class=\"line\"><span class=\"emphasis\">          ID: test_</span>var</span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: echo \"测试变量 hello world!\"</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"echo \"测试变量 hello world!\"\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 14:50:58.302424</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 12.358 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  22510</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"><span class=\"code\">                  测试变量 hello world!</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  12.358 ms</span><br></pre></td></tr></table></figure></p>\n<p><code>jinja2</code> 常用变量<br>1、字符串类型<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> <span class=\"keyword\">var</span> = <span class=\"string\">'test'</span> %&#125;  <span class=\"meta\">#定义变量</span></span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">var</span> &#125;&#125;  <span class=\"meta\">#调用变量</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表类型<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% set <span class=\"keyword\">list</span> = [<span class=\"string\">'one'</span>, <span class=\"string\">'two'</span>, <span class=\"string\">'three'</span>] %&#125;</span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">list</span>[<span class=\"number\">1</span>] &#125;&#125;  <span class=\"comment\">#获取变量的第一个值</span></span><br></pre></td></tr></table></figure></p>\n<p>3、字典类型<br><figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> dict <span class=\"comment\">= &#123;</span><span class=\"comment\">'key1'</span><span class=\"comment\">:</span><span class=\"comment\">'value1'</span><span class=\"comment\">,</span> <span class=\"comment\">'key2'</span><span class=\"comment\">:</span><span class=\"comment\">'value2'</span><span class=\"comment\">&#125; %&#125;</span></span><br><span class=\"line\">&#123;&#123; dict[<span class=\"string\">'key1'</span>] &#125;&#125;  #获取<span class=\"string\">'key1'</span>的值</span><br></pre></td></tr></table></figure></p>\n<p>示例1：<code>Saltstack</code>使用<code>jinja</code>模块配置<code>apache</code>监听端口<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.告诉file状态模块，需要使用jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"comment\">#2.列出参数列表</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"comment\">#3.配置文件引用jinja模板</span></span><br><span class=\"line\"><span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例2：使用<code>grinas</code> 方式进行赋值<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"attr\">      IPADDR:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">IPADDR</span> <span class=\"string\">&#125;&#125;:&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例3：通过<code>jinja+grains</code>根据系统不同安装<code>apache</code><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cat /srv/salt/base/httpd.sls</span></span><br><span class=\"line\"><span class=\"comment\">#根据grains获取的值判别系统后安装软件</span></span><br><span class=\"line\">httpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">&#123;% <span class=\"keyword\">if</span> grains[<span class=\"string\">'os'</span>] == <span class=\"string\">'CentOS'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">&#123;% elif grains[<span class=\"string\">'OS'</span>] == <span class=\"string\">'Debin'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: apache2</span><br><span class=\"line\">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack项目实战","date":"2019-05-21T07:43:05.000Z","copyright":true,"_content":"## 项目架构规划\n>后端web服务器使用`Nginx+Php`作为站点，通过`HAproxy`做负载均衡，`Keepalived`做高可用\n\n![架构规划图](saltstack项目实战/01.png)\n\n## 项目环境准备\n![环境准备](saltstack项目实战/02.png)\n\n**说明：** 关闭防火墙、`selinux`、时间同步等\n`host`绑定\n```\n[root@salt-master ~]# cat /etc/hosts\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.1.30\tsalt-master\n192.168.1.31\tsalt-minion01\n192.168.1.32\tsalt-minion02\n192.168.1.33\tsalt-minion03\n192.168.1.34\tsalt-minion04\n\n[root@salt-master ~]# for i in `seq 4`; do scp /etc/hosts 192.168.1.3$i:/etc/hosts ; done\n```\n### 软件安装\n[参考地址](https://www.cnblogs.com/yanjieli/p/10864648.html)\n1）`Master`上软件安装\n```\n[root@salt-master ~]# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n[root@salt-master ~]# sed -i \"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\" /etc/yum.repos.d/salt-latest.repo\n[root@salt-master ~]# yum -y install salt-master\n[root@salt-master ~]# systemctl enable salt-master\n[root@salt-master ~]# systemctl start salt-master\n```\n2）`Minion`上软件安装并配置\n```\n# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n# yum -y install salt-minion\n# cp /etc/salt/minion{,.back}\n# sed -i '/#master: /c\\master: salt-master' /etc/salt/minion\n# systemctl enable salt-minion\n# systemctl start salt-minion\n```\n### Master上认证\n```\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nDenied Keys:\nUnaccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nRejected Keys:\n\n[root@salt-master ~]# salt-key -A -y\nThe following keys are going to be accepted:\nUnaccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nKey for minion salt-minion01 accepted.\nKey for minion salt-minion02 accepted.\nKey for minion salt-minion03 accepted.\nKey for minion salt-minion04 accepted.\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nDenied Keys:\nUnaccepted Keys:\nRejected Keys:\n\n[root@salt-master ~]# salt '*' test.ping\nsalt-minion01:\n    True\nsalt-minion02:\n    True\nsalt-minion03:\n    True\nsalt-minion04:\n    True\n```\n## Master上state编写\n### state环境设置\n>说明：该案例在`prod`环境下配置，在`prod`下面创建了一个`modules`的目录，所有的安装配置都放在这个目录下面了，里面分别又对应创建了对应的软件目录，每个软件目录下面的`files`目录用来存放的是软件包或者配置文件模板\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  test:\n    - /srv/salt/test\n  prod:\n    - /srv/salt/prod\n  dev:\n    - /srv/salt/dev\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# mkdir -p /srv/salt/{base,test,prod,dev}\n\n[root@salt-master ~]# mkdir -p /srv/salt/prod/modules/{nginx,php,mysql,haproxy,keepalived,lnmp}/files\n[root@salt-master ~]# mkdir /srv/salt/prod/modules/user\n[root@salt-master ~]# tree /srv/salt/prod/modules/\n/srv/salt/prod/modules/\n├── haproxy\n│   └── files\n├── keepalived\n│   └── files\n├── lnmp\n│   └── files\n├── mysql\n│   └── files\n├── nginx\n│   └── files\n├── php\n│   └── files\n└── user\n\n13 directories, 0 files\n```\n### sls文件编写\n#### pkg基础包\n安装源码编译所需要用到的基础软件包\n```\n[root@salt-master ~]# cat /srv/salt/prod/modules/pkg.sls \npkg-install:\n  pkg.installed:\n    - pkgs:\n      - gcc\n      - gcc-c++\n      - make\n      - autoconf\n      - glibc\n      - glibc-devel\n      - glib2\n      - glib2-devel\n      - pcre\n      - pcre-devel\n      - zlib\n      - zlib-devel\n      - openssl\n      - openssl-devel\n      - libpng\n      - libpng-devel\n      - freetype\n      - freetype-devel\n      - libxml2\n      - libxml2-devel\n      - bzip2\n      - bzip2-devel\n      - ncurses\n      - curl\n      - gdbm-devel\n      - libXpm-devel\n      - libX11-devel\n      - gd-devel\n      - gmp-devel\n      - readline-devel\n      - libxslt-devel\n      - expat-devel\n      - xmlrpc-c\n      - xmlrpc-c-devel\n```\n#### useradd\n创建网站运行用户\n```\n[root@salt-master ~]# cat /srv/salt/prod/modules/user/www.sls \nwww-user-group:\n  group.present:\n    - name: www\n    - gid: 2000\n\n  user.present:\n    - name: www\n    - fullname: www\n    - shell: /sbin/nologin\n    - uid: 2000\n    - gid: 2000\n    - unless: id www\n```\n#### nginx\n1）软件包准备，及配置文件模板，启动文件模板\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/nginx/\n[root@salt-master nginx]# tree \n.\n├── files\n│   ├── nginx-1.12.2.tar.gz\n│   ├── nginx-1.16.0.tar.gz\n│   ├── nginx.conf.template\n│   └── nginx.service.template\n├── install.sls\n└── service.sls\n\n1 directory, 6 files\n```\n2）`install.sls` \n```\n[root@salt-master nginx]# cat install.sls \n{% set nginx_version = \"1.16.0\"%}\ninclude:\n  - modules.pkg\n  - modules.user.www\n\nnginx-install:\n  file.managed:\n    - name: /usr/local/src/nginx-{{ nginx_version }}.tar.gz\n    - source: salt://modules/nginx/files/nginx-{{ nginx_version }}.tar.gz\n    - user: root\n    - group: root\n    - mode: 644\n\n  cmd.run:\n    - name: cd /usr/local/src/ && tar xf nginx-{{ nginx_version }}.tar.gz && cd nginx-{{ nginx_version }} && ./configure --prefix=/usr/local/nginx-{{ nginx_version }} --user=root --group=root --with-http_ssl_module --with-stream --with-http_stub_status_module --with-file-aio --with-http_gzip_static_module && make && make install && ln -s /usr/local/nginx-{{ nginx_version }} /usr/local/nginx\n    - unless: test -d /usr/local/nginx-{{ nginx_version }} && test -L /usr/local/nginx\n    - require:\n      - file: nginx-install\n      - pkg: pkg-install\n```\n3）`service.sls`\n```\n[root@salt-master nginx]# cat service.sls \n#引入nginx安装sls\ninclude:\n  - modules.nginx.install\n\n#添加systemctl\nnginx-init:\n  file.managed:\n    - name: /usr/lib/systemd/system/nginx.service\n    - source: salt://modules/nginx/files/nginx.service.template\n    - user: root\n    - group: root\n    - mode: 755\n    - unless: test -f /usr/lib/systemd/system/nginx.service\n  cmd.run:\n    - name: systemctl daemon-reload\n    - require:\n      - file: nginx-init\n\n#配置文件\n/usr/local/nginx/conf/nginx.conf:\n  file.managed:\n    - source: salt://modules/nginx/files/nginx.conf.template\n    - user: root\n    - group: root\n    - mode: 644\n\n#启动nginx\nnginx-service:\n  file.directory:\n    - name: /usr/local/nginx/conf/conf.d\n    - user: root\n    - group: root\n    - mode: 755\n    - require:\n      - cmd: nginx-install\n  service.running:\n    - name: nginx\n    - enable: True\n    - reload: True\n    - require:\n      - cmd: nginx-init\n    - watch:\n      - file: /usr/local/nginx/conf/nginx.conf\n      - file: nginx-service\n```\n#### php\n1）软件包准备，及配置文件模板，启动文件模板\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/php/\n[root@salt-master php]# tree\n.\n├── files\n│   ├── php-5.6.40.tar.gz\n│   ├── php-fpm.conf.template\n│   ├── php-fpm.service.template\n│   ├── php-fpm.template\n│   └── php.ini.template\n├── install.sls\n└── service.sls\n\n1 directory, 7 files\n```\n2）`install.sls`\n```\n[root@salt-master php]# cat install.sls \n{% set php_version = \"5.6.40\" %}\ninclude:\n  - modules.pkg\n\nphp-install:\n  file.managed:\n    - name: /usr/local/src/php-{{ php_version }}.tar.gz\n    - source: salt://modules/php/files/php-{{ php_version }}.tar.gz\n    - user: root\n    - group: root\n    - mode: 644\n\n  cmd.run:\n    - name: cd /usr/local/src/ && tar xf php-{{ php_version }}.tar.gz && cd php-{{ php_version }} && ./configure --prefix=/usr/local/php-{{ php_version }} --with-curl --with-freetype-dir --with-gd --with-gettext --with-iconv-dir --with-jpeg-dir --with-kerberos --with-libdir=lib64 --with-libxml-dir --with-mysql --with-mysqli --with-openssl --with-pcre-regex --with-pdo-mysql --with-dpo-sqlite --with-pear --with-png-dir --with-openssl --with-xmlrpc --with-xsl --with-zlib --enable-fpm --enable-bcmath --enable-libxml --enable-inline-optimization --enable-gd-native-ttf --enable-mbregex --enable-mbstring --enable-opcache --enable-pcntl --enable-shmop --enable-soap --enable-sockets --enable-sysvsem --enable-xml --enable-zip && make && make install && ln -s /usr/local/php-{{ php_version }} /usr/local/php\n    - unless: test -d /usr/local/php-{{ php_version }} && test -L /usr/local/php\n    - require:\n      - file: php-install\n      - pkg: pkg-install\n```\n3）`service.sls`\n```\n[root@salt-master php]# cat service.sls \n#引入php安装的sls\ninclude:\n  - modules.php.install\n\n#php-ini配置文件配置\nphp-ini:\n  file.managed:\n    - name: /usr/local/php/etc/php.ini\n    - source: salt://modules/php/files/php.ini.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n  cmd.run:\n    - name: ln -s /usr/local/php/etc/php.ini /etc/php.ini\n    - unless: test -L /etc/php.ini\n    - require:\n      - file: php-ini\n\n#php-fpm配置文件配置\nphp-fpm:\n  file.managed:\n    - name: /usr/local/php/etc/php-fpm.conf\n    - source: salt://modules/php/files/php-fpm.conf.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n  cmd.run:\n    - name: ln -s /usr/local/php/etc/php-fpm.conf /etc/php-fpm.conf\n    - unless: test -L /etc/php-fpm.conf\n    - require:\n      - file: php-fpm\n\n#加入system启动\nphp-systemd:\n  file.managed:\n    - name: /usr/lib/systemd/system/php-fpm.service\n    - source: salt://modules/php/files/php-fpm.service.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n\n#加入/etc/init.d/启动\nphp-init:\n  file.managed:\n    - name: /etc/init.d/php-fpm\n    - source: salt://modules/php/files/php-fpm.template\n    - user: root\n    - group: root\n    - mode: 755\n    - require:\n      - cmd: php-install\n\n#启动php-fpm\nphp-service:\n  service.running:\n    - name: php-fpm\n    - enable: True\n    - require:\n      - file: php-systemd\n    - watch:\n      - file: php-fpm\n      - file: php-ini\n```\n#### mysql\n1）配置文件模板准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/mysql/\n[root@salt-master mysql]# tree\n.\n├── files\n│   └── my.cnf\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master mysql]# cat install.sls \nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n```\n3）`service.sls`\n```\n[root@salt-master mysql]# cat service.sls \n#引入mysql安装的sls\ninclude:\n  - modules.mysql.install\n\n#my.cnf配置文件\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://modules/mysql/files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: mariadb-install\n\n#启动mariadb\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n    - watch:\n      - file: mariadb-config\n    - require:\n      - pkg: mariadb-install\n      - file: mariadb-config\n```\n#### lnmp\n1）准备测试文件`php info` 和`nginx`虚拟主机配置文件\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/lnmp/\n[root@salt-master lnmp]# tree\n.\n├── files\n│   ├── index.php\n│   └── www.conf\n└── www.sls\n\n1 directory, 3 files\n```\n2）`www.sls`\n```\n[root@salt-master lnmp]# cat www.sls \n#引入nginx、php、mysql的安装\ninclude:\n  - modules.nginx.service\n  - modules.php.service\n  - modules.mysql.service\n\n#虚拟主机web站点目录创建\nweb-www:\n  file.directory:\n    - name: /opt/www\n    - user: www\n    - group: www\n    - mode: 755\n\n#虚拟主机配置文件配置\nweb-www-conf:\n  file.managed:\n    - name: /usr/local/nginx/conf/conf.d/www.conf\n    - source: salt://modules/lnmp/files/www.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - file: web-www\n    - watch_in:\n      - service: nginx-service\n    - template: jinja\n    - defaults:\n      PORT: 80\n      IPADDR: {{ grains['fqdn_ip4'][0] }}\n\n#phpinfo测试文件准备\nweb-index:\n  file.managed:\n    - name: /opt/www/index.php\n    - source: salt://modules/lnmp/files/index.php\n    - user: www\n    - group: www\n    - mode: 644\n```\n#### 测试lnmp是否OK\n1）`Top file`编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n```\n2）执行高级状态\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n3）访问测试\n![http://192.168.1.31](saltstack项目实战/03.png)\n![http://192.168.1.32](saltstack项目实战/04.png)\n\n#### haproxy\n1）配置文件准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/haproxy/\n[root@salt-master haproxy]# tree\n.\n├── files\n│   └── haproxy.cfg\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master haproxy]# cat install.sls \nhaproxy-install:\n  pkg.installed:\n    - name: haproxy\n```\n3）`service.sls`\n```\n[root@salt-master haproxy]# cat service.sls \n#引入haproxy安装的sls\ninclude:\n  - modules.haproxy.install\n\n#配置文件\nhaproxy-config:\n  file.managed:\n    - name: /etc/haproxy/haproxy.cfg\n    - source: salt://modules/haproxy/files/haproxy.cfg\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: haproxy-install\n\n#启动haproxy\nhaproxy-service:\n  service.running:\n    - name: haproxy\n    - enable: True\n    - require:\n      - pkg: haproxy-install\n      - file: haproxy-config\n    - watch:\n      - file: haproxy-config\n```\n#### keepalived\n1）配置文件准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/keepalived/\n[root@salt-master keepalived]# tree\n.\n├── files\n│   └── keepalived.conf\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master keepalived]# cat install.sls \nkeepalived-install:\n  pkg.installed:\n    - name: keepalived\n```\n3）`service.sls`\n```\n[root@salt-master keepalived]# cat service.sls \n#引入keepalived安装的sls\ninclude:\n  - modules.keepalived.install\n\n#keepalived配置文件\nkeepalived-config:\n  file.managed:\n    - name: /etc/keepalived/keepalived.conf\n    - source: salt://modules/keepalived/files/keepalived.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: keepalived-install\n    - template: jinja\n    - defaults:\n{% if grains['fqdn'] == \"salt-minion01\" %}\n      ROUTER_ID: saltstack01\n      STATE: MASTER\n      PRIORITY: 150\n{% elif grains['fqdn'] == \"salt-minion02\" %}\n      ROUTER_ID: saltstack02\n      STATE: BACKUP\n      PRIORITY: 100\n{% endif %}\n\n#启动keepalived\nkeepalived-service:\n  service.running:\n    - name: keepalived\n    - enable: True\n    - require:\n      - pkg: keepalived-install\n      - file: keepalived-config\n    - watch:\n      - file: keepalived-config\n```\n### 整体部署\n1）top file 编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n\n  \"salt-minion0[1-2]\":\n    - modules.haproxy.service\n    - modules.keepalived.service\n```\n2）高级状态执行\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n3）测试\n访问`192.168.1.31`和`192.168.1.32`的状态页\n![http://192.168.1.31:1314/status](saltstack项目实战/05.png)\n![http://192.168.1.32:1314/status](saltstack项目实战/06.png)\n访问VIP`192.168.1.100`\n![http://192.168.1.100](saltstack项目实战/07.png)\n\n通过上面测试可看到可以成功访问`lnmp`站点，并且`haproxy`也`ok`。访问所有四台服务器都可以得到`phpinfo`页面，而在生产环境中，我们只是对外提供`vip`即可。\n## 项目总结\n1）整体环境查看\n```\n[root@salt-master ~]# tree /srv/salt/prod/modules/\n/srv/salt/prod/modules/\n├── haproxy\n│   ├── files\n│   │   └── haproxy.cfg\n│   ├── install.sls\n│   └── service.sls\n├── keepalived\n│   ├── files\n│   │   └── keepalived.conf\n│   ├── install.sls\n│   └── service.sls\n├── lnmp\n│   ├── files\n│   │   ├── index.php\n│   │   └── www.conf\n│   └── www.sls\n├── mysql\n│   ├── files\n│   │   └── my.cnf\n│   ├── install.sls\n│   └── service.sls\n├── nginx\n│   ├── files\n│   │   ├── nginx-1.12.2.tar.gz\n│   │   ├── nginx-1.16.0.tar.gz\n│   │   ├── nginx.conf.template\n│   │   └── nginx.service.template\n│   ├── install.sls\n│   └── service.sls\n├── php\n│   ├── files\n│   │   ├── php-5.6.40.tar.gz\n│   │   ├── php-fpm.conf.template\n│   │   ├── php-fpm.service.template\n│   │   ├── php-fpm.template\n│   │   └── php.ini.template\n│   ├── install.sls\n│   └── service.sls\n├── pkg.sls\n└── user\n    └── www.sls\n\n13 directories, 27 files\n```\n2）如果需要在某台服务器上面单独部署某一部分，参考以下写法：\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \n#部署lnmp及haproxy+keepalived\nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n\n  \"salt-minion0[1-2]\":\n    - modules.haproxy.service\n    - modules.keepalived.service\n\n#单实例操作说明：\nprod:\n  \"salt-minion04\":\n    - modules.nginx.service\t#单独安装nginx时\n    - modules.mysql.service     #单独安装mysql时\n    - modules.php.service       #单独安装php时\n    - modules.keepalived.service  #单独安装keepalived时\n    - modules.haproxy.service   #单独安装haproxy时\n\n  \"salt-minion03\":\n    - modules.lnmp.www     #单独部署lnmp环境时\n```\n","source":"_posts/saltstack项目实战.md","raw":"---\ntitle: saltstack项目实战\ndate: 2019-05-21 15:43:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## 项目架构规划\n>后端web服务器使用`Nginx+Php`作为站点，通过`HAproxy`做负载均衡，`Keepalived`做高可用\n\n![架构规划图](saltstack项目实战/01.png)\n\n## 项目环境准备\n![环境准备](saltstack项目实战/02.png)\n\n**说明：** 关闭防火墙、`selinux`、时间同步等\n`host`绑定\n```\n[root@salt-master ~]# cat /etc/hosts\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.1.30\tsalt-master\n192.168.1.31\tsalt-minion01\n192.168.1.32\tsalt-minion02\n192.168.1.33\tsalt-minion03\n192.168.1.34\tsalt-minion04\n\n[root@salt-master ~]# for i in `seq 4`; do scp /etc/hosts 192.168.1.3$i:/etc/hosts ; done\n```\n### 软件安装\n[参考地址](https://www.cnblogs.com/yanjieli/p/10864648.html)\n1）`Master`上软件安装\n```\n[root@salt-master ~]# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n[root@salt-master ~]# sed -i \"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\" /etc/yum.repos.d/salt-latest.repo\n[root@salt-master ~]# yum -y install salt-master\n[root@salt-master ~]# systemctl enable salt-master\n[root@salt-master ~]# systemctl start salt-master\n```\n2）`Minion`上软件安装并配置\n```\n# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n# yum -y install salt-minion\n# cp /etc/salt/minion{,.back}\n# sed -i '/#master: /c\\master: salt-master' /etc/salt/minion\n# systemctl enable salt-minion\n# systemctl start salt-minion\n```\n### Master上认证\n```\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nDenied Keys:\nUnaccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nRejected Keys:\n\n[root@salt-master ~]# salt-key -A -y\nThe following keys are going to be accepted:\nUnaccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nKey for minion salt-minion01 accepted.\nKey for minion salt-minion02 accepted.\nKey for minion salt-minion03 accepted.\nKey for minion salt-minion04 accepted.\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nDenied Keys:\nUnaccepted Keys:\nRejected Keys:\n\n[root@salt-master ~]# salt '*' test.ping\nsalt-minion01:\n    True\nsalt-minion02:\n    True\nsalt-minion03:\n    True\nsalt-minion04:\n    True\n```\n## Master上state编写\n### state环境设置\n>说明：该案例在`prod`环境下配置，在`prod`下面创建了一个`modules`的目录，所有的安装配置都放在这个目录下面了，里面分别又对应创建了对应的软件目录，每个软件目录下面的`files`目录用来存放的是软件包或者配置文件模板\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  test:\n    - /srv/salt/test\n  prod:\n    - /srv/salt/prod\n  dev:\n    - /srv/salt/dev\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# mkdir -p /srv/salt/{base,test,prod,dev}\n\n[root@salt-master ~]# mkdir -p /srv/salt/prod/modules/{nginx,php,mysql,haproxy,keepalived,lnmp}/files\n[root@salt-master ~]# mkdir /srv/salt/prod/modules/user\n[root@salt-master ~]# tree /srv/salt/prod/modules/\n/srv/salt/prod/modules/\n├── haproxy\n│   └── files\n├── keepalived\n│   └── files\n├── lnmp\n│   └── files\n├── mysql\n│   └── files\n├── nginx\n│   └── files\n├── php\n│   └── files\n└── user\n\n13 directories, 0 files\n```\n### sls文件编写\n#### pkg基础包\n安装源码编译所需要用到的基础软件包\n```\n[root@salt-master ~]# cat /srv/salt/prod/modules/pkg.sls \npkg-install:\n  pkg.installed:\n    - pkgs:\n      - gcc\n      - gcc-c++\n      - make\n      - autoconf\n      - glibc\n      - glibc-devel\n      - glib2\n      - glib2-devel\n      - pcre\n      - pcre-devel\n      - zlib\n      - zlib-devel\n      - openssl\n      - openssl-devel\n      - libpng\n      - libpng-devel\n      - freetype\n      - freetype-devel\n      - libxml2\n      - libxml2-devel\n      - bzip2\n      - bzip2-devel\n      - ncurses\n      - curl\n      - gdbm-devel\n      - libXpm-devel\n      - libX11-devel\n      - gd-devel\n      - gmp-devel\n      - readline-devel\n      - libxslt-devel\n      - expat-devel\n      - xmlrpc-c\n      - xmlrpc-c-devel\n```\n#### useradd\n创建网站运行用户\n```\n[root@salt-master ~]# cat /srv/salt/prod/modules/user/www.sls \nwww-user-group:\n  group.present:\n    - name: www\n    - gid: 2000\n\n  user.present:\n    - name: www\n    - fullname: www\n    - shell: /sbin/nologin\n    - uid: 2000\n    - gid: 2000\n    - unless: id www\n```\n#### nginx\n1）软件包准备，及配置文件模板，启动文件模板\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/nginx/\n[root@salt-master nginx]# tree \n.\n├── files\n│   ├── nginx-1.12.2.tar.gz\n│   ├── nginx-1.16.0.tar.gz\n│   ├── nginx.conf.template\n│   └── nginx.service.template\n├── install.sls\n└── service.sls\n\n1 directory, 6 files\n```\n2）`install.sls` \n```\n[root@salt-master nginx]# cat install.sls \n{% set nginx_version = \"1.16.0\"%}\ninclude:\n  - modules.pkg\n  - modules.user.www\n\nnginx-install:\n  file.managed:\n    - name: /usr/local/src/nginx-{{ nginx_version }}.tar.gz\n    - source: salt://modules/nginx/files/nginx-{{ nginx_version }}.tar.gz\n    - user: root\n    - group: root\n    - mode: 644\n\n  cmd.run:\n    - name: cd /usr/local/src/ && tar xf nginx-{{ nginx_version }}.tar.gz && cd nginx-{{ nginx_version }} && ./configure --prefix=/usr/local/nginx-{{ nginx_version }} --user=root --group=root --with-http_ssl_module --with-stream --with-http_stub_status_module --with-file-aio --with-http_gzip_static_module && make && make install && ln -s /usr/local/nginx-{{ nginx_version }} /usr/local/nginx\n    - unless: test -d /usr/local/nginx-{{ nginx_version }} && test -L /usr/local/nginx\n    - require:\n      - file: nginx-install\n      - pkg: pkg-install\n```\n3）`service.sls`\n```\n[root@salt-master nginx]# cat service.sls \n#引入nginx安装sls\ninclude:\n  - modules.nginx.install\n\n#添加systemctl\nnginx-init:\n  file.managed:\n    - name: /usr/lib/systemd/system/nginx.service\n    - source: salt://modules/nginx/files/nginx.service.template\n    - user: root\n    - group: root\n    - mode: 755\n    - unless: test -f /usr/lib/systemd/system/nginx.service\n  cmd.run:\n    - name: systemctl daemon-reload\n    - require:\n      - file: nginx-init\n\n#配置文件\n/usr/local/nginx/conf/nginx.conf:\n  file.managed:\n    - source: salt://modules/nginx/files/nginx.conf.template\n    - user: root\n    - group: root\n    - mode: 644\n\n#启动nginx\nnginx-service:\n  file.directory:\n    - name: /usr/local/nginx/conf/conf.d\n    - user: root\n    - group: root\n    - mode: 755\n    - require:\n      - cmd: nginx-install\n  service.running:\n    - name: nginx\n    - enable: True\n    - reload: True\n    - require:\n      - cmd: nginx-init\n    - watch:\n      - file: /usr/local/nginx/conf/nginx.conf\n      - file: nginx-service\n```\n#### php\n1）软件包准备，及配置文件模板，启动文件模板\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/php/\n[root@salt-master php]# tree\n.\n├── files\n│   ├── php-5.6.40.tar.gz\n│   ├── php-fpm.conf.template\n│   ├── php-fpm.service.template\n│   ├── php-fpm.template\n│   └── php.ini.template\n├── install.sls\n└── service.sls\n\n1 directory, 7 files\n```\n2）`install.sls`\n```\n[root@salt-master php]# cat install.sls \n{% set php_version = \"5.6.40\" %}\ninclude:\n  - modules.pkg\n\nphp-install:\n  file.managed:\n    - name: /usr/local/src/php-{{ php_version }}.tar.gz\n    - source: salt://modules/php/files/php-{{ php_version }}.tar.gz\n    - user: root\n    - group: root\n    - mode: 644\n\n  cmd.run:\n    - name: cd /usr/local/src/ && tar xf php-{{ php_version }}.tar.gz && cd php-{{ php_version }} && ./configure --prefix=/usr/local/php-{{ php_version }} --with-curl --with-freetype-dir --with-gd --with-gettext --with-iconv-dir --with-jpeg-dir --with-kerberos --with-libdir=lib64 --with-libxml-dir --with-mysql --with-mysqli --with-openssl --with-pcre-regex --with-pdo-mysql --with-dpo-sqlite --with-pear --with-png-dir --with-openssl --with-xmlrpc --with-xsl --with-zlib --enable-fpm --enable-bcmath --enable-libxml --enable-inline-optimization --enable-gd-native-ttf --enable-mbregex --enable-mbstring --enable-opcache --enable-pcntl --enable-shmop --enable-soap --enable-sockets --enable-sysvsem --enable-xml --enable-zip && make && make install && ln -s /usr/local/php-{{ php_version }} /usr/local/php\n    - unless: test -d /usr/local/php-{{ php_version }} && test -L /usr/local/php\n    - require:\n      - file: php-install\n      - pkg: pkg-install\n```\n3）`service.sls`\n```\n[root@salt-master php]# cat service.sls \n#引入php安装的sls\ninclude:\n  - modules.php.install\n\n#php-ini配置文件配置\nphp-ini:\n  file.managed:\n    - name: /usr/local/php/etc/php.ini\n    - source: salt://modules/php/files/php.ini.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n  cmd.run:\n    - name: ln -s /usr/local/php/etc/php.ini /etc/php.ini\n    - unless: test -L /etc/php.ini\n    - require:\n      - file: php-ini\n\n#php-fpm配置文件配置\nphp-fpm:\n  file.managed:\n    - name: /usr/local/php/etc/php-fpm.conf\n    - source: salt://modules/php/files/php-fpm.conf.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n  cmd.run:\n    - name: ln -s /usr/local/php/etc/php-fpm.conf /etc/php-fpm.conf\n    - unless: test -L /etc/php-fpm.conf\n    - require:\n      - file: php-fpm\n\n#加入system启动\nphp-systemd:\n  file.managed:\n    - name: /usr/lib/systemd/system/php-fpm.service\n    - source: salt://modules/php/files/php-fpm.service.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n\n#加入/etc/init.d/启动\nphp-init:\n  file.managed:\n    - name: /etc/init.d/php-fpm\n    - source: salt://modules/php/files/php-fpm.template\n    - user: root\n    - group: root\n    - mode: 755\n    - require:\n      - cmd: php-install\n\n#启动php-fpm\nphp-service:\n  service.running:\n    - name: php-fpm\n    - enable: True\n    - require:\n      - file: php-systemd\n    - watch:\n      - file: php-fpm\n      - file: php-ini\n```\n#### mysql\n1）配置文件模板准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/mysql/\n[root@salt-master mysql]# tree\n.\n├── files\n│   └── my.cnf\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master mysql]# cat install.sls \nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n```\n3）`service.sls`\n```\n[root@salt-master mysql]# cat service.sls \n#引入mysql安装的sls\ninclude:\n  - modules.mysql.install\n\n#my.cnf配置文件\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://modules/mysql/files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: mariadb-install\n\n#启动mariadb\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n    - watch:\n      - file: mariadb-config\n    - require:\n      - pkg: mariadb-install\n      - file: mariadb-config\n```\n#### lnmp\n1）准备测试文件`php info` 和`nginx`虚拟主机配置文件\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/lnmp/\n[root@salt-master lnmp]# tree\n.\n├── files\n│   ├── index.php\n│   └── www.conf\n└── www.sls\n\n1 directory, 3 files\n```\n2）`www.sls`\n```\n[root@salt-master lnmp]# cat www.sls \n#引入nginx、php、mysql的安装\ninclude:\n  - modules.nginx.service\n  - modules.php.service\n  - modules.mysql.service\n\n#虚拟主机web站点目录创建\nweb-www:\n  file.directory:\n    - name: /opt/www\n    - user: www\n    - group: www\n    - mode: 755\n\n#虚拟主机配置文件配置\nweb-www-conf:\n  file.managed:\n    - name: /usr/local/nginx/conf/conf.d/www.conf\n    - source: salt://modules/lnmp/files/www.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - file: web-www\n    - watch_in:\n      - service: nginx-service\n    - template: jinja\n    - defaults:\n      PORT: 80\n      IPADDR: {{ grains['fqdn_ip4'][0] }}\n\n#phpinfo测试文件准备\nweb-index:\n  file.managed:\n    - name: /opt/www/index.php\n    - source: salt://modules/lnmp/files/index.php\n    - user: www\n    - group: www\n    - mode: 644\n```\n#### 测试lnmp是否OK\n1）`Top file`编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n```\n2）执行高级状态\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n3）访问测试\n![http://192.168.1.31](saltstack项目实战/03.png)\n![http://192.168.1.32](saltstack项目实战/04.png)\n\n#### haproxy\n1）配置文件准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/haproxy/\n[root@salt-master haproxy]# tree\n.\n├── files\n│   └── haproxy.cfg\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master haproxy]# cat install.sls \nhaproxy-install:\n  pkg.installed:\n    - name: haproxy\n```\n3）`service.sls`\n```\n[root@salt-master haproxy]# cat service.sls \n#引入haproxy安装的sls\ninclude:\n  - modules.haproxy.install\n\n#配置文件\nhaproxy-config:\n  file.managed:\n    - name: /etc/haproxy/haproxy.cfg\n    - source: salt://modules/haproxy/files/haproxy.cfg\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: haproxy-install\n\n#启动haproxy\nhaproxy-service:\n  service.running:\n    - name: haproxy\n    - enable: True\n    - require:\n      - pkg: haproxy-install\n      - file: haproxy-config\n    - watch:\n      - file: haproxy-config\n```\n#### keepalived\n1）配置文件准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/keepalived/\n[root@salt-master keepalived]# tree\n.\n├── files\n│   └── keepalived.conf\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master keepalived]# cat install.sls \nkeepalived-install:\n  pkg.installed:\n    - name: keepalived\n```\n3）`service.sls`\n```\n[root@salt-master keepalived]# cat service.sls \n#引入keepalived安装的sls\ninclude:\n  - modules.keepalived.install\n\n#keepalived配置文件\nkeepalived-config:\n  file.managed:\n    - name: /etc/keepalived/keepalived.conf\n    - source: salt://modules/keepalived/files/keepalived.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: keepalived-install\n    - template: jinja\n    - defaults:\n{% if grains['fqdn'] == \"salt-minion01\" %}\n      ROUTER_ID: saltstack01\n      STATE: MASTER\n      PRIORITY: 150\n{% elif grains['fqdn'] == \"salt-minion02\" %}\n      ROUTER_ID: saltstack02\n      STATE: BACKUP\n      PRIORITY: 100\n{% endif %}\n\n#启动keepalived\nkeepalived-service:\n  service.running:\n    - name: keepalived\n    - enable: True\n    - require:\n      - pkg: keepalived-install\n      - file: keepalived-config\n    - watch:\n      - file: keepalived-config\n```\n### 整体部署\n1）top file 编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n\n  \"salt-minion0[1-2]\":\n    - modules.haproxy.service\n    - modules.keepalived.service\n```\n2）高级状态执行\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n3）测试\n访问`192.168.1.31`和`192.168.1.32`的状态页\n![http://192.168.1.31:1314/status](saltstack项目实战/05.png)\n![http://192.168.1.32:1314/status](saltstack项目实战/06.png)\n访问VIP`192.168.1.100`\n![http://192.168.1.100](saltstack项目实战/07.png)\n\n通过上面测试可看到可以成功访问`lnmp`站点，并且`haproxy`也`ok`。访问所有四台服务器都可以得到`phpinfo`页面，而在生产环境中，我们只是对外提供`vip`即可。\n## 项目总结\n1）整体环境查看\n```\n[root@salt-master ~]# tree /srv/salt/prod/modules/\n/srv/salt/prod/modules/\n├── haproxy\n│   ├── files\n│   │   └── haproxy.cfg\n│   ├── install.sls\n│   └── service.sls\n├── keepalived\n│   ├── files\n│   │   └── keepalived.conf\n│   ├── install.sls\n│   └── service.sls\n├── lnmp\n│   ├── files\n│   │   ├── index.php\n│   │   └── www.conf\n│   └── www.sls\n├── mysql\n│   ├── files\n│   │   └── my.cnf\n│   ├── install.sls\n│   └── service.sls\n├── nginx\n│   ├── files\n│   │   ├── nginx-1.12.2.tar.gz\n│   │   ├── nginx-1.16.0.tar.gz\n│   │   ├── nginx.conf.template\n│   │   └── nginx.service.template\n│   ├── install.sls\n│   └── service.sls\n├── php\n│   ├── files\n│   │   ├── php-5.6.40.tar.gz\n│   │   ├── php-fpm.conf.template\n│   │   ├── php-fpm.service.template\n│   │   ├── php-fpm.template\n│   │   └── php.ini.template\n│   ├── install.sls\n│   └── service.sls\n├── pkg.sls\n└── user\n    └── www.sls\n\n13 directories, 27 files\n```\n2）如果需要在某台服务器上面单独部署某一部分，参考以下写法：\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \n#部署lnmp及haproxy+keepalived\nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n\n  \"salt-minion0[1-2]\":\n    - modules.haproxy.service\n    - modules.keepalived.service\n\n#单实例操作说明：\nprod:\n  \"salt-minion04\":\n    - modules.nginx.service\t#单独安装nginx时\n    - modules.mysql.service     #单独安装mysql时\n    - modules.php.service       #单独安装php时\n    - modules.keepalived.service  #单独安装keepalived时\n    - modules.haproxy.service   #单独安装haproxy时\n\n  \"salt-minion03\":\n    - modules.lnmp.www     #单独部署lnmp环境时\n```\n","slug":"saltstack项目实战","published":1,"updated":"2019-05-28T14:26:57.451Z","_id":"cjxwlqrqd002flctc55dkujpm","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"项目架构规划\"><a href=\"#项目架构规划\" class=\"headerlink\" title=\"项目架构规划\"></a>项目架构规划</h2><blockquote>\n<p>后端web服务器使用<code>Nginx+Php</code>作为站点，通过<code>HAproxy</code>做负载均衡，<code>Keepalived</code>做高可用</p>\n</blockquote>\n<p><img src=\"/2019/05/21/saltstack项目实战/01.png\" alt=\"架构规划图\"></p>\n<h2 id=\"项目环境准备\"><a href=\"#项目环境准备\" class=\"headerlink\" title=\"项目环境准备\"></a>项目环境准备</h2><p><img src=\"/2019/05/21/saltstack项目实战/02.png\" alt=\"环境准备\"></p>\n<p><strong>说明：</strong> 关闭防火墙、<code>selinux</code>、时间同步等<br><code>host</code>绑定<br><figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /etc/hosts</span><br><span class=\"line\"><span class=\"number\">127.0</span><span class=\"meta\">.0</span><span class=\"meta\">.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class=\"line\">::<span class=\"number\">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>\tsalt-master</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.31</span>\tsalt-minion01</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.32</span>\tsalt-minion02</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.33</span>\tsalt-minion03</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.34</span>\tsalt-minion04</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# for i <span class=\"keyword\">in</span> <span class=\"string\">`seq 4`</span><span class=\"comment\">; do scp /etc/hosts 192.168.1.3$i:/etc/hosts ; done</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"软件安装\"><a href=\"#软件安装\" class=\"headerlink\" title=\"软件安装\"></a>软件安装</h3><p><a href=\"https://www.cnblogs.com/yanjieli/p/10864648.html\" target=\"_blank\" rel=\"noopener\">参考地址</a><br>1）<code>Master</code>上软件安装<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class=\"number\">2</span>.el7.noarch.rpm</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# sed</span> -i <span class=\"string\">\"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> enable salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>2）<code>Minion</code>上软件安装并配置<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm</span></span><br><span class=\"line\"><span class=\"meta\"># yum -y install salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class=\"line\"><span class=\"meta\"># sed -i '/#master: /c\\master: salt-master' /etc/salt/minion</span></span><br><span class=\"line\"><span class=\"meta\"># systemctl enable salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Master上认证\"><a href=\"#Master上认证\" class=\"headerlink\" title=\"Master上认证\"></a>Master上认证</h3><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -A -y</span><br><span class=\"line\">The following keys are going to be accepted:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Key for minion salt-minion01 accepted.</span><br><span class=\"line\">Key for minion salt-minion02 accepted.</span><br><span class=\"line\">Key for minion salt-minion03 accepted.</span><br><span class=\"line\">Key for minion salt-minion04 accepted.</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' test.ping</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion04:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Master上state编写\"><a href=\"#Master上state编写\" class=\"headerlink\" title=\"Master上state编写\"></a>Master上state编写</h2><h3 id=\"state环境设置\"><a href=\"#state环境设置\" class=\"headerlink\" title=\"state环境设置\"></a>state环境设置</h3><blockquote>\n<p>说明：该案例在<code>prod</code>环境下配置，在<code>prod</code>下面创建了一个<code>modules</code>的目录，所有的安装配置都放在这个目录下面了，里面分别又对应创建了对应的软件目录，每个软件目录下面的<code>files</code>目录用来存放的是软件包或者配置文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">file_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/salt/base</span><br><span class=\"line\">  test:</span><br><span class=\"line\">    - /srv/salt/test</span><br><span class=\"line\">  prod:</span><br><span class=\"line\">    - /srv/salt/prod</span><br><span class=\"line\">  dev:</span><br><span class=\"line\">    - /srv/salt/dev</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,test,prod,dev&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/prod/modules/&#123;nginx,php,mysql,haproxy,keepalived,lnmp&#125;/files</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/salt/prod/modules/user</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /srv/salt/prod/modules/</span><br><span class=\"line\">/srv/salt/prod/modules/</span><br><span class=\"line\">├── haproxy</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── keepalived</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── lnmp</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── mysql</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── nginx</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── php</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">└── user</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">13</span> directories, <span class=\"number\">0</span> files</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"sls文件编写\"><a href=\"#sls文件编写\" class=\"headerlink\" title=\"sls文件编写\"></a>sls文件编写</h3><h4 id=\"pkg基础包\"><a href=\"#pkg基础包\" class=\"headerlink\" title=\"pkg基础包\"></a>pkg基础包</h4><p>安装源码编译所需要用到的基础软件包<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/modules/pkg.sls </span><br><span class=\"line\">pkg-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - gcc</span></span><br><span class=\"line\"><span class=\"ruby\">      - gcc-c++</span></span><br><span class=\"line\"><span class=\"ruby\">      - make</span></span><br><span class=\"line\"><span class=\"ruby\">      - autoconf</span></span><br><span class=\"line\"><span class=\"ruby\">      - glibc</span></span><br><span class=\"line\"><span class=\"ruby\">      - glibc-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - glib2</span></span><br><span class=\"line\"><span class=\"ruby\">      - glib2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - pcre</span></span><br><span class=\"line\"><span class=\"ruby\">      - pcre-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - zlib</span></span><br><span class=\"line\"><span class=\"ruby\">      - zlib-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - openssl</span></span><br><span class=\"line\"><span class=\"ruby\">      - openssl-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libpng</span></span><br><span class=\"line\"><span class=\"ruby\">      - libpng-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - freetype</span></span><br><span class=\"line\"><span class=\"ruby\">      - freetype-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxml2</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxml2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - bzip2</span></span><br><span class=\"line\"><span class=\"ruby\">      - bzip2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - ncurses</span></span><br><span class=\"line\"><span class=\"ruby\">      - curl</span></span><br><span class=\"line\"><span class=\"ruby\">      - gdbm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libXpm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libX11-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - gd-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - gmp-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - readline-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxslt-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - expat-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - xmlrpc-c</span></span><br><span class=\"line\"><span class=\"ruby\">      - xmlrpc-c-devel</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"useradd\"><a href=\"#useradd\" class=\"headerlink\" title=\"useradd\"></a>useradd</h4><p>创建网站运行用户<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/modules/user/www.sls</span> </span><br><span class=\"line\"><span class=\"attr\">www-user-group:</span></span><br><span class=\"line\">  <span class=\"string\">group.present:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - gid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">user.present:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - fullname:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - shell:</span> <span class=\"string\">/sbin/nologin</span></span><br><span class=\"line\"><span class=\"attr\">    - uid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"><span class=\"attr\">    - gid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">id</span> <span class=\"string\">www</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"nginx\"><a href=\"#nginx\" class=\"headerlink\" title=\"nginx\"></a>nginx</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/nginx/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">nginx</span>]<span class=\"comment\"># tree </span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── nginx-<span class=\"number\">1.12</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\">│   ├── nginx-<span class=\"number\">1.16</span>.<span class=\"number\">0</span>.tar.gz</span><br><span class=\"line\">│   ├── nginx.conf.template</span><br><span class=\"line\">│   └── nginx.service.template</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">6</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master nginx]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">&#123;% <span class=\"keyword\">set</span> nginx_<span class=\"keyword\">version</span> = <span class=\"string\">\"1.16.0\"</span>%&#125;</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - modules.pkg</span><br><span class=\"line\">  - modules.user.www</span><br><span class=\"line\"></span><br><span class=\"line\">nginx-install:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - name: <span class=\"string\">/usr/local/src/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - source: salt:<span class=\"string\">//modules/nginx/files/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: 644</span><br><span class=\"line\"></span><br><span class=\"line\">  cmd.run:</span><br><span class=\"line\">    - name: <span class=\"keyword\">cd</span> <span class=\"string\">/usr/local/src/</span> &amp;&amp; tar xf nginx-&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span> &amp;&amp; <span class=\"keyword\">cd</span> nginx-&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; <span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"params\">--user=root</span> <span class=\"params\">--group=root</span> <span class=\"params\">--with-http_ssl_module</span> <span class=\"params\">--with-stream</span> <span class=\"params\">--with-http_stub_status_module</span> <span class=\"params\">--with-file-aio</span> <span class=\"params\">--with-http_gzip_static_module</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class=\"string\">/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"string\">/usr/local/nginx</span></span><br><span class=\"line\">    - unless: test -d <span class=\"string\">/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; test -L <span class=\"string\">/usr/local/nginx</span></span><br><span class=\"line\">    - require:</span><br><span class=\"line\">      - file: nginx-install</span><br><span class=\"line\">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">nginx]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入nginx安装sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.nginx.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加systemctl</span></span><br><span class=\"line\"><span class=\"attr\">nginx-init:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/lib/systemd/system/nginx.service</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/nginx/files/nginx.service.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-f</span> <span class=\"string\">/usr/lib/systemd/system/nginx.service</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">systemctl</span> <span class=\"string\">daemon-reload</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">nginx-init</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置文件</span></span><br><span class=\"line\"><span class=\"string\">/usr/local/nginx/conf/nginx.conf:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/nginx/files/nginx.conf.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动nginx</span></span><br><span class=\"line\"><span class=\"attr\">nginx-service:</span></span><br><span class=\"line\">  <span class=\"string\">file.directory:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/nginx/conf/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">nginx-install</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">nginx-init</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">/usr/local/nginx/conf/nginx.conf</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">nginx-service</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"php\"><a href=\"#php\" class=\"headerlink\" title=\"php\"></a>php</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/php/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">php</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── php-<span class=\"number\">5.6</span>.<span class=\"number\">40</span>.tar.gz</span><br><span class=\"line\">│   ├── php-fpm.conf.template</span><br><span class=\"line\">│   ├── php-fpm.service.template</span><br><span class=\"line\">│   ├── php-fpm.template</span><br><span class=\"line\">│   └── php.ini.template</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">7</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master php]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">&#123;% <span class=\"keyword\">set</span> php_<span class=\"keyword\">version</span> = <span class=\"string\">\"5.6.40\"</span> %&#125;</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - modules.pkg</span><br><span class=\"line\"></span><br><span class=\"line\">php-install:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - name: <span class=\"string\">/usr/local/src/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - source: salt:<span class=\"string\">//modules/php/files/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: 644</span><br><span class=\"line\"></span><br><span class=\"line\">  cmd.run:</span><br><span class=\"line\">    - name: <span class=\"keyword\">cd</span> <span class=\"string\">/usr/local/src/</span> &amp;&amp; tar xf php-&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span> &amp;&amp; <span class=\"keyword\">cd</span> php-&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; <span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"params\">--with-curl</span> <span class=\"params\">--with-freetype-dir</span> <span class=\"params\">--with-gd</span> <span class=\"params\">--with-gettext</span> <span class=\"params\">--with-iconv-dir</span> <span class=\"params\">--with-jpeg-dir</span> <span class=\"params\">--with-kerberos</span> <span class=\"params\">--with-libdir=lib64</span> <span class=\"params\">--with-libxml-dir</span> <span class=\"params\">--with-mysql</span> <span class=\"params\">--with-mysqli</span> <span class=\"params\">--with-openssl</span> <span class=\"params\">--with-pcre-regex</span> <span class=\"params\">--with-pdo-mysql</span> <span class=\"params\">--with-dpo-sqlite</span> <span class=\"params\">--with-pear</span> <span class=\"params\">--with-png-dir</span> <span class=\"params\">--with-openssl</span> <span class=\"params\">--with-xmlrpc</span> <span class=\"params\">--with-xsl</span> <span class=\"params\">--with-zlib</span> <span class=\"params\">--enable-fpm</span> <span class=\"params\">--enable-bcmath</span> <span class=\"params\">--enable-libxml</span> <span class=\"params\">--enable-inline-optimization</span> <span class=\"params\">--enable-gd-native-ttf</span> <span class=\"params\">--enable-mbregex</span> <span class=\"params\">--enable-mbstring</span> <span class=\"params\">--enable-opcache</span> <span class=\"params\">--enable-pcntl</span> <span class=\"params\">--enable-shmop</span> <span class=\"params\">--enable-soap</span> <span class=\"params\">--enable-sockets</span> <span class=\"params\">--enable-sysvsem</span> <span class=\"params\">--enable-xml</span> <span class=\"params\">--enable-zip</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class=\"string\">/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"string\">/usr/local/php</span></span><br><span class=\"line\">    - unless: test -d <span class=\"string\">/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; test -L <span class=\"string\">/usr/local/php</span></span><br><span class=\"line\">    - require:</span><br><span class=\"line\">      - file: php-install</span><br><span class=\"line\">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">php]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入php安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.php.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php-ini配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">php-ini:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/php/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php.ini.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ln</span> <span class=\"bullet\">-s</span> <span class=\"string\">/usr/local/php/etc/php.ini</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-L</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-ini</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php-fpm配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">php-fpm:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/php/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.conf.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ln</span> <span class=\"bullet\">-s</span> <span class=\"string\">/usr/local/php/etc/php-fpm.conf</span> <span class=\"string\">/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-L</span> <span class=\"string\">/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#加入system启动</span></span><br><span class=\"line\"><span class=\"attr\">php-systemd:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/lib/systemd/system/php-fpm.service</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.service.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#加入/etc/init.d/启动</span></span><br><span class=\"line\"><span class=\"attr\">php-init:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/init.d/php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">php-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-systemd</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-ini</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"mysql\"><a href=\"#mysql\" class=\"headerlink\" title=\"mysql\"></a>mysql</h4><p>1）配置文件模板准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/mysql/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">mysql</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── my.cnf</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">mysql</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">mariadb-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkgs:</span><br><span class=\"line\">      - mariadb-server</span><br><span class=\"line\">      - mariadb</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">mysql]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入mysql安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.mysql.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#my.cnf配置文件</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/mysql/files/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动mariadb</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"lnmp\"><a href=\"#lnmp\" class=\"headerlink\" title=\"lnmp\"></a>lnmp</h4><p>1）准备测试文件<code>php info</code> 和<code>nginx</code>虚拟主机配置文件<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/lnmp/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">lnmp</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── index.php</span><br><span class=\"line\">│   └── www.conf</span><br><span class=\"line\">└── www.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>www.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">lnmp]#</span> <span class=\"string\">cat</span> <span class=\"string\">www.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入nginx、php、mysql的安装</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.nginx.service</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.php.service</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.mysql.service</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#虚拟主机web站点目录创建</span></span><br><span class=\"line\"><span class=\"attr\">web-www:</span></span><br><span class=\"line\">  <span class=\"string\">file.directory:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/opt/www</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#虚拟主机配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">web-www-conf:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/nginx/conf/conf.d/www.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/lnmp/files/www.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">web-www</span></span><br><span class=\"line\"><span class=\"attr\">    - watch_in:</span></span><br><span class=\"line\"><span class=\"attr\">      - service:</span> <span class=\"string\">nginx-service</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">      IPADDR:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#phpinfo测试文件准备</span></span><br><span class=\"line\"><span class=\"attr\">web-index:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/opt/www/index.php</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/lnmp/files/index.php</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"测试lnmp是否OK\"><a href=\"#测试lnmp是否OK\" class=\"headerlink\" title=\"测试lnmp是否OK\"></a>测试lnmp是否OK</h4><p>1）<code>Top file</code>编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br></pre></td></tr></table></figure></p>\n<p>2）执行高级状态<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<p>3）访问测试<br><img src=\"/2019/05/21/saltstack项目实战/03.png\" alt=\"http://192.168.1.31\"><br><img src=\"/2019/05/21/saltstack项目实战/04.png\" alt=\"http://192.168.1.32\"></p>\n<h4 id=\"haproxy\"><a href=\"#haproxy\" class=\"headerlink\" title=\"haproxy\"></a>haproxy</h4><p>1）配置文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/haproxy/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">haproxy</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── haproxy.cfg</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">haproxy</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">haproxy-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - name: haproxy</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">haproxy]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入haproxy安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.haproxy.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置文件</span></span><br><span class=\"line\"><span class=\"attr\">haproxy-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/haproxy/files/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">haproxy-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动haproxy</span></span><br><span class=\"line\"><span class=\"attr\">haproxy-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">haproxy</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">haproxy-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">haproxy-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">haproxy-config</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"keepalived\"><a href=\"#keepalived\" class=\"headerlink\" title=\"keepalived\"></a>keepalived</h4><p>1）配置文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/keepalived/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">keepalived</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── keepalived.conf</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">keepalived</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">keepalived-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - name: keepalived</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">keepalived]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入keepalived安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.keepalived.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#keepalived配置文件</span></span><br><span class=\"line\"><span class=\"attr\">keepalived-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/keepalived/keepalived.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/keepalived/files/keepalived.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">keepalived-install</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">if</span> <span class=\"string\">grains['fqdn']</span> <span class=\"string\">==</span> <span class=\"string\">\"salt-minion01\"</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      ROUTER_ID:</span> <span class=\"string\">saltstack01</span></span><br><span class=\"line\"><span class=\"attr\">      STATE:</span> <span class=\"string\">MASTER</span></span><br><span class=\"line\"><span class=\"attr\">      PRIORITY:</span> <span class=\"number\">150</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">elif</span> <span class=\"string\">grains['fqdn']</span> <span class=\"string\">==</span> <span class=\"string\">\"salt-minion02\"</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      ROUTER_ID:</span> <span class=\"string\">saltstack02</span></span><br><span class=\"line\"><span class=\"attr\">      STATE:</span> <span class=\"string\">BACKUP</span></span><br><span class=\"line\"><span class=\"attr\">      PRIORITY:</span> <span class=\"number\">100</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">endif</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动keepalived</span></span><br><span class=\"line\"><span class=\"attr\">keepalived-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">keepalived</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">keepalived-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">keepalived-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">keepalived-config</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"整体部署\"><a href=\"#整体部署\" class=\"headerlink\" title=\"整体部署\"></a>整体部署</h3><p>1）top file 编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[1-2]\"</span>:</span><br><span class=\"line\">    - modules.haproxy.service</span><br><span class=\"line\">    - modules.keepalived.service</span><br></pre></td></tr></table></figure></p>\n<p>2）高级状态执行<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<p>3）测试<br>访问<code>192.168.1.31</code>和<code>192.168.1.32</code>的状态页<br><img src=\"/2019/05/21/saltstack项目实战/05.png\" alt=\"http://192.168.1.31:1314/status\"><br><img src=\"/2019/05/21/saltstack项目实战/06.png\" alt=\"http://192.168.1.32:1314/status\"><br>访问VIP<code>192.168.1.100</code><br><img src=\"/2019/05/21/saltstack项目实战/07.png\" alt=\"http://192.168.1.100\"></p>\n<p>通过上面测试可看到可以成功访问<code>lnmp</code>站点，并且<code>haproxy</code>也<code>ok</code>。访问所有四台服务器都可以得到<code>phpinfo</code>页面，而在生产环境中，我们只是对外提供<code>vip</code>即可。</p>\n<h2 id=\"项目总结\"><a href=\"#项目总结\" class=\"headerlink\" title=\"项目总结\"></a>项目总结</h2><p>1）整体环境查看<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# tree /srv/salt/prod/modules/</span><br><span class=\"line\">/srv/salt/prod/modules/</span><br><span class=\"line\">├── haproxy</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── haproxy.cfg</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── keepalived</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── keepalived.<span class=\"keyword\">conf</span></span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── lnmp</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── <span class=\"built_in\">index</span>.php</span><br><span class=\"line\">│   │   └── www.<span class=\"keyword\">conf</span></span><br><span class=\"line\">│   └── www.sls</span><br><span class=\"line\">├── mysql</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── nginx</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── nginx-<span class=\"number\">1.12</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\">│   │   ├── nginx-<span class=\"number\">1.16</span>.<span class=\"number\">0</span>.tar.gz</span><br><span class=\"line\">│   │   ├── nginx.<span class=\"keyword\">conf</span>.template</span><br><span class=\"line\">│   │   └── nginx.service.template</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── php</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── php-<span class=\"number\">5.6</span>.<span class=\"number\">40</span>.tar.gz</span><br><span class=\"line\">│   │   ├── php-fpm.<span class=\"keyword\">conf</span>.template</span><br><span class=\"line\">│   │   ├── php-fpm.service.template</span><br><span class=\"line\">│   │   ├── php-fpm.template</span><br><span class=\"line\">│   │   └── php.ini.template</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── pkg.sls</span><br><span class=\"line\">└── user</span><br><span class=\"line\">    └── www.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">13</span> directories, <span class=\"number\">27</span> <span class=\"keyword\">files</span></span><br></pre></td></tr></table></figure></p>\n<p>2）如果需要在某台服务器上面单独部署某一部分，参考以下写法：<br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># cat /srv/salt/base/top.sls </span></span><br><span class=\"line\"><span class=\"meta\">#部署lnmp及haproxy+keepalived</span></span><br><span class=\"line\"><span class=\"symbol\">prod:</span></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[1-2]\"</span>:</span><br><span class=\"line\">    - modules.haproxy.service</span><br><span class=\"line\">    - modules.keepalived.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#单实例操作说明：</span></span><br><span class=\"line\"><span class=\"symbol\">prod:</span></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion04\"</span>:</span><br><span class=\"line\">    - modules.nginx.service\t<span class=\"meta\">#单独安装nginx时</span></span><br><span class=\"line\">    - modules.mysql.service     <span class=\"meta\">#单独安装mysql时</span></span><br><span class=\"line\">    - modules.php.service       <span class=\"meta\">#单独安装php时</span></span><br><span class=\"line\">    - modules.keepalived.service  <span class=\"meta\">#单独安装keepalived时</span></span><br><span class=\"line\">    - modules.haproxy.service   <span class=\"meta\">#单独安装haproxy时</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion03\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www     <span class=\"meta\">#单独部署lnmp环境时</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"项目架构规划\"><a href=\"#项目架构规划\" class=\"headerlink\" title=\"项目架构规划\"></a>项目架构规划</h2><blockquote>\n<p>后端web服务器使用<code>Nginx+Php</code>作为站点，通过<code>HAproxy</code>做负载均衡，<code>Keepalived</code>做高可用</p>\n</blockquote>\n<p><img src=\"/2019/05/21/saltstack项目实战/01.png\" alt=\"架构规划图\"></p>\n<h2 id=\"项目环境准备\"><a href=\"#项目环境准备\" class=\"headerlink\" title=\"项目环境准备\"></a>项目环境准备</h2><p><img src=\"/2019/05/21/saltstack项目实战/02.png\" alt=\"环境准备\"></p>\n<p><strong>说明：</strong> 关闭防火墙、<code>selinux</code>、时间同步等<br><code>host</code>绑定<br><figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /etc/hosts</span><br><span class=\"line\"><span class=\"number\">127.0</span><span class=\"meta\">.0</span><span class=\"meta\">.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class=\"line\">::<span class=\"number\">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>\tsalt-master</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.31</span>\tsalt-minion01</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.32</span>\tsalt-minion02</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.33</span>\tsalt-minion03</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.34</span>\tsalt-minion04</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# for i <span class=\"keyword\">in</span> <span class=\"string\">`seq 4`</span><span class=\"comment\">; do scp /etc/hosts 192.168.1.3$i:/etc/hosts ; done</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"软件安装\"><a href=\"#软件安装\" class=\"headerlink\" title=\"软件安装\"></a>软件安装</h3><p><a href=\"https://www.cnblogs.com/yanjieli/p/10864648.html\" target=\"_blank\" rel=\"noopener\">参考地址</a><br>1）<code>Master</code>上软件安装<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class=\"number\">2</span>.el7.noarch.rpm</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# sed</span> -i <span class=\"string\">\"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> enable salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>2）<code>Minion</code>上软件安装并配置<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm</span></span><br><span class=\"line\"><span class=\"meta\"># yum -y install salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class=\"line\"><span class=\"meta\"># sed -i '/#master: /c\\master: salt-master' /etc/salt/minion</span></span><br><span class=\"line\"><span class=\"meta\"># systemctl enable salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Master上认证\"><a href=\"#Master上认证\" class=\"headerlink\" title=\"Master上认证\"></a>Master上认证</h3><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -A -y</span><br><span class=\"line\">The following keys are going to be accepted:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Key for minion salt-minion01 accepted.</span><br><span class=\"line\">Key for minion salt-minion02 accepted.</span><br><span class=\"line\">Key for minion salt-minion03 accepted.</span><br><span class=\"line\">Key for minion salt-minion04 accepted.</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' test.ping</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion04:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Master上state编写\"><a href=\"#Master上state编写\" class=\"headerlink\" title=\"Master上state编写\"></a>Master上state编写</h2><h3 id=\"state环境设置\"><a href=\"#state环境设置\" class=\"headerlink\" title=\"state环境设置\"></a>state环境设置</h3><blockquote>\n<p>说明：该案例在<code>prod</code>环境下配置，在<code>prod</code>下面创建了一个<code>modules</code>的目录，所有的安装配置都放在这个目录下面了，里面分别又对应创建了对应的软件目录，每个软件目录下面的<code>files</code>目录用来存放的是软件包或者配置文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">file_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/salt/base</span><br><span class=\"line\">  test:</span><br><span class=\"line\">    - /srv/salt/test</span><br><span class=\"line\">  prod:</span><br><span class=\"line\">    - /srv/salt/prod</span><br><span class=\"line\">  dev:</span><br><span class=\"line\">    - /srv/salt/dev</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,test,prod,dev&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/prod/modules/&#123;nginx,php,mysql,haproxy,keepalived,lnmp&#125;/files</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/salt/prod/modules/user</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /srv/salt/prod/modules/</span><br><span class=\"line\">/srv/salt/prod/modules/</span><br><span class=\"line\">├── haproxy</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── keepalived</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── lnmp</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── mysql</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── nginx</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── php</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">└── user</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">13</span> directories, <span class=\"number\">0</span> files</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"sls文件编写\"><a href=\"#sls文件编写\" class=\"headerlink\" title=\"sls文件编写\"></a>sls文件编写</h3><h4 id=\"pkg基础包\"><a href=\"#pkg基础包\" class=\"headerlink\" title=\"pkg基础包\"></a>pkg基础包</h4><p>安装源码编译所需要用到的基础软件包<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/modules/pkg.sls </span><br><span class=\"line\">pkg-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - gcc</span></span><br><span class=\"line\"><span class=\"ruby\">      - gcc-c++</span></span><br><span class=\"line\"><span class=\"ruby\">      - make</span></span><br><span class=\"line\"><span class=\"ruby\">      - autoconf</span></span><br><span class=\"line\"><span class=\"ruby\">      - glibc</span></span><br><span class=\"line\"><span class=\"ruby\">      - glibc-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - glib2</span></span><br><span class=\"line\"><span class=\"ruby\">      - glib2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - pcre</span></span><br><span class=\"line\"><span class=\"ruby\">      - pcre-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - zlib</span></span><br><span class=\"line\"><span class=\"ruby\">      - zlib-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - openssl</span></span><br><span class=\"line\"><span class=\"ruby\">      - openssl-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libpng</span></span><br><span class=\"line\"><span class=\"ruby\">      - libpng-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - freetype</span></span><br><span class=\"line\"><span class=\"ruby\">      - freetype-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxml2</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxml2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - bzip2</span></span><br><span class=\"line\"><span class=\"ruby\">      - bzip2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - ncurses</span></span><br><span class=\"line\"><span class=\"ruby\">      - curl</span></span><br><span class=\"line\"><span class=\"ruby\">      - gdbm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libXpm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libX11-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - gd-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - gmp-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - readline-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxslt-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - expat-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - xmlrpc-c</span></span><br><span class=\"line\"><span class=\"ruby\">      - xmlrpc-c-devel</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"useradd\"><a href=\"#useradd\" class=\"headerlink\" title=\"useradd\"></a>useradd</h4><p>创建网站运行用户<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/modules/user/www.sls</span> </span><br><span class=\"line\"><span class=\"attr\">www-user-group:</span></span><br><span class=\"line\">  <span class=\"string\">group.present:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - gid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">user.present:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - fullname:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - shell:</span> <span class=\"string\">/sbin/nologin</span></span><br><span class=\"line\"><span class=\"attr\">    - uid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"><span class=\"attr\">    - gid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">id</span> <span class=\"string\">www</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"nginx\"><a href=\"#nginx\" class=\"headerlink\" title=\"nginx\"></a>nginx</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/nginx/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">nginx</span>]<span class=\"comment\"># tree </span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── nginx-<span class=\"number\">1.12</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\">│   ├── nginx-<span class=\"number\">1.16</span>.<span class=\"number\">0</span>.tar.gz</span><br><span class=\"line\">│   ├── nginx.conf.template</span><br><span class=\"line\">│   └── nginx.service.template</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">6</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master nginx]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">&#123;% <span class=\"keyword\">set</span> nginx_<span class=\"keyword\">version</span> = <span class=\"string\">\"1.16.0\"</span>%&#125;</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - modules.pkg</span><br><span class=\"line\">  - modules.user.www</span><br><span class=\"line\"></span><br><span class=\"line\">nginx-install:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - name: <span class=\"string\">/usr/local/src/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - source: salt:<span class=\"string\">//modules/nginx/files/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: 644</span><br><span class=\"line\"></span><br><span class=\"line\">  cmd.run:</span><br><span class=\"line\">    - name: <span class=\"keyword\">cd</span> <span class=\"string\">/usr/local/src/</span> &amp;&amp; tar xf nginx-&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span> &amp;&amp; <span class=\"keyword\">cd</span> nginx-&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; <span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"params\">--user=root</span> <span class=\"params\">--group=root</span> <span class=\"params\">--with-http_ssl_module</span> <span class=\"params\">--with-stream</span> <span class=\"params\">--with-http_stub_status_module</span> <span class=\"params\">--with-file-aio</span> <span class=\"params\">--with-http_gzip_static_module</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class=\"string\">/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"string\">/usr/local/nginx</span></span><br><span class=\"line\">    - unless: test -d <span class=\"string\">/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; test -L <span class=\"string\">/usr/local/nginx</span></span><br><span class=\"line\">    - require:</span><br><span class=\"line\">      - file: nginx-install</span><br><span class=\"line\">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">nginx]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入nginx安装sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.nginx.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加systemctl</span></span><br><span class=\"line\"><span class=\"attr\">nginx-init:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/lib/systemd/system/nginx.service</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/nginx/files/nginx.service.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-f</span> <span class=\"string\">/usr/lib/systemd/system/nginx.service</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">systemctl</span> <span class=\"string\">daemon-reload</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">nginx-init</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置文件</span></span><br><span class=\"line\"><span class=\"string\">/usr/local/nginx/conf/nginx.conf:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/nginx/files/nginx.conf.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动nginx</span></span><br><span class=\"line\"><span class=\"attr\">nginx-service:</span></span><br><span class=\"line\">  <span class=\"string\">file.directory:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/nginx/conf/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">nginx-install</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">nginx-init</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">/usr/local/nginx/conf/nginx.conf</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">nginx-service</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"php\"><a href=\"#php\" class=\"headerlink\" title=\"php\"></a>php</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/php/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">php</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── php-<span class=\"number\">5.6</span>.<span class=\"number\">40</span>.tar.gz</span><br><span class=\"line\">│   ├── php-fpm.conf.template</span><br><span class=\"line\">│   ├── php-fpm.service.template</span><br><span class=\"line\">│   ├── php-fpm.template</span><br><span class=\"line\">│   └── php.ini.template</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">7</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master php]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">&#123;% <span class=\"keyword\">set</span> php_<span class=\"keyword\">version</span> = <span class=\"string\">\"5.6.40\"</span> %&#125;</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - modules.pkg</span><br><span class=\"line\"></span><br><span class=\"line\">php-install:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - name: <span class=\"string\">/usr/local/src/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - source: salt:<span class=\"string\">//modules/php/files/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: 644</span><br><span class=\"line\"></span><br><span class=\"line\">  cmd.run:</span><br><span class=\"line\">    - name: <span class=\"keyword\">cd</span> <span class=\"string\">/usr/local/src/</span> &amp;&amp; tar xf php-&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span> &amp;&amp; <span class=\"keyword\">cd</span> php-&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; <span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"params\">--with-curl</span> <span class=\"params\">--with-freetype-dir</span> <span class=\"params\">--with-gd</span> <span class=\"params\">--with-gettext</span> <span class=\"params\">--with-iconv-dir</span> <span class=\"params\">--with-jpeg-dir</span> <span class=\"params\">--with-kerberos</span> <span class=\"params\">--with-libdir=lib64</span> <span class=\"params\">--with-libxml-dir</span> <span class=\"params\">--with-mysql</span> <span class=\"params\">--with-mysqli</span> <span class=\"params\">--with-openssl</span> <span class=\"params\">--with-pcre-regex</span> <span class=\"params\">--with-pdo-mysql</span> <span class=\"params\">--with-dpo-sqlite</span> <span class=\"params\">--with-pear</span> <span class=\"params\">--with-png-dir</span> <span class=\"params\">--with-openssl</span> <span class=\"params\">--with-xmlrpc</span> <span class=\"params\">--with-xsl</span> <span class=\"params\">--with-zlib</span> <span class=\"params\">--enable-fpm</span> <span class=\"params\">--enable-bcmath</span> <span class=\"params\">--enable-libxml</span> <span class=\"params\">--enable-inline-optimization</span> <span class=\"params\">--enable-gd-native-ttf</span> <span class=\"params\">--enable-mbregex</span> <span class=\"params\">--enable-mbstring</span> <span class=\"params\">--enable-opcache</span> <span class=\"params\">--enable-pcntl</span> <span class=\"params\">--enable-shmop</span> <span class=\"params\">--enable-soap</span> <span class=\"params\">--enable-sockets</span> <span class=\"params\">--enable-sysvsem</span> <span class=\"params\">--enable-xml</span> <span class=\"params\">--enable-zip</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class=\"string\">/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"string\">/usr/local/php</span></span><br><span class=\"line\">    - unless: test -d <span class=\"string\">/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; test -L <span class=\"string\">/usr/local/php</span></span><br><span class=\"line\">    - require:</span><br><span class=\"line\">      - file: php-install</span><br><span class=\"line\">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">php]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入php安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.php.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php-ini配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">php-ini:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/php/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php.ini.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ln</span> <span class=\"bullet\">-s</span> <span class=\"string\">/usr/local/php/etc/php.ini</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-L</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-ini</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php-fpm配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">php-fpm:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/php/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.conf.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ln</span> <span class=\"bullet\">-s</span> <span class=\"string\">/usr/local/php/etc/php-fpm.conf</span> <span class=\"string\">/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-L</span> <span class=\"string\">/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#加入system启动</span></span><br><span class=\"line\"><span class=\"attr\">php-systemd:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/lib/systemd/system/php-fpm.service</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.service.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#加入/etc/init.d/启动</span></span><br><span class=\"line\"><span class=\"attr\">php-init:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/init.d/php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">php-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-systemd</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-ini</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"mysql\"><a href=\"#mysql\" class=\"headerlink\" title=\"mysql\"></a>mysql</h4><p>1）配置文件模板准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/mysql/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">mysql</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── my.cnf</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">mysql</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">mariadb-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkgs:</span><br><span class=\"line\">      - mariadb-server</span><br><span class=\"line\">      - mariadb</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">mysql]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入mysql安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.mysql.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#my.cnf配置文件</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/mysql/files/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动mariadb</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"lnmp\"><a href=\"#lnmp\" class=\"headerlink\" title=\"lnmp\"></a>lnmp</h4><p>1）准备测试文件<code>php info</code> 和<code>nginx</code>虚拟主机配置文件<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/lnmp/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">lnmp</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── index.php</span><br><span class=\"line\">│   └── www.conf</span><br><span class=\"line\">└── www.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>www.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">lnmp]#</span> <span class=\"string\">cat</span> <span class=\"string\">www.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入nginx、php、mysql的安装</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.nginx.service</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.php.service</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.mysql.service</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#虚拟主机web站点目录创建</span></span><br><span class=\"line\"><span class=\"attr\">web-www:</span></span><br><span class=\"line\">  <span class=\"string\">file.directory:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/opt/www</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#虚拟主机配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">web-www-conf:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/nginx/conf/conf.d/www.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/lnmp/files/www.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">web-www</span></span><br><span class=\"line\"><span class=\"attr\">    - watch_in:</span></span><br><span class=\"line\"><span class=\"attr\">      - service:</span> <span class=\"string\">nginx-service</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">      IPADDR:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#phpinfo测试文件准备</span></span><br><span class=\"line\"><span class=\"attr\">web-index:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/opt/www/index.php</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/lnmp/files/index.php</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"测试lnmp是否OK\"><a href=\"#测试lnmp是否OK\" class=\"headerlink\" title=\"测试lnmp是否OK\"></a>测试lnmp是否OK</h4><p>1）<code>Top file</code>编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br></pre></td></tr></table></figure></p>\n<p>2）执行高级状态<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<p>3）访问测试<br><img src=\"/2019/05/21/saltstack项目实战/03.png\" alt=\"http://192.168.1.31\"><br><img src=\"/2019/05/21/saltstack项目实战/04.png\" alt=\"http://192.168.1.32\"></p>\n<h4 id=\"haproxy\"><a href=\"#haproxy\" class=\"headerlink\" title=\"haproxy\"></a>haproxy</h4><p>1）配置文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/haproxy/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">haproxy</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── haproxy.cfg</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">haproxy</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">haproxy-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - name: haproxy</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">haproxy]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入haproxy安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.haproxy.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置文件</span></span><br><span class=\"line\"><span class=\"attr\">haproxy-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/haproxy/files/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">haproxy-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动haproxy</span></span><br><span class=\"line\"><span class=\"attr\">haproxy-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">haproxy</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">haproxy-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">haproxy-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">haproxy-config</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"keepalived\"><a href=\"#keepalived\" class=\"headerlink\" title=\"keepalived\"></a>keepalived</h4><p>1）配置文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/keepalived/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">keepalived</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── keepalived.conf</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">keepalived</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">keepalived-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - name: keepalived</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">keepalived]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入keepalived安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.keepalived.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#keepalived配置文件</span></span><br><span class=\"line\"><span class=\"attr\">keepalived-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/keepalived/keepalived.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/keepalived/files/keepalived.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">keepalived-install</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">if</span> <span class=\"string\">grains['fqdn']</span> <span class=\"string\">==</span> <span class=\"string\">\"salt-minion01\"</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      ROUTER_ID:</span> <span class=\"string\">saltstack01</span></span><br><span class=\"line\"><span class=\"attr\">      STATE:</span> <span class=\"string\">MASTER</span></span><br><span class=\"line\"><span class=\"attr\">      PRIORITY:</span> <span class=\"number\">150</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">elif</span> <span class=\"string\">grains['fqdn']</span> <span class=\"string\">==</span> <span class=\"string\">\"salt-minion02\"</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      ROUTER_ID:</span> <span class=\"string\">saltstack02</span></span><br><span class=\"line\"><span class=\"attr\">      STATE:</span> <span class=\"string\">BACKUP</span></span><br><span class=\"line\"><span class=\"attr\">      PRIORITY:</span> <span class=\"number\">100</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">endif</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动keepalived</span></span><br><span class=\"line\"><span class=\"attr\">keepalived-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">keepalived</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">keepalived-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">keepalived-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">keepalived-config</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"整体部署\"><a href=\"#整体部署\" class=\"headerlink\" title=\"整体部署\"></a>整体部署</h3><p>1）top file 编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[1-2]\"</span>:</span><br><span class=\"line\">    - modules.haproxy.service</span><br><span class=\"line\">    - modules.keepalived.service</span><br></pre></td></tr></table></figure></p>\n<p>2）高级状态执行<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<p>3）测试<br>访问<code>192.168.1.31</code>和<code>192.168.1.32</code>的状态页<br><img src=\"/2019/05/21/saltstack项目实战/05.png\" alt=\"http://192.168.1.31:1314/status\"><br><img src=\"/2019/05/21/saltstack项目实战/06.png\" alt=\"http://192.168.1.32:1314/status\"><br>访问VIP<code>192.168.1.100</code><br><img src=\"/2019/05/21/saltstack项目实战/07.png\" alt=\"http://192.168.1.100\"></p>\n<p>通过上面测试可看到可以成功访问<code>lnmp</code>站点，并且<code>haproxy</code>也<code>ok</code>。访问所有四台服务器都可以得到<code>phpinfo</code>页面，而在生产环境中，我们只是对外提供<code>vip</code>即可。</p>\n<h2 id=\"项目总结\"><a href=\"#项目总结\" class=\"headerlink\" title=\"项目总结\"></a>项目总结</h2><p>1）整体环境查看<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# tree /srv/salt/prod/modules/</span><br><span class=\"line\">/srv/salt/prod/modules/</span><br><span class=\"line\">├── haproxy</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── haproxy.cfg</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── keepalived</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── keepalived.<span class=\"keyword\">conf</span></span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── lnmp</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── <span class=\"built_in\">index</span>.php</span><br><span class=\"line\">│   │   └── www.<span class=\"keyword\">conf</span></span><br><span class=\"line\">│   └── www.sls</span><br><span class=\"line\">├── mysql</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── nginx</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── nginx-<span class=\"number\">1.12</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\">│   │   ├── nginx-<span class=\"number\">1.16</span>.<span class=\"number\">0</span>.tar.gz</span><br><span class=\"line\">│   │   ├── nginx.<span class=\"keyword\">conf</span>.template</span><br><span class=\"line\">│   │   └── nginx.service.template</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── php</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── php-<span class=\"number\">5.6</span>.<span class=\"number\">40</span>.tar.gz</span><br><span class=\"line\">│   │   ├── php-fpm.<span class=\"keyword\">conf</span>.template</span><br><span class=\"line\">│   │   ├── php-fpm.service.template</span><br><span class=\"line\">│   │   ├── php-fpm.template</span><br><span class=\"line\">│   │   └── php.ini.template</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── pkg.sls</span><br><span class=\"line\">└── user</span><br><span class=\"line\">    └── www.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">13</span> directories, <span class=\"number\">27</span> <span class=\"keyword\">files</span></span><br></pre></td></tr></table></figure></p>\n<p>2）如果需要在某台服务器上面单独部署某一部分，参考以下写法：<br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># cat /srv/salt/base/top.sls </span></span><br><span class=\"line\"><span class=\"meta\">#部署lnmp及haproxy+keepalived</span></span><br><span class=\"line\"><span class=\"symbol\">prod:</span></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[1-2]\"</span>:</span><br><span class=\"line\">    - modules.haproxy.service</span><br><span class=\"line\">    - modules.keepalived.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#单实例操作说明：</span></span><br><span class=\"line\"><span class=\"symbol\">prod:</span></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion04\"</span>:</span><br><span class=\"line\">    - modules.nginx.service\t<span class=\"meta\">#单独安装nginx时</span></span><br><span class=\"line\">    - modules.mysql.service     <span class=\"meta\">#单独安装mysql时</span></span><br><span class=\"line\">    - modules.php.service       <span class=\"meta\">#单独安装php时</span></span><br><span class=\"line\">    - modules.keepalived.service  <span class=\"meta\">#单独安装keepalived时</span></span><br><span class=\"line\">    - modules.haproxy.service   <span class=\"meta\">#单独安装haproxy时</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion03\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www     <span class=\"meta\">#单独部署lnmp环境时</span></span><br></pre></td></tr></table></figure></p>\n"},{"title":"Cobbler自动化部署","date":"2019-06-12T02:10:22.000Z","copyright":true,"_content":"## cobbler简介\n>`Cobbler` 可以用来快速建立 `Linux` 网络安装环境，它已将`Linux`网络安装的技术门槛，从大专以上文化水平，成功降低到了初中水平，连补鞋匠都能学会。\n>网络安装服务器套件`Cobbler`（补鞋匠）从前，我们一直在装机民工这份很有前途的职业。自打若干年前`Red Hat`推出了 `Kickstart`，此后我们顿觉身价增倍。不再需要刻了光盘一台一台的安装`Linux`，只要搞定`PXE`、`DHCP`、`TFTP`，还有那满屏眼花缭乱不知所云的`Kickstart`脚本，我们就可以像哈利波特一样，轻点魔棒，瞬间安装上百台服务器。这一堆花里胡哨的东西可不是一般人能够整明白的，没有大专以上的学历，通不过英语四级，根本别想玩转。总而言之，这是一份多么有前途，多么有技术含量的工作啊。很不幸，`Red Ha`t 最新（`Cobbler`项目最初在`2008`年左右发布）发布了网络安装服务器套件`Cobbler`（补鞋匠），它已将`Linux`网络安装的技术门槛，从大专以上文化水平，成功降低到初中以下水平，连补鞋匠都能学会。\n\n>1、`Cobbler`是一个`Linux`服务器安装的服务，可以通过网络启动（`PXE`）的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理`DHCP`，`DNS`等。\n>2、`Cobbler`可以使用命令行方式管理，也提供了基于Web的界面管理工具（`cobbler-web`），还提供了`API`接口，可以方便二次开发使用。\n>3、`Cobbler`是较早前的`kickstart`的升级版，优点是比较容易配置，还自带web界面比较易于管理。\n>4、`Cobbler`内置了一个轻量级配置管理系统，但它也支持和其它配置管理系统集成，如`Puppet`。\n\n**参考网站**\n\n[cobbler官网](http://cobbler.github.io/)\n\n[Kickstart文件编写参考](https://www.linuxidc.com/Linux/2017-08/146168.htm)\n\n## cobbler对应关系\n\n![](Cobbler自动化部署/cobbler01.png)\n> `Cobbler`的配置结构基于一组注册的对象。每个对象表示一个与另一个实体相关联的实体。当一个对象指向另一个对象时，它就继承了被指向对象的数据，并可覆盖或添加更多特定信息。\n- 发行版(`distros`)： 表示一个操作系统。它承载了内核和`initrd`的信息，以及内核参数等其他数据。\n- 配置文件(`profiles`)：包含一个发行版、一个`kickstart`文件以及可能的存储库，还包括更多特定的内核参数等其他数据。\n- 系统(`systems`)：表示要配给的机器。它包括一个配置文件或一个镜像、`IP`和`MAC`地址、电源管理（地址、凭据、类型）以及更为专业的数据等信息。\n- 镜像(`images`)：可以替换一个保函不屑于此类别的文件的发行版对象（例如，无法分为内核和`initrd`的对象）。\n\n## cobbler集成的服务\n- PXE服务支持\n- DHCP服务管理\n- DNS服务管理\n- 电源管理\n- Kickstart服务支持\n- YUM仓库管理\n- TFTP\n- Apache\n\n## cobbler工作原理\n\n![](Cobbler自动化部署/cobbler09.png)\n\n**Server端**\n\n- 启动`Cobbler`服务\n- 进行`Cobbler`错误检查，执行`cobbler check`命令\n- 进行配置同步，执行`cobbler syn`c命令\n- 复制相关启动文件到`TFTP`目录中\n- 启动`DHCP`服务，提供地址分配\n- `DHCP`服务分配IP地址\n- `TFTP`传输启动文件\n- `Server`端接收安装信息\n- `Server`端发送`ISO`镜像与`Kickstart`文件\n\n**Client端**\n\n- 客户端以`PXE`模式启动\n- 客户端获取`IP`地址\n- 通过`TFTP`服务器获取启动文件\n- 进入`Cobbler`安装选择界面\n- 根据配置信息准备安装系统\n- 加载`Kickstart`文件\n- 传输系统安装的其它文件\n- 进行安装系统\n\n## cobbler安装\n\n>说明：虚拟机网卡采用NAT模式，不要使用桥接模式，因为后面会搭建DHCP服务器，在同一个局域网多个DHCP服务会有冲突。\n>VMware的NAT模式的dhcp服务也关闭，避免干扰。\n>![](Cobbler自动化部署/cobbler02.png)\n\n### 环境准备\n```\n# 关闭防火墙、selinux等\n[root@cobbler ~]# systemctl stop firewalld\n[root@cobbler ~]# systemctl disable firewalld\n[root@cobbler ~]# setenforce 0\n[root@cobbler ~]# sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/sysconfig/selinux\n```\n### 安装cobbler\n```\n# 配置epel源\n[root@cobbler ~]# yum -y install epel-release\n\n# 安装cobbler及dhcp httpd xinetd cobbler-web\n[root@cobbler ~]# yum -y install cobbler cobbler-web tftp-server dhcp httpd xinetd\n\n# 启动cobbler及httpd并加入开机启动\n[root@cobbler ~]# systemctl start httpd cobblerd\n[root@cobbler ~]# systemctl enable httpd cobblerd\n```\n查看安装后相关文件\n```\n[root@cobbler ~]# rpm -ql cobbler\n/etc/cobbler                  # 配置文件目录\n/etc/cobbler/settings         # cobbler主配置文件，这个文件是YAML格式，Cobbler是python写的程序。\n/etc/cobbler/dhcp.template    # DHCP服务的配置模板\n/etc/cobbler/tftpd.template   # tftp服务的配置模板\n/etc/cobbler/rsync.template   # rsync服务的配置模板\n/etc/cobbler/iso              # iso模板配置文件目录\n/etc/cobbler/pxe              # pxe模板文件目录\n/etc/cobbler/power            # 电源的配置文件目录\n/etc/cobbler/users.conf       # Web服务授权配置文件\n/etc/cobbler/users.digest     # 用于web访问的用户名密码配置文件\n/etc/cobbler/dnsmasq.template # DNS服务的配置模板\n/etc/cobbler/modules.conf     # Cobbler模块配置文件\n/var/lib/cobbler              # Cobbler数据目录\n/var/lib/cobbler/config       # 配置文件\n/var/lib/cobbler/kickstarts   # 默认存放kickstart文件\n/var/lib/cobbler/loaders      # 存放的各种引导程序\n/var/www/cobbler              # 系统安装镜像目录\n/var/www/cobbler/ks_mirror    # 导入的系统镜像列表\n/var/www/cobbler/images       # 导入的系统镜像启动文件\n/var/www/cobbler/repo_mirror  # yum源存储目录\n/var/log/cobbler              # 日志目录\n/var/log/cobbler/install.log  # 客户端系统安装日志\n/var/log/cobbler/cobbler.log  # cobbler日志\n```\n### 配置cobbler\n> 检查`Cobbler`的配置，如果看不到下面的结果，再次重启`cobbler`\n\n```\n[root@cobbler ~]# cobbler check\nThe following are potential configuration items that you may want to fix:\n\n1 : The 'server' field in /etc/cobbler/settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.\n2 : For PXE to be functional, the 'next_server' field in /etc/cobbler/settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.\n3 : change 'disable' to 'no' in /etc/xinetd.d/tftp\n4 : Some network boot-loaders are missing from /var/lib/cobbler/loaders, you may run 'cobbler get-loaders' to download them, or, if you only want to handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The 'cobbler get-loaders' command is the easiest way to resolve these requirements.\n5 : enable and start rsyncd.service with systemctl\n6 : debmirror package is not installed, it will be required to manage debian deployments and repositories\n7 : ksvalidator was not found, install pykickstart\n8 : The default password used by the sample templates for newly installed machines (default_password_crypted in /etc/cobbler/settings) is still set to 'cobbler' and should be changed, try: \"openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'\" to generate new one\n9 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them\n\nRestart cobblerd and then run 'cobbler sync' to apply changes.\n```\n> 看到上面出现的问题，然后一个一个的进行解决，先进行设置为可以动态配置，也可以直接更改配置文件。\n\n```\n# 设置可以动态修改配置文件\n[root@cobbler ~]# sed -ri '/allow_dynamic_settings:/c\\allow_dynamic_settings: 1' /etc/cobbler/settings\n[root@cobbler ~]# grep allow_dynamic_settings /etc/cobbler/settings \nallow_dynamic_settings: 1\n[root@cobbler ~]# systemctl restart cobblerd\n```\n逐个解决上面的问题\n```\n1. server\n[root@cobbler ~]# cobbler setting edit --name=server --value=192.168.2.128\n\n2. next_server\n[root@cobbler ~]# cobbler setting edit --name=next_server --value=192.168.2.128\n\n3. tftp_server\n[root@cobbler ~]# sed -ri '/disable/c\\disable = no' /etc/xinetd.d/tftp\n[root@cobbler ~]# systemctl enable xinetd\n[root@cobbler ~]# systemctl restart xinetd\n\n4. boot-loaders\n[root@cobbler ~]# cobbler get-loaders\n\n5. rsyncd\n[root@cobbler ~]# systemctl start rsyncd\n[root@cobbler ~]# systemctl enable rsyncd\n\n6. debmirror [optional]\n# 这个是可选项的，可以忽略。这里就忽略了\n\n7. pykickstart\n[root@cobbler ~]# yum -y install pykickstart\n\n8. default_password_crypted  #注意：这里设置的密码，也就是后面安装完系统的初始化登录密码\n[root@cobbler ~]# openssl passwd -1 -salt `openssl rand -hex 4` 'admin'\n$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0\n[root@cobbler ~]# cobbler setting edit --name=default_password_crypted --value='$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0'\n\n9. fencing tools [optional]\n[root@cobbler ~]# yum -y install fence-agents\n```\n解决完成再次查看\n```\n[root@cobbler ~]# cobbler check\nThe following are potential configuration items that you may want to fix:\n\n1 : debmirror package is not installed, it will be required to manage debian deployments and repositories\n\nRestart cobblerd and then run 'cobbler sync' to apply changes.\n```\n### 配置DHCP\n```\n[root@cobbler ~]# cobbler setting edit --name=manage_dhcp --value=1\n\n# 修改cobbler的dhcp模块，不要直接修改dhcp本身的配置文件，因为cobbler会覆盖\n[root@cobbler ~]# vim /etc/cobbler/dhcp.template\n...\nsubnet 192.168.2.0 netmask 255.255.255.0 { #这里改为分配的网段和掩码\n     #option routers             192.168.1.5; #如果有网关，这里改为网关地址\n     #option domain-name-servers 192.168.1.1; #如果有DNS，这里改为DNS地址\n     option subnet-mask         255.255.255.0; #改为分配的IP的掩码\n     range dynamic-bootp        192.168.2.100 192.168.2.254; #改为分配的IP的范围\n...\n```\n### 同步cobbler配置\n>同步cobbler配置，它会根据配置自动修改dhcp等服务。\n\n```\n[root@cobbler ~]# cobbler rsync \nNo such command: rsync\n[root@cobbler ~]# cobbler sync\ntask started: 2019-06-12_152623_sync\ntask started (id=Sync, time=Wed Jun 12 15:26:23 2019)\nrunning pre-sync triggers\ncleaning trees\nremoving: /var/www/cobbler/images/centos6.9-x86_64\nremoving: /var/lib/tftpboot/pxelinux.cfg/default\nremoving: /var/lib/tftpboot/grub/images\nremoving: /var/lib/tftpboot/grub/grub-x86.efi\nremoving: /var/lib/tftpboot/grub/grub-x86_64.efi\nremoving: /var/lib/tftpboot/grub/efidefault\nremoving: /var/lib/tftpboot/images/centos6.9-x86_64\nremoving: /var/lib/tftpboot/s390x/profile_list\ncopying bootloaders\ntrying hardlink /var/lib/cobbler/loaders/grub-x86.efi -> /var/lib/tftpboot/grub/grub-x86.efi\ntrying hardlink /var/lib/cobbler/loaders/grub-x86_64.efi -> /var/lib/tftpboot/grub/grub-x86_64.efi\ncopying distros to tftpboot\ncopying files for distro: centos6.9-x86_64\ntrying hardlink /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/vmlinuz -> /var/lib/tftpboot/images/centos6.9-x86_64/vmlinuz\ntrying hardlink /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/initrd.img -> /var/lib/tftpboot/images/centos6.9-x86_64/initrd.img\ncopying images\ngenerating PXE configuration files\ngenerating PXE menu structure\ncopying files for distro: centos6.9-x86_64\ntrying hardlink /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/vmlinuz -> /var/www/cobbler/images/centos6.9-x86_64/vmlinuz\ntrying hardlink /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/initrd.img -> /var/www/cobbler/images/centos6.9-x86_64/initrd.img\nWriting template files for centos6.9-x86_64\nrendering DHCP files\ngenerating /etc/dhcp/dhcpd.conf\nrendering TFTPD files\ngenerating /etc/xinetd.d/tftp\nprocessing boot_files for distro: centos6.9-x86_64\ncleaning link caches\nrunning post-sync triggers\nrunning python triggers from /var/lib/cobbler/triggers/sync/post/*\nrunning python trigger cobbler.modules.sync_post_restart_services\nrunning: dhcpd -t -q\nreceived on stdout: \nreceived on stderr: \nrunning: service dhcpd restart\nreceived on stdout: \nreceived on stderr: Redirecting to /bin/systemctl restart dhcpd.service\n\nrunning shell triggers from /var/lib/cobbler/triggers/sync/post/*\nrunning python triggers from /var/lib/cobbler/triggers/change/*\nrunning python trigger cobbler.modules.manage_genders\nrunning python trigger cobbler.modules.scm_track\nrunning shell triggers from /var/lib/cobbler/triggers/change/*\n*** TASK COMPLETE ***\n```\n这时候创建一个新虚拟机可以获取到如下信息，没有镜像选择，只能从本地启动\n![](Cobbler自动化部署/cobbler03.png)\n\n### cobbler命令帮助\n| 命令             | 说明                                       |\n| ---------------- | :----------------------------------------- |\n| cobbler check    | 核对当前设置是否有问题                     |\n| cobbler list     | 列出所有的cobbler元素                      |\n| cobbler report   | 列出元素的详细信息                         |\n| cobbler sync     | 同步配置到数据目录，更改配置最好都执行一下 |\n| cobbler reposync | 同步yum仓库                                |\n| cobbler distro   | 查看导入的发行版系统信息                   |\n| cobbler system   | 查看添加的系统信息                         |\n| cobbler profile  | 查看配置信息                               |\n\n## cobbler配置安装centos6.x\n>由于我这里实在`centos7`系统上面配置的`cobbler`，所以上传了一个`centos6`的镜像并进行挂载。\n\n1）创建挂载点，并进行挂载\n```\n[root@cobbler ~]# mkdir /centos6\n[root@cobbler ~]# mount -o loop CentOS-6.9-x86_64-bin-DVD1.iso /centos6\n```\n2）查看挂载后的目录\n```\n[root@cobbler ~]# ls /centos6/\nCentOS_BuildTag  images                    repodata                       RPM-GPG-KEY-CentOS-Testing-6\nEFI              isolinux                  RPM-GPG-KEY-CentOS-6           TRANS.TBL\nEULA             Packages                  RPM-GPG-KEY-CentOS-Debug-6\nGPL              RELEASE-NOTES-en-US.html  RPM-GPG-KEY-CentOS-Security-6\n```\n3）导入镜像\n```\n[root@cobbler ~]# cobbler import --path=/centos6 --name=centos6.9 --arch=x86_64\n# --path 镜像路径\n# --name 为安装源定义一个名字\n# --arch 指定安装源是32位、64位、ia64, 目前支持的选项有: x86│x86_64│ia64\n# 安装源的唯一标示就是根据name参数来定义，本例导入成功后，安装源的唯一标示就是：centos6.9，如果重复，系统会提示导入失败。\n```\n4）查看导入后镜像信息\n```\n[root@cobbler ~]# cobbler distro report --name=centos6.9-x86_64\nName                           : centos6.9-x86_64\nArchitecture                   : x86_64\nTFTP Boot Files                : {}\nBreed                          : redhat\nComment                        : \nFetchable Files                : {}\nInitrd                         : /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/initrd.img\nKernel                         : /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/vmlinuz\nKernel Options                 : {}\nKernel Options (Post Install)  : {}\nKickstart Metadata             : {'tree': 'http://@@http_server@@/cblr/links/centos6.9-x86_64'}\nManagement Classes             : []\nOS Version                     : rhel6\nOwners                         : ['admin']\nRed Hat Management Key         : <<inherit>>\nRed Hat Management Server      : <<inherit>>\nTemplate Files                 : {}\n```\n5）查看`profile`信息\n```\n[root@cobbler ~]# cobbler profile report --name=centos6.9-x86_64\nName                           : centos6.9-x86_64\nTFTP Boot Files                : {}\nComment                        : \nDHCP Tag                       : default\nDistribution                   : centos6.9-x86_64\nEnable gPXE?                   : 0\nEnable PXE Menu?               : 1\nFetchable Files                : {}\nKernel Options                 : {}\nKernel Options (Post Install)  : {}\nKickstart                      : /var/lib/cobbler/kickstarts/sample_end.ks\nKickstart Metadata             : {}\nManagement Classes             : []\nManagement Parameters          : <<inherit>>\nName Servers                   : []\nName Servers Search Path       : []\nOwners                         : ['admin']\nParent Profile                 : \nInternal proxy                 : \nRed Hat Management Key         : <<inherit>>\nRed Hat Management Server      : <<inherit>>\nRepos                          : []\nServer Override                : <<inherit>>\nTemplate Files                 : {}\nVirt Auto Boot                 : 1\nVirt Bridge                    : xenbr0\nVirt CPUs                      : 1\nVirt Disk Driver Type          : raw\nVirt File Size(GB)             : 5\nVirt Path                      : \nVirt RAM (MB)                  : 512\nVirt Type                      : kvm\n```\n6）`copy`一份`profile`文件(`ks`)，进行修改\n```\n[root@cobbler ~]# cd /var/lib/cobbler/kickstarts/\n[root@cobbler kickstarts]# ls\ndefault.ks    install_profiles  sample_autoyast.xml  sample_esxi4.ks  sample.ks\nesxi4-ks.cfg  legacy.ks         sample_end.ks        sample_esxi5.ks  sample_old.seed\nesxi5-ks.cfg  pxerescue.ks      sample_esx4.ks       sample_esxi6.ks  sample.seed\n[root@cobbler kickstarts]# cp sample_end.ks centos6.ks\n\n# 编辑centos6的kickstart文件\n[root@cobbler kickstarts]# vim centos6.ks \n# This kickstart file should only be used with EL > 5 and/or Fedora > 7.\n# For older versions please use the sample.ks kickstart file.\n# Install OS instead of upgrade\ninstall\n# Use text mode install\ntext\n# System keyboard\nkeyboard us\n# System language\nlang en_US\n# System timezone\ntimezone  Asia/ShangHai\n#Root password\nrootpw --iscrypted $default_password_crypted\n# System authorization information\nauth  --useshadow  --enablemd5\n# Firewall configuration\nfirewall --disabled\n# SELinux configuration\nselinux --disabled\n# Use network installation\nurl --url=$tree\n\n# Clear the Master Boot Record\nzerombr\n# System bootloader configuration\nbootloader --location=mbr\n# Partition clearing information\nclearpart --all --initlabel\npart /boot --fstype=ext4 --size=500\npart swap --fstype=swap --size=2048\npart / --fstype=ext4 --grow --size=200 \n\n# If any cobbler repo definitions were referenced in the kickstart profile, include them here.\n$yum_repo_stanza\n# Network information\n$SNIPPET('network_config')\n# Do not configure the X Window System\nskipx\n# Run the Setup Agent on first boot\nfirstboot --disable\n# Reboot after installation\nreboot\n\n\n%pre\n$SNIPPET('log_ks_pre')\n$SNIPPET('kickstart_start')\n$SNIPPET('pre_install_network_config')\n# Enable installation monitoring\n$SNIPPET('pre_anamon')\n%end\n\n%packages\n$SNIPPET('func_install_if_enabled')\n@core\n@base\ntree\nnmap\nwget\nlftp\nlrzsz\ntelnet\n%end\n\n%post --nochroot\n$SNIPPET('log_ks_post_nochroot')\n%end\n\n%post\n$SNIPPET('log_ks_post')\n# Start yum configuration\n$yum_config_stanza\n# End yum configuration\n$SNIPPET('post_install_kernel_options')\n$SNIPPET('post_install_network_config')\n$SNIPPET('func_register_if_enabled')\n$SNIPPET('download_config_files')\n$SNIPPET('koan_environment')\n$SNIPPET('redhat_register')\n$SNIPPET('cobbler_register')\n# Enable post-install boot notification\n$SNIPPET('post_anamon')\n# Start final steps\n$SNIPPET('kickstart_done')\n# End final steps\n\nsed -ri \"/^#UseDNS/c\\UseDNS no\" /etc/ssh/sshd_config\nsed -ri \"/^GSSAPIAuthentication/c\\GSSAPIAuthentication no\" /etc/ssh/sshd_config\n%end\n```\n7）编辑`centos6`镜像所使用的`kickstart`文件\n```\n# 动态编辑指定使用新的kickstart文件\n[root@cobbler ~]# cobbler profile edit --name=centos6.9-x86_64 --kickstart=/var/lib/cobbler/kickstarts/centos6.ks\n\n# 验证是否更改成功\n[root@cobbler ~]# cobbler profile report --name=centos6.9-x86_64 |grep Kickstart\nKickstart                      : /var/lib/cobbler/kickstarts/centos6.ks\n```\n8）再次同步`cobbler`配置\n```\n[root@cobbler ~]# cobbler sync\n```\n9）新建虚拟机进行测试\n![](Cobbler自动化部署/cobbler04.png)\n选择`centos6.9`进行安装，会按照`kickstart`文件安装并启动\n![](Cobbler自动化部署/cobbler05.png)\n\n## cobbler配置安装centos7.x\n>我这里cobbler服务器就是7的系统，所以直接挂载/dev/cdrom即可\n\n1）创建挂载点，并进行挂载\n```\n[root@cobbler ~]# mkdir /centos7\n[root@cobbler ~]# mount -o loop /dev/cdrom /centos7\n```\n2）查看挂载后的目录\n```\n[root@cobbler ~]# ls /centos7/\nCentOS_BuildTag  EULA  images    LiveOS    repodata              RPM-GPG-KEY-CentOS-Testing-7\nEFI              GPL   isolinux  Packages  RPM-GPG-KEY-CentOS-7  TRANS.TBL\n```\n3）导入镜像\n```\n[root@cobbler ~]# cobbler import --path=/centos7 --name=centos7.4 --arch=x86_64\ntask started: 2019-06-12_165812_import\ntask started (id=Media import, time=Wed Jun 12 16:58:12 2019)\nFound a candidate signature: breed=redhat, version=rhel6\nFound a candidate signature: breed=redhat, version=rhel7\nFound a matching signature: breed=redhat, version=rhel7\nAdding distros from path /var/www/cobbler/ks_mirror/centos7.4-x86_64:\ncreating new distro: centos7.4-x86_64\ntrying symlink: /var/www/cobbler/ks_mirror/centos7.4-x86_64 -> /var/www/cobbler/links/centos7.4-x86_64\ncreating new profile: centos7.4-x86_64\nassociating repos\nchecking for rsync repo(s)\nchecking for rhn repo(s)\nchecking for yum repo(s)\nstarting descent into /var/www/cobbler/ks_mirror/centos7.4-x86_64 for centos7.4-x86_64\nprocessing repo at : /var/www/cobbler/ks_mirror/centos7.4-x86_64\nneed to process repo/comps: /var/www/cobbler/ks_mirror/centos7.4-x86_64\nlooking for /var/www/cobbler/ks_mirror/centos7.4-x86_64/repodata/*comps*.xml\nKeeping repodata as-is :/var/www/cobbler/ks_mirror/centos7.4-x86_64/repodata\n*** TASK COMPLETE ***\n```\n4）查看导入后镜像信息\n```\n[root@cobbler ~]# cobbler distro report --name=centos7.4-x86_64\nName                           : centos7.4-x86_64\nArchitecture                   : x86_64\nTFTP Boot Files                : {}\nBreed                          : redhat\nComment                        : \nFetchable Files                : {}\nInitrd                         : /var/www/cobbler/ks_mirror/centos7.4-x86_64/images/pxeboot/initrd.img\nKernel                         : /var/www/cobbler/ks_mirror/centos7.4-x86_64/images/pxeboot/vmlinuz\nKernel Options                 : {}\nKernel Options (Post Install)  : {}\nKickstart Metadata             : {'tree': 'http://@@http_server@@/cblr/links/centos7.4-x86_64'}\nManagement Classes             : []\nOS Version                     : rhel7\nOwners                         : ['admin']\nRed Hat Management Key         : <<inherit>>\nRed Hat Management Server      : <<inherit>>\nTemplate Files                 : {}\n```\n5）查看`profile`信息\n```\n[root@cobbler ~]# cobbler profile report --name=centos7.4-x86_64\nName                           : centos7.4-x86_64\nTFTP Boot Files                : {}\nComment                        : \nDHCP Tag                       : default\nDistribution                   : centos7.4-x86_64\nEnable gPXE?                   : 0\nEnable PXE Menu?               : 1\nFetchable Files                : {}\nKernel Options                 : {}\nKernel Options (Post Install)  : {}\nKickstart                      : /var/lib/cobbler/kickstarts/sample_end.ks\nKickstart Metadata             : {}\nManagement Classes             : []\nManagement Parameters          : <<inherit>>\nName Servers                   : []\nName Servers Search Path       : []\nOwners                         : ['admin']\nParent Profile                 : \nInternal proxy                 : \nRed Hat Management Key         : <<inherit>>\nRed Hat Management Server      : <<inherit>>\nRepos                          : []\nServer Override                : <<inherit>>\nTemplate Files                 : {}\nVirt Auto Boot                 : 1\nVirt Bridge                    : xenbr0\nVirt CPUs                      : 1\nVirt Disk Driver Type          : raw\nVirt File Size(GB)             : 5\nVirt Path                      : \nVirt RAM (MB)                  : 512\nVirt Type                      : kvm\n```\n7）`copy`一份`profile`文件( `ks` )，进行修改,这里直接copy上面6的了，然后修改修改即可\n```\n[root@cobbler ~]# cd /var/lib/cobbler/kickstarts/\n[root@cobbler kickstarts]# cp centos6.ks centos7.ks\n\n# 编辑centos7的kickstart文件\n[root@cobbler kickstarts]# vim centos7.ks\n# This kickstart file should only be used with EL > 5 and/or Fedora > 7.\n# For older versions please use the sample.ks kickstart file.\n# Install OS instead of upgrade\ninstall\n# Use text mode install\ntext\n# System keyboard\nkeyboard us\n# System language\nlang en_US\n# System timezone\ntimezone  Asia/ShangHai\n#Root password\nrootpw --iscrypted $default_password_crypted\n# System authorization information\nauth  --useshadow  --enablemd5\n# Firewall configuration\nfirewall --disabled\n# SELinux configuration\nselinux --disabled\n# Use network installation\nurl --url=$tree\n\n# Clear the Master Boot Record\nzerombr\n# System bootloader configuration\nbootloader --location=mbr\n# Partition clearing information\nclearpart --all --initlabel\npart /boot --fstype=xfs --size=500\npart swap --fstype=swap --size=2048\npart / --fstype=xfs --grow --size=200 \n\n# If any cobbler repo definitions were referenced in the kickstart profile, include them here.\n$yum_repo_stanza\n# Network information\n$SNIPPET('network_config')\n# Do not configure the X Window System\nskipx\n# Run the Setup Agent on first boot\nfirstboot --disable\n# Reboot after installation\nreboot\n\n\n%pre\n$SNIPPET('log_ks_pre')\n$SNIPPET('kickstart_start')\n$SNIPPET('pre_install_network_config')\n# Enable installation monitoring\n$SNIPPET('pre_anamon')\n%end\n\n%packages\n$SNIPPET('func_install_if_enabled')\n@core\n@base\ntree\nnmap\nwget\nlftp\nlrzsz\ntelnet\n%end\n\n%post --nochroot\n$SNIPPET('log_ks_post_nochroot')\n%end\n\n%post\n$SNIPPET('log_ks_post')\n# Start yum configuration\n$yum_config_stanza\n# End yum configuration\n$SNIPPET('post_install_kernel_options')\n$SNIPPET('post_install_network_config')\n$SNIPPET('func_register_if_enabled')\n$SNIPPET('download_config_files')\n$SNIPPET('koan_environment')\n$SNIPPET('redhat_register')\n$SNIPPET('cobbler_register')\n# Enable post-install boot notification\n$SNIPPET('post_anamon')\n# Start final steps\n$SNIPPET('kickstart_done')\n# End final steps\n\nsed -ri \"/^#UseDNS/c\\UseDNS no\" /etc/ssh/sshd_config\nsed -ri \"/^GSSAPIAuthentication/c\\GSSAPIAuthentication no\" /etc/ssh/sshd_config\n%end\n```\n7）编辑`centos7`镜像所使用的`kickstart`文件\n```\n# 动态编辑指定使用新的kickstart文件\n[root@cobbler ~]# cobbler profile edit --name=centos7.4-x86_64 --kickstart=/var/lib/cobbler/kickstarts/centos7.ks\n\n# 验证是否更改成功\n[root@cobbler ~]# cobbler profile report --name=centos7.4-x86_64 |grep Kickstart\nKickstart                      : /var/lib/cobbler/kickstarts/centos7.ks\n```\n8）再次同步`cobbler`配置\n```\n[root@cobbler ~]# cobbler sync\n```\n9）新建虚拟机进行测试\n![](Cobbler自动化部署/cobbler06.png)\n选择`centos7.4`进行安装即可\n![](Cobbler自动化部署/cobbler07.png)\n\n>说明：在`client`端系统安装时，可以在`cobbler`服务端上查看日志`/var/log/messages`，观察安装的每一个`cobbler`流程\n\n## cobbler Web管理界面配置\n> `web`界面有很多功能，包括上传镜像、编辑`kickstart`、等等很多在命令行操作的都可以在`web`界面直接操作。\n> 在上面已经安装了`cobbler-web`软件，访问地址：https://IP/cobbler_web 即可。默认账号为`cobbler`，密码也为`cobbler`\n\n![](Cobbler自动化部署/cobbler08.png)\n\n**修改密码**\n```\n/etc/cobbler/users.conf     #Web服务授权配置文件\n/etc/cobbler/users.digest   #用于web访问的用户名密码\n\n[root@cobbler ~]# cat /etc/cobbler/users.digest \ncobbler:Cobbler:a2d6bae81669d707b72c0bd9806e01f3\n\n# 设置密码，在Cobbler组添加cobbler用户，输入2遍密码确\n[root@cobbler ~]# htdigest /etc/cobbler/users.digest \"Cobbler\" cobbler\nChanging password for user cobbler in realm Cobbler\nNew password: superman\nRe-type new password: superman\n\n# 同步配置并重启httpd、cobbler\n[root@cobbler ~]# cobbler sync\n[root@cobbler ~]# systemctl restart httpd\n[root@cobbler ~]# systemctl restart cobblerd\n```\n再次登录即使用新设置的密码登录即可。\n\n\n","source":"_posts/Cobbler自动化部署.md","raw":"---\ntitle: Cobbler自动化部署\ndate: 2019-06-12 10:10:22\ntags: Cobbler\ncategories: Cobbler\ncopyright: true\n---\n## cobbler简介\n>`Cobbler` 可以用来快速建立 `Linux` 网络安装环境，它已将`Linux`网络安装的技术门槛，从大专以上文化水平，成功降低到了初中水平，连补鞋匠都能学会。\n>网络安装服务器套件`Cobbler`（补鞋匠）从前，我们一直在装机民工这份很有前途的职业。自打若干年前`Red Hat`推出了 `Kickstart`，此后我们顿觉身价增倍。不再需要刻了光盘一台一台的安装`Linux`，只要搞定`PXE`、`DHCP`、`TFTP`，还有那满屏眼花缭乱不知所云的`Kickstart`脚本，我们就可以像哈利波特一样，轻点魔棒，瞬间安装上百台服务器。这一堆花里胡哨的东西可不是一般人能够整明白的，没有大专以上的学历，通不过英语四级，根本别想玩转。总而言之，这是一份多么有前途，多么有技术含量的工作啊。很不幸，`Red Ha`t 最新（`Cobbler`项目最初在`2008`年左右发布）发布了网络安装服务器套件`Cobbler`（补鞋匠），它已将`Linux`网络安装的技术门槛，从大专以上文化水平，成功降低到初中以下水平，连补鞋匠都能学会。\n\n>1、`Cobbler`是一个`Linux`服务器安装的服务，可以通过网络启动（`PXE`）的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理`DHCP`，`DNS`等。\n>2、`Cobbler`可以使用命令行方式管理，也提供了基于Web的界面管理工具（`cobbler-web`），还提供了`API`接口，可以方便二次开发使用。\n>3、`Cobbler`是较早前的`kickstart`的升级版，优点是比较容易配置，还自带web界面比较易于管理。\n>4、`Cobbler`内置了一个轻量级配置管理系统，但它也支持和其它配置管理系统集成，如`Puppet`。\n\n**参考网站**\n\n[cobbler官网](http://cobbler.github.io/)\n\n[Kickstart文件编写参考](https://www.linuxidc.com/Linux/2017-08/146168.htm)\n\n## cobbler对应关系\n\n![](Cobbler自动化部署/cobbler01.png)\n> `Cobbler`的配置结构基于一组注册的对象。每个对象表示一个与另一个实体相关联的实体。当一个对象指向另一个对象时，它就继承了被指向对象的数据，并可覆盖或添加更多特定信息。\n- 发行版(`distros`)： 表示一个操作系统。它承载了内核和`initrd`的信息，以及内核参数等其他数据。\n- 配置文件(`profiles`)：包含一个发行版、一个`kickstart`文件以及可能的存储库，还包括更多特定的内核参数等其他数据。\n- 系统(`systems`)：表示要配给的机器。它包括一个配置文件或一个镜像、`IP`和`MAC`地址、电源管理（地址、凭据、类型）以及更为专业的数据等信息。\n- 镜像(`images`)：可以替换一个保函不屑于此类别的文件的发行版对象（例如，无法分为内核和`initrd`的对象）。\n\n## cobbler集成的服务\n- PXE服务支持\n- DHCP服务管理\n- DNS服务管理\n- 电源管理\n- Kickstart服务支持\n- YUM仓库管理\n- TFTP\n- Apache\n\n## cobbler工作原理\n\n![](Cobbler自动化部署/cobbler09.png)\n\n**Server端**\n\n- 启动`Cobbler`服务\n- 进行`Cobbler`错误检查，执行`cobbler check`命令\n- 进行配置同步，执行`cobbler syn`c命令\n- 复制相关启动文件到`TFTP`目录中\n- 启动`DHCP`服务，提供地址分配\n- `DHCP`服务分配IP地址\n- `TFTP`传输启动文件\n- `Server`端接收安装信息\n- `Server`端发送`ISO`镜像与`Kickstart`文件\n\n**Client端**\n\n- 客户端以`PXE`模式启动\n- 客户端获取`IP`地址\n- 通过`TFTP`服务器获取启动文件\n- 进入`Cobbler`安装选择界面\n- 根据配置信息准备安装系统\n- 加载`Kickstart`文件\n- 传输系统安装的其它文件\n- 进行安装系统\n\n## cobbler安装\n\n>说明：虚拟机网卡采用NAT模式，不要使用桥接模式，因为后面会搭建DHCP服务器，在同一个局域网多个DHCP服务会有冲突。\n>VMware的NAT模式的dhcp服务也关闭，避免干扰。\n>![](Cobbler自动化部署/cobbler02.png)\n\n### 环境准备\n```\n# 关闭防火墙、selinux等\n[root@cobbler ~]# systemctl stop firewalld\n[root@cobbler ~]# systemctl disable firewalld\n[root@cobbler ~]# setenforce 0\n[root@cobbler ~]# sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/sysconfig/selinux\n```\n### 安装cobbler\n```\n# 配置epel源\n[root@cobbler ~]# yum -y install epel-release\n\n# 安装cobbler及dhcp httpd xinetd cobbler-web\n[root@cobbler ~]# yum -y install cobbler cobbler-web tftp-server dhcp httpd xinetd\n\n# 启动cobbler及httpd并加入开机启动\n[root@cobbler ~]# systemctl start httpd cobblerd\n[root@cobbler ~]# systemctl enable httpd cobblerd\n```\n查看安装后相关文件\n```\n[root@cobbler ~]# rpm -ql cobbler\n/etc/cobbler                  # 配置文件目录\n/etc/cobbler/settings         # cobbler主配置文件，这个文件是YAML格式，Cobbler是python写的程序。\n/etc/cobbler/dhcp.template    # DHCP服务的配置模板\n/etc/cobbler/tftpd.template   # tftp服务的配置模板\n/etc/cobbler/rsync.template   # rsync服务的配置模板\n/etc/cobbler/iso              # iso模板配置文件目录\n/etc/cobbler/pxe              # pxe模板文件目录\n/etc/cobbler/power            # 电源的配置文件目录\n/etc/cobbler/users.conf       # Web服务授权配置文件\n/etc/cobbler/users.digest     # 用于web访问的用户名密码配置文件\n/etc/cobbler/dnsmasq.template # DNS服务的配置模板\n/etc/cobbler/modules.conf     # Cobbler模块配置文件\n/var/lib/cobbler              # Cobbler数据目录\n/var/lib/cobbler/config       # 配置文件\n/var/lib/cobbler/kickstarts   # 默认存放kickstart文件\n/var/lib/cobbler/loaders      # 存放的各种引导程序\n/var/www/cobbler              # 系统安装镜像目录\n/var/www/cobbler/ks_mirror    # 导入的系统镜像列表\n/var/www/cobbler/images       # 导入的系统镜像启动文件\n/var/www/cobbler/repo_mirror  # yum源存储目录\n/var/log/cobbler              # 日志目录\n/var/log/cobbler/install.log  # 客户端系统安装日志\n/var/log/cobbler/cobbler.log  # cobbler日志\n```\n### 配置cobbler\n> 检查`Cobbler`的配置，如果看不到下面的结果，再次重启`cobbler`\n\n```\n[root@cobbler ~]# cobbler check\nThe following are potential configuration items that you may want to fix:\n\n1 : The 'server' field in /etc/cobbler/settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.\n2 : For PXE to be functional, the 'next_server' field in /etc/cobbler/settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.\n3 : change 'disable' to 'no' in /etc/xinetd.d/tftp\n4 : Some network boot-loaders are missing from /var/lib/cobbler/loaders, you may run 'cobbler get-loaders' to download them, or, if you only want to handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The 'cobbler get-loaders' command is the easiest way to resolve these requirements.\n5 : enable and start rsyncd.service with systemctl\n6 : debmirror package is not installed, it will be required to manage debian deployments and repositories\n7 : ksvalidator was not found, install pykickstart\n8 : The default password used by the sample templates for newly installed machines (default_password_crypted in /etc/cobbler/settings) is still set to 'cobbler' and should be changed, try: \"openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'\" to generate new one\n9 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them\n\nRestart cobblerd and then run 'cobbler sync' to apply changes.\n```\n> 看到上面出现的问题，然后一个一个的进行解决，先进行设置为可以动态配置，也可以直接更改配置文件。\n\n```\n# 设置可以动态修改配置文件\n[root@cobbler ~]# sed -ri '/allow_dynamic_settings:/c\\allow_dynamic_settings: 1' /etc/cobbler/settings\n[root@cobbler ~]# grep allow_dynamic_settings /etc/cobbler/settings \nallow_dynamic_settings: 1\n[root@cobbler ~]# systemctl restart cobblerd\n```\n逐个解决上面的问题\n```\n1. server\n[root@cobbler ~]# cobbler setting edit --name=server --value=192.168.2.128\n\n2. next_server\n[root@cobbler ~]# cobbler setting edit --name=next_server --value=192.168.2.128\n\n3. tftp_server\n[root@cobbler ~]# sed -ri '/disable/c\\disable = no' /etc/xinetd.d/tftp\n[root@cobbler ~]# systemctl enable xinetd\n[root@cobbler ~]# systemctl restart xinetd\n\n4. boot-loaders\n[root@cobbler ~]# cobbler get-loaders\n\n5. rsyncd\n[root@cobbler ~]# systemctl start rsyncd\n[root@cobbler ~]# systemctl enable rsyncd\n\n6. debmirror [optional]\n# 这个是可选项的，可以忽略。这里就忽略了\n\n7. pykickstart\n[root@cobbler ~]# yum -y install pykickstart\n\n8. default_password_crypted  #注意：这里设置的密码，也就是后面安装完系统的初始化登录密码\n[root@cobbler ~]# openssl passwd -1 -salt `openssl rand -hex 4` 'admin'\n$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0\n[root@cobbler ~]# cobbler setting edit --name=default_password_crypted --value='$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0'\n\n9. fencing tools [optional]\n[root@cobbler ~]# yum -y install fence-agents\n```\n解决完成再次查看\n```\n[root@cobbler ~]# cobbler check\nThe following are potential configuration items that you may want to fix:\n\n1 : debmirror package is not installed, it will be required to manage debian deployments and repositories\n\nRestart cobblerd and then run 'cobbler sync' to apply changes.\n```\n### 配置DHCP\n```\n[root@cobbler ~]# cobbler setting edit --name=manage_dhcp --value=1\n\n# 修改cobbler的dhcp模块，不要直接修改dhcp本身的配置文件，因为cobbler会覆盖\n[root@cobbler ~]# vim /etc/cobbler/dhcp.template\n...\nsubnet 192.168.2.0 netmask 255.255.255.0 { #这里改为分配的网段和掩码\n     #option routers             192.168.1.5; #如果有网关，这里改为网关地址\n     #option domain-name-servers 192.168.1.1; #如果有DNS，这里改为DNS地址\n     option subnet-mask         255.255.255.0; #改为分配的IP的掩码\n     range dynamic-bootp        192.168.2.100 192.168.2.254; #改为分配的IP的范围\n...\n```\n### 同步cobbler配置\n>同步cobbler配置，它会根据配置自动修改dhcp等服务。\n\n```\n[root@cobbler ~]# cobbler rsync \nNo such command: rsync\n[root@cobbler ~]# cobbler sync\ntask started: 2019-06-12_152623_sync\ntask started (id=Sync, time=Wed Jun 12 15:26:23 2019)\nrunning pre-sync triggers\ncleaning trees\nremoving: /var/www/cobbler/images/centos6.9-x86_64\nremoving: /var/lib/tftpboot/pxelinux.cfg/default\nremoving: /var/lib/tftpboot/grub/images\nremoving: /var/lib/tftpboot/grub/grub-x86.efi\nremoving: /var/lib/tftpboot/grub/grub-x86_64.efi\nremoving: /var/lib/tftpboot/grub/efidefault\nremoving: /var/lib/tftpboot/images/centos6.9-x86_64\nremoving: /var/lib/tftpboot/s390x/profile_list\ncopying bootloaders\ntrying hardlink /var/lib/cobbler/loaders/grub-x86.efi -> /var/lib/tftpboot/grub/grub-x86.efi\ntrying hardlink /var/lib/cobbler/loaders/grub-x86_64.efi -> /var/lib/tftpboot/grub/grub-x86_64.efi\ncopying distros to tftpboot\ncopying files for distro: centos6.9-x86_64\ntrying hardlink /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/vmlinuz -> /var/lib/tftpboot/images/centos6.9-x86_64/vmlinuz\ntrying hardlink /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/initrd.img -> /var/lib/tftpboot/images/centos6.9-x86_64/initrd.img\ncopying images\ngenerating PXE configuration files\ngenerating PXE menu structure\ncopying files for distro: centos6.9-x86_64\ntrying hardlink /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/vmlinuz -> /var/www/cobbler/images/centos6.9-x86_64/vmlinuz\ntrying hardlink /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/initrd.img -> /var/www/cobbler/images/centos6.9-x86_64/initrd.img\nWriting template files for centos6.9-x86_64\nrendering DHCP files\ngenerating /etc/dhcp/dhcpd.conf\nrendering TFTPD files\ngenerating /etc/xinetd.d/tftp\nprocessing boot_files for distro: centos6.9-x86_64\ncleaning link caches\nrunning post-sync triggers\nrunning python triggers from /var/lib/cobbler/triggers/sync/post/*\nrunning python trigger cobbler.modules.sync_post_restart_services\nrunning: dhcpd -t -q\nreceived on stdout: \nreceived on stderr: \nrunning: service dhcpd restart\nreceived on stdout: \nreceived on stderr: Redirecting to /bin/systemctl restart dhcpd.service\n\nrunning shell triggers from /var/lib/cobbler/triggers/sync/post/*\nrunning python triggers from /var/lib/cobbler/triggers/change/*\nrunning python trigger cobbler.modules.manage_genders\nrunning python trigger cobbler.modules.scm_track\nrunning shell triggers from /var/lib/cobbler/triggers/change/*\n*** TASK COMPLETE ***\n```\n这时候创建一个新虚拟机可以获取到如下信息，没有镜像选择，只能从本地启动\n![](Cobbler自动化部署/cobbler03.png)\n\n### cobbler命令帮助\n| 命令             | 说明                                       |\n| ---------------- | :----------------------------------------- |\n| cobbler check    | 核对当前设置是否有问题                     |\n| cobbler list     | 列出所有的cobbler元素                      |\n| cobbler report   | 列出元素的详细信息                         |\n| cobbler sync     | 同步配置到数据目录，更改配置最好都执行一下 |\n| cobbler reposync | 同步yum仓库                                |\n| cobbler distro   | 查看导入的发行版系统信息                   |\n| cobbler system   | 查看添加的系统信息                         |\n| cobbler profile  | 查看配置信息                               |\n\n## cobbler配置安装centos6.x\n>由于我这里实在`centos7`系统上面配置的`cobbler`，所以上传了一个`centos6`的镜像并进行挂载。\n\n1）创建挂载点，并进行挂载\n```\n[root@cobbler ~]# mkdir /centos6\n[root@cobbler ~]# mount -o loop CentOS-6.9-x86_64-bin-DVD1.iso /centos6\n```\n2）查看挂载后的目录\n```\n[root@cobbler ~]# ls /centos6/\nCentOS_BuildTag  images                    repodata                       RPM-GPG-KEY-CentOS-Testing-6\nEFI              isolinux                  RPM-GPG-KEY-CentOS-6           TRANS.TBL\nEULA             Packages                  RPM-GPG-KEY-CentOS-Debug-6\nGPL              RELEASE-NOTES-en-US.html  RPM-GPG-KEY-CentOS-Security-6\n```\n3）导入镜像\n```\n[root@cobbler ~]# cobbler import --path=/centos6 --name=centos6.9 --arch=x86_64\n# --path 镜像路径\n# --name 为安装源定义一个名字\n# --arch 指定安装源是32位、64位、ia64, 目前支持的选项有: x86│x86_64│ia64\n# 安装源的唯一标示就是根据name参数来定义，本例导入成功后，安装源的唯一标示就是：centos6.9，如果重复，系统会提示导入失败。\n```\n4）查看导入后镜像信息\n```\n[root@cobbler ~]# cobbler distro report --name=centos6.9-x86_64\nName                           : centos6.9-x86_64\nArchitecture                   : x86_64\nTFTP Boot Files                : {}\nBreed                          : redhat\nComment                        : \nFetchable Files                : {}\nInitrd                         : /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/initrd.img\nKernel                         : /var/www/cobbler/ks_mirror/centos6.9-x86_64/images/pxeboot/vmlinuz\nKernel Options                 : {}\nKernel Options (Post Install)  : {}\nKickstart Metadata             : {'tree': 'http://@@http_server@@/cblr/links/centos6.9-x86_64'}\nManagement Classes             : []\nOS Version                     : rhel6\nOwners                         : ['admin']\nRed Hat Management Key         : <<inherit>>\nRed Hat Management Server      : <<inherit>>\nTemplate Files                 : {}\n```\n5）查看`profile`信息\n```\n[root@cobbler ~]# cobbler profile report --name=centos6.9-x86_64\nName                           : centos6.9-x86_64\nTFTP Boot Files                : {}\nComment                        : \nDHCP Tag                       : default\nDistribution                   : centos6.9-x86_64\nEnable gPXE?                   : 0\nEnable PXE Menu?               : 1\nFetchable Files                : {}\nKernel Options                 : {}\nKernel Options (Post Install)  : {}\nKickstart                      : /var/lib/cobbler/kickstarts/sample_end.ks\nKickstart Metadata             : {}\nManagement Classes             : []\nManagement Parameters          : <<inherit>>\nName Servers                   : []\nName Servers Search Path       : []\nOwners                         : ['admin']\nParent Profile                 : \nInternal proxy                 : \nRed Hat Management Key         : <<inherit>>\nRed Hat Management Server      : <<inherit>>\nRepos                          : []\nServer Override                : <<inherit>>\nTemplate Files                 : {}\nVirt Auto Boot                 : 1\nVirt Bridge                    : xenbr0\nVirt CPUs                      : 1\nVirt Disk Driver Type          : raw\nVirt File Size(GB)             : 5\nVirt Path                      : \nVirt RAM (MB)                  : 512\nVirt Type                      : kvm\n```\n6）`copy`一份`profile`文件(`ks`)，进行修改\n```\n[root@cobbler ~]# cd /var/lib/cobbler/kickstarts/\n[root@cobbler kickstarts]# ls\ndefault.ks    install_profiles  sample_autoyast.xml  sample_esxi4.ks  sample.ks\nesxi4-ks.cfg  legacy.ks         sample_end.ks        sample_esxi5.ks  sample_old.seed\nesxi5-ks.cfg  pxerescue.ks      sample_esx4.ks       sample_esxi6.ks  sample.seed\n[root@cobbler kickstarts]# cp sample_end.ks centos6.ks\n\n# 编辑centos6的kickstart文件\n[root@cobbler kickstarts]# vim centos6.ks \n# This kickstart file should only be used with EL > 5 and/or Fedora > 7.\n# For older versions please use the sample.ks kickstart file.\n# Install OS instead of upgrade\ninstall\n# Use text mode install\ntext\n# System keyboard\nkeyboard us\n# System language\nlang en_US\n# System timezone\ntimezone  Asia/ShangHai\n#Root password\nrootpw --iscrypted $default_password_crypted\n# System authorization information\nauth  --useshadow  --enablemd5\n# Firewall configuration\nfirewall --disabled\n# SELinux configuration\nselinux --disabled\n# Use network installation\nurl --url=$tree\n\n# Clear the Master Boot Record\nzerombr\n# System bootloader configuration\nbootloader --location=mbr\n# Partition clearing information\nclearpart --all --initlabel\npart /boot --fstype=ext4 --size=500\npart swap --fstype=swap --size=2048\npart / --fstype=ext4 --grow --size=200 \n\n# If any cobbler repo definitions were referenced in the kickstart profile, include them here.\n$yum_repo_stanza\n# Network information\n$SNIPPET('network_config')\n# Do not configure the X Window System\nskipx\n# Run the Setup Agent on first boot\nfirstboot --disable\n# Reboot after installation\nreboot\n\n\n%pre\n$SNIPPET('log_ks_pre')\n$SNIPPET('kickstart_start')\n$SNIPPET('pre_install_network_config')\n# Enable installation monitoring\n$SNIPPET('pre_anamon')\n%end\n\n%packages\n$SNIPPET('func_install_if_enabled')\n@core\n@base\ntree\nnmap\nwget\nlftp\nlrzsz\ntelnet\n%end\n\n%post --nochroot\n$SNIPPET('log_ks_post_nochroot')\n%end\n\n%post\n$SNIPPET('log_ks_post')\n# Start yum configuration\n$yum_config_stanza\n# End yum configuration\n$SNIPPET('post_install_kernel_options')\n$SNIPPET('post_install_network_config')\n$SNIPPET('func_register_if_enabled')\n$SNIPPET('download_config_files')\n$SNIPPET('koan_environment')\n$SNIPPET('redhat_register')\n$SNIPPET('cobbler_register')\n# Enable post-install boot notification\n$SNIPPET('post_anamon')\n# Start final steps\n$SNIPPET('kickstart_done')\n# End final steps\n\nsed -ri \"/^#UseDNS/c\\UseDNS no\" /etc/ssh/sshd_config\nsed -ri \"/^GSSAPIAuthentication/c\\GSSAPIAuthentication no\" /etc/ssh/sshd_config\n%end\n```\n7）编辑`centos6`镜像所使用的`kickstart`文件\n```\n# 动态编辑指定使用新的kickstart文件\n[root@cobbler ~]# cobbler profile edit --name=centos6.9-x86_64 --kickstart=/var/lib/cobbler/kickstarts/centos6.ks\n\n# 验证是否更改成功\n[root@cobbler ~]# cobbler profile report --name=centos6.9-x86_64 |grep Kickstart\nKickstart                      : /var/lib/cobbler/kickstarts/centos6.ks\n```\n8）再次同步`cobbler`配置\n```\n[root@cobbler ~]# cobbler sync\n```\n9）新建虚拟机进行测试\n![](Cobbler自动化部署/cobbler04.png)\n选择`centos6.9`进行安装，会按照`kickstart`文件安装并启动\n![](Cobbler自动化部署/cobbler05.png)\n\n## cobbler配置安装centos7.x\n>我这里cobbler服务器就是7的系统，所以直接挂载/dev/cdrom即可\n\n1）创建挂载点，并进行挂载\n```\n[root@cobbler ~]# mkdir /centos7\n[root@cobbler ~]# mount -o loop /dev/cdrom /centos7\n```\n2）查看挂载后的目录\n```\n[root@cobbler ~]# ls /centos7/\nCentOS_BuildTag  EULA  images    LiveOS    repodata              RPM-GPG-KEY-CentOS-Testing-7\nEFI              GPL   isolinux  Packages  RPM-GPG-KEY-CentOS-7  TRANS.TBL\n```\n3）导入镜像\n```\n[root@cobbler ~]# cobbler import --path=/centos7 --name=centos7.4 --arch=x86_64\ntask started: 2019-06-12_165812_import\ntask started (id=Media import, time=Wed Jun 12 16:58:12 2019)\nFound a candidate signature: breed=redhat, version=rhel6\nFound a candidate signature: breed=redhat, version=rhel7\nFound a matching signature: breed=redhat, version=rhel7\nAdding distros from path /var/www/cobbler/ks_mirror/centos7.4-x86_64:\ncreating new distro: centos7.4-x86_64\ntrying symlink: /var/www/cobbler/ks_mirror/centos7.4-x86_64 -> /var/www/cobbler/links/centos7.4-x86_64\ncreating new profile: centos7.4-x86_64\nassociating repos\nchecking for rsync repo(s)\nchecking for rhn repo(s)\nchecking for yum repo(s)\nstarting descent into /var/www/cobbler/ks_mirror/centos7.4-x86_64 for centos7.4-x86_64\nprocessing repo at : /var/www/cobbler/ks_mirror/centos7.4-x86_64\nneed to process repo/comps: /var/www/cobbler/ks_mirror/centos7.4-x86_64\nlooking for /var/www/cobbler/ks_mirror/centos7.4-x86_64/repodata/*comps*.xml\nKeeping repodata as-is :/var/www/cobbler/ks_mirror/centos7.4-x86_64/repodata\n*** TASK COMPLETE ***\n```\n4）查看导入后镜像信息\n```\n[root@cobbler ~]# cobbler distro report --name=centos7.4-x86_64\nName                           : centos7.4-x86_64\nArchitecture                   : x86_64\nTFTP Boot Files                : {}\nBreed                          : redhat\nComment                        : \nFetchable Files                : {}\nInitrd                         : /var/www/cobbler/ks_mirror/centos7.4-x86_64/images/pxeboot/initrd.img\nKernel                         : /var/www/cobbler/ks_mirror/centos7.4-x86_64/images/pxeboot/vmlinuz\nKernel Options                 : {}\nKernel Options (Post Install)  : {}\nKickstart Metadata             : {'tree': 'http://@@http_server@@/cblr/links/centos7.4-x86_64'}\nManagement Classes             : []\nOS Version                     : rhel7\nOwners                         : ['admin']\nRed Hat Management Key         : <<inherit>>\nRed Hat Management Server      : <<inherit>>\nTemplate Files                 : {}\n```\n5）查看`profile`信息\n```\n[root@cobbler ~]# cobbler profile report --name=centos7.4-x86_64\nName                           : centos7.4-x86_64\nTFTP Boot Files                : {}\nComment                        : \nDHCP Tag                       : default\nDistribution                   : centos7.4-x86_64\nEnable gPXE?                   : 0\nEnable PXE Menu?               : 1\nFetchable Files                : {}\nKernel Options                 : {}\nKernel Options (Post Install)  : {}\nKickstart                      : /var/lib/cobbler/kickstarts/sample_end.ks\nKickstart Metadata             : {}\nManagement Classes             : []\nManagement Parameters          : <<inherit>>\nName Servers                   : []\nName Servers Search Path       : []\nOwners                         : ['admin']\nParent Profile                 : \nInternal proxy                 : \nRed Hat Management Key         : <<inherit>>\nRed Hat Management Server      : <<inherit>>\nRepos                          : []\nServer Override                : <<inherit>>\nTemplate Files                 : {}\nVirt Auto Boot                 : 1\nVirt Bridge                    : xenbr0\nVirt CPUs                      : 1\nVirt Disk Driver Type          : raw\nVirt File Size(GB)             : 5\nVirt Path                      : \nVirt RAM (MB)                  : 512\nVirt Type                      : kvm\n```\n7）`copy`一份`profile`文件( `ks` )，进行修改,这里直接copy上面6的了，然后修改修改即可\n```\n[root@cobbler ~]# cd /var/lib/cobbler/kickstarts/\n[root@cobbler kickstarts]# cp centos6.ks centos7.ks\n\n# 编辑centos7的kickstart文件\n[root@cobbler kickstarts]# vim centos7.ks\n# This kickstart file should only be used with EL > 5 and/or Fedora > 7.\n# For older versions please use the sample.ks kickstart file.\n# Install OS instead of upgrade\ninstall\n# Use text mode install\ntext\n# System keyboard\nkeyboard us\n# System language\nlang en_US\n# System timezone\ntimezone  Asia/ShangHai\n#Root password\nrootpw --iscrypted $default_password_crypted\n# System authorization information\nauth  --useshadow  --enablemd5\n# Firewall configuration\nfirewall --disabled\n# SELinux configuration\nselinux --disabled\n# Use network installation\nurl --url=$tree\n\n# Clear the Master Boot Record\nzerombr\n# System bootloader configuration\nbootloader --location=mbr\n# Partition clearing information\nclearpart --all --initlabel\npart /boot --fstype=xfs --size=500\npart swap --fstype=swap --size=2048\npart / --fstype=xfs --grow --size=200 \n\n# If any cobbler repo definitions were referenced in the kickstart profile, include them here.\n$yum_repo_stanza\n# Network information\n$SNIPPET('network_config')\n# Do not configure the X Window System\nskipx\n# Run the Setup Agent on first boot\nfirstboot --disable\n# Reboot after installation\nreboot\n\n\n%pre\n$SNIPPET('log_ks_pre')\n$SNIPPET('kickstart_start')\n$SNIPPET('pre_install_network_config')\n# Enable installation monitoring\n$SNIPPET('pre_anamon')\n%end\n\n%packages\n$SNIPPET('func_install_if_enabled')\n@core\n@base\ntree\nnmap\nwget\nlftp\nlrzsz\ntelnet\n%end\n\n%post --nochroot\n$SNIPPET('log_ks_post_nochroot')\n%end\n\n%post\n$SNIPPET('log_ks_post')\n# Start yum configuration\n$yum_config_stanza\n# End yum configuration\n$SNIPPET('post_install_kernel_options')\n$SNIPPET('post_install_network_config')\n$SNIPPET('func_register_if_enabled')\n$SNIPPET('download_config_files')\n$SNIPPET('koan_environment')\n$SNIPPET('redhat_register')\n$SNIPPET('cobbler_register')\n# Enable post-install boot notification\n$SNIPPET('post_anamon')\n# Start final steps\n$SNIPPET('kickstart_done')\n# End final steps\n\nsed -ri \"/^#UseDNS/c\\UseDNS no\" /etc/ssh/sshd_config\nsed -ri \"/^GSSAPIAuthentication/c\\GSSAPIAuthentication no\" /etc/ssh/sshd_config\n%end\n```\n7）编辑`centos7`镜像所使用的`kickstart`文件\n```\n# 动态编辑指定使用新的kickstart文件\n[root@cobbler ~]# cobbler profile edit --name=centos7.4-x86_64 --kickstart=/var/lib/cobbler/kickstarts/centos7.ks\n\n# 验证是否更改成功\n[root@cobbler ~]# cobbler profile report --name=centos7.4-x86_64 |grep Kickstart\nKickstart                      : /var/lib/cobbler/kickstarts/centos7.ks\n```\n8）再次同步`cobbler`配置\n```\n[root@cobbler ~]# cobbler sync\n```\n9）新建虚拟机进行测试\n![](Cobbler自动化部署/cobbler06.png)\n选择`centos7.4`进行安装即可\n![](Cobbler自动化部署/cobbler07.png)\n\n>说明：在`client`端系统安装时，可以在`cobbler`服务端上查看日志`/var/log/messages`，观察安装的每一个`cobbler`流程\n\n## cobbler Web管理界面配置\n> `web`界面有很多功能，包括上传镜像、编辑`kickstart`、等等很多在命令行操作的都可以在`web`界面直接操作。\n> 在上面已经安装了`cobbler-web`软件，访问地址：https://IP/cobbler_web 即可。默认账号为`cobbler`，密码也为`cobbler`\n\n![](Cobbler自动化部署/cobbler08.png)\n\n**修改密码**\n```\n/etc/cobbler/users.conf     #Web服务授权配置文件\n/etc/cobbler/users.digest   #用于web访问的用户名密码\n\n[root@cobbler ~]# cat /etc/cobbler/users.digest \ncobbler:Cobbler:a2d6bae81669d707b72c0bd9806e01f3\n\n# 设置密码，在Cobbler组添加cobbler用户，输入2遍密码确\n[root@cobbler ~]# htdigest /etc/cobbler/users.digest \"Cobbler\" cobbler\nChanging password for user cobbler in realm Cobbler\nNew password: superman\nRe-type new password: superman\n\n# 同步配置并重启httpd、cobbler\n[root@cobbler ~]# cobbler sync\n[root@cobbler ~]# systemctl restart httpd\n[root@cobbler ~]# systemctl restart cobblerd\n```\n再次登录即使用新设置的密码登录即可。\n\n\n","slug":"Cobbler自动化部署","published":1,"updated":"2019-07-10T01:46:29.912Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjxwlqrqg002glctcd5evuez3","content":"<h2 id=\"cobbler简介\"><a href=\"#cobbler简介\" class=\"headerlink\" title=\"cobbler简介\"></a>cobbler简介</h2><blockquote>\n<p><code>Cobbler</code> 可以用来快速建立 <code>Linux</code> 网络安装环境，它已将<code>Linux</code>网络安装的技术门槛，从大专以上文化水平，成功降低到了初中水平，连补鞋匠都能学会。<br>网络安装服务器套件<code>Cobbler</code>（补鞋匠）从前，我们一直在装机民工这份很有前途的职业。自打若干年前<code>Red Hat</code>推出了 <code>Kickstart</code>，此后我们顿觉身价增倍。不再需要刻了光盘一台一台的安装<code>Linux</code>，只要搞定<code>PXE</code>、<code>DHCP</code>、<code>TFTP</code>，还有那满屏眼花缭乱不知所云的<code>Kickstart</code>脚本，我们就可以像哈利波特一样，轻点魔棒，瞬间安装上百台服务器。这一堆花里胡哨的东西可不是一般人能够整明白的，没有大专以上的学历，通不过英语四级，根本别想玩转。总而言之，这是一份多么有前途，多么有技术含量的工作啊。很不幸，<code>Red Ha</code>t 最新（<code>Cobbler</code>项目最初在<code>2008</code>年左右发布）发布了网络安装服务器套件<code>Cobbler</code>（补鞋匠），它已将<code>Linux</code>网络安装的技术门槛，从大专以上文化水平，成功降低到初中以下水平，连补鞋匠都能学会。</p>\n</blockquote>\n<blockquote>\n<p>1、<code>Cobbler</code>是一个<code>Linux</code>服务器安装的服务，可以通过网络启动（<code>PXE</code>）的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理<code>DHCP</code>，<code>DNS</code>等。<br>2、<code>Cobbler</code>可以使用命令行方式管理，也提供了基于Web的界面管理工具（<code>cobbler-web</code>），还提供了<code>API</code>接口，可以方便二次开发使用。<br>3、<code>Cobbler</code>是较早前的<code>kickstart</code>的升级版，优点是比较容易配置，还自带web界面比较易于管理。<br>4、<code>Cobbler</code>内置了一个轻量级配置管理系统，但它也支持和其它配置管理系统集成，如<code>Puppet</code>。</p>\n</blockquote>\n<p><strong>参考网站</strong></p>\n<p><a href=\"http://cobbler.github.io/\" target=\"_blank\" rel=\"noopener\">cobbler官网</a></p>\n<p><a href=\"https://www.linuxidc.com/Linux/2017-08/146168.htm\" target=\"_blank\" rel=\"noopener\">Kickstart文件编写参考</a></p>\n<h2 id=\"cobbler对应关系\"><a href=\"#cobbler对应关系\" class=\"headerlink\" title=\"cobbler对应关系\"></a>cobbler对应关系</h2><p><img src=\"/2019/06/12/Cobbler自动化部署/cobbler01.png\" alt></p>\n<blockquote>\n<p><code>Cobbler</code>的配置结构基于一组注册的对象。每个对象表示一个与另一个实体相关联的实体。当一个对象指向另一个对象时，它就继承了被指向对象的数据，并可覆盖或添加更多特定信息。</p>\n<ul>\n<li>发行版(<code>distros</code>)： 表示一个操作系统。它承载了内核和<code>initrd</code>的信息，以及内核参数等其他数据。</li>\n<li>配置文件(<code>profiles</code>)：包含一个发行版、一个<code>kickstart</code>文件以及可能的存储库，还包括更多特定的内核参数等其他数据。</li>\n<li>系统(<code>systems</code>)：表示要配给的机器。它包括一个配置文件或一个镜像、<code>IP</code>和<code>MAC</code>地址、电源管理（地址、凭据、类型）以及更为专业的数据等信息。</li>\n<li>镜像(<code>images</code>)：可以替换一个保函不屑于此类别的文件的发行版对象（例如，无法分为内核和<code>initrd</code>的对象）。</li>\n</ul>\n</blockquote>\n<h2 id=\"cobbler集成的服务\"><a href=\"#cobbler集成的服务\" class=\"headerlink\" title=\"cobbler集成的服务\"></a>cobbler集成的服务</h2><ul>\n<li>PXE服务支持</li>\n<li>DHCP服务管理</li>\n<li>DNS服务管理</li>\n<li>电源管理</li>\n<li>Kickstart服务支持</li>\n<li>YUM仓库管理</li>\n<li>TFTP</li>\n<li>Apache</li>\n</ul>\n<h2 id=\"cobbler工作原理\"><a href=\"#cobbler工作原理\" class=\"headerlink\" title=\"cobbler工作原理\"></a>cobbler工作原理</h2><p><img src=\"/2019/06/12/Cobbler自动化部署/cobbler09.png\" alt></p>\n<p><strong>Server端</strong></p>\n<ul>\n<li>启动<code>Cobbler</code>服务</li>\n<li>进行<code>Cobbler</code>错误检查，执行<code>cobbler check</code>命令</li>\n<li>进行配置同步，执行<code>cobbler syn</code>c命令</li>\n<li>复制相关启动文件到<code>TFTP</code>目录中</li>\n<li>启动<code>DHCP</code>服务，提供地址分配</li>\n<li><code>DHCP</code>服务分配IP地址</li>\n<li><code>TFTP</code>传输启动文件</li>\n<li><code>Server</code>端接收安装信息</li>\n<li><code>Server</code>端发送<code>ISO</code>镜像与<code>Kickstart</code>文件</li>\n</ul>\n<p><strong>Client端</strong></p>\n<ul>\n<li>客户端以<code>PXE</code>模式启动</li>\n<li>客户端获取<code>IP</code>地址</li>\n<li>通过<code>TFTP</code>服务器获取启动文件</li>\n<li>进入<code>Cobbler</code>安装选择界面</li>\n<li>根据配置信息准备安装系统</li>\n<li>加载<code>Kickstart</code>文件</li>\n<li>传输系统安装的其它文件</li>\n<li>进行安装系统</li>\n</ul>\n<h2 id=\"cobbler安装\"><a href=\"#cobbler安装\" class=\"headerlink\" title=\"cobbler安装\"></a>cobbler安装</h2><blockquote>\n<p>说明：虚拟机网卡采用NAT模式，不要使用桥接模式，因为后面会搭建DHCP服务器，在同一个局域网多个DHCP服务会有冲突。<br>VMware的NAT模式的dhcp服务也关闭，避免干扰。<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler02.png\" alt></p>\n</blockquote>\n<h3 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h3><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 关闭防火墙、selinux等</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl stop firewalld</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl disable firewalld</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># setenforce 0</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># sed -i <span class=\"string\">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/sysconfig/selinux</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"安装cobbler\"><a href=\"#安装cobbler\" class=\"headerlink\" title=\"安装cobbler\"></a>安装cobbler</h3><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 配置epel源</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># yum -y install epel-release</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 安装cobbler及dhcp httpd xinetd cobbler-web</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># yum -y install cobbler cobbler-web tftp-server dhcp httpd xinetd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 启动cobbler及httpd并加入开机启动</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl start httpd cobblerd</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl enable httpd cobblerd</span></span><br></pre></td></tr></table></figure>\n<p>查看安装后相关文件<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"meta\"># rpm -ql cobbler</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler                  <span class=\"meta\"># 配置文件目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/settings         <span class=\"meta\"># cobbler主配置文件，这个文件是YAML格式，Cobbler是python写的程序。</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/dhcp.template    <span class=\"meta\"># DHCP服务的配置模板</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/tftpd.template   <span class=\"meta\"># tftp服务的配置模板</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/rsync.template   <span class=\"meta\"># rsync服务的配置模板</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/iso              <span class=\"meta\"># iso模板配置文件目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/pxe              <span class=\"meta\"># pxe模板文件目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/power            <span class=\"meta\"># 电源的配置文件目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/users.conf       <span class=\"meta\"># Web服务授权配置文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/users.digest     <span class=\"meta\"># 用于web访问的用户名密码配置文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/dnsmasq.template <span class=\"meta\"># DNS服务的配置模板</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/modules.conf     <span class=\"meta\"># Cobbler模块配置文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>lib/cobbler              <span class=\"meta\"># Cobbler数据目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>lib<span class=\"meta-keyword\">/cobbler/</span>config       <span class=\"meta\"># 配置文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>lib<span class=\"meta-keyword\">/cobbler/</span>kickstarts   <span class=\"meta\"># 默认存放kickstart文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>lib<span class=\"meta-keyword\">/cobbler/</span>loaders      <span class=\"meta\"># 存放的各种引导程序</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>www/cobbler              <span class=\"meta\"># 系统安装镜像目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>www<span class=\"meta-keyword\">/cobbler/</span>ks_mirror    <span class=\"meta\"># 导入的系统镜像列表</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>www<span class=\"meta-keyword\">/cobbler/</span>images       <span class=\"meta\"># 导入的系统镜像启动文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>www<span class=\"meta-keyword\">/cobbler/</span>repo_mirror  <span class=\"meta\"># yum源存储目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>log/cobbler              <span class=\"meta\"># 日志目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>log<span class=\"meta-keyword\">/cobbler/</span>install.log  <span class=\"meta\"># 客户端系统安装日志</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>log<span class=\"meta-keyword\">/cobbler/</span>cobbler.log  <span class=\"meta\"># cobbler日志</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"配置cobbler\"><a href=\"#配置cobbler\" class=\"headerlink\" title=\"配置cobbler\"></a>配置cobbler</h3><blockquote>\n<p>检查<code>Cobbler</code>的配置，如果看不到下面的结果，再次重启<code>cobbler</code></p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cobbler check</span></span><br><span class=\"line\">The following are potential configuration items that you may want to fix:</span><br><span class=\"line\"></span><br><span class=\"line\">1 : The 'server' field in /etc/cobbler/settings must be <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> something other <span class=\"keyword\">than</span> localhost, <span class=\"keyword\">or</span> kickstarting features will <span class=\"keyword\">not</span> work.  This should be a resolvable hostname <span class=\"keyword\">or</span> IP <span class=\"keyword\">for</span> the boot <span class=\"keyword\">server</span> <span class=\"keyword\">as</span> reachable <span class=\"keyword\">by</span> <span class=\"keyword\">all</span> machines that will <span class=\"keyword\">use</span> it.</span><br><span class=\"line\"><span class=\"number\">2</span> : <span class=\"keyword\">For</span> PXE <span class=\"keyword\">to</span> be functional, the <span class=\"string\">'next_server'</span> <span class=\"keyword\">field</span> <span class=\"keyword\">in</span> /etc/cobbler/<span class=\"keyword\">settings</span> must be <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> something other <span class=\"keyword\">than</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>, <span class=\"keyword\">and</span> should <span class=\"keyword\">match</span> the IP <span class=\"keyword\">of</span> the boot <span class=\"keyword\">server</span> <span class=\"keyword\">on</span> the PXE network.</span><br><span class=\"line\"><span class=\"number\">3</span> : <span class=\"keyword\">change</span> <span class=\"string\">'disable'</span> <span class=\"keyword\">to</span> <span class=\"string\">'no'</span> <span class=\"keyword\">in</span> /etc/xinetd.d/tftp</span><br><span class=\"line\"><span class=\"number\">4</span> : <span class=\"keyword\">Some</span> network boot-loaders <span class=\"keyword\">are</span> <span class=\"keyword\">missing</span> <span class=\"keyword\">from</span> /<span class=\"keyword\">var</span>/lib/cobbler/loaders, you may run <span class=\"string\">'cobbler get-loaders'</span> <span class=\"keyword\">to</span> download them, <span class=\"keyword\">or</span>, <span class=\"keyword\">if</span> you <span class=\"keyword\">only</span> want <span class=\"keyword\">to</span> handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* <span class=\"keyword\">version</span> <span class=\"keyword\">of</span> the syslinux <span class=\"keyword\">package</span> installed <span class=\"keyword\">and</span> can <span class=\"keyword\">ignore</span> this message entirely.  Files <span class=\"keyword\">in</span> this <span class=\"keyword\">directory</span>, should you want <span class=\"keyword\">to</span> support <span class=\"keyword\">all</span> architectures, should <span class=\"keyword\">include</span> pxelinux<span class=\"number\">.0</span>, menu.c32, elilo.efi, <span class=\"keyword\">and</span> yaboot. The <span class=\"string\">'cobbler get-loaders'</span> command <span class=\"keyword\">is</span> the easiest way <span class=\"keyword\">to</span> resolve these requirements.</span><br><span class=\"line\"><span class=\"number\">5</span> : <span class=\"keyword\">enable</span> <span class=\"keyword\">and</span> <span class=\"keyword\">start</span> rsyncd.service <span class=\"keyword\">with</span> systemctl</span><br><span class=\"line\"><span class=\"number\">6</span> : debmirror <span class=\"keyword\">package</span> <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> installed, it will be <span class=\"keyword\">required</span> <span class=\"keyword\">to</span> manage debian deployments <span class=\"keyword\">and</span> repositories</span><br><span class=\"line\"><span class=\"number\">7</span> : ksvalidator was <span class=\"keyword\">not</span> <span class=\"keyword\">found</span>, <span class=\"keyword\">install</span> pykickstart</span><br><span class=\"line\"><span class=\"number\">8</span> : The <span class=\"keyword\">default</span> <span class=\"keyword\">password</span> used <span class=\"keyword\">by</span> the <span class=\"keyword\">sample</span> templates <span class=\"keyword\">for</span> newly installed machines (default_password_crypted <span class=\"keyword\">in</span> /etc/cobbler/<span class=\"keyword\">settings</span>) <span class=\"keyword\">is</span> still <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"string\">'cobbler'</span> <span class=\"keyword\">and</span> should be <span class=\"keyword\">changed</span>, try: <span class=\"string\">\"openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'\"</span> <span class=\"keyword\">to</span> generate <span class=\"keyword\">new</span> one</span><br><span class=\"line\"><span class=\"number\">9</span> : fencing tools were <span class=\"keyword\">not</span> <span class=\"keyword\">found</span>, <span class=\"keyword\">and</span> <span class=\"keyword\">are</span> <span class=\"keyword\">required</span> <span class=\"keyword\">to</span> <span class=\"keyword\">use</span> the (optional) <span class=\"keyword\">power</span> <span class=\"keyword\">management</span> features. <span class=\"keyword\">install</span> cman <span class=\"keyword\">or</span> fence-agents <span class=\"keyword\">to</span> <span class=\"keyword\">use</span> them</span><br><span class=\"line\"></span><br><span class=\"line\">Restart cobblerd <span class=\"keyword\">and</span> <span class=\"keyword\">then</span> run <span class=\"string\">'cobbler sync'</span> <span class=\"keyword\">to</span> <span class=\"keyword\">apply</span> changes.</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>看到上面出现的问题，然后一个一个的进行解决，先进行设置为可以动态配置，也可以直接更改配置文件。</p>\n</blockquote>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 设置可以动态修改配置文件</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># sed -ri <span class=\"string\">'/allow_dynamic_settings:/c\\allow_dynamic_settings: 1'</span> /etc/cobbler/settings</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># grep allow_dynamic_settings /etc/cobbler/settings </span></span><br><span class=\"line\">allow_dynamic_settings: <span class=\"number\">1</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl restart cobblerd</span></span><br></pre></td></tr></table></figure>\n<p>逐个解决上面的问题<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1.</span> server</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler setting edit --name=server --value=192.168.2.128</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2.</span> next_server</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler setting edit --name=next_server --value=192.168.2.128</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3.</span> tftp_server</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># sed -ri <span class=\"string\">'/disable/c\\disable = no'</span> /etc/xinetd.d/tftp</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl enable xinetd</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl restart xinetd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4.</span> boot-loaders</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler get-loaders</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">5.</span> rsyncd</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl start rsyncd</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl enable rsyncd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">6.</span> debmirror [optional]</span><br><span class=\"line\"><span class=\"meta\"># 这个是可选项的，可以忽略。这里就忽略了</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">7.</span> pykickstart</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># yum -y install pykickstart</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">8.</span> default_password_crypted  <span class=\"meta\">#注意：这里设置的密码，也就是后面安装完系统的初始化登录密码</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># openssl passwd -1 -salt `openssl rand -hex 4` <span class=\"string\">'admin'</span></span></span><br><span class=\"line\">$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler setting edit --name=default_password_crypted --value=<span class=\"string\">'$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">9.</span> fencing tools [optional]</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># yum -y install fence-agents</span></span><br></pre></td></tr></table></figure></p>\n<p>解决完成再次查看<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cobbler check</span></span><br><span class=\"line\">The following are potential configuration items <span class=\"literal\">that</span> you may want <span class=\"keyword\">to</span> fix:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> : debmirror package <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> installed, <span class=\"literal\">it</span> will be required <span class=\"keyword\">to</span> manage debian deployments <span class=\"keyword\">and</span> repositories</span><br><span class=\"line\"></span><br><span class=\"line\">Restart cobblerd <span class=\"keyword\">and</span> <span class=\"keyword\">then</span> run <span class=\"string\">'cobbler sync'</span> <span class=\"keyword\">to</span> apply changes.</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"配置DHCP\"><a href=\"#配置DHCP\" class=\"headerlink\" title=\"配置DHCP\"></a>配置DHCP</h3><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler setting edit --name=manage_dhcp --value=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"># 修改cobbler的dhcp模块，不要直接修改dhcp本身的配置文件，因为cobbler会覆盖</span><br><span class=\"line\">[root@cobbler ~]# vim /etc/cobbler/dhcp.template</span><br><span class=\"line\">...</span><br><span class=\"line\">subnet <span class=\"number\">192.168</span><span class=\"number\">.2</span><span class=\"number\">.0</span> netmask <span class=\"number\">255.255</span><span class=\"number\">.255</span><span class=\"number\">.0</span> &#123; #这里改为分配的网段和掩码</span><br><span class=\"line\">     #option routers             <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.5</span>; #如果有网关，这里改为网关地址</span><br><span class=\"line\">     #option domain-name-servers <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.1</span>; #如果有DNS，这里改为DNS地址</span><br><span class=\"line\">     option subnet-mask         <span class=\"number\">255.255</span><span class=\"number\">.255</span><span class=\"number\">.0</span>; #改为分配的IP的掩码</span><br><span class=\"line\">     range dynamic-bootp        <span class=\"number\">192.168</span><span class=\"number\">.2</span><span class=\"number\">.100</span> <span class=\"number\">192.168</span><span class=\"number\">.2</span><span class=\"number\">.254</span>; #改为分配的IP的范围</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<h3 id=\"同步cobbler配置\"><a href=\"#同步cobbler配置\" class=\"headerlink\" title=\"同步cobbler配置\"></a>同步cobbler配置</h3><blockquote>\n<p>同步cobbler配置，它会根据配置自动修改dhcp等服务。</p>\n</blockquote>\n<figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cobbler rsync </span></span><br><span class=\"line\">No such <span class=\"symbol\">command:</span> rsync</span><br><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cobbler sync</span></span><br><span class=\"line\">task <span class=\"symbol\">started:</span> <span class=\"number\">2019</span>-<span class=\"number\">0</span>6-<span class=\"number\">12_15262</span>3_sync</span><br><span class=\"line\">task started (id=Sync, time=Wed Jun <span class=\"number\">12</span> <span class=\"number\">15</span>:<span class=\"number\">26</span>:<span class=\"number\">23</span> <span class=\"number\">2019</span>)</span><br><span class=\"line\">running pre-sync triggers</span><br><span class=\"line\">cleaning trees</span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/www/cobbler/images/centos6.<span class=\"number\">9</span>-x86_64</span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">pxelinux</span>.<span class=\"title\">cfg</span>/<span class=\"title\">default</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">images</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86</span>.<span class=\"title\">efi</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86_64</span>.<span class=\"title\">efi</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">efidefault</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">images</span>/<span class=\"title\">centos6</span>.9-<span class=\"title\">x86_64</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">s390x</span>/<span class=\"title\">profile_list</span></span></span><br><span class=\"line\">copying bootloaders</span><br><span class=\"line\">trying hardlink /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">loaders</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86</span>.<span class=\"title\">efi</span> -&gt; /<span class=\"title\">var</span>/<span class=\"title\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86</span>.<span class=\"title\">efi</span></span></span><br><span class=\"line\">trying hardlink /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">loaders</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86_64</span>.<span class=\"title\">efi</span> -&gt; /<span class=\"title\">var</span>/<span class=\"title\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86_64</span>.<span class=\"title\">efi</span></span></span><br><span class=\"line\">copying distros to tftpboot</span><br><span class=\"line\">copying files <span class=\"keyword\">for</span> <span class=\"symbol\">distro:</span> centos6.<span class=\"number\">9</span>-x86_64</span><br><span class=\"line\">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/vmlinuz -&gt; <span class=\"regexp\">/var/lib</span><span class=\"regexp\">/tftpboot/images</span><span class=\"regexp\">/centos6.9-x86_64/vmlinuz</span></span><br><span class=\"line\">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/initrd.img -&gt; <span class=\"regexp\">/var/lib</span><span class=\"regexp\">/tftpboot/images</span><span class=\"regexp\">/centos6.9-x86_64/initrd</span>.img</span><br><span class=\"line\">copying images</span><br><span class=\"line\">generating PXE configuration files</span><br><span class=\"line\">generating PXE menu structure</span><br><span class=\"line\">copying files <span class=\"keyword\">for</span> <span class=\"symbol\">distro:</span> centos6.<span class=\"number\">9</span>-x86_64</span><br><span class=\"line\">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/vmlinuz -&gt; <span class=\"regexp\">/var/www</span><span class=\"regexp\">/cobbler/images</span><span class=\"regexp\">/centos6.9-x86_64/vmlinuz</span></span><br><span class=\"line\">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/initrd.img -&gt; <span class=\"regexp\">/var/www</span><span class=\"regexp\">/cobbler/images</span><span class=\"regexp\">/centos6.9-x86_64/initrd</span>.img</span><br><span class=\"line\">Writing template files <span class=\"keyword\">for</span> centos6.<span class=\"number\">9</span>-x86_64</span><br><span class=\"line\">rendering DHCP files</span><br><span class=\"line\">generating /etc/dhcp/dhcpd.conf</span><br><span class=\"line\">rendering TFTPD files</span><br><span class=\"line\">generating /etc/xinetd.d/tftp</span><br><span class=\"line\">processing boot_files <span class=\"keyword\">for</span> <span class=\"symbol\">distro:</span> centos6.<span class=\"number\">9</span>-x86_64</span><br><span class=\"line\">cleaning link caches</span><br><span class=\"line\">running post-sync triggers</span><br><span class=\"line\">running python triggers from /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">triggers</span>/<span class=\"title\">sync</span>/<span class=\"title\">post</span>/*</span></span><br><span class=\"line\">running python trigger cobbler.modules.sync_post_restart_services</span><br><span class=\"line\"><span class=\"symbol\">running:</span> dhcpd -t -q</span><br><span class=\"line\">received on <span class=\"symbol\">stdout:</span> </span><br><span class=\"line\">received on <span class=\"symbol\">stderr:</span> </span><br><span class=\"line\"><span class=\"symbol\">running:</span> service dhcpd restart</span><br><span class=\"line\">received on <span class=\"symbol\">stdout:</span> </span><br><span class=\"line\">received on <span class=\"symbol\">stderr:</span> Redirecting to /bin/systemctl restart dhcpd.service</span><br><span class=\"line\"></span><br><span class=\"line\">running shell triggers from /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">triggers</span>/<span class=\"title\">sync</span>/<span class=\"title\">post</span>/*</span></span><br><span class=\"line\">running python triggers from /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">triggers</span>/<span class=\"title\">change</span>/*</span></span><br><span class=\"line\">running python trigger cobbler.modules.manage_genders</span><br><span class=\"line\">running python trigger cobbler.modules.scm_track</span><br><span class=\"line\">running shell triggers from /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">triggers</span>/<span class=\"title\">change</span>/*</span></span><br><span class=\"line\">*** TASK COMPLETE ***</span><br></pre></td></tr></table></figure>\n<p>这时候创建一个新虚拟机可以获取到如下信息，没有镜像选择，只能从本地启动<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler03.png\" alt></p>\n<h3 id=\"cobbler命令帮助\"><a href=\"#cobbler命令帮助\" class=\"headerlink\" title=\"cobbler命令帮助\"></a>cobbler命令帮助</h3><table>\n<thead>\n<tr>\n<th>命令</th>\n<th style=\"text-align:left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>cobbler check</td>\n<td style=\"text-align:left\">核对当前设置是否有问题</td>\n</tr>\n<tr>\n<td>cobbler list</td>\n<td style=\"text-align:left\">列出所有的cobbler元素</td>\n</tr>\n<tr>\n<td>cobbler report</td>\n<td style=\"text-align:left\">列出元素的详细信息</td>\n</tr>\n<tr>\n<td>cobbler sync</td>\n<td style=\"text-align:left\">同步配置到数据目录，更改配置最好都执行一下</td>\n</tr>\n<tr>\n<td>cobbler reposync</td>\n<td style=\"text-align:left\">同步yum仓库</td>\n</tr>\n<tr>\n<td>cobbler distro</td>\n<td style=\"text-align:left\">查看导入的发行版系统信息</td>\n</tr>\n<tr>\n<td>cobbler system</td>\n<td style=\"text-align:left\">查看添加的系统信息</td>\n</tr>\n<tr>\n<td>cobbler profile</td>\n<td style=\"text-align:left\">查看配置信息</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"cobbler配置安装centos6-x\"><a href=\"#cobbler配置安装centos6-x\" class=\"headerlink\" title=\"cobbler配置安装centos6.x\"></a>cobbler配置安装centos6.x</h2><blockquote>\n<p>由于我这里实在<code>centos7</code>系统上面配置的<code>cobbler</code>，所以上传了一个<code>centos6</code>的镜像并进行挂载。</p>\n</blockquote>\n<p>1）创建挂载点，并进行挂载<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># mkdir /centos6</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># mount -o loop CentOS-6.9-x86_64-bin-DVD1.iso /centos6</span></span><br></pre></td></tr></table></figure></p>\n<p>2）查看挂载后的目录<br><figure class=\"highlight vbnet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"meta\"># ls /centos6/</span></span><br><span class=\"line\">CentOS_BuildTag  images                    repodata                       RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS-Testing<span class=\"number\">-6</span></span><br><span class=\"line\">EFI              isolinux                  RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS<span class=\"number\">-6</span>           TRANS.TBL</span><br><span class=\"line\">EULA             Packages                  RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS-Debug<span class=\"number\">-6</span></span><br><span class=\"line\">GPL              RELEASE-NOTES-en-US.html  RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS-Security<span class=\"number\">-6</span></span><br></pre></td></tr></table></figure></p>\n<p>3）导入镜像<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler import <span class=\"attribute\">--path</span>=/centos6 <span class=\"attribute\">--name</span>=centos6.9 <span class=\"attribute\">--arch</span>=x86_64</span><br><span class=\"line\"><span class=\"comment\"># --path 镜像路径</span></span><br><span class=\"line\"><span class=\"comment\"># --name 为安装源定义一个名字</span></span><br><span class=\"line\"><span class=\"comment\"># --arch 指定安装源是32位、64位、ia64, 目前支持的选项有: x86│x86_64│ia64</span></span><br><span class=\"line\"><span class=\"comment\"># 安装源的唯一标示就是根据name参数来定义，本例导入成功后，安装源的唯一标示就是：centos6.9，如果重复，系统会提示导入失败。</span></span><br></pre></td></tr></table></figure></p>\n<p>4）查看导入后镜像信息<br><figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler distro report <span class=\"comment\">--name=centos6.9-x86_64</span></span><br><span class=\"line\">Name                           : <span class=\"type\">centos6.9</span>-x86_64</span><br><span class=\"line\">Architecture                   : <span class=\"type\">x86_64</span></span><br><span class=\"line\">TFTP Boot Files                : &#123;&#125;</span><br><span class=\"line\">Breed                          : <span class=\"type\">redhat</span></span><br><span class=\"line\">Comment                        : </span><br><span class=\"line\">Fetchable Files                : &#123;&#125;</span><br><span class=\"line\">Initrd                         : /<span class=\"type\">var</span>/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/initrd.img</span><br><span class=\"line\">Kernel                         : /<span class=\"type\">var</span>/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/vmlinuz</span><br><span class=\"line\">Kernel Options                 : &#123;&#125;</span><br><span class=\"line\">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class=\"line\">Kickstart Metadata             : &#123;'<span class=\"type\">tree</span>': <span class=\"symbol\">'http</span>://@@http_server@@/cblr/links/centos6.<span class=\"number\">9</span>-x86_64'&#125;</span><br><span class=\"line\">Management Classes             : []</span><br><span class=\"line\">OS Version                     : <span class=\"type\">rhel6</span></span><br><span class=\"line\">Owners                         : ['<span class=\"type\">admin</span>']</span><br><span class=\"line\">Red Hat Management Key         : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Red Hat Management Server      : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Template Files                 : &#123;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>5）查看<code>profile</code>信息<br><figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler profile report <span class=\"comment\">--name=centos6.9-x86_64</span></span><br><span class=\"line\">Name                           : <span class=\"type\">centos6.9</span>-x86_64</span><br><span class=\"line\">TFTP Boot Files                : &#123;&#125;</span><br><span class=\"line\">Comment                        : </span><br><span class=\"line\">DHCP Tag                       : <span class=\"type\">default</span></span><br><span class=\"line\">Distribution                   : <span class=\"type\">centos6.9</span>-x86_64</span><br><span class=\"line\">Enable gPXE?                   : 0</span><br><span class=\"line\">Enable PXE Menu?               : 1</span><br><span class=\"line\">Fetchable Files                : &#123;&#125;</span><br><span class=\"line\">Kernel Options                 : &#123;&#125;</span><br><span class=\"line\">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class=\"line\">Kickstart                      : /<span class=\"type\">var</span>/lib/cobbler/kickstarts/sample_end.ks</span><br><span class=\"line\">Kickstart Metadata             : &#123;&#125;</span><br><span class=\"line\">Management Classes             : []</span><br><span class=\"line\">Management Parameters          : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Name Servers                   : []</span><br><span class=\"line\">Name Servers Search Path       : []</span><br><span class=\"line\">Owners                         : ['<span class=\"type\">admin</span>']</span><br><span class=\"line\">Parent Profile                 : </span><br><span class=\"line\">Internal proxy                 : </span><br><span class=\"line\">Red Hat Management Key         : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Red Hat Management Server      : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Repos                          : []</span><br><span class=\"line\">Server Override                : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Template Files                 : &#123;&#125;</span><br><span class=\"line\">Virt Auto Boot                 : 1</span><br><span class=\"line\">Virt Bridge                    : <span class=\"type\">xenbr0</span></span><br><span class=\"line\">Virt CPUs                      : 1</span><br><span class=\"line\">Virt Disk Driver <span class=\"keyword\">Type</span>          <span class=\"type\">: </span>raw</span><br><span class=\"line\">Virt File Size(GB)             : 5</span><br><span class=\"line\">Virt Path                      : </span><br><span class=\"line\">Virt RAM (MB)                  : 512</span><br><span class=\"line\">Virt <span class=\"keyword\">Type</span>                      <span class=\"type\">: </span>kvm</span><br></pre></td></tr></table></figure></p>\n<p>6）<code>copy</code>一份<code>profile</code>文件(<code>ks</code>)，进行修改<br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cd /var/lib/cobbler/kickstarts/</span></span><br><span class=\"line\">[root@cobbler kickstarts]<span class=\"comment\"># ls</span></span><br><span class=\"line\">default.ks    install_profiles  sample_autoyast.xml  sample_esxi4.ks  sample.ks</span><br><span class=\"line\">esxi4-ks.cfg  legacy.ks         sample_end.ks        sample_esxi5.ks  sample_old.seed</span><br><span class=\"line\">esxi5-ks.cfg  pxerescue.ks      sample_esx4.ks       sample_esxi6.ks  sample.seed</span><br><span class=\"line\">[root@cobbler kickstarts]<span class=\"comment\"># cp sample_end.ks centos6.ks</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑centos6的kickstart文件</span></span><br><span class=\"line\">[root@cobbler kickstarts]<span class=\"comment\"># vim centos6.ks </span></span><br><span class=\"line\"><span class=\"comment\"># This kickstart file should only be used with EL &gt; 5 and/or Fedora &gt; 7.</span></span><br><span class=\"line\"><span class=\"comment\"># For older versions please use the sample.ks kickstart file.</span></span><br><span class=\"line\"><span class=\"comment\"># Install OS instead of upgrade</span></span><br><span class=\"line\">install</span><br><span class=\"line\"><span class=\"comment\"># Use text mode install</span></span><br><span class=\"line\">text</span><br><span class=\"line\"><span class=\"comment\"># System keyboard</span></span><br><span class=\"line\">keyboard us</span><br><span class=\"line\"><span class=\"comment\"># System language</span></span><br><span class=\"line\">lang en_US</span><br><span class=\"line\"><span class=\"comment\"># System timezone</span></span><br><span class=\"line\">timezone  Asia/ShangHai</span><br><span class=\"line\"><span class=\"comment\">#Root password</span></span><br><span class=\"line\">rootpw --iscrypted $default_password_crypted</span><br><span class=\"line\"><span class=\"comment\"># System authorization information</span></span><br><span class=\"line\">auth  --useshadow  --enablemd5</span><br><span class=\"line\"><span class=\"comment\"># Firewall configuration</span></span><br><span class=\"line\">firewall --disabled</span><br><span class=\"line\"><span class=\"comment\"># SELinux configuration</span></span><br><span class=\"line\">selinux --disabled</span><br><span class=\"line\"><span class=\"comment\"># Use network installation</span></span><br><span class=\"line\">url --url=$tree</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Clear the Master Boot Record</span></span><br><span class=\"line\">zerombr</span><br><span class=\"line\"><span class=\"comment\"># System bootloader configuration</span></span><br><span class=\"line\">bootloader --location=mbr</span><br><span class=\"line\"><span class=\"comment\"># Partition clearing information</span></span><br><span class=\"line\">clearpart --all --initlabel</span><br><span class=\"line\">part /boot --fstype=ext4 --size=<span class=\"number\">500</span></span><br><span class=\"line\">part swap --fstype=swap --size=<span class=\"number\">2048</span></span><br><span class=\"line\">part / --fstype=ext4 --grow --size=<span class=\"number\">200</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If any cobbler repo definitions were referenced in the kickstart profile, include them here.</span></span><br><span class=\"line\">$yum_repo_stanza</span><br><span class=\"line\"><span class=\"comment\"># Network information</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'network_config'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Do not configure the X Window System</span></span><br><span class=\"line\">skipx</span><br><span class=\"line\"><span class=\"comment\"># Run the Setup Agent on first boot</span></span><br><span class=\"line\">firstboot --disable</span><br><span class=\"line\"><span class=\"comment\"># Reboot after installation</span></span><br><span class=\"line\">reboot</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">%pre</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_pre'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'kickstart_start'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'pre_install_network_config'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Enable installation monitoring</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'pre_anamon'</span>)</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%packages</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'func_install_if_enabled'</span>)</span><br><span class=\"line\">@core</span><br><span class=\"line\">@base</span><br><span class=\"line\">tree</span><br><span class=\"line\">nmap</span><br><span class=\"line\">wget</span><br><span class=\"line\">lftp</span><br><span class=\"line\">lrzsz</span><br><span class=\"line\">telnet</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%post --nochroot</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_post_nochroot'</span>)</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%post</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_post'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Start yum configuration</span></span><br><span class=\"line\">$yum_config_stanza</span><br><span class=\"line\"><span class=\"comment\"># End yum configuration</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_install_kernel_options'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_install_network_config'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'func_register_if_enabled'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'download_config_files'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'koan_environment'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'redhat_register'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'cobbler_register'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Enable post-install boot notification</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_anamon'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Start final steps</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'kickstart_done'</span>)</span><br><span class=\"line\"><span class=\"comment\"># End final steps</span></span><br><span class=\"line\"></span><br><span class=\"line\">sed -ri <span class=\"string\">\"/^#UseDNS/c\\UseDNS no\"</span> /etc/ssh/sshd_config</span><br><span class=\"line\">sed -ri <span class=\"string\">\"/^GSSAPIAuthentication/c\\GSSAPIAuthentication no\"</span> /etc/ssh/sshd_config</span><br><span class=\"line\">%end</span><br></pre></td></tr></table></figure></p>\n<p>7）编辑<code>centos6</code>镜像所使用的<code>kickstart</code>文件<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 动态编辑指定使用新的kickstart文件</span></span><br><span class=\"line\">[root@cobbler ~]# cobbler<span class=\"built_in\"> profile </span><span class=\"builtin-name\">edit</span> <span class=\"attribute\">--name</span>=centos6.9-x86_64 <span class=\"attribute\">--kickstart</span>=/var/lib/cobbler/kickstarts/centos6.ks</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证是否更改成功</span></span><br><span class=\"line\">[root@cobbler ~]# cobbler<span class=\"built_in\"> profile </span>report <span class=\"attribute\">--name</span>=centos6.9-x86_64 |grep Kickstart</span><br><span class=\"line\">Kickstart                      : /var/lib/cobbler/kickstarts/centos6.ks</span><br></pre></td></tr></table></figure></p>\n<p>8）再次同步<code>cobbler</code>配置<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler sync</span></span><br></pre></td></tr></table></figure></p>\n<p>9）新建虚拟机进行测试<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler04.png\" alt><br>选择<code>centos6.9</code>进行安装，会按照<code>kickstart</code>文件安装并启动<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler05.png\" alt></p>\n<h2 id=\"cobbler配置安装centos7-x\"><a href=\"#cobbler配置安装centos7-x\" class=\"headerlink\" title=\"cobbler配置安装centos7.x\"></a>cobbler配置安装centos7.x</h2><blockquote>\n<p>我这里cobbler服务器就是7的系统，所以直接挂载/dev/cdrom即可</p>\n</blockquote>\n<p>1）创建挂载点，并进行挂载<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># mkdir /centos7</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># mount -o loop /dev/cdrom /centos7</span></span><br></pre></td></tr></table></figure></p>\n<p>2）查看挂载后的目录<br><figure class=\"highlight vbnet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"meta\"># ls /centos7/</span></span><br><span class=\"line\">CentOS_BuildTag  EULA  images    LiveOS    repodata              RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS-Testing<span class=\"number\">-7</span></span><br><span class=\"line\">EFI              GPL   isolinux  Packages  RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS<span class=\"number\">-7</span>  TRANS.TBL</span><br></pre></td></tr></table></figure></p>\n<p>3）导入镜像<br><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@cobbler</span> ~]<span class=\"comment\"># cobbler import --path=/centos7 --name=centos7.4 --arch=x86_64</span></span><br><span class=\"line\">task <span class=\"symbol\">started:</span> <span class=\"number\">2019</span>-<span class=\"number\">06</span>-<span class=\"number\">12_165812_</span><span class=\"keyword\">import</span></span><br><span class=\"line\">task started (id=Media <span class=\"keyword\">import</span>, time=Wed Jun <span class=\"number\">12</span> <span class=\"number\">16</span><span class=\"symbol\">:</span><span class=\"number\">58</span><span class=\"symbol\">:</span><span class=\"number\">12</span> <span class=\"number\">2019</span>)</span><br><span class=\"line\">Found a candidate <span class=\"symbol\">signature:</span> breed=redhat, version=rhel6</span><br><span class=\"line\">Found a candidate <span class=\"symbol\">signature:</span> breed=redhat, version=rhel7</span><br><span class=\"line\">Found a matching <span class=\"symbol\">signature:</span> breed=redhat, version=rhel7</span><br><span class=\"line\">Adding distros from path /var/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-<span class=\"symbol\">x86_64:</span></span><br><span class=\"line\">creating new <span class=\"symbol\">distro:</span> centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">trying <span class=\"symbol\">symlink:</span> /var/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64 -&gt; /var/www/cobbler/links/centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">creating new <span class=\"symbol\">profile:</span> centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">associating repos</span><br><span class=\"line\">checking <span class=\"keyword\">for</span> rsync repo(s)</span><br><span class=\"line\">checking <span class=\"keyword\">for</span> rhn repo(s)</span><br><span class=\"line\">checking <span class=\"keyword\">for</span> yum repo(s)</span><br><span class=\"line\">starting descent into /var/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64 <span class=\"keyword\">for</span> centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">processing repo at : <span class=\"regexp\">/var/www</span><span class=\"regexp\">/cobbler/ks</span>_mirror/centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">need to process repo/<span class=\"symbol\">comps:</span> /var/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">looking <span class=\"keyword\">for</span> /var/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64/repodata/*comps*.xml</span><br><span class=\"line\">Keeping repodata as-is <span class=\"symbol\">:/var/www/cobbler/ks_mirror/centos7</span>.<span class=\"number\">4</span>-x86_64/repodata</span><br><span class=\"line\">*** TASK COMPLETE ***</span><br></pre></td></tr></table></figure></p>\n<p>4）查看导入后镜像信息<br><figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler distro report <span class=\"comment\">--name=centos7.4-x86_64</span></span><br><span class=\"line\">Name                           : <span class=\"type\">centos7.4</span>-x86_64</span><br><span class=\"line\">Architecture                   : <span class=\"type\">x86_64</span></span><br><span class=\"line\">TFTP Boot Files                : &#123;&#125;</span><br><span class=\"line\">Breed                          : <span class=\"type\">redhat</span></span><br><span class=\"line\">Comment                        : </span><br><span class=\"line\">Fetchable Files                : &#123;&#125;</span><br><span class=\"line\">Initrd                         : /<span class=\"type\">var</span>/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64/images/pxeboot/initrd.img</span><br><span class=\"line\">Kernel                         : /<span class=\"type\">var</span>/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64/images/pxeboot/vmlinuz</span><br><span class=\"line\">Kernel Options                 : &#123;&#125;</span><br><span class=\"line\">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class=\"line\">Kickstart Metadata             : &#123;'<span class=\"type\">tree</span>': <span class=\"symbol\">'http</span>://@@http_server@@/cblr/links/centos7.<span class=\"number\">4</span>-x86_64'&#125;</span><br><span class=\"line\">Management Classes             : []</span><br><span class=\"line\">OS Version                     : <span class=\"type\">rhel7</span></span><br><span class=\"line\">Owners                         : ['<span class=\"type\">admin</span>']</span><br><span class=\"line\">Red Hat Management Key         : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Red Hat Management Server      : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Template Files                 : &#123;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>5）查看<code>profile</code>信息<br><figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler profile report <span class=\"comment\">--name=centos7.4-x86_64</span></span><br><span class=\"line\">Name                           : <span class=\"type\">centos7.4</span>-x86_64</span><br><span class=\"line\">TFTP Boot Files                : &#123;&#125;</span><br><span class=\"line\">Comment                        : </span><br><span class=\"line\">DHCP Tag                       : <span class=\"type\">default</span></span><br><span class=\"line\">Distribution                   : <span class=\"type\">centos7.4</span>-x86_64</span><br><span class=\"line\">Enable gPXE?                   : 0</span><br><span class=\"line\">Enable PXE Menu?               : 1</span><br><span class=\"line\">Fetchable Files                : &#123;&#125;</span><br><span class=\"line\">Kernel Options                 : &#123;&#125;</span><br><span class=\"line\">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class=\"line\">Kickstart                      : /<span class=\"type\">var</span>/lib/cobbler/kickstarts/sample_end.ks</span><br><span class=\"line\">Kickstart Metadata             : &#123;&#125;</span><br><span class=\"line\">Management Classes             : []</span><br><span class=\"line\">Management Parameters          : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Name Servers                   : []</span><br><span class=\"line\">Name Servers Search Path       : []</span><br><span class=\"line\">Owners                         : ['<span class=\"type\">admin</span>']</span><br><span class=\"line\">Parent Profile                 : </span><br><span class=\"line\">Internal proxy                 : </span><br><span class=\"line\">Red Hat Management Key         : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Red Hat Management Server      : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Repos                          : []</span><br><span class=\"line\">Server Override                : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Template Files                 : &#123;&#125;</span><br><span class=\"line\">Virt Auto Boot                 : 1</span><br><span class=\"line\">Virt Bridge                    : <span class=\"type\">xenbr0</span></span><br><span class=\"line\">Virt CPUs                      : 1</span><br><span class=\"line\">Virt Disk Driver <span class=\"keyword\">Type</span>          <span class=\"type\">: </span>raw</span><br><span class=\"line\">Virt File Size(GB)             : 5</span><br><span class=\"line\">Virt Path                      : </span><br><span class=\"line\">Virt RAM (MB)                  : 512</span><br><span class=\"line\">Virt <span class=\"keyword\">Type</span>                      <span class=\"type\">: </span>kvm</span><br></pre></td></tr></table></figure></p>\n<p>7）<code>copy</code>一份<code>profile</code>文件( <code>ks</code> )，进行修改,这里直接copy上面6的了，然后修改修改即可<br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cd /var/lib/cobbler/kickstarts/</span></span><br><span class=\"line\">[root@cobbler kickstarts]<span class=\"comment\"># cp centos6.ks centos7.ks</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑centos7的kickstart文件</span></span><br><span class=\"line\">[root@cobbler kickstarts]<span class=\"comment\"># vim centos7.ks</span></span><br><span class=\"line\"><span class=\"comment\"># This kickstart file should only be used with EL &gt; 5 and/or Fedora &gt; 7.</span></span><br><span class=\"line\"><span class=\"comment\"># For older versions please use the sample.ks kickstart file.</span></span><br><span class=\"line\"><span class=\"comment\"># Install OS instead of upgrade</span></span><br><span class=\"line\">install</span><br><span class=\"line\"><span class=\"comment\"># Use text mode install</span></span><br><span class=\"line\">text</span><br><span class=\"line\"><span class=\"comment\"># System keyboard</span></span><br><span class=\"line\">keyboard us</span><br><span class=\"line\"><span class=\"comment\"># System language</span></span><br><span class=\"line\">lang en_US</span><br><span class=\"line\"><span class=\"comment\"># System timezone</span></span><br><span class=\"line\">timezone  Asia/ShangHai</span><br><span class=\"line\"><span class=\"comment\">#Root password</span></span><br><span class=\"line\">rootpw --iscrypted $default_password_crypted</span><br><span class=\"line\"><span class=\"comment\"># System authorization information</span></span><br><span class=\"line\">auth  --useshadow  --enablemd5</span><br><span class=\"line\"><span class=\"comment\"># Firewall configuration</span></span><br><span class=\"line\">firewall --disabled</span><br><span class=\"line\"><span class=\"comment\"># SELinux configuration</span></span><br><span class=\"line\">selinux --disabled</span><br><span class=\"line\"><span class=\"comment\"># Use network installation</span></span><br><span class=\"line\">url --url=$tree</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Clear the Master Boot Record</span></span><br><span class=\"line\">zerombr</span><br><span class=\"line\"><span class=\"comment\"># System bootloader configuration</span></span><br><span class=\"line\">bootloader --location=mbr</span><br><span class=\"line\"><span class=\"comment\"># Partition clearing information</span></span><br><span class=\"line\">clearpart --all --initlabel</span><br><span class=\"line\">part /boot --fstype=xfs --size=<span class=\"number\">500</span></span><br><span class=\"line\">part swap --fstype=swap --size=<span class=\"number\">2048</span></span><br><span class=\"line\">part / --fstype=xfs --grow --size=<span class=\"number\">200</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If any cobbler repo definitions were referenced in the kickstart profile, include them here.</span></span><br><span class=\"line\">$yum_repo_stanza</span><br><span class=\"line\"><span class=\"comment\"># Network information</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'network_config'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Do not configure the X Window System</span></span><br><span class=\"line\">skipx</span><br><span class=\"line\"><span class=\"comment\"># Run the Setup Agent on first boot</span></span><br><span class=\"line\">firstboot --disable</span><br><span class=\"line\"><span class=\"comment\"># Reboot after installation</span></span><br><span class=\"line\">reboot</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">%pre</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_pre'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'kickstart_start'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'pre_install_network_config'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Enable installation monitoring</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'pre_anamon'</span>)</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%packages</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'func_install_if_enabled'</span>)</span><br><span class=\"line\">@core</span><br><span class=\"line\">@base</span><br><span class=\"line\">tree</span><br><span class=\"line\">nmap</span><br><span class=\"line\">wget</span><br><span class=\"line\">lftp</span><br><span class=\"line\">lrzsz</span><br><span class=\"line\">telnet</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%post --nochroot</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_post_nochroot'</span>)</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%post</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_post'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Start yum configuration</span></span><br><span class=\"line\">$yum_config_stanza</span><br><span class=\"line\"><span class=\"comment\"># End yum configuration</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_install_kernel_options'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_install_network_config'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'func_register_if_enabled'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'download_config_files'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'koan_environment'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'redhat_register'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'cobbler_register'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Enable post-install boot notification</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_anamon'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Start final steps</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'kickstart_done'</span>)</span><br><span class=\"line\"><span class=\"comment\"># End final steps</span></span><br><span class=\"line\"></span><br><span class=\"line\">sed -ri <span class=\"string\">\"/^#UseDNS/c\\UseDNS no\"</span> /etc/ssh/sshd_config</span><br><span class=\"line\">sed -ri <span class=\"string\">\"/^GSSAPIAuthentication/c\\GSSAPIAuthentication no\"</span> /etc/ssh/sshd_config</span><br><span class=\"line\">%end</span><br></pre></td></tr></table></figure></p>\n<p>7）编辑<code>centos7</code>镜像所使用的<code>kickstart</code>文件<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 动态编辑指定使用新的kickstart文件</span></span><br><span class=\"line\">[root@cobbler ~]# cobbler<span class=\"built_in\"> profile </span><span class=\"builtin-name\">edit</span> <span class=\"attribute\">--name</span>=centos7.4-x86_64 <span class=\"attribute\">--kickstart</span>=/var/lib/cobbler/kickstarts/centos7.ks</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证是否更改成功</span></span><br><span class=\"line\">[root@cobbler ~]# cobbler<span class=\"built_in\"> profile </span>report <span class=\"attribute\">--name</span>=centos7.4-x86_64 |grep Kickstart</span><br><span class=\"line\">Kickstart                      : /var/lib/cobbler/kickstarts/centos7.ks</span><br></pre></td></tr></table></figure></p>\n<p>8）再次同步<code>cobbler</code>配置<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler sync</span></span><br></pre></td></tr></table></figure></p>\n<p>9）新建虚拟机进行测试<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler06.png\" alt><br>选择<code>centos7.4</code>进行安装即可<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler07.png\" alt></p>\n<blockquote>\n<p>说明：在<code>client</code>端系统安装时，可以在<code>cobbler</code>服务端上查看日志<code>/var/log/messages</code>，观察安装的每一个<code>cobbler</code>流程</p>\n</blockquote>\n<h2 id=\"cobbler-Web管理界面配置\"><a href=\"#cobbler-Web管理界面配置\" class=\"headerlink\" title=\"cobbler Web管理界面配置\"></a>cobbler Web管理界面配置</h2><blockquote>\n<p><code>web</code>界面有很多功能，包括上传镜像、编辑<code>kickstart</code>、等等很多在命令行操作的都可以在<code>web</code>界面直接操作。<br>在上面已经安装了<code>cobbler-web</code>软件，访问地址：<a href=\"https://IP/cobbler_web\" target=\"_blank\" rel=\"noopener\">https://IP/cobbler_web</a> 即可。默认账号为<code>cobbler</code>，密码也为<code>cobbler</code></p>\n</blockquote>\n<p><img src=\"/2019/06/12/Cobbler自动化部署/cobbler08.png\" alt></p>\n<p><strong>修改密码</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/cobbler/users.conf     <span class=\"meta\">#Web服务授权配置文件</span></span><br><span class=\"line\">/etc/cobbler/users.digest   <span class=\"meta\">#用于web访问的用户名密码</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cat /etc/cobbler/users.digest </span></span><br><span class=\"line\">cobbler:Cobbler:a2d6bae81669d707b72c0bd9806e01f3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 设置密码，在Cobbler组添加cobbler用户，输入2遍密码确</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># htdigest /etc/cobbler/users.digest <span class=\"string\">\"Cobbler\"</span> cobbler</span></span><br><span class=\"line\">Changing password <span class=\"keyword\">for</span> user cobbler <span class=\"keyword\">in</span> realm Cobbler</span><br><span class=\"line\">New password: superman</span><br><span class=\"line\">Re-type new password: superman</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 同步配置并重启httpd、cobbler</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler sync</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl restart httpd</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl restart cobblerd</span></span><br></pre></td></tr></table></figure></p>\n<p>再次登录即使用新设置的密码登录即可。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"cobbler简介\"><a href=\"#cobbler简介\" class=\"headerlink\" title=\"cobbler简介\"></a>cobbler简介</h2><blockquote>\n<p><code>Cobbler</code> 可以用来快速建立 <code>Linux</code> 网络安装环境，它已将<code>Linux</code>网络安装的技术门槛，从大专以上文化水平，成功降低到了初中水平，连补鞋匠都能学会。<br>网络安装服务器套件<code>Cobbler</code>（补鞋匠）从前，我们一直在装机民工这份很有前途的职业。自打若干年前<code>Red Hat</code>推出了 <code>Kickstart</code>，此后我们顿觉身价增倍。不再需要刻了光盘一台一台的安装<code>Linux</code>，只要搞定<code>PXE</code>、<code>DHCP</code>、<code>TFTP</code>，还有那满屏眼花缭乱不知所云的<code>Kickstart</code>脚本，我们就可以像哈利波特一样，轻点魔棒，瞬间安装上百台服务器。这一堆花里胡哨的东西可不是一般人能够整明白的，没有大专以上的学历，通不过英语四级，根本别想玩转。总而言之，这是一份多么有前途，多么有技术含量的工作啊。很不幸，<code>Red Ha</code>t 最新（<code>Cobbler</code>项目最初在<code>2008</code>年左右发布）发布了网络安装服务器套件<code>Cobbler</code>（补鞋匠），它已将<code>Linux</code>网络安装的技术门槛，从大专以上文化水平，成功降低到初中以下水平，连补鞋匠都能学会。</p>\n</blockquote>\n<blockquote>\n<p>1、<code>Cobbler</code>是一个<code>Linux</code>服务器安装的服务，可以通过网络启动（<code>PXE</code>）的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理<code>DHCP</code>，<code>DNS</code>等。<br>2、<code>Cobbler</code>可以使用命令行方式管理，也提供了基于Web的界面管理工具（<code>cobbler-web</code>），还提供了<code>API</code>接口，可以方便二次开发使用。<br>3、<code>Cobbler</code>是较早前的<code>kickstart</code>的升级版，优点是比较容易配置，还自带web界面比较易于管理。<br>4、<code>Cobbler</code>内置了一个轻量级配置管理系统，但它也支持和其它配置管理系统集成，如<code>Puppet</code>。</p>\n</blockquote>\n<p><strong>参考网站</strong></p>\n<p><a href=\"http://cobbler.github.io/\" target=\"_blank\" rel=\"noopener\">cobbler官网</a></p>\n<p><a href=\"https://www.linuxidc.com/Linux/2017-08/146168.htm\" target=\"_blank\" rel=\"noopener\">Kickstart文件编写参考</a></p>\n<h2 id=\"cobbler对应关系\"><a href=\"#cobbler对应关系\" class=\"headerlink\" title=\"cobbler对应关系\"></a>cobbler对应关系</h2><p><img src=\"/2019/06/12/Cobbler自动化部署/cobbler01.png\" alt></p>\n<blockquote>\n<p><code>Cobbler</code>的配置结构基于一组注册的对象。每个对象表示一个与另一个实体相关联的实体。当一个对象指向另一个对象时，它就继承了被指向对象的数据，并可覆盖或添加更多特定信息。</p>\n<ul>\n<li>发行版(<code>distros</code>)： 表示一个操作系统。它承载了内核和<code>initrd</code>的信息，以及内核参数等其他数据。</li>\n<li>配置文件(<code>profiles</code>)：包含一个发行版、一个<code>kickstart</code>文件以及可能的存储库，还包括更多特定的内核参数等其他数据。</li>\n<li>系统(<code>systems</code>)：表示要配给的机器。它包括一个配置文件或一个镜像、<code>IP</code>和<code>MAC</code>地址、电源管理（地址、凭据、类型）以及更为专业的数据等信息。</li>\n<li>镜像(<code>images</code>)：可以替换一个保函不屑于此类别的文件的发行版对象（例如，无法分为内核和<code>initrd</code>的对象）。</li>\n</ul>\n</blockquote>\n<h2 id=\"cobbler集成的服务\"><a href=\"#cobbler集成的服务\" class=\"headerlink\" title=\"cobbler集成的服务\"></a>cobbler集成的服务</h2><ul>\n<li>PXE服务支持</li>\n<li>DHCP服务管理</li>\n<li>DNS服务管理</li>\n<li>电源管理</li>\n<li>Kickstart服务支持</li>\n<li>YUM仓库管理</li>\n<li>TFTP</li>\n<li>Apache</li>\n</ul>\n<h2 id=\"cobbler工作原理\"><a href=\"#cobbler工作原理\" class=\"headerlink\" title=\"cobbler工作原理\"></a>cobbler工作原理</h2><p><img src=\"/2019/06/12/Cobbler自动化部署/cobbler09.png\" alt></p>\n<p><strong>Server端</strong></p>\n<ul>\n<li>启动<code>Cobbler</code>服务</li>\n<li>进行<code>Cobbler</code>错误检查，执行<code>cobbler check</code>命令</li>\n<li>进行配置同步，执行<code>cobbler syn</code>c命令</li>\n<li>复制相关启动文件到<code>TFTP</code>目录中</li>\n<li>启动<code>DHCP</code>服务，提供地址分配</li>\n<li><code>DHCP</code>服务分配IP地址</li>\n<li><code>TFTP</code>传输启动文件</li>\n<li><code>Server</code>端接收安装信息</li>\n<li><code>Server</code>端发送<code>ISO</code>镜像与<code>Kickstart</code>文件</li>\n</ul>\n<p><strong>Client端</strong></p>\n<ul>\n<li>客户端以<code>PXE</code>模式启动</li>\n<li>客户端获取<code>IP</code>地址</li>\n<li>通过<code>TFTP</code>服务器获取启动文件</li>\n<li>进入<code>Cobbler</code>安装选择界面</li>\n<li>根据配置信息准备安装系统</li>\n<li>加载<code>Kickstart</code>文件</li>\n<li>传输系统安装的其它文件</li>\n<li>进行安装系统</li>\n</ul>\n<h2 id=\"cobbler安装\"><a href=\"#cobbler安装\" class=\"headerlink\" title=\"cobbler安装\"></a>cobbler安装</h2><blockquote>\n<p>说明：虚拟机网卡采用NAT模式，不要使用桥接模式，因为后面会搭建DHCP服务器，在同一个局域网多个DHCP服务会有冲突。<br>VMware的NAT模式的dhcp服务也关闭，避免干扰。<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler02.png\" alt></p>\n</blockquote>\n<h3 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h3><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 关闭防火墙、selinux等</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl stop firewalld</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl disable firewalld</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># setenforce 0</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># sed -i <span class=\"string\">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/sysconfig/selinux</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"安装cobbler\"><a href=\"#安装cobbler\" class=\"headerlink\" title=\"安装cobbler\"></a>安装cobbler</h3><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 配置epel源</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># yum -y install epel-release</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 安装cobbler及dhcp httpd xinetd cobbler-web</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># yum -y install cobbler cobbler-web tftp-server dhcp httpd xinetd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 启动cobbler及httpd并加入开机启动</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl start httpd cobblerd</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl enable httpd cobblerd</span></span><br></pre></td></tr></table></figure>\n<p>查看安装后相关文件<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"meta\"># rpm -ql cobbler</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler                  <span class=\"meta\"># 配置文件目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/settings         <span class=\"meta\"># cobbler主配置文件，这个文件是YAML格式，Cobbler是python写的程序。</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/dhcp.template    <span class=\"meta\"># DHCP服务的配置模板</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/tftpd.template   <span class=\"meta\"># tftp服务的配置模板</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/rsync.template   <span class=\"meta\"># rsync服务的配置模板</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/iso              <span class=\"meta\"># iso模板配置文件目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/pxe              <span class=\"meta\"># pxe模板文件目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/power            <span class=\"meta\"># 电源的配置文件目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/users.conf       <span class=\"meta\"># Web服务授权配置文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/users.digest     <span class=\"meta\"># 用于web访问的用户名密码配置文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/dnsmasq.template <span class=\"meta\"># DNS服务的配置模板</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>cobbler/modules.conf     <span class=\"meta\"># Cobbler模块配置文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>lib/cobbler              <span class=\"meta\"># Cobbler数据目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>lib<span class=\"meta-keyword\">/cobbler/</span>config       <span class=\"meta\"># 配置文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>lib<span class=\"meta-keyword\">/cobbler/</span>kickstarts   <span class=\"meta\"># 默认存放kickstart文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>lib<span class=\"meta-keyword\">/cobbler/</span>loaders      <span class=\"meta\"># 存放的各种引导程序</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>www/cobbler              <span class=\"meta\"># 系统安装镜像目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>www<span class=\"meta-keyword\">/cobbler/</span>ks_mirror    <span class=\"meta\"># 导入的系统镜像列表</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>www<span class=\"meta-keyword\">/cobbler/</span>images       <span class=\"meta\"># 导入的系统镜像启动文件</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>www<span class=\"meta-keyword\">/cobbler/</span>repo_mirror  <span class=\"meta\"># yum源存储目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>log/cobbler              <span class=\"meta\"># 日志目录</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>log<span class=\"meta-keyword\">/cobbler/</span>install.log  <span class=\"meta\"># 客户端系统安装日志</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/var/</span>log<span class=\"meta-keyword\">/cobbler/</span>cobbler.log  <span class=\"meta\"># cobbler日志</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"配置cobbler\"><a href=\"#配置cobbler\" class=\"headerlink\" title=\"配置cobbler\"></a>配置cobbler</h3><blockquote>\n<p>检查<code>Cobbler</code>的配置，如果看不到下面的结果，再次重启<code>cobbler</code></p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cobbler check</span></span><br><span class=\"line\">The following are potential configuration items that you may want to fix:</span><br><span class=\"line\"></span><br><span class=\"line\">1 : The 'server' field in /etc/cobbler/settings must be <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> something other <span class=\"keyword\">than</span> localhost, <span class=\"keyword\">or</span> kickstarting features will <span class=\"keyword\">not</span> work.  This should be a resolvable hostname <span class=\"keyword\">or</span> IP <span class=\"keyword\">for</span> the boot <span class=\"keyword\">server</span> <span class=\"keyword\">as</span> reachable <span class=\"keyword\">by</span> <span class=\"keyword\">all</span> machines that will <span class=\"keyword\">use</span> it.</span><br><span class=\"line\"><span class=\"number\">2</span> : <span class=\"keyword\">For</span> PXE <span class=\"keyword\">to</span> be functional, the <span class=\"string\">'next_server'</span> <span class=\"keyword\">field</span> <span class=\"keyword\">in</span> /etc/cobbler/<span class=\"keyword\">settings</span> must be <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> something other <span class=\"keyword\">than</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>, <span class=\"keyword\">and</span> should <span class=\"keyword\">match</span> the IP <span class=\"keyword\">of</span> the boot <span class=\"keyword\">server</span> <span class=\"keyword\">on</span> the PXE network.</span><br><span class=\"line\"><span class=\"number\">3</span> : <span class=\"keyword\">change</span> <span class=\"string\">'disable'</span> <span class=\"keyword\">to</span> <span class=\"string\">'no'</span> <span class=\"keyword\">in</span> /etc/xinetd.d/tftp</span><br><span class=\"line\"><span class=\"number\">4</span> : <span class=\"keyword\">Some</span> network boot-loaders <span class=\"keyword\">are</span> <span class=\"keyword\">missing</span> <span class=\"keyword\">from</span> /<span class=\"keyword\">var</span>/lib/cobbler/loaders, you may run <span class=\"string\">'cobbler get-loaders'</span> <span class=\"keyword\">to</span> download them, <span class=\"keyword\">or</span>, <span class=\"keyword\">if</span> you <span class=\"keyword\">only</span> want <span class=\"keyword\">to</span> handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* <span class=\"keyword\">version</span> <span class=\"keyword\">of</span> the syslinux <span class=\"keyword\">package</span> installed <span class=\"keyword\">and</span> can <span class=\"keyword\">ignore</span> this message entirely.  Files <span class=\"keyword\">in</span> this <span class=\"keyword\">directory</span>, should you want <span class=\"keyword\">to</span> support <span class=\"keyword\">all</span> architectures, should <span class=\"keyword\">include</span> pxelinux<span class=\"number\">.0</span>, menu.c32, elilo.efi, <span class=\"keyword\">and</span> yaboot. The <span class=\"string\">'cobbler get-loaders'</span> command <span class=\"keyword\">is</span> the easiest way <span class=\"keyword\">to</span> resolve these requirements.</span><br><span class=\"line\"><span class=\"number\">5</span> : <span class=\"keyword\">enable</span> <span class=\"keyword\">and</span> <span class=\"keyword\">start</span> rsyncd.service <span class=\"keyword\">with</span> systemctl</span><br><span class=\"line\"><span class=\"number\">6</span> : debmirror <span class=\"keyword\">package</span> <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> installed, it will be <span class=\"keyword\">required</span> <span class=\"keyword\">to</span> manage debian deployments <span class=\"keyword\">and</span> repositories</span><br><span class=\"line\"><span class=\"number\">7</span> : ksvalidator was <span class=\"keyword\">not</span> <span class=\"keyword\">found</span>, <span class=\"keyword\">install</span> pykickstart</span><br><span class=\"line\"><span class=\"number\">8</span> : The <span class=\"keyword\">default</span> <span class=\"keyword\">password</span> used <span class=\"keyword\">by</span> the <span class=\"keyword\">sample</span> templates <span class=\"keyword\">for</span> newly installed machines (default_password_crypted <span class=\"keyword\">in</span> /etc/cobbler/<span class=\"keyword\">settings</span>) <span class=\"keyword\">is</span> still <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"string\">'cobbler'</span> <span class=\"keyword\">and</span> should be <span class=\"keyword\">changed</span>, try: <span class=\"string\">\"openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'\"</span> <span class=\"keyword\">to</span> generate <span class=\"keyword\">new</span> one</span><br><span class=\"line\"><span class=\"number\">9</span> : fencing tools were <span class=\"keyword\">not</span> <span class=\"keyword\">found</span>, <span class=\"keyword\">and</span> <span class=\"keyword\">are</span> <span class=\"keyword\">required</span> <span class=\"keyword\">to</span> <span class=\"keyword\">use</span> the (optional) <span class=\"keyword\">power</span> <span class=\"keyword\">management</span> features. <span class=\"keyword\">install</span> cman <span class=\"keyword\">or</span> fence-agents <span class=\"keyword\">to</span> <span class=\"keyword\">use</span> them</span><br><span class=\"line\"></span><br><span class=\"line\">Restart cobblerd <span class=\"keyword\">and</span> <span class=\"keyword\">then</span> run <span class=\"string\">'cobbler sync'</span> <span class=\"keyword\">to</span> <span class=\"keyword\">apply</span> changes.</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>看到上面出现的问题，然后一个一个的进行解决，先进行设置为可以动态配置，也可以直接更改配置文件。</p>\n</blockquote>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 设置可以动态修改配置文件</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># sed -ri <span class=\"string\">'/allow_dynamic_settings:/c\\allow_dynamic_settings: 1'</span> /etc/cobbler/settings</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># grep allow_dynamic_settings /etc/cobbler/settings </span></span><br><span class=\"line\">allow_dynamic_settings: <span class=\"number\">1</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl restart cobblerd</span></span><br></pre></td></tr></table></figure>\n<p>逐个解决上面的问题<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1.</span> server</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler setting edit --name=server --value=192.168.2.128</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2.</span> next_server</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler setting edit --name=next_server --value=192.168.2.128</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3.</span> tftp_server</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># sed -ri <span class=\"string\">'/disable/c\\disable = no'</span> /etc/xinetd.d/tftp</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl enable xinetd</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl restart xinetd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4.</span> boot-loaders</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler get-loaders</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">5.</span> rsyncd</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl start rsyncd</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl enable rsyncd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">6.</span> debmirror [optional]</span><br><span class=\"line\"><span class=\"meta\"># 这个是可选项的，可以忽略。这里就忽略了</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">7.</span> pykickstart</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># yum -y install pykickstart</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">8.</span> default_password_crypted  <span class=\"meta\">#注意：这里设置的密码，也就是后面安装完系统的初始化登录密码</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># openssl passwd -1 -salt `openssl rand -hex 4` <span class=\"string\">'admin'</span></span></span><br><span class=\"line\">$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler setting edit --name=default_password_crypted --value=<span class=\"string\">'$1$675f1d08$oJoAMVxdbdKHjQXbGqNTX0'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">9.</span> fencing tools [optional]</span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># yum -y install fence-agents</span></span><br></pre></td></tr></table></figure></p>\n<p>解决完成再次查看<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cobbler check</span></span><br><span class=\"line\">The following are potential configuration items <span class=\"literal\">that</span> you may want <span class=\"keyword\">to</span> fix:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> : debmirror package <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> installed, <span class=\"literal\">it</span> will be required <span class=\"keyword\">to</span> manage debian deployments <span class=\"keyword\">and</span> repositories</span><br><span class=\"line\"></span><br><span class=\"line\">Restart cobblerd <span class=\"keyword\">and</span> <span class=\"keyword\">then</span> run <span class=\"string\">'cobbler sync'</span> <span class=\"keyword\">to</span> apply changes.</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"配置DHCP\"><a href=\"#配置DHCP\" class=\"headerlink\" title=\"配置DHCP\"></a>配置DHCP</h3><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler setting edit --name=manage_dhcp --value=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"># 修改cobbler的dhcp模块，不要直接修改dhcp本身的配置文件，因为cobbler会覆盖</span><br><span class=\"line\">[root@cobbler ~]# vim /etc/cobbler/dhcp.template</span><br><span class=\"line\">...</span><br><span class=\"line\">subnet <span class=\"number\">192.168</span><span class=\"number\">.2</span><span class=\"number\">.0</span> netmask <span class=\"number\">255.255</span><span class=\"number\">.255</span><span class=\"number\">.0</span> &#123; #这里改为分配的网段和掩码</span><br><span class=\"line\">     #option routers             <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.5</span>; #如果有网关，这里改为网关地址</span><br><span class=\"line\">     #option domain-name-servers <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.1</span>; #如果有DNS，这里改为DNS地址</span><br><span class=\"line\">     option subnet-mask         <span class=\"number\">255.255</span><span class=\"number\">.255</span><span class=\"number\">.0</span>; #改为分配的IP的掩码</span><br><span class=\"line\">     range dynamic-bootp        <span class=\"number\">192.168</span><span class=\"number\">.2</span><span class=\"number\">.100</span> <span class=\"number\">192.168</span><span class=\"number\">.2</span><span class=\"number\">.254</span>; #改为分配的IP的范围</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<h3 id=\"同步cobbler配置\"><a href=\"#同步cobbler配置\" class=\"headerlink\" title=\"同步cobbler配置\"></a>同步cobbler配置</h3><blockquote>\n<p>同步cobbler配置，它会根据配置自动修改dhcp等服务。</p>\n</blockquote>\n<figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cobbler rsync </span></span><br><span class=\"line\">No such <span class=\"symbol\">command:</span> rsync</span><br><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cobbler sync</span></span><br><span class=\"line\">task <span class=\"symbol\">started:</span> <span class=\"number\">2019</span>-<span class=\"number\">0</span>6-<span class=\"number\">12_15262</span>3_sync</span><br><span class=\"line\">task started (id=Sync, time=Wed Jun <span class=\"number\">12</span> <span class=\"number\">15</span>:<span class=\"number\">26</span>:<span class=\"number\">23</span> <span class=\"number\">2019</span>)</span><br><span class=\"line\">running pre-sync triggers</span><br><span class=\"line\">cleaning trees</span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/www/cobbler/images/centos6.<span class=\"number\">9</span>-x86_64</span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">pxelinux</span>.<span class=\"title\">cfg</span>/<span class=\"title\">default</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">images</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86</span>.<span class=\"title\">efi</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86_64</span>.<span class=\"title\">efi</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">efidefault</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">images</span>/<span class=\"title\">centos6</span>.9-<span class=\"title\">x86_64</span></span></span><br><span class=\"line\"><span class=\"symbol\">removing:</span> /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">s390x</span>/<span class=\"title\">profile_list</span></span></span><br><span class=\"line\">copying bootloaders</span><br><span class=\"line\">trying hardlink /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">loaders</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86</span>.<span class=\"title\">efi</span> -&gt; /<span class=\"title\">var</span>/<span class=\"title\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86</span>.<span class=\"title\">efi</span></span></span><br><span class=\"line\">trying hardlink /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">loaders</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86_64</span>.<span class=\"title\">efi</span> -&gt; /<span class=\"title\">var</span>/<span class=\"title\">lib</span>/<span class=\"title\">tftpboot</span>/<span class=\"title\">grub</span>/<span class=\"title\">grub</span>-<span class=\"title\">x86_64</span>.<span class=\"title\">efi</span></span></span><br><span class=\"line\">copying distros to tftpboot</span><br><span class=\"line\">copying files <span class=\"keyword\">for</span> <span class=\"symbol\">distro:</span> centos6.<span class=\"number\">9</span>-x86_64</span><br><span class=\"line\">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/vmlinuz -&gt; <span class=\"regexp\">/var/lib</span><span class=\"regexp\">/tftpboot/images</span><span class=\"regexp\">/centos6.9-x86_64/vmlinuz</span></span><br><span class=\"line\">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/initrd.img -&gt; <span class=\"regexp\">/var/lib</span><span class=\"regexp\">/tftpboot/images</span><span class=\"regexp\">/centos6.9-x86_64/initrd</span>.img</span><br><span class=\"line\">copying images</span><br><span class=\"line\">generating PXE configuration files</span><br><span class=\"line\">generating PXE menu structure</span><br><span class=\"line\">copying files <span class=\"keyword\">for</span> <span class=\"symbol\">distro:</span> centos6.<span class=\"number\">9</span>-x86_64</span><br><span class=\"line\">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/vmlinuz -&gt; <span class=\"regexp\">/var/www</span><span class=\"regexp\">/cobbler/images</span><span class=\"regexp\">/centos6.9-x86_64/vmlinuz</span></span><br><span class=\"line\">trying hardlink /var/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/initrd.img -&gt; <span class=\"regexp\">/var/www</span><span class=\"regexp\">/cobbler/images</span><span class=\"regexp\">/centos6.9-x86_64/initrd</span>.img</span><br><span class=\"line\">Writing template files <span class=\"keyword\">for</span> centos6.<span class=\"number\">9</span>-x86_64</span><br><span class=\"line\">rendering DHCP files</span><br><span class=\"line\">generating /etc/dhcp/dhcpd.conf</span><br><span class=\"line\">rendering TFTPD files</span><br><span class=\"line\">generating /etc/xinetd.d/tftp</span><br><span class=\"line\">processing boot_files <span class=\"keyword\">for</span> <span class=\"symbol\">distro:</span> centos6.<span class=\"number\">9</span>-x86_64</span><br><span class=\"line\">cleaning link caches</span><br><span class=\"line\">running post-sync triggers</span><br><span class=\"line\">running python triggers from /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">triggers</span>/<span class=\"title\">sync</span>/<span class=\"title\">post</span>/*</span></span><br><span class=\"line\">running python trigger cobbler.modules.sync_post_restart_services</span><br><span class=\"line\"><span class=\"symbol\">running:</span> dhcpd -t -q</span><br><span class=\"line\">received on <span class=\"symbol\">stdout:</span> </span><br><span class=\"line\">received on <span class=\"symbol\">stderr:</span> </span><br><span class=\"line\"><span class=\"symbol\">running:</span> service dhcpd restart</span><br><span class=\"line\">received on <span class=\"symbol\">stdout:</span> </span><br><span class=\"line\">received on <span class=\"symbol\">stderr:</span> Redirecting to /bin/systemctl restart dhcpd.service</span><br><span class=\"line\"></span><br><span class=\"line\">running shell triggers from /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">triggers</span>/<span class=\"title\">sync</span>/<span class=\"title\">post</span>/*</span></span><br><span class=\"line\">running python triggers from /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">triggers</span>/<span class=\"title\">change</span>/*</span></span><br><span class=\"line\">running python trigger cobbler.modules.manage_genders</span><br><span class=\"line\">running python trigger cobbler.modules.scm_track</span><br><span class=\"line\">running shell triggers from /var/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">cobbler</span>/<span class=\"title\">triggers</span>/<span class=\"title\">change</span>/*</span></span><br><span class=\"line\">*** TASK COMPLETE ***</span><br></pre></td></tr></table></figure>\n<p>这时候创建一个新虚拟机可以获取到如下信息，没有镜像选择，只能从本地启动<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler03.png\" alt></p>\n<h3 id=\"cobbler命令帮助\"><a href=\"#cobbler命令帮助\" class=\"headerlink\" title=\"cobbler命令帮助\"></a>cobbler命令帮助</h3><table>\n<thead>\n<tr>\n<th>命令</th>\n<th style=\"text-align:left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>cobbler check</td>\n<td style=\"text-align:left\">核对当前设置是否有问题</td>\n</tr>\n<tr>\n<td>cobbler list</td>\n<td style=\"text-align:left\">列出所有的cobbler元素</td>\n</tr>\n<tr>\n<td>cobbler report</td>\n<td style=\"text-align:left\">列出元素的详细信息</td>\n</tr>\n<tr>\n<td>cobbler sync</td>\n<td style=\"text-align:left\">同步配置到数据目录，更改配置最好都执行一下</td>\n</tr>\n<tr>\n<td>cobbler reposync</td>\n<td style=\"text-align:left\">同步yum仓库</td>\n</tr>\n<tr>\n<td>cobbler distro</td>\n<td style=\"text-align:left\">查看导入的发行版系统信息</td>\n</tr>\n<tr>\n<td>cobbler system</td>\n<td style=\"text-align:left\">查看添加的系统信息</td>\n</tr>\n<tr>\n<td>cobbler profile</td>\n<td style=\"text-align:left\">查看配置信息</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"cobbler配置安装centos6-x\"><a href=\"#cobbler配置安装centos6-x\" class=\"headerlink\" title=\"cobbler配置安装centos6.x\"></a>cobbler配置安装centos6.x</h2><blockquote>\n<p>由于我这里实在<code>centos7</code>系统上面配置的<code>cobbler</code>，所以上传了一个<code>centos6</code>的镜像并进行挂载。</p>\n</blockquote>\n<p>1）创建挂载点，并进行挂载<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># mkdir /centos6</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># mount -o loop CentOS-6.9-x86_64-bin-DVD1.iso /centos6</span></span><br></pre></td></tr></table></figure></p>\n<p>2）查看挂载后的目录<br><figure class=\"highlight vbnet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"meta\"># ls /centos6/</span></span><br><span class=\"line\">CentOS_BuildTag  images                    repodata                       RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS-Testing<span class=\"number\">-6</span></span><br><span class=\"line\">EFI              isolinux                  RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS<span class=\"number\">-6</span>           TRANS.TBL</span><br><span class=\"line\">EULA             Packages                  RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS-Debug<span class=\"number\">-6</span></span><br><span class=\"line\">GPL              RELEASE-NOTES-en-US.html  RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS-Security<span class=\"number\">-6</span></span><br></pre></td></tr></table></figure></p>\n<p>3）导入镜像<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler import <span class=\"attribute\">--path</span>=/centos6 <span class=\"attribute\">--name</span>=centos6.9 <span class=\"attribute\">--arch</span>=x86_64</span><br><span class=\"line\"><span class=\"comment\"># --path 镜像路径</span></span><br><span class=\"line\"><span class=\"comment\"># --name 为安装源定义一个名字</span></span><br><span class=\"line\"><span class=\"comment\"># --arch 指定安装源是32位、64位、ia64, 目前支持的选项有: x86│x86_64│ia64</span></span><br><span class=\"line\"><span class=\"comment\"># 安装源的唯一标示就是根据name参数来定义，本例导入成功后，安装源的唯一标示就是：centos6.9，如果重复，系统会提示导入失败。</span></span><br></pre></td></tr></table></figure></p>\n<p>4）查看导入后镜像信息<br><figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler distro report <span class=\"comment\">--name=centos6.9-x86_64</span></span><br><span class=\"line\">Name                           : <span class=\"type\">centos6.9</span>-x86_64</span><br><span class=\"line\">Architecture                   : <span class=\"type\">x86_64</span></span><br><span class=\"line\">TFTP Boot Files                : &#123;&#125;</span><br><span class=\"line\">Breed                          : <span class=\"type\">redhat</span></span><br><span class=\"line\">Comment                        : </span><br><span class=\"line\">Fetchable Files                : &#123;&#125;</span><br><span class=\"line\">Initrd                         : /<span class=\"type\">var</span>/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/initrd.img</span><br><span class=\"line\">Kernel                         : /<span class=\"type\">var</span>/www/cobbler/ks_mirror/centos6.<span class=\"number\">9</span>-x86_64/images/pxeboot/vmlinuz</span><br><span class=\"line\">Kernel Options                 : &#123;&#125;</span><br><span class=\"line\">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class=\"line\">Kickstart Metadata             : &#123;'<span class=\"type\">tree</span>': <span class=\"symbol\">'http</span>://@@http_server@@/cblr/links/centos6.<span class=\"number\">9</span>-x86_64'&#125;</span><br><span class=\"line\">Management Classes             : []</span><br><span class=\"line\">OS Version                     : <span class=\"type\">rhel6</span></span><br><span class=\"line\">Owners                         : ['<span class=\"type\">admin</span>']</span><br><span class=\"line\">Red Hat Management Key         : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Red Hat Management Server      : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Template Files                 : &#123;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>5）查看<code>profile</code>信息<br><figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler profile report <span class=\"comment\">--name=centos6.9-x86_64</span></span><br><span class=\"line\">Name                           : <span class=\"type\">centos6.9</span>-x86_64</span><br><span class=\"line\">TFTP Boot Files                : &#123;&#125;</span><br><span class=\"line\">Comment                        : </span><br><span class=\"line\">DHCP Tag                       : <span class=\"type\">default</span></span><br><span class=\"line\">Distribution                   : <span class=\"type\">centos6.9</span>-x86_64</span><br><span class=\"line\">Enable gPXE?                   : 0</span><br><span class=\"line\">Enable PXE Menu?               : 1</span><br><span class=\"line\">Fetchable Files                : &#123;&#125;</span><br><span class=\"line\">Kernel Options                 : &#123;&#125;</span><br><span class=\"line\">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class=\"line\">Kickstart                      : /<span class=\"type\">var</span>/lib/cobbler/kickstarts/sample_end.ks</span><br><span class=\"line\">Kickstart Metadata             : &#123;&#125;</span><br><span class=\"line\">Management Classes             : []</span><br><span class=\"line\">Management Parameters          : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Name Servers                   : []</span><br><span class=\"line\">Name Servers Search Path       : []</span><br><span class=\"line\">Owners                         : ['<span class=\"type\">admin</span>']</span><br><span class=\"line\">Parent Profile                 : </span><br><span class=\"line\">Internal proxy                 : </span><br><span class=\"line\">Red Hat Management Key         : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Red Hat Management Server      : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Repos                          : []</span><br><span class=\"line\">Server Override                : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Template Files                 : &#123;&#125;</span><br><span class=\"line\">Virt Auto Boot                 : 1</span><br><span class=\"line\">Virt Bridge                    : <span class=\"type\">xenbr0</span></span><br><span class=\"line\">Virt CPUs                      : 1</span><br><span class=\"line\">Virt Disk Driver <span class=\"keyword\">Type</span>          <span class=\"type\">: </span>raw</span><br><span class=\"line\">Virt File Size(GB)             : 5</span><br><span class=\"line\">Virt Path                      : </span><br><span class=\"line\">Virt RAM (MB)                  : 512</span><br><span class=\"line\">Virt <span class=\"keyword\">Type</span>                      <span class=\"type\">: </span>kvm</span><br></pre></td></tr></table></figure></p>\n<p>6）<code>copy</code>一份<code>profile</code>文件(<code>ks</code>)，进行修改<br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cd /var/lib/cobbler/kickstarts/</span></span><br><span class=\"line\">[root@cobbler kickstarts]<span class=\"comment\"># ls</span></span><br><span class=\"line\">default.ks    install_profiles  sample_autoyast.xml  sample_esxi4.ks  sample.ks</span><br><span class=\"line\">esxi4-ks.cfg  legacy.ks         sample_end.ks        sample_esxi5.ks  sample_old.seed</span><br><span class=\"line\">esxi5-ks.cfg  pxerescue.ks      sample_esx4.ks       sample_esxi6.ks  sample.seed</span><br><span class=\"line\">[root@cobbler kickstarts]<span class=\"comment\"># cp sample_end.ks centos6.ks</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑centos6的kickstart文件</span></span><br><span class=\"line\">[root@cobbler kickstarts]<span class=\"comment\"># vim centos6.ks </span></span><br><span class=\"line\"><span class=\"comment\"># This kickstart file should only be used with EL &gt; 5 and/or Fedora &gt; 7.</span></span><br><span class=\"line\"><span class=\"comment\"># For older versions please use the sample.ks kickstart file.</span></span><br><span class=\"line\"><span class=\"comment\"># Install OS instead of upgrade</span></span><br><span class=\"line\">install</span><br><span class=\"line\"><span class=\"comment\"># Use text mode install</span></span><br><span class=\"line\">text</span><br><span class=\"line\"><span class=\"comment\"># System keyboard</span></span><br><span class=\"line\">keyboard us</span><br><span class=\"line\"><span class=\"comment\"># System language</span></span><br><span class=\"line\">lang en_US</span><br><span class=\"line\"><span class=\"comment\"># System timezone</span></span><br><span class=\"line\">timezone  Asia/ShangHai</span><br><span class=\"line\"><span class=\"comment\">#Root password</span></span><br><span class=\"line\">rootpw --iscrypted $default_password_crypted</span><br><span class=\"line\"><span class=\"comment\"># System authorization information</span></span><br><span class=\"line\">auth  --useshadow  --enablemd5</span><br><span class=\"line\"><span class=\"comment\"># Firewall configuration</span></span><br><span class=\"line\">firewall --disabled</span><br><span class=\"line\"><span class=\"comment\"># SELinux configuration</span></span><br><span class=\"line\">selinux --disabled</span><br><span class=\"line\"><span class=\"comment\"># Use network installation</span></span><br><span class=\"line\">url --url=$tree</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Clear the Master Boot Record</span></span><br><span class=\"line\">zerombr</span><br><span class=\"line\"><span class=\"comment\"># System bootloader configuration</span></span><br><span class=\"line\">bootloader --location=mbr</span><br><span class=\"line\"><span class=\"comment\"># Partition clearing information</span></span><br><span class=\"line\">clearpart --all --initlabel</span><br><span class=\"line\">part /boot --fstype=ext4 --size=<span class=\"number\">500</span></span><br><span class=\"line\">part swap --fstype=swap --size=<span class=\"number\">2048</span></span><br><span class=\"line\">part / --fstype=ext4 --grow --size=<span class=\"number\">200</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If any cobbler repo definitions were referenced in the kickstart profile, include them here.</span></span><br><span class=\"line\">$yum_repo_stanza</span><br><span class=\"line\"><span class=\"comment\"># Network information</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'network_config'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Do not configure the X Window System</span></span><br><span class=\"line\">skipx</span><br><span class=\"line\"><span class=\"comment\"># Run the Setup Agent on first boot</span></span><br><span class=\"line\">firstboot --disable</span><br><span class=\"line\"><span class=\"comment\"># Reboot after installation</span></span><br><span class=\"line\">reboot</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">%pre</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_pre'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'kickstart_start'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'pre_install_network_config'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Enable installation monitoring</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'pre_anamon'</span>)</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%packages</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'func_install_if_enabled'</span>)</span><br><span class=\"line\">@core</span><br><span class=\"line\">@base</span><br><span class=\"line\">tree</span><br><span class=\"line\">nmap</span><br><span class=\"line\">wget</span><br><span class=\"line\">lftp</span><br><span class=\"line\">lrzsz</span><br><span class=\"line\">telnet</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%post --nochroot</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_post_nochroot'</span>)</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%post</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_post'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Start yum configuration</span></span><br><span class=\"line\">$yum_config_stanza</span><br><span class=\"line\"><span class=\"comment\"># End yum configuration</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_install_kernel_options'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_install_network_config'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'func_register_if_enabled'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'download_config_files'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'koan_environment'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'redhat_register'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'cobbler_register'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Enable post-install boot notification</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_anamon'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Start final steps</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'kickstart_done'</span>)</span><br><span class=\"line\"><span class=\"comment\"># End final steps</span></span><br><span class=\"line\"></span><br><span class=\"line\">sed -ri <span class=\"string\">\"/^#UseDNS/c\\UseDNS no\"</span> /etc/ssh/sshd_config</span><br><span class=\"line\">sed -ri <span class=\"string\">\"/^GSSAPIAuthentication/c\\GSSAPIAuthentication no\"</span> /etc/ssh/sshd_config</span><br><span class=\"line\">%end</span><br></pre></td></tr></table></figure></p>\n<p>7）编辑<code>centos6</code>镜像所使用的<code>kickstart</code>文件<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 动态编辑指定使用新的kickstart文件</span></span><br><span class=\"line\">[root@cobbler ~]# cobbler<span class=\"built_in\"> profile </span><span class=\"builtin-name\">edit</span> <span class=\"attribute\">--name</span>=centos6.9-x86_64 <span class=\"attribute\">--kickstart</span>=/var/lib/cobbler/kickstarts/centos6.ks</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证是否更改成功</span></span><br><span class=\"line\">[root@cobbler ~]# cobbler<span class=\"built_in\"> profile </span>report <span class=\"attribute\">--name</span>=centos6.9-x86_64 |grep Kickstart</span><br><span class=\"line\">Kickstart                      : /var/lib/cobbler/kickstarts/centos6.ks</span><br></pre></td></tr></table></figure></p>\n<p>8）再次同步<code>cobbler</code>配置<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler sync</span></span><br></pre></td></tr></table></figure></p>\n<p>9）新建虚拟机进行测试<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler04.png\" alt><br>选择<code>centos6.9</code>进行安装，会按照<code>kickstart</code>文件安装并启动<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler05.png\" alt></p>\n<h2 id=\"cobbler配置安装centos7-x\"><a href=\"#cobbler配置安装centos7-x\" class=\"headerlink\" title=\"cobbler配置安装centos7.x\"></a>cobbler配置安装centos7.x</h2><blockquote>\n<p>我这里cobbler服务器就是7的系统，所以直接挂载/dev/cdrom即可</p>\n</blockquote>\n<p>1）创建挂载点，并进行挂载<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># mkdir /centos7</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># mount -o loop /dev/cdrom /centos7</span></span><br></pre></td></tr></table></figure></p>\n<p>2）查看挂载后的目录<br><figure class=\"highlight vbnet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"meta\"># ls /centos7/</span></span><br><span class=\"line\">CentOS_BuildTag  EULA  images    LiveOS    repodata              RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS-Testing<span class=\"number\">-7</span></span><br><span class=\"line\">EFI              GPL   isolinux  Packages  RPM-GPG-<span class=\"keyword\">KEY</span>-CentOS<span class=\"number\">-7</span>  TRANS.TBL</span><br></pre></td></tr></table></figure></p>\n<p>3）导入镜像<br><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@cobbler</span> ~]<span class=\"comment\"># cobbler import --path=/centos7 --name=centos7.4 --arch=x86_64</span></span><br><span class=\"line\">task <span class=\"symbol\">started:</span> <span class=\"number\">2019</span>-<span class=\"number\">06</span>-<span class=\"number\">12_165812_</span><span class=\"keyword\">import</span></span><br><span class=\"line\">task started (id=Media <span class=\"keyword\">import</span>, time=Wed Jun <span class=\"number\">12</span> <span class=\"number\">16</span><span class=\"symbol\">:</span><span class=\"number\">58</span><span class=\"symbol\">:</span><span class=\"number\">12</span> <span class=\"number\">2019</span>)</span><br><span class=\"line\">Found a candidate <span class=\"symbol\">signature:</span> breed=redhat, version=rhel6</span><br><span class=\"line\">Found a candidate <span class=\"symbol\">signature:</span> breed=redhat, version=rhel7</span><br><span class=\"line\">Found a matching <span class=\"symbol\">signature:</span> breed=redhat, version=rhel7</span><br><span class=\"line\">Adding distros from path /var/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-<span class=\"symbol\">x86_64:</span></span><br><span class=\"line\">creating new <span class=\"symbol\">distro:</span> centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">trying <span class=\"symbol\">symlink:</span> /var/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64 -&gt; /var/www/cobbler/links/centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">creating new <span class=\"symbol\">profile:</span> centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">associating repos</span><br><span class=\"line\">checking <span class=\"keyword\">for</span> rsync repo(s)</span><br><span class=\"line\">checking <span class=\"keyword\">for</span> rhn repo(s)</span><br><span class=\"line\">checking <span class=\"keyword\">for</span> yum repo(s)</span><br><span class=\"line\">starting descent into /var/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64 <span class=\"keyword\">for</span> centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">processing repo at : <span class=\"regexp\">/var/www</span><span class=\"regexp\">/cobbler/ks</span>_mirror/centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">need to process repo/<span class=\"symbol\">comps:</span> /var/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64</span><br><span class=\"line\">looking <span class=\"keyword\">for</span> /var/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64/repodata/*comps*.xml</span><br><span class=\"line\">Keeping repodata as-is <span class=\"symbol\">:/var/www/cobbler/ks_mirror/centos7</span>.<span class=\"number\">4</span>-x86_64/repodata</span><br><span class=\"line\">*** TASK COMPLETE ***</span><br></pre></td></tr></table></figure></p>\n<p>4）查看导入后镜像信息<br><figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler distro report <span class=\"comment\">--name=centos7.4-x86_64</span></span><br><span class=\"line\">Name                           : <span class=\"type\">centos7.4</span>-x86_64</span><br><span class=\"line\">Architecture                   : <span class=\"type\">x86_64</span></span><br><span class=\"line\">TFTP Boot Files                : &#123;&#125;</span><br><span class=\"line\">Breed                          : <span class=\"type\">redhat</span></span><br><span class=\"line\">Comment                        : </span><br><span class=\"line\">Fetchable Files                : &#123;&#125;</span><br><span class=\"line\">Initrd                         : /<span class=\"type\">var</span>/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64/images/pxeboot/initrd.img</span><br><span class=\"line\">Kernel                         : /<span class=\"type\">var</span>/www/cobbler/ks_mirror/centos7.<span class=\"number\">4</span>-x86_64/images/pxeboot/vmlinuz</span><br><span class=\"line\">Kernel Options                 : &#123;&#125;</span><br><span class=\"line\">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class=\"line\">Kickstart Metadata             : &#123;'<span class=\"type\">tree</span>': <span class=\"symbol\">'http</span>://@@http_server@@/cblr/links/centos7.<span class=\"number\">4</span>-x86_64'&#125;</span><br><span class=\"line\">Management Classes             : []</span><br><span class=\"line\">OS Version                     : <span class=\"type\">rhel7</span></span><br><span class=\"line\">Owners                         : ['<span class=\"type\">admin</span>']</span><br><span class=\"line\">Red Hat Management Key         : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Red Hat Management Server      : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Template Files                 : &#123;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>5）查看<code>profile</code>信息<br><figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]# cobbler profile report <span class=\"comment\">--name=centos7.4-x86_64</span></span><br><span class=\"line\">Name                           : <span class=\"type\">centos7.4</span>-x86_64</span><br><span class=\"line\">TFTP Boot Files                : &#123;&#125;</span><br><span class=\"line\">Comment                        : </span><br><span class=\"line\">DHCP Tag                       : <span class=\"type\">default</span></span><br><span class=\"line\">Distribution                   : <span class=\"type\">centos7.4</span>-x86_64</span><br><span class=\"line\">Enable gPXE?                   : 0</span><br><span class=\"line\">Enable PXE Menu?               : 1</span><br><span class=\"line\">Fetchable Files                : &#123;&#125;</span><br><span class=\"line\">Kernel Options                 : &#123;&#125;</span><br><span class=\"line\">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class=\"line\">Kickstart                      : /<span class=\"type\">var</span>/lib/cobbler/kickstarts/sample_end.ks</span><br><span class=\"line\">Kickstart Metadata             : &#123;&#125;</span><br><span class=\"line\">Management Classes             : []</span><br><span class=\"line\">Management Parameters          : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Name Servers                   : []</span><br><span class=\"line\">Name Servers Search Path       : []</span><br><span class=\"line\">Owners                         : ['<span class=\"type\">admin</span>']</span><br><span class=\"line\">Parent Profile                 : </span><br><span class=\"line\">Internal proxy                 : </span><br><span class=\"line\">Red Hat Management Key         : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Red Hat Management Server      : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Repos                          : []</span><br><span class=\"line\">Server Override                : &lt;&lt;<span class=\"type\">inherit</span>&gt;&gt;</span><br><span class=\"line\">Template Files                 : &#123;&#125;</span><br><span class=\"line\">Virt Auto Boot                 : 1</span><br><span class=\"line\">Virt Bridge                    : <span class=\"type\">xenbr0</span></span><br><span class=\"line\">Virt CPUs                      : 1</span><br><span class=\"line\">Virt Disk Driver <span class=\"keyword\">Type</span>          <span class=\"type\">: </span>raw</span><br><span class=\"line\">Virt File Size(GB)             : 5</span><br><span class=\"line\">Virt Path                      : </span><br><span class=\"line\">Virt RAM (MB)                  : 512</span><br><span class=\"line\">Virt <span class=\"keyword\">Type</span>                      <span class=\"type\">: </span>kvm</span><br></pre></td></tr></table></figure></p>\n<p>7）<code>copy</code>一份<code>profile</code>文件( <code>ks</code> )，进行修改,这里直接copy上面6的了，然后修改修改即可<br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@cobbler ~]<span class=\"comment\"># cd /var/lib/cobbler/kickstarts/</span></span><br><span class=\"line\">[root@cobbler kickstarts]<span class=\"comment\"># cp centos6.ks centos7.ks</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑centos7的kickstart文件</span></span><br><span class=\"line\">[root@cobbler kickstarts]<span class=\"comment\"># vim centos7.ks</span></span><br><span class=\"line\"><span class=\"comment\"># This kickstart file should only be used with EL &gt; 5 and/or Fedora &gt; 7.</span></span><br><span class=\"line\"><span class=\"comment\"># For older versions please use the sample.ks kickstart file.</span></span><br><span class=\"line\"><span class=\"comment\"># Install OS instead of upgrade</span></span><br><span class=\"line\">install</span><br><span class=\"line\"><span class=\"comment\"># Use text mode install</span></span><br><span class=\"line\">text</span><br><span class=\"line\"><span class=\"comment\"># System keyboard</span></span><br><span class=\"line\">keyboard us</span><br><span class=\"line\"><span class=\"comment\"># System language</span></span><br><span class=\"line\">lang en_US</span><br><span class=\"line\"><span class=\"comment\"># System timezone</span></span><br><span class=\"line\">timezone  Asia/ShangHai</span><br><span class=\"line\"><span class=\"comment\">#Root password</span></span><br><span class=\"line\">rootpw --iscrypted $default_password_crypted</span><br><span class=\"line\"><span class=\"comment\"># System authorization information</span></span><br><span class=\"line\">auth  --useshadow  --enablemd5</span><br><span class=\"line\"><span class=\"comment\"># Firewall configuration</span></span><br><span class=\"line\">firewall --disabled</span><br><span class=\"line\"><span class=\"comment\"># SELinux configuration</span></span><br><span class=\"line\">selinux --disabled</span><br><span class=\"line\"><span class=\"comment\"># Use network installation</span></span><br><span class=\"line\">url --url=$tree</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Clear the Master Boot Record</span></span><br><span class=\"line\">zerombr</span><br><span class=\"line\"><span class=\"comment\"># System bootloader configuration</span></span><br><span class=\"line\">bootloader --location=mbr</span><br><span class=\"line\"><span class=\"comment\"># Partition clearing information</span></span><br><span class=\"line\">clearpart --all --initlabel</span><br><span class=\"line\">part /boot --fstype=xfs --size=<span class=\"number\">500</span></span><br><span class=\"line\">part swap --fstype=swap --size=<span class=\"number\">2048</span></span><br><span class=\"line\">part / --fstype=xfs --grow --size=<span class=\"number\">200</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If any cobbler repo definitions were referenced in the kickstart profile, include them here.</span></span><br><span class=\"line\">$yum_repo_stanza</span><br><span class=\"line\"><span class=\"comment\"># Network information</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'network_config'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Do not configure the X Window System</span></span><br><span class=\"line\">skipx</span><br><span class=\"line\"><span class=\"comment\"># Run the Setup Agent on first boot</span></span><br><span class=\"line\">firstboot --disable</span><br><span class=\"line\"><span class=\"comment\"># Reboot after installation</span></span><br><span class=\"line\">reboot</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">%pre</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_pre'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'kickstart_start'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'pre_install_network_config'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Enable installation monitoring</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'pre_anamon'</span>)</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%packages</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'func_install_if_enabled'</span>)</span><br><span class=\"line\">@core</span><br><span class=\"line\">@base</span><br><span class=\"line\">tree</span><br><span class=\"line\">nmap</span><br><span class=\"line\">wget</span><br><span class=\"line\">lftp</span><br><span class=\"line\">lrzsz</span><br><span class=\"line\">telnet</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%post --nochroot</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_post_nochroot'</span>)</span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%post</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'log_ks_post'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Start yum configuration</span></span><br><span class=\"line\">$yum_config_stanza</span><br><span class=\"line\"><span class=\"comment\"># End yum configuration</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_install_kernel_options'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_install_network_config'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'func_register_if_enabled'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'download_config_files'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'koan_environment'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'redhat_register'</span>)</span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'cobbler_register'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Enable post-install boot notification</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'post_anamon'</span>)</span><br><span class=\"line\"><span class=\"comment\"># Start final steps</span></span><br><span class=\"line\">$SNIPPET(<span class=\"string\">'kickstart_done'</span>)</span><br><span class=\"line\"><span class=\"comment\"># End final steps</span></span><br><span class=\"line\"></span><br><span class=\"line\">sed -ri <span class=\"string\">\"/^#UseDNS/c\\UseDNS no\"</span> /etc/ssh/sshd_config</span><br><span class=\"line\">sed -ri <span class=\"string\">\"/^GSSAPIAuthentication/c\\GSSAPIAuthentication no\"</span> /etc/ssh/sshd_config</span><br><span class=\"line\">%end</span><br></pre></td></tr></table></figure></p>\n<p>7）编辑<code>centos7</code>镜像所使用的<code>kickstart</code>文件<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 动态编辑指定使用新的kickstart文件</span></span><br><span class=\"line\">[root@cobbler ~]# cobbler<span class=\"built_in\"> profile </span><span class=\"builtin-name\">edit</span> <span class=\"attribute\">--name</span>=centos7.4-x86_64 <span class=\"attribute\">--kickstart</span>=/var/lib/cobbler/kickstarts/centos7.ks</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证是否更改成功</span></span><br><span class=\"line\">[root@cobbler ~]# cobbler<span class=\"built_in\"> profile </span>report <span class=\"attribute\">--name</span>=centos7.4-x86_64 |grep Kickstart</span><br><span class=\"line\">Kickstart                      : /var/lib/cobbler/kickstarts/centos7.ks</span><br></pre></td></tr></table></figure></p>\n<p>8）再次同步<code>cobbler</code>配置<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler sync</span></span><br></pre></td></tr></table></figure></p>\n<p>9）新建虚拟机进行测试<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler06.png\" alt><br>选择<code>centos7.4</code>进行安装即可<br><img src=\"/2019/06/12/Cobbler自动化部署/cobbler07.png\" alt></p>\n<blockquote>\n<p>说明：在<code>client</code>端系统安装时，可以在<code>cobbler</code>服务端上查看日志<code>/var/log/messages</code>，观察安装的每一个<code>cobbler</code>流程</p>\n</blockquote>\n<h2 id=\"cobbler-Web管理界面配置\"><a href=\"#cobbler-Web管理界面配置\" class=\"headerlink\" title=\"cobbler Web管理界面配置\"></a>cobbler Web管理界面配置</h2><blockquote>\n<p><code>web</code>界面有很多功能，包括上传镜像、编辑<code>kickstart</code>、等等很多在命令行操作的都可以在<code>web</code>界面直接操作。<br>在上面已经安装了<code>cobbler-web</code>软件，访问地址：<a href=\"https://IP/cobbler_web\" target=\"_blank\" rel=\"noopener\">https://IP/cobbler_web</a> 即可。默认账号为<code>cobbler</code>，密码也为<code>cobbler</code></p>\n</blockquote>\n<p><img src=\"/2019/06/12/Cobbler自动化部署/cobbler08.png\" alt></p>\n<p><strong>修改密码</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/cobbler/users.conf     <span class=\"meta\">#Web服务授权配置文件</span></span><br><span class=\"line\">/etc/cobbler/users.digest   <span class=\"meta\">#用于web访问的用户名密码</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cat /etc/cobbler/users.digest </span></span><br><span class=\"line\">cobbler:Cobbler:a2d6bae81669d707b72c0bd9806e01f3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 设置密码，在Cobbler组添加cobbler用户，输入2遍密码确</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># htdigest /etc/cobbler/users.digest <span class=\"string\">\"Cobbler\"</span> cobbler</span></span><br><span class=\"line\">Changing password <span class=\"keyword\">for</span> user cobbler <span class=\"keyword\">in</span> realm Cobbler</span><br><span class=\"line\">New password: superman</span><br><span class=\"line\">Re-type new password: superman</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 同步配置并重启httpd、cobbler</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># cobbler sync</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl restart httpd</span></span><br><span class=\"line\">[root<span class=\"symbol\">@cobbler</span> ~]<span class=\"meta\"># systemctl restart cobblerd</span></span><br></pre></td></tr></table></figure></p>\n<p>再次登录即使用新设置的密码登录即可。</p>\n"},{"title":"Tomcat安装与部署","date":"2019-06-26T09:36:22.000Z","copyright":true,"_content":"\n## Tomcat简介\n官网：http://tomcat.apache.org/\n>`Tomcat`服务器是一个免费的开源代码的Web应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下使用，是开发和调试`JSP`程序的首选。\n>`Tomcat`和`Nginx`、`Apache`等`Web`服务器一样，具有处理`HTML`页面的功能，另外它还是一个`Servlet`和`JSP`容器，独立的`Servlet`容器是`Tomcat`的默认模式。不过，`Tomcat`处理静态`HTML`的能力不如`Nginx/Apache`服务器。\n>一般情况下多用`Nginx+Tomcat`，`Nginx`处理静态，`Tomcat`处理动态程序\n\n## Tomcat安装\n>软件下载：[JDK下载](https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html)  &emsp; [Tomcat下载](http://tomcat.apache.org/)\n>本文使用的软件包`jdk-8u211`,`tomcat-9.0.21`。 [下载链接](https://pan.baidu.com/s/1d0g0T75p-CW7uz3ug7I8YA) &emsp; 提取码：f0ay\n\n### 部署Java环境\n将下载的软件包上传到服务器\n```\n# 解压软件包\n[root@tomcat ~]# tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/\n\n# 创建一个软链接\n[root@tomcat ~]# ln -s /usr/local/jdk1.8.0_211 /usr/local/java\n\n# 添加环境变量\n[root@tomcat ~]# sed -i.ori '$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile\n\n# 重新加载环境变量\n[root@tomcat ~]# source /etc/profile\n[root@tomcat ~]# env |grep JAVA\nJAVA_HOME=/usr/local/java\n\n# 查看是否安装成功\n[root@tomcat ~]# java -version\njava version \"1.8.0_211\"\nJava(TM) SE Runtime Environment (build 1.8.0_211-b12)\nJava HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)\n```\n\n### 部署Tomcat\n```\n# 解压软件包\n[root@tomcat ~]# tar xf apache-tomcat-9.0.21.tar.gz -C /usr/local/\n\n# 创建一个软链接\n[root@tomcat ~]# ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat\n\n# 定义tomcat所需的环境变量\n[root@tomcat ~]# echo \"export TOMCAT_HOME=/usr/local/tomcat\" >> /etc/profile\n\n# 重新加载环境变量\n[root@tomcat ~]# source /etc/profile\n```\n\n## Tomcat启动\n1）默认的启动方式\n```\n[root@tomcat ~]# ls /usr/local/tomcat/bin/startup.sh   #启动脚本\n/usr/local/tomcat/bin/startup.sh\n[root@tomcat ~]# ls /usr/local/tomcat/bin/shutdown.sh   #停止脚本\n/usr/local/tomcat/bin/shutdown.sh\n\n# 默认方式启动\n[root@tomcat ~]# /usr/local/tomcat/bin/startup.sh \nUsing CATALINA_BASE:   /usr/local/tomcat\nUsing CATALINA_HOME:   /usr/local/tomcat\nUsing CATALINA_TMPDIR: /usr/local/tomcat/temp\nUsing JRE_HOME:        /usr/local/java\nUsing CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar\nTomcat started.\n\n# 默认方式停止\n[root@tomcat ~]# /usr/local/tomcat/bin/shutdown.sh \nUsing CATALINA_BASE:   /usr/local/tomcat\nUsing CATALINA_HOME:   /usr/local/tomcat\nUsing CATALINA_TMPDIR: /usr/local/tomcat/temp\nUsing JRE_HOME:        /usr/local/java\nUsing CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar\n```\n2）加入`/etc/init.d/`支持`centos6`的`service`\n```\n# 编辑/etc/init.d/tomcat脚本\n[root@tomcat ~]# vim /etc/init.d/tomcat\n#!/bin/bash\n# Init file for Tomcat server daemon\n#\n# chkconfig: 2345 96 14\n# description: Tomcat server daemon\nJAVA_OPTS='-Xms64m -Xmx128m'\nJAVA_HOME=/usr/local/jdk1.8.0_211      #指定jdk安装路径\nCATALINA_HOME=/usr/local/tomcat     #指定tomcat安装路径\nexport JAVA_OPTS JAVA_HOME CATALINA_HOME\nexec $CATALINA_HOME/bin/catalina.sh $*\n\n# 添加执行权限\n[root@tomcat ~]# chmod +x /etc/init.d/tomcat\n\n# 启动停止测试\n[root@tomcat ~]# service tomcat start\nUsing CATALINA_BASE:   /usr/local/tomcat\nUsing CATALINA_HOME:   /usr/local/tomcat\nUsing CATALINA_TMPDIR: /usr/local/tomcat/temp\nUsing JRE_HOME:        /usr/local/jdk1.8.0_211\nUsing CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar\nTomcat started.\n[root@tomcat ~]# \n[root@tomcat ~]# service tomcat stop\nUsing CATALINA_BASE:   /usr/local/tomcat\nUsing CATALINA_HOME:   /usr/local/tomcat\nUsing CATALINA_TMPDIR: /usr/local/tomcat/temp\nUsing JRE_HOME:        /usr/local/jdk1.8.0_211\nUsing CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar\n```\n3）加入`systemd`管理`tomcat`\n```\n# 编辑启动脚本\n[root@tomcat ~]# vim /usr/lib/systemd/system/tomcat.service\n[Unit]\nDescription=Tomcat server daemon\nAfter=syslog.target network.target remote-fs.target nss-lookup.target\n\n[Service]\nType=oneshot\nExecStart=/usr/local/tomcat/bin/startup.sh\nExecStop=/usr/local/tomcat/bin/shutdown.sh\nExecReload=/bin/kill -HUP $MAINPID\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\n\n# 测试启动和关闭\n[root@tomcat ~]# systemctl start tomcat\n[root@tomcat ~]# ps -ef |grep tomcat\nroot       4810      1 35 12:37 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start\nroot       4852   1823  0 12:37 pts/1    00:00:00 grep --color=auto tomcat\n[root@tomcat ~]# \n[root@tomcat ~]# systemctl stop tomcat\n[root@tomcat ~]# ps -ef |grep tomcat\nroot       4888   1823  0 12:38 pts/1    00:00:00 grep --color=auto tomcat\n[root@tomcat ~]# \n[root@tomcat ~]# systemctl restart tomcat \n[root@tomcat ~]# ps -ef |grep tomcat\nroot       4909      1 43 12:38 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start\nroot       4959   1823  0 12:38 pts/1    00:00:00 grep --color=auto tomcat\n[root@tomcat ~]#\n[root@tomcat ~]# systemctl status tomcat\n● tomcat.service - Tomcat server daemon\n   Loaded: loaded (/usr/lib/systemd/system/tomcat.service; disabled; vendor preset: disabled)\n   Active: active (exited) since 二 2019-06-25 12:38:22 CST; 3min 53s ago\n  Process: 4895 ExecStart=/usr/local/tomcat/bin/startup.sh (code=exited, status=0/SUCCESS)\n Main PID: 4895 (code=exited, status=0/SUCCESS)\n   CGroup: /system.slice/tomcat.service\n           └─4909 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.pro...\n\n6月 25 12:38:22 tomcat systemd[1]: Starting Tomcat server daemon...\n6月 25 12:38:22 tomcat startup.sh[4895]: Tomcat started.\n6月 25 12:38:22 tomcat systemd[1]: Started Tomcat server daemon.\n\n# 加入开机启动\n[root@tomcat ~]# systemctl enable tomcat\n[root@tomcat ~]# systemctl list-unit-files  |grep tomcat\ntomcat.service                                enabled\n```\ntomcat启动成功后默认端口为：8080，访问地址http://ip:8080\n![](Tomcat安装与部署/tomcat01.png)\n\n## Tomcat目录结构\n`tomcat`安装主目录下的各个子目录说明：\n```\n[root@tomcat ~]# cd /usr/local/tomcat/\n[root@tomcat tomcat]# tree -L 1\n.\n├── bin\t\t\t#存放启动、关闭tomcat或者其它功能的脚本(.bat文件和.sh文件)\n├── BUILDING.txt\n├── conf        #存放tomcat配置相关的文件\n├── CONTRIBUTING.md\n├── lib         #存放Web应用能访问的JAR包\n├── LICENSE\n├── logs        #存放tomcat日志文件\n├── NOTICE\n├── README.md\n├── RELEASE-NOTES\n├── RUNNING.txt\n├── temp        #临时文件\n├── webapps     #Web应用程序的跟目录\n└── work        #用以产生有JSP编译出的Servlet的.java和.class文件\n\n7 directories, 7 files\n```\n`webapps`目录说明：\n>这里几个目录对应着主界面的上面的按钮，可以直接在主界面查看帮助文档，及`web`界面直接管理。\n\n```\n[root@tomcat tomcat]# cd webapps/\n[root@tomcat webapps]# ll\n总用量 4\ndrwxr-x--- 14 root root 4096 6月  25 11:39 docs          #tomcat帮助文档\ndrwxr-x---  6 root root   83 6月  25 11:39 examples      #web应用实例\ndrwxr-x---  5 root root   87 6月  25 11:39 host-manager  #管理\ndrwxr-x---  5 root root  103 6月  25 11:39 manager       #管理\ndrwxr-x---  3 root root  283 6月  25 11:39 ROOT          #默认网站根目录\n```\n\n## Tomcat日志文件\n>`tomcat`一般有几个日志文件，访问的一般放在`localhost`日志文件里面，管理的日志放在`manager`日志文件里面，实时日志一般在`catalina.out`里面\n\n```\n[root@tomcat tomcat]# cd logs/\n[root@tomcat logs]# ll\n总用量 180\n-rw-r----- 1 root root 82372 6月  25 12:38 catalina.2019-06-25.log\n-rw-r----- 1 root root 82574 6月  25 12:38 catalina.out\n-rw-r----- 1 root root     0 6月  25 12:18 host-manager.2019-06-25.log\n-rw-r----- 1 root root  6246 6月  25 12:38 localhost.2019-06-25.log\n-rw-r----- 1 root root  3489 6月  25 14:30 localhost_access_log.2019-06-25.txt\n-rw-r----- 1 root root     0 6月  25 12:18 manager.2019-06-25.log\n\n[root@tomcat logs]# tailf catalina.out \n25-Jun-2019 12:38:24.674 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/apache-tomcat-9.0.21/webapps/docs] has finished in [27] ms\n25-Jun-2019 12:38:24.675 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory 把web 应用程序部署到目录 [/usr/local/apache-tomcat-9.0.21/webapps/examples]\n25-Jun-2019 12:38:25.113 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/apache-tomcat-9.0.21/webapps/examples] has finished in [438] ms\n25-Jun-2019 12:38:25.113 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory 把web 应用程序部署到目录 [/usr/local/apache-tomcat-9.0.21/webapps/host-manager]\n25-Jun-2019 12:38:25.163 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/apache-tomcat-9.0.21/webapps/host-manager] has finished in [50] ms\n25-Jun-2019 12:38:25.163 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory 把web 应用程序部署到目录 [/usr/local/apache-tomcat-9.0.21/webapps/manager]\n25-Jun-2019 12:38:25.220 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/apache-tomcat-9.0.21/webapps/manager] has finished in [57] ms\n25-Jun-2019 12:38:25.238 信息 [main] org.apache.coyote.AbstractProtocol.start 开始协议处理句柄[\"http-nio-8080\"]\n25-Jun-2019 12:38:25.298 信息 [main] org.apache.coyote.AbstractProtocol.start 开始协议处理句柄[\"ajp-nio-8009\"]\n25-Jun-2019 12:38:25.302 信息 [main] org.apache.catalina.startup.Catalina.start Server startup in [1,290] milliseconds\n```\n\n## Tomcat配置文件\n>`tomcat`配置文件存放在安装目录下的`conf`目录下面\n\n```\n# 进入到配置文件目录\n[root@tomcat ~]# cd /usr/local/tomcat/conf/\n[root@tomcat conf]# ll\n总用量 228\ndrwxr-x--- 3 root root     23 6月  25 12:18 Catalina\n-rw------- 1 root root  12873 6月   5 04:23 catalina.policy\n-rw------- 1 root root   7243 6月   5 04:23 catalina.properties\n-rw------- 1 root root   1400 6月   5 04:23 context.xml\n-rw------- 1 root root   1149 6月   5 04:23 jaspic-providers.xml\n-rw------- 1 root root   2313 6月   5 04:23 jaspic-providers.xsd\n-rw------- 1 root root   4144 6月   5 04:23 logging.properties\n-rw------- 1 root root   7511 6月   5 04:23 server.xml  #主配置文件\n-rw------- 1 root root   2164 6月   5 04:23 tomcat-users.xml  #Tomcat管理用户配置文件\n-rw------- 1 root root   2633 6月   5 04:23 tomcat-users.xsd\n-rw------- 1 root root 171962 6月   5 04:23 web.xml\n```\n### Tomcat管理\n>配置`tomcat`的`web`界面管理功能，可以进行配置文件的管理，及部署在`tomcat`上的应用进行管理，默认情况是处于禁用状态。如果要开启这个功能，需要配置管理用户，即配置`tomcat-users.xml`文件。并且还需要修改manager项目下的`content.xml`文件，让其所有地址可访问\n\n```\n# 编辑配置文件\n[root@tomcat ~]# vim /usr/local/tomcat/conf/tomcat-users.xml\n...\n<role rolename=\"manager-gui\"/>\n<role rolename=\"admin-gui\"/>\n<user username=\"tomcat\" password=\"tomcat\" roles=\"manager-gui,admin-gui\"/>\n</tomcat-users> #在这行前面加入上面三行\n\n# 编辑manager/META-INF/context.xml\n[root@tomcat ~]# vim /usr/local/tomcat/webapps/manager/META-INF/context.xml\n#将\nallow=\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\" />\n#改为\nallow=\"\\d+\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\" />\n\n# 编辑host-manager/META-INF/context.xml\n[root@tomcat ~]# vim /usr/local/tomcat/webapps/host-manager/META-INF/context.xml\n#将\nallow=\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\" />\n#改为\nallow=\"\\d+\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\" />\n\n# 重启tomcat\n[root@tomcat ~]# systemctl restart tomcat\n```\n访问测试\n![](Tomcat安装与部署/tomcat02.png)\n状态页面：\n![](Tomcat安装与部署/tomcat03.png)\nManager页面：\n![](Tomcat安装与部署/tomcat04.png)\nHost Manager页面：\n![](Tomcat安装与部署/tomcat05.png)\n\n### server.xml配置文件注释\n参考：https://www.cnblogs.com/sunshine-1/p/8990044.html\n```\n<Server port=\"8005\" shutdown=\"SHUTDOWN\">\n  <Listener className=\"org.apache.catalina.startup.VersionLoggerListener\" />\n  <Listener className=\"org.apache.catalina.security.SecurityListener\" />\n  <Listener className=\"org.apache.catalina.core.AprLifecycleListener\" SSLEngine=\"on\" /> \n  <Listener className=\"org.apache.catalina.core.JasperListener\" /> \n  <Listener className=\"org.apache.catalina.core.JreMemoryLeakPreventionListener\" /> \n  <Listener className=\"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\" /> \n  <Listener className=\"org.apache.catalina.core.ThreadLocalLeakPreventionListener\" /> \n  <GlobalNamingResources> \n  <!-- 全局命名资源，来定义一些外部访问资源，其作用是为所有引擎应用程序所引用的外部资源的定义 --!> \n    <Resource name=\"UserDatabase\" auth=\"Container\" \n              type=\"org.apache.catalina.UserDatabase\" \n              description=\"User database that can be updated and saved\" \n              factory=\"org.apache.catalina.users.MemoryUserDatabaseFactory\" \n              pathname=\"conf/tomcat-users.xml\" /> \n  </GlobalNamingResources> \n  <!-- 定义的一个名叫“UserDatabase”的认证资源，将conf/tomcat-users.xml加载至内存中，在需要认证的时候到内存中进行认证 --> \n  <Service name=\"Catalina\"> \n  <!-- # 定义Service组件，同来关联Connector和Engine，一个Engine可以对应多个Connector，每个Service中只能一个Engine --!> \n    <Connector port=\"80\" protocol=\"HTTP/1.1\" connectionTimeout=\"20000\" redirectPort=\"8443\" /> \n    <!-- 修改HTTP/1.1的Connector监听端口为80.客户端通过浏览器访问的请求，只能通过HTTP传递给tomcat。还可以设置server与URIEncoding参数 --> \n    <Connector port=\"8009\" protocol=\"AJP/1.3\" redirectPort=\"8443\" /> \n    <Engine name=\"Catalina\" defaultHost=\"test.com\"> \n    <!-- 修改当前Engine，默认主机是，www.test.com  --> \n    <Realm className=\"org.apache.catalina.realm.LockOutRealm\"> \n        <Realm className=\"org.apache.catalina.realm.UserDatabaseRealm\" \n               resourceName=\"UserDatabase\"/> \n    </Realm> \n    # Realm组件，定义对当前容器内的应用程序访问的认证，通过外部资源UserDatabase进行认证 \n      <Host name=\"test.com\"  appBase=\"/web\" unpackWARs=\"true\" autoDeploy=\"true\"> \n      <!--  定义一个主机，域名为：test.com，应用程序的目录是/web，设置自动部署，自动解压    --> \n        <Alias>www.test.com</Alias> \n        <!--    定义一个别名www.test.com，类似apache的ServerAlias --> \n        <Context path=\"\" docBase=\"www/\" reloadable=\"true\" /> \n        <!--    定义该应用程序，访问路径\"\"，即访问www.test.com即可访问，网页目录为：相对于appBase下的www/，即/web/www，并且当该应用程序下web.xml或者类等有相关变化时，自动重载当前配置，即不用重启tomcat使部署的新应用程序生效  --> \n        <Context path=\"/bbs\" docBase=\"/web/bbs\" reloadable=\"true\" /> \n        <!--  定义另外一个独立的应用程序(虚拟主机)，访问路径为：www.test.com/bbs，该应用程序网页目录为/web/bbs   --> \n        <Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"/web/www/logs\" \n               prefix=\"www_access.\" suffix=\".log\" \n               pattern=\"%h %l %u %t &quot;%r&quot; %s %b\" /> \n        <!--   定义一个Valve组件，用来记录tomcat的访问日志，日志存放目录为：/web/www/logs如果定义为相对路径则是相当于$CATALINA_HOME，并非相对于appBase，这个要注意。定义日志文件前缀为www_access.并以.log结尾，pattern定义日志内容格式，具体字段表示可以查看tomcat官方文档   --> \n      </Host> \n      <Host name=\"manager.test.com\" appBase=\"webapps\" unpackWARs=\"true\" autoDeploy=\"true\"> \n      <!--   定义一个主机名为man.test.com，应用程序目录是$CATALINA_HOME/webapps,自动解压，自动部署   --> \n        <Valve className=\"org.apache.catalina.valves.RemoteAddrValve\" allow=\"172.16.100.*\" /> \n        <!--   定义远程地址访问策略，仅允许172.16.100.*网段访问该主机，其他的将被拒绝访问  --> \n        <Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"/web/bbs/logs\" \n               prefix=\"bbs_access.\" suffix=\".log\" \n               pattern=\"%h %l %u %t &quot;%r&quot; %s %b\" /> \n        <!--   定义该主机的访问日志      --> \n      </Host> \n    </Engine> \n  </Service> \n</Server>\n```\n\n## Tomcat单实例站点部署\n>以部署`jspxcms`为例，在上面已部署的环境下继续操作。\n\n1）安装`MySQL`及创建库\n```\n[root@tomcat ~]# yum -y install mariadb mariadb-server\n[root@tomcat ~]# systemctl enable mariadb\n[root@tomcat ~]# systemctl start mariadb\n\n# 创建数据库并授权\nMariaDB [(none)]> create database jspxcms_test character set utf8;\nMariaDB [(none)]> grant all on jspxcms_test.* to 'jspxcmsuser'@'localhost' identified by '123';\nMariaDB [(none)]> flush privileges;\n```\n2）部署`jspxcms`\n```\n# tomcat默认的网站目录\n[root@tomcat ~]# ls /usr/local/tomcat/webapps/\ndocs  examples  host-manager  manager  ROOT\n[root@tomcat ~]# ls /usr/local/tomcat/webapps/ROOT/\n\n# 上传jspxcms安装包并解压\n[root@tomcat ~]# mkdir tools\n[root@tomcat tools]# ls\njspxcms-9.5.0-release.zip\n[root@tomcat tools]# unzip jspxcms-9.5.0-release.zip\n[root@tomcat tools]# ls\nCHANGELOG.txt  database  jspxcms-9.5.0-release.zip  Jspxcms安装手册.pdf  ROOT  用户许可协议.txt\n[root@tomcat tools]# rm -rf /usr/local/tomcat/webapps/*\n[root@tomcat tools]# cp -a ROOT /usr/local/tomcat/webapps/\n\n# 导入sql文件\n[root@tomcat tools]# mysql -D jspxcms_test < database/mysql.sql\n\n# 编辑配置文件配置数据库连接信息\n[root@tomcat tools]# vim /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/application.properties\nspring.datasource.url=jdbc:mysql://127.0.0.1:3306/jspxcms_test?characterEncoding=utf8\n# \\u6570\\u636E\\u5E93\\u7528\\u6237\\u540D\nspring.datasource.username=jspxcmsuser\n# \\u6570\\u636E\\u5E93\\u5BC6\\u7801\nspring.datasource.password=123\n\n# 重启tomcat\n[root@tomcat ~]# systemctl restart tomcat\n```\n3）`web`页面访问 前台地址：http://ip:8080  &emsp;后台地址：http://ip:8080/cmscp/index.do   &emsp; 默认账号：admin  密码为空\n![](Tomcat安装与部署/tomcat06.png)\n![](Tomcat安装与部署/tomcat07.png)\n\n## Tomcat多实例站点部署\n>多实例作用运行不同的应用（类似虚拟主机）\n>多实例运行相同的应用（实现负载均衡，支持高并发处理，session问题）\n>这里基于上面已安装的tomcat环境\n\n| 环境      | Web监听端口 | 管理实例端口 | 站点家目录         |\n| --------- | ----------- | ------------ | ------------------ |\n| tomcat9_1 | 8081        | 8091         | /webapps/tomcat9_1 |\n| tomcat9_2 | 8082        | 8092         | /webapps/tomcat9_2 |\n1）拷贝tomcat目录\n```\n[root@tomcat ~]# cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_1\n[root@tomcat ~]# cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_2\n```\n2）编辑配置文件，修改监听端口和站点家目录\n```\n[root@tomcat ~]# vim /usr/local/tomcat9_1/conf/server.xml\n<Server port=\"8091\" shutdown=\"SHUTDOWN\">\n<Connector port=\"8081\" protocol=\"HTTP/1.1\"\n           connectionTimeout=\"20000\"\n           redirectPort=\"8443\" />\n<Host name=\"localhost\"  appBase=\"/webapps/tomcat9_1\"\n            unpackWARs=\"true\" autoDeploy=\"true\">\n\n[root@tomcat ~]# vim /usr/local/tomcat9_2/conf/server.xml\n<Server port=\"8092\" shutdown=\"SHUTDOWN\">\n<Connector port=\"8082\" protocol=\"HTTP/1.1\"\n           connectionTimeout=\"20000\"\n           redirectPort=\"8443\" />\n<Host name=\"localhost\"  appBase=\"/webapps/tomcat9_2\"\n            unpackWARs=\"true\" autoDeploy=\"true\">\n```\n3）创建站点家目录，及测试页面准备\n```\n[root@tomcat ~]# mkdir -p /webapps/tomcat9_{1,2}\n[root@tomcat ~]# mkdir /webapps/tomcat9_{1,2}/ROOT\n\n# tomcat9_1测试页面准备\n[root@tomcat ~]# vim /webapps/tomcat9_1/ROOT/index.jsp\n<html>\n<body>\n<center>\n<H1><%=new java.util.Date()%></H1>\n<H2>tomcat9_1</H2>\n</center>\n</body>\n</html>\n\n# tomcat9_2测试页面准备\n[root@tomcat ~]# vim /webapps/tomcat9_2/ROOT/index.jsp\n<html>\n<body>\n<center>\n<H1><%=new java.util.Date()%></H1>\n<H2>tomcat9_2</H2>\n</center>\n</body>\n</html>\n```\n4）删除掉之前的站点目录里面的东西，对这里没有用了。可以直接删掉\n```\n[root@tomcat ~]# rm -rf /usr/local/tomcat9_2/webapps/*\n[root@tomcat ~]# rm -rf /usr/local/tomcat9_1/webapps/*\n```\n5）启动`tomcat1`和`tomcat2`\n```\n[root@tomcat ~]# for i in {1..2};do /usr/local/tomcat9_$i/bin/startup.sh; done\n\n# 端口查看\n[root@tomcat ~]# ss -tnlp |grep :80\nLISTEN     0      100         :::8080                    :::*                   users:((\"java\",pid=27023,fd=54))\nLISTEN     0      100         :::8081                    :::*                   users:((\"java\",pid=28687,fd=54))\nLISTEN     0      100         :::8082                    :::*                   users:((\"java\",pid=28708,fd=54))\nLISTEN     0      1         ::ffff:127.0.0.1:8091                    :::*                   users:((\"java\",pid=28687,fd=65))\nLISTEN     0      1         ::ffff:127.0.0.1:8092                    :::*                   users:((\"java\",pid=28708,fd=66))\nLISTEN     0      1         ::ffff:127.0.0.1:8005                    :::*                   users:((\"java\",pid=27023,fd=71))\nLISTEN     0      100         :::8009                    :::*                   users:((\"java\",pid=27023,fd=59)\n```\n6）访问测试\n![http://192.168.1.31:8081](Tomcat安装与部署/tomcat08.png)\n![http://192.168.1.31:8082](Tomcat安装与部署/tomcat09.png)\n\n**补充：Tomcat多实例启动脚本**\n```\n[root@tomcat ~]# cat TomcatSys.sh \n#!/bin/bash\n#Desc：用于tomcat多实例部署启动脚本。\n#Date：2019-6-26\n#by：Lee-YJ\n\nif [ \"$1\" == \"tomcat1\" ];then\n    export CATALINA_HOME=\"/usr/local/tomcat9_1\"\nelif [ \"$1\" == \"tomcat2\" ];then\n    export CATALINA_HOME=\"/usr/local/tomcat9_2\"\nelse\n    echo $\"Usage: $0 {[tomcat1|tomcat2] start|stop|restart}\" && exit\nfi\n\ncase \"$2\" in\nstart)\n    $CATALINA_HOME/bin/startup.sh\n    ;;\nstop)\n    $CATALINA_HOME/bin/shutdown.sh\n    ;;\nrestart)\n    $CATALINA_HOME/bin/shutdown.sh\n    sleep 3\n    $CATALINA_HOME/bin/startup.sh\n    ;;\n    *)\n    echo $\"Usage: $0 {[tomcat1|tomcat2] start|stop|restart}\" && exit\n    ;;\nesac\n\n# 使用说明：\n[root@tomcat ~]# ./TomcatSys.sh tomcat1 start      #启动tomcat1\n[root@tomcat ~]# ./TomcatSys.sh tomcat1 stop       #停止tomcat1\n[root@tomcat ~]# ./TomcatSys.sh tomcat2 restart    #重启tomcat2\n```\n\n\n\n","source":"_posts/Tomcat安装与部署.md","raw":"---\ntitle: Tomcat安装与部署\ndate: 2019-06-26 17:36:22\ntags: Tomcat\ncategories: Tomcat\ncopyright: true\n---\n\n## Tomcat简介\n官网：http://tomcat.apache.org/\n>`Tomcat`服务器是一个免费的开源代码的Web应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下使用，是开发和调试`JSP`程序的首选。\n>`Tomcat`和`Nginx`、`Apache`等`Web`服务器一样，具有处理`HTML`页面的功能，另外它还是一个`Servlet`和`JSP`容器，独立的`Servlet`容器是`Tomcat`的默认模式。不过，`Tomcat`处理静态`HTML`的能力不如`Nginx/Apache`服务器。\n>一般情况下多用`Nginx+Tomcat`，`Nginx`处理静态，`Tomcat`处理动态程序\n\n## Tomcat安装\n>软件下载：[JDK下载](https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html)  &emsp; [Tomcat下载](http://tomcat.apache.org/)\n>本文使用的软件包`jdk-8u211`,`tomcat-9.0.21`。 [下载链接](https://pan.baidu.com/s/1d0g0T75p-CW7uz3ug7I8YA) &emsp; 提取码：f0ay\n\n### 部署Java环境\n将下载的软件包上传到服务器\n```\n# 解压软件包\n[root@tomcat ~]# tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/\n\n# 创建一个软链接\n[root@tomcat ~]# ln -s /usr/local/jdk1.8.0_211 /usr/local/java\n\n# 添加环境变量\n[root@tomcat ~]# sed -i.ori '$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile\n\n# 重新加载环境变量\n[root@tomcat ~]# source /etc/profile\n[root@tomcat ~]# env |grep JAVA\nJAVA_HOME=/usr/local/java\n\n# 查看是否安装成功\n[root@tomcat ~]# java -version\njava version \"1.8.0_211\"\nJava(TM) SE Runtime Environment (build 1.8.0_211-b12)\nJava HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)\n```\n\n### 部署Tomcat\n```\n# 解压软件包\n[root@tomcat ~]# tar xf apache-tomcat-9.0.21.tar.gz -C /usr/local/\n\n# 创建一个软链接\n[root@tomcat ~]# ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat\n\n# 定义tomcat所需的环境变量\n[root@tomcat ~]# echo \"export TOMCAT_HOME=/usr/local/tomcat\" >> /etc/profile\n\n# 重新加载环境变量\n[root@tomcat ~]# source /etc/profile\n```\n\n## Tomcat启动\n1）默认的启动方式\n```\n[root@tomcat ~]# ls /usr/local/tomcat/bin/startup.sh   #启动脚本\n/usr/local/tomcat/bin/startup.sh\n[root@tomcat ~]# ls /usr/local/tomcat/bin/shutdown.sh   #停止脚本\n/usr/local/tomcat/bin/shutdown.sh\n\n# 默认方式启动\n[root@tomcat ~]# /usr/local/tomcat/bin/startup.sh \nUsing CATALINA_BASE:   /usr/local/tomcat\nUsing CATALINA_HOME:   /usr/local/tomcat\nUsing CATALINA_TMPDIR: /usr/local/tomcat/temp\nUsing JRE_HOME:        /usr/local/java\nUsing CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar\nTomcat started.\n\n# 默认方式停止\n[root@tomcat ~]# /usr/local/tomcat/bin/shutdown.sh \nUsing CATALINA_BASE:   /usr/local/tomcat\nUsing CATALINA_HOME:   /usr/local/tomcat\nUsing CATALINA_TMPDIR: /usr/local/tomcat/temp\nUsing JRE_HOME:        /usr/local/java\nUsing CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar\n```\n2）加入`/etc/init.d/`支持`centos6`的`service`\n```\n# 编辑/etc/init.d/tomcat脚本\n[root@tomcat ~]# vim /etc/init.d/tomcat\n#!/bin/bash\n# Init file for Tomcat server daemon\n#\n# chkconfig: 2345 96 14\n# description: Tomcat server daemon\nJAVA_OPTS='-Xms64m -Xmx128m'\nJAVA_HOME=/usr/local/jdk1.8.0_211      #指定jdk安装路径\nCATALINA_HOME=/usr/local/tomcat     #指定tomcat安装路径\nexport JAVA_OPTS JAVA_HOME CATALINA_HOME\nexec $CATALINA_HOME/bin/catalina.sh $*\n\n# 添加执行权限\n[root@tomcat ~]# chmod +x /etc/init.d/tomcat\n\n# 启动停止测试\n[root@tomcat ~]# service tomcat start\nUsing CATALINA_BASE:   /usr/local/tomcat\nUsing CATALINA_HOME:   /usr/local/tomcat\nUsing CATALINA_TMPDIR: /usr/local/tomcat/temp\nUsing JRE_HOME:        /usr/local/jdk1.8.0_211\nUsing CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar\nTomcat started.\n[root@tomcat ~]# \n[root@tomcat ~]# service tomcat stop\nUsing CATALINA_BASE:   /usr/local/tomcat\nUsing CATALINA_HOME:   /usr/local/tomcat\nUsing CATALINA_TMPDIR: /usr/local/tomcat/temp\nUsing JRE_HOME:        /usr/local/jdk1.8.0_211\nUsing CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar\n```\n3）加入`systemd`管理`tomcat`\n```\n# 编辑启动脚本\n[root@tomcat ~]# vim /usr/lib/systemd/system/tomcat.service\n[Unit]\nDescription=Tomcat server daemon\nAfter=syslog.target network.target remote-fs.target nss-lookup.target\n\n[Service]\nType=oneshot\nExecStart=/usr/local/tomcat/bin/startup.sh\nExecStop=/usr/local/tomcat/bin/shutdown.sh\nExecReload=/bin/kill -HUP $MAINPID\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\n\n# 测试启动和关闭\n[root@tomcat ~]# systemctl start tomcat\n[root@tomcat ~]# ps -ef |grep tomcat\nroot       4810      1 35 12:37 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start\nroot       4852   1823  0 12:37 pts/1    00:00:00 grep --color=auto tomcat\n[root@tomcat ~]# \n[root@tomcat ~]# systemctl stop tomcat\n[root@tomcat ~]# ps -ef |grep tomcat\nroot       4888   1823  0 12:38 pts/1    00:00:00 grep --color=auto tomcat\n[root@tomcat ~]# \n[root@tomcat ~]# systemctl restart tomcat \n[root@tomcat ~]# ps -ef |grep tomcat\nroot       4909      1 43 12:38 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start\nroot       4959   1823  0 12:38 pts/1    00:00:00 grep --color=auto tomcat\n[root@tomcat ~]#\n[root@tomcat ~]# systemctl status tomcat\n● tomcat.service - Tomcat server daemon\n   Loaded: loaded (/usr/lib/systemd/system/tomcat.service; disabled; vendor preset: disabled)\n   Active: active (exited) since 二 2019-06-25 12:38:22 CST; 3min 53s ago\n  Process: 4895 ExecStart=/usr/local/tomcat/bin/startup.sh (code=exited, status=0/SUCCESS)\n Main PID: 4895 (code=exited, status=0/SUCCESS)\n   CGroup: /system.slice/tomcat.service\n           └─4909 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.pro...\n\n6月 25 12:38:22 tomcat systemd[1]: Starting Tomcat server daemon...\n6月 25 12:38:22 tomcat startup.sh[4895]: Tomcat started.\n6月 25 12:38:22 tomcat systemd[1]: Started Tomcat server daemon.\n\n# 加入开机启动\n[root@tomcat ~]# systemctl enable tomcat\n[root@tomcat ~]# systemctl list-unit-files  |grep tomcat\ntomcat.service                                enabled\n```\ntomcat启动成功后默认端口为：8080，访问地址http://ip:8080\n![](Tomcat安装与部署/tomcat01.png)\n\n## Tomcat目录结构\n`tomcat`安装主目录下的各个子目录说明：\n```\n[root@tomcat ~]# cd /usr/local/tomcat/\n[root@tomcat tomcat]# tree -L 1\n.\n├── bin\t\t\t#存放启动、关闭tomcat或者其它功能的脚本(.bat文件和.sh文件)\n├── BUILDING.txt\n├── conf        #存放tomcat配置相关的文件\n├── CONTRIBUTING.md\n├── lib         #存放Web应用能访问的JAR包\n├── LICENSE\n├── logs        #存放tomcat日志文件\n├── NOTICE\n├── README.md\n├── RELEASE-NOTES\n├── RUNNING.txt\n├── temp        #临时文件\n├── webapps     #Web应用程序的跟目录\n└── work        #用以产生有JSP编译出的Servlet的.java和.class文件\n\n7 directories, 7 files\n```\n`webapps`目录说明：\n>这里几个目录对应着主界面的上面的按钮，可以直接在主界面查看帮助文档，及`web`界面直接管理。\n\n```\n[root@tomcat tomcat]# cd webapps/\n[root@tomcat webapps]# ll\n总用量 4\ndrwxr-x--- 14 root root 4096 6月  25 11:39 docs          #tomcat帮助文档\ndrwxr-x---  6 root root   83 6月  25 11:39 examples      #web应用实例\ndrwxr-x---  5 root root   87 6月  25 11:39 host-manager  #管理\ndrwxr-x---  5 root root  103 6月  25 11:39 manager       #管理\ndrwxr-x---  3 root root  283 6月  25 11:39 ROOT          #默认网站根目录\n```\n\n## Tomcat日志文件\n>`tomcat`一般有几个日志文件，访问的一般放在`localhost`日志文件里面，管理的日志放在`manager`日志文件里面，实时日志一般在`catalina.out`里面\n\n```\n[root@tomcat tomcat]# cd logs/\n[root@tomcat logs]# ll\n总用量 180\n-rw-r----- 1 root root 82372 6月  25 12:38 catalina.2019-06-25.log\n-rw-r----- 1 root root 82574 6月  25 12:38 catalina.out\n-rw-r----- 1 root root     0 6月  25 12:18 host-manager.2019-06-25.log\n-rw-r----- 1 root root  6246 6月  25 12:38 localhost.2019-06-25.log\n-rw-r----- 1 root root  3489 6月  25 14:30 localhost_access_log.2019-06-25.txt\n-rw-r----- 1 root root     0 6月  25 12:18 manager.2019-06-25.log\n\n[root@tomcat logs]# tailf catalina.out \n25-Jun-2019 12:38:24.674 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/apache-tomcat-9.0.21/webapps/docs] has finished in [27] ms\n25-Jun-2019 12:38:24.675 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory 把web 应用程序部署到目录 [/usr/local/apache-tomcat-9.0.21/webapps/examples]\n25-Jun-2019 12:38:25.113 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/apache-tomcat-9.0.21/webapps/examples] has finished in [438] ms\n25-Jun-2019 12:38:25.113 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory 把web 应用程序部署到目录 [/usr/local/apache-tomcat-9.0.21/webapps/host-manager]\n25-Jun-2019 12:38:25.163 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/apache-tomcat-9.0.21/webapps/host-manager] has finished in [50] ms\n25-Jun-2019 12:38:25.163 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory 把web 应用程序部署到目录 [/usr/local/apache-tomcat-9.0.21/webapps/manager]\n25-Jun-2019 12:38:25.220 信息 [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/apache-tomcat-9.0.21/webapps/manager] has finished in [57] ms\n25-Jun-2019 12:38:25.238 信息 [main] org.apache.coyote.AbstractProtocol.start 开始协议处理句柄[\"http-nio-8080\"]\n25-Jun-2019 12:38:25.298 信息 [main] org.apache.coyote.AbstractProtocol.start 开始协议处理句柄[\"ajp-nio-8009\"]\n25-Jun-2019 12:38:25.302 信息 [main] org.apache.catalina.startup.Catalina.start Server startup in [1,290] milliseconds\n```\n\n## Tomcat配置文件\n>`tomcat`配置文件存放在安装目录下的`conf`目录下面\n\n```\n# 进入到配置文件目录\n[root@tomcat ~]# cd /usr/local/tomcat/conf/\n[root@tomcat conf]# ll\n总用量 228\ndrwxr-x--- 3 root root     23 6月  25 12:18 Catalina\n-rw------- 1 root root  12873 6月   5 04:23 catalina.policy\n-rw------- 1 root root   7243 6月   5 04:23 catalina.properties\n-rw------- 1 root root   1400 6月   5 04:23 context.xml\n-rw------- 1 root root   1149 6月   5 04:23 jaspic-providers.xml\n-rw------- 1 root root   2313 6月   5 04:23 jaspic-providers.xsd\n-rw------- 1 root root   4144 6月   5 04:23 logging.properties\n-rw------- 1 root root   7511 6月   5 04:23 server.xml  #主配置文件\n-rw------- 1 root root   2164 6月   5 04:23 tomcat-users.xml  #Tomcat管理用户配置文件\n-rw------- 1 root root   2633 6月   5 04:23 tomcat-users.xsd\n-rw------- 1 root root 171962 6月   5 04:23 web.xml\n```\n### Tomcat管理\n>配置`tomcat`的`web`界面管理功能，可以进行配置文件的管理，及部署在`tomcat`上的应用进行管理，默认情况是处于禁用状态。如果要开启这个功能，需要配置管理用户，即配置`tomcat-users.xml`文件。并且还需要修改manager项目下的`content.xml`文件，让其所有地址可访问\n\n```\n# 编辑配置文件\n[root@tomcat ~]# vim /usr/local/tomcat/conf/tomcat-users.xml\n...\n<role rolename=\"manager-gui\"/>\n<role rolename=\"admin-gui\"/>\n<user username=\"tomcat\" password=\"tomcat\" roles=\"manager-gui,admin-gui\"/>\n</tomcat-users> #在这行前面加入上面三行\n\n# 编辑manager/META-INF/context.xml\n[root@tomcat ~]# vim /usr/local/tomcat/webapps/manager/META-INF/context.xml\n#将\nallow=\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\" />\n#改为\nallow=\"\\d+\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\" />\n\n# 编辑host-manager/META-INF/context.xml\n[root@tomcat ~]# vim /usr/local/tomcat/webapps/host-manager/META-INF/context.xml\n#将\nallow=\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\" />\n#改为\nallow=\"\\d+\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\" />\n\n# 重启tomcat\n[root@tomcat ~]# systemctl restart tomcat\n```\n访问测试\n![](Tomcat安装与部署/tomcat02.png)\n状态页面：\n![](Tomcat安装与部署/tomcat03.png)\nManager页面：\n![](Tomcat安装与部署/tomcat04.png)\nHost Manager页面：\n![](Tomcat安装与部署/tomcat05.png)\n\n### server.xml配置文件注释\n参考：https://www.cnblogs.com/sunshine-1/p/8990044.html\n```\n<Server port=\"8005\" shutdown=\"SHUTDOWN\">\n  <Listener className=\"org.apache.catalina.startup.VersionLoggerListener\" />\n  <Listener className=\"org.apache.catalina.security.SecurityListener\" />\n  <Listener className=\"org.apache.catalina.core.AprLifecycleListener\" SSLEngine=\"on\" /> \n  <Listener className=\"org.apache.catalina.core.JasperListener\" /> \n  <Listener className=\"org.apache.catalina.core.JreMemoryLeakPreventionListener\" /> \n  <Listener className=\"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\" /> \n  <Listener className=\"org.apache.catalina.core.ThreadLocalLeakPreventionListener\" /> \n  <GlobalNamingResources> \n  <!-- 全局命名资源，来定义一些外部访问资源，其作用是为所有引擎应用程序所引用的外部资源的定义 --!> \n    <Resource name=\"UserDatabase\" auth=\"Container\" \n              type=\"org.apache.catalina.UserDatabase\" \n              description=\"User database that can be updated and saved\" \n              factory=\"org.apache.catalina.users.MemoryUserDatabaseFactory\" \n              pathname=\"conf/tomcat-users.xml\" /> \n  </GlobalNamingResources> \n  <!-- 定义的一个名叫“UserDatabase”的认证资源，将conf/tomcat-users.xml加载至内存中，在需要认证的时候到内存中进行认证 --> \n  <Service name=\"Catalina\"> \n  <!-- # 定义Service组件，同来关联Connector和Engine，一个Engine可以对应多个Connector，每个Service中只能一个Engine --!> \n    <Connector port=\"80\" protocol=\"HTTP/1.1\" connectionTimeout=\"20000\" redirectPort=\"8443\" /> \n    <!-- 修改HTTP/1.1的Connector监听端口为80.客户端通过浏览器访问的请求，只能通过HTTP传递给tomcat。还可以设置server与URIEncoding参数 --> \n    <Connector port=\"8009\" protocol=\"AJP/1.3\" redirectPort=\"8443\" /> \n    <Engine name=\"Catalina\" defaultHost=\"test.com\"> \n    <!-- 修改当前Engine，默认主机是，www.test.com  --> \n    <Realm className=\"org.apache.catalina.realm.LockOutRealm\"> \n        <Realm className=\"org.apache.catalina.realm.UserDatabaseRealm\" \n               resourceName=\"UserDatabase\"/> \n    </Realm> \n    # Realm组件，定义对当前容器内的应用程序访问的认证，通过外部资源UserDatabase进行认证 \n      <Host name=\"test.com\"  appBase=\"/web\" unpackWARs=\"true\" autoDeploy=\"true\"> \n      <!--  定义一个主机，域名为：test.com，应用程序的目录是/web，设置自动部署，自动解压    --> \n        <Alias>www.test.com</Alias> \n        <!--    定义一个别名www.test.com，类似apache的ServerAlias --> \n        <Context path=\"\" docBase=\"www/\" reloadable=\"true\" /> \n        <!--    定义该应用程序，访问路径\"\"，即访问www.test.com即可访问，网页目录为：相对于appBase下的www/，即/web/www，并且当该应用程序下web.xml或者类等有相关变化时，自动重载当前配置，即不用重启tomcat使部署的新应用程序生效  --> \n        <Context path=\"/bbs\" docBase=\"/web/bbs\" reloadable=\"true\" /> \n        <!--  定义另外一个独立的应用程序(虚拟主机)，访问路径为：www.test.com/bbs，该应用程序网页目录为/web/bbs   --> \n        <Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"/web/www/logs\" \n               prefix=\"www_access.\" suffix=\".log\" \n               pattern=\"%h %l %u %t &quot;%r&quot; %s %b\" /> \n        <!--   定义一个Valve组件，用来记录tomcat的访问日志，日志存放目录为：/web/www/logs如果定义为相对路径则是相当于$CATALINA_HOME，并非相对于appBase，这个要注意。定义日志文件前缀为www_access.并以.log结尾，pattern定义日志内容格式，具体字段表示可以查看tomcat官方文档   --> \n      </Host> \n      <Host name=\"manager.test.com\" appBase=\"webapps\" unpackWARs=\"true\" autoDeploy=\"true\"> \n      <!--   定义一个主机名为man.test.com，应用程序目录是$CATALINA_HOME/webapps,自动解压，自动部署   --> \n        <Valve className=\"org.apache.catalina.valves.RemoteAddrValve\" allow=\"172.16.100.*\" /> \n        <!--   定义远程地址访问策略，仅允许172.16.100.*网段访问该主机，其他的将被拒绝访问  --> \n        <Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"/web/bbs/logs\" \n               prefix=\"bbs_access.\" suffix=\".log\" \n               pattern=\"%h %l %u %t &quot;%r&quot; %s %b\" /> \n        <!--   定义该主机的访问日志      --> \n      </Host> \n    </Engine> \n  </Service> \n</Server>\n```\n\n## Tomcat单实例站点部署\n>以部署`jspxcms`为例，在上面已部署的环境下继续操作。\n\n1）安装`MySQL`及创建库\n```\n[root@tomcat ~]# yum -y install mariadb mariadb-server\n[root@tomcat ~]# systemctl enable mariadb\n[root@tomcat ~]# systemctl start mariadb\n\n# 创建数据库并授权\nMariaDB [(none)]> create database jspxcms_test character set utf8;\nMariaDB [(none)]> grant all on jspxcms_test.* to 'jspxcmsuser'@'localhost' identified by '123';\nMariaDB [(none)]> flush privileges;\n```\n2）部署`jspxcms`\n```\n# tomcat默认的网站目录\n[root@tomcat ~]# ls /usr/local/tomcat/webapps/\ndocs  examples  host-manager  manager  ROOT\n[root@tomcat ~]# ls /usr/local/tomcat/webapps/ROOT/\n\n# 上传jspxcms安装包并解压\n[root@tomcat ~]# mkdir tools\n[root@tomcat tools]# ls\njspxcms-9.5.0-release.zip\n[root@tomcat tools]# unzip jspxcms-9.5.0-release.zip\n[root@tomcat tools]# ls\nCHANGELOG.txt  database  jspxcms-9.5.0-release.zip  Jspxcms安装手册.pdf  ROOT  用户许可协议.txt\n[root@tomcat tools]# rm -rf /usr/local/tomcat/webapps/*\n[root@tomcat tools]# cp -a ROOT /usr/local/tomcat/webapps/\n\n# 导入sql文件\n[root@tomcat tools]# mysql -D jspxcms_test < database/mysql.sql\n\n# 编辑配置文件配置数据库连接信息\n[root@tomcat tools]# vim /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/application.properties\nspring.datasource.url=jdbc:mysql://127.0.0.1:3306/jspxcms_test?characterEncoding=utf8\n# \\u6570\\u636E\\u5E93\\u7528\\u6237\\u540D\nspring.datasource.username=jspxcmsuser\n# \\u6570\\u636E\\u5E93\\u5BC6\\u7801\nspring.datasource.password=123\n\n# 重启tomcat\n[root@tomcat ~]# systemctl restart tomcat\n```\n3）`web`页面访问 前台地址：http://ip:8080  &emsp;后台地址：http://ip:8080/cmscp/index.do   &emsp; 默认账号：admin  密码为空\n![](Tomcat安装与部署/tomcat06.png)\n![](Tomcat安装与部署/tomcat07.png)\n\n## Tomcat多实例站点部署\n>多实例作用运行不同的应用（类似虚拟主机）\n>多实例运行相同的应用（实现负载均衡，支持高并发处理，session问题）\n>这里基于上面已安装的tomcat环境\n\n| 环境      | Web监听端口 | 管理实例端口 | 站点家目录         |\n| --------- | ----------- | ------------ | ------------------ |\n| tomcat9_1 | 8081        | 8091         | /webapps/tomcat9_1 |\n| tomcat9_2 | 8082        | 8092         | /webapps/tomcat9_2 |\n1）拷贝tomcat目录\n```\n[root@tomcat ~]# cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_1\n[root@tomcat ~]# cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_2\n```\n2）编辑配置文件，修改监听端口和站点家目录\n```\n[root@tomcat ~]# vim /usr/local/tomcat9_1/conf/server.xml\n<Server port=\"8091\" shutdown=\"SHUTDOWN\">\n<Connector port=\"8081\" protocol=\"HTTP/1.1\"\n           connectionTimeout=\"20000\"\n           redirectPort=\"8443\" />\n<Host name=\"localhost\"  appBase=\"/webapps/tomcat9_1\"\n            unpackWARs=\"true\" autoDeploy=\"true\">\n\n[root@tomcat ~]# vim /usr/local/tomcat9_2/conf/server.xml\n<Server port=\"8092\" shutdown=\"SHUTDOWN\">\n<Connector port=\"8082\" protocol=\"HTTP/1.1\"\n           connectionTimeout=\"20000\"\n           redirectPort=\"8443\" />\n<Host name=\"localhost\"  appBase=\"/webapps/tomcat9_2\"\n            unpackWARs=\"true\" autoDeploy=\"true\">\n```\n3）创建站点家目录，及测试页面准备\n```\n[root@tomcat ~]# mkdir -p /webapps/tomcat9_{1,2}\n[root@tomcat ~]# mkdir /webapps/tomcat9_{1,2}/ROOT\n\n# tomcat9_1测试页面准备\n[root@tomcat ~]# vim /webapps/tomcat9_1/ROOT/index.jsp\n<html>\n<body>\n<center>\n<H1><%=new java.util.Date()%></H1>\n<H2>tomcat9_1</H2>\n</center>\n</body>\n</html>\n\n# tomcat9_2测试页面准备\n[root@tomcat ~]# vim /webapps/tomcat9_2/ROOT/index.jsp\n<html>\n<body>\n<center>\n<H1><%=new java.util.Date()%></H1>\n<H2>tomcat9_2</H2>\n</center>\n</body>\n</html>\n```\n4）删除掉之前的站点目录里面的东西，对这里没有用了。可以直接删掉\n```\n[root@tomcat ~]# rm -rf /usr/local/tomcat9_2/webapps/*\n[root@tomcat ~]# rm -rf /usr/local/tomcat9_1/webapps/*\n```\n5）启动`tomcat1`和`tomcat2`\n```\n[root@tomcat ~]# for i in {1..2};do /usr/local/tomcat9_$i/bin/startup.sh; done\n\n# 端口查看\n[root@tomcat ~]# ss -tnlp |grep :80\nLISTEN     0      100         :::8080                    :::*                   users:((\"java\",pid=27023,fd=54))\nLISTEN     0      100         :::8081                    :::*                   users:((\"java\",pid=28687,fd=54))\nLISTEN     0      100         :::8082                    :::*                   users:((\"java\",pid=28708,fd=54))\nLISTEN     0      1         ::ffff:127.0.0.1:8091                    :::*                   users:((\"java\",pid=28687,fd=65))\nLISTEN     0      1         ::ffff:127.0.0.1:8092                    :::*                   users:((\"java\",pid=28708,fd=66))\nLISTEN     0      1         ::ffff:127.0.0.1:8005                    :::*                   users:((\"java\",pid=27023,fd=71))\nLISTEN     0      100         :::8009                    :::*                   users:((\"java\",pid=27023,fd=59)\n```\n6）访问测试\n![http://192.168.1.31:8081](Tomcat安装与部署/tomcat08.png)\n![http://192.168.1.31:8082](Tomcat安装与部署/tomcat09.png)\n\n**补充：Tomcat多实例启动脚本**\n```\n[root@tomcat ~]# cat TomcatSys.sh \n#!/bin/bash\n#Desc：用于tomcat多实例部署启动脚本。\n#Date：2019-6-26\n#by：Lee-YJ\n\nif [ \"$1\" == \"tomcat1\" ];then\n    export CATALINA_HOME=\"/usr/local/tomcat9_1\"\nelif [ \"$1\" == \"tomcat2\" ];then\n    export CATALINA_HOME=\"/usr/local/tomcat9_2\"\nelse\n    echo $\"Usage: $0 {[tomcat1|tomcat2] start|stop|restart}\" && exit\nfi\n\ncase \"$2\" in\nstart)\n    $CATALINA_HOME/bin/startup.sh\n    ;;\nstop)\n    $CATALINA_HOME/bin/shutdown.sh\n    ;;\nrestart)\n    $CATALINA_HOME/bin/shutdown.sh\n    sleep 3\n    $CATALINA_HOME/bin/startup.sh\n    ;;\n    *)\n    echo $\"Usage: $0 {[tomcat1|tomcat2] start|stop|restart}\" && exit\n    ;;\nesac\n\n# 使用说明：\n[root@tomcat ~]# ./TomcatSys.sh tomcat1 start      #启动tomcat1\n[root@tomcat ~]# ./TomcatSys.sh tomcat1 stop       #停止tomcat1\n[root@tomcat ~]# ./TomcatSys.sh tomcat2 restart    #重启tomcat2\n```\n\n\n\n","slug":"Tomcat安装与部署","published":1,"updated":"2019-07-10T01:46:29.992Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjxwlqrqj002ilctcnqawjqtj","content":"<h2 id=\"Tomcat简介\"><a href=\"#Tomcat简介\" class=\"headerlink\" title=\"Tomcat简介\"></a>Tomcat简介</h2><p>官网：<a href=\"http://tomcat.apache.org/\" target=\"_blank\" rel=\"noopener\">http://tomcat.apache.org/</a></p>\n<blockquote>\n<p><code>Tomcat</code>服务器是一个免费的开源代码的Web应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下使用，是开发和调试<code>JSP</code>程序的首选。<br><code>Tomcat</code>和<code>Nginx</code>、<code>Apache</code>等<code>Web</code>服务器一样，具有处理<code>HTML</code>页面的功能，另外它还是一个<code>Servlet</code>和<code>JSP</code>容器，独立的<code>Servlet</code>容器是<code>Tomcat</code>的默认模式。不过，<code>Tomcat</code>处理静态<code>HTML</code>的能力不如<code>Nginx/Apache</code>服务器。<br>一般情况下多用<code>Nginx+Tomcat</code>，<code>Nginx</code>处理静态，<code>Tomcat</code>处理动态程序</p>\n</blockquote>\n<h2 id=\"Tomcat安装\"><a href=\"#Tomcat安装\" class=\"headerlink\" title=\"Tomcat安装\"></a>Tomcat安装</h2><blockquote>\n<p>软件下载：<a href=\"https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html\" target=\"_blank\" rel=\"noopener\">JDK下载</a>  &emsp; <a href=\"http://tomcat.apache.org/\" target=\"_blank\" rel=\"noopener\">Tomcat下载</a><br>本文使用的软件包<code>jdk-8u211</code>,<code>tomcat-9.0.21</code>。 <a href=\"https://pan.baidu.com/s/1d0g0T75p-CW7uz3ug7I8YA\" target=\"_blank\" rel=\"noopener\">下载链接</a> &emsp; 提取码：f0ay</p>\n</blockquote>\n<h3 id=\"部署Java环境\"><a href=\"#部署Java环境\" class=\"headerlink\" title=\"部署Java环境\"></a>部署Java环境</h3><p>将下载的软件包上传到服务器<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 解压软件包</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个软链接</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># ln -s /usr/local/jdk1.8.0_211 /usr/local/java</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加环境变量</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># sed -i.ori '$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重新加载环境变量</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># env |grep JAVA</span></span><br><span class=\"line\"><span class=\"keyword\">JAVA_HOME=/usr/local/java</span></span><br><span class=\"line\"><span class=\"keyword\"></span></span><br><span class=\"line\"><span class=\"keyword\"># </span>查看是否安装成功</span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># java -version</span></span><br><span class=\"line\"><span class=\"keyword\">java </span>version <span class=\"string\">\"1.8.0_211\"</span></span><br><span class=\"line\"><span class=\"keyword\">Java(TM) </span>SE Runtime Environment (<span class=\"keyword\">build </span><span class=\"number\">1</span>.<span class=\"number\">8</span>.<span class=\"number\">0</span>_211-<span class=\"keyword\">b12)</span></span><br><span class=\"line\"><span class=\"keyword\">Java </span>HotSpot(TM) <span class=\"number\">64</span>-<span class=\"keyword\">Bit </span>Server VM (<span class=\"keyword\">build </span><span class=\"number\">25</span>.<span class=\"number\">211</span>-<span class=\"keyword\">b12, </span>mixed mode)</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"部署Tomcat\"><a href=\"#部署Tomcat\" class=\"headerlink\" title=\"部署Tomcat\"></a>部署Tomcat</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 解压软件包</span></span><br><span class=\"line\">[root@tomcat ~]# tar xf apache-tomcat-9.0.21.tar.gz -C /usr/local/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个软链接</span></span><br><span class=\"line\">[root@tomcat ~]# ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义tomcat所需的环境变量</span></span><br><span class=\"line\">[root@tomcat ~]# echo <span class=\"string\">\"export TOMCAT_HOME=/usr/local/tomcat\"</span> &gt;&gt; /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重新加载环境变量</span></span><br><span class=\"line\">[root@tomcat ~]# source /etc/profile</span><br></pre></td></tr></table></figure>\n<h2 id=\"Tomcat启动\"><a href=\"#Tomcat启动\" class=\"headerlink\" title=\"Tomcat启动\"></a>Tomcat启动</h2><p>1）默认的启动方式<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat ~]<span class=\"meta\"># ls /usr/local/tomcat/bin/startup.sh   #启动脚本</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/startup.sh</span><br><span class=\"line\">[root@tomcat ~]<span class=\"meta\"># ls /usr/local/tomcat/bin/shutdown.sh   #停止脚本</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/shutdown.sh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 默认方式启动</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"meta\"># /usr/local/tomcat/bin/startup.sh </span></span><br><span class=\"line\">Using CATALINA_BASE:   <span class=\"meta-keyword\">/usr/</span>local/tomcat</span><br><span class=\"line\">Using CATALINA_HOME:   <span class=\"meta-keyword\">/usr/</span>local/tomcat</span><br><span class=\"line\">Using CATALINA_TMPDIR: <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>temp</span><br><span class=\"line\">Using JRE_HOME:        <span class=\"meta-keyword\">/usr/</span>local/java</span><br><span class=\"line\">Using CLASSPATH:       <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/bootstrap.jar:<span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/tomcat-juli.jar</span><br><span class=\"line\">Tomcat started.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 默认方式停止</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"meta\"># /usr/local/tomcat/bin/shutdown.sh </span></span><br><span class=\"line\">Using CATALINA_BASE:   <span class=\"meta-keyword\">/usr/</span>local/tomcat</span><br><span class=\"line\">Using CATALINA_HOME:   <span class=\"meta-keyword\">/usr/</span>local/tomcat</span><br><span class=\"line\">Using CATALINA_TMPDIR: <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>temp</span><br><span class=\"line\">Using JRE_HOME:        <span class=\"meta-keyword\">/usr/</span>local/java</span><br><span class=\"line\">Using CLASSPATH:       <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/bootstrap.jar:<span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/tomcat-juli.jar</span><br></pre></td></tr></table></figure></p>\n<p>2）加入<code>/etc/init.d/</code>支持<code>centos6</code>的<code>service</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑/etc/init.d/tomcat脚本</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># vim /etc/init.d/tomcat</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># Init file for Tomcat server daemon</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># chkconfig: 2345 96 14</span></span><br><span class=\"line\"><span class=\"comment\"># description: Tomcat server daemon</span></span><br><span class=\"line\">JAVA_OPTS=<span class=\"string\">'-Xms64m -Xmx128m'</span></span><br><span class=\"line\">JAVA_HOME=/usr/<span class=\"built_in\">local</span>/jdk1.8.0_211      <span class=\"comment\">#指定jdk安装路径</span></span><br><span class=\"line\">CATALINA_HOME=/usr/<span class=\"built_in\">local</span>/tomcat     <span class=\"comment\">#指定tomcat安装路径</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_OPTS JAVA_HOME CATALINA_HOME</span><br><span class=\"line\"><span class=\"built_in\">exec</span> <span class=\"variable\">$CATALINA_HOME</span>/bin/catalina.sh $*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加执行权限</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># chmod +x /etc/init.d/tomcat</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动停止测试</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># service tomcat start</span></span><br><span class=\"line\">Using CATALINA_BASE:   /usr/<span class=\"built_in\">local</span>/tomcat</span><br><span class=\"line\">Using CATALINA_HOME:   /usr/<span class=\"built_in\">local</span>/tomcat</span><br><span class=\"line\">Using CATALINA_TMPDIR: /usr/<span class=\"built_in\">local</span>/tomcat/temp</span><br><span class=\"line\">Using JRE_HOME:        /usr/<span class=\"built_in\">local</span>/jdk1.8.0_211</span><br><span class=\"line\">Using CLASSPATH:       /usr/<span class=\"built_in\">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class=\"built_in\">local</span>/tomcat/bin/tomcat-juli.jar</span><br><span class=\"line\">Tomcat started.</span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># </span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># service tomcat stop</span></span><br><span class=\"line\">Using CATALINA_BASE:   /usr/<span class=\"built_in\">local</span>/tomcat</span><br><span class=\"line\">Using CATALINA_HOME:   /usr/<span class=\"built_in\">local</span>/tomcat</span><br><span class=\"line\">Using CATALINA_TMPDIR: /usr/<span class=\"built_in\">local</span>/tomcat/temp</span><br><span class=\"line\">Using JRE_HOME:        /usr/<span class=\"built_in\">local</span>/jdk1.8.0_211</span><br><span class=\"line\">Using CLASSPATH:       /usr/<span class=\"built_in\">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class=\"built_in\">local</span>/tomcat/bin/tomcat-juli.jar</span><br></pre></td></tr></table></figure></p>\n<p>3）加入<code>systemd</code>管理<code>tomcat</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑启动脚本</span></span><br><span class=\"line\">[root@tomcat ~]# vim /usr/lib/systemd/system/tomcat.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\"><span class=\"attribute\">Description</span>=Tomcat<span class=\"built_in\"> server </span>daemon</span><br><span class=\"line\"><span class=\"attribute\">After</span>=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\"><span class=\"attribute\">Type</span>=oneshot</span><br><span class=\"line\"><span class=\"attribute\">ExecStart</span>=/usr/local/tomcat/bin/startup.sh</span><br><span class=\"line\"><span class=\"attribute\">ExecStop</span>=/usr/local/tomcat/bin/shutdown.sh</span><br><span class=\"line\"><span class=\"attribute\">ExecReload</span>=/bin/kill -HUP <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\"><span class=\"attribute\">RemainAfterExit</span>=<span class=\"literal\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\"><span class=\"attribute\">WantedBy</span>=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 测试启动和关闭</span></span><br><span class=\"line\">[root@tomcat ~]# systemctl start tomcat</span><br><span class=\"line\">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class=\"line\">root       4810      1 35 12:37 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.<span class=\"attribute\">file</span>=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.<span class=\"attribute\">manager</span>=org.apache.juli.ClassLoaderLogManager -Djdk.tls.<span class=\"attribute\">ephemeralDHKeySize</span>=2048 -Djava.protocol.handler.<span class=\"attribute\">pkgs</span>=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.<span class=\"attribute\">UMASK</span>=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.<span class=\"attribute\">base</span>=/usr/local/tomcat -Dcatalina.<span class=\"attribute\">home</span>=/usr/local/tomcat -Djava.io.<span class=\"attribute\">tmpdir</span>=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class=\"line\">root       4852   1823  0 12:37 pts/1    00:00:00 grep <span class=\"attribute\">--color</span>=auto tomcat</span><br><span class=\"line\">[root@tomcat ~]# </span><br><span class=\"line\">[root@tomcat ~]# systemctl stop tomcat</span><br><span class=\"line\">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class=\"line\">root       4888   1823  0 12:38 pts/1    00:00:00 grep <span class=\"attribute\">--color</span>=auto tomcat</span><br><span class=\"line\">[root@tomcat ~]# </span><br><span class=\"line\">[root@tomcat ~]# systemctl restart tomcat </span><br><span class=\"line\">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class=\"line\">root       4909      1 43 12:38 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.<span class=\"attribute\">file</span>=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.<span class=\"attribute\">manager</span>=org.apache.juli.ClassLoaderLogManager -Djdk.tls.<span class=\"attribute\">ephemeralDHKeySize</span>=2048 -Djava.protocol.handler.<span class=\"attribute\">pkgs</span>=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.<span class=\"attribute\">UMASK</span>=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.<span class=\"attribute\">base</span>=/usr/local/tomcat -Dcatalina.<span class=\"attribute\">home</span>=/usr/local/tomcat -Djava.io.<span class=\"attribute\">tmpdir</span>=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class=\"line\">root       4959   1823  0 12:38 pts/1    00:00:00 grep <span class=\"attribute\">--color</span>=auto tomcat</span><br><span class=\"line\">[root@tomcat ~]#</span><br><span class=\"line\">[root@tomcat ~]# systemctl status tomcat</span><br><span class=\"line\">● tomcat.service - Tomcat<span class=\"built_in\"> server </span>daemon</span><br><span class=\"line\">   Loaded: loaded (/usr/lib/systemd/system/tomcat.service; disabled; vendor preset: disabled)</span><br><span class=\"line\">   Active: active (exited) since 二 2019-06-25 12:38:22 CST; 3min 53s ago</span><br><span class=\"line\">  Process: 4895 <span class=\"attribute\">ExecStart</span>=/usr/local/tomcat/bin/startup.sh (<span class=\"attribute\">code</span>=exited, <span class=\"attribute\">status</span>=0/SUCCESS)</span><br><span class=\"line\"> Main PID: 4895 (<span class=\"attribute\">code</span>=exited, <span class=\"attribute\">status</span>=0/SUCCESS)</span><br><span class=\"line\">   CGroup: /system.slice/tomcat.service</span><br><span class=\"line\">           └─4909 /usr/bin/java -Djava.util.logging.config.<span class=\"attribute\">file</span>=/usr/local/tomcat/conf/logging.pro...</span><br><span class=\"line\"></span><br><span class=\"line\">6月 25 12:38:22 tomcat systemd[1]: Starting Tomcat<span class=\"built_in\"> server </span>daemon<span class=\"built_in\">..</span>.</span><br><span class=\"line\">6月 25 12:38:22 tomcat startup.sh[4895]: Tomcat started.</span><br><span class=\"line\">6月 25 12:38:22 tomcat systemd[1]: Started Tomcat<span class=\"built_in\"> server </span>daemon.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 加入开机启动</span></span><br><span class=\"line\">[root@tomcat ~]# systemctl <span class=\"builtin-name\">enable</span> tomcat</span><br><span class=\"line\">[root@tomcat ~]# systemctl list-unit-files  |grep tomcat</span><br><span class=\"line\">tomcat.service                                enabled</span><br></pre></td></tr></table></figure></p>\n<p>tomcat启动成功后默认端口为：8080，访问地址<a href=\"http://ip:8080\" target=\"_blank\" rel=\"noopener\">http://ip:8080</a><br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat01.png\" alt></p>\n<h2 id=\"Tomcat目录结构\"><a href=\"#Tomcat目录结构\" class=\"headerlink\" title=\"Tomcat目录结构\"></a>Tomcat目录结构</h2><p><code>tomcat</code>安装主目录下的各个子目录说明：<br><figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># cd /usr/local/tomcat/</span></span><br><span class=\"line\">[root@tomcat tomcat]<span class=\"comment\"># tree -L 1</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── bin\t\t\t<span class=\"comment\">#存放启动、关闭tomcat或者其它功能的脚本(.bat文件和.sh文件)</span></span><br><span class=\"line\">├── BUILDING.txt</span><br><span class=\"line\">├── conf        <span class=\"comment\">#存放tomcat配置相关的文件</span></span><br><span class=\"line\">├── CONTRIBUTING.md</span><br><span class=\"line\">├── <span class=\"class\"><span class=\"keyword\">lib</span>         <span class=\"comment\">#存放Web应用能访问的JAR包</span></span></span><br><span class=\"line\">├── LICENSE</span><br><span class=\"line\">├── logs        <span class=\"comment\">#存放tomcat日志文件</span></span><br><span class=\"line\">├── NOTICE</span><br><span class=\"line\">├── README.md</span><br><span class=\"line\">├── RELEASE-NOTES</span><br><span class=\"line\">├── RUNNING.txt</span><br><span class=\"line\">├── temp        <span class=\"comment\">#临时文件</span></span><br><span class=\"line\">├── webapps     <span class=\"comment\">#Web应用程序的跟目录</span></span><br><span class=\"line\">└── work        <span class=\"comment\">#用以产生有JSP编译出的Servlet的.java和.class文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">7</span> directories, <span class=\"number\">7</span> files</span><br></pre></td></tr></table></figure></p>\n<p><code>webapps</code>目录说明：</p>\n<blockquote>\n<p>这里几个目录对应着主界面的上面的按钮，可以直接在主界面查看帮助文档，及<code>web</code>界面直接管理。</p>\n</blockquote>\n<figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat tomcat]<span class=\"comment\"># cd webapps/</span></span><br><span class=\"line\">[root@tomcat webapps]<span class=\"comment\"># ll</span></span><br><span class=\"line\">总用量 4</span><br><span class=\"line\">drwxr-x---<span class=\"number\"> 14 </span>root root<span class=\"number\"> 4096 </span>6月 <span class=\"number\"> 25 </span>11:39 docs          <span class=\"comment\">#tomcat帮助文档</span></span><br><span class=\"line\">drwxr-x--- <span class=\"number\"> 6 </span>root root  <span class=\"number\"> 83 </span>6月 <span class=\"number\"> 25 </span>11:39 examples      <span class=\"comment\">#web应用实例</span></span><br><span class=\"line\">drwxr-x--- <span class=\"number\"> 5 </span>root root  <span class=\"number\"> 87 </span>6月 <span class=\"number\"> 25 </span>11:39 host-manager  <span class=\"comment\">#管理</span></span><br><span class=\"line\">drwxr-x--- <span class=\"number\"> 5 </span>root root <span class=\"number\"> 103 </span>6月 <span class=\"number\"> 25 </span>11:39 manager       <span class=\"comment\">#管理</span></span><br><span class=\"line\">drwxr-x--- <span class=\"number\"> 3 </span>root root <span class=\"number\"> 283 </span>6月 <span class=\"number\"> 25 </span>11:39 ROOT          <span class=\"comment\">#默认网站根目录</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Tomcat日志文件\"><a href=\"#Tomcat日志文件\" class=\"headerlink\" title=\"Tomcat日志文件\"></a>Tomcat日志文件</h2><blockquote>\n<p><code>tomcat</code>一般有几个日志文件，访问的一般放在<code>localhost</code>日志文件里面，管理的日志放在<code>manager</code>日志文件里面，实时日志一般在<code>catalina.out</code>里面</p>\n</blockquote>\n<figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@tomcat tomcat]</span># <span class=\"selector-tag\">cd</span> <span class=\"selector-tag\">logs</span>/</span><br><span class=\"line\"><span class=\"selector-attr\">[root@tomcat logs]</span># <span class=\"selector-tag\">ll</span></span><br><span class=\"line\">总用量 <span class=\"selector-tag\">180</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">82372</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span> <span class=\"selector-tag\">catalina</span><span class=\"selector-class\">.2019-06-25</span><span class=\"selector-class\">.log</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">82574</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span> <span class=\"selector-tag\">catalina</span><span class=\"selector-class\">.out</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span>     <span class=\"selector-tag\">0</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:18</span> <span class=\"selector-tag\">host-manager</span><span class=\"selector-class\">.2019-06-25</span><span class=\"selector-class\">.log</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span>  <span class=\"selector-tag\">6246</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span> <span class=\"selector-tag\">localhost</span><span class=\"selector-class\">.2019-06-25</span><span class=\"selector-class\">.log</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span>  <span class=\"selector-tag\">3489</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">14</span><span class=\"selector-pseudo\">:30</span> <span class=\"selector-tag\">localhost_access_log</span><span class=\"selector-class\">.2019-06-25</span><span class=\"selector-class\">.txt</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span>     <span class=\"selector-tag\">0</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:18</span> <span class=\"selector-tag\">manager</span><span class=\"selector-class\">.2019-06-25</span><span class=\"selector-class\">.log</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-attr\">[root@tomcat logs]</span># <span class=\"selector-tag\">tailf</span> <span class=\"selector-tag\">catalina</span><span class=\"selector-class\">.out</span> </span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:24.674</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> <span class=\"selector-tag\">Deployment</span> <span class=\"selector-tag\">of</span> <span class=\"selector-tag\">web</span> <span class=\"selector-tag\">application</span> <span class=\"selector-tag\">directory</span> <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/docs]</span> <span class=\"selector-tag\">has</span> <span class=\"selector-tag\">finished</span> <span class=\"selector-tag\">in</span> <span class=\"selector-attr\">[27]</span> <span class=\"selector-tag\">ms</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:24.675</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> 把<span class=\"selector-tag\">web</span> 应用程序部署到目录 <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/examples]</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.113</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> <span class=\"selector-tag\">Deployment</span> <span class=\"selector-tag\">of</span> <span class=\"selector-tag\">web</span> <span class=\"selector-tag\">application</span> <span class=\"selector-tag\">directory</span> <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/examples]</span> <span class=\"selector-tag\">has</span> <span class=\"selector-tag\">finished</span> <span class=\"selector-tag\">in</span> <span class=\"selector-attr\">[438]</span> <span class=\"selector-tag\">ms</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.113</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> 把<span class=\"selector-tag\">web</span> 应用程序部署到目录 <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/host-manager]</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.163</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> <span class=\"selector-tag\">Deployment</span> <span class=\"selector-tag\">of</span> <span class=\"selector-tag\">web</span> <span class=\"selector-tag\">application</span> <span class=\"selector-tag\">directory</span> <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/host-manager]</span> <span class=\"selector-tag\">has</span> <span class=\"selector-tag\">finished</span> <span class=\"selector-tag\">in</span> <span class=\"selector-attr\">[50]</span> <span class=\"selector-tag\">ms</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.163</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> 把<span class=\"selector-tag\">web</span> 应用程序部署到目录 <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/manager]</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.220</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> <span class=\"selector-tag\">Deployment</span> <span class=\"selector-tag\">of</span> <span class=\"selector-tag\">web</span> <span class=\"selector-tag\">application</span> <span class=\"selector-tag\">directory</span> <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/manager]</span> <span class=\"selector-tag\">has</span> <span class=\"selector-tag\">finished</span> <span class=\"selector-tag\">in</span> <span class=\"selector-attr\">[57]</span> <span class=\"selector-tag\">ms</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.238</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.coyote</span><span class=\"selector-class\">.AbstractProtocol</span><span class=\"selector-class\">.start</span> 开始协议处理句柄<span class=\"selector-attr\">[\"http-nio-8080\"]</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.298</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.coyote</span><span class=\"selector-class\">.AbstractProtocol</span><span class=\"selector-class\">.start</span> 开始协议处理句柄<span class=\"selector-attr\">[\"ajp-nio-8009\"]</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.302</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.Catalina</span><span class=\"selector-class\">.start</span> <span class=\"selector-tag\">Server</span> <span class=\"selector-tag\">startup</span> <span class=\"selector-tag\">in</span> <span class=\"selector-attr\">[1,290]</span> <span class=\"selector-tag\">milliseconds</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Tomcat配置文件\"><a href=\"#Tomcat配置文件\" class=\"headerlink\" title=\"Tomcat配置文件\"></a>Tomcat配置文件</h2><blockquote>\n<p><code>tomcat</code>配置文件存放在安装目录下的<code>conf</code>目录下面</p>\n</blockquote>\n<figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入到配置文件目录</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># cd /usr/local/tomcat/conf/</span></span><br><span class=\"line\">[root@tomcat conf]<span class=\"comment\"># ll</span></span><br><span class=\"line\">总用量 228</span><br><span class=\"line\">drwxr-x---<span class=\"number\"> 3 </span>root root    <span class=\"number\"> 23 </span>6月 <span class=\"number\"> 25 </span>12:18 Catalina</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root <span class=\"number\"> 12873 </span>6月  <span class=\"number\"> 5 </span>04:23 catalina.policy</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 7243 </span>6月  <span class=\"number\"> 5 </span>04:23 catalina.properties</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 1400 </span>6月  <span class=\"number\"> 5 </span>04:23 context.xml</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 1149 </span>6月  <span class=\"number\"> 5 </span>04:23 jaspic-providers.xml</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 2313 </span>6月  <span class=\"number\"> 5 </span>04:23 jaspic-providers.xsd</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 4144 </span>6月  <span class=\"number\"> 5 </span>04:23 logging.properties</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 7511 </span>6月  <span class=\"number\"> 5 </span>04:23 server.xml  <span class=\"comment\">#主配置文件</span></span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 2164 </span>6月  <span class=\"number\"> 5 </span>04:23 tomcat-users.xml  <span class=\"comment\">#Tomcat管理用户配置文件</span></span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 2633 </span>6月  <span class=\"number\"> 5 </span>04:23 tomcat-users.xsd</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root<span class=\"number\"> 171962 </span>6月  <span class=\"number\"> 5 </span>04:23 web.xml</span><br></pre></td></tr></table></figure>\n<h3 id=\"Tomcat管理\"><a href=\"#Tomcat管理\" class=\"headerlink\" title=\"Tomcat管理\"></a>Tomcat管理</h3><blockquote>\n<p>配置<code>tomcat</code>的<code>web</code>界面管理功能，可以进行配置文件的管理，及部署在<code>tomcat</code>上的应用进行管理，默认情况是处于禁用状态。如果要开启这个功能，需要配置管理用户，即配置<code>tomcat-users.xml</code>文件。并且还需要修改manager项目下的<code>content.xml</code>文件，让其所有地址可访问</p>\n</blockquote>\n<figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑配置文件</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># vim /usr/local/tomcat/conf/tomcat-users.xml</span></span><br><span class=\"line\">...</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">\"manager-gui\"</span>/&gt;</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">\"admin-gui\"</span>/&gt;</span><br><span class=\"line\">&lt;user username=<span class=\"string\">\"tomcat\"</span> password=<span class=\"string\">\"tomcat\"</span> roles=<span class=\"string\">\"manager-gui,admin-gui\"</span>/&gt;</span><br><span class=\"line\">&lt;/tomcat-users&gt; <span class=\"comment\">#在这行前面加入上面三行</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑manager/META-INF/context.xml</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># vim /usr/local/tomcat/webapps/manager/META-INF/context.xml</span></span><br><span class=\"line\"><span class=\"comment\">#将</span></span><br><span class=\"line\">allow=<span class=\"string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\"</span> /&gt;</span><br><span class=\"line\"><span class=\"comment\">#改为</span></span><br><span class=\"line\">allow=<span class=\"string\">\"\\d+\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\"</span> /&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑host-manager/META-INF/context.xml</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># vim /usr/local/tomcat/webapps/host-manager/META-INF/context.xml</span></span><br><span class=\"line\"><span class=\"comment\">#将</span></span><br><span class=\"line\">allow=<span class=\"string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\"</span> /&gt;</span><br><span class=\"line\"><span class=\"comment\">#改为</span></span><br><span class=\"line\">allow=<span class=\"string\">\"\\d+\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\"</span> /&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启tomcat</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure>\n<p>访问测试<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat02.png\" alt><br>状态页面：<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat03.png\" alt><br>Manager页面：<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat04.png\" alt><br>Host Manager页面：<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat05.png\" alt></p>\n<h3 id=\"server-xml配置文件注释\"><a href=\"#server-xml配置文件注释\" class=\"headerlink\" title=\"server.xml配置文件注释\"></a>server.xml配置文件注释</h3><p>参考：<a href=\"https://www.cnblogs.com/sunshine-1/p/8990044.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/sunshine-1/p/8990044.html</a><br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Server</span> <span class=\"attr\">port</span>=<span class=\"string\">\"8005\"</span> <span class=\"attr\">shutdown</span>=<span class=\"string\">\"SHUTDOWN\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.startup.VersionLoggerListener\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.security.SecurityListener\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.core.AprLifecycleListener\"</span> <span class=\"attr\">SSLEngine</span>=<span class=\"string\">\"on\"</span> /&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.core.JasperListener\"</span> /&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.core.JreMemoryLeakPreventionListener\"</span> /&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\"</span> /&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.core.ThreadLocalLeakPreventionListener\"</span> /&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">GlobalNamingResources</span>&gt;</span> </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 全局命名资源，来定义一些外部访问资源，其作用是为所有引擎应用程序所引用的外部资源的定义 --!&gt; </span></span><br><span class=\"line\"><span class=\"comment\">    &lt;Resource name=\"UserDatabase\" auth=\"Container\" </span></span><br><span class=\"line\"><span class=\"comment\">              type=\"org.apache.catalina.UserDatabase\" </span></span><br><span class=\"line\"><span class=\"comment\">              description=\"User database that can be updated and saved\" </span></span><br><span class=\"line\"><span class=\"comment\">              factory=\"org.apache.catalina.users.MemoryUserDatabaseFactory\" </span></span><br><span class=\"line\"><span class=\"comment\">              pathname=\"conf/tomcat-users.xml\" /&gt; </span></span><br><span class=\"line\"><span class=\"comment\">  &lt;/GlobalNamingResources&gt; </span></span><br><span class=\"line\"><span class=\"comment\">  &lt;!-- 定义的一个名叫“UserDatabase”的认证资源，将conf/tomcat-users.xml加载至内存中，在需要认证的时候到内存中进行认证 --&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Service</span> <span class=\"attr\">name</span>=<span class=\"string\">\"Catalina\"</span>&gt;</span> </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- # 定义Service组件，同来关联Connector和Engine，一个Engine可以对应多个Connector，每个Service中只能一个Engine --!&gt; </span></span><br><span class=\"line\"><span class=\"comment\">    &lt;Connector port=\"80\" protocol=\"HTTP/1.1\" connectionTimeout=\"20000\" redirectPort=\"8443\" /&gt; </span></span><br><span class=\"line\"><span class=\"comment\">    &lt;!-- 修改HTTP/1.1的Connector监听端口为80.客户端通过浏览器访问的请求，只能通过HTTP传递给tomcat。还可以设置server与URIEncoding参数 --&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">\"8009\"</span> <span class=\"attr\">protocol</span>=<span class=\"string\">\"AJP/1.3\"</span> <span class=\"attr\">redirectPort</span>=<span class=\"string\">\"8443\"</span> /&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Engine</span> <span class=\"attr\">name</span>=<span class=\"string\">\"Catalina\"</span> <span class=\"attr\">defaultHost</span>=<span class=\"string\">\"test.com\"</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 修改当前Engine，默认主机是，www.test.com  --&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Realm</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.realm.LockOutRealm\"</span>&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Realm</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.realm.UserDatabaseRealm\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">resourceName</span>=<span class=\"string\">\"UserDatabase\"</span>/&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Realm</span>&gt;</span> </span><br><span class=\"line\">    # Realm组件，定义对当前容器内的应用程序访问的认证，通过外部资源UserDatabase进行认证 </span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">Host</span> <span class=\"attr\">name</span>=<span class=\"string\">\"test.com\"</span>  <span class=\"attr\">appBase</span>=<span class=\"string\">\"/web\"</span> <span class=\"attr\">unpackWARs</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">autoDeploy</span>=<span class=\"string\">\"true\"</span>&gt;</span> </span><br><span class=\"line\">      <span class=\"comment\">&lt;!--  定义一个主机，域名为：test.com，应用程序的目录是/web，设置自动部署，自动解压    --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Alias</span>&gt;</span>www.test.com<span class=\"tag\">&lt;/<span class=\"name\">Alias</span>&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--    定义一个别名www.test.com，类似apache的ServerAlias --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Context</span> <span class=\"attr\">path</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">docBase</span>=<span class=\"string\">\"www/\"</span> <span class=\"attr\">reloadable</span>=<span class=\"string\">\"true\"</span> /&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--    定义该应用程序，访问路径\"\"，即访问www.test.com即可访问，网页目录为：相对于appBase下的www/，即/web/www，并且当该应用程序下web.xml或者类等有相关变化时，自动重载当前配置，即不用重启tomcat使部署的新应用程序生效  --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Context</span> <span class=\"attr\">path</span>=<span class=\"string\">\"/bbs\"</span> <span class=\"attr\">docBase</span>=<span class=\"string\">\"/web/bbs\"</span> <span class=\"attr\">reloadable</span>=<span class=\"string\">\"true\"</span> /&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--  定义另外一个独立的应用程序(虚拟主机)，访问路径为：www.test.com/bbs，该应用程序网页目录为/web/bbs   --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Valve</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"attr\">directory</span>=<span class=\"string\">\"/web/www/logs\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">prefix</span>=<span class=\"string\">\"www_access.\"</span> <span class=\"attr\">suffix</span>=<span class=\"string\">\".log\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">pattern</span>=<span class=\"string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--   定义一个Valve组件，用来记录tomcat的访问日志，日志存放目录为：/web/www/logs如果定义为相对路径则是相当于$CATALINA_HOME，并非相对于appBase，这个要注意。定义日志文件前缀为www_access.并以.log结尾，pattern定义日志内容格式，具体字段表示可以查看tomcat官方文档   --&gt;</span> </span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">Host</span>&gt;</span> </span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">Host</span> <span class=\"attr\">name</span>=<span class=\"string\">\"manager.test.com\"</span> <span class=\"attr\">appBase</span>=<span class=\"string\">\"webapps\"</span> <span class=\"attr\">unpackWARs</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">autoDeploy</span>=<span class=\"string\">\"true\"</span>&gt;</span> </span><br><span class=\"line\">      <span class=\"comment\">&lt;!--   定义一个主机名为man.test.com，应用程序目录是$CATALINA_HOME/webapps,自动解压，自动部署   --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Valve</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.valves.RemoteAddrValve\"</span> <span class=\"attr\">allow</span>=<span class=\"string\">\"172.16.100.*\"</span> /&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--   定义远程地址访问策略，仅允许172.16.100.*网段访问该主机，其他的将被拒绝访问  --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Valve</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"attr\">directory</span>=<span class=\"string\">\"/web/bbs/logs\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">prefix</span>=<span class=\"string\">\"bbs_access.\"</span> <span class=\"attr\">suffix</span>=<span class=\"string\">\".log\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">pattern</span>=<span class=\"string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--   定义该主机的访问日志      --&gt;</span> </span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">Host</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Engine</span>&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">Service</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Server</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Tomcat单实例站点部署\"><a href=\"#Tomcat单实例站点部署\" class=\"headerlink\" title=\"Tomcat单实例站点部署\"></a>Tomcat单实例站点部署</h2><blockquote>\n<p>以部署<code>jspxcms</code>为例，在上面已部署的环境下继续操作。</p>\n</blockquote>\n<p>1）安装<code>MySQL</code>及创建库<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">root@tomcat ~</span>]<span class=\"meta\"># yum -y install mariadb mariadb-server</span></span><br><span class=\"line\">[<span class=\"meta\">root@tomcat ~</span>]<span class=\"meta\"># systemctl enable mariadb</span></span><br><span class=\"line\">[<span class=\"meta\">root@tomcat ~</span>]<span class=\"meta\"># systemctl start mariadb</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 创建数据库并授权</span></span><br><span class=\"line\">MariaDB [(none)]&gt; create database jspxcms_test character <span class=\"keyword\">set</span> utf8;</span><br><span class=\"line\">MariaDB [(none)]&gt; grant all <span class=\"keyword\">on</span> jspxcms_test.* to <span class=\"string\">'jspxcmsuser'</span>@<span class=\"string\">'localhost'</span> identified <span class=\"keyword\">by</span> <span class=\"string\">'123'</span>;</span><br><span class=\"line\">MariaDB [(none)]&gt; flush privileges;</span><br></pre></td></tr></table></figure></p>\n<p>2）部署<code>jspxcms</code><br><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># tomcat默认的网站目录</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># ls /usr/local/tomcat/webapps/</span></span><br><span class=\"line\">docs  examples  host-manager  manager  ROOT</span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># ls /usr/local/tomcat/webapps/ROOT/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 上传jspxcms安装包并解压</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># mkdir tools</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># ls</span></span><br><span class=\"line\">jspxcms-<span class=\"number\">9.5</span>.<span class=\"number\">0</span>-release.zip</span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># unzip jspxcms-9.5.0-release.zip</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># ls</span></span><br><span class=\"line\">CHANGELOG.txt  database  jspxcms-<span class=\"number\">9.5</span>.<span class=\"number\">0</span>-release.zip  Jspxcms安装手册.pdf  ROOT  用户许可协议.txt</span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># rm -rf /usr/local/tomcat/webapps/*</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># cp -a ROOT /usr/local/tomcat/webapps/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 导入sql文件</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># mysql -D jspxcms_test &lt; database/mysql.sql</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑配置文件配置数据库连接信息</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># vim /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/application.properties</span></span><br><span class=\"line\">spring.datasource.url=<span class=\"symbol\">jdbc:</span><span class=\"symbol\">mysql:</span>/<span class=\"regexp\">/127.0.0.1:3306/jspxcms</span>_test?characterEncoding=utf8</span><br><span class=\"line\"><span class=\"comment\"># \\u6570\\u636E\\u5E93\\u7528\\u6237\\u540D</span></span><br><span class=\"line\">spring.datasource.username=jspxcmsuser</span><br><span class=\"line\"><span class=\"comment\"># \\u6570\\u636E\\u5E93\\u5BC6\\u7801</span></span><br><span class=\"line\">spring.datasource.password=<span class=\"number\">123</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启tomcat</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>web</code>页面访问 前台地址：<a href=\"http://ip:8080\" target=\"_blank\" rel=\"noopener\">http://ip:8080</a>  &emsp;后台地址：<a href=\"http://ip:8080/cmscp/index.do\" target=\"_blank\" rel=\"noopener\">http://ip:8080/cmscp/index.do</a>   &emsp; 默认账号：admin  密码为空<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat06.png\" alt><br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat07.png\" alt></p>\n<h2 id=\"Tomcat多实例站点部署\"><a href=\"#Tomcat多实例站点部署\" class=\"headerlink\" title=\"Tomcat多实例站点部署\"></a>Tomcat多实例站点部署</h2><blockquote>\n<p>多实例作用运行不同的应用（类似虚拟主机）<br>多实例运行相同的应用（实现负载均衡，支持高并发处理，session问题）<br>这里基于上面已安装的tomcat环境</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>环境</th>\n<th>Web监听端口</th>\n<th>管理实例端口</th>\n<th>站点家目录</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>tomcat9_1</td>\n<td>8081</td>\n<td>8091</td>\n<td>/webapps/tomcat9_1</td>\n</tr>\n<tr>\n<td>tomcat9_2</td>\n<td>8082</td>\n<td>8092</td>\n<td>/webapps/tomcat9_2</td>\n</tr>\n</tbody>\n</table>\n<p>1）拷贝tomcat目录<br><figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_1</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_2</span></span><br></pre></td></tr></table></figure></p>\n<p>2）编辑配置文件，修改监听端口和站点家目录<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat ~]# vim /usr/local/tomcat9_1/conf/server.xml</span><br><span class=\"line\">&lt;Server <span class=\"attribute\">port</span>=<span class=\"string\">\"8091\"</span> <span class=\"attribute\">shutdown</span>=<span class=\"string\">\"SHUTDOWN\"</span>&gt;</span><br><span class=\"line\">&lt;Connector <span class=\"attribute\">port</span>=<span class=\"string\">\"8081\"</span> <span class=\"attribute\">protocol</span>=<span class=\"string\">\"HTTP/1.1\"</span></span><br><span class=\"line\">           <span class=\"attribute\">connectionTimeout</span>=<span class=\"string\">\"20000\"</span></span><br><span class=\"line\">           <span class=\"attribute\">redirectPort</span>=<span class=\"string\">\"8443\"</span> /&gt;</span><br><span class=\"line\">&lt;Host <span class=\"attribute\">name</span>=<span class=\"string\">\"localhost\"</span>  <span class=\"attribute\">appBase</span>=<span class=\"string\">\"/webapps/tomcat9_1\"</span></span><br><span class=\"line\">            <span class=\"attribute\">unpackWARs</span>=<span class=\"string\">\"true\"</span> <span class=\"attribute\">autoDeploy</span>=<span class=\"string\">\"true\"</span>&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@tomcat ~]# vim /usr/local/tomcat9_2/conf/server.xml</span><br><span class=\"line\">&lt;Server <span class=\"attribute\">port</span>=<span class=\"string\">\"8092\"</span> <span class=\"attribute\">shutdown</span>=<span class=\"string\">\"SHUTDOWN\"</span>&gt;</span><br><span class=\"line\">&lt;Connector <span class=\"attribute\">port</span>=<span class=\"string\">\"8082\"</span> <span class=\"attribute\">protocol</span>=<span class=\"string\">\"HTTP/1.1\"</span></span><br><span class=\"line\">           <span class=\"attribute\">connectionTimeout</span>=<span class=\"string\">\"20000\"</span></span><br><span class=\"line\">           <span class=\"attribute\">redirectPort</span>=<span class=\"string\">\"8443\"</span> /&gt;</span><br><span class=\"line\">&lt;Host <span class=\"attribute\">name</span>=<span class=\"string\">\"localhost\"</span>  <span class=\"attribute\">appBase</span>=<span class=\"string\">\"/webapps/tomcat9_2\"</span></span><br><span class=\"line\">            <span class=\"attribute\">unpackWARs</span>=<span class=\"string\">\"true\"</span> <span class=\"attribute\">autoDeploy</span>=<span class=\"string\">\"true\"</span>&gt;</span><br></pre></td></tr></table></figure></p>\n<p>3）创建站点家目录，及测试页面准备<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"meta\">@tomcat</span> ~]<span class=\"comment\"># mkdir -p /webapps/tomcat9_&#123;1,2&#125;</span></span><br><span class=\"line\">[root<span class=\"meta\">@tomcat</span> ~]<span class=\"comment\"># mkdir /webapps/tomcat9_&#123;1,2&#125;/ROOT</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># tomcat9_1测试页面准备</span></span><br><span class=\"line\">[root<span class=\"meta\">@tomcat</span> ~]<span class=\"comment\"># vim /webapps/tomcat9_1/ROOT/index.jsp</span></span><br><span class=\"line\"><span class=\"variable\">&lt;html&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;body&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;center&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;H1&gt;</span><span class=\"variable\">&lt;%=new java.util.Date()%&gt;</span><span class=\"variable\">&lt;/H1&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;H2&gt;</span>tomcat9_1<span class=\"variable\">&lt;/H2&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/center&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/body&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/html&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># tomcat9_2测试页面准备</span></span><br><span class=\"line\">[root<span class=\"meta\">@tomcat</span> ~]<span class=\"comment\"># vim /webapps/tomcat9_2/ROOT/index.jsp</span></span><br><span class=\"line\"><span class=\"variable\">&lt;html&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;body&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;center&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;H1&gt;</span><span class=\"variable\">&lt;%=new java.util.Date()%&gt;</span><span class=\"variable\">&lt;/H1&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;H2&gt;</span>tomcat9_2<span class=\"variable\">&lt;/H2&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/center&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/body&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>4）删除掉之前的站点目录里面的东西，对这里没有用了。可以直接删掉<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@tomcat</span> ~]<span class=\"meta\"># rm -rf /usr/local/tomcat9_2/webapps/*</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat</span> ~]<span class=\"meta\"># rm -rf /usr/local/tomcat9_1/webapps/*</span></span><br></pre></td></tr></table></figure></p>\n<p>5）启动<code>tomcat1</code>和<code>tomcat2</code><br><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># for i in &#123;1..2&#125;;do /usr/local/tomcat9_$i/bin/startup.sh; done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 端口查看</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># ss -tnlp |grep :80</span></span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">100</span>         ::<span class=\"symbol\">:</span><span class=\"number\">8080</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">27023</span>,fd=<span class=\"number\">54</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">100</span>         ::<span class=\"symbol\">:</span><span class=\"number\">8081</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">28687</span>,fd=<span class=\"number\">54</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">100</span>         ::<span class=\"symbol\">:</span><span class=\"number\">8082</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">28708</span>,fd=<span class=\"number\">54</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">1</span>         ::<span class=\"symbol\">ffff:</span><span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span><span class=\"symbol\">:</span><span class=\"number\">8091</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">28687</span>,fd=<span class=\"number\">65</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">1</span>         ::<span class=\"symbol\">ffff:</span><span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span><span class=\"symbol\">:</span><span class=\"number\">8092</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">28708</span>,fd=<span class=\"number\">66</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">1</span>         ::<span class=\"symbol\">ffff:</span><span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span><span class=\"symbol\">:</span><span class=\"number\">8005</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">27023</span>,fd=<span class=\"number\">71</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">100</span>         ::<span class=\"symbol\">:</span><span class=\"number\">8009</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">27023</span>,fd=<span class=\"number\">59</span>)</span><br></pre></td></tr></table></figure></p>\n<p>6）访问测试<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat08.png\" alt=\"http://192.168.1.31:8081\"><br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat09.png\" alt=\"http://192.168.1.31:8082\"></p>\n<p><strong>补充：Tomcat多实例启动脚本</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># cat TomcatSys.sh </span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#Desc：用于tomcat多实例部署启动脚本。</span></span><br><span class=\"line\"><span class=\"comment\">#Date：2019-6-26</span></span><br><span class=\"line\"><span class=\"comment\">#by：Lee-YJ</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> == <span class=\"string\">\"tomcat1\"</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">export</span> CATALINA_HOME=<span class=\"string\">\"/usr/local/tomcat9_1\"</span></span><br><span class=\"line\"><span class=\"keyword\">elif</span> [ <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> == <span class=\"string\">\"tomcat2\"</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">export</span> CATALINA_HOME=<span class=\"string\">\"/usr/local/tomcat9_2\"</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> $<span class=\"string\">\"Usage: <span class=\"variable\">$0</span> &#123;[tomcat1|tomcat2] start|stop|restart&#125;\"</span> &amp;&amp; <span class=\"built_in\">exit</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">\"<span class=\"variable\">$2</span>\"</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">start)</span><br><span class=\"line\">    <span class=\"variable\">$CATALINA_HOME</span>/bin/startup.sh</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">stop)</span><br><span class=\"line\">    <span class=\"variable\">$CATALINA_HOME</span>/bin/shutdown.sh</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">restart)</span><br><span class=\"line\">    <span class=\"variable\">$CATALINA_HOME</span>/bin/shutdown.sh</span><br><span class=\"line\">    sleep 3</span><br><span class=\"line\">    <span class=\"variable\">$CATALINA_HOME</span>/bin/startup.sh</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">    *)</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> $<span class=\"string\">\"Usage: <span class=\"variable\">$0</span> &#123;[tomcat1|tomcat2] start|stop|restart&#125;\"</span> &amp;&amp; <span class=\"built_in\">exit</span></span><br><span class=\"line\">    ;;</span><br><span class=\"line\"><span class=\"keyword\">esac</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用说明：</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># ./TomcatSys.sh tomcat1 start      #启动tomcat1</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># ./TomcatSys.sh tomcat1 stop       #停止tomcat1</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># ./TomcatSys.sh tomcat2 restart    #重启tomcat2</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Tomcat简介\"><a href=\"#Tomcat简介\" class=\"headerlink\" title=\"Tomcat简介\"></a>Tomcat简介</h2><p>官网：<a href=\"http://tomcat.apache.org/\" target=\"_blank\" rel=\"noopener\">http://tomcat.apache.org/</a></p>\n<blockquote>\n<p><code>Tomcat</code>服务器是一个免费的开源代码的Web应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下使用，是开发和调试<code>JSP</code>程序的首选。<br><code>Tomcat</code>和<code>Nginx</code>、<code>Apache</code>等<code>Web</code>服务器一样，具有处理<code>HTML</code>页面的功能，另外它还是一个<code>Servlet</code>和<code>JSP</code>容器，独立的<code>Servlet</code>容器是<code>Tomcat</code>的默认模式。不过，<code>Tomcat</code>处理静态<code>HTML</code>的能力不如<code>Nginx/Apache</code>服务器。<br>一般情况下多用<code>Nginx+Tomcat</code>，<code>Nginx</code>处理静态，<code>Tomcat</code>处理动态程序</p>\n</blockquote>\n<h2 id=\"Tomcat安装\"><a href=\"#Tomcat安装\" class=\"headerlink\" title=\"Tomcat安装\"></a>Tomcat安装</h2><blockquote>\n<p>软件下载：<a href=\"https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html\" target=\"_blank\" rel=\"noopener\">JDK下载</a>  &emsp; <a href=\"http://tomcat.apache.org/\" target=\"_blank\" rel=\"noopener\">Tomcat下载</a><br>本文使用的软件包<code>jdk-8u211</code>,<code>tomcat-9.0.21</code>。 <a href=\"https://pan.baidu.com/s/1d0g0T75p-CW7uz3ug7I8YA\" target=\"_blank\" rel=\"noopener\">下载链接</a> &emsp; 提取码：f0ay</p>\n</blockquote>\n<h3 id=\"部署Java环境\"><a href=\"#部署Java环境\" class=\"headerlink\" title=\"部署Java环境\"></a>部署Java环境</h3><p>将下载的软件包上传到服务器<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 解压软件包</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个软链接</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># ln -s /usr/local/jdk1.8.0_211 /usr/local/java</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加环境变量</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># sed -i.ori '$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重新加载环境变量</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># env |grep JAVA</span></span><br><span class=\"line\"><span class=\"keyword\">JAVA_HOME=/usr/local/java</span></span><br><span class=\"line\"><span class=\"keyword\"></span></span><br><span class=\"line\"><span class=\"keyword\"># </span>查看是否安装成功</span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># java -version</span></span><br><span class=\"line\"><span class=\"keyword\">java </span>version <span class=\"string\">\"1.8.0_211\"</span></span><br><span class=\"line\"><span class=\"keyword\">Java(TM) </span>SE Runtime Environment (<span class=\"keyword\">build </span><span class=\"number\">1</span>.<span class=\"number\">8</span>.<span class=\"number\">0</span>_211-<span class=\"keyword\">b12)</span></span><br><span class=\"line\"><span class=\"keyword\">Java </span>HotSpot(TM) <span class=\"number\">64</span>-<span class=\"keyword\">Bit </span>Server VM (<span class=\"keyword\">build </span><span class=\"number\">25</span>.<span class=\"number\">211</span>-<span class=\"keyword\">b12, </span>mixed mode)</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"部署Tomcat\"><a href=\"#部署Tomcat\" class=\"headerlink\" title=\"部署Tomcat\"></a>部署Tomcat</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 解压软件包</span></span><br><span class=\"line\">[root@tomcat ~]# tar xf apache-tomcat-9.0.21.tar.gz -C /usr/local/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个软链接</span></span><br><span class=\"line\">[root@tomcat ~]# ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义tomcat所需的环境变量</span></span><br><span class=\"line\">[root@tomcat ~]# echo <span class=\"string\">\"export TOMCAT_HOME=/usr/local/tomcat\"</span> &gt;&gt; /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重新加载环境变量</span></span><br><span class=\"line\">[root@tomcat ~]# source /etc/profile</span><br></pre></td></tr></table></figure>\n<h2 id=\"Tomcat启动\"><a href=\"#Tomcat启动\" class=\"headerlink\" title=\"Tomcat启动\"></a>Tomcat启动</h2><p>1）默认的启动方式<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat ~]<span class=\"meta\"># ls /usr/local/tomcat/bin/startup.sh   #启动脚本</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/startup.sh</span><br><span class=\"line\">[root@tomcat ~]<span class=\"meta\"># ls /usr/local/tomcat/bin/shutdown.sh   #停止脚本</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/shutdown.sh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 默认方式启动</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"meta\"># /usr/local/tomcat/bin/startup.sh </span></span><br><span class=\"line\">Using CATALINA_BASE:   <span class=\"meta-keyword\">/usr/</span>local/tomcat</span><br><span class=\"line\">Using CATALINA_HOME:   <span class=\"meta-keyword\">/usr/</span>local/tomcat</span><br><span class=\"line\">Using CATALINA_TMPDIR: <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>temp</span><br><span class=\"line\">Using JRE_HOME:        <span class=\"meta-keyword\">/usr/</span>local/java</span><br><span class=\"line\">Using CLASSPATH:       <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/bootstrap.jar:<span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/tomcat-juli.jar</span><br><span class=\"line\">Tomcat started.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 默认方式停止</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"meta\"># /usr/local/tomcat/bin/shutdown.sh </span></span><br><span class=\"line\">Using CATALINA_BASE:   <span class=\"meta-keyword\">/usr/</span>local/tomcat</span><br><span class=\"line\">Using CATALINA_HOME:   <span class=\"meta-keyword\">/usr/</span>local/tomcat</span><br><span class=\"line\">Using CATALINA_TMPDIR: <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>temp</span><br><span class=\"line\">Using JRE_HOME:        <span class=\"meta-keyword\">/usr/</span>local/java</span><br><span class=\"line\">Using CLASSPATH:       <span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/bootstrap.jar:<span class=\"meta-keyword\">/usr/</span>local<span class=\"meta-keyword\">/tomcat/</span>bin/tomcat-juli.jar</span><br></pre></td></tr></table></figure></p>\n<p>2）加入<code>/etc/init.d/</code>支持<code>centos6</code>的<code>service</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑/etc/init.d/tomcat脚本</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># vim /etc/init.d/tomcat</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># Init file for Tomcat server daemon</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># chkconfig: 2345 96 14</span></span><br><span class=\"line\"><span class=\"comment\"># description: Tomcat server daemon</span></span><br><span class=\"line\">JAVA_OPTS=<span class=\"string\">'-Xms64m -Xmx128m'</span></span><br><span class=\"line\">JAVA_HOME=/usr/<span class=\"built_in\">local</span>/jdk1.8.0_211      <span class=\"comment\">#指定jdk安装路径</span></span><br><span class=\"line\">CATALINA_HOME=/usr/<span class=\"built_in\">local</span>/tomcat     <span class=\"comment\">#指定tomcat安装路径</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_OPTS JAVA_HOME CATALINA_HOME</span><br><span class=\"line\"><span class=\"built_in\">exec</span> <span class=\"variable\">$CATALINA_HOME</span>/bin/catalina.sh $*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加执行权限</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># chmod +x /etc/init.d/tomcat</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动停止测试</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># service tomcat start</span></span><br><span class=\"line\">Using CATALINA_BASE:   /usr/<span class=\"built_in\">local</span>/tomcat</span><br><span class=\"line\">Using CATALINA_HOME:   /usr/<span class=\"built_in\">local</span>/tomcat</span><br><span class=\"line\">Using CATALINA_TMPDIR: /usr/<span class=\"built_in\">local</span>/tomcat/temp</span><br><span class=\"line\">Using JRE_HOME:        /usr/<span class=\"built_in\">local</span>/jdk1.8.0_211</span><br><span class=\"line\">Using CLASSPATH:       /usr/<span class=\"built_in\">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class=\"built_in\">local</span>/tomcat/bin/tomcat-juli.jar</span><br><span class=\"line\">Tomcat started.</span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># </span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># service tomcat stop</span></span><br><span class=\"line\">Using CATALINA_BASE:   /usr/<span class=\"built_in\">local</span>/tomcat</span><br><span class=\"line\">Using CATALINA_HOME:   /usr/<span class=\"built_in\">local</span>/tomcat</span><br><span class=\"line\">Using CATALINA_TMPDIR: /usr/<span class=\"built_in\">local</span>/tomcat/temp</span><br><span class=\"line\">Using JRE_HOME:        /usr/<span class=\"built_in\">local</span>/jdk1.8.0_211</span><br><span class=\"line\">Using CLASSPATH:       /usr/<span class=\"built_in\">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class=\"built_in\">local</span>/tomcat/bin/tomcat-juli.jar</span><br></pre></td></tr></table></figure></p>\n<p>3）加入<code>systemd</code>管理<code>tomcat</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑启动脚本</span></span><br><span class=\"line\">[root@tomcat ~]# vim /usr/lib/systemd/system/tomcat.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\"><span class=\"attribute\">Description</span>=Tomcat<span class=\"built_in\"> server </span>daemon</span><br><span class=\"line\"><span class=\"attribute\">After</span>=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\"><span class=\"attribute\">Type</span>=oneshot</span><br><span class=\"line\"><span class=\"attribute\">ExecStart</span>=/usr/local/tomcat/bin/startup.sh</span><br><span class=\"line\"><span class=\"attribute\">ExecStop</span>=/usr/local/tomcat/bin/shutdown.sh</span><br><span class=\"line\"><span class=\"attribute\">ExecReload</span>=/bin/kill -HUP <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\"><span class=\"attribute\">RemainAfterExit</span>=<span class=\"literal\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\"><span class=\"attribute\">WantedBy</span>=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 测试启动和关闭</span></span><br><span class=\"line\">[root@tomcat ~]# systemctl start tomcat</span><br><span class=\"line\">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class=\"line\">root       4810      1 35 12:37 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.<span class=\"attribute\">file</span>=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.<span class=\"attribute\">manager</span>=org.apache.juli.ClassLoaderLogManager -Djdk.tls.<span class=\"attribute\">ephemeralDHKeySize</span>=2048 -Djava.protocol.handler.<span class=\"attribute\">pkgs</span>=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.<span class=\"attribute\">UMASK</span>=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.<span class=\"attribute\">base</span>=/usr/local/tomcat -Dcatalina.<span class=\"attribute\">home</span>=/usr/local/tomcat -Djava.io.<span class=\"attribute\">tmpdir</span>=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class=\"line\">root       4852   1823  0 12:37 pts/1    00:00:00 grep <span class=\"attribute\">--color</span>=auto tomcat</span><br><span class=\"line\">[root@tomcat ~]# </span><br><span class=\"line\">[root@tomcat ~]# systemctl stop tomcat</span><br><span class=\"line\">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class=\"line\">root       4888   1823  0 12:38 pts/1    00:00:00 grep <span class=\"attribute\">--color</span>=auto tomcat</span><br><span class=\"line\">[root@tomcat ~]# </span><br><span class=\"line\">[root@tomcat ~]# systemctl restart tomcat </span><br><span class=\"line\">[root@tomcat ~]# ps -ef |grep tomcat</span><br><span class=\"line\">root       4909      1 43 12:38 ?        00:00:02 /usr/bin/java -Djava.util.logging.config.<span class=\"attribute\">file</span>=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.<span class=\"attribute\">manager</span>=org.apache.juli.ClassLoaderLogManager -Djdk.tls.<span class=\"attribute\">ephemeralDHKeySize</span>=2048 -Djava.protocol.handler.<span class=\"attribute\">pkgs</span>=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.<span class=\"attribute\">UMASK</span>=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.<span class=\"attribute\">base</span>=/usr/local/tomcat -Dcatalina.<span class=\"attribute\">home</span>=/usr/local/tomcat -Djava.io.<span class=\"attribute\">tmpdir</span>=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class=\"line\">root       4959   1823  0 12:38 pts/1    00:00:00 grep <span class=\"attribute\">--color</span>=auto tomcat</span><br><span class=\"line\">[root@tomcat ~]#</span><br><span class=\"line\">[root@tomcat ~]# systemctl status tomcat</span><br><span class=\"line\">● tomcat.service - Tomcat<span class=\"built_in\"> server </span>daemon</span><br><span class=\"line\">   Loaded: loaded (/usr/lib/systemd/system/tomcat.service; disabled; vendor preset: disabled)</span><br><span class=\"line\">   Active: active (exited) since 二 2019-06-25 12:38:22 CST; 3min 53s ago</span><br><span class=\"line\">  Process: 4895 <span class=\"attribute\">ExecStart</span>=/usr/local/tomcat/bin/startup.sh (<span class=\"attribute\">code</span>=exited, <span class=\"attribute\">status</span>=0/SUCCESS)</span><br><span class=\"line\"> Main PID: 4895 (<span class=\"attribute\">code</span>=exited, <span class=\"attribute\">status</span>=0/SUCCESS)</span><br><span class=\"line\">   CGroup: /system.slice/tomcat.service</span><br><span class=\"line\">           └─4909 /usr/bin/java -Djava.util.logging.config.<span class=\"attribute\">file</span>=/usr/local/tomcat/conf/logging.pro...</span><br><span class=\"line\"></span><br><span class=\"line\">6月 25 12:38:22 tomcat systemd[1]: Starting Tomcat<span class=\"built_in\"> server </span>daemon<span class=\"built_in\">..</span>.</span><br><span class=\"line\">6月 25 12:38:22 tomcat startup.sh[4895]: Tomcat started.</span><br><span class=\"line\">6月 25 12:38:22 tomcat systemd[1]: Started Tomcat<span class=\"built_in\"> server </span>daemon.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 加入开机启动</span></span><br><span class=\"line\">[root@tomcat ~]# systemctl <span class=\"builtin-name\">enable</span> tomcat</span><br><span class=\"line\">[root@tomcat ~]# systemctl list-unit-files  |grep tomcat</span><br><span class=\"line\">tomcat.service                                enabled</span><br></pre></td></tr></table></figure></p>\n<p>tomcat启动成功后默认端口为：8080，访问地址<a href=\"http://ip:8080\" target=\"_blank\" rel=\"noopener\">http://ip:8080</a><br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat01.png\" alt></p>\n<h2 id=\"Tomcat目录结构\"><a href=\"#Tomcat目录结构\" class=\"headerlink\" title=\"Tomcat目录结构\"></a>Tomcat目录结构</h2><p><code>tomcat</code>安装主目录下的各个子目录说明：<br><figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># cd /usr/local/tomcat/</span></span><br><span class=\"line\">[root@tomcat tomcat]<span class=\"comment\"># tree -L 1</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── bin\t\t\t<span class=\"comment\">#存放启动、关闭tomcat或者其它功能的脚本(.bat文件和.sh文件)</span></span><br><span class=\"line\">├── BUILDING.txt</span><br><span class=\"line\">├── conf        <span class=\"comment\">#存放tomcat配置相关的文件</span></span><br><span class=\"line\">├── CONTRIBUTING.md</span><br><span class=\"line\">├── <span class=\"class\"><span class=\"keyword\">lib</span>         <span class=\"comment\">#存放Web应用能访问的JAR包</span></span></span><br><span class=\"line\">├── LICENSE</span><br><span class=\"line\">├── logs        <span class=\"comment\">#存放tomcat日志文件</span></span><br><span class=\"line\">├── NOTICE</span><br><span class=\"line\">├── README.md</span><br><span class=\"line\">├── RELEASE-NOTES</span><br><span class=\"line\">├── RUNNING.txt</span><br><span class=\"line\">├── temp        <span class=\"comment\">#临时文件</span></span><br><span class=\"line\">├── webapps     <span class=\"comment\">#Web应用程序的跟目录</span></span><br><span class=\"line\">└── work        <span class=\"comment\">#用以产生有JSP编译出的Servlet的.java和.class文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">7</span> directories, <span class=\"number\">7</span> files</span><br></pre></td></tr></table></figure></p>\n<p><code>webapps</code>目录说明：</p>\n<blockquote>\n<p>这里几个目录对应着主界面的上面的按钮，可以直接在主界面查看帮助文档，及<code>web</code>界面直接管理。</p>\n</blockquote>\n<figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat tomcat]<span class=\"comment\"># cd webapps/</span></span><br><span class=\"line\">[root@tomcat webapps]<span class=\"comment\"># ll</span></span><br><span class=\"line\">总用量 4</span><br><span class=\"line\">drwxr-x---<span class=\"number\"> 14 </span>root root<span class=\"number\"> 4096 </span>6月 <span class=\"number\"> 25 </span>11:39 docs          <span class=\"comment\">#tomcat帮助文档</span></span><br><span class=\"line\">drwxr-x--- <span class=\"number\"> 6 </span>root root  <span class=\"number\"> 83 </span>6月 <span class=\"number\"> 25 </span>11:39 examples      <span class=\"comment\">#web应用实例</span></span><br><span class=\"line\">drwxr-x--- <span class=\"number\"> 5 </span>root root  <span class=\"number\"> 87 </span>6月 <span class=\"number\"> 25 </span>11:39 host-manager  <span class=\"comment\">#管理</span></span><br><span class=\"line\">drwxr-x--- <span class=\"number\"> 5 </span>root root <span class=\"number\"> 103 </span>6月 <span class=\"number\"> 25 </span>11:39 manager       <span class=\"comment\">#管理</span></span><br><span class=\"line\">drwxr-x--- <span class=\"number\"> 3 </span>root root <span class=\"number\"> 283 </span>6月 <span class=\"number\"> 25 </span>11:39 ROOT          <span class=\"comment\">#默认网站根目录</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Tomcat日志文件\"><a href=\"#Tomcat日志文件\" class=\"headerlink\" title=\"Tomcat日志文件\"></a>Tomcat日志文件</h2><blockquote>\n<p><code>tomcat</code>一般有几个日志文件，访问的一般放在<code>localhost</code>日志文件里面，管理的日志放在<code>manager</code>日志文件里面，实时日志一般在<code>catalina.out</code>里面</p>\n</blockquote>\n<figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@tomcat tomcat]</span># <span class=\"selector-tag\">cd</span> <span class=\"selector-tag\">logs</span>/</span><br><span class=\"line\"><span class=\"selector-attr\">[root@tomcat logs]</span># <span class=\"selector-tag\">ll</span></span><br><span class=\"line\">总用量 <span class=\"selector-tag\">180</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">82372</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span> <span class=\"selector-tag\">catalina</span><span class=\"selector-class\">.2019-06-25</span><span class=\"selector-class\">.log</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">82574</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span> <span class=\"selector-tag\">catalina</span><span class=\"selector-class\">.out</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span>     <span class=\"selector-tag\">0</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:18</span> <span class=\"selector-tag\">host-manager</span><span class=\"selector-class\">.2019-06-25</span><span class=\"selector-class\">.log</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span>  <span class=\"selector-tag\">6246</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span> <span class=\"selector-tag\">localhost</span><span class=\"selector-class\">.2019-06-25</span><span class=\"selector-class\">.log</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span>  <span class=\"selector-tag\">3489</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">14</span><span class=\"selector-pseudo\">:30</span> <span class=\"selector-tag\">localhost_access_log</span><span class=\"selector-class\">.2019-06-25</span><span class=\"selector-class\">.txt</span></span><br><span class=\"line\"><span class=\"selector-tag\">-rw-r-----</span> <span class=\"selector-tag\">1</span> <span class=\"selector-tag\">root</span> <span class=\"selector-tag\">root</span>     <span class=\"selector-tag\">0</span> <span class=\"selector-tag\">6</span>月  <span class=\"selector-tag\">25</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:18</span> <span class=\"selector-tag\">manager</span><span class=\"selector-class\">.2019-06-25</span><span class=\"selector-class\">.log</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-attr\">[root@tomcat logs]</span># <span class=\"selector-tag\">tailf</span> <span class=\"selector-tag\">catalina</span><span class=\"selector-class\">.out</span> </span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:24.674</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> <span class=\"selector-tag\">Deployment</span> <span class=\"selector-tag\">of</span> <span class=\"selector-tag\">web</span> <span class=\"selector-tag\">application</span> <span class=\"selector-tag\">directory</span> <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/docs]</span> <span class=\"selector-tag\">has</span> <span class=\"selector-tag\">finished</span> <span class=\"selector-tag\">in</span> <span class=\"selector-attr\">[27]</span> <span class=\"selector-tag\">ms</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:24.675</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> 把<span class=\"selector-tag\">web</span> 应用程序部署到目录 <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/examples]</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.113</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> <span class=\"selector-tag\">Deployment</span> <span class=\"selector-tag\">of</span> <span class=\"selector-tag\">web</span> <span class=\"selector-tag\">application</span> <span class=\"selector-tag\">directory</span> <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/examples]</span> <span class=\"selector-tag\">has</span> <span class=\"selector-tag\">finished</span> <span class=\"selector-tag\">in</span> <span class=\"selector-attr\">[438]</span> <span class=\"selector-tag\">ms</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.113</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> 把<span class=\"selector-tag\">web</span> 应用程序部署到目录 <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/host-manager]</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.163</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> <span class=\"selector-tag\">Deployment</span> <span class=\"selector-tag\">of</span> <span class=\"selector-tag\">web</span> <span class=\"selector-tag\">application</span> <span class=\"selector-tag\">directory</span> <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/host-manager]</span> <span class=\"selector-tag\">has</span> <span class=\"selector-tag\">finished</span> <span class=\"selector-tag\">in</span> <span class=\"selector-attr\">[50]</span> <span class=\"selector-tag\">ms</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.163</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> 把<span class=\"selector-tag\">web</span> 应用程序部署到目录 <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/manager]</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.220</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.HostConfig</span><span class=\"selector-class\">.deployDirectory</span> <span class=\"selector-tag\">Deployment</span> <span class=\"selector-tag\">of</span> <span class=\"selector-tag\">web</span> <span class=\"selector-tag\">application</span> <span class=\"selector-tag\">directory</span> <span class=\"selector-attr\">[/usr/local/apache-tomcat-9.0.21/webapps/manager]</span> <span class=\"selector-tag\">has</span> <span class=\"selector-tag\">finished</span> <span class=\"selector-tag\">in</span> <span class=\"selector-attr\">[57]</span> <span class=\"selector-tag\">ms</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.238</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.coyote</span><span class=\"selector-class\">.AbstractProtocol</span><span class=\"selector-class\">.start</span> 开始协议处理句柄<span class=\"selector-attr\">[\"http-nio-8080\"]</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.298</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.coyote</span><span class=\"selector-class\">.AbstractProtocol</span><span class=\"selector-class\">.start</span> 开始协议处理句柄<span class=\"selector-attr\">[\"ajp-nio-8009\"]</span></span><br><span class=\"line\"><span class=\"selector-tag\">25-Jun-2019</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:38</span><span class=\"selector-pseudo\">:25.302</span> 信息 <span class=\"selector-attr\">[main]</span> <span class=\"selector-tag\">org</span><span class=\"selector-class\">.apache</span><span class=\"selector-class\">.catalina</span><span class=\"selector-class\">.startup</span><span class=\"selector-class\">.Catalina</span><span class=\"selector-class\">.start</span> <span class=\"selector-tag\">Server</span> <span class=\"selector-tag\">startup</span> <span class=\"selector-tag\">in</span> <span class=\"selector-attr\">[1,290]</span> <span class=\"selector-tag\">milliseconds</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Tomcat配置文件\"><a href=\"#Tomcat配置文件\" class=\"headerlink\" title=\"Tomcat配置文件\"></a>Tomcat配置文件</h2><blockquote>\n<p><code>tomcat</code>配置文件存放在安装目录下的<code>conf</code>目录下面</p>\n</blockquote>\n<figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入到配置文件目录</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># cd /usr/local/tomcat/conf/</span></span><br><span class=\"line\">[root@tomcat conf]<span class=\"comment\"># ll</span></span><br><span class=\"line\">总用量 228</span><br><span class=\"line\">drwxr-x---<span class=\"number\"> 3 </span>root root    <span class=\"number\"> 23 </span>6月 <span class=\"number\"> 25 </span>12:18 Catalina</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root <span class=\"number\"> 12873 </span>6月  <span class=\"number\"> 5 </span>04:23 catalina.policy</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 7243 </span>6月  <span class=\"number\"> 5 </span>04:23 catalina.properties</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 1400 </span>6月  <span class=\"number\"> 5 </span>04:23 context.xml</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 1149 </span>6月  <span class=\"number\"> 5 </span>04:23 jaspic-providers.xml</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 2313 </span>6月  <span class=\"number\"> 5 </span>04:23 jaspic-providers.xsd</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 4144 </span>6月  <span class=\"number\"> 5 </span>04:23 logging.properties</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 7511 </span>6月  <span class=\"number\"> 5 </span>04:23 server.xml  <span class=\"comment\">#主配置文件</span></span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 2164 </span>6月  <span class=\"number\"> 5 </span>04:23 tomcat-users.xml  <span class=\"comment\">#Tomcat管理用户配置文件</span></span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root  <span class=\"number\"> 2633 </span>6月  <span class=\"number\"> 5 </span>04:23 tomcat-users.xsd</span><br><span class=\"line\">-rw-------<span class=\"number\"> 1 </span>root root<span class=\"number\"> 171962 </span>6月  <span class=\"number\"> 5 </span>04:23 web.xml</span><br></pre></td></tr></table></figure>\n<h3 id=\"Tomcat管理\"><a href=\"#Tomcat管理\" class=\"headerlink\" title=\"Tomcat管理\"></a>Tomcat管理</h3><blockquote>\n<p>配置<code>tomcat</code>的<code>web</code>界面管理功能，可以进行配置文件的管理，及部署在<code>tomcat</code>上的应用进行管理，默认情况是处于禁用状态。如果要开启这个功能，需要配置管理用户，即配置<code>tomcat-users.xml</code>文件。并且还需要修改manager项目下的<code>content.xml</code>文件，让其所有地址可访问</p>\n</blockquote>\n<figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑配置文件</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># vim /usr/local/tomcat/conf/tomcat-users.xml</span></span><br><span class=\"line\">...</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">\"manager-gui\"</span>/&gt;</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">\"admin-gui\"</span>/&gt;</span><br><span class=\"line\">&lt;user username=<span class=\"string\">\"tomcat\"</span> password=<span class=\"string\">\"tomcat\"</span> roles=<span class=\"string\">\"manager-gui,admin-gui\"</span>/&gt;</span><br><span class=\"line\">&lt;/tomcat-users&gt; <span class=\"comment\">#在这行前面加入上面三行</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑manager/META-INF/context.xml</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># vim /usr/local/tomcat/webapps/manager/META-INF/context.xml</span></span><br><span class=\"line\"><span class=\"comment\">#将</span></span><br><span class=\"line\">allow=<span class=\"string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\"</span> /&gt;</span><br><span class=\"line\"><span class=\"comment\">#改为</span></span><br><span class=\"line\">allow=<span class=\"string\">\"\\d+\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\"</span> /&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑host-manager/META-INF/context.xml</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># vim /usr/local/tomcat/webapps/host-manager/META-INF/context.xml</span></span><br><span class=\"line\"><span class=\"comment\">#将</span></span><br><span class=\"line\">allow=<span class=\"string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\"</span> /&gt;</span><br><span class=\"line\"><span class=\"comment\">#改为</span></span><br><span class=\"line\">allow=<span class=\"string\">\"\\d+\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\"</span> /&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启tomcat</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure>\n<p>访问测试<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat02.png\" alt><br>状态页面：<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat03.png\" alt><br>Manager页面：<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat04.png\" alt><br>Host Manager页面：<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat05.png\" alt></p>\n<h3 id=\"server-xml配置文件注释\"><a href=\"#server-xml配置文件注释\" class=\"headerlink\" title=\"server.xml配置文件注释\"></a>server.xml配置文件注释</h3><p>参考：<a href=\"https://www.cnblogs.com/sunshine-1/p/8990044.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/sunshine-1/p/8990044.html</a><br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Server</span> <span class=\"attr\">port</span>=<span class=\"string\">\"8005\"</span> <span class=\"attr\">shutdown</span>=<span class=\"string\">\"SHUTDOWN\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.startup.VersionLoggerListener\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.security.SecurityListener\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.core.AprLifecycleListener\"</span> <span class=\"attr\">SSLEngine</span>=<span class=\"string\">\"on\"</span> /&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.core.JasperListener\"</span> /&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.core.JreMemoryLeakPreventionListener\"</span> /&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\"</span> /&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.core.ThreadLocalLeakPreventionListener\"</span> /&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">GlobalNamingResources</span>&gt;</span> </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 全局命名资源，来定义一些外部访问资源，其作用是为所有引擎应用程序所引用的外部资源的定义 --!&gt; </span></span><br><span class=\"line\"><span class=\"comment\">    &lt;Resource name=\"UserDatabase\" auth=\"Container\" </span></span><br><span class=\"line\"><span class=\"comment\">              type=\"org.apache.catalina.UserDatabase\" </span></span><br><span class=\"line\"><span class=\"comment\">              description=\"User database that can be updated and saved\" </span></span><br><span class=\"line\"><span class=\"comment\">              factory=\"org.apache.catalina.users.MemoryUserDatabaseFactory\" </span></span><br><span class=\"line\"><span class=\"comment\">              pathname=\"conf/tomcat-users.xml\" /&gt; </span></span><br><span class=\"line\"><span class=\"comment\">  &lt;/GlobalNamingResources&gt; </span></span><br><span class=\"line\"><span class=\"comment\">  &lt;!-- 定义的一个名叫“UserDatabase”的认证资源，将conf/tomcat-users.xml加载至内存中，在需要认证的时候到内存中进行认证 --&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Service</span> <span class=\"attr\">name</span>=<span class=\"string\">\"Catalina\"</span>&gt;</span> </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- # 定义Service组件，同来关联Connector和Engine，一个Engine可以对应多个Connector，每个Service中只能一个Engine --!&gt; </span></span><br><span class=\"line\"><span class=\"comment\">    &lt;Connector port=\"80\" protocol=\"HTTP/1.1\" connectionTimeout=\"20000\" redirectPort=\"8443\" /&gt; </span></span><br><span class=\"line\"><span class=\"comment\">    &lt;!-- 修改HTTP/1.1的Connector监听端口为80.客户端通过浏览器访问的请求，只能通过HTTP传递给tomcat。还可以设置server与URIEncoding参数 --&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">\"8009\"</span> <span class=\"attr\">protocol</span>=<span class=\"string\">\"AJP/1.3\"</span> <span class=\"attr\">redirectPort</span>=<span class=\"string\">\"8443\"</span> /&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Engine</span> <span class=\"attr\">name</span>=<span class=\"string\">\"Catalina\"</span> <span class=\"attr\">defaultHost</span>=<span class=\"string\">\"test.com\"</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 修改当前Engine，默认主机是，www.test.com  --&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Realm</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.realm.LockOutRealm\"</span>&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Realm</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.realm.UserDatabaseRealm\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">resourceName</span>=<span class=\"string\">\"UserDatabase\"</span>/&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Realm</span>&gt;</span> </span><br><span class=\"line\">    # Realm组件，定义对当前容器内的应用程序访问的认证，通过外部资源UserDatabase进行认证 </span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">Host</span> <span class=\"attr\">name</span>=<span class=\"string\">\"test.com\"</span>  <span class=\"attr\">appBase</span>=<span class=\"string\">\"/web\"</span> <span class=\"attr\">unpackWARs</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">autoDeploy</span>=<span class=\"string\">\"true\"</span>&gt;</span> </span><br><span class=\"line\">      <span class=\"comment\">&lt;!--  定义一个主机，域名为：test.com，应用程序的目录是/web，设置自动部署，自动解压    --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Alias</span>&gt;</span>www.test.com<span class=\"tag\">&lt;/<span class=\"name\">Alias</span>&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--    定义一个别名www.test.com，类似apache的ServerAlias --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Context</span> <span class=\"attr\">path</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">docBase</span>=<span class=\"string\">\"www/\"</span> <span class=\"attr\">reloadable</span>=<span class=\"string\">\"true\"</span> /&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--    定义该应用程序，访问路径\"\"，即访问www.test.com即可访问，网页目录为：相对于appBase下的www/，即/web/www，并且当该应用程序下web.xml或者类等有相关变化时，自动重载当前配置，即不用重启tomcat使部署的新应用程序生效  --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Context</span> <span class=\"attr\">path</span>=<span class=\"string\">\"/bbs\"</span> <span class=\"attr\">docBase</span>=<span class=\"string\">\"/web/bbs\"</span> <span class=\"attr\">reloadable</span>=<span class=\"string\">\"true\"</span> /&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--  定义另外一个独立的应用程序(虚拟主机)，访问路径为：www.test.com/bbs，该应用程序网页目录为/web/bbs   --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Valve</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"attr\">directory</span>=<span class=\"string\">\"/web/www/logs\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">prefix</span>=<span class=\"string\">\"www_access.\"</span> <span class=\"attr\">suffix</span>=<span class=\"string\">\".log\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">pattern</span>=<span class=\"string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--   定义一个Valve组件，用来记录tomcat的访问日志，日志存放目录为：/web/www/logs如果定义为相对路径则是相当于$CATALINA_HOME，并非相对于appBase，这个要注意。定义日志文件前缀为www_access.并以.log结尾，pattern定义日志内容格式，具体字段表示可以查看tomcat官方文档   --&gt;</span> </span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">Host</span>&gt;</span> </span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">Host</span> <span class=\"attr\">name</span>=<span class=\"string\">\"manager.test.com\"</span> <span class=\"attr\">appBase</span>=<span class=\"string\">\"webapps\"</span> <span class=\"attr\">unpackWARs</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">autoDeploy</span>=<span class=\"string\">\"true\"</span>&gt;</span> </span><br><span class=\"line\">      <span class=\"comment\">&lt;!--   定义一个主机名为man.test.com，应用程序目录是$CATALINA_HOME/webapps,自动解压，自动部署   --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Valve</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.valves.RemoteAddrValve\"</span> <span class=\"attr\">allow</span>=<span class=\"string\">\"172.16.100.*\"</span> /&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--   定义远程地址访问策略，仅允许172.16.100.*网段访问该主机，其他的将被拒绝访问  --&gt;</span> </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Valve</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"attr\">directory</span>=<span class=\"string\">\"/web/bbs/logs\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">prefix</span>=<span class=\"string\">\"bbs_access.\"</span> <span class=\"attr\">suffix</span>=<span class=\"string\">\".log\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">pattern</span>=<span class=\"string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /&gt;</span> </span><br><span class=\"line\">        <span class=\"comment\">&lt;!--   定义该主机的访问日志      --&gt;</span> </span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">Host</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Engine</span>&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">Service</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Server</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Tomcat单实例站点部署\"><a href=\"#Tomcat单实例站点部署\" class=\"headerlink\" title=\"Tomcat单实例站点部署\"></a>Tomcat单实例站点部署</h2><blockquote>\n<p>以部署<code>jspxcms</code>为例，在上面已部署的环境下继续操作。</p>\n</blockquote>\n<p>1）安装<code>MySQL</code>及创建库<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">root@tomcat ~</span>]<span class=\"meta\"># yum -y install mariadb mariadb-server</span></span><br><span class=\"line\">[<span class=\"meta\">root@tomcat ~</span>]<span class=\"meta\"># systemctl enable mariadb</span></span><br><span class=\"line\">[<span class=\"meta\">root@tomcat ~</span>]<span class=\"meta\"># systemctl start mariadb</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 创建数据库并授权</span></span><br><span class=\"line\">MariaDB [(none)]&gt; create database jspxcms_test character <span class=\"keyword\">set</span> utf8;</span><br><span class=\"line\">MariaDB [(none)]&gt; grant all <span class=\"keyword\">on</span> jspxcms_test.* to <span class=\"string\">'jspxcmsuser'</span>@<span class=\"string\">'localhost'</span> identified <span class=\"keyword\">by</span> <span class=\"string\">'123'</span>;</span><br><span class=\"line\">MariaDB [(none)]&gt; flush privileges;</span><br></pre></td></tr></table></figure></p>\n<p>2）部署<code>jspxcms</code><br><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># tomcat默认的网站目录</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># ls /usr/local/tomcat/webapps/</span></span><br><span class=\"line\">docs  examples  host-manager  manager  ROOT</span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># ls /usr/local/tomcat/webapps/ROOT/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 上传jspxcms安装包并解压</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># mkdir tools</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># ls</span></span><br><span class=\"line\">jspxcms-<span class=\"number\">9.5</span>.<span class=\"number\">0</span>-release.zip</span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># unzip jspxcms-9.5.0-release.zip</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># ls</span></span><br><span class=\"line\">CHANGELOG.txt  database  jspxcms-<span class=\"number\">9.5</span>.<span class=\"number\">0</span>-release.zip  Jspxcms安装手册.pdf  ROOT  用户许可协议.txt</span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># rm -rf /usr/local/tomcat/webapps/*</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># cp -a ROOT /usr/local/tomcat/webapps/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 导入sql文件</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># mysql -D jspxcms_test &lt; database/mysql.sql</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑配置文件配置数据库连接信息</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> tools]<span class=\"comment\"># vim /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/application.properties</span></span><br><span class=\"line\">spring.datasource.url=<span class=\"symbol\">jdbc:</span><span class=\"symbol\">mysql:</span>/<span class=\"regexp\">/127.0.0.1:3306/jspxcms</span>_test?characterEncoding=utf8</span><br><span class=\"line\"><span class=\"comment\"># \\u6570\\u636E\\u5E93\\u7528\\u6237\\u540D</span></span><br><span class=\"line\">spring.datasource.username=jspxcmsuser</span><br><span class=\"line\"><span class=\"comment\"># \\u6570\\u636E\\u5E93\\u5BC6\\u7801</span></span><br><span class=\"line\">spring.datasource.password=<span class=\"number\">123</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启tomcat</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>web</code>页面访问 前台地址：<a href=\"http://ip:8080\" target=\"_blank\" rel=\"noopener\">http://ip:8080</a>  &emsp;后台地址：<a href=\"http://ip:8080/cmscp/index.do\" target=\"_blank\" rel=\"noopener\">http://ip:8080/cmscp/index.do</a>   &emsp; 默认账号：admin  密码为空<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat06.png\" alt><br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat07.png\" alt></p>\n<h2 id=\"Tomcat多实例站点部署\"><a href=\"#Tomcat多实例站点部署\" class=\"headerlink\" title=\"Tomcat多实例站点部署\"></a>Tomcat多实例站点部署</h2><blockquote>\n<p>多实例作用运行不同的应用（类似虚拟主机）<br>多实例运行相同的应用（实现负载均衡，支持高并发处理，session问题）<br>这里基于上面已安装的tomcat环境</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>环境</th>\n<th>Web监听端口</th>\n<th>管理实例端口</th>\n<th>站点家目录</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>tomcat9_1</td>\n<td>8081</td>\n<td>8091</td>\n<td>/webapps/tomcat9_1</td>\n</tr>\n<tr>\n<td>tomcat9_2</td>\n<td>8082</td>\n<td>8092</td>\n<td>/webapps/tomcat9_2</td>\n</tr>\n</tbody>\n</table>\n<p>1）拷贝tomcat目录<br><figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_1</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># cp -a /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat9_2</span></span><br></pre></td></tr></table></figure></p>\n<p>2）编辑配置文件，修改监听端口和站点家目录<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat ~]# vim /usr/local/tomcat9_1/conf/server.xml</span><br><span class=\"line\">&lt;Server <span class=\"attribute\">port</span>=<span class=\"string\">\"8091\"</span> <span class=\"attribute\">shutdown</span>=<span class=\"string\">\"SHUTDOWN\"</span>&gt;</span><br><span class=\"line\">&lt;Connector <span class=\"attribute\">port</span>=<span class=\"string\">\"8081\"</span> <span class=\"attribute\">protocol</span>=<span class=\"string\">\"HTTP/1.1\"</span></span><br><span class=\"line\">           <span class=\"attribute\">connectionTimeout</span>=<span class=\"string\">\"20000\"</span></span><br><span class=\"line\">           <span class=\"attribute\">redirectPort</span>=<span class=\"string\">\"8443\"</span> /&gt;</span><br><span class=\"line\">&lt;Host <span class=\"attribute\">name</span>=<span class=\"string\">\"localhost\"</span>  <span class=\"attribute\">appBase</span>=<span class=\"string\">\"/webapps/tomcat9_1\"</span></span><br><span class=\"line\">            <span class=\"attribute\">unpackWARs</span>=<span class=\"string\">\"true\"</span> <span class=\"attribute\">autoDeploy</span>=<span class=\"string\">\"true\"</span>&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@tomcat ~]# vim /usr/local/tomcat9_2/conf/server.xml</span><br><span class=\"line\">&lt;Server <span class=\"attribute\">port</span>=<span class=\"string\">\"8092\"</span> <span class=\"attribute\">shutdown</span>=<span class=\"string\">\"SHUTDOWN\"</span>&gt;</span><br><span class=\"line\">&lt;Connector <span class=\"attribute\">port</span>=<span class=\"string\">\"8082\"</span> <span class=\"attribute\">protocol</span>=<span class=\"string\">\"HTTP/1.1\"</span></span><br><span class=\"line\">           <span class=\"attribute\">connectionTimeout</span>=<span class=\"string\">\"20000\"</span></span><br><span class=\"line\">           <span class=\"attribute\">redirectPort</span>=<span class=\"string\">\"8443\"</span> /&gt;</span><br><span class=\"line\">&lt;Host <span class=\"attribute\">name</span>=<span class=\"string\">\"localhost\"</span>  <span class=\"attribute\">appBase</span>=<span class=\"string\">\"/webapps/tomcat9_2\"</span></span><br><span class=\"line\">            <span class=\"attribute\">unpackWARs</span>=<span class=\"string\">\"true\"</span> <span class=\"attribute\">autoDeploy</span>=<span class=\"string\">\"true\"</span>&gt;</span><br></pre></td></tr></table></figure></p>\n<p>3）创建站点家目录，及测试页面准备<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"meta\">@tomcat</span> ~]<span class=\"comment\"># mkdir -p /webapps/tomcat9_&#123;1,2&#125;</span></span><br><span class=\"line\">[root<span class=\"meta\">@tomcat</span> ~]<span class=\"comment\"># mkdir /webapps/tomcat9_&#123;1,2&#125;/ROOT</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># tomcat9_1测试页面准备</span></span><br><span class=\"line\">[root<span class=\"meta\">@tomcat</span> ~]<span class=\"comment\"># vim /webapps/tomcat9_1/ROOT/index.jsp</span></span><br><span class=\"line\"><span class=\"variable\">&lt;html&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;body&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;center&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;H1&gt;</span><span class=\"variable\">&lt;%=new java.util.Date()%&gt;</span><span class=\"variable\">&lt;/H1&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;H2&gt;</span>tomcat9_1<span class=\"variable\">&lt;/H2&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/center&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/body&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/html&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># tomcat9_2测试页面准备</span></span><br><span class=\"line\">[root<span class=\"meta\">@tomcat</span> ~]<span class=\"comment\"># vim /webapps/tomcat9_2/ROOT/index.jsp</span></span><br><span class=\"line\"><span class=\"variable\">&lt;html&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;body&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;center&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;H1&gt;</span><span class=\"variable\">&lt;%=new java.util.Date()%&gt;</span><span class=\"variable\">&lt;/H1&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;H2&gt;</span>tomcat9_2<span class=\"variable\">&lt;/H2&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/center&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/body&gt;</span></span><br><span class=\"line\"><span class=\"variable\">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>4）删除掉之前的站点目录里面的东西，对这里没有用了。可以直接删掉<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@tomcat</span> ~]<span class=\"meta\"># rm -rf /usr/local/tomcat9_2/webapps/*</span></span><br><span class=\"line\">[root<span class=\"symbol\">@tomcat</span> ~]<span class=\"meta\"># rm -rf /usr/local/tomcat9_1/webapps/*</span></span><br></pre></td></tr></table></figure></p>\n<p>5）启动<code>tomcat1</code>和<code>tomcat2</code><br><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># for i in &#123;1..2&#125;;do /usr/local/tomcat9_$i/bin/startup.sh; done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 端口查看</span></span><br><span class=\"line\">[root<span class=\"variable\">@tomcat</span> ~]<span class=\"comment\"># ss -tnlp |grep :80</span></span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">100</span>         ::<span class=\"symbol\">:</span><span class=\"number\">8080</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">27023</span>,fd=<span class=\"number\">54</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">100</span>         ::<span class=\"symbol\">:</span><span class=\"number\">8081</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">28687</span>,fd=<span class=\"number\">54</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">100</span>         ::<span class=\"symbol\">:</span><span class=\"number\">8082</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">28708</span>,fd=<span class=\"number\">54</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">1</span>         ::<span class=\"symbol\">ffff:</span><span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span><span class=\"symbol\">:</span><span class=\"number\">8091</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">28687</span>,fd=<span class=\"number\">65</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">1</span>         ::<span class=\"symbol\">ffff:</span><span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span><span class=\"symbol\">:</span><span class=\"number\">8092</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">28708</span>,fd=<span class=\"number\">66</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">1</span>         ::<span class=\"symbol\">ffff:</span><span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span><span class=\"symbol\">:</span><span class=\"number\">8005</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">27023</span>,fd=<span class=\"number\">71</span>))</span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">100</span>         ::<span class=\"symbol\">:</span><span class=\"number\">8009</span>                    ::<span class=\"symbol\">:*</span>                   <span class=\"symbol\">users:</span>((<span class=\"string\">\"java\"</span>,pid=<span class=\"number\">27023</span>,fd=<span class=\"number\">59</span>)</span><br></pre></td></tr></table></figure></p>\n<p>6）访问测试<br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat08.png\" alt=\"http://192.168.1.31:8081\"><br><img src=\"/2019/06/26/Tomcat安装与部署/tomcat09.png\" alt=\"http://192.168.1.31:8082\"></p>\n<p><strong>补充：Tomcat多实例启动脚本</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># cat TomcatSys.sh </span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#Desc：用于tomcat多实例部署启动脚本。</span></span><br><span class=\"line\"><span class=\"comment\">#Date：2019-6-26</span></span><br><span class=\"line\"><span class=\"comment\">#by：Lee-YJ</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> == <span class=\"string\">\"tomcat1\"</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">export</span> CATALINA_HOME=<span class=\"string\">\"/usr/local/tomcat9_1\"</span></span><br><span class=\"line\"><span class=\"keyword\">elif</span> [ <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> == <span class=\"string\">\"tomcat2\"</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">export</span> CATALINA_HOME=<span class=\"string\">\"/usr/local/tomcat9_2\"</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> $<span class=\"string\">\"Usage: <span class=\"variable\">$0</span> &#123;[tomcat1|tomcat2] start|stop|restart&#125;\"</span> &amp;&amp; <span class=\"built_in\">exit</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">\"<span class=\"variable\">$2</span>\"</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">start)</span><br><span class=\"line\">    <span class=\"variable\">$CATALINA_HOME</span>/bin/startup.sh</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">stop)</span><br><span class=\"line\">    <span class=\"variable\">$CATALINA_HOME</span>/bin/shutdown.sh</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">restart)</span><br><span class=\"line\">    <span class=\"variable\">$CATALINA_HOME</span>/bin/shutdown.sh</span><br><span class=\"line\">    sleep 3</span><br><span class=\"line\">    <span class=\"variable\">$CATALINA_HOME</span>/bin/startup.sh</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">    *)</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> $<span class=\"string\">\"Usage: <span class=\"variable\">$0</span> &#123;[tomcat1|tomcat2] start|stop|restart&#125;\"</span> &amp;&amp; <span class=\"built_in\">exit</span></span><br><span class=\"line\">    ;;</span><br><span class=\"line\"><span class=\"keyword\">esac</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用说明：</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># ./TomcatSys.sh tomcat1 start      #启动tomcat1</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># ./TomcatSys.sh tomcat1 stop       #停止tomcat1</span></span><br><span class=\"line\">[root@tomcat ~]<span class=\"comment\"># ./TomcatSys.sh tomcat2 restart    #重启tomcat2</span></span><br></pre></td></tr></table></figure></p>\n"},{"title":"Ansible之Playbook","date":"2019-05-29T07:35:22.000Z","copyright":true,"_content":"## Playbook介绍\n[playbook参考文档](https://ansible-tran.readthedocs.io/en/latest/docs/playbooks.html)\n>`Playbook`与`ad-hoc`相比,是一种完全不同的运用ansible的方式，类似与`saltstack`的`state`状态文件。`ad-hoc`无法持久使用，`playbook`可以持久使用。\n`playbook`是由一个或多个`play`组成的列表，`play`的主要功能在于将事先归并为一组的主机装扮成事先通过`ansible`中的`task`定义好的角色。从根本上来讲，所谓的`task`无非是调用`ansible`的一个`module`。将多个`play`组织在一个`playbook`中，即可以让它们联合起来按事先编排的机制完成某一任务\n\n\n## Playbook核心元素\n>- Hosts  执行的远程主机列表\n>- Tasks  任务集\n>- Varniables 内置变量或自定义变量在playbook中调用\n>- Templates 模板，即使用模板语法的文件，比如配置文件等\n>- Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行\n>- tags 标签，指定某条任务执行，用于选择运行playbook中的部分代码。\n\n## Playbook语法\n> `playbook`使用`yaml`语法格式，后缀可以是`yaml`,也可以是`yml`。\n- 在单一一个`playbook`文件中，可以连续三个连子号(`---`)区分多个`play`。还有选择性的连续三个点好(`...`)用来表示`play`的结尾，也可省略。\n- 次行开始正常写`playbook`的内容，一般都会写上描述该`playbook`的功能。\n- 使用#号注释代码。\n- 缩进必须统一，不能空格和`tab`混用。\n- 缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行实现的。\n- `YAML`文件内容和`Linux`系统大小写判断方式保持一致，是区分大小写的，`k/v`的值均需大小写敏感\n- `k/v`的值可同行写也可以换行写。同行使用:分隔。\n- `v`可以是个字符串，也可以是一个列表\n- 一个完整的代码块功能需要最少元素包括 `name: task`\n\n### 一个简单的示例\n```\n# 创建playbook文件\n[root@ansible ~]# cat playbook01.yml\n---                       #固定格式\n- hosts: 192.168.1.31     #定义需要执行主机\n  remote_user: root       #远程用户\n  vars:                   #定义变量\n    http_port: 8088       #变量\n\n  tasks:                             #定义一个任务的开始\n    - name: create new file          #定义任务的名称\n      file: name=/tmp/playtest.txt state=touch   #调用模块，具体要做的事情\n    - name: create new user\n      user: name=test02 system=yes shell=/sbin/nologin\n    - name: install package\n      yum: name=httpd\n    - name: config httpd\n      template: src=./httpd.conf dest=/etc/httpd/conf/httpd.conf\n      notify:                 #定义执行一个动作(action)让handlers来引用执行，与handlers配合使用\n        - restart apache      #notify要执行的动作，这里必须与handlers中的name定义内容一致\n    - name: copy index.html\n      copy: src=/var/www/html/index.html dest=/var/www/html/index.html\n    - name: start httpd\n      service: name=httpd state=started\n  handlers:                                    #处理器：更加tasks中notify定义的action触发执行相应的处理动作\n    - name: restart apache                     #要与notify定义的内容相同\n      service: name=httpd state=restarted      #触发要执行的动作\n\n#测试页面准备\n[root@ansible ~]# echo \"<h1>playbook test file</h1>\" >>/var/www/html/index.html\n#配置文件准备\n[root@ansible ~]# cat httpd.conf |grep ^Listen\nListen {{ http_port }}\n\n#执行playbook， 第一次执行可以加-C选项，检查写的playbook是否ok\n[root@ansible ~]# ansible-playbook playbook01.yml\nPLAY [192.168.1.31] *********************************************************************************************\nTASK [Gathering Facts] ******************************************************************************************\nok: [192.168.1.31]\nTASK [create new file] ******************************************************************************************\nchanged: [192.168.1.31]\nTASK [create new user] ******************************************************************************************\nchanged: [192.168.1.31]\nTASK [install package] ******************************************************************************************\nchanged: [192.168.1.31]\nTASK [config httpd] *********************************************************************************************\nchanged: [192.168.1.31]\nTASK [copy index.html] ******************************************************************************************\nchanged: [192.168.1.31]\nTASK [start httpd] **********************************************************************************************\nchanged: [192.168.1.31]\nPLAY RECAP ******************************************************************************************************\n192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 \n\n\n# 验证上面playbook执行的结果\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'ls /tmp/playtest.txt && id test02'\n192.168.1.31 | CHANGED | rc=0 >>\n/tmp/playtest.txt\nuid=990(test02) gid=985(test02) 组=985(test02)\n\n[root@ansible ~]# curl 192.168.1.31:8088\n<h1>playbook test file</h1>\n```\n## Playbook的运行方式\n\n>通过`ansible-playbook`命令运行\n格式：`ansible-playbook <filename.yml> ... [options]`\n```\n[root@ansible PlayBook]# ansible-playbook -h\n#ansible-playbook常用选项：\n--check  or -C    #只检测可能会发生的改变，但不真正执行操作\n--list-hosts      #列出运行任务的主机\n--list-tags       #列出playbook文件中定义所有的tags\n--list-tasks      #列出playbook文件中定义的所以任务集\n--limit           #主机列表 只针对主机列表中的某个主机或者某个组执行\n-f                #指定并发数，默认为5个\n-t                #指定tags运行，运行某一个或者多个tags。（前提playbook中有定义tags）\n-v                #显示过程  -vv  -vvv更详细\n```\n## Playbook中元素属性\n### 主机与用户\n>在一个`playbook`开始时，最先定义的是要操作的主机和用户\n \n```\n---\n- hosts: 192.168.1.31\n  remote_user: root\n```\n>除了上面的定义外，还可以在某一个`tasks`中定义要执行该任务的远程用户\n\n```\n  tasks: \n    - name: run df -h\n      remote_user: test\n      shell: name=df -h\n```\n> 还可以定义使用`sudo`授权用户执行该任务\n\n```\n  tasks: \n    - name: run df -h\n      sudo_user: test\n      sudo: yes\n      shell: name=df -h\n```\n### tasks任务列表\n>每一个`task`必须有一个名称`name`,这样在运行`playbook`时，从其输出的任务执行信息中可以很清楚的辨别是属于哪一个`task`的，如果没有定义 `name`，`action`的值将会用作输出信息中标记特定的`task`。\n每一个`playbook`中可以包含一个或者多个`tasks`任务列表，每一个`tasks`完成具体的一件事，（任务模块）比如创建一个用户或者安装一个软件等，在`hosts`中定义的主机或者主机组都将会执行这个被定义的`tasks`。\n\n```\n  tasks:\n    - name: create new file\n      file: path=/tmp/test01.txt state=touch\n    - name: create new user\n      user: name=test001 state=present\n```\n### Handlers与Notify\n>很多时候当我们某一个配置发生改变，我们需要重启服务，（比如httpd配置文件文件发生改变了）这时候就可以用到`handlers`和`notify`了；\n(当发生改动时)`notify actions`会在`playbook`的每一个task结束时被触发，而且即使有多个不同task通知改动的发生，`notify actions`知会被触发一次；比如多个`resources`指出因为一个配置文件被改动，所以`apache`需要重启，但是重新启动的操作知会被执行一次。\n\n```\n[root@ansible ~]# cat httpd.yml \n#用于安装httpd并配置启动\n---\n- hosts: 192.168.1.31\n  remote_user: root\n\n  tasks:\n  - name: install httpd\n    yum: name=httpd state=installed\n  - name: config httpd\n    template: src=/root/httpd.conf dest=/etc/httpd/conf/httpd.conf\n    notify:\n      - restart httpd\n  - name: start httpd\n    service: name=httpd state=started\n\n  handlers:\n    - name: restart httpd\n      service: name=httpd state=restarted\n\n#这里只要对httpd.conf配置文件作出了修改，修改后需要重启生效，在tasks中定义了restart httpd这个action，然后在handlers中引用上面tasks中定义的notify。\n```\n## Playbook中变量的使用\n**环境说明**：这里配置了两个组，一个apache组和一个nginx组\n```\n[root@ansible PlayBook]# cat /etc/ansible/hosts\n[apache]\n192.168.1.36\n192.168.1.33\n\n[nginx]\n192.168.1.3[1:2]\n```\n### 命令行指定变量\n>执行`playbook`时候通过参数`-e`传入变量，这样传入的变量在整个`playbook`中都可以被调用，属于全局变量\n\n```\n[root@ansible PlayBook]# cat variables.yml \n---\n- hosts: all\n  remote_user: root\n\n  tasks:\n    - name: install pkg\n      yum: name={{ pkg }}\n\n#执行playbook 指定pkg\n[root@ansible PlayBook]# ansible-playbook -e \"pkg=httpd\" variables.yml\n```\n### hosts文件中定义变量\n>在`/etc/ansible/hosts`文件中定义变量，可以针对每个主机定义不同的变量，也可以定义一个组的变量，然后直接在`playbook`中直接调用。注意，组中定义的变量没有单个主机中的优先级高。\n\n```\n# 编辑hosts文件定义变量\n[root@ansible PlayBook]# vim /etc/ansible/hosts\n[apache]\n192.168.1.36 webdir=/opt/test     #定义单个主机的变量\n192.168.1.33\n[apache:vars]      #定义整个组的统一变量\nwebdir=/web/test\n\n[nginx]\n192.168.1.3[1:2]\n[nginx:vars]\nwebdir=/opt/web\n\n\n# 编辑playbook文件\n[root@ansible PlayBook]# cat variables.yml \n---\n- hosts: all\n  remote_user: root\n\n  tasks:\n    - name: create webdir\n      file: name={{ webdir }} state=directory   #引用变量\n\n\n# 执行playbook\n[root@ansible PlayBook]# ansible-playbook variables.yml\n```\n### playbook文件中定义变量\n>编写`playbook`时，直接在里面定义变量，然后直接引用，可以定义多个变量；注意：如果在执行`playbook`时，又通过`-e`参数指定变量的值，那么会以`-e`参数指定的为准。\n\n```\n# 编辑playbook\n[root@ansible PlayBook]# cat variables.yml \n---\n- hosts: all\n  remote_user: root\n  vars:                #定义变量\n    pkg: nginx         #变量1\n    dir: /tmp/test1    #变量2\n\n  tasks:\n    - name: install pkg\n      yum: name={{ pkg }} state=installed    #引用变量\n    - name: create new dir\n      file: name={{ dir }} state=directory   #引用变量\n\n\n# 执行playbook\n[root@ansible PlayBook]# ansible-playbook variables.yml\n\n# 如果执行时候又重新指定了变量的值，那么会已重新指定的为准\n[root@ansible PlayBook]# ansible-playbook -e \"dir=/tmp/test2\" variables.yml\n```\n### 调用setup模块获取变量\n> `setup`模块默认是获取主机信息的，有时候在`playbook`中需要用到，所以可以直接调用。常用的参数[参考](https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup)\n\n```\n# 编辑playbook文件\n[root@ansible PlayBook]# cat variables.yml \n---\n- hosts: all\n  remote_user: root\n\n  tasks:\n    - name: create file\n      file: name={{ ansible_fqdn }}.log state=touch   #引用setup中的ansible_fqdn\n\n\n# 执行playbook\n[root@ansible PlayBook]# ansible-playbook variables.yml\n```\n### 独立的变量YAML文件中定义\n> 为了方便管理将所有的变量统一放在一个独立的变量`YAML`文件中，`laybook`文件直接引用文件调用变量即可。\n\n```\n# 定义存放变量的文件\n[root@ansible PlayBook]# cat var.yml \nvar1: vsftpd\nvar2: httpd\n\n# 编写playbook\n[root@ansible PlayBook]# cat variables.yml \n---\n- hosts: all\n  remote_user: root\n  vars_files:    #引用变量文件\n    - ./var.yml   #指定变量文件的path（这里可以是绝对路径，也可以是相对路径）\n\n  tasks:\n    - name: install package\n      yum: name={{ var1 }}   #引用变量\n    - name: create file\n      file: name=/tmp/{{ var2 }}.log state=touch   #引用变量\n\n\n# 执行playbook\n[root@ansible PlayBook]# ansible-playbook  variables.yml\n```\n## Playbook中标签的使用\n> 一个`playbook`文件中，执行时如果想执行某一个任务，那么可以给每个任务集进行打标签，这样在执行的时候可以通过`-t`选择指定标签执行，还可以通过`--skip-tags`选择除了某个标签外全部执行等。\n\n```\n# 编辑playbook\n[root@ansible PlayBook]# cat httpd.yml \n---\n- hosts: 192.168.1.31\n  remote_user: root\n\n  tasks:\n    - name: install httpd\n      yum: name=httpd state=installed\n      tags: inhttpd\n\n    - name: start httpd\n      service: name=httpd state=started\n      tags: sthttpd\n\n    - name: restart httpd\n      service: name=httpd state=restarted\n      tags: \n        - rshttpd\n        - rs_httpd\n\n# 正常执行的结果\n[root@ansible PlayBook]# ansible-playbook httpd.yml \n\nPLAY [192.168.1.31] **************************************************************************************************************************\n\nTASK [Gathering Facts] ***********************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [install httpd] *************************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [start httpd] ***************************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [restart httpd] *************************************************************************************************************************\nchanged: [192.168.1.31]\n\nPLAY RECAP ***********************************************************************************************************************************\n192.168.1.31               : ok=4    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 \n```\n1）通过`-t`选项指定`tags`进行执行\n```\n# 通过-t指定tags名称，多个tags用逗号隔开\n[root@ansible PlayBook]# ansible-playbook -t rshttpd httpd.yml \n\nPLAY [192.168.1.31] **************************************************************************************************************************\n\nTASK [Gathering Facts] ***********************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [restart httpd] *************************************************************************************************************************\nchanged: [192.168.1.31]\n\nPLAY RECAP ***********************************************************************************************************************************\n192.168.1.31               : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n```\n2）通过`--skip-tags`选项排除不执行的`tags`\n```\n[root@ansible PlayBook]# ansible-playbook --skip-tags inhttpd httpd.yml \n\nPLAY [192.168.1.31] **************************************************************************************************************************\n\nTASK [Gathering Facts] ***********************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [start httpd] ***************************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [restart httpd] *************************************************************************************************************************\nchanged: [192.168.1.31]\n\nPLAY RECAP ***********************************************************************************************************************************\n192.168.1.31               : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 \n```\n## Playbook中模板的使用\n>`template `模板为我们提供了动态配置服务，使用`jinja2`语言，里面支持多种条件判断、循环、逻辑运算、比较操作等。其实说白了也就是一个文件，和之前配置文件使用`copy`一样，只是使用`copy`，不能根据服务器配置不一样进行不同动态的配置。这样就不利于管理。\n说明：\n1、多数情况下都将`template`文件放在和`playbook`文件同级的`templates`目录下（手动创建），这样`playbook`文件中可以直接引用，会自动去找这个文件。如果放在别的地方，也可以通过绝对路径去指定。\n2、模板文件后缀名为`.j2`。\n\n[循环参考](http://www.ansible.com.cn/docs/playbooks_loops.html#standard-loops)\n**示例：通过template安装httpd**\n1）`playbook`文件编写\n```\n[root@ansible PlayBook]# cat testtmp.yml \n#模板示例\n---\n- hosts: all\n  remote_user: root\n  vars:\n    - listen_port: 88    #定义变量\n\n  tasks:\n    - name: Install Httpd\n      yum: name=httpd state=installed\n    - name: Config Httpd\n      template: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf    #使用模板\n      notify: Restart Httpd\n    - name: Start Httpd\n      service: name=httpd state=started\n      \n  handlers:\n    - name: Restart Httpd\n      service: name=httpd state=restarted\n```\n2）模板文件准备，`httpd`配置文件准备，这里配置文件端口使用了变量\n```\n[root@ansible PlayBook]# cat templates/httpd.conf.j2 |grep ^Listen\nListen {{ listen_port }}\n```\n3）查看目录结构\n```\n# 目录结构\n[root@ansible PlayBook]# tree .\n.\n├── templates\n│   └── httpd.conf.j2\n└── testtmp.yml\n\n1 directory, 2 files\n```\n4）执行`playbook`，由于`192.168.1.36`那台机器是`6`的系统，模板文件里面的配置文件是`7`上面默认的`httpd`配置文件，`httpd`版本不一样(`6默认版本为2.2.15，7默认版本为2.4.6`)，所以拷贝过去后启动报错。下面使用`playbook`中的判断语句进行处理；此处先略过\n```\n[root@ansible PlayBook]# ansible-playbook testtmp.yml \n\nPLAY [all] ******************************************************************************************\n\nTASK [Gathering Facts] ******************************************************************************\nok: [192.168.1.36]\nok: [192.168.1.32]\nok: [192.168.1.33]\nok: [192.168.1.31]\n\nTASK [Install Httpd] ********************************************************************************\nok: [192.168.1.36]\nok: [192.168.1.33]\nok: [192.168.1.32]\nok: [192.168.1.31]\n\nTASK [Config Httpd] *********************************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.36]\n\nTASK [Start Httpd] **********************************************************************************\nfatal: [192.168.1.36]: FAILED! => {\"changed\": false, \"msg\": \"httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\\n\"}\nchanged: [192.168.1.32]\nchanged: [192.168.1.33]\nchanged: [192.168.1.31]\n\nRUNNING HANDLER [Restart Httpd] *********************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.32]\nchanged: [192.168.1.33]\n\nPLAY RECAP ******************************************************************************************\n192.168.1.31               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.32               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.33               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.36               : ok=3    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0\n```\n### template之when\n[when语句参考](http://www.ansible.com.cn/docs/playbooks_conditionals.html#when)\n>条件测试：如果需要根据变量、`facts`或此前任务的执行结果来做为某`task`执行与否的前提时要用到条件测试，通过`when`语句执行，在`task`中使用`jinja2`的语法格式、\nwhen语句：\n在`task`后添加`when`子句即可使用条件测试；`when`语句支持`jinja2`表达式语法。\n\n类似这样：\n```\ntasks:\n  - command: /bin/false\n    register: result\n    ignore_errors: True\n  - command: /bin/something\n    when: result|failed\n  - command: /bin/something_else\n    when: result|success\n  - command: /bin/still/something_else\n    when: result|skipped\n```\n**示例：通过when语句完善上面的httpd配置**\n1）准备两个配置文件，一个`centos6`系统`httpd`配置文件，一个`centos7`系统httpd配置文件。\n```\n[root@ansible PlayBook]# tree templates/\ntemplates/\n├── httpd6.conf.j2     #6系统2.2.15版本httpd配置文件\n└── httpd7.conf.j2     #7系统2.4.6版本httpd配置文件\n\n0 directories, 2 files\n```\n2）修改`playbook`文件，通过setup模块获取系统版本去判断。[setup常用模块](https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup)\n```\n[root@ansible PlayBook]# cat testtmp.yml \n#when示例\n---\n- hosts: all\n  remote_user: root\n  vars:\n    - listen_port: 88\n\n  tasks:\n    - name: Install Httpd\n      yum: name=httpd state=installed\n    - name: Config System6 Httpd\n      template: src=httpd6.conf.j2 dest=/etc/httpd/conf/httpd.conf\n      when: ansible_distribution_major_version == \"6\"   #判断系统版本，为6便执行上面的template配置6的配置文件\n      notify: Restart Httpd\n    - name: Config System7 Httpd\n      template: src=httpd7.conf.j2 dest=/etc/httpd/conf/httpd.conf\n      when: ansible_distribution_major_version == \"7\"   #判断系统版本，为7便执行上面的template配置7的配置文件\n      notify: Restart Httpd\n    - name: Start Httpd\n      service: name=httpd state=started\n\n  handlers:\n    - name: Restart Httpd\n      service: name=httpd state=restarted\n```\n3）执行playbook\n```\n[root@ansible PlayBook]# ansible-playbook testtmp.yml\n\nPLAY [all] ******************************************************************************************\n\nTASK [Gathering Facts] ******************************************************************************\nok: [192.168.1.31]\nok: [192.168.1.32]\nok: [192.168.1.33]\nok: [192.168.1.36]\n\nTASK [Install Httpd] ********************************************************************************\nok: [192.168.1.32]\nok: [192.168.1.33]\nok: [192.168.1.31]\nok: [192.168.1.36]\n\nTASK [Config System6 Httpd] *************************************************************************\nskipping: [192.168.1.33]\nskipping: [192.168.1.31]\nskipping: [192.168.1.32]\nchanged: [192.168.1.36]\n\nTASK [Config System7 Httpd] *************************************************************************\nskipping: [192.168.1.36]\nchanged: [192.168.1.33]\nchanged: [192.168.1.31]\nchanged: [192.168.1.32]\n\nTASK [Start Httpd] **********************************************************************************\nok: [192.168.1.36]\nok: [192.168.1.31]\nok: [192.168.1.32]\nok: [192.168.1.33]\n\nRUNNING HANDLER [Restart Httpd] *********************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.31]\nchanged: [192.168.1.32]\nchanged: [192.168.1.36]\n\nPLAY RECAP ******************************************************************************************\n192.168.1.31               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n192.168.1.32               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n192.168.1.33               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n192.168.1.36               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0\n```\n### template之with_items\n>`with_items`迭代，当有需要重复性执行的任务时，可以使用迭代机制。\n对迭代项的引用，固定变量名为`“item”`，要在task中使用with_items给定要迭代的元素列表。\n列表格式：\n&emsp;&ensp;字符串\n&emsp;&ensp;字典\n\n**示例1：通过with_items安装多个不同软件**\n编写`playbook`\n```\n[root@ansible PlayBook]# cat testwith.yml \n# 示例with_items\n---\n- hosts: all\n  remote_user: root\n\n  tasks:\n    - name: Install Package\n      yum: name={{ item }} state=installed   #引用item获取值\n      with_items:     #定义with_items\n        - httpd\n        - vsftpd\n        - nginx\n```\n上面`tasks`写法等同于：\n```\n---\n- hosts: all\n  remote_user: root\n  tasks:\n    - name: Install Httpd\n      yum: name=httpd state=installed\n    - name: Install Vsftpd\n      yum: name=vsftpd state=installed\n    - name: Install Nginx\n      yum: name=nginx state=installed\n```\n**示例2：通过嵌套子变量创建用户并加入不同的组**\n1）编写`playbook`\n```\n[root@ansible PlayBook]# cat testwith01.yml \n# 示例with_items嵌套子变量\n---\n- hosts: all\n  remote_user: root\n\n  tasks:\n    - name: Create New Group\n      group: name={{ item }} state=present\n      with_items: \n        - group1\n        - group2\n        - group3 \n\n    - name: Create New User\n      user: name={{ item.name }} group={{ item.group }} state=present\n      with_items:\n        - { name: 'user1', group: 'group1' } \n        - { name: 'user2', group: 'group2' } \n        - { name: 'user3', group: 'group3' }\n```\n2）执行`playbook`并验证\n```\n# 执行playbook\n[root@ansible PlayBook]# ansible-playbook testwith01.yml\n\n# 验证是否成功创建用户及组\n[root@ansible PlayBook]# ansible all -m shell -a 'tail -3 /etc/passwd'\n192.168.1.36 | CHANGED | rc=0 >>\nuser1:x:500:500::/home/user1:/bin/bash\nuser2:x:501:501::/home/user2:/bin/bash\nuser3:x:502:502::/home/user3:/bin/bash\n\n192.168.1.32 | CHANGED | rc=0 >>\nuser1:x:1001:1001::/home/user1:/bin/bash\nuser2:x:1002:1002::/home/user2:/bin/bash\nuser3:x:1003:1003::/home/user3:/bin/bash\n\n192.168.1.31 | CHANGED | rc=0 >>\nuser1:x:1002:1003::/home/user1:/bin/bash\nuser2:x:1003:1004::/home/user2:/bin/bash\nuser3:x:1004:1005::/home/user3:/bin/bash\n\n192.168.1.33 | CHANGED | rc=0 >>\nuser1:x:1001:1001::/home/user1:/bin/bash\nuser2:x:1002:1002::/home/user2:/bin/bash\nuser3:x:1003:1003::/home/user3:/bin/bash\n```\n### template之for if\n>通过使用`for`，`if`可以更加灵活的生成配置文件等需求，还可以在里面根据各种条件进行判断，然后生成不同的配置文件、或者服务器配置相关等。\n\n**示例1**\n1）编写`playbook`\n```\n[root@ansible PlayBook]# cat testfor01.yml \n# template for 示例\n---\n- hosts: all\n  remote_user: root\n  vars:\n    nginx_vhost_port:\n      - 81\n      - 82\n      - 83\n\n  tasks:\n    - name: Templage Nginx Config\n      template: src=nginx.conf.j2 dest=/tmp/nginx_test.conf\n```\n2）模板文件编写\n```\n# 循环playbook文件中定义的变量，依次赋值给port\n[root@ansible PlayBook]# cat templates/nginx.conf.j2 \n{% for port in nginx_vhost_port %}\nserver{\n     listen: {{ port }};\n     server_name: localhost;\n}\n{% endfor %}\n```\n3）执行`playbook`并查看生成结果\n```\n[root@ansible PlayBook]# ansible-playbook testfor01.yml\n\n# 去到一个节点看下生成的结果发现自动生成了三个虚拟主机\n[root@linux ~]# cat /tmp/nginx_test.conf \nserver{\n     listen: 81;\n     server_name: localhost;\n}\nserver{\n     listen: 82;\n     server_name: localhost;\n}\nserver{\n     listen: 83;\n     server_name: localhost;\n}\n```\n**示例2**\n1）编写`playbook`\n```\n[root@ansible PlayBook]# cat testfor02.yml \n# template for 示例\n---\n- hosts: all\n  remote_user: root\n  vars:\n    nginx_vhosts:\n      - web1:\n        listen: 8081\n        server_name: \"web1.example.com\"\n        root: \"/var/www/nginx/web1\"\n      - web2:\n        listen: 8082\n        server_name: \"web2.example.com\"\n        root: \"/var/www/nginx/web2\"\n      - web3:\n        listen: 8083\n        server_name: \"web3.example.com\"\n        root: \"/var/www/nginx/web3\"\n\n  tasks:\n    - name: Templage Nginx Config\n      template: src=nginx.conf.j2 dest=/tmp/nginx_vhost.conf\n```\n2）模板文件编写\n```\n[root@ansible PlayBook]# cat templates/nginx.conf.j2 \n{% for vhost in nginx_vhosts %}\nserver{\n     listen:    {{ vhost.listen }};\n     server_name:    {{ vhost.server_name }};\n     root:   {{ vhost.root }}; \n}\n{% endfor %}\n```\n3）执行`playbook`并查看生成结果\n```\n[root@ansible PlayBook]# ansible-playbook testfor02.yml\n\n# 去到一个节点看下生成的结果发现自动生成了三个虚拟主机\n[root@linux ~]# cat /tmp/nginx_vhost.conf \nserver{\n     listen:    8081;\n     server_name:    web1.example.com;\n     root:   /var/www/nginx/web1; \n}\nserver{\n     listen:    8082;\n     server_name:    web2.example.com;\n     root:   /var/www/nginx/web2; \n}\nserver{\n     listen:    8083;\n     server_name:    web3.example.com;\n     root:   /var/www/nginx/web3; \n}\n```\n**示例3**\n在for循环中再嵌套if判断，让生成的配置文件更加灵活\n1）编写`playbook`\n```\n[root@ansible PlayBook]# cat testfor03.yml \n# template for 示例\n---\n- hosts: all\n  remote_user: root\n  vars:\n    nginx_vhosts:\n      - web1:\n        listen: 8081\n        root: \"/var/www/nginx/web1\"\n      - web2:\n        server_name: \"web2.example.com\"\n        root: \"/var/www/nginx/web2\"\n      - web3:\n        listen: 8083\n        server_name: \"web3.example.com\"\n        root: \"/var/www/nginx/web3\"\n\n  tasks:\n    - name: Templage Nginx Config\n      template: src=nginx.conf.j2 dest=/tmp/nginx_vhost.conf\n```\n2）模板文件编写\n```\n# 说明：这里添加了判断，如果listen没有定义的话，默认端口使用8888，如果server_name有定义，那么生成的配置文件中才有这一项。\n[root@ansible PlayBook]# cat templates/nginx.conf.j2 \n{% for vhost in nginx_vhosts %}\nserver{\n     {% if vhost.listen is defined %}\n     listen:    {{ vhost.listen }};\n     {% else %}\n     listen: 8888;\n     {% endif %}\n     {% if vhost.server_name is defined %}\n     server_name:    {{ vhost.server_name }};\n     {% endif %}\n     root:   {{ vhost.root }}; \n}\n{% endfor %}\n```\n3）执行`playbook`并查看生成结果\n```\n[root@ansible PlayBook]# ansible-playbook testfor03.yml\n\n# 去到一个节点看下生成的结果发现自动生成了三个虚拟主机\n[root@linux ~]# cat /tmp/nginx_vhost.conf \nserver{\n          listen:    8081;\n          root:   /var/www/nginx/web1; \n}\nserver{\n          listen: 8888;\n          server_name:    web2.example.com;\n          root:   /var/www/nginx/web2; \n}\nserver{\n          listen:    8083;\n          server_name:    web3.example.com;\n          root:   /var/www/nginx/web3; \n}\n```\n\n**上面三个示例的图片展示效果**\n{% tabs %}\n<!-- tab 示例1 -->\n![](Ansible之Playbook/shili01.png)\n<!-- endtab -->\n<!-- tab 示例2 -->\n![](Ansible之Playbook/shili02.png)\n<!-- endtab -->\n<!-- tab 示例3 -->\n![](Ansible之Playbook/shili03.png)\n<!-- endtab -->\n{% endtabs %}\n\n\n\n\n\n\n","source":"_posts/Ansible之Playbook.md","raw":"---\ntitle: Ansible之Playbook\ndate: 2019-05-29 15:35:22\ntags: Ansible\ncategories: Ansible\ncopyright: true\n---\n## Playbook介绍\n[playbook参考文档](https://ansible-tran.readthedocs.io/en/latest/docs/playbooks.html)\n>`Playbook`与`ad-hoc`相比,是一种完全不同的运用ansible的方式，类似与`saltstack`的`state`状态文件。`ad-hoc`无法持久使用，`playbook`可以持久使用。\n`playbook`是由一个或多个`play`组成的列表，`play`的主要功能在于将事先归并为一组的主机装扮成事先通过`ansible`中的`task`定义好的角色。从根本上来讲，所谓的`task`无非是调用`ansible`的一个`module`。将多个`play`组织在一个`playbook`中，即可以让它们联合起来按事先编排的机制完成某一任务\n\n\n## Playbook核心元素\n>- Hosts  执行的远程主机列表\n>- Tasks  任务集\n>- Varniables 内置变量或自定义变量在playbook中调用\n>- Templates 模板，即使用模板语法的文件，比如配置文件等\n>- Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行\n>- tags 标签，指定某条任务执行，用于选择运行playbook中的部分代码。\n\n## Playbook语法\n> `playbook`使用`yaml`语法格式，后缀可以是`yaml`,也可以是`yml`。\n- 在单一一个`playbook`文件中，可以连续三个连子号(`---`)区分多个`play`。还有选择性的连续三个点好(`...`)用来表示`play`的结尾，也可省略。\n- 次行开始正常写`playbook`的内容，一般都会写上描述该`playbook`的功能。\n- 使用#号注释代码。\n- 缩进必须统一，不能空格和`tab`混用。\n- 缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行实现的。\n- `YAML`文件内容和`Linux`系统大小写判断方式保持一致，是区分大小写的，`k/v`的值均需大小写敏感\n- `k/v`的值可同行写也可以换行写。同行使用:分隔。\n- `v`可以是个字符串，也可以是一个列表\n- 一个完整的代码块功能需要最少元素包括 `name: task`\n\n### 一个简单的示例\n```\n# 创建playbook文件\n[root@ansible ~]# cat playbook01.yml\n---                       #固定格式\n- hosts: 192.168.1.31     #定义需要执行主机\n  remote_user: root       #远程用户\n  vars:                   #定义变量\n    http_port: 8088       #变量\n\n  tasks:                             #定义一个任务的开始\n    - name: create new file          #定义任务的名称\n      file: name=/tmp/playtest.txt state=touch   #调用模块，具体要做的事情\n    - name: create new user\n      user: name=test02 system=yes shell=/sbin/nologin\n    - name: install package\n      yum: name=httpd\n    - name: config httpd\n      template: src=./httpd.conf dest=/etc/httpd/conf/httpd.conf\n      notify:                 #定义执行一个动作(action)让handlers来引用执行，与handlers配合使用\n        - restart apache      #notify要执行的动作，这里必须与handlers中的name定义内容一致\n    - name: copy index.html\n      copy: src=/var/www/html/index.html dest=/var/www/html/index.html\n    - name: start httpd\n      service: name=httpd state=started\n  handlers:                                    #处理器：更加tasks中notify定义的action触发执行相应的处理动作\n    - name: restart apache                     #要与notify定义的内容相同\n      service: name=httpd state=restarted      #触发要执行的动作\n\n#测试页面准备\n[root@ansible ~]# echo \"<h1>playbook test file</h1>\" >>/var/www/html/index.html\n#配置文件准备\n[root@ansible ~]# cat httpd.conf |grep ^Listen\nListen {{ http_port }}\n\n#执行playbook， 第一次执行可以加-C选项，检查写的playbook是否ok\n[root@ansible ~]# ansible-playbook playbook01.yml\nPLAY [192.168.1.31] *********************************************************************************************\nTASK [Gathering Facts] ******************************************************************************************\nok: [192.168.1.31]\nTASK [create new file] ******************************************************************************************\nchanged: [192.168.1.31]\nTASK [create new user] ******************************************************************************************\nchanged: [192.168.1.31]\nTASK [install package] ******************************************************************************************\nchanged: [192.168.1.31]\nTASK [config httpd] *********************************************************************************************\nchanged: [192.168.1.31]\nTASK [copy index.html] ******************************************************************************************\nchanged: [192.168.1.31]\nTASK [start httpd] **********************************************************************************************\nchanged: [192.168.1.31]\nPLAY RECAP ******************************************************************************************************\n192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 \n\n\n# 验证上面playbook执行的结果\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'ls /tmp/playtest.txt && id test02'\n192.168.1.31 | CHANGED | rc=0 >>\n/tmp/playtest.txt\nuid=990(test02) gid=985(test02) 组=985(test02)\n\n[root@ansible ~]# curl 192.168.1.31:8088\n<h1>playbook test file</h1>\n```\n## Playbook的运行方式\n\n>通过`ansible-playbook`命令运行\n格式：`ansible-playbook <filename.yml> ... [options]`\n```\n[root@ansible PlayBook]# ansible-playbook -h\n#ansible-playbook常用选项：\n--check  or -C    #只检测可能会发生的改变，但不真正执行操作\n--list-hosts      #列出运行任务的主机\n--list-tags       #列出playbook文件中定义所有的tags\n--list-tasks      #列出playbook文件中定义的所以任务集\n--limit           #主机列表 只针对主机列表中的某个主机或者某个组执行\n-f                #指定并发数，默认为5个\n-t                #指定tags运行，运行某一个或者多个tags。（前提playbook中有定义tags）\n-v                #显示过程  -vv  -vvv更详细\n```\n## Playbook中元素属性\n### 主机与用户\n>在一个`playbook`开始时，最先定义的是要操作的主机和用户\n \n```\n---\n- hosts: 192.168.1.31\n  remote_user: root\n```\n>除了上面的定义外，还可以在某一个`tasks`中定义要执行该任务的远程用户\n\n```\n  tasks: \n    - name: run df -h\n      remote_user: test\n      shell: name=df -h\n```\n> 还可以定义使用`sudo`授权用户执行该任务\n\n```\n  tasks: \n    - name: run df -h\n      sudo_user: test\n      sudo: yes\n      shell: name=df -h\n```\n### tasks任务列表\n>每一个`task`必须有一个名称`name`,这样在运行`playbook`时，从其输出的任务执行信息中可以很清楚的辨别是属于哪一个`task`的，如果没有定义 `name`，`action`的值将会用作输出信息中标记特定的`task`。\n每一个`playbook`中可以包含一个或者多个`tasks`任务列表，每一个`tasks`完成具体的一件事，（任务模块）比如创建一个用户或者安装一个软件等，在`hosts`中定义的主机或者主机组都将会执行这个被定义的`tasks`。\n\n```\n  tasks:\n    - name: create new file\n      file: path=/tmp/test01.txt state=touch\n    - name: create new user\n      user: name=test001 state=present\n```\n### Handlers与Notify\n>很多时候当我们某一个配置发生改变，我们需要重启服务，（比如httpd配置文件文件发生改变了）这时候就可以用到`handlers`和`notify`了；\n(当发生改动时)`notify actions`会在`playbook`的每一个task结束时被触发，而且即使有多个不同task通知改动的发生，`notify actions`知会被触发一次；比如多个`resources`指出因为一个配置文件被改动，所以`apache`需要重启，但是重新启动的操作知会被执行一次。\n\n```\n[root@ansible ~]# cat httpd.yml \n#用于安装httpd并配置启动\n---\n- hosts: 192.168.1.31\n  remote_user: root\n\n  tasks:\n  - name: install httpd\n    yum: name=httpd state=installed\n  - name: config httpd\n    template: src=/root/httpd.conf dest=/etc/httpd/conf/httpd.conf\n    notify:\n      - restart httpd\n  - name: start httpd\n    service: name=httpd state=started\n\n  handlers:\n    - name: restart httpd\n      service: name=httpd state=restarted\n\n#这里只要对httpd.conf配置文件作出了修改，修改后需要重启生效，在tasks中定义了restart httpd这个action，然后在handlers中引用上面tasks中定义的notify。\n```\n## Playbook中变量的使用\n**环境说明**：这里配置了两个组，一个apache组和一个nginx组\n```\n[root@ansible PlayBook]# cat /etc/ansible/hosts\n[apache]\n192.168.1.36\n192.168.1.33\n\n[nginx]\n192.168.1.3[1:2]\n```\n### 命令行指定变量\n>执行`playbook`时候通过参数`-e`传入变量，这样传入的变量在整个`playbook`中都可以被调用，属于全局变量\n\n```\n[root@ansible PlayBook]# cat variables.yml \n---\n- hosts: all\n  remote_user: root\n\n  tasks:\n    - name: install pkg\n      yum: name={{ pkg }}\n\n#执行playbook 指定pkg\n[root@ansible PlayBook]# ansible-playbook -e \"pkg=httpd\" variables.yml\n```\n### hosts文件中定义变量\n>在`/etc/ansible/hosts`文件中定义变量，可以针对每个主机定义不同的变量，也可以定义一个组的变量，然后直接在`playbook`中直接调用。注意，组中定义的变量没有单个主机中的优先级高。\n\n```\n# 编辑hosts文件定义变量\n[root@ansible PlayBook]# vim /etc/ansible/hosts\n[apache]\n192.168.1.36 webdir=/opt/test     #定义单个主机的变量\n192.168.1.33\n[apache:vars]      #定义整个组的统一变量\nwebdir=/web/test\n\n[nginx]\n192.168.1.3[1:2]\n[nginx:vars]\nwebdir=/opt/web\n\n\n# 编辑playbook文件\n[root@ansible PlayBook]# cat variables.yml \n---\n- hosts: all\n  remote_user: root\n\n  tasks:\n    - name: create webdir\n      file: name={{ webdir }} state=directory   #引用变量\n\n\n# 执行playbook\n[root@ansible PlayBook]# ansible-playbook variables.yml\n```\n### playbook文件中定义变量\n>编写`playbook`时，直接在里面定义变量，然后直接引用，可以定义多个变量；注意：如果在执行`playbook`时，又通过`-e`参数指定变量的值，那么会以`-e`参数指定的为准。\n\n```\n# 编辑playbook\n[root@ansible PlayBook]# cat variables.yml \n---\n- hosts: all\n  remote_user: root\n  vars:                #定义变量\n    pkg: nginx         #变量1\n    dir: /tmp/test1    #变量2\n\n  tasks:\n    - name: install pkg\n      yum: name={{ pkg }} state=installed    #引用变量\n    - name: create new dir\n      file: name={{ dir }} state=directory   #引用变量\n\n\n# 执行playbook\n[root@ansible PlayBook]# ansible-playbook variables.yml\n\n# 如果执行时候又重新指定了变量的值，那么会已重新指定的为准\n[root@ansible PlayBook]# ansible-playbook -e \"dir=/tmp/test2\" variables.yml\n```\n### 调用setup模块获取变量\n> `setup`模块默认是获取主机信息的，有时候在`playbook`中需要用到，所以可以直接调用。常用的参数[参考](https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup)\n\n```\n# 编辑playbook文件\n[root@ansible PlayBook]# cat variables.yml \n---\n- hosts: all\n  remote_user: root\n\n  tasks:\n    - name: create file\n      file: name={{ ansible_fqdn }}.log state=touch   #引用setup中的ansible_fqdn\n\n\n# 执行playbook\n[root@ansible PlayBook]# ansible-playbook variables.yml\n```\n### 独立的变量YAML文件中定义\n> 为了方便管理将所有的变量统一放在一个独立的变量`YAML`文件中，`laybook`文件直接引用文件调用变量即可。\n\n```\n# 定义存放变量的文件\n[root@ansible PlayBook]# cat var.yml \nvar1: vsftpd\nvar2: httpd\n\n# 编写playbook\n[root@ansible PlayBook]# cat variables.yml \n---\n- hosts: all\n  remote_user: root\n  vars_files:    #引用变量文件\n    - ./var.yml   #指定变量文件的path（这里可以是绝对路径，也可以是相对路径）\n\n  tasks:\n    - name: install package\n      yum: name={{ var1 }}   #引用变量\n    - name: create file\n      file: name=/tmp/{{ var2 }}.log state=touch   #引用变量\n\n\n# 执行playbook\n[root@ansible PlayBook]# ansible-playbook  variables.yml\n```\n## Playbook中标签的使用\n> 一个`playbook`文件中，执行时如果想执行某一个任务，那么可以给每个任务集进行打标签，这样在执行的时候可以通过`-t`选择指定标签执行，还可以通过`--skip-tags`选择除了某个标签外全部执行等。\n\n```\n# 编辑playbook\n[root@ansible PlayBook]# cat httpd.yml \n---\n- hosts: 192.168.1.31\n  remote_user: root\n\n  tasks:\n    - name: install httpd\n      yum: name=httpd state=installed\n      tags: inhttpd\n\n    - name: start httpd\n      service: name=httpd state=started\n      tags: sthttpd\n\n    - name: restart httpd\n      service: name=httpd state=restarted\n      tags: \n        - rshttpd\n        - rs_httpd\n\n# 正常执行的结果\n[root@ansible PlayBook]# ansible-playbook httpd.yml \n\nPLAY [192.168.1.31] **************************************************************************************************************************\n\nTASK [Gathering Facts] ***********************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [install httpd] *************************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [start httpd] ***************************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [restart httpd] *************************************************************************************************************************\nchanged: [192.168.1.31]\n\nPLAY RECAP ***********************************************************************************************************************************\n192.168.1.31               : ok=4    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 \n```\n1）通过`-t`选项指定`tags`进行执行\n```\n# 通过-t指定tags名称，多个tags用逗号隔开\n[root@ansible PlayBook]# ansible-playbook -t rshttpd httpd.yml \n\nPLAY [192.168.1.31] **************************************************************************************************************************\n\nTASK [Gathering Facts] ***********************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [restart httpd] *************************************************************************************************************************\nchanged: [192.168.1.31]\n\nPLAY RECAP ***********************************************************************************************************************************\n192.168.1.31               : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n```\n2）通过`--skip-tags`选项排除不执行的`tags`\n```\n[root@ansible PlayBook]# ansible-playbook --skip-tags inhttpd httpd.yml \n\nPLAY [192.168.1.31] **************************************************************************************************************************\n\nTASK [Gathering Facts] ***********************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [start httpd] ***************************************************************************************************************************\nok: [192.168.1.31]\n\nTASK [restart httpd] *************************************************************************************************************************\nchanged: [192.168.1.31]\n\nPLAY RECAP ***********************************************************************************************************************************\n192.168.1.31               : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 \n```\n## Playbook中模板的使用\n>`template `模板为我们提供了动态配置服务，使用`jinja2`语言，里面支持多种条件判断、循环、逻辑运算、比较操作等。其实说白了也就是一个文件，和之前配置文件使用`copy`一样，只是使用`copy`，不能根据服务器配置不一样进行不同动态的配置。这样就不利于管理。\n说明：\n1、多数情况下都将`template`文件放在和`playbook`文件同级的`templates`目录下（手动创建），这样`playbook`文件中可以直接引用，会自动去找这个文件。如果放在别的地方，也可以通过绝对路径去指定。\n2、模板文件后缀名为`.j2`。\n\n[循环参考](http://www.ansible.com.cn/docs/playbooks_loops.html#standard-loops)\n**示例：通过template安装httpd**\n1）`playbook`文件编写\n```\n[root@ansible PlayBook]# cat testtmp.yml \n#模板示例\n---\n- hosts: all\n  remote_user: root\n  vars:\n    - listen_port: 88    #定义变量\n\n  tasks:\n    - name: Install Httpd\n      yum: name=httpd state=installed\n    - name: Config Httpd\n      template: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf    #使用模板\n      notify: Restart Httpd\n    - name: Start Httpd\n      service: name=httpd state=started\n      \n  handlers:\n    - name: Restart Httpd\n      service: name=httpd state=restarted\n```\n2）模板文件准备，`httpd`配置文件准备，这里配置文件端口使用了变量\n```\n[root@ansible PlayBook]# cat templates/httpd.conf.j2 |grep ^Listen\nListen {{ listen_port }}\n```\n3）查看目录结构\n```\n# 目录结构\n[root@ansible PlayBook]# tree .\n.\n├── templates\n│   └── httpd.conf.j2\n└── testtmp.yml\n\n1 directory, 2 files\n```\n4）执行`playbook`，由于`192.168.1.36`那台机器是`6`的系统，模板文件里面的配置文件是`7`上面默认的`httpd`配置文件，`httpd`版本不一样(`6默认版本为2.2.15，7默认版本为2.4.6`)，所以拷贝过去后启动报错。下面使用`playbook`中的判断语句进行处理；此处先略过\n```\n[root@ansible PlayBook]# ansible-playbook testtmp.yml \n\nPLAY [all] ******************************************************************************************\n\nTASK [Gathering Facts] ******************************************************************************\nok: [192.168.1.36]\nok: [192.168.1.32]\nok: [192.168.1.33]\nok: [192.168.1.31]\n\nTASK [Install Httpd] ********************************************************************************\nok: [192.168.1.36]\nok: [192.168.1.33]\nok: [192.168.1.32]\nok: [192.168.1.31]\n\nTASK [Config Httpd] *********************************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.33]\nchanged: [192.168.1.32]\nchanged: [192.168.1.36]\n\nTASK [Start Httpd] **********************************************************************************\nfatal: [192.168.1.36]: FAILED! => {\"changed\": false, \"msg\": \"httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\\n\"}\nchanged: [192.168.1.32]\nchanged: [192.168.1.33]\nchanged: [192.168.1.31]\n\nRUNNING HANDLER [Restart Httpd] *********************************************************************\nchanged: [192.168.1.31]\nchanged: [192.168.1.32]\nchanged: [192.168.1.33]\n\nPLAY RECAP ******************************************************************************************\n192.168.1.31               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.32               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.33               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.1.36               : ok=3    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0\n```\n### template之when\n[when语句参考](http://www.ansible.com.cn/docs/playbooks_conditionals.html#when)\n>条件测试：如果需要根据变量、`facts`或此前任务的执行结果来做为某`task`执行与否的前提时要用到条件测试，通过`when`语句执行，在`task`中使用`jinja2`的语法格式、\nwhen语句：\n在`task`后添加`when`子句即可使用条件测试；`when`语句支持`jinja2`表达式语法。\n\n类似这样：\n```\ntasks:\n  - command: /bin/false\n    register: result\n    ignore_errors: True\n  - command: /bin/something\n    when: result|failed\n  - command: /bin/something_else\n    when: result|success\n  - command: /bin/still/something_else\n    when: result|skipped\n```\n**示例：通过when语句完善上面的httpd配置**\n1）准备两个配置文件，一个`centos6`系统`httpd`配置文件，一个`centos7`系统httpd配置文件。\n```\n[root@ansible PlayBook]# tree templates/\ntemplates/\n├── httpd6.conf.j2     #6系统2.2.15版本httpd配置文件\n└── httpd7.conf.j2     #7系统2.4.6版本httpd配置文件\n\n0 directories, 2 files\n```\n2）修改`playbook`文件，通过setup模块获取系统版本去判断。[setup常用模块](https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup)\n```\n[root@ansible PlayBook]# cat testtmp.yml \n#when示例\n---\n- hosts: all\n  remote_user: root\n  vars:\n    - listen_port: 88\n\n  tasks:\n    - name: Install Httpd\n      yum: name=httpd state=installed\n    - name: Config System6 Httpd\n      template: src=httpd6.conf.j2 dest=/etc/httpd/conf/httpd.conf\n      when: ansible_distribution_major_version == \"6\"   #判断系统版本，为6便执行上面的template配置6的配置文件\n      notify: Restart Httpd\n    - name: Config System7 Httpd\n      template: src=httpd7.conf.j2 dest=/etc/httpd/conf/httpd.conf\n      when: ansible_distribution_major_version == \"7\"   #判断系统版本，为7便执行上面的template配置7的配置文件\n      notify: Restart Httpd\n    - name: Start Httpd\n      service: name=httpd state=started\n\n  handlers:\n    - name: Restart Httpd\n      service: name=httpd state=restarted\n```\n3）执行playbook\n```\n[root@ansible PlayBook]# ansible-playbook testtmp.yml\n\nPLAY [all] ******************************************************************************************\n\nTASK [Gathering Facts] ******************************************************************************\nok: [192.168.1.31]\nok: [192.168.1.32]\nok: [192.168.1.33]\nok: [192.168.1.36]\n\nTASK [Install Httpd] ********************************************************************************\nok: [192.168.1.32]\nok: [192.168.1.33]\nok: [192.168.1.31]\nok: [192.168.1.36]\n\nTASK [Config System6 Httpd] *************************************************************************\nskipping: [192.168.1.33]\nskipping: [192.168.1.31]\nskipping: [192.168.1.32]\nchanged: [192.168.1.36]\n\nTASK [Config System7 Httpd] *************************************************************************\nskipping: [192.168.1.36]\nchanged: [192.168.1.33]\nchanged: [192.168.1.31]\nchanged: [192.168.1.32]\n\nTASK [Start Httpd] **********************************************************************************\nok: [192.168.1.36]\nok: [192.168.1.31]\nok: [192.168.1.32]\nok: [192.168.1.33]\n\nRUNNING HANDLER [Restart Httpd] *********************************************************************\nchanged: [192.168.1.33]\nchanged: [192.168.1.31]\nchanged: [192.168.1.32]\nchanged: [192.168.1.36]\n\nPLAY RECAP ******************************************************************************************\n192.168.1.31               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n192.168.1.32               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n192.168.1.33               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n192.168.1.36               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0\n```\n### template之with_items\n>`with_items`迭代，当有需要重复性执行的任务时，可以使用迭代机制。\n对迭代项的引用，固定变量名为`“item”`，要在task中使用with_items给定要迭代的元素列表。\n列表格式：\n&emsp;&ensp;字符串\n&emsp;&ensp;字典\n\n**示例1：通过with_items安装多个不同软件**\n编写`playbook`\n```\n[root@ansible PlayBook]# cat testwith.yml \n# 示例with_items\n---\n- hosts: all\n  remote_user: root\n\n  tasks:\n    - name: Install Package\n      yum: name={{ item }} state=installed   #引用item获取值\n      with_items:     #定义with_items\n        - httpd\n        - vsftpd\n        - nginx\n```\n上面`tasks`写法等同于：\n```\n---\n- hosts: all\n  remote_user: root\n  tasks:\n    - name: Install Httpd\n      yum: name=httpd state=installed\n    - name: Install Vsftpd\n      yum: name=vsftpd state=installed\n    - name: Install Nginx\n      yum: name=nginx state=installed\n```\n**示例2：通过嵌套子变量创建用户并加入不同的组**\n1）编写`playbook`\n```\n[root@ansible PlayBook]# cat testwith01.yml \n# 示例with_items嵌套子变量\n---\n- hosts: all\n  remote_user: root\n\n  tasks:\n    - name: Create New Group\n      group: name={{ item }} state=present\n      with_items: \n        - group1\n        - group2\n        - group3 \n\n    - name: Create New User\n      user: name={{ item.name }} group={{ item.group }} state=present\n      with_items:\n        - { name: 'user1', group: 'group1' } \n        - { name: 'user2', group: 'group2' } \n        - { name: 'user3', group: 'group3' }\n```\n2）执行`playbook`并验证\n```\n# 执行playbook\n[root@ansible PlayBook]# ansible-playbook testwith01.yml\n\n# 验证是否成功创建用户及组\n[root@ansible PlayBook]# ansible all -m shell -a 'tail -3 /etc/passwd'\n192.168.1.36 | CHANGED | rc=0 >>\nuser1:x:500:500::/home/user1:/bin/bash\nuser2:x:501:501::/home/user2:/bin/bash\nuser3:x:502:502::/home/user3:/bin/bash\n\n192.168.1.32 | CHANGED | rc=0 >>\nuser1:x:1001:1001::/home/user1:/bin/bash\nuser2:x:1002:1002::/home/user2:/bin/bash\nuser3:x:1003:1003::/home/user3:/bin/bash\n\n192.168.1.31 | CHANGED | rc=0 >>\nuser1:x:1002:1003::/home/user1:/bin/bash\nuser2:x:1003:1004::/home/user2:/bin/bash\nuser3:x:1004:1005::/home/user3:/bin/bash\n\n192.168.1.33 | CHANGED | rc=0 >>\nuser1:x:1001:1001::/home/user1:/bin/bash\nuser2:x:1002:1002::/home/user2:/bin/bash\nuser3:x:1003:1003::/home/user3:/bin/bash\n```\n### template之for if\n>通过使用`for`，`if`可以更加灵活的生成配置文件等需求，还可以在里面根据各种条件进行判断，然后生成不同的配置文件、或者服务器配置相关等。\n\n**示例1**\n1）编写`playbook`\n```\n[root@ansible PlayBook]# cat testfor01.yml \n# template for 示例\n---\n- hosts: all\n  remote_user: root\n  vars:\n    nginx_vhost_port:\n      - 81\n      - 82\n      - 83\n\n  tasks:\n    - name: Templage Nginx Config\n      template: src=nginx.conf.j2 dest=/tmp/nginx_test.conf\n```\n2）模板文件编写\n```\n# 循环playbook文件中定义的变量，依次赋值给port\n[root@ansible PlayBook]# cat templates/nginx.conf.j2 \n{% for port in nginx_vhost_port %}\nserver{\n     listen: {{ port }};\n     server_name: localhost;\n}\n{% endfor %}\n```\n3）执行`playbook`并查看生成结果\n```\n[root@ansible PlayBook]# ansible-playbook testfor01.yml\n\n# 去到一个节点看下生成的结果发现自动生成了三个虚拟主机\n[root@linux ~]# cat /tmp/nginx_test.conf \nserver{\n     listen: 81;\n     server_name: localhost;\n}\nserver{\n     listen: 82;\n     server_name: localhost;\n}\nserver{\n     listen: 83;\n     server_name: localhost;\n}\n```\n**示例2**\n1）编写`playbook`\n```\n[root@ansible PlayBook]# cat testfor02.yml \n# template for 示例\n---\n- hosts: all\n  remote_user: root\n  vars:\n    nginx_vhosts:\n      - web1:\n        listen: 8081\n        server_name: \"web1.example.com\"\n        root: \"/var/www/nginx/web1\"\n      - web2:\n        listen: 8082\n        server_name: \"web2.example.com\"\n        root: \"/var/www/nginx/web2\"\n      - web3:\n        listen: 8083\n        server_name: \"web3.example.com\"\n        root: \"/var/www/nginx/web3\"\n\n  tasks:\n    - name: Templage Nginx Config\n      template: src=nginx.conf.j2 dest=/tmp/nginx_vhost.conf\n```\n2）模板文件编写\n```\n[root@ansible PlayBook]# cat templates/nginx.conf.j2 \n{% for vhost in nginx_vhosts %}\nserver{\n     listen:    {{ vhost.listen }};\n     server_name:    {{ vhost.server_name }};\n     root:   {{ vhost.root }}; \n}\n{% endfor %}\n```\n3）执行`playbook`并查看生成结果\n```\n[root@ansible PlayBook]# ansible-playbook testfor02.yml\n\n# 去到一个节点看下生成的结果发现自动生成了三个虚拟主机\n[root@linux ~]# cat /tmp/nginx_vhost.conf \nserver{\n     listen:    8081;\n     server_name:    web1.example.com;\n     root:   /var/www/nginx/web1; \n}\nserver{\n     listen:    8082;\n     server_name:    web2.example.com;\n     root:   /var/www/nginx/web2; \n}\nserver{\n     listen:    8083;\n     server_name:    web3.example.com;\n     root:   /var/www/nginx/web3; \n}\n```\n**示例3**\n在for循环中再嵌套if判断，让生成的配置文件更加灵活\n1）编写`playbook`\n```\n[root@ansible PlayBook]# cat testfor03.yml \n# template for 示例\n---\n- hosts: all\n  remote_user: root\n  vars:\n    nginx_vhosts:\n      - web1:\n        listen: 8081\n        root: \"/var/www/nginx/web1\"\n      - web2:\n        server_name: \"web2.example.com\"\n        root: \"/var/www/nginx/web2\"\n      - web3:\n        listen: 8083\n        server_name: \"web3.example.com\"\n        root: \"/var/www/nginx/web3\"\n\n  tasks:\n    - name: Templage Nginx Config\n      template: src=nginx.conf.j2 dest=/tmp/nginx_vhost.conf\n```\n2）模板文件编写\n```\n# 说明：这里添加了判断，如果listen没有定义的话，默认端口使用8888，如果server_name有定义，那么生成的配置文件中才有这一项。\n[root@ansible PlayBook]# cat templates/nginx.conf.j2 \n{% for vhost in nginx_vhosts %}\nserver{\n     {% if vhost.listen is defined %}\n     listen:    {{ vhost.listen }};\n     {% else %}\n     listen: 8888;\n     {% endif %}\n     {% if vhost.server_name is defined %}\n     server_name:    {{ vhost.server_name }};\n     {% endif %}\n     root:   {{ vhost.root }}; \n}\n{% endfor %}\n```\n3）执行`playbook`并查看生成结果\n```\n[root@ansible PlayBook]# ansible-playbook testfor03.yml\n\n# 去到一个节点看下生成的结果发现自动生成了三个虚拟主机\n[root@linux ~]# cat /tmp/nginx_vhost.conf \nserver{\n          listen:    8081;\n          root:   /var/www/nginx/web1; \n}\nserver{\n          listen: 8888;\n          server_name:    web2.example.com;\n          root:   /var/www/nginx/web2; \n}\nserver{\n          listen:    8083;\n          server_name:    web3.example.com;\n          root:   /var/www/nginx/web3; \n}\n```\n\n**上面三个示例的图片展示效果**\n{% tabs %}\n<!-- tab 示例1 -->\n![](Ansible之Playbook/shili01.png)\n<!-- endtab -->\n<!-- tab 示例2 -->\n![](Ansible之Playbook/shili02.png)\n<!-- endtab -->\n<!-- tab 示例3 -->\n![](Ansible之Playbook/shili03.png)\n<!-- endtab -->\n{% endtabs %}\n\n\n\n\n\n\n","slug":"Ansible之Playbook","published":1,"updated":"2019-07-10T01:46:29.882Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjxwlqrqo002llctcvyy5yzln","content":"<h2 id=\"Playbook介绍\"><a href=\"#Playbook介绍\" class=\"headerlink\" title=\"Playbook介绍\"></a>Playbook介绍</h2><p><a href=\"https://ansible-tran.readthedocs.io/en/latest/docs/playbooks.html\" target=\"_blank\" rel=\"noopener\">playbook参考文档</a></p>\n<blockquote>\n<p><code>Playbook</code>与<code>ad-hoc</code>相比,是一种完全不同的运用ansible的方式，类似与<code>saltstack</code>的<code>state</code>状态文件。<code>ad-hoc</code>无法持久使用，<code>playbook</code>可以持久使用。<br><code>playbook</code>是由一个或多个<code>play</code>组成的列表，<code>play</code>的主要功能在于将事先归并为一组的主机装扮成事先通过<code>ansible</code>中的<code>task</code>定义好的角色。从根本上来讲，所谓的<code>task</code>无非是调用<code>ansible</code>的一个<code>module</code>。将多个<code>play</code>组织在一个<code>playbook</code>中，即可以让它们联合起来按事先编排的机制完成某一任务</p>\n</blockquote>\n<h2 id=\"Playbook核心元素\"><a href=\"#Playbook核心元素\" class=\"headerlink\" title=\"Playbook核心元素\"></a>Playbook核心元素</h2><blockquote>\n<ul>\n<li>Hosts  执行的远程主机列表</li>\n<li>Tasks  任务集</li>\n<li>Varniables 内置变量或自定义变量在playbook中调用</li>\n<li>Templates 模板，即使用模板语法的文件，比如配置文件等</li>\n<li>Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li>\n<li>tags 标签，指定某条任务执行，用于选择运行playbook中的部分代码。</li>\n</ul>\n</blockquote>\n<h2 id=\"Playbook语法\"><a href=\"#Playbook语法\" class=\"headerlink\" title=\"Playbook语法\"></a>Playbook语法</h2><blockquote>\n<p><code>playbook</code>使用<code>yaml</code>语法格式，后缀可以是<code>yaml</code>,也可以是<code>yml</code>。</p>\n<ul>\n<li>在单一一个<code>playbook</code>文件中，可以连续三个连子号(<code>---</code>)区分多个<code>play</code>。还有选择性的连续三个点好(<code>...</code>)用来表示<code>play</code>的结尾，也可省略。</li>\n<li>次行开始正常写<code>playbook</code>的内容，一般都会写上描述该<code>playbook</code>的功能。</li>\n<li>使用#号注释代码。</li>\n<li>缩进必须统一，不能空格和<code>tab</code>混用。</li>\n<li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行实现的。</li>\n<li><code>YAML</code>文件内容和<code>Linux</code>系统大小写判断方式保持一致，是区分大小写的，<code>k/v</code>的值均需大小写敏感</li>\n<li><code>k/v</code>的值可同行写也可以换行写。同行使用:分隔。</li>\n<li><code>v</code>可以是个字符串，也可以是一个列表</li>\n<li>一个完整的代码块功能需要最少元素包括 <code>name: task</code></li>\n</ul>\n</blockquote>\n<h3 id=\"一个简单的示例\"><a href=\"#一个简单的示例\" class=\"headerlink\" title=\"一个简单的示例\"></a>一个简单的示例</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># 创建playbook文件</span></span><br><span class=\"line\">[root@ansible ~]# cat playbook01.yml</span><br><span class=\"line\">---                       #固定格式</span><br><span class=\"line\"><span class=\"bullet\">- </span>hosts: 192.168.1.31     #定义需要执行主机</span><br><span class=\"line\">  remote_user: root       #远程用户</span><br><span class=\"line\">  vars:                   #定义变量</span><br><span class=\"line\"><span class=\"code\">    http_port: 8088       #变量</span></span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:                             #定义一个任务的开始</span><br><span class=\"line\"><span class=\"code\">    - name: create new file          #定义任务的名称</span></span><br><span class=\"line\"><span class=\"code\">      file: name=/tmp/playtest.txt state=touch   #调用模块，具体要做的事情</span></span><br><span class=\"line\"><span class=\"code\">    - name: create new user</span></span><br><span class=\"line\"><span class=\"code\">      user: name=test02 system=yes shell=/sbin/nologin</span></span><br><span class=\"line\"><span class=\"code\">    - name: install package</span></span><br><span class=\"line\"><span class=\"code\">      yum: name=httpd</span></span><br><span class=\"line\"><span class=\"code\">    - name: config httpd</span></span><br><span class=\"line\"><span class=\"code\">      template: src=./httpd.conf dest=/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"code\">      notify:                 #定义执行一个动作(action)让handlers来引用执行，与handlers配合使用</span></span><br><span class=\"line\"><span class=\"code\">        - restart apache      #notify要执行的动作，这里必须与handlers中的name定义内容一致</span></span><br><span class=\"line\"><span class=\"code\">    - name: copy index.html</span></span><br><span class=\"line\"><span class=\"code\">      copy: src=/var/www/html/index.html dest=/var/www/html/index.html</span></span><br><span class=\"line\"><span class=\"code\">    - name: start httpd</span></span><br><span class=\"line\"><span class=\"code\">      service: name=httpd state=started</span></span><br><span class=\"line\">  handlers:                                    #处理器：更加tasks中notify定义的action触发执行相应的处理动作</span><br><span class=\"line\"><span class=\"code\">    - name: restart apache                     #要与notify定义的内容相同</span></span><br><span class=\"line\"><span class=\"code\">      service: name=httpd state=restarted      #触发要执行的动作</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">#测试页面准备</span></span><br><span class=\"line\">[root@ansible ~]# echo \"<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">h1</span>&gt;</span></span>playbook test file<span class=\"xml\"><span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span></span>\" &gt;&gt;/var/www/html/index.html</span><br><span class=\"line\"><span class=\"section\">#配置文件准备</span></span><br><span class=\"line\">[root@ansible ~]# cat httpd.conf |grep ^Listen</span><br><span class=\"line\">Listen &#123;&#123; http_port &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">#执行playbook， 第一次执行可以加-C选项，检查写的playbook是否ok</span></span><br><span class=\"line\">[root@ansible ~]# ansible-playbook playbook01.yml</span><br><span class=\"line\">PLAY [192.168.1.31] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">TASK [create new file] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">TASK [create new user] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">TASK [install package] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">TASK [config httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">TASK [copy index.html] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">TASK [start httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\"># 验证上面playbook执行的结果</span></span><br><span class=\"line\">[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'ls /tmp/playtest.txt &amp;&amp; id test02'</span><br><span class=\"line\">192.168.1.31 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">/tmp/playtest.txt</span><br><span class=\"line\">uid=990(test02) gid=985(test02) 组=985(test02)</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]# curl 192.168.1.31:8088</span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">h1</span>&gt;</span></span>playbook test file<span class=\"xml\"><span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span></span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Playbook的运行方式\"><a href=\"#Playbook的运行方式\" class=\"headerlink\" title=\"Playbook的运行方式\"></a>Playbook的运行方式</h2><blockquote>\n<p>通过<code>ansible-playbook</code>命令运行<br>格式：<code>ansible-playbook &lt;filename.yml&gt; ... [options]</code><br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# ansible-playbook -h</span><br><span class=\"line\">#ansible-playbook常用选项：</span><br><span class=\"line\">-<span class=\"ruby\">-check  <span class=\"keyword\">or</span> -C    <span class=\"comment\">#只检测可能会发生的改变，但不真正执行操作</span></span></span><br><span class=\"line\"><span class=\"ruby\">--list-hosts      <span class=\"comment\">#列出运行任务的主机</span></span></span><br><span class=\"line\"><span class=\"ruby\">--list-tags       <span class=\"comment\">#列出playbook文件中定义所有的tags</span></span></span><br><span class=\"line\"><span class=\"ruby\">--list-tasks      <span class=\"comment\">#列出playbook文件中定义的所以任务集</span></span></span><br><span class=\"line\"><span class=\"ruby\">--limit           <span class=\"comment\">#主机列表 只针对主机列表中的某个主机或者某个组执行</span></span></span><br><span class=\"line\"><span class=\"ruby\">-f                <span class=\"comment\">#指定并发数，默认为5个</span></span></span><br><span class=\"line\"><span class=\"ruby\">-t                <span class=\"comment\">#指定tags运行，运行某一个或者多个tags。（前提playbook中有定义tags）</span></span></span><br><span class=\"line\"><span class=\"ruby\">-v                <span class=\"comment\">#显示过程  -vv  -vvv更详细</span></span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"Playbook中元素属性\"><a href=\"#Playbook中元素属性\" class=\"headerlink\" title=\"Playbook中元素属性\"></a>Playbook中元素属性</h2><h3 id=\"主机与用户\"><a href=\"#主机与用户\" class=\"headerlink\" title=\"主机与用户\"></a>主机与用户</h3><blockquote>\n<p>在一个<code>playbook</code>开始时，最先定义的是要操作的主机和用户</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>除了上面的定义外，还可以在某一个<code>tasks</code>中定义要执行该任务的远程用户</p>\n</blockquote>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tasks: </span><br><span class=\"line\">  - name: <span class=\"keyword\">run</span> df -<span class=\"built_in\">h</span></span><br><span class=\"line\">    remote_user: <span class=\"keyword\">test</span></span><br><span class=\"line\">    <span class=\"keyword\">shell</span>: name=df -<span class=\"built_in\">h</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>还可以定义使用<code>sudo</code>授权用户执行该任务</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">tasks:</span> </span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">run</span> <span class=\"string\">df</span> <span class=\"bullet\">-h</span></span><br><span class=\"line\"><span class=\"attr\">    sudo_user:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">    sudo:</span> <span class=\"literal\">yes</span></span><br><span class=\"line\"><span class=\"attr\">    shell:</span> <span class=\"string\">name=df</span> <span class=\"bullet\">-h</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"tasks任务列表\"><a href=\"#tasks任务列表\" class=\"headerlink\" title=\"tasks任务列表\"></a>tasks任务列表</h3><blockquote>\n<p>每一个<code>task</code>必须有一个名称<code>name</code>,这样在运行<code>playbook</code>时，从其输出的任务执行信息中可以很清楚的辨别是属于哪一个<code>task</code>的，如果没有定义 <code>name</code>，<code>action</code>的值将会用作输出信息中标记特定的<code>task</code>。<br>每一个<code>playbook</code>中可以包含一个或者多个<code>tasks</code>任务列表，每一个<code>tasks</code>完成具体的一件事，（任务模块）比如创建一个用户或者安装一个软件等，在<code>hosts</code>中定义的主机或者主机组都将会执行这个被定义的<code>tasks</code>。</p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tasks:</span><br><span class=\"line\">  - name: create new file</span><br><span class=\"line\">    file: <span class=\"attribute\">path</span>=/tmp/test01.txt <span class=\"attribute\">state</span>=touch</span><br><span class=\"line\">  - name: create new user</span><br><span class=\"line\">    user: <span class=\"attribute\">name</span>=test001 <span class=\"attribute\">state</span>=present</span><br></pre></td></tr></table></figure>\n<h3 id=\"Handlers与Notify\"><a href=\"#Handlers与Notify\" class=\"headerlink\" title=\"Handlers与Notify\"></a>Handlers与Notify</h3><blockquote>\n<p>很多时候当我们某一个配置发生改变，我们需要重启服务，（比如httpd配置文件文件发生改变了）这时候就可以用到<code>handlers</code>和<code>notify</code>了；<br>(当发生改动时)<code>notify actions</code>会在<code>playbook</code>的每一个task结束时被触发，而且即使有多个不同task通知改动的发生，<code>notify actions</code>知会被触发一次；比如多个<code>resources</code>指出因为一个配置文件被改动，所以<code>apache</code>需要重启，但是重新启动的操作知会被执行一次。</p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# cat httpd.yml </span><br><span class=\"line\"><span class=\"comment\">#用于安装httpd并配置启动</span></span><br><span class=\"line\">---</span><br><span class=\"line\">- hosts: 192.168.1.31</span><br><span class=\"line\">  remote_user: root</span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">  - name: install httpd</span><br><span class=\"line\">    yum: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=installed</span><br><span class=\"line\">  - name:<span class=\"built_in\"> config </span>httpd</span><br><span class=\"line\">    template: <span class=\"attribute\">src</span>=/root/httpd.conf <span class=\"attribute\">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class=\"line\">    notify:</span><br><span class=\"line\">      - restart httpd</span><br><span class=\"line\">  - name: start httpd</span><br><span class=\"line\">    service: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=started</span><br><span class=\"line\"></span><br><span class=\"line\">  handlers:</span><br><span class=\"line\">    - name: restart httpd</span><br><span class=\"line\">      service: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=restarted</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#这里只要对httpd.conf配置文件作出了修改，修改后需要重启生效，在tasks中定义了restart httpd这个action，然后在handlers中引用上面tasks中定义的notify。</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Playbook中变量的使用\"><a href=\"#Playbook中变量的使用\" class=\"headerlink\" title=\"Playbook中变量的使用\"></a>Playbook中变量的使用</h2><p><strong>环境说明</strong>：这里配置了两个组，一个apache组和一个nginx组<br><figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible PlayBook]</span># cat /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"string\">[apache]</span></span><br><span class=\"line\"><span class=\"number\">192.168.1.36</span></span><br><span class=\"line\"><span class=\"number\">192.168.1.33</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[nginx]</span></span><br><span class=\"line\"><span class=\"number\">192.168.1.3</span><span class=\"string\">[1:2]</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"命令行指定变量\"><a href=\"#命令行指定变量\" class=\"headerlink\" title=\"命令行指定变量\"></a>命令行指定变量</h3><blockquote>\n<p>执行<code>playbook</code>时候通过参数<code>-e</code>传入变量，这样传入的变量在整个<code>playbook</code>中都可以被调用，属于全局变量</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">variables.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">install</span> <span class=\"string\">pkg</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">pkg</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行playbook 指定pkg</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span> <span class=\"bullet\">-e</span> <span class=\"string\">\"pkg=httpd\"</span> <span class=\"string\">variables.yml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"hosts文件中定义变量\"><a href=\"#hosts文件中定义变量\" class=\"headerlink\" title=\"hosts文件中定义变量\"></a>hosts文件中定义变量</h3><blockquote>\n<p>在<code>/etc/ansible/hosts</code>文件中定义变量，可以针对每个主机定义不同的变量，也可以定义一个组的变量，然后直接在<code>playbook</code>中直接调用。注意，组中定义的变量没有单个主机中的优先级高。</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑hosts文件定义变量</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">vim</span> <span class=\"string\">/etc/ansible/hosts</span></span><br><span class=\"line\"><span class=\"string\">[apache]</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.36</span> <span class=\"string\">webdir=/opt/test</span>     <span class=\"comment\">#定义单个主机的变量</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br><span class=\"line\"><span class=\"string\">[apache:vars]</span>      <span class=\"comment\">#定义整个组的统一变量</span></span><br><span class=\"line\"><span class=\"string\">webdir=/web/test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[nginx]</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.3</span><span class=\"string\">[1:2]</span></span><br><span class=\"line\"><span class=\"string\">[nginx:vars]</span></span><br><span class=\"line\"><span class=\"string\">webdir=/opt/web</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑playbook文件</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">variables.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">webdir</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">webdir</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=directory</span>   <span class=\"comment\">#引用变量</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span> <span class=\"string\">variables.yml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"playbook文件中定义变量\"><a href=\"#playbook文件中定义变量\" class=\"headerlink\" title=\"playbook文件中定义变量\"></a>playbook文件中定义变量</h3><blockquote>\n<p>编写<code>playbook</code>时，直接在里面定义变量，然后直接引用，可以定义多个变量；注意：如果在执行<code>playbook</code>时，又通过<code>-e</code>参数指定变量的值，那么会以<code>-e</code>参数指定的为准。</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">variables.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span>                <span class=\"comment\">#定义变量</span></span><br><span class=\"line\"><span class=\"attr\">    pkg:</span> <span class=\"string\">nginx</span>         <span class=\"comment\">#变量1</span></span><br><span class=\"line\"><span class=\"attr\">    dir:</span> <span class=\"string\">/tmp/test1</span>    <span class=\"comment\">#变量2</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">install</span> <span class=\"string\">pkg</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">pkg</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=installed</span>    <span class=\"comment\">#引用变量</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">new</span> <span class=\"string\">dir</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">dir</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=directory</span>   <span class=\"comment\">#引用变量</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span> <span class=\"string\">variables.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果执行时候又重新指定了变量的值，那么会已重新指定的为准</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span> <span class=\"bullet\">-e</span> <span class=\"string\">\"dir=/tmp/test2\"</span> <span class=\"string\">variables.yml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"调用setup模块获取变量\"><a href=\"#调用setup模块获取变量\" class=\"headerlink\" title=\"调用setup模块获取变量\"></a>调用setup模块获取变量</h3><blockquote>\n<p><code>setup</code>模块默认是获取主机信息的，有时候在<code>playbook</code>中需要用到，所以可以直接调用。常用的参数<a href=\"https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup\" target=\"_blank\" rel=\"noopener\">参考</a></p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑playbook文件</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">variables.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">ansible_fqdn</span> <span class=\"string\">&#125;&#125;.log</span> <span class=\"string\">state=touch</span>   <span class=\"comment\">#引用setup中的ansible_fqdn</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span> <span class=\"string\">variables.yml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"独立的变量YAML文件中定义\"><a href=\"#独立的变量YAML文件中定义\" class=\"headerlink\" title=\"独立的变量YAML文件中定义\"></a>独立的变量YAML文件中定义</h3><blockquote>\n<p>为了方便管理将所有的变量统一放在一个独立的变量<code>YAML</code>文件中，<code>laybook</code>文件直接引用文件调用变量即可。</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义存放变量的文件</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">var.yml</span> </span><br><span class=\"line\"><span class=\"attr\">var1:</span> <span class=\"string\">vsftpd</span></span><br><span class=\"line\"><span class=\"attr\">var2:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编写playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">variables.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars_files:</span>    <span class=\"comment\">#引用变量文件</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">./var.yml</span>   <span class=\"comment\">#指定变量文件的path（这里可以是绝对路径，也可以是相对路径）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">install</span> <span class=\"string\">package</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">var1</span> <span class=\"string\">&#125;&#125;</span>   <span class=\"comment\">#引用变量</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span> <span class=\"string\">name=/tmp/&#123;&#123;</span> <span class=\"string\">var2</span> <span class=\"string\">&#125;&#125;.log</span> <span class=\"string\">state=touch</span>   <span class=\"comment\">#引用变量</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span>  <span class=\"string\">variables.yml</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Playbook中标签的使用\"><a href=\"#Playbook中标签的使用\" class=\"headerlink\" title=\"Playbook中标签的使用\"></a>Playbook中标签的使用</h2><blockquote>\n<p>一个<code>playbook</code>文件中，执行时如果想执行某一个任务，那么可以给每个任务集进行打标签，这样在执行的时候可以通过<code>-t</code>选择指定标签执行，还可以通过<code>--skip-tags</code>选择除了某个标签外全部执行等。</p>\n</blockquote>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># 编辑playbook</span></span><br><span class=\"line\">[root@ansible PlayBook]# cat httpd.yml </span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"bullet\">- </span>hosts: 192.168.1.31</span><br><span class=\"line\">  remote_user: root</span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\"><span class=\"code\">    - name: install httpd</span></span><br><span class=\"line\"><span class=\"code\">      yum: name=httpd state=installed</span></span><br><span class=\"line\"><span class=\"code\">      tags: inhttpd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"code\">    - name: start httpd</span></span><br><span class=\"line\"><span class=\"code\">      service: name=httpd state=started</span></span><br><span class=\"line\"><span class=\"code\">      tags: sthttpd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"code\">    - name: restart httpd</span></span><br><span class=\"line\"><span class=\"code\">      service: name=httpd state=restarted</span></span><br><span class=\"line\"><span class=\"code\">      tags: </span></span><br><span class=\"line\"><span class=\"code\">        - rshttpd</span></span><br><span class=\"line\"><span class=\"code\">        - rs_httpd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\"># 正常执行的结果</span></span><br><span class=\"line\">[root@ansible PlayBook]# ansible-playbook httpd.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [192.168.1.31] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [install httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [start httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [restart httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">192.168.1.31               : ok=4    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>\n<p>1）通过<code>-t</code>选项指定<code>tags</code>进行执行<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># 通过-t指定tags名称，多个tags用逗号隔开</span></span><br><span class=\"line\">[root@ansible PlayBook]# ansible-playbook -t rshttpd httpd.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [192.168.1.31] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [restart httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">192.168.1.31               : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<p>2）通过<code>--skip-tags</code>选项排除不执行的<code>tags</code><br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# ansible-playbook --skip-tags inhttpd httpd.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [192.168.1.31] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [start httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [restart httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">192.168.1.31               : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Playbook中模板的使用\"><a href=\"#Playbook中模板的使用\" class=\"headerlink\" title=\"Playbook中模板的使用\"></a>Playbook中模板的使用</h2><blockquote>\n<p><code>template</code>模板为我们提供了动态配置服务，使用<code>jinja2</code>语言，里面支持多种条件判断、循环、逻辑运算、比较操作等。其实说白了也就是一个文件，和之前配置文件使用<code>copy</code>一样，只是使用<code>copy</code>，不能根据服务器配置不一样进行不同动态的配置。这样就不利于管理。<br>说明：<br>1、多数情况下都将<code>template</code>文件放在和<code>playbook</code>文件同级的<code>templates</code>目录下（手动创建），这样<code>playbook</code>文件中可以直接引用，会自动去找这个文件。如果放在别的地方，也可以通过绝对路径去指定。<br>2、模板文件后缀名为<code>.j2</code>。</p>\n</blockquote>\n<p><a href=\"http://www.ansible.com.cn/docs/playbooks_loops.html#standard-loops\" target=\"_blank\" rel=\"noopener\">循环参考</a><br><strong>示例：通过template安装httpd</strong><br>1）<code>playbook</code>文件编写<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">testtmp.yml</span> </span><br><span class=\"line\"><span class=\"comment\">#模板示例</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    - listen_port:</span> <span class=\"number\">88</span>    <span class=\"comment\">#定义变量</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Install</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=installed</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Config</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">      template:</span> <span class=\"string\">src=httpd.conf.j2</span> <span class=\"string\">dest=/etc/httpd/conf/httpd.conf</span>    <span class=\"comment\">#使用模板</span></span><br><span class=\"line\"><span class=\"attr\">      notify:</span> <span class=\"string\">Restart</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Start</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">      service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=started</span></span><br><span class=\"line\">      </span><br><span class=\"line\"><span class=\"attr\">  handlers:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Restart</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">      service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=restarted</span></span><br></pre></td></tr></table></figure></p>\n<p>2）模板文件准备，<code>httpd</code>配置文件准备，这里配置文件端口使用了变量<br><figure class=\"highlight mathematica\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# cat templates/httpd.conf.j2 |grep ^<span class=\"keyword\">Listen</span></span><br><span class=\"line\"><span class=\"keyword\">Listen</span> &#123;&#123; listen_port &#125;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）查看目录结构<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 目录结构</span><br><span class=\"line\"><span class=\"selector-attr\">[root@ansible PlayBook]</span># <span class=\"selector-tag\">tree</span> .</span><br><span class=\"line\">.</span><br><span class=\"line\">├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">httpd</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">testtmp</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\">1 <span class=\"selector-tag\">directory</span>, 2 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure></p>\n<p>4）执行<code>playbook</code>，由于<code>192.168.1.36</code>那台机器是<code>6</code>的系统，模板文件里面的配置文件是<code>7</code>上面默认的<code>httpd</code>配置文件，<code>httpd</code>版本不一样(<code>6默认版本为2.2.15，7默认版本为2.4.6</code>)，所以拷贝过去后启动报错。下面使用<code>playbook</code>中的判断语句进行处理；此处先略过<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# ansible-playbook testtmp.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [all] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Install Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Config Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Start Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">fatal: [192.168.1.36]: FAILED! =&gt; &#123;\"changed\": false, \"msg\": \"httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\\n\"&#125;</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [Restart Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">192.168.1.31               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.32               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.33               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.36               : ok=3    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"template之when\"><a href=\"#template之when\" class=\"headerlink\" title=\"template之when\"></a>template之when</h3><p><a href=\"http://www.ansible.com.cn/docs/playbooks_conditionals.html#when\" target=\"_blank\" rel=\"noopener\">when语句参考</a></p>\n<blockquote>\n<p>条件测试：如果需要根据变量、<code>facts</code>或此前任务的执行结果来做为某<code>task</code>执行与否的前提时要用到条件测试，通过<code>when</code>语句执行，在<code>task</code>中使用<code>jinja2</code>的语法格式、<br>when语句：<br>在<code>task</code>后添加<code>when</code>子句即可使用条件测试；<code>when</code>语句支持<code>jinja2</code>表达式语法。</p>\n</blockquote>\n<p>类似这样：<br><figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tasks:</span><br><span class=\"line\">  - <span class=\"keyword\">command</span>: /<span class=\"title\">bin</span>/<span class=\"title\">false</span></span><br><span class=\"line\">    register: <span class=\"built_in\">result</span></span><br><span class=\"line\">    ignore_errors: True</span><br><span class=\"line\">  - <span class=\"keyword\">command</span>: /<span class=\"title\">bin</span>/<span class=\"title\">something</span></span><br><span class=\"line\">    when: <span class=\"built_in\">result</span>|failed</span><br><span class=\"line\">  - <span class=\"keyword\">command</span>: /<span class=\"title\">bin</span>/<span class=\"title\">something_else</span></span><br><span class=\"line\">    when: <span class=\"built_in\">result</span>|success</span><br><span class=\"line\">  - <span class=\"keyword\">command</span>: /<span class=\"title\">bin</span>/<span class=\"title\">still</span>/<span class=\"title\">something_else</span></span><br><span class=\"line\">    when: <span class=\"built_in\">result</span>|skipped</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例：通过when语句完善上面的httpd配置</strong><br>1）准备两个配置文件，一个<code>centos6</code>系统<code>httpd</code>配置文件，一个<code>centos7</code>系统httpd配置文件。<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# tree templates/</span><br><span class=\"line\">templates/</span><br><span class=\"line\">├── httpd6.conf.j2     #<span class=\"number\">6</span>系统<span class=\"number\">2.2</span><span class=\"number\">.15</span>版本httpd配置文件</span><br><span class=\"line\">└── httpd7.conf.j2     #<span class=\"number\">7</span>系统<span class=\"number\">2.4</span><span class=\"number\">.6</span>版本httpd配置文件</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span> directories, <span class=\"number\">2</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）修改<code>playbook</code>文件，通过setup模块获取系统版本去判断。<a href=\"https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup\" target=\"_blank\" rel=\"noopener\">setup常用模块</a><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# cat testtmp.yml </span><br><span class=\"line\"><span class=\"comment\">#when示例</span></span><br><span class=\"line\">---</span><br><span class=\"line\">- hosts: all</span><br><span class=\"line\">  remote_user: root</span><br><span class=\"line\">  vars:</span><br><span class=\"line\">    - listen_port: 88</span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">    - name: Install Httpd</span><br><span class=\"line\">      yum: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=installed</span><br><span class=\"line\">    - name:<span class=\"built_in\"> Config </span>System6 Httpd</span><br><span class=\"line\">      template: <span class=\"attribute\">src</span>=httpd6.conf.j2 <span class=\"attribute\">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class=\"line\">      when: ansible_distribution_major_version == <span class=\"string\">\"6\"</span>   #判断系统版本，为6便执行上面的template配置6的配置文件</span><br><span class=\"line\">      notify: Restart Httpd</span><br><span class=\"line\">    - name:<span class=\"built_in\"> Config </span>System7 Httpd</span><br><span class=\"line\">      template: <span class=\"attribute\">src</span>=httpd7.conf.j2 <span class=\"attribute\">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class=\"line\">      when: ansible_distribution_major_version == <span class=\"string\">\"7\"</span>   #判断系统版本，为7便执行上面的template配置7的配置文件</span><br><span class=\"line\">      notify: Restart Httpd</span><br><span class=\"line\">    - name: Start Httpd</span><br><span class=\"line\">      service: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=started</span><br><span class=\"line\"></span><br><span class=\"line\">  handlers:</span><br><span class=\"line\">    - name: Restart Httpd</span><br><span class=\"line\">      service: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=restarted</span><br></pre></td></tr></table></figure></p>\n<p>3）执行playbook<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# ansible-playbook testtmp.yml</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [all] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Install Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Config System6 Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">skipping: [192.168.1.33]</span><br><span class=\"line\">skipping: [192.168.1.31]</span><br><span class=\"line\">skipping: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Config System7 Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">skipping: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Start Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [Restart Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">192.168.1.31               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.32               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.33               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.36               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"template之with-items\"><a href=\"#template之with-items\" class=\"headerlink\" title=\"template之with_items\"></a>template之with_items</h3><blockquote>\n<p><code>with_items</code>迭代，当有需要重复性执行的任务时，可以使用迭代机制。<br>对迭代项的引用，固定变量名为<code>“item”</code>，要在task中使用with_items给定要迭代的元素列表。<br>列表格式：<br>&emsp;&ensp;字符串<br>&emsp;&ensp;字典</p>\n</blockquote>\n<p><strong>示例1：通过with_items安装多个不同软件</strong><br>编写<code>playbook</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">testwith.yml</span> </span><br><span class=\"line\"><span class=\"comment\"># 示例with_items</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Install</span> <span class=\"string\">Package</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">item</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=installed</span>   <span class=\"comment\">#引用item获取值</span></span><br><span class=\"line\"><span class=\"attr\">      with_items:</span>     <span class=\"comment\">#定义with_items</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">vsftpd</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">nginx</span></span><br></pre></td></tr></table></figure></p>\n<p>上面<code>tasks</code>写法等同于：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Install</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=installed</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Install</span> <span class=\"string\">Vsftpd</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=vsftpd</span> <span class=\"string\">state=installed</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Install</span> <span class=\"string\">Nginx</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=nginx</span> <span class=\"string\">state=installed</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>示例2：通过嵌套子变量创建用户并加入不同的组</strong><br>1）编写<code>playbook</code><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># cat testwith01.yml </span></span><br><span class=\"line\"><span class=\"comment\"># 示例with_items嵌套子变量</span></span><br><span class=\"line\"><span class=\"comment\">---</span></span><br><span class=\"line\">- hosts: all</span><br><span class=\"line\">  remote_user: root</span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">    - name: <span class=\"keyword\">Create</span> <span class=\"keyword\">New</span> <span class=\"keyword\">Group</span></span><br><span class=\"line\">      <span class=\"keyword\">group</span>: <span class=\"keyword\">name</span>=&#123;&#123; item &#125;&#125; state=<span class=\"keyword\">present</span></span><br><span class=\"line\">      with_items: </span><br><span class=\"line\">        - group1</span><br><span class=\"line\">        - group2</span><br><span class=\"line\">        - group3 </span><br><span class=\"line\"></span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: <span class=\"keyword\">Create</span> <span class=\"keyword\">New</span> <span class=\"keyword\">User</span></span><br><span class=\"line\">      <span class=\"keyword\">user</span>: <span class=\"keyword\">name</span>=&#123;&#123; item.name &#125;&#125; <span class=\"keyword\">group</span>=&#123;&#123; item.group &#125;&#125; state=<span class=\"keyword\">present</span></span><br><span class=\"line\">      with_items:</span><br><span class=\"line\">        - &#123; <span class=\"keyword\">name</span>: <span class=\"string\">'user1'</span>, <span class=\"keyword\">group</span>: <span class=\"string\">'group1'</span> &#125; </span><br><span class=\"line\">        - &#123; <span class=\"keyword\">name</span>: <span class=\"string\">'user2'</span>, <span class=\"keyword\">group</span>: <span class=\"string\">'group2'</span> &#125; </span><br><span class=\"line\">        - &#123; <span class=\"keyword\">name</span>: <span class=\"string\">'user3'</span>, <span class=\"keyword\">group</span>: <span class=\"string\">'group3'</span> &#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）执行<code>playbook</code>并验证<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 执行playbook</span></span><br><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># ansible-playbook testwith01.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证是否成功创建用户及组</span></span><br><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># ansible all -m shell -a 'tail -3 /etc/passwd'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.36 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"symbol\">user1:</span><span class=\"symbol\">x:</span><span class=\"number\">500</span><span class=\"symbol\">:</span><span class=\"number\">500</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user1</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user2:</span><span class=\"symbol\">x:</span><span class=\"number\">501</span><span class=\"symbol\">:</span><span class=\"number\">501</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user2</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user3:</span><span class=\"symbol\">x:</span><span class=\"number\">502</span><span class=\"symbol\">:</span><span class=\"number\">502</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user3</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">192.168.1.32 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"symbol\">user1:</span><span class=\"symbol\">x:</span><span class=\"number\">1001</span><span class=\"symbol\">:</span><span class=\"number\">1001</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user1</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user2:</span><span class=\"symbol\">x:</span><span class=\"number\">1002</span><span class=\"symbol\">:</span><span class=\"number\">1002</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user2</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user3:</span><span class=\"symbol\">x:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user3</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"symbol\">user1:</span><span class=\"symbol\">x:</span><span class=\"number\">1002</span><span class=\"symbol\">:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user1</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user2:</span><span class=\"symbol\">x:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"number\">1004</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user2</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user3:</span><span class=\"symbol\">x:</span><span class=\"number\">1004</span><span class=\"symbol\">:</span><span class=\"number\">1005</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user3</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">192.168.1.33 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"symbol\">user1:</span><span class=\"symbol\">x:</span><span class=\"number\">1001</span><span class=\"symbol\">:</span><span class=\"number\">1001</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user1</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user2:</span><span class=\"symbol\">x:</span><span class=\"number\">1002</span><span class=\"symbol\">:</span><span class=\"number\">1002</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user2</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user3:</span><span class=\"symbol\">x:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user3</span><span class=\"symbol\">:/bin/bash</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"template之for-if\"><a href=\"#template之for-if\" class=\"headerlink\" title=\"template之for if\"></a>template之for if</h3><blockquote>\n<p>通过使用<code>for</code>，<code>if</code>可以更加灵活的生成配置文件等需求，还可以在里面根据各种条件进行判断，然后生成不同的配置文件、或者服务器配置相关等。</p>\n</blockquote>\n<p><strong>示例1</strong><br>1）编写<code>playbook</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">testfor01.yml</span> </span><br><span class=\"line\"><span class=\"comment\"># template for 示例</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    nginx_vhost_port:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">81</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">82</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">83</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Templage</span> <span class=\"string\">Nginx</span> <span class=\"string\">Config</span></span><br><span class=\"line\"><span class=\"attr\">      template:</span> <span class=\"string\">src=nginx.conf.j2</span> <span class=\"string\">dest=/tmp/nginx_test.conf</span></span><br></pre></td></tr></table></figure></p>\n<p>2）模板文件编写<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 循环playbook文件中定义的变量，依次赋值给port</span></span><br><span class=\"line\">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span><br><span class=\"line\">&#123;% <span class=\"keyword\">for</span><span class=\"built_in\"> port </span><span class=\"keyword\">in</span> nginx_vhost_port %&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     listen: &#123;&#123;<span class=\"built_in\"> port </span>&#125;&#125;;</span><br><span class=\"line\">     server_name: localhost;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）执行<code>playbook</code>并查看生成结果<br><figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># ansible-playbook testfor01.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class=\"line\">[root@linux ~]<span class=\"comment\"># cat /tmp/nginx_test.conf </span></span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>: 81;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>: localhost;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>: 82;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>: localhost;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>: 83;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>: localhost;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例2</strong><br>1）编写<code>playbook</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">testfor02.yml</span> </span><br><span class=\"line\"><span class=\"comment\"># template for 示例</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    nginx_vhosts:</span></span><br><span class=\"line\"><span class=\"attr\">      - web1:</span></span><br><span class=\"line\"><span class=\"attr\">        listen:</span> <span class=\"number\">8081</span></span><br><span class=\"line\"><span class=\"attr\">        server_name:</span> <span class=\"string\">\"web1.example.com\"</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web1\"</span></span><br><span class=\"line\"><span class=\"attr\">      - web2:</span></span><br><span class=\"line\"><span class=\"attr\">        listen:</span> <span class=\"number\">8082</span></span><br><span class=\"line\"><span class=\"attr\">        server_name:</span> <span class=\"string\">\"web2.example.com\"</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web2\"</span></span><br><span class=\"line\"><span class=\"attr\">      - web3:</span></span><br><span class=\"line\"><span class=\"attr\">        listen:</span> <span class=\"number\">8083</span></span><br><span class=\"line\"><span class=\"attr\">        server_name:</span> <span class=\"string\">\"web3.example.com\"</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web3\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Templage</span> <span class=\"string\">Nginx</span> <span class=\"string\">Config</span></span><br><span class=\"line\"><span class=\"attr\">      template:</span> <span class=\"string\">src=nginx.conf.j2</span> <span class=\"string\">dest=/tmp/nginx_vhost.conf</span></span><br></pre></td></tr></table></figure></p>\n<p>2）模板文件编写<br><figure class=\"highlight django\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"xml\">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span></span><br><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">for</span></span> vhost <span class=\"keyword\">in</span> nginx_vhosts %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">server&#123;</span></span><br><span class=\"line\"><span class=\"xml\">     listen:    </span><span class=\"template-variable\">&#123;&#123; vhost.listen &#125;&#125;</span><span class=\"xml\">;</span></span><br><span class=\"line\"><span class=\"xml\">     server_name:    </span><span class=\"template-variable\">&#123;&#123; vhost.server_name &#125;&#125;</span><span class=\"xml\">;</span></span><br><span class=\"line\"><span class=\"xml\">     root:   </span><span class=\"template-variable\">&#123;&#123; vhost.root &#125;&#125;</span><span class=\"xml\">; </span></span><br><span class=\"line\"><span class=\"xml\">&#125;</span></span><br><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">endfor</span></span> %&#125;</span><span class=\"xml\"></span></span><br></pre></td></tr></table></figure></p>\n<p>3）执行<code>playbook</code>并查看生成结果<br><figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># ansible-playbook testfor02.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class=\"line\">[root@linux ~]<span class=\"comment\"># cat /tmp/nginx_vhost.conf </span></span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>:    8081;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>:    web1<span class=\"variable\">.example</span><span class=\"variable\">.com</span>;</span><br><span class=\"line\">     <span class=\"attribute\">root</span>:   /var/www/nginx/web1; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>:    8082;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>:    web2<span class=\"variable\">.example</span><span class=\"variable\">.com</span>;</span><br><span class=\"line\">     <span class=\"attribute\">root</span>:   /var/www/nginx/web2; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>:    8083;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>:    web3<span class=\"variable\">.example</span><span class=\"variable\">.com</span>;</span><br><span class=\"line\">     <span class=\"attribute\">root</span>:   /var/www/nginx/web3; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例3</strong><br>在for循环中再嵌套if判断，让生成的配置文件更加灵活<br>1）编写<code>playbook</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">testfor03.yml</span> </span><br><span class=\"line\"><span class=\"comment\"># template for 示例</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    nginx_vhosts:</span></span><br><span class=\"line\"><span class=\"attr\">      - web1:</span></span><br><span class=\"line\"><span class=\"attr\">        listen:</span> <span class=\"number\">8081</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web1\"</span></span><br><span class=\"line\"><span class=\"attr\">      - web2:</span></span><br><span class=\"line\"><span class=\"attr\">        server_name:</span> <span class=\"string\">\"web2.example.com\"</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web2\"</span></span><br><span class=\"line\"><span class=\"attr\">      - web3:</span></span><br><span class=\"line\"><span class=\"attr\">        listen:</span> <span class=\"number\">8083</span></span><br><span class=\"line\"><span class=\"attr\">        server_name:</span> <span class=\"string\">\"web3.example.com\"</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web3\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Templage</span> <span class=\"string\">Nginx</span> <span class=\"string\">Config</span></span><br><span class=\"line\"><span class=\"attr\">      template:</span> <span class=\"string\">src=nginx.conf.j2</span> <span class=\"string\">dest=/tmp/nginx_vhost.conf</span></span><br></pre></td></tr></table></figure></p>\n<p>2）模板文件编写<br><figure class=\"highlight django\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"xml\"># 说明：这里添加了判断，如果listen没有定义的话，默认端口使用8888，如果server_name有定义，那么生成的配置文件中才有这一项。</span></span><br><span class=\"line\"><span class=\"xml\">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span></span><br><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">for</span></span> vhost <span class=\"keyword\">in</span> nginx_vhosts %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">server&#123;</span></span><br><span class=\"line\"><span class=\"xml\">     </span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">if</span></span> vhost.listen is defined %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">     listen:    </span><span class=\"template-variable\">&#123;&#123; vhost.listen &#125;&#125;</span><span class=\"xml\">;</span></span><br><span class=\"line\"><span class=\"xml\">     </span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">else</span></span> %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">     listen: 8888;</span></span><br><span class=\"line\"><span class=\"xml\">     </span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">endif</span></span> %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">     </span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">if</span></span> vhost.server_name is defined %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">     server_name:    </span><span class=\"template-variable\">&#123;&#123; vhost.server_name &#125;&#125;</span><span class=\"xml\">;</span></span><br><span class=\"line\"><span class=\"xml\">     </span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">endif</span></span> %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">     root:   </span><span class=\"template-variable\">&#123;&#123; vhost.root &#125;&#125;</span><span class=\"xml\">; </span></span><br><span class=\"line\"><span class=\"xml\">&#125;</span></span><br><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">endfor</span></span> %&#125;</span><span class=\"xml\"></span></span><br></pre></td></tr></table></figure></p>\n<p>3）执行<code>playbook</code>并查看生成结果<br><figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># ansible-playbook testfor03.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class=\"line\">[root@linux ~]<span class=\"comment\"># cat /tmp/nginx_vhost.conf </span></span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">          <span class=\"attribute\">listen</span>:    8081;</span><br><span class=\"line\">          <span class=\"attribute\">root</span>:   /var/www/nginx/web1; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">          <span class=\"attribute\">listen</span>: 8888;</span><br><span class=\"line\">          <span class=\"attribute\">server_name</span>:    web2<span class=\"variable\">.example</span><span class=\"variable\">.com</span>;</span><br><span class=\"line\">          <span class=\"attribute\">root</span>:   /var/www/nginx/web2; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">          <span class=\"attribute\">listen</span>:    8083;</span><br><span class=\"line\">          <span class=\"attribute\">server_name</span>:    web3<span class=\"variable\">.example</span><span class=\"variable\">.com</span>;</span><br><span class=\"line\">          <span class=\"attribute\">root</span>:   /var/www/nginx/web3; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><strong>上面三个示例的图片展示效果</strong><br><div class=\"tabs\" id><ul class=\"nav-tabs\"><li class=\"tab active\"><a href=\"#-1\">示例1</a></li><li class=\"tab\"><a href=\"#-2\">示例2</a></li><li class=\"tab\"><a href=\"#-3\">示例3</a></li></ul><div class=\"tab-content\"><div class=\"tab-pane active\" id=\"-1\"><p><img src=\"/2019/05/29/Ansible之Playbook/shili01.png\" alt></p>\n</div><div class=\"tab-pane\" id=\"-2\"><p><img src=\"/2019/05/29/Ansible之Playbook/shili02.png\" alt></p>\n</div><div class=\"tab-pane\" id=\"-3\"><p><img src=\"/2019/05/29/Ansible之Playbook/shili03.png\" alt></p>\n</div></div></div></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Playbook介绍\"><a href=\"#Playbook介绍\" class=\"headerlink\" title=\"Playbook介绍\"></a>Playbook介绍</h2><p><a href=\"https://ansible-tran.readthedocs.io/en/latest/docs/playbooks.html\" target=\"_blank\" rel=\"noopener\">playbook参考文档</a></p>\n<blockquote>\n<p><code>Playbook</code>与<code>ad-hoc</code>相比,是一种完全不同的运用ansible的方式，类似与<code>saltstack</code>的<code>state</code>状态文件。<code>ad-hoc</code>无法持久使用，<code>playbook</code>可以持久使用。<br><code>playbook</code>是由一个或多个<code>play</code>组成的列表，<code>play</code>的主要功能在于将事先归并为一组的主机装扮成事先通过<code>ansible</code>中的<code>task</code>定义好的角色。从根本上来讲，所谓的<code>task</code>无非是调用<code>ansible</code>的一个<code>module</code>。将多个<code>play</code>组织在一个<code>playbook</code>中，即可以让它们联合起来按事先编排的机制完成某一任务</p>\n</blockquote>\n<h2 id=\"Playbook核心元素\"><a href=\"#Playbook核心元素\" class=\"headerlink\" title=\"Playbook核心元素\"></a>Playbook核心元素</h2><blockquote>\n<ul>\n<li>Hosts  执行的远程主机列表</li>\n<li>Tasks  任务集</li>\n<li>Varniables 内置变量或自定义变量在playbook中调用</li>\n<li>Templates 模板，即使用模板语法的文件，比如配置文件等</li>\n<li>Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li>\n<li>tags 标签，指定某条任务执行，用于选择运行playbook中的部分代码。</li>\n</ul>\n</blockquote>\n<h2 id=\"Playbook语法\"><a href=\"#Playbook语法\" class=\"headerlink\" title=\"Playbook语法\"></a>Playbook语法</h2><blockquote>\n<p><code>playbook</code>使用<code>yaml</code>语法格式，后缀可以是<code>yaml</code>,也可以是<code>yml</code>。</p>\n<ul>\n<li>在单一一个<code>playbook</code>文件中，可以连续三个连子号(<code>---</code>)区分多个<code>play</code>。还有选择性的连续三个点好(<code>...</code>)用来表示<code>play</code>的结尾，也可省略。</li>\n<li>次行开始正常写<code>playbook</code>的内容，一般都会写上描述该<code>playbook</code>的功能。</li>\n<li>使用#号注释代码。</li>\n<li>缩进必须统一，不能空格和<code>tab</code>混用。</li>\n<li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行实现的。</li>\n<li><code>YAML</code>文件内容和<code>Linux</code>系统大小写判断方式保持一致，是区分大小写的，<code>k/v</code>的值均需大小写敏感</li>\n<li><code>k/v</code>的值可同行写也可以换行写。同行使用:分隔。</li>\n<li><code>v</code>可以是个字符串，也可以是一个列表</li>\n<li>一个完整的代码块功能需要最少元素包括 <code>name: task</code></li>\n</ul>\n</blockquote>\n<h3 id=\"一个简单的示例\"><a href=\"#一个简单的示例\" class=\"headerlink\" title=\"一个简单的示例\"></a>一个简单的示例</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># 创建playbook文件</span></span><br><span class=\"line\">[root@ansible ~]# cat playbook01.yml</span><br><span class=\"line\">---                       #固定格式</span><br><span class=\"line\"><span class=\"bullet\">- </span>hosts: 192.168.1.31     #定义需要执行主机</span><br><span class=\"line\">  remote_user: root       #远程用户</span><br><span class=\"line\">  vars:                   #定义变量</span><br><span class=\"line\"><span class=\"code\">    http_port: 8088       #变量</span></span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:                             #定义一个任务的开始</span><br><span class=\"line\"><span class=\"code\">    - name: create new file          #定义任务的名称</span></span><br><span class=\"line\"><span class=\"code\">      file: name=/tmp/playtest.txt state=touch   #调用模块，具体要做的事情</span></span><br><span class=\"line\"><span class=\"code\">    - name: create new user</span></span><br><span class=\"line\"><span class=\"code\">      user: name=test02 system=yes shell=/sbin/nologin</span></span><br><span class=\"line\"><span class=\"code\">    - name: install package</span></span><br><span class=\"line\"><span class=\"code\">      yum: name=httpd</span></span><br><span class=\"line\"><span class=\"code\">    - name: config httpd</span></span><br><span class=\"line\"><span class=\"code\">      template: src=./httpd.conf dest=/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"code\">      notify:                 #定义执行一个动作(action)让handlers来引用执行，与handlers配合使用</span></span><br><span class=\"line\"><span class=\"code\">        - restart apache      #notify要执行的动作，这里必须与handlers中的name定义内容一致</span></span><br><span class=\"line\"><span class=\"code\">    - name: copy index.html</span></span><br><span class=\"line\"><span class=\"code\">      copy: src=/var/www/html/index.html dest=/var/www/html/index.html</span></span><br><span class=\"line\"><span class=\"code\">    - name: start httpd</span></span><br><span class=\"line\"><span class=\"code\">      service: name=httpd state=started</span></span><br><span class=\"line\">  handlers:                                    #处理器：更加tasks中notify定义的action触发执行相应的处理动作</span><br><span class=\"line\"><span class=\"code\">    - name: restart apache                     #要与notify定义的内容相同</span></span><br><span class=\"line\"><span class=\"code\">      service: name=httpd state=restarted      #触发要执行的动作</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">#测试页面准备</span></span><br><span class=\"line\">[root@ansible ~]# echo \"<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">h1</span>&gt;</span></span>playbook test file<span class=\"xml\"><span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span></span>\" &gt;&gt;/var/www/html/index.html</span><br><span class=\"line\"><span class=\"section\">#配置文件准备</span></span><br><span class=\"line\">[root@ansible ~]# cat httpd.conf |grep ^Listen</span><br><span class=\"line\">Listen &#123;&#123; http_port &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">#执行playbook， 第一次执行可以加-C选项，检查写的playbook是否ok</span></span><br><span class=\"line\">[root@ansible ~]# ansible-playbook playbook01.yml</span><br><span class=\"line\">PLAY [192.168.1.31] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">TASK [create new file] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">TASK [create new user] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">TASK [install package] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">TASK [config httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">TASK [copy index.html] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">TASK [start httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">192.168.1.31               : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\"># 验证上面playbook执行的结果</span></span><br><span class=\"line\">[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'ls /tmp/playtest.txt &amp;&amp; id test02'</span><br><span class=\"line\">192.168.1.31 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">/tmp/playtest.txt</span><br><span class=\"line\">uid=990(test02) gid=985(test02) 组=985(test02)</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]# curl 192.168.1.31:8088</span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">h1</span>&gt;</span></span>playbook test file<span class=\"xml\"><span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span></span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Playbook的运行方式\"><a href=\"#Playbook的运行方式\" class=\"headerlink\" title=\"Playbook的运行方式\"></a>Playbook的运行方式</h2><blockquote>\n<p>通过<code>ansible-playbook</code>命令运行<br>格式：<code>ansible-playbook &lt;filename.yml&gt; ... [options]</code><br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# ansible-playbook -h</span><br><span class=\"line\">#ansible-playbook常用选项：</span><br><span class=\"line\">-<span class=\"ruby\">-check  <span class=\"keyword\">or</span> -C    <span class=\"comment\">#只检测可能会发生的改变，但不真正执行操作</span></span></span><br><span class=\"line\"><span class=\"ruby\">--list-hosts      <span class=\"comment\">#列出运行任务的主机</span></span></span><br><span class=\"line\"><span class=\"ruby\">--list-tags       <span class=\"comment\">#列出playbook文件中定义所有的tags</span></span></span><br><span class=\"line\"><span class=\"ruby\">--list-tasks      <span class=\"comment\">#列出playbook文件中定义的所以任务集</span></span></span><br><span class=\"line\"><span class=\"ruby\">--limit           <span class=\"comment\">#主机列表 只针对主机列表中的某个主机或者某个组执行</span></span></span><br><span class=\"line\"><span class=\"ruby\">-f                <span class=\"comment\">#指定并发数，默认为5个</span></span></span><br><span class=\"line\"><span class=\"ruby\">-t                <span class=\"comment\">#指定tags运行，运行某一个或者多个tags。（前提playbook中有定义tags）</span></span></span><br><span class=\"line\"><span class=\"ruby\">-v                <span class=\"comment\">#显示过程  -vv  -vvv更详细</span></span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"Playbook中元素属性\"><a href=\"#Playbook中元素属性\" class=\"headerlink\" title=\"Playbook中元素属性\"></a>Playbook中元素属性</h2><h3 id=\"主机与用户\"><a href=\"#主机与用户\" class=\"headerlink\" title=\"主机与用户\"></a>主机与用户</h3><blockquote>\n<p>在一个<code>playbook</code>开始时，最先定义的是要操作的主机和用户</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>除了上面的定义外，还可以在某一个<code>tasks</code>中定义要执行该任务的远程用户</p>\n</blockquote>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tasks: </span><br><span class=\"line\">  - name: <span class=\"keyword\">run</span> df -<span class=\"built_in\">h</span></span><br><span class=\"line\">    remote_user: <span class=\"keyword\">test</span></span><br><span class=\"line\">    <span class=\"keyword\">shell</span>: name=df -<span class=\"built_in\">h</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>还可以定义使用<code>sudo</code>授权用户执行该任务</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">tasks:</span> </span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">run</span> <span class=\"string\">df</span> <span class=\"bullet\">-h</span></span><br><span class=\"line\"><span class=\"attr\">    sudo_user:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">    sudo:</span> <span class=\"literal\">yes</span></span><br><span class=\"line\"><span class=\"attr\">    shell:</span> <span class=\"string\">name=df</span> <span class=\"bullet\">-h</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"tasks任务列表\"><a href=\"#tasks任务列表\" class=\"headerlink\" title=\"tasks任务列表\"></a>tasks任务列表</h3><blockquote>\n<p>每一个<code>task</code>必须有一个名称<code>name</code>,这样在运行<code>playbook</code>时，从其输出的任务执行信息中可以很清楚的辨别是属于哪一个<code>task</code>的，如果没有定义 <code>name</code>，<code>action</code>的值将会用作输出信息中标记特定的<code>task</code>。<br>每一个<code>playbook</code>中可以包含一个或者多个<code>tasks</code>任务列表，每一个<code>tasks</code>完成具体的一件事，（任务模块）比如创建一个用户或者安装一个软件等，在<code>hosts</code>中定义的主机或者主机组都将会执行这个被定义的<code>tasks</code>。</p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tasks:</span><br><span class=\"line\">  - name: create new file</span><br><span class=\"line\">    file: <span class=\"attribute\">path</span>=/tmp/test01.txt <span class=\"attribute\">state</span>=touch</span><br><span class=\"line\">  - name: create new user</span><br><span class=\"line\">    user: <span class=\"attribute\">name</span>=test001 <span class=\"attribute\">state</span>=present</span><br></pre></td></tr></table></figure>\n<h3 id=\"Handlers与Notify\"><a href=\"#Handlers与Notify\" class=\"headerlink\" title=\"Handlers与Notify\"></a>Handlers与Notify</h3><blockquote>\n<p>很多时候当我们某一个配置发生改变，我们需要重启服务，（比如httpd配置文件文件发生改变了）这时候就可以用到<code>handlers</code>和<code>notify</code>了；<br>(当发生改动时)<code>notify actions</code>会在<code>playbook</code>的每一个task结束时被触发，而且即使有多个不同task通知改动的发生，<code>notify actions</code>知会被触发一次；比如多个<code>resources</code>指出因为一个配置文件被改动，所以<code>apache</code>需要重启，但是重新启动的操作知会被执行一次。</p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# cat httpd.yml </span><br><span class=\"line\"><span class=\"comment\">#用于安装httpd并配置启动</span></span><br><span class=\"line\">---</span><br><span class=\"line\">- hosts: 192.168.1.31</span><br><span class=\"line\">  remote_user: root</span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">  - name: install httpd</span><br><span class=\"line\">    yum: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=installed</span><br><span class=\"line\">  - name:<span class=\"built_in\"> config </span>httpd</span><br><span class=\"line\">    template: <span class=\"attribute\">src</span>=/root/httpd.conf <span class=\"attribute\">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class=\"line\">    notify:</span><br><span class=\"line\">      - restart httpd</span><br><span class=\"line\">  - name: start httpd</span><br><span class=\"line\">    service: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=started</span><br><span class=\"line\"></span><br><span class=\"line\">  handlers:</span><br><span class=\"line\">    - name: restart httpd</span><br><span class=\"line\">      service: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=restarted</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#这里只要对httpd.conf配置文件作出了修改，修改后需要重启生效，在tasks中定义了restart httpd这个action，然后在handlers中引用上面tasks中定义的notify。</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Playbook中变量的使用\"><a href=\"#Playbook中变量的使用\" class=\"headerlink\" title=\"Playbook中变量的使用\"></a>Playbook中变量的使用</h2><p><strong>环境说明</strong>：这里配置了两个组，一个apache组和一个nginx组<br><figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible PlayBook]</span># cat /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"string\">[apache]</span></span><br><span class=\"line\"><span class=\"number\">192.168.1.36</span></span><br><span class=\"line\"><span class=\"number\">192.168.1.33</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[nginx]</span></span><br><span class=\"line\"><span class=\"number\">192.168.1.3</span><span class=\"string\">[1:2]</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"命令行指定变量\"><a href=\"#命令行指定变量\" class=\"headerlink\" title=\"命令行指定变量\"></a>命令行指定变量</h3><blockquote>\n<p>执行<code>playbook</code>时候通过参数<code>-e</code>传入变量，这样传入的变量在整个<code>playbook</code>中都可以被调用，属于全局变量</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">variables.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">install</span> <span class=\"string\">pkg</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">pkg</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行playbook 指定pkg</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span> <span class=\"bullet\">-e</span> <span class=\"string\">\"pkg=httpd\"</span> <span class=\"string\">variables.yml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"hosts文件中定义变量\"><a href=\"#hosts文件中定义变量\" class=\"headerlink\" title=\"hosts文件中定义变量\"></a>hosts文件中定义变量</h3><blockquote>\n<p>在<code>/etc/ansible/hosts</code>文件中定义变量，可以针对每个主机定义不同的变量，也可以定义一个组的变量，然后直接在<code>playbook</code>中直接调用。注意，组中定义的变量没有单个主机中的优先级高。</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑hosts文件定义变量</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">vim</span> <span class=\"string\">/etc/ansible/hosts</span></span><br><span class=\"line\"><span class=\"string\">[apache]</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.36</span> <span class=\"string\">webdir=/opt/test</span>     <span class=\"comment\">#定义单个主机的变量</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br><span class=\"line\"><span class=\"string\">[apache:vars]</span>      <span class=\"comment\">#定义整个组的统一变量</span></span><br><span class=\"line\"><span class=\"string\">webdir=/web/test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[nginx]</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.3</span><span class=\"string\">[1:2]</span></span><br><span class=\"line\"><span class=\"string\">[nginx:vars]</span></span><br><span class=\"line\"><span class=\"string\">webdir=/opt/web</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑playbook文件</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">variables.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">webdir</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">webdir</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=directory</span>   <span class=\"comment\">#引用变量</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span> <span class=\"string\">variables.yml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"playbook文件中定义变量\"><a href=\"#playbook文件中定义变量\" class=\"headerlink\" title=\"playbook文件中定义变量\"></a>playbook文件中定义变量</h3><blockquote>\n<p>编写<code>playbook</code>时，直接在里面定义变量，然后直接引用，可以定义多个变量；注意：如果在执行<code>playbook</code>时，又通过<code>-e</code>参数指定变量的值，那么会以<code>-e</code>参数指定的为准。</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">variables.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span>                <span class=\"comment\">#定义变量</span></span><br><span class=\"line\"><span class=\"attr\">    pkg:</span> <span class=\"string\">nginx</span>         <span class=\"comment\">#变量1</span></span><br><span class=\"line\"><span class=\"attr\">    dir:</span> <span class=\"string\">/tmp/test1</span>    <span class=\"comment\">#变量2</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">install</span> <span class=\"string\">pkg</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">pkg</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=installed</span>    <span class=\"comment\">#引用变量</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">new</span> <span class=\"string\">dir</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">dir</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=directory</span>   <span class=\"comment\">#引用变量</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span> <span class=\"string\">variables.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果执行时候又重新指定了变量的值，那么会已重新指定的为准</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span> <span class=\"bullet\">-e</span> <span class=\"string\">\"dir=/tmp/test2\"</span> <span class=\"string\">variables.yml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"调用setup模块获取变量\"><a href=\"#调用setup模块获取变量\" class=\"headerlink\" title=\"调用setup模块获取变量\"></a>调用setup模块获取变量</h3><blockquote>\n<p><code>setup</code>模块默认是获取主机信息的，有时候在<code>playbook</code>中需要用到，所以可以直接调用。常用的参数<a href=\"https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup\" target=\"_blank\" rel=\"noopener\">参考</a></p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑playbook文件</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">variables.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">ansible_fqdn</span> <span class=\"string\">&#125;&#125;.log</span> <span class=\"string\">state=touch</span>   <span class=\"comment\">#引用setup中的ansible_fqdn</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span> <span class=\"string\">variables.yml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"独立的变量YAML文件中定义\"><a href=\"#独立的变量YAML文件中定义\" class=\"headerlink\" title=\"独立的变量YAML文件中定义\"></a>独立的变量YAML文件中定义</h3><blockquote>\n<p>为了方便管理将所有的变量统一放在一个独立的变量<code>YAML</code>文件中，<code>laybook</code>文件直接引用文件调用变量即可。</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义存放变量的文件</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">var.yml</span> </span><br><span class=\"line\"><span class=\"attr\">var1:</span> <span class=\"string\">vsftpd</span></span><br><span class=\"line\"><span class=\"attr\">var2:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编写playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">variables.yml</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars_files:</span>    <span class=\"comment\">#引用变量文件</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">./var.yml</span>   <span class=\"comment\">#指定变量文件的path（这里可以是绝对路径，也可以是相对路径）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">install</span> <span class=\"string\">package</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">var1</span> <span class=\"string\">&#125;&#125;</span>   <span class=\"comment\">#引用变量</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">create</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span> <span class=\"string\">name=/tmp/&#123;&#123;</span> <span class=\"string\">var2</span> <span class=\"string\">&#125;&#125;.log</span> <span class=\"string\">state=touch</span>   <span class=\"comment\">#引用变量</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行playbook</span></span><br><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">ansible-playbook</span>  <span class=\"string\">variables.yml</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Playbook中标签的使用\"><a href=\"#Playbook中标签的使用\" class=\"headerlink\" title=\"Playbook中标签的使用\"></a>Playbook中标签的使用</h2><blockquote>\n<p>一个<code>playbook</code>文件中，执行时如果想执行某一个任务，那么可以给每个任务集进行打标签，这样在执行的时候可以通过<code>-t</code>选择指定标签执行，还可以通过<code>--skip-tags</code>选择除了某个标签外全部执行等。</p>\n</blockquote>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># 编辑playbook</span></span><br><span class=\"line\">[root@ansible PlayBook]# cat httpd.yml </span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"bullet\">- </span>hosts: 192.168.1.31</span><br><span class=\"line\">  remote_user: root</span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\"><span class=\"code\">    - name: install httpd</span></span><br><span class=\"line\"><span class=\"code\">      yum: name=httpd state=installed</span></span><br><span class=\"line\"><span class=\"code\">      tags: inhttpd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"code\">    - name: start httpd</span></span><br><span class=\"line\"><span class=\"code\">      service: name=httpd state=started</span></span><br><span class=\"line\"><span class=\"code\">      tags: sthttpd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"code\">    - name: restart httpd</span></span><br><span class=\"line\"><span class=\"code\">      service: name=httpd state=restarted</span></span><br><span class=\"line\"><span class=\"code\">      tags: </span></span><br><span class=\"line\"><span class=\"code\">        - rshttpd</span></span><br><span class=\"line\"><span class=\"code\">        - rs_httpd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\"># 正常执行的结果</span></span><br><span class=\"line\">[root@ansible PlayBook]# ansible-playbook httpd.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [192.168.1.31] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [install httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [start httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [restart httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">192.168.1.31               : ok=4    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>\n<p>1）通过<code>-t</code>选项指定<code>tags</code>进行执行<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># 通过-t指定tags名称，多个tags用逗号隔开</span></span><br><span class=\"line\">[root@ansible PlayBook]# ansible-playbook -t rshttpd httpd.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [192.168.1.31] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [restart httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">192.168.1.31               : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<p>2）通过<code>--skip-tags</code>选项排除不执行的<code>tags</code><br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# ansible-playbook --skip-tags inhttpd httpd.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [192.168.1.31] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [start httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [restart httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">192.168.1.31               : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Playbook中模板的使用\"><a href=\"#Playbook中模板的使用\" class=\"headerlink\" title=\"Playbook中模板的使用\"></a>Playbook中模板的使用</h2><blockquote>\n<p><code>template</code>模板为我们提供了动态配置服务，使用<code>jinja2</code>语言，里面支持多种条件判断、循环、逻辑运算、比较操作等。其实说白了也就是一个文件，和之前配置文件使用<code>copy</code>一样，只是使用<code>copy</code>，不能根据服务器配置不一样进行不同动态的配置。这样就不利于管理。<br>说明：<br>1、多数情况下都将<code>template</code>文件放在和<code>playbook</code>文件同级的<code>templates</code>目录下（手动创建），这样<code>playbook</code>文件中可以直接引用，会自动去找这个文件。如果放在别的地方，也可以通过绝对路径去指定。<br>2、模板文件后缀名为<code>.j2</code>。</p>\n</blockquote>\n<p><a href=\"http://www.ansible.com.cn/docs/playbooks_loops.html#standard-loops\" target=\"_blank\" rel=\"noopener\">循环参考</a><br><strong>示例：通过template安装httpd</strong><br>1）<code>playbook</code>文件编写<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">testtmp.yml</span> </span><br><span class=\"line\"><span class=\"comment\">#模板示例</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    - listen_port:</span> <span class=\"number\">88</span>    <span class=\"comment\">#定义变量</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Install</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=installed</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Config</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">      template:</span> <span class=\"string\">src=httpd.conf.j2</span> <span class=\"string\">dest=/etc/httpd/conf/httpd.conf</span>    <span class=\"comment\">#使用模板</span></span><br><span class=\"line\"><span class=\"attr\">      notify:</span> <span class=\"string\">Restart</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Start</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">      service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=started</span></span><br><span class=\"line\">      </span><br><span class=\"line\"><span class=\"attr\">  handlers:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Restart</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">      service:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=restarted</span></span><br></pre></td></tr></table></figure></p>\n<p>2）模板文件准备，<code>httpd</code>配置文件准备，这里配置文件端口使用了变量<br><figure class=\"highlight mathematica\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# cat templates/httpd.conf.j2 |grep ^<span class=\"keyword\">Listen</span></span><br><span class=\"line\"><span class=\"keyword\">Listen</span> &#123;&#123; listen_port &#125;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）查看目录结构<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 目录结构</span><br><span class=\"line\"><span class=\"selector-attr\">[root@ansible PlayBook]</span># <span class=\"selector-tag\">tree</span> .</span><br><span class=\"line\">.</span><br><span class=\"line\">├── <span class=\"selector-tag\">templates</span></span><br><span class=\"line\">│   └── <span class=\"selector-tag\">httpd</span><span class=\"selector-class\">.conf</span><span class=\"selector-class\">.j2</span></span><br><span class=\"line\">└── <span class=\"selector-tag\">testtmp</span><span class=\"selector-class\">.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\">1 <span class=\"selector-tag\">directory</span>, 2 <span class=\"selector-tag\">files</span></span><br></pre></td></tr></table></figure></p>\n<p>4）执行<code>playbook</code>，由于<code>192.168.1.36</code>那台机器是<code>6</code>的系统，模板文件里面的配置文件是<code>7</code>上面默认的<code>httpd</code>配置文件，<code>httpd</code>版本不一样(<code>6默认版本为2.2.15，7默认版本为2.4.6</code>)，所以拷贝过去后启动报错。下面使用<code>playbook</code>中的判断语句进行处理；此处先略过<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# ansible-playbook testtmp.yml </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [all] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Install Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Config Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Start Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">fatal: [192.168.1.36]: FAILED! =&gt; &#123;\"changed\": false, \"msg\": \"httpd: Syntax error on line 56 of /etc/httpd/conf/httpd.conf: Include directory '/etc/httpd/conf.modules.d' not found\\n\"&#125;</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [Restart Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">192.168.1.31               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.32               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.33               : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.36               : ok=3    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"template之when\"><a href=\"#template之when\" class=\"headerlink\" title=\"template之when\"></a>template之when</h3><p><a href=\"http://www.ansible.com.cn/docs/playbooks_conditionals.html#when\" target=\"_blank\" rel=\"noopener\">when语句参考</a></p>\n<blockquote>\n<p>条件测试：如果需要根据变量、<code>facts</code>或此前任务的执行结果来做为某<code>task</code>执行与否的前提时要用到条件测试，通过<code>when</code>语句执行，在<code>task</code>中使用<code>jinja2</code>的语法格式、<br>when语句：<br>在<code>task</code>后添加<code>when</code>子句即可使用条件测试；<code>when</code>语句支持<code>jinja2</code>表达式语法。</p>\n</blockquote>\n<p>类似这样：<br><figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tasks:</span><br><span class=\"line\">  - <span class=\"keyword\">command</span>: /<span class=\"title\">bin</span>/<span class=\"title\">false</span></span><br><span class=\"line\">    register: <span class=\"built_in\">result</span></span><br><span class=\"line\">    ignore_errors: True</span><br><span class=\"line\">  - <span class=\"keyword\">command</span>: /<span class=\"title\">bin</span>/<span class=\"title\">something</span></span><br><span class=\"line\">    when: <span class=\"built_in\">result</span>|failed</span><br><span class=\"line\">  - <span class=\"keyword\">command</span>: /<span class=\"title\">bin</span>/<span class=\"title\">something_else</span></span><br><span class=\"line\">    when: <span class=\"built_in\">result</span>|success</span><br><span class=\"line\">  - <span class=\"keyword\">command</span>: /<span class=\"title\">bin</span>/<span class=\"title\">still</span>/<span class=\"title\">something_else</span></span><br><span class=\"line\">    when: <span class=\"built_in\">result</span>|skipped</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例：通过when语句完善上面的httpd配置</strong><br>1）准备两个配置文件，一个<code>centos6</code>系统<code>httpd</code>配置文件，一个<code>centos7</code>系统httpd配置文件。<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# tree templates/</span><br><span class=\"line\">templates/</span><br><span class=\"line\">├── httpd6.conf.j2     #<span class=\"number\">6</span>系统<span class=\"number\">2.2</span><span class=\"number\">.15</span>版本httpd配置文件</span><br><span class=\"line\">└── httpd7.conf.j2     #<span class=\"number\">7</span>系统<span class=\"number\">2.4</span><span class=\"number\">.6</span>版本httpd配置文件</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span> directories, <span class=\"number\">2</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）修改<code>playbook</code>文件，通过setup模块获取系统版本去判断。<a href=\"https://buji595.github.io/2019/05/27/Ansible%20Ad-hoc%E5%B8%B8%E7%94%A8Module/#setup\" target=\"_blank\" rel=\"noopener\">setup常用模块</a><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# cat testtmp.yml </span><br><span class=\"line\"><span class=\"comment\">#when示例</span></span><br><span class=\"line\">---</span><br><span class=\"line\">- hosts: all</span><br><span class=\"line\">  remote_user: root</span><br><span class=\"line\">  vars:</span><br><span class=\"line\">    - listen_port: 88</span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">    - name: Install Httpd</span><br><span class=\"line\">      yum: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=installed</span><br><span class=\"line\">    - name:<span class=\"built_in\"> Config </span>System6 Httpd</span><br><span class=\"line\">      template: <span class=\"attribute\">src</span>=httpd6.conf.j2 <span class=\"attribute\">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class=\"line\">      when: ansible_distribution_major_version == <span class=\"string\">\"6\"</span>   #判断系统版本，为6便执行上面的template配置6的配置文件</span><br><span class=\"line\">      notify: Restart Httpd</span><br><span class=\"line\">    - name:<span class=\"built_in\"> Config </span>System7 Httpd</span><br><span class=\"line\">      template: <span class=\"attribute\">src</span>=httpd7.conf.j2 <span class=\"attribute\">dest</span>=/etc/httpd/conf/httpd.conf</span><br><span class=\"line\">      when: ansible_distribution_major_version == <span class=\"string\">\"7\"</span>   #判断系统版本，为7便执行上面的template配置7的配置文件</span><br><span class=\"line\">      notify: Restart Httpd</span><br><span class=\"line\">    - name: Start Httpd</span><br><span class=\"line\">      service: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=started</span><br><span class=\"line\"></span><br><span class=\"line\">  handlers:</span><br><span class=\"line\">    - name: Restart Httpd</span><br><span class=\"line\">      service: <span class=\"attribute\">name</span>=httpd <span class=\"attribute\">state</span>=restarted</span><br></pre></td></tr></table></figure></p>\n<p>3）执行playbook<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]# ansible-playbook testtmp.yml</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [all] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Install Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Config System6 Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">skipping: [192.168.1.33]</span><br><span class=\"line\">skipping: [192.168.1.31]</span><br><span class=\"line\">skipping: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Config System7 Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span></span><br><span class=\"line\">skipping: [192.168.1.36]</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Start Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span>**</span><br><span class=\"line\">ok: [192.168.1.36]</span><br><span class=\"line\">ok: [192.168.1.31]</span><br><span class=\"line\">ok: [192.168.1.32]</span><br><span class=\"line\">ok: [192.168.1.33]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [Restart Httpd] <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"emphasis\">***</span>*</span><br><span class=\"line\">changed: [192.168.1.33]</span><br><span class=\"line\">changed: [192.168.1.31]</span><br><span class=\"line\">changed: [192.168.1.32]</span><br><span class=\"line\">changed: [192.168.1.36]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP <span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span><span class=\"strong\">*****</span></span><br><span class=\"line\">192.168.1.31               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.32               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.33               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">192.168.1.36               : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"template之with-items\"><a href=\"#template之with-items\" class=\"headerlink\" title=\"template之with_items\"></a>template之with_items</h3><blockquote>\n<p><code>with_items</code>迭代，当有需要重复性执行的任务时，可以使用迭代机制。<br>对迭代项的引用，固定变量名为<code>“item”</code>，要在task中使用with_items给定要迭代的元素列表。<br>列表格式：<br>&emsp;&ensp;字符串<br>&emsp;&ensp;字典</p>\n</blockquote>\n<p><strong>示例1：通过with_items安装多个不同软件</strong><br>编写<code>playbook</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">testwith.yml</span> </span><br><span class=\"line\"><span class=\"comment\"># 示例with_items</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Install</span> <span class=\"string\">Package</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=&#123;&#123;</span> <span class=\"string\">item</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=installed</span>   <span class=\"comment\">#引用item获取值</span></span><br><span class=\"line\"><span class=\"attr\">      with_items:</span>     <span class=\"comment\">#定义with_items</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">vsftpd</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">nginx</span></span><br></pre></td></tr></table></figure></p>\n<p>上面<code>tasks</code>写法等同于：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Install</span> <span class=\"string\">Httpd</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=installed</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Install</span> <span class=\"string\">Vsftpd</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=vsftpd</span> <span class=\"string\">state=installed</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Install</span> <span class=\"string\">Nginx</span></span><br><span class=\"line\"><span class=\"attr\">      yum:</span> <span class=\"string\">name=nginx</span> <span class=\"string\">state=installed</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>示例2：通过嵌套子变量创建用户并加入不同的组</strong><br>1）编写<code>playbook</code><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># cat testwith01.yml </span></span><br><span class=\"line\"><span class=\"comment\"># 示例with_items嵌套子变量</span></span><br><span class=\"line\"><span class=\"comment\">---</span></span><br><span class=\"line\">- hosts: all</span><br><span class=\"line\">  remote_user: root</span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">    - name: <span class=\"keyword\">Create</span> <span class=\"keyword\">New</span> <span class=\"keyword\">Group</span></span><br><span class=\"line\">      <span class=\"keyword\">group</span>: <span class=\"keyword\">name</span>=&#123;&#123; item &#125;&#125; state=<span class=\"keyword\">present</span></span><br><span class=\"line\">      with_items: </span><br><span class=\"line\">        - group1</span><br><span class=\"line\">        - group2</span><br><span class=\"line\">        - group3 </span><br><span class=\"line\"></span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: <span class=\"keyword\">Create</span> <span class=\"keyword\">New</span> <span class=\"keyword\">User</span></span><br><span class=\"line\">      <span class=\"keyword\">user</span>: <span class=\"keyword\">name</span>=&#123;&#123; item.name &#125;&#125; <span class=\"keyword\">group</span>=&#123;&#123; item.group &#125;&#125; state=<span class=\"keyword\">present</span></span><br><span class=\"line\">      with_items:</span><br><span class=\"line\">        - &#123; <span class=\"keyword\">name</span>: <span class=\"string\">'user1'</span>, <span class=\"keyword\">group</span>: <span class=\"string\">'group1'</span> &#125; </span><br><span class=\"line\">        - &#123; <span class=\"keyword\">name</span>: <span class=\"string\">'user2'</span>, <span class=\"keyword\">group</span>: <span class=\"string\">'group2'</span> &#125; </span><br><span class=\"line\">        - &#123; <span class=\"keyword\">name</span>: <span class=\"string\">'user3'</span>, <span class=\"keyword\">group</span>: <span class=\"string\">'group3'</span> &#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）执行<code>playbook</code>并验证<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 执行playbook</span></span><br><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># ansible-playbook testwith01.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证是否成功创建用户及组</span></span><br><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># ansible all -m shell -a 'tail -3 /etc/passwd'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.36 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"symbol\">user1:</span><span class=\"symbol\">x:</span><span class=\"number\">500</span><span class=\"symbol\">:</span><span class=\"number\">500</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user1</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user2:</span><span class=\"symbol\">x:</span><span class=\"number\">501</span><span class=\"symbol\">:</span><span class=\"number\">501</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user2</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user3:</span><span class=\"symbol\">x:</span><span class=\"number\">502</span><span class=\"symbol\">:</span><span class=\"number\">502</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user3</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">192.168.1.32 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"symbol\">user1:</span><span class=\"symbol\">x:</span><span class=\"number\">1001</span><span class=\"symbol\">:</span><span class=\"number\">1001</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user1</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user2:</span><span class=\"symbol\">x:</span><span class=\"number\">1002</span><span class=\"symbol\">:</span><span class=\"number\">1002</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user2</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user3:</span><span class=\"symbol\">x:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user3</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"symbol\">user1:</span><span class=\"symbol\">x:</span><span class=\"number\">1002</span><span class=\"symbol\">:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user1</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user2:</span><span class=\"symbol\">x:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"number\">1004</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user2</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user3:</span><span class=\"symbol\">x:</span><span class=\"number\">1004</span><span class=\"symbol\">:</span><span class=\"number\">1005</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user3</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">192.168.1.33 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"symbol\">user1:</span><span class=\"symbol\">x:</span><span class=\"number\">1001</span><span class=\"symbol\">:</span><span class=\"number\">1001</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user1</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user2:</span><span class=\"symbol\">x:</span><span class=\"number\">1002</span><span class=\"symbol\">:</span><span class=\"number\">1002</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user2</span><span class=\"symbol\">:/bin/bash</span></span><br><span class=\"line\"><span class=\"symbol\">user3:</span><span class=\"symbol\">x:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/user3</span><span class=\"symbol\">:/bin/bash</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"template之for-if\"><a href=\"#template之for-if\" class=\"headerlink\" title=\"template之for if\"></a>template之for if</h3><blockquote>\n<p>通过使用<code>for</code>，<code>if</code>可以更加灵活的生成配置文件等需求，还可以在里面根据各种条件进行判断，然后生成不同的配置文件、或者服务器配置相关等。</p>\n</blockquote>\n<p><strong>示例1</strong><br>1）编写<code>playbook</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">testfor01.yml</span> </span><br><span class=\"line\"><span class=\"comment\"># template for 示例</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    nginx_vhost_port:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">81</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">82</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">83</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Templage</span> <span class=\"string\">Nginx</span> <span class=\"string\">Config</span></span><br><span class=\"line\"><span class=\"attr\">      template:</span> <span class=\"string\">src=nginx.conf.j2</span> <span class=\"string\">dest=/tmp/nginx_test.conf</span></span><br></pre></td></tr></table></figure></p>\n<p>2）模板文件编写<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 循环playbook文件中定义的变量，依次赋值给port</span></span><br><span class=\"line\">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span><br><span class=\"line\">&#123;% <span class=\"keyword\">for</span><span class=\"built_in\"> port </span><span class=\"keyword\">in</span> nginx_vhost_port %&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     listen: &#123;&#123;<span class=\"built_in\"> port </span>&#125;&#125;;</span><br><span class=\"line\">     server_name: localhost;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）执行<code>playbook</code>并查看生成结果<br><figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># ansible-playbook testfor01.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class=\"line\">[root@linux ~]<span class=\"comment\"># cat /tmp/nginx_test.conf </span></span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>: 81;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>: localhost;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>: 82;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>: localhost;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>: 83;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>: localhost;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例2</strong><br>1）编写<code>playbook</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">testfor02.yml</span> </span><br><span class=\"line\"><span class=\"comment\"># template for 示例</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    nginx_vhosts:</span></span><br><span class=\"line\"><span class=\"attr\">      - web1:</span></span><br><span class=\"line\"><span class=\"attr\">        listen:</span> <span class=\"number\">8081</span></span><br><span class=\"line\"><span class=\"attr\">        server_name:</span> <span class=\"string\">\"web1.example.com\"</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web1\"</span></span><br><span class=\"line\"><span class=\"attr\">      - web2:</span></span><br><span class=\"line\"><span class=\"attr\">        listen:</span> <span class=\"number\">8082</span></span><br><span class=\"line\"><span class=\"attr\">        server_name:</span> <span class=\"string\">\"web2.example.com\"</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web2\"</span></span><br><span class=\"line\"><span class=\"attr\">      - web3:</span></span><br><span class=\"line\"><span class=\"attr\">        listen:</span> <span class=\"number\">8083</span></span><br><span class=\"line\"><span class=\"attr\">        server_name:</span> <span class=\"string\">\"web3.example.com\"</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web3\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Templage</span> <span class=\"string\">Nginx</span> <span class=\"string\">Config</span></span><br><span class=\"line\"><span class=\"attr\">      template:</span> <span class=\"string\">src=nginx.conf.j2</span> <span class=\"string\">dest=/tmp/nginx_vhost.conf</span></span><br></pre></td></tr></table></figure></p>\n<p>2）模板文件编写<br><figure class=\"highlight django\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"xml\">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span></span><br><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">for</span></span> vhost <span class=\"keyword\">in</span> nginx_vhosts %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">server&#123;</span></span><br><span class=\"line\"><span class=\"xml\">     listen:    </span><span class=\"template-variable\">&#123;&#123; vhost.listen &#125;&#125;</span><span class=\"xml\">;</span></span><br><span class=\"line\"><span class=\"xml\">     server_name:    </span><span class=\"template-variable\">&#123;&#123; vhost.server_name &#125;&#125;</span><span class=\"xml\">;</span></span><br><span class=\"line\"><span class=\"xml\">     root:   </span><span class=\"template-variable\">&#123;&#123; vhost.root &#125;&#125;</span><span class=\"xml\">; </span></span><br><span class=\"line\"><span class=\"xml\">&#125;</span></span><br><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">endfor</span></span> %&#125;</span><span class=\"xml\"></span></span><br></pre></td></tr></table></figure></p>\n<p>3）执行<code>playbook</code>并查看生成结果<br><figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># ansible-playbook testfor02.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class=\"line\">[root@linux ~]<span class=\"comment\"># cat /tmp/nginx_vhost.conf </span></span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>:    8081;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>:    web1<span class=\"variable\">.example</span><span class=\"variable\">.com</span>;</span><br><span class=\"line\">     <span class=\"attribute\">root</span>:   /var/www/nginx/web1; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>:    8082;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>:    web2<span class=\"variable\">.example</span><span class=\"variable\">.com</span>;</span><br><span class=\"line\">     <span class=\"attribute\">root</span>:   /var/www/nginx/web2; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>:    8083;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>:    web3<span class=\"variable\">.example</span><span class=\"variable\">.com</span>;</span><br><span class=\"line\">     <span class=\"attribute\">root</span>:   /var/www/nginx/web3; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例3</strong><br>在for循环中再嵌套if判断，让生成的配置文件更加灵活<br>1）编写<code>playbook</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@ansible</span> <span class=\"string\">PlayBook]#</span> <span class=\"string\">cat</span> <span class=\"string\">testfor03.yml</span> </span><br><span class=\"line\"><span class=\"comment\"># template for 示例</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    nginx_vhosts:</span></span><br><span class=\"line\"><span class=\"attr\">      - web1:</span></span><br><span class=\"line\"><span class=\"attr\">        listen:</span> <span class=\"number\">8081</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web1\"</span></span><br><span class=\"line\"><span class=\"attr\">      - web2:</span></span><br><span class=\"line\"><span class=\"attr\">        server_name:</span> <span class=\"string\">\"web2.example.com\"</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web2\"</span></span><br><span class=\"line\"><span class=\"attr\">      - web3:</span></span><br><span class=\"line\"><span class=\"attr\">        listen:</span> <span class=\"number\">8083</span></span><br><span class=\"line\"><span class=\"attr\">        server_name:</span> <span class=\"string\">\"web3.example.com\"</span></span><br><span class=\"line\"><span class=\"attr\">        root:</span> <span class=\"string\">\"/var/www/nginx/web3\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Templage</span> <span class=\"string\">Nginx</span> <span class=\"string\">Config</span></span><br><span class=\"line\"><span class=\"attr\">      template:</span> <span class=\"string\">src=nginx.conf.j2</span> <span class=\"string\">dest=/tmp/nginx_vhost.conf</span></span><br></pre></td></tr></table></figure></p>\n<p>2）模板文件编写<br><figure class=\"highlight django\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"xml\"># 说明：这里添加了判断，如果listen没有定义的话，默认端口使用8888，如果server_name有定义，那么生成的配置文件中才有这一项。</span></span><br><span class=\"line\"><span class=\"xml\">[root@ansible PlayBook]# cat templates/nginx.conf.j2 </span></span><br><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">for</span></span> vhost <span class=\"keyword\">in</span> nginx_vhosts %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">server&#123;</span></span><br><span class=\"line\"><span class=\"xml\">     </span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">if</span></span> vhost.listen is defined %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">     listen:    </span><span class=\"template-variable\">&#123;&#123; vhost.listen &#125;&#125;</span><span class=\"xml\">;</span></span><br><span class=\"line\"><span class=\"xml\">     </span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">else</span></span> %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">     listen: 8888;</span></span><br><span class=\"line\"><span class=\"xml\">     </span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">endif</span></span> %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">     </span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">if</span></span> vhost.server_name is defined %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">     server_name:    </span><span class=\"template-variable\">&#123;&#123; vhost.server_name &#125;&#125;</span><span class=\"xml\">;</span></span><br><span class=\"line\"><span class=\"xml\">     </span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">endif</span></span> %&#125;</span><span class=\"xml\"></span></span><br><span class=\"line\"><span class=\"xml\">     root:   </span><span class=\"template-variable\">&#123;&#123; vhost.root &#125;&#125;</span><span class=\"xml\">; </span></span><br><span class=\"line\"><span class=\"xml\">&#125;</span></span><br><span class=\"line\"><span class=\"xml\"></span><span class=\"template-tag\">&#123;% <span class=\"name\"><span class=\"name\">endfor</span></span> %&#125;</span><span class=\"xml\"></span></span><br></pre></td></tr></table></figure></p>\n<p>3）执行<code>playbook</code>并查看生成结果<br><figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible PlayBook]<span class=\"comment\"># ansible-playbook testfor03.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 去到一个节点看下生成的结果发现自动生成了三个虚拟主机</span></span><br><span class=\"line\">[root@linux ~]<span class=\"comment\"># cat /tmp/nginx_vhost.conf </span></span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">          <span class=\"attribute\">listen</span>:    8081;</span><br><span class=\"line\">          <span class=\"attribute\">root</span>:   /var/www/nginx/web1; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">          <span class=\"attribute\">listen</span>: 8888;</span><br><span class=\"line\">          <span class=\"attribute\">server_name</span>:    web2<span class=\"variable\">.example</span><span class=\"variable\">.com</span>;</span><br><span class=\"line\">          <span class=\"attribute\">root</span>:   /var/www/nginx/web2; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">          <span class=\"attribute\">listen</span>:    8083;</span><br><span class=\"line\">          <span class=\"attribute\">server_name</span>:    web3<span class=\"variable\">.example</span><span class=\"variable\">.com</span>;</span><br><span class=\"line\">          <span class=\"attribute\">root</span>:   /var/www/nginx/web3; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><strong>上面三个示例的图片展示效果</strong><br><div class=\"tabs\" id><ul class=\"nav-tabs\"><li class=\"tab active\"><a href=\"#-1\">示例1</a></li><li class=\"tab\"><a href=\"#-2\">示例2</a></li><li class=\"tab\"><a href=\"#-3\">示例3</a></li></ul><div class=\"tab-content\"><div class=\"tab-pane active\" id=\"-1\"><p><img src=\"/2019/05/29/Ansible之Playbook/shili01.png\" alt></p>\n</div><div class=\"tab-pane\" id=\"-2\"><p><img src=\"/2019/05/29/Ansible之Playbook/shili02.png\" alt></p>\n</div><div class=\"tab-pane\" id=\"-3\"><p><img src=\"/2019/05/29/Ansible之Playbook/shili03.png\" alt></p>\n</div></div></div></p>\n"},{"title":"ELK快速入门五-配置nginx代理kibana","date":"2019-07-05T09:30:35.000Z","copyright":true,"_content":"\n>由于`kibana`界面默认没有安全认证界面，为了保证安全，通过`nginx`进行代理并设置访问认证。\n\n## 配置kibana\n```\n[root@linux-elk1 ~]# vim /etc/kibana/kibana.yml\nserver.host: \"127.0.0.1\"    #将监听地址更改为127.0.0.1\n[root@linux-elk1 ~]# systemctl restart kibana\n[root@linux-elk1 ~]# netstat -nlutp |grep 5601\ntcp        0      0 127.0.0.1:5601          0.0.0.0:*               LISTEN      72068/node\n```\n\n\n## 部署nginx\n1）安装`nginx`\n```\n[root@linux-elk1 ~]# yum -y install nginx httpd-tools\n```\n2）配置`nginx`\n```\n[root@linux-elk1 ~]# vim /etc/nginx/conf.d/kibana.conf\nupstream kibana_server {\n    server 127.0.0.1:5601 weight=1 max_fails=3 fail_timeout=60;\n}\n\nserver {\n    listen 80;\n    server_name www.kibana.com;\n    auth_basic \"Restricted Access\";\n    auth_basic_user_file /etc/nginx/conf.d/htpasswd.users;\n    location / {\n        proxy_pass http://kibana_server;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n    }\n}\n\n[root@linux-elk1 ~]# htpasswd -bc /etc/nginx/conf.d/htpasswd.users admin 123456\nAdding password for user admin\n[root@linux-elk1 ~]# cat /etc/nginx/conf.d/htpasswd.users\nadmin:$apr1$ro5tQZp9$grhByziZtm3ZpZCsSFzsQ1\n[root@linux-elk1 ~]# systemctl start nginx\n```\n3）`windows`上添加`hosts`, 路径`C:\\Windows\\System32\\drivers\\etc\\hosts`\n```\n192.168.1.31\twww.kibana.com\n```\n4）测试验证\n![nginx01.png](ELK快速入门五-配置nginx代理kibana/nginx01.png)\n![nginx02.png](ELK快速入门五-配置nginx代理kibana/nginx02.png)\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/ELK快速入门五-配置nginx代理kibana.md","raw":"---\ntitle: ELK快速入门五-配置nginx代理kibana\ndate: 2019-07-05 17:30:35\ntags: ELK\ncategories: ELK\ncopyright: true\n---\n\n>由于`kibana`界面默认没有安全认证界面，为了保证安全，通过`nginx`进行代理并设置访问认证。\n\n## 配置kibana\n```\n[root@linux-elk1 ~]# vim /etc/kibana/kibana.yml\nserver.host: \"127.0.0.1\"    #将监听地址更改为127.0.0.1\n[root@linux-elk1 ~]# systemctl restart kibana\n[root@linux-elk1 ~]# netstat -nlutp |grep 5601\ntcp        0      0 127.0.0.1:5601          0.0.0.0:*               LISTEN      72068/node\n```\n\n\n## 部署nginx\n1）安装`nginx`\n```\n[root@linux-elk1 ~]# yum -y install nginx httpd-tools\n```\n2）配置`nginx`\n```\n[root@linux-elk1 ~]# vim /etc/nginx/conf.d/kibana.conf\nupstream kibana_server {\n    server 127.0.0.1:5601 weight=1 max_fails=3 fail_timeout=60;\n}\n\nserver {\n    listen 80;\n    server_name www.kibana.com;\n    auth_basic \"Restricted Access\";\n    auth_basic_user_file /etc/nginx/conf.d/htpasswd.users;\n    location / {\n        proxy_pass http://kibana_server;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n    }\n}\n\n[root@linux-elk1 ~]# htpasswd -bc /etc/nginx/conf.d/htpasswd.users admin 123456\nAdding password for user admin\n[root@linux-elk1 ~]# cat /etc/nginx/conf.d/htpasswd.users\nadmin:$apr1$ro5tQZp9$grhByziZtm3ZpZCsSFzsQ1\n[root@linux-elk1 ~]# systemctl start nginx\n```\n3）`windows`上添加`hosts`, 路径`C:\\Windows\\System32\\drivers\\etc\\hosts`\n```\n192.168.1.31\twww.kibana.com\n```\n4）测试验证\n![nginx01.png](ELK快速入门五-配置nginx代理kibana/nginx01.png)\n![nginx02.png](ELK快速入门五-配置nginx代理kibana/nginx02.png)\n\n\n\n\n\n\n\n\n\n\n","slug":"ELK快速入门五-配置nginx代理kibana","published":1,"updated":"2019-10-24T09:12:16.884Z","_id":"cjz3xyifu0000dstchojk9zfj","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>由于<code>kibana</code>界面默认没有安全认证界面，为了保证安全，通过<code>nginx</code>进行代理并设置访问认证。</p>\n</blockquote>\n<h2 id=\"配置kibana\"><a href=\"#配置kibana\" class=\"headerlink\" title=\"配置kibana\"></a>配置kibana</h2><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># vim /etc/kibana/kibana.yml</span></span><br><span class=\"line\"><span class=\"symbol\">server.host:</span> <span class=\"string\">\"127.0.0.1\"</span>    <span class=\"comment\">#将监听地址更改为127.0.0.1</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># systemctl restart kibana</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># netstat -nlutp |grep 5601</span></span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span><span class=\"symbol\">:</span><span class=\"number\">5601</span>          <span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span><span class=\"symbol\">:*</span>               LISTEN      <span class=\"number\">72068</span>/node</span><br></pre></td></tr></table></figure>\n<h2 id=\"部署nginx\"><a href=\"#部署nginx\" class=\"headerlink\" title=\"部署nginx\"></a>部署nginx</h2><p>1）安装<code>nginx</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># yum -y install nginx httpd-tools</span></span><br></pre></td></tr></table></figure></p>\n<p>2）配置<code>nginx</code><br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/nginx/conf.d/kibana.conf</span></span><br><span class=\"line\">upstream kibana_server &#123;</span><br><span class=\"line\">    server <span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span>:<span class=\"number\">5601</span> weight=<span class=\"number\">1</span> max_fails=<span class=\"number\">3</span> fail_timeout=<span class=\"number\">60</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    <span class=\"keyword\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    server_name www.kibana.com;</span><br><span class=\"line\">    auth_basic <span class=\"string\">\"Restricted Access\"</span>;</span><br><span class=\"line\">    auth_basic_user_file /etc/nginx/conf.d/htpasswd.users;</span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http:<span class=\"regexp\">//kibana</span>_server;</span><br><span class=\"line\">        proxy_http_version <span class=\"number\">1.1</span>;</span><br><span class=\"line\">        proxy_set_header Upgrade $http_upgrade;</span><br><span class=\"line\">        proxy_set_header Connection <span class=\"string\">'upgrade'</span>;</span><br><span class=\"line\">        proxy_set_header Host $host;</span><br><span class=\"line\">        proxy_cache_bypass $http_upgrade;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># htpasswd -bc /etc/nginx/conf.d/htpasswd.users admin 123456</span></span><br><span class=\"line\">Adding password <span class=\"keyword\">for</span> user admin</span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># cat /etc/nginx/conf.d/htpasswd.users</span></span><br><span class=\"line\">admin:$apr1$ro5tQZp9$grhByziZtm3ZpZCsSFzsQ1</span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># systemctl start nginx</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>windows</code>上添加<code>hosts</code>, 路径<code>C:\\Windows\\System32\\drivers\\etc\\hosts</code><br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.31</span>\t<span class=\"selector-tag\">www</span><span class=\"selector-class\">.kibana</span><span class=\"selector-class\">.com</span></span><br></pre></td></tr></table></figure></p>\n<p>4）测试验证<br><img src=\"/2019/07/05/ELK快速入门五-配置nginx代理kibana/nginx01.png\" alt=\"nginx01.png\"><br><img src=\"/2019/07/05/ELK快速入门五-配置nginx代理kibana/nginx02.png\" alt=\"nginx02.png\"></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>由于<code>kibana</code>界面默认没有安全认证界面，为了保证安全，通过<code>nginx</code>进行代理并设置访问认证。</p>\n</blockquote>\n<h2 id=\"配置kibana\"><a href=\"#配置kibana\" class=\"headerlink\" title=\"配置kibana\"></a>配置kibana</h2><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># vim /etc/kibana/kibana.yml</span></span><br><span class=\"line\"><span class=\"symbol\">server.host:</span> <span class=\"string\">\"127.0.0.1\"</span>    <span class=\"comment\">#将监听地址更改为127.0.0.1</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># systemctl restart kibana</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># netstat -nlutp |grep 5601</span></span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span><span class=\"symbol\">:</span><span class=\"number\">5601</span>          <span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span><span class=\"symbol\">:*</span>               LISTEN      <span class=\"number\">72068</span>/node</span><br></pre></td></tr></table></figure>\n<h2 id=\"部署nginx\"><a href=\"#部署nginx\" class=\"headerlink\" title=\"部署nginx\"></a>部署nginx</h2><p>1）安装<code>nginx</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># yum -y install nginx httpd-tools</span></span><br></pre></td></tr></table></figure></p>\n<p>2）配置<code>nginx</code><br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/nginx/conf.d/kibana.conf</span></span><br><span class=\"line\">upstream kibana_server &#123;</span><br><span class=\"line\">    server <span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span>:<span class=\"number\">5601</span> weight=<span class=\"number\">1</span> max_fails=<span class=\"number\">3</span> fail_timeout=<span class=\"number\">60</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    <span class=\"keyword\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    server_name www.kibana.com;</span><br><span class=\"line\">    auth_basic <span class=\"string\">\"Restricted Access\"</span>;</span><br><span class=\"line\">    auth_basic_user_file /etc/nginx/conf.d/htpasswd.users;</span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http:<span class=\"regexp\">//kibana</span>_server;</span><br><span class=\"line\">        proxy_http_version <span class=\"number\">1.1</span>;</span><br><span class=\"line\">        proxy_set_header Upgrade $http_upgrade;</span><br><span class=\"line\">        proxy_set_header Connection <span class=\"string\">'upgrade'</span>;</span><br><span class=\"line\">        proxy_set_header Host $host;</span><br><span class=\"line\">        proxy_cache_bypass $http_upgrade;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># htpasswd -bc /etc/nginx/conf.d/htpasswd.users admin 123456</span></span><br><span class=\"line\">Adding password <span class=\"keyword\">for</span> user admin</span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># cat /etc/nginx/conf.d/htpasswd.users</span></span><br><span class=\"line\">admin:$apr1$ro5tQZp9$grhByziZtm3ZpZCsSFzsQ1</span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># systemctl start nginx</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>windows</code>上添加<code>hosts</code>, 路径<code>C:\\Windows\\System32\\drivers\\etc\\hosts</code><br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.31</span>\t<span class=\"selector-tag\">www</span><span class=\"selector-class\">.kibana</span><span class=\"selector-class\">.com</span></span><br></pre></td></tr></table></figure></p>\n<p>4）测试验证<br><img src=\"/2019/07/05/ELK快速入门五-配置nginx代理kibana/nginx01.png\" alt=\"nginx01.png\"><br><img src=\"/2019/07/05/ELK快速入门五-配置nginx代理kibana/nginx02.png\" alt=\"nginx02.png\"></p>\n"},{"title":"ELK快速入门四-filebeat替代logstash收集日志","date":"2019-07-05T08:30:35.000Z","copyright":true,"_content":"## filebeat简介\n>`Filebeat`是轻量级单用途的日志收集工具，用于在没有安装java的服务器上专门收集日志，可以将日志转发到`logstash`、`elasticsearch`或`redis`等场景中进行下一步处理。\n>官网下载地址：https://www.elastic.co/cn/downloads/past-releases#filebeat\n>官方文档：https://www.elastic.co/guide/en/beats/filebeat/current/configuring-howto-filebeat.html\n\n\n## filebeat安装配置\n1）下载`filebeat`\n```\n# 这里是在logstash服务器上面做的，为了测试，所以先将logstash停止。\n[root@logstash ~]# systemctl stop logstash\n[root@logstash ~]# wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.8.1-x86_64.rpm\n```\n2）安装`filebeat`\n```\n[root@logstash ~]# yum -y localinstall filebeat-6.8.1-x86_64.rpm \n```\n\n\n### 配置filebeat收集系统日志输出到文件\n1）编辑`filebeat`配置文件\n```\n[root@logstash ~]# cp /etc/filebeat/filebeat.yml{,.bak}\n[root@logstash ~]# grep -v \"#\" /etc/filebeat/filebeat.yml |grep -v \"^$\"\nfilebeat.inputs:\n- type: log    # 默认值 log ，表示一个日志读取源\n  enabled: true    # 该配置是否生效，如果设置为 false 将不会收集该配置的日志\n  paths:\n    - /var/log/messages   # 要抓取的日志路径，写绝对路径,可以多个\n    - /var/log/*.log\nfilebeat.config.modules:\n  path: ${path.config}/modules.d/*.yml\n  reload.enabled: false\nsetup.template.settings:\n  index.number_of_shards: 3\nsetup.kibana:\noutput.file:\n  path: \"/tmp\"\n  filename: \"filebeat.txt\"\nprocessors:\n  - add_host_metadata: ~\n  - add_cloud_metadata: ~\n\n[root@logstash ~]# systemctl start filebeat\n```\n2）测试验证数据\n```\n[root@logstash ~]# echo \"test\" >> /var/log/messages\n\n[root@logstash ~]# tail /tmp/filebeat.txt \n{\"@timestamp\":\"2019-07-11T02:18:10.331Z\",\"@metadata\":{\"beat\":\"filebeat\",\"type\":\"doc\",\"version\":\"6.8.1\"},\"prospector\":{\"type\":\"log\"},\"input\":{\"type\":\"log\"},\"beat\":{\"name\":\"logstash\",\"hostname\":\"logstash\",\"version\":\"6.8.1\"},\"host\":{\"architecture\":\"x86_64\",\"os\":{\"platform\":\"centos\",\"version\":\"7 (Core)\",\"family\":\"redhat\",\"name\":\"CentOS Linux\",\"codename\":\"Core\"},\"id\":\"12bcfdc379904e4eb20173a568ecd7df\",\"containerized\":false,\"name\":\"logstash\"},\"source\":\"/var/log/messages\",\"offset\":53643,\"log\":{\"file\":{\"path\":\"/var/log/messages\"}},\"message\":\"Jul 11 10:18:10 node01 systemd: Stopping Filebeat sends log files to Logstash or directly to Elasticsearch....\"}\n{\"@timestamp\":\"2019-07-11T02:18:13.324Z\",\"@metadata\":{\"beat\":\"filebeat\",\"type\":\"doc\",\"version\":\"6.8.1\"},\"prospector\":{\"type\":\"log\"},\"beat\":{\"version\":\"6.8.1\",\"name\":\"logstash\",\"hostname\":\"logstash\"},\"host\":{\"name\":\"logstash\",\"architecture\":\"x86_64\",\"os\":{\"family\":\"redhat\",\"name\":\"CentOS Linux\",\"codename\":\"Core\",\"platform\":\"centos\",\"version\":\"7 (Core)\"},\"id\":\"12bcfdc379904e4eb20173a568ecd7df\",\"containerized\":false},\"log\":{\"file\":{\"path\":\"/var/log/messages\"}},\"message\":\"Jul 11 10:18:10 node01 systemd: Started Filebeat sends log files to Logstash or directly to Elasticsearch..\",\"source\":\"/var/log/messages\",\"offset\":53754,\"input\":{\"type\":\"log\"}}\n{\"@timestamp\":\"2019-07-11T02:18:13.324Z\",\"@metadata\":{\"beat\":\"filebeat\",\"type\":\"doc\",\"version\":\"6.8.1\"},\"host\":{\"architecture\":\"x86_64\",\"name\":\"logstash\",\"os\":{\"codename\":\"Core\",\"platform\":\"centos\",\"version\":\"7 (Core)\",\"family\":\"redhat\",\"name\":\"CentOS Linux\"},\"id\":\"12bcfdc379904e4eb20173a568ecd7df\",\"containerized\":false},\"source\":\"/var/log/messages\",\"offset\":53862,\"log\":{\"file\":{\"path\":\"/var/log/messages\"}},\"message\":\"Jul 11 10:18:10 node01 systemd: Starting Filebeat sends log files to Logstash or directly to Elasticsearch....\",\"prospector\":{\"type\":\"log\"},\"input\":{\"type\":\"log\"},\"beat\":{\"name\":\"logstash\",\"hostname\":\"logstash\",\"version\":\"6.8.1\"}}\n{\"@timestamp\":\"2019-07-11T02:18:48.328Z\",\"@metadata\":{\"beat\":\"filebeat\",\"type\":\"doc\",\"version\":\"6.8.1\"},\"offset\":53973,\"log\":{\"file\":{\"path\":\"/var/log/messages\"}},\"message\":\"test\",\"input\":{\"type\":\"log\"},\"prospector\":{\"type\":\"log\"},\"beat\":{\"name\":\"logstash\",\"hostname\":\"logstash\",\"version\":\"6.8.1\"},\"host\":{\"name\":\"logstash\",\"os\":{\"version\":\"7 (Core)\",\"family\":\"redhat\",\"name\":\"CentOS Linux\",\"codename\":\"Core\",\"platform\":\"centos\"},\"id\":\"12bcfdc379904e4eb20173a568ecd7df\",\"containerized\":false,\"architecture\":\"x86_64\"},\"source\":\"/var/log/messages\"}\n```\n\n\n\n\n\n### 配置filebeat收集系统日志输出redis\n1）编辑`filebeat`配置文件，修改输出\n```\n[root@logstash ~]# grep -v \"#\" /etc/filebeat/filebeat.yml |grep -v \"^$\"\nfilebeat.inputs:\n- type: log\n  enabled: true\n  paths:\n    - /var/log/messages\n    - /var/log/*.log\nfilebeat.config.modules:\n  path: ${path.config}/modules.d/*.yml\n  reload.enabled: false\nsetup.template.settings:\n  index.number_of_shards: 3\nsetup.kibana:\noutput.redis:\n  hosts: [\"192.168.1.30:6379\"]    #redis服务器及端口\n  key: \"system-log-33\"    #这里自定义key的名称，为了后期处理\n  db: 1    #使用第几个库\n  timeout: 5    #超时时间\n  password: 123321    #redis 密码\nprocessors:\n  - add_host_metadata: ~\n  - add_cloud_metadata: ~\n\n[root@logstash ~]# systemctl restart filebeat\n```\n2）验证`redis`中是否有数据\n```\n[root@linux-redis ~]# redis-cli -h 192.168.1.30\n192.168.1.30:6379> AUTH 123321\nOK\n192.168.1.30:6379> SELECT 1\nOK\n192.168.1.30:6379[1]> KEYS *\n1) \"system-log-33\"\n192.168.1.30:6379[1]> LLEN system-log-33\n(integer) 3\n```\n3）`logstash`服务器上面配置从`redis`服务器中取数据\n```\n[root@linux-elk1 ~]# cat /etc/logstash/conf.d/redis-filebeat.conf \ninput {\n    redis {\n        data_type => \"list\"\n        host => \"192.168.1.30\"\n        password => \"123321\"\n        port => \"6379\"\n        db => \"1\"\n        key => \"system-log-33\"\n    }\n}\n\noutput {\n    elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]\n        index => \"file-systemlog-%{+YYYY.MM.dd}\"\n    }\n}\n\n[root@linux-elk1 ~]# systemctl restart logstash\n```\n4）输入测试数据到日志文件里\n```\n[root@logstash ~]# echo \"11111111111111\" >> /var/log/messages\n[root@logstash ~]# echo \"2222222222\" >> /var/log/messages\n[root@logstash ~]# echo \"33333333\" >> /var/log/messages\n```\n5）`kibana`界面创建索引模式\n![](ELK快速入门四-filebeat替代logstash收集日志/file01.png)\n![file02.png](ELK快速入门四-filebeat替代logstash收集日志/file02.png)\n6）验证数据\n![file03.png](ELK快速入门四-filebeat替代logstash收集日志/file03.png)\n\n\n\n\n\n\n\n\n","source":"_posts/ELK快速入门四-filebeat替代logstash收集日志.md","raw":"---\ntitle: ELK快速入门四-filebeat替代logstash收集日志\ndate: 2019-07-05 16:30:35\ntags: ELK\ncategories: ELK\ncopyright: true\n---\n## filebeat简介\n>`Filebeat`是轻量级单用途的日志收集工具，用于在没有安装java的服务器上专门收集日志，可以将日志转发到`logstash`、`elasticsearch`或`redis`等场景中进行下一步处理。\n>官网下载地址：https://www.elastic.co/cn/downloads/past-releases#filebeat\n>官方文档：https://www.elastic.co/guide/en/beats/filebeat/current/configuring-howto-filebeat.html\n\n\n## filebeat安装配置\n1）下载`filebeat`\n```\n# 这里是在logstash服务器上面做的，为了测试，所以先将logstash停止。\n[root@logstash ~]# systemctl stop logstash\n[root@logstash ~]# wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.8.1-x86_64.rpm\n```\n2）安装`filebeat`\n```\n[root@logstash ~]# yum -y localinstall filebeat-6.8.1-x86_64.rpm \n```\n\n\n### 配置filebeat收集系统日志输出到文件\n1）编辑`filebeat`配置文件\n```\n[root@logstash ~]# cp /etc/filebeat/filebeat.yml{,.bak}\n[root@logstash ~]# grep -v \"#\" /etc/filebeat/filebeat.yml |grep -v \"^$\"\nfilebeat.inputs:\n- type: log    # 默认值 log ，表示一个日志读取源\n  enabled: true    # 该配置是否生效，如果设置为 false 将不会收集该配置的日志\n  paths:\n    - /var/log/messages   # 要抓取的日志路径，写绝对路径,可以多个\n    - /var/log/*.log\nfilebeat.config.modules:\n  path: ${path.config}/modules.d/*.yml\n  reload.enabled: false\nsetup.template.settings:\n  index.number_of_shards: 3\nsetup.kibana:\noutput.file:\n  path: \"/tmp\"\n  filename: \"filebeat.txt\"\nprocessors:\n  - add_host_metadata: ~\n  - add_cloud_metadata: ~\n\n[root@logstash ~]# systemctl start filebeat\n```\n2）测试验证数据\n```\n[root@logstash ~]# echo \"test\" >> /var/log/messages\n\n[root@logstash ~]# tail /tmp/filebeat.txt \n{\"@timestamp\":\"2019-07-11T02:18:10.331Z\",\"@metadata\":{\"beat\":\"filebeat\",\"type\":\"doc\",\"version\":\"6.8.1\"},\"prospector\":{\"type\":\"log\"},\"input\":{\"type\":\"log\"},\"beat\":{\"name\":\"logstash\",\"hostname\":\"logstash\",\"version\":\"6.8.1\"},\"host\":{\"architecture\":\"x86_64\",\"os\":{\"platform\":\"centos\",\"version\":\"7 (Core)\",\"family\":\"redhat\",\"name\":\"CentOS Linux\",\"codename\":\"Core\"},\"id\":\"12bcfdc379904e4eb20173a568ecd7df\",\"containerized\":false,\"name\":\"logstash\"},\"source\":\"/var/log/messages\",\"offset\":53643,\"log\":{\"file\":{\"path\":\"/var/log/messages\"}},\"message\":\"Jul 11 10:18:10 node01 systemd: Stopping Filebeat sends log files to Logstash or directly to Elasticsearch....\"}\n{\"@timestamp\":\"2019-07-11T02:18:13.324Z\",\"@metadata\":{\"beat\":\"filebeat\",\"type\":\"doc\",\"version\":\"6.8.1\"},\"prospector\":{\"type\":\"log\"},\"beat\":{\"version\":\"6.8.1\",\"name\":\"logstash\",\"hostname\":\"logstash\"},\"host\":{\"name\":\"logstash\",\"architecture\":\"x86_64\",\"os\":{\"family\":\"redhat\",\"name\":\"CentOS Linux\",\"codename\":\"Core\",\"platform\":\"centos\",\"version\":\"7 (Core)\"},\"id\":\"12bcfdc379904e4eb20173a568ecd7df\",\"containerized\":false},\"log\":{\"file\":{\"path\":\"/var/log/messages\"}},\"message\":\"Jul 11 10:18:10 node01 systemd: Started Filebeat sends log files to Logstash or directly to Elasticsearch..\",\"source\":\"/var/log/messages\",\"offset\":53754,\"input\":{\"type\":\"log\"}}\n{\"@timestamp\":\"2019-07-11T02:18:13.324Z\",\"@metadata\":{\"beat\":\"filebeat\",\"type\":\"doc\",\"version\":\"6.8.1\"},\"host\":{\"architecture\":\"x86_64\",\"name\":\"logstash\",\"os\":{\"codename\":\"Core\",\"platform\":\"centos\",\"version\":\"7 (Core)\",\"family\":\"redhat\",\"name\":\"CentOS Linux\"},\"id\":\"12bcfdc379904e4eb20173a568ecd7df\",\"containerized\":false},\"source\":\"/var/log/messages\",\"offset\":53862,\"log\":{\"file\":{\"path\":\"/var/log/messages\"}},\"message\":\"Jul 11 10:18:10 node01 systemd: Starting Filebeat sends log files to Logstash or directly to Elasticsearch....\",\"prospector\":{\"type\":\"log\"},\"input\":{\"type\":\"log\"},\"beat\":{\"name\":\"logstash\",\"hostname\":\"logstash\",\"version\":\"6.8.1\"}}\n{\"@timestamp\":\"2019-07-11T02:18:48.328Z\",\"@metadata\":{\"beat\":\"filebeat\",\"type\":\"doc\",\"version\":\"6.8.1\"},\"offset\":53973,\"log\":{\"file\":{\"path\":\"/var/log/messages\"}},\"message\":\"test\",\"input\":{\"type\":\"log\"},\"prospector\":{\"type\":\"log\"},\"beat\":{\"name\":\"logstash\",\"hostname\":\"logstash\",\"version\":\"6.8.1\"},\"host\":{\"name\":\"logstash\",\"os\":{\"version\":\"7 (Core)\",\"family\":\"redhat\",\"name\":\"CentOS Linux\",\"codename\":\"Core\",\"platform\":\"centos\"},\"id\":\"12bcfdc379904e4eb20173a568ecd7df\",\"containerized\":false,\"architecture\":\"x86_64\"},\"source\":\"/var/log/messages\"}\n```\n\n\n\n\n\n### 配置filebeat收集系统日志输出redis\n1）编辑`filebeat`配置文件，修改输出\n```\n[root@logstash ~]# grep -v \"#\" /etc/filebeat/filebeat.yml |grep -v \"^$\"\nfilebeat.inputs:\n- type: log\n  enabled: true\n  paths:\n    - /var/log/messages\n    - /var/log/*.log\nfilebeat.config.modules:\n  path: ${path.config}/modules.d/*.yml\n  reload.enabled: false\nsetup.template.settings:\n  index.number_of_shards: 3\nsetup.kibana:\noutput.redis:\n  hosts: [\"192.168.1.30:6379\"]    #redis服务器及端口\n  key: \"system-log-33\"    #这里自定义key的名称，为了后期处理\n  db: 1    #使用第几个库\n  timeout: 5    #超时时间\n  password: 123321    #redis 密码\nprocessors:\n  - add_host_metadata: ~\n  - add_cloud_metadata: ~\n\n[root@logstash ~]# systemctl restart filebeat\n```\n2）验证`redis`中是否有数据\n```\n[root@linux-redis ~]# redis-cli -h 192.168.1.30\n192.168.1.30:6379> AUTH 123321\nOK\n192.168.1.30:6379> SELECT 1\nOK\n192.168.1.30:6379[1]> KEYS *\n1) \"system-log-33\"\n192.168.1.30:6379[1]> LLEN system-log-33\n(integer) 3\n```\n3）`logstash`服务器上面配置从`redis`服务器中取数据\n```\n[root@linux-elk1 ~]# cat /etc/logstash/conf.d/redis-filebeat.conf \ninput {\n    redis {\n        data_type => \"list\"\n        host => \"192.168.1.30\"\n        password => \"123321\"\n        port => \"6379\"\n        db => \"1\"\n        key => \"system-log-33\"\n    }\n}\n\noutput {\n    elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]\n        index => \"file-systemlog-%{+YYYY.MM.dd}\"\n    }\n}\n\n[root@linux-elk1 ~]# systemctl restart logstash\n```\n4）输入测试数据到日志文件里\n```\n[root@logstash ~]# echo \"11111111111111\" >> /var/log/messages\n[root@logstash ~]# echo \"2222222222\" >> /var/log/messages\n[root@logstash ~]# echo \"33333333\" >> /var/log/messages\n```\n5）`kibana`界面创建索引模式\n![](ELK快速入门四-filebeat替代logstash收集日志/file01.png)\n![file02.png](ELK快速入门四-filebeat替代logstash收集日志/file02.png)\n6）验证数据\n![file03.png](ELK快速入门四-filebeat替代logstash收集日志/file03.png)\n\n\n\n\n\n\n\n\n","slug":"ELK快速入门四-filebeat替代logstash收集日志","published":1,"updated":"2019-10-24T09:12:16.885Z","_id":"cjz3xyigm0001dstca0f16i35","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"filebeat简介\"><a href=\"#filebeat简介\" class=\"headerlink\" title=\"filebeat简介\"></a>filebeat简介</h2><blockquote>\n<p><code>Filebeat</code>是轻量级单用途的日志收集工具，用于在没有安装java的服务器上专门收集日志，可以将日志转发到<code>logstash</code>、<code>elasticsearch</code>或<code>redis</code>等场景中进行下一步处理。<br>官网下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#filebeat\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/cn/downloads/past-releases#filebeat</a><br>官方文档：<a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/configuring-howto-filebeat.html\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/guide/en/beats/filebeat/current/configuring-howto-filebeat.html</a></p>\n</blockquote>\n<h2 id=\"filebeat安装配置\"><a href=\"#filebeat安装配置\" class=\"headerlink\" title=\"filebeat安装配置\"></a>filebeat安装配置</h2><p>1）下载<code>filebeat</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 这里是在logstash服务器上面做的，为了测试，所以先将logstash停止。</span></span><br><span class=\"line\">[root<span class=\"symbol\">@logstash</span> ~]<span class=\"meta\"># systemctl stop logstash</span></span><br><span class=\"line\">[root<span class=\"symbol\">@logstash</span> ~]<span class=\"meta\"># wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.8.1-x86_64.rpm</span></span><br></pre></td></tr></table></figure></p>\n<p>2）安装<code>filebeat</code><br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@logstash ~]</span># <span class=\"selector-tag\">yum</span> <span class=\"selector-tag\">-y</span> <span class=\"selector-tag\">localinstall</span> <span class=\"selector-tag\">filebeat-6</span><span class=\"selector-class\">.8</span><span class=\"selector-class\">.1-x86_64</span><span class=\"selector-class\">.rpm</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"配置filebeat收集系统日志输出到文件\"><a href=\"#配置filebeat收集系统日志输出到文件\" class=\"headerlink\" title=\"配置filebeat收集系统日志输出到文件\"></a>配置filebeat收集系统日志输出到文件</h3><p>1）编辑<code>filebeat</code>配置文件<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">cp</span> /etc/filebeat/filebeat.yml&#123;,.bak&#125;</span><br><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">grep</span> -v <span class=\"string\">\"#\"</span> /etc/filebeat/filebeat.yml |<span class=\"keyword\">grep</span> -v <span class=\"string\">\"^$\"</span></span><br><span class=\"line\">filebeat.<span class=\"built_in\">input</span><span class=\"variable\">s:</span></span><br><span class=\"line\">- <span class=\"built_in\">type</span>: <span class=\"built_in\">log</span>    # 默认值 <span class=\"built_in\">log</span> ，表示一个日志读取源</span><br><span class=\"line\">  enabled: true    # 该配置是否生效，如果设置为 false 将不会收集该配置的日志</span><br><span class=\"line\">  path<span class=\"variable\">s:</span></span><br><span class=\"line\">    - /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span>   # 要抓取的日志路径，写绝对路径,可以多个</span><br><span class=\"line\">    - /var/<span class=\"built_in\">log</span>/*.<span class=\"built_in\">log</span></span><br><span class=\"line\">filebeat.config.module<span class=\"variable\">s:</span></span><br><span class=\"line\">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class=\"line\">  reload.enabled: false</span><br><span class=\"line\">setup.template.setting<span class=\"variable\">s:</span></span><br><span class=\"line\">  <span class=\"built_in\">index</span>.number_of_shard<span class=\"variable\">s:</span> <span class=\"number\">3</span></span><br><span class=\"line\">setup.kiban<span class=\"variable\">a:</span></span><br><span class=\"line\">output.<span class=\"keyword\">file</span>:</span><br><span class=\"line\">  path: <span class=\"string\">\"/tmp\"</span></span><br><span class=\"line\">  filename: <span class=\"string\">\"filebeat.txt\"</span></span><br><span class=\"line\">processor<span class=\"variable\">s:</span></span><br><span class=\"line\">  - add_host_metadat<span class=\"variable\">a:</span> ~</span><br><span class=\"line\">  - add_cloud_metadat<span class=\"variable\">a:</span> ~</span><br><span class=\"line\"></span><br><span class=\"line\">[root@logstash ~]# systemctl start filebeat</span><br></pre></td></tr></table></figure></p>\n<p>2）测试验证数据<br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@logstash ~]<span class=\"comment\"># echo \"test\" &gt;&gt; /var/log/messages</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@logstash ~]<span class=\"comment\"># tail /tmp/filebeat.txt </span></span><br><span class=\"line\">&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"2019-07-11T02:18:10.331Z\"</span>,<span class=\"string\">\"@metadata\"</span>:&#123;<span class=\"string\">\"beat\"</span>:<span class=\"string\">\"filebeat\"</span>,<span class=\"string\">\"type\"</span>:<span class=\"string\">\"doc\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"prospector\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"input\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"beat\"</span>:&#123;<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"hostname\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"host\"</span>:&#123;<span class=\"string\">\"architecture\"</span>:<span class=\"string\">\"x86_64\"</span>,<span class=\"string\">\"os\"</span>:&#123;<span class=\"string\">\"platform\"</span>:<span class=\"string\">\"centos\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"7 (Core)\"</span>,<span class=\"string\">\"family\"</span>:<span class=\"string\">\"redhat\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"CentOS Linux\"</span>,<span class=\"string\">\"codename\"</span>:<span class=\"string\">\"Core\"</span>&#125;,<span class=\"string\">\"id\"</span>:<span class=\"string\">\"12bcfdc379904e4eb20173a568ecd7df\"</span>,<span class=\"string\">\"containerized\"</span>:false,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>&#125;,<span class=\"string\">\"source\"</span>:<span class=\"string\">\"/var/log/messages\"</span>,<span class=\"string\">\"offset\"</span>:<span class=\"number\">53643</span>,<span class=\"string\">\"log\"</span>:&#123;<span class=\"string\">\"file\"</span>:&#123;<span class=\"string\">\"path\"</span>:<span class=\"string\">\"/var/log/messages\"</span>&#125;&#125;,<span class=\"string\">\"message\"</span>:<span class=\"string\">\"Jul 11 10:18:10 node01 systemd: Stopping Filebeat sends log files to Logstash or directly to Elasticsearch....\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"2019-07-11T02:18:13.324Z\"</span>,<span class=\"string\">\"@metadata\"</span>:&#123;<span class=\"string\">\"beat\"</span>:<span class=\"string\">\"filebeat\"</span>,<span class=\"string\">\"type\"</span>:<span class=\"string\">\"doc\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"prospector\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"beat\"</span>:&#123;<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"hostname\"</span>:<span class=\"string\">\"logstash\"</span>&#125;,<span class=\"string\">\"host\"</span>:&#123;<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"architecture\"</span>:<span class=\"string\">\"x86_64\"</span>,<span class=\"string\">\"os\"</span>:&#123;<span class=\"string\">\"family\"</span>:<span class=\"string\">\"redhat\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"CentOS Linux\"</span>,<span class=\"string\">\"codename\"</span>:<span class=\"string\">\"Core\"</span>,<span class=\"string\">\"platform\"</span>:<span class=\"string\">\"centos\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"7 (Core)\"</span>&#125;,<span class=\"string\">\"id\"</span>:<span class=\"string\">\"12bcfdc379904e4eb20173a568ecd7df\"</span>,<span class=\"string\">\"containerized\"</span>:false&#125;,<span class=\"string\">\"log\"</span>:&#123;<span class=\"string\">\"file\"</span>:&#123;<span class=\"string\">\"path\"</span>:<span class=\"string\">\"/var/log/messages\"</span>&#125;&#125;,<span class=\"string\">\"message\"</span>:<span class=\"string\">\"Jul 11 10:18:10 node01 systemd: Started Filebeat sends log files to Logstash or directly to Elasticsearch..\"</span>,<span class=\"string\">\"source\"</span>:<span class=\"string\">\"/var/log/messages\"</span>,<span class=\"string\">\"offset\"</span>:<span class=\"number\">53754</span>,<span class=\"string\">\"input\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"2019-07-11T02:18:13.324Z\"</span>,<span class=\"string\">\"@metadata\"</span>:&#123;<span class=\"string\">\"beat\"</span>:<span class=\"string\">\"filebeat\"</span>,<span class=\"string\">\"type\"</span>:<span class=\"string\">\"doc\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"host\"</span>:&#123;<span class=\"string\">\"architecture\"</span>:<span class=\"string\">\"x86_64\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"os\"</span>:&#123;<span class=\"string\">\"codename\"</span>:<span class=\"string\">\"Core\"</span>,<span class=\"string\">\"platform\"</span>:<span class=\"string\">\"centos\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"7 (Core)\"</span>,<span class=\"string\">\"family\"</span>:<span class=\"string\">\"redhat\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"CentOS Linux\"</span>&#125;,<span class=\"string\">\"id\"</span>:<span class=\"string\">\"12bcfdc379904e4eb20173a568ecd7df\"</span>,<span class=\"string\">\"containerized\"</span>:false&#125;,<span class=\"string\">\"source\"</span>:<span class=\"string\">\"/var/log/messages\"</span>,<span class=\"string\">\"offset\"</span>:<span class=\"number\">53862</span>,<span class=\"string\">\"log\"</span>:&#123;<span class=\"string\">\"file\"</span>:&#123;<span class=\"string\">\"path\"</span>:<span class=\"string\">\"/var/log/messages\"</span>&#125;&#125;,<span class=\"string\">\"message\"</span>:<span class=\"string\">\"Jul 11 10:18:10 node01 systemd: Starting Filebeat sends log files to Logstash or directly to Elasticsearch....\"</span>,<span class=\"string\">\"prospector\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"input\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"beat\"</span>:&#123;<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"hostname\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"2019-07-11T02:18:48.328Z\"</span>,<span class=\"string\">\"@metadata\"</span>:&#123;<span class=\"string\">\"beat\"</span>:<span class=\"string\">\"filebeat\"</span>,<span class=\"string\">\"type\"</span>:<span class=\"string\">\"doc\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"offset\"</span>:<span class=\"number\">53973</span>,<span class=\"string\">\"log\"</span>:&#123;<span class=\"string\">\"file\"</span>:&#123;<span class=\"string\">\"path\"</span>:<span class=\"string\">\"/var/log/messages\"</span>&#125;&#125;,<span class=\"string\">\"message\"</span>:<span class=\"string\">\"test\"</span>,<span class=\"string\">\"input\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"prospector\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"beat\"</span>:&#123;<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"hostname\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"host\"</span>:&#123;<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"os\"</span>:&#123;<span class=\"string\">\"version\"</span>:<span class=\"string\">\"7 (Core)\"</span>,<span class=\"string\">\"family\"</span>:<span class=\"string\">\"redhat\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"CentOS Linux\"</span>,<span class=\"string\">\"codename\"</span>:<span class=\"string\">\"Core\"</span>,<span class=\"string\">\"platform\"</span>:<span class=\"string\">\"centos\"</span>&#125;,<span class=\"string\">\"id\"</span>:<span class=\"string\">\"12bcfdc379904e4eb20173a568ecd7df\"</span>,<span class=\"string\">\"containerized\"</span>:false,<span class=\"string\">\"architecture\"</span>:<span class=\"string\">\"x86_64\"</span>&#125;,<span class=\"string\">\"source\"</span>:<span class=\"string\">\"/var/log/messages\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"配置filebeat收集系统日志输出redis\"><a href=\"#配置filebeat收集系统日志输出redis\" class=\"headerlink\" title=\"配置filebeat收集系统日志输出redis\"></a>配置filebeat收集系统日志输出redis</h3><p>1）编辑<code>filebeat</code>配置文件，修改输出<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">grep</span> -v <span class=\"string\">\"#\"</span> /etc/filebeat/filebeat.yml |<span class=\"keyword\">grep</span> -v <span class=\"string\">\"^$\"</span></span><br><span class=\"line\">filebeat.<span class=\"built_in\">input</span><span class=\"variable\">s:</span></span><br><span class=\"line\">- <span class=\"built_in\">type</span>: <span class=\"built_in\">log</span></span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  path<span class=\"variable\">s:</span></span><br><span class=\"line\">    - /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br><span class=\"line\">    - /var/<span class=\"built_in\">log</span>/*.<span class=\"built_in\">log</span></span><br><span class=\"line\">filebeat.config.module<span class=\"variable\">s:</span></span><br><span class=\"line\">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class=\"line\">  reload.enabled: false</span><br><span class=\"line\">setup.template.setting<span class=\"variable\">s:</span></span><br><span class=\"line\">  <span class=\"built_in\">index</span>.number_of_shard<span class=\"variable\">s:</span> <span class=\"number\">3</span></span><br><span class=\"line\">setup.kiban<span class=\"variable\">a:</span></span><br><span class=\"line\">output.<span class=\"keyword\">redi</span><span class=\"variable\">s:</span></span><br><span class=\"line\">  host<span class=\"variable\">s:</span> [<span class=\"string\">\"192.168.1.30:6379\"</span>]    #redis服务器及端口</span><br><span class=\"line\">  key: <span class=\"string\">\"system-log-33\"</span>    #这里自定义key的名称，为了后期处理</span><br><span class=\"line\">  d<span class=\"variable\">b:</span> <span class=\"number\">1</span>    #使用第几个库</span><br><span class=\"line\">  timeou<span class=\"variable\">t:</span> <span class=\"number\">5</span>    #超时时间</span><br><span class=\"line\">  password: <span class=\"number\">123321</span>    #redis 密码</span><br><span class=\"line\">processor<span class=\"variable\">s:</span></span><br><span class=\"line\">  - add_host_metadat<span class=\"variable\">a:</span> ~</span><br><span class=\"line\">  - add_cloud_metadat<span class=\"variable\">a:</span> ~</span><br><span class=\"line\"></span><br><span class=\"line\">[root@logstash ~]# systemctl restart filebeat</span><br></pre></td></tr></table></figure></p>\n<p>2）验证<code>redis</code>中是否有数据<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@linux-redis ~]</span># <span class=\"selector-tag\">redis-cli</span> <span class=\"selector-tag\">-h</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">AUTH</span> 123321</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">SELECT</span> 1</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span><span class=\"selector-attr\">[1]</span>&gt; <span class=\"selector-tag\">KEYS</span> *</span><br><span class=\"line\">1) \"<span class=\"selector-tag\">system-log-33</span>\"</span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span><span class=\"selector-attr\">[1]</span>&gt; <span class=\"selector-tag\">LLEN</span> <span class=\"selector-tag\">system-log-33</span></span><br><span class=\"line\">(<span class=\"selector-tag\">integer</span>) 3</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>logstash</code>服务器上面配置从<code>redis</code>服务器中取数据<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># cat /etc/logstash/conf.d/redis-filebeat.conf </span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    redis &#123;</span><br><span class=\"line\">        <span class=\"attr\">data_type</span> =&gt; <span class=\"string\">\"list\"</span></span><br><span class=\"line\">        <span class=\"attr\">host</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span></span><br><span class=\"line\">        <span class=\"attr\">password</span> =&gt; <span class=\"string\">\"123321\"</span></span><br><span class=\"line\">        <span class=\"attr\">port</span> =&gt; <span class=\"string\">\"6379\"</span></span><br><span class=\"line\">        <span class=\"attr\">db</span> =&gt; <span class=\"string\">\"1\"</span></span><br><span class=\"line\">        <span class=\"attr\">key</span> =&gt; <span class=\"string\">\"system-log-33\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"file-systemlog-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p>\n<p>4）输入测试数据到日志文件里<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"11111111111111\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"2222222222\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"33333333\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br></pre></td></tr></table></figure></p>\n<p>5）<code>kibana</code>界面创建索引模式<br><img src=\"/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file01.png\" alt><br><img src=\"/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file02.png\" alt=\"file02.png\"><br>6）验证数据<br><img src=\"/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file03.png\" alt=\"file03.png\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"filebeat简介\"><a href=\"#filebeat简介\" class=\"headerlink\" title=\"filebeat简介\"></a>filebeat简介</h2><blockquote>\n<p><code>Filebeat</code>是轻量级单用途的日志收集工具，用于在没有安装java的服务器上专门收集日志，可以将日志转发到<code>logstash</code>、<code>elasticsearch</code>或<code>redis</code>等场景中进行下一步处理。<br>官网下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#filebeat\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/cn/downloads/past-releases#filebeat</a><br>官方文档：<a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/configuring-howto-filebeat.html\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/guide/en/beats/filebeat/current/configuring-howto-filebeat.html</a></p>\n</blockquote>\n<h2 id=\"filebeat安装配置\"><a href=\"#filebeat安装配置\" class=\"headerlink\" title=\"filebeat安装配置\"></a>filebeat安装配置</h2><p>1）下载<code>filebeat</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 这里是在logstash服务器上面做的，为了测试，所以先将logstash停止。</span></span><br><span class=\"line\">[root<span class=\"symbol\">@logstash</span> ~]<span class=\"meta\"># systemctl stop logstash</span></span><br><span class=\"line\">[root<span class=\"symbol\">@logstash</span> ~]<span class=\"meta\"># wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.8.1-x86_64.rpm</span></span><br></pre></td></tr></table></figure></p>\n<p>2）安装<code>filebeat</code><br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@logstash ~]</span># <span class=\"selector-tag\">yum</span> <span class=\"selector-tag\">-y</span> <span class=\"selector-tag\">localinstall</span> <span class=\"selector-tag\">filebeat-6</span><span class=\"selector-class\">.8</span><span class=\"selector-class\">.1-x86_64</span><span class=\"selector-class\">.rpm</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"配置filebeat收集系统日志输出到文件\"><a href=\"#配置filebeat收集系统日志输出到文件\" class=\"headerlink\" title=\"配置filebeat收集系统日志输出到文件\"></a>配置filebeat收集系统日志输出到文件</h3><p>1）编辑<code>filebeat</code>配置文件<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">cp</span> /etc/filebeat/filebeat.yml&#123;,.bak&#125;</span><br><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">grep</span> -v <span class=\"string\">\"#\"</span> /etc/filebeat/filebeat.yml |<span class=\"keyword\">grep</span> -v <span class=\"string\">\"^$\"</span></span><br><span class=\"line\">filebeat.<span class=\"built_in\">input</span><span class=\"variable\">s:</span></span><br><span class=\"line\">- <span class=\"built_in\">type</span>: <span class=\"built_in\">log</span>    # 默认值 <span class=\"built_in\">log</span> ，表示一个日志读取源</span><br><span class=\"line\">  enabled: true    # 该配置是否生效，如果设置为 false 将不会收集该配置的日志</span><br><span class=\"line\">  path<span class=\"variable\">s:</span></span><br><span class=\"line\">    - /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span>   # 要抓取的日志路径，写绝对路径,可以多个</span><br><span class=\"line\">    - /var/<span class=\"built_in\">log</span>/*.<span class=\"built_in\">log</span></span><br><span class=\"line\">filebeat.config.module<span class=\"variable\">s:</span></span><br><span class=\"line\">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class=\"line\">  reload.enabled: false</span><br><span class=\"line\">setup.template.setting<span class=\"variable\">s:</span></span><br><span class=\"line\">  <span class=\"built_in\">index</span>.number_of_shard<span class=\"variable\">s:</span> <span class=\"number\">3</span></span><br><span class=\"line\">setup.kiban<span class=\"variable\">a:</span></span><br><span class=\"line\">output.<span class=\"keyword\">file</span>:</span><br><span class=\"line\">  path: <span class=\"string\">\"/tmp\"</span></span><br><span class=\"line\">  filename: <span class=\"string\">\"filebeat.txt\"</span></span><br><span class=\"line\">processor<span class=\"variable\">s:</span></span><br><span class=\"line\">  - add_host_metadat<span class=\"variable\">a:</span> ~</span><br><span class=\"line\">  - add_cloud_metadat<span class=\"variable\">a:</span> ~</span><br><span class=\"line\"></span><br><span class=\"line\">[root@logstash ~]# systemctl start filebeat</span><br></pre></td></tr></table></figure></p>\n<p>2）测试验证数据<br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@logstash ~]<span class=\"comment\"># echo \"test\" &gt;&gt; /var/log/messages</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@logstash ~]<span class=\"comment\"># tail /tmp/filebeat.txt </span></span><br><span class=\"line\">&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"2019-07-11T02:18:10.331Z\"</span>,<span class=\"string\">\"@metadata\"</span>:&#123;<span class=\"string\">\"beat\"</span>:<span class=\"string\">\"filebeat\"</span>,<span class=\"string\">\"type\"</span>:<span class=\"string\">\"doc\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"prospector\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"input\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"beat\"</span>:&#123;<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"hostname\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"host\"</span>:&#123;<span class=\"string\">\"architecture\"</span>:<span class=\"string\">\"x86_64\"</span>,<span class=\"string\">\"os\"</span>:&#123;<span class=\"string\">\"platform\"</span>:<span class=\"string\">\"centos\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"7 (Core)\"</span>,<span class=\"string\">\"family\"</span>:<span class=\"string\">\"redhat\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"CentOS Linux\"</span>,<span class=\"string\">\"codename\"</span>:<span class=\"string\">\"Core\"</span>&#125;,<span class=\"string\">\"id\"</span>:<span class=\"string\">\"12bcfdc379904e4eb20173a568ecd7df\"</span>,<span class=\"string\">\"containerized\"</span>:false,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>&#125;,<span class=\"string\">\"source\"</span>:<span class=\"string\">\"/var/log/messages\"</span>,<span class=\"string\">\"offset\"</span>:<span class=\"number\">53643</span>,<span class=\"string\">\"log\"</span>:&#123;<span class=\"string\">\"file\"</span>:&#123;<span class=\"string\">\"path\"</span>:<span class=\"string\">\"/var/log/messages\"</span>&#125;&#125;,<span class=\"string\">\"message\"</span>:<span class=\"string\">\"Jul 11 10:18:10 node01 systemd: Stopping Filebeat sends log files to Logstash or directly to Elasticsearch....\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"2019-07-11T02:18:13.324Z\"</span>,<span class=\"string\">\"@metadata\"</span>:&#123;<span class=\"string\">\"beat\"</span>:<span class=\"string\">\"filebeat\"</span>,<span class=\"string\">\"type\"</span>:<span class=\"string\">\"doc\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"prospector\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"beat\"</span>:&#123;<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"hostname\"</span>:<span class=\"string\">\"logstash\"</span>&#125;,<span class=\"string\">\"host\"</span>:&#123;<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"architecture\"</span>:<span class=\"string\">\"x86_64\"</span>,<span class=\"string\">\"os\"</span>:&#123;<span class=\"string\">\"family\"</span>:<span class=\"string\">\"redhat\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"CentOS Linux\"</span>,<span class=\"string\">\"codename\"</span>:<span class=\"string\">\"Core\"</span>,<span class=\"string\">\"platform\"</span>:<span class=\"string\">\"centos\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"7 (Core)\"</span>&#125;,<span class=\"string\">\"id\"</span>:<span class=\"string\">\"12bcfdc379904e4eb20173a568ecd7df\"</span>,<span class=\"string\">\"containerized\"</span>:false&#125;,<span class=\"string\">\"log\"</span>:&#123;<span class=\"string\">\"file\"</span>:&#123;<span class=\"string\">\"path\"</span>:<span class=\"string\">\"/var/log/messages\"</span>&#125;&#125;,<span class=\"string\">\"message\"</span>:<span class=\"string\">\"Jul 11 10:18:10 node01 systemd: Started Filebeat sends log files to Logstash or directly to Elasticsearch..\"</span>,<span class=\"string\">\"source\"</span>:<span class=\"string\">\"/var/log/messages\"</span>,<span class=\"string\">\"offset\"</span>:<span class=\"number\">53754</span>,<span class=\"string\">\"input\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"2019-07-11T02:18:13.324Z\"</span>,<span class=\"string\">\"@metadata\"</span>:&#123;<span class=\"string\">\"beat\"</span>:<span class=\"string\">\"filebeat\"</span>,<span class=\"string\">\"type\"</span>:<span class=\"string\">\"doc\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"host\"</span>:&#123;<span class=\"string\">\"architecture\"</span>:<span class=\"string\">\"x86_64\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"os\"</span>:&#123;<span class=\"string\">\"codename\"</span>:<span class=\"string\">\"Core\"</span>,<span class=\"string\">\"platform\"</span>:<span class=\"string\">\"centos\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"7 (Core)\"</span>,<span class=\"string\">\"family\"</span>:<span class=\"string\">\"redhat\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"CentOS Linux\"</span>&#125;,<span class=\"string\">\"id\"</span>:<span class=\"string\">\"12bcfdc379904e4eb20173a568ecd7df\"</span>,<span class=\"string\">\"containerized\"</span>:false&#125;,<span class=\"string\">\"source\"</span>:<span class=\"string\">\"/var/log/messages\"</span>,<span class=\"string\">\"offset\"</span>:<span class=\"number\">53862</span>,<span class=\"string\">\"log\"</span>:&#123;<span class=\"string\">\"file\"</span>:&#123;<span class=\"string\">\"path\"</span>:<span class=\"string\">\"/var/log/messages\"</span>&#125;&#125;,<span class=\"string\">\"message\"</span>:<span class=\"string\">\"Jul 11 10:18:10 node01 systemd: Starting Filebeat sends log files to Logstash or directly to Elasticsearch....\"</span>,<span class=\"string\">\"prospector\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"input\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"beat\"</span>:&#123;<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"hostname\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"2019-07-11T02:18:48.328Z\"</span>,<span class=\"string\">\"@metadata\"</span>:&#123;<span class=\"string\">\"beat\"</span>:<span class=\"string\">\"filebeat\"</span>,<span class=\"string\">\"type\"</span>:<span class=\"string\">\"doc\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"offset\"</span>:<span class=\"number\">53973</span>,<span class=\"string\">\"log\"</span>:&#123;<span class=\"string\">\"file\"</span>:&#123;<span class=\"string\">\"path\"</span>:<span class=\"string\">\"/var/log/messages\"</span>&#125;&#125;,<span class=\"string\">\"message\"</span>:<span class=\"string\">\"test\"</span>,<span class=\"string\">\"input\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"prospector\"</span>:&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>&#125;,<span class=\"string\">\"beat\"</span>:&#123;<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"hostname\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"version\"</span>:<span class=\"string\">\"6.8.1\"</span>&#125;,<span class=\"string\">\"host\"</span>:&#123;<span class=\"string\">\"name\"</span>:<span class=\"string\">\"logstash\"</span>,<span class=\"string\">\"os\"</span>:&#123;<span class=\"string\">\"version\"</span>:<span class=\"string\">\"7 (Core)\"</span>,<span class=\"string\">\"family\"</span>:<span class=\"string\">\"redhat\"</span>,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"CentOS Linux\"</span>,<span class=\"string\">\"codename\"</span>:<span class=\"string\">\"Core\"</span>,<span class=\"string\">\"platform\"</span>:<span class=\"string\">\"centos\"</span>&#125;,<span class=\"string\">\"id\"</span>:<span class=\"string\">\"12bcfdc379904e4eb20173a568ecd7df\"</span>,<span class=\"string\">\"containerized\"</span>:false,<span class=\"string\">\"architecture\"</span>:<span class=\"string\">\"x86_64\"</span>&#125;,<span class=\"string\">\"source\"</span>:<span class=\"string\">\"/var/log/messages\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"配置filebeat收集系统日志输出redis\"><a href=\"#配置filebeat收集系统日志输出redis\" class=\"headerlink\" title=\"配置filebeat收集系统日志输出redis\"></a>配置filebeat收集系统日志输出redis</h3><p>1）编辑<code>filebeat</code>配置文件，修改输出<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">grep</span> -v <span class=\"string\">\"#\"</span> /etc/filebeat/filebeat.yml |<span class=\"keyword\">grep</span> -v <span class=\"string\">\"^$\"</span></span><br><span class=\"line\">filebeat.<span class=\"built_in\">input</span><span class=\"variable\">s:</span></span><br><span class=\"line\">- <span class=\"built_in\">type</span>: <span class=\"built_in\">log</span></span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  path<span class=\"variable\">s:</span></span><br><span class=\"line\">    - /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br><span class=\"line\">    - /var/<span class=\"built_in\">log</span>/*.<span class=\"built_in\">log</span></span><br><span class=\"line\">filebeat.config.module<span class=\"variable\">s:</span></span><br><span class=\"line\">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class=\"line\">  reload.enabled: false</span><br><span class=\"line\">setup.template.setting<span class=\"variable\">s:</span></span><br><span class=\"line\">  <span class=\"built_in\">index</span>.number_of_shard<span class=\"variable\">s:</span> <span class=\"number\">3</span></span><br><span class=\"line\">setup.kiban<span class=\"variable\">a:</span></span><br><span class=\"line\">output.<span class=\"keyword\">redi</span><span class=\"variable\">s:</span></span><br><span class=\"line\">  host<span class=\"variable\">s:</span> [<span class=\"string\">\"192.168.1.30:6379\"</span>]    #redis服务器及端口</span><br><span class=\"line\">  key: <span class=\"string\">\"system-log-33\"</span>    #这里自定义key的名称，为了后期处理</span><br><span class=\"line\">  d<span class=\"variable\">b:</span> <span class=\"number\">1</span>    #使用第几个库</span><br><span class=\"line\">  timeou<span class=\"variable\">t:</span> <span class=\"number\">5</span>    #超时时间</span><br><span class=\"line\">  password: <span class=\"number\">123321</span>    #redis 密码</span><br><span class=\"line\">processor<span class=\"variable\">s:</span></span><br><span class=\"line\">  - add_host_metadat<span class=\"variable\">a:</span> ~</span><br><span class=\"line\">  - add_cloud_metadat<span class=\"variable\">a:</span> ~</span><br><span class=\"line\"></span><br><span class=\"line\">[root@logstash ~]# systemctl restart filebeat</span><br></pre></td></tr></table></figure></p>\n<p>2）验证<code>redis</code>中是否有数据<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@linux-redis ~]</span># <span class=\"selector-tag\">redis-cli</span> <span class=\"selector-tag\">-h</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">AUTH</span> 123321</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">SELECT</span> 1</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span><span class=\"selector-attr\">[1]</span>&gt; <span class=\"selector-tag\">KEYS</span> *</span><br><span class=\"line\">1) \"<span class=\"selector-tag\">system-log-33</span>\"</span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span><span class=\"selector-attr\">[1]</span>&gt; <span class=\"selector-tag\">LLEN</span> <span class=\"selector-tag\">system-log-33</span></span><br><span class=\"line\">(<span class=\"selector-tag\">integer</span>) 3</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>logstash</code>服务器上面配置从<code>redis</code>服务器中取数据<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># cat /etc/logstash/conf.d/redis-filebeat.conf </span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    redis &#123;</span><br><span class=\"line\">        <span class=\"attr\">data_type</span> =&gt; <span class=\"string\">\"list\"</span></span><br><span class=\"line\">        <span class=\"attr\">host</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span></span><br><span class=\"line\">        <span class=\"attr\">password</span> =&gt; <span class=\"string\">\"123321\"</span></span><br><span class=\"line\">        <span class=\"attr\">port</span> =&gt; <span class=\"string\">\"6379\"</span></span><br><span class=\"line\">        <span class=\"attr\">db</span> =&gt; <span class=\"string\">\"1\"</span></span><br><span class=\"line\">        <span class=\"attr\">key</span> =&gt; <span class=\"string\">\"system-log-33\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"file-systemlog-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p>\n<p>4）输入测试数据到日志文件里<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"11111111111111\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"2222222222\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br><span class=\"line\">[root@logstash ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"33333333\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br></pre></td></tr></table></figure></p>\n<p>5）<code>kibana</code>界面创建索引模式<br><img src=\"/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file01.png\" alt><br><img src=\"/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file02.png\" alt=\"file02.png\"><br>6）验证数据<br><img src=\"/2019/07/05/ELK快速入门四-filebeat替代logstash收集日志/file03.png\" alt=\"file03.png\"></p>\n"},{"title":"ELK快速入门三-logstash收集日志写入redis","date":"2019-07-05T07:30:35.000Z","copyright":true,"_content":"\n>用一台服务器部署`redis`服务，专门用于日志缓存使用，一般用于`web`服务器产生大量日志的场景。\n>\n>这里是使用一台专门用于部署`redis` ，一台专门部署了`logstash`，在`linux-elk1`ELK集群上面进行日志收集存到了`redis`服务器上面，然后通过专门的`logstash`服务器去`redis`服务器里面取出数据在放到`kibana`上面进行展示\n\n\n\n## 部署redis\n\n### 下载安装redis\n```\n[root@linux-redis ~]# wget http://download.redis.io/releases/redis-5.0.0.tar.gz\n[root@linux-redis ~]# tar -xvzf redis-5.0.0.tar.gz\n[root@linux-redis ~]# mv redis-5.0.0 /usr/local/src/\n[root@linux-redis ~]# ln -sv /usr/local/src/redis-5.0.0 /usr/local/redis\n\"/usr/local/redis\" -> \"/usr/local/src/redis-5.0.0\"\n[root@linux-redis ~]# cd /usr/local/redis/\n[root@linux-redis ~]# make distclean\n[root@linux-redis ~]# make\n```\n\n\n### 配置redis\n```\n[root@linux-redis redis]# vim redis.conf\ndaemonize yes\nbind 192.168.1.30\nrequirepass 123321\n\n[root@linux-redis redis]# cp /usr/local/redis/src/redis-server /usr/bin/\n[root@linux-redis redis]# cp /usr/local/redis/src/redis-cli /usr/bin/\n[root@linux-redis redis]# redis-server /usr/local/redis/redis.conf \n4007:C 10 Jul 2019 12:24:30.367 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\n4007:C 10 Jul 2019 12:24:30.367 # Redis version=5.0.0, bits=64, commit=00000000, modified=0, pid=4007, just started\n4007:C 10 Jul 2019 12:24:30.367 # Configuration loaded\n\n[root@linux-redis redis]# netstat -nlutp |grep 6379\ntcp        0      0 192.168.1.30:6379       0.0.0.0:*               LISTEN      4008/redis-server 1\n```\n\n\n### 测试redis\n```\n[root@linux-redis redis]# redis-cli -h 192.168.1.30\n192.168.1.30:6379> AUTH 123321\nOK\n192.168.1.30:6379> ping\nPONG\n192.168.1.30:6379> KEYS *\n(empty list or set)\n192.168.1.30:6379> quit\n```\n\n\n\n## 配置logstash将日志写入redis\n>将系统日志的通过`logstash`收集之后写入`redis`，然后通过另外的`logstash`将`redis`服务器的数据取出来。\n\n### 配置logstash的配置文件\n```\n[root@linux-elk1 ~]# vim /etc/logstash/conf.d/system.conf\ninput {\n    file {\n        path => \"/var/log/messages\"\n        type => \"systemlog\"\n        start_position => \"beginning\"\n        stat_interval => \"2\"\n    }\n}\n\noutput {\n    if [type] == \"systemlog\" {\n        redis {\n            data_type => \"list\"\n            host => \"192.168.1.30\"\n            password => \"123321\"\n            port => \"6379\"\n            db => \"0\"\n            key => \"systemlog\"\n        }\n    }\n}\n```\n### 检查logstash配置语法是否正确\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf -t\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-10 14:46:46.324 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n\n[root@linux-elk1 ~]# systemctl restart logstash\n```\n### 写入messages日志测试\n```\n[root@linux-elk1 ~]# echo \"redis-test\" >> /var/log/messages\n[root@linux-elk1 ~]# echo \"systemlog\" >> /var/log/messages\n```\n### 登录redis进行查看\n```\n[root@linux-redis ~]# redis-cli -h 192.168.1.30\n192.168.1.30:6379> AUTH 123321\nOK\n192.168.1.30:6379> SELECT 0\nOK\n192.168.1.30:6379> KEYS *\n1) \"systemlog\"\n192.168.1.30:6379> LLEN systemlog\n(integer) 126\n```\n\n\n\n## 配置logstash从redis中取出数据到elasticsearch\n>配置专门`logstash`服务器从`redis`服务器读取指定的`key`的数据，并写入到`elasticsearch`\n\n### 编辑logstash配置文件\n```\n[root@logstash ~]# vim /etc/logstash/conf.d/redis-read.conf\ninput {\n    redis {\n        data_type => \"list\"\n        host => \"192.168.1.30\"\n        password => \"123321\"\n        port => \"6379\"\n        db => \"0\"\n        key => \"systemlog\"\n    }\n}\n\noutput {\n    elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]\n        index => \"redis-systemlog-%{+YYYY.MM.dd}\"\n    }\n}\n```\n\n### 测试logstash配置是否正确\n```\n[root@logstash ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-read.conf -t\nOpenJDK 64-Bit Server VM warning: If the number of processors is expected to increase from one, then you should configure the number of parallel GC threads appropriately using -XX:ParallelGCThreads=N\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[INFO ] 2019-07-10 16:41:50.576 [main] writabledirectory - Creating directory {:setting=>\"path.queue\", :path=>\"/usr/share/logstash/data/queue\"}\n[INFO ] 2019-07-10 16:41:50.649 [main] writabledirectory - Creating directory {:setting=>\"path.dead_letter_queue\", :path=>\"/usr/share/logstash/data/dead_letter_queue\"}\n[WARN ] 2019-07-10 16:41:51.498 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n\n[root@logstash ~]# systemctl restart logstash\n```\n\n### 验证redis的数据是否被取出\n```\n[root@linux-redis ~]# redis-cli -h 192.168.1.30\n192.168.1.30:6379> AUTH 123321\nOK\n192.168.1.30:6379> SELECT 0\nOK\n192.168.1.30:6379> KEYS *\n(empty list or set)     #这里数据已经为空\n192.168.1.30:6379> SELECT 1\nOK\n192.168.1.30:6379[1]> KEYS *\n(empty list or set)     #这里数据已经为空\n```\n### head插件上验证数据\n![redis01.png](ELK快速入门三-logstash收集日志写入redis/redis01.png)\n\n### kibana界面创建索引模式并查看数据\n![redis02.png](ELK快速入门三-logstash收集日志写入redis/redis02.png)\n![redis03.png](ELK快速入门三-logstash收集日志写入redis/redis03.png)\n![redis04.png](ELK快速入门三-logstash收集日志写入redis/redis04.png)\n\n\n\n\n\n\n","source":"_posts/ELK快速入门三-logstash收集日志写入redis.md","raw":"---\ntitle: ELK快速入门三-logstash收集日志写入redis\ndate: 2019-07-05 15:30:35\ntags: ELK\ncategories: ELK\ncopyright: true\n---\n\n>用一台服务器部署`redis`服务，专门用于日志缓存使用，一般用于`web`服务器产生大量日志的场景。\n>\n>这里是使用一台专门用于部署`redis` ，一台专门部署了`logstash`，在`linux-elk1`ELK集群上面进行日志收集存到了`redis`服务器上面，然后通过专门的`logstash`服务器去`redis`服务器里面取出数据在放到`kibana`上面进行展示\n\n\n\n## 部署redis\n\n### 下载安装redis\n```\n[root@linux-redis ~]# wget http://download.redis.io/releases/redis-5.0.0.tar.gz\n[root@linux-redis ~]# tar -xvzf redis-5.0.0.tar.gz\n[root@linux-redis ~]# mv redis-5.0.0 /usr/local/src/\n[root@linux-redis ~]# ln -sv /usr/local/src/redis-5.0.0 /usr/local/redis\n\"/usr/local/redis\" -> \"/usr/local/src/redis-5.0.0\"\n[root@linux-redis ~]# cd /usr/local/redis/\n[root@linux-redis ~]# make distclean\n[root@linux-redis ~]# make\n```\n\n\n### 配置redis\n```\n[root@linux-redis redis]# vim redis.conf\ndaemonize yes\nbind 192.168.1.30\nrequirepass 123321\n\n[root@linux-redis redis]# cp /usr/local/redis/src/redis-server /usr/bin/\n[root@linux-redis redis]# cp /usr/local/redis/src/redis-cli /usr/bin/\n[root@linux-redis redis]# redis-server /usr/local/redis/redis.conf \n4007:C 10 Jul 2019 12:24:30.367 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\n4007:C 10 Jul 2019 12:24:30.367 # Redis version=5.0.0, bits=64, commit=00000000, modified=0, pid=4007, just started\n4007:C 10 Jul 2019 12:24:30.367 # Configuration loaded\n\n[root@linux-redis redis]# netstat -nlutp |grep 6379\ntcp        0      0 192.168.1.30:6379       0.0.0.0:*               LISTEN      4008/redis-server 1\n```\n\n\n### 测试redis\n```\n[root@linux-redis redis]# redis-cli -h 192.168.1.30\n192.168.1.30:6379> AUTH 123321\nOK\n192.168.1.30:6379> ping\nPONG\n192.168.1.30:6379> KEYS *\n(empty list or set)\n192.168.1.30:6379> quit\n```\n\n\n\n## 配置logstash将日志写入redis\n>将系统日志的通过`logstash`收集之后写入`redis`，然后通过另外的`logstash`将`redis`服务器的数据取出来。\n\n### 配置logstash的配置文件\n```\n[root@linux-elk1 ~]# vim /etc/logstash/conf.d/system.conf\ninput {\n    file {\n        path => \"/var/log/messages\"\n        type => \"systemlog\"\n        start_position => \"beginning\"\n        stat_interval => \"2\"\n    }\n}\n\noutput {\n    if [type] == \"systemlog\" {\n        redis {\n            data_type => \"list\"\n            host => \"192.168.1.30\"\n            password => \"123321\"\n            port => \"6379\"\n            db => \"0\"\n            key => \"systemlog\"\n        }\n    }\n}\n```\n### 检查logstash配置语法是否正确\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf -t\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-10 14:46:46.324 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n\n[root@linux-elk1 ~]# systemctl restart logstash\n```\n### 写入messages日志测试\n```\n[root@linux-elk1 ~]# echo \"redis-test\" >> /var/log/messages\n[root@linux-elk1 ~]# echo \"systemlog\" >> /var/log/messages\n```\n### 登录redis进行查看\n```\n[root@linux-redis ~]# redis-cli -h 192.168.1.30\n192.168.1.30:6379> AUTH 123321\nOK\n192.168.1.30:6379> SELECT 0\nOK\n192.168.1.30:6379> KEYS *\n1) \"systemlog\"\n192.168.1.30:6379> LLEN systemlog\n(integer) 126\n```\n\n\n\n## 配置logstash从redis中取出数据到elasticsearch\n>配置专门`logstash`服务器从`redis`服务器读取指定的`key`的数据，并写入到`elasticsearch`\n\n### 编辑logstash配置文件\n```\n[root@logstash ~]# vim /etc/logstash/conf.d/redis-read.conf\ninput {\n    redis {\n        data_type => \"list\"\n        host => \"192.168.1.30\"\n        password => \"123321\"\n        port => \"6379\"\n        db => \"0\"\n        key => \"systemlog\"\n    }\n}\n\noutput {\n    elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]\n        index => \"redis-systemlog-%{+YYYY.MM.dd}\"\n    }\n}\n```\n\n### 测试logstash配置是否正确\n```\n[root@logstash ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-read.conf -t\nOpenJDK 64-Bit Server VM warning: If the number of processors is expected to increase from one, then you should configure the number of parallel GC threads appropriately using -XX:ParallelGCThreads=N\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[INFO ] 2019-07-10 16:41:50.576 [main] writabledirectory - Creating directory {:setting=>\"path.queue\", :path=>\"/usr/share/logstash/data/queue\"}\n[INFO ] 2019-07-10 16:41:50.649 [main] writabledirectory - Creating directory {:setting=>\"path.dead_letter_queue\", :path=>\"/usr/share/logstash/data/dead_letter_queue\"}\n[WARN ] 2019-07-10 16:41:51.498 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n\n[root@logstash ~]# systemctl restart logstash\n```\n\n### 验证redis的数据是否被取出\n```\n[root@linux-redis ~]# redis-cli -h 192.168.1.30\n192.168.1.30:6379> AUTH 123321\nOK\n192.168.1.30:6379> SELECT 0\nOK\n192.168.1.30:6379> KEYS *\n(empty list or set)     #这里数据已经为空\n192.168.1.30:6379> SELECT 1\nOK\n192.168.1.30:6379[1]> KEYS *\n(empty list or set)     #这里数据已经为空\n```\n### head插件上验证数据\n![redis01.png](ELK快速入门三-logstash收集日志写入redis/redis01.png)\n\n### kibana界面创建索引模式并查看数据\n![redis02.png](ELK快速入门三-logstash收集日志写入redis/redis02.png)\n![redis03.png](ELK快速入门三-logstash收集日志写入redis/redis03.png)\n![redis04.png](ELK快速入门三-logstash收集日志写入redis/redis04.png)\n\n\n\n\n\n\n","slug":"ELK快速入门三-logstash收集日志写入redis","published":1,"updated":"2019-10-24T09:12:16.857Z","_id":"cjz3xyiig0006dstcwqlyjqcl","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>用一台服务器部署<code>redis</code>服务，专门用于日志缓存使用，一般用于<code>web</code>服务器产生大量日志的场景。</p>\n<p>这里是使用一台专门用于部署<code>redis</code> ，一台专门部署了<code>logstash</code>，在<code>linux-elk1</code>ELK集群上面进行日志收集存到了<code>redis</code>服务器上面，然后通过专门的<code>logstash</code>服务器去<code>redis</code>服务器里面取出数据在放到<code>kibana</code>上面进行展示</p>\n</blockquote>\n<h2 id=\"部署redis\"><a href=\"#部署redis\" class=\"headerlink\" title=\"部署redis\"></a>部署redis</h2><h3 id=\"下载安装redis\"><a href=\"#下载安装redis\" class=\"headerlink\" title=\"下载安装redis\"></a>下载安装redis</h3><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># wget http://download.redis.io/releases/redis-5.0.0.tar.gz</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># tar -xvzf redis-5.0.0.tar.gz</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># mv redis-5.0.0 /usr/local/src/</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># ln -sv /usr/local/src/redis-5.0.0 /usr/local/redis</span></span><br><span class=\"line\"><span class=\"string\">\"/usr/local/redis\"</span> -&gt; <span class=\"string\">\"/usr/local/src/redis-5.0.0\"</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># cd /usr/local/redis/</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># make distclean</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># make</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"配置redis\"><a href=\"#配置redis\" class=\"headerlink\" title=\"配置redis\"></a>配置redis</h3><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis redis]<span class=\"comment\"># vim redis.conf</span></span><br><span class=\"line\">daemonize yes</span><br><span class=\"line\">bind <span class=\"number\">192.168</span>.<span class=\"number\">1.30</span></span><br><span class=\"line\">requirepass <span class=\"number\">123321</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis redis]<span class=\"comment\"># cp /usr/local/redis/src/redis-server /usr/bin/</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis redis]<span class=\"comment\"># cp /usr/local/redis/src/redis-cli /usr/bin/</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis redis]<span class=\"comment\"># redis-server /usr/local/redis/redis.conf </span></span><br><span class=\"line\"><span class=\"number\">4007</span><span class=\"symbol\">:C</span> <span class=\"number\">10</span> Jul <span class=\"number\">2019</span> <span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">24</span><span class=\"symbol\">:</span><span class=\"number\">30.367</span> <span class=\"comment\"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class=\"line\"><span class=\"number\">4007</span><span class=\"symbol\">:C</span> <span class=\"number\">10</span> Jul <span class=\"number\">2019</span> <span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">24</span><span class=\"symbol\">:</span><span class=\"number\">30.367</span> <span class=\"comment\"># Redis version=5.0.0, bits=64, commit=00000000, modified=0, pid=4007, just started</span></span><br><span class=\"line\"><span class=\"number\">4007</span><span class=\"symbol\">:C</span> <span class=\"number\">10</span> Jul <span class=\"number\">2019</span> <span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">24</span><span class=\"symbol\">:</span><span class=\"number\">30.367</span> <span class=\"comment\"># Configuration loaded</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis redis]<span class=\"comment\"># netstat -nlutp |grep 6379</span></span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.30</span><span class=\"symbol\">:</span><span class=\"number\">6379</span>       <span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span><span class=\"symbol\">:*</span>               LISTEN      <span class=\"number\">4008</span>/redis-server <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"测试redis\"><a href=\"#测试redis\" class=\"headerlink\" title=\"测试redis\"></a>测试redis</h3><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@linux-redis redis]</span># <span class=\"selector-tag\">redis-cli</span> <span class=\"selector-tag\">-h</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">AUTH</span> 123321</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">ping</span></span><br><span class=\"line\"><span class=\"selector-tag\">PONG</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">KEYS</span> *</span><br><span class=\"line\">(<span class=\"selector-tag\">empty</span> <span class=\"selector-tag\">list</span> <span class=\"selector-tag\">or</span> <span class=\"selector-tag\">set</span>)</span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">quit</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"配置logstash将日志写入redis\"><a href=\"#配置logstash将日志写入redis\" class=\"headerlink\" title=\"配置logstash将日志写入redis\"></a>配置logstash将日志写入redis</h2><blockquote>\n<p>将系统日志的通过<code>logstash</code>收集之后写入<code>redis</code>，然后通过另外的<code>logstash</code>将<code>redis</code>服务器的数据取出来。</p>\n</blockquote>\n<h3 id=\"配置logstash的配置文件\"><a href=\"#配置logstash的配置文件\" class=\"headerlink\" title=\"配置logstash的配置文件\"></a>配置logstash的配置文件</h3><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/system.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/var/log/messages\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"systemlog\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"2\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [<span class=\"built_in\">type</span>] == <span class=\"string\">\"systemlog\"</span> &#123;</span><br><span class=\"line\">        redis &#123;</span><br><span class=\"line\">            <span class=\"attr\">data_type</span> =&gt; <span class=\"string\">\"list\"</span></span><br><span class=\"line\">            <span class=\"attr\">host</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span></span><br><span class=\"line\">            <span class=\"attr\">password</span> =&gt; <span class=\"string\">\"123321\"</span></span><br><span class=\"line\">            <span class=\"attr\">port</span> =&gt; <span class=\"string\">\"6379\"</span></span><br><span class=\"line\">            <span class=\"attr\">db</span> =&gt; <span class=\"string\">\"0\"</span></span><br><span class=\"line\">            <span class=\"attr\">key</span> =&gt; <span class=\"string\">\"systemlog\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"检查logstash配置语法是否正确\"><a href=\"#检查logstash配置语法是否正确\" class=\"headerlink\" title=\"检查logstash配置语法是否正确\"></a>检查logstash配置语法是否正确</h3><figure class=\"highlight vhdl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf -t</span><br><span class=\"line\"><span class=\"literal\">WARNING</span>: Could <span class=\"keyword\">not</span> find logstash.yml which <span class=\"keyword\">is</span> typically located <span class=\"keyword\">in</span> $LS_HOME/config <span class=\"keyword\">or</span> /etc/logstash. You can specify the path using <span class=\"comment\">--path.settings. Continuing using the defaults</span></span><br><span class=\"line\">Could <span class=\"keyword\">not</span> find log4j2 <span class=\"keyword\">configuration</span> at path /usr/share/logstash/config/log4j2.properties. Using <span class=\"keyword\">default</span> config which logs errors <span class=\"keyword\">to</span> the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">10</span> <span class=\"number\">14</span>:<span class=\"number\">46</span>:<span class=\"number\">46.324</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"symbol\">'pipelines</span>.yml' <span class=\"keyword\">file</span> because modules <span class=\"keyword\">or</span> command <span class=\"literal\">line</span> options are specified</span><br><span class=\"line\"><span class=\"keyword\">Configuration</span> OK</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]# systemctl restart logstash</span><br></pre></td></tr></table></figure>\n<h3 id=\"写入messages日志测试\"><a href=\"#写入messages日志测试\" class=\"headerlink\" title=\"写入messages日志测试\"></a>写入messages日志测试</h3><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"redis-test\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br><span class=\"line\">[root@linux-elk1 ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"systemlog\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"登录redis进行查看\"><a href=\"#登录redis进行查看\" class=\"headerlink\" title=\"登录redis进行查看\"></a>登录redis进行查看</h3><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@linux-redis ~]</span># <span class=\"selector-tag\">redis-cli</span> <span class=\"selector-tag\">-h</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">AUTH</span> 123321</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">SELECT</span> 0</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">KEYS</span> *</span><br><span class=\"line\">1) \"<span class=\"selector-tag\">systemlog</span>\"</span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">LLEN</span> <span class=\"selector-tag\">systemlog</span></span><br><span class=\"line\">(<span class=\"selector-tag\">integer</span>) 126</span><br></pre></td></tr></table></figure>\n<h2 id=\"配置logstash从redis中取出数据到elasticsearch\"><a href=\"#配置logstash从redis中取出数据到elasticsearch\" class=\"headerlink\" title=\"配置logstash从redis中取出数据到elasticsearch\"></a>配置logstash从redis中取出数据到elasticsearch</h2><blockquote>\n<p>配置专门<code>logstash</code>服务器从<code>redis</code>服务器读取指定的<code>key</code>的数据，并写入到<code>elasticsearch</code></p>\n</blockquote>\n<h3 id=\"编辑logstash配置文件\"><a href=\"#编辑logstash配置文件\" class=\"headerlink\" title=\"编辑logstash配置文件\"></a>编辑logstash配置文件</h3><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@logstash ~]<span class=\"comment\"># vim /etc/logstash/conf.d/redis-read.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    redis &#123;</span><br><span class=\"line\">        <span class=\"attr\">data_type</span> =&gt; <span class=\"string\">\"list\"</span></span><br><span class=\"line\">        <span class=\"attr\">host</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span></span><br><span class=\"line\">        <span class=\"attr\">password</span> =&gt; <span class=\"string\">\"123321\"</span></span><br><span class=\"line\">        <span class=\"attr\">port</span> =&gt; <span class=\"string\">\"6379\"</span></span><br><span class=\"line\">        <span class=\"attr\">db</span> =&gt; <span class=\"string\">\"0\"</span></span><br><span class=\"line\">        <span class=\"attr\">key</span> =&gt; <span class=\"string\">\"systemlog\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"redis-systemlog-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"测试logstash配置是否正确\"><a href=\"#测试logstash配置是否正确\" class=\"headerlink\" title=\"测试logstash配置是否正确\"></a>测试logstash配置是否正确</h3><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@logstash</span> ~]<span class=\"comment\"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-read.conf -t</span></span><br><span class=\"line\">OpenJDK <span class=\"number\">64</span>-Bit Server VM <span class=\"symbol\">warning:</span> If the number of processors is expected to increase from one, <span class=\"keyword\">then</span> you should configure the number of parallel GC threads appropriately using -<span class=\"symbol\">XX:</span>ParallelGCThreads=N</span><br><span class=\"line\"><span class=\"symbol\">WARNING:</span> Could <span class=\"keyword\">not</span> find logstash.yml which is typically located <span class=\"keyword\">in</span> <span class=\"variable\">$LS_HOME</span>/config <span class=\"keyword\">or</span> /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class=\"line\">Could <span class=\"keyword\">not</span> find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">10</span> <span class=\"number\">16</span><span class=\"symbol\">:</span><span class=\"number\">41</span><span class=\"symbol\">:</span><span class=\"number\">50.576</span> [main] writabledirectory - Creating directory &#123;<span class=\"symbol\">:setting=&gt;<span class=\"string\">\"path.queue\"</span></span>, <span class=\"symbol\">:path=&gt;<span class=\"string\">\"/usr/share/logstash/data/queue\"</span></span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">10</span> <span class=\"number\">16</span><span class=\"symbol\">:</span><span class=\"number\">41</span><span class=\"symbol\">:</span><span class=\"number\">50.649</span> [main] writabledirectory - Creating directory &#123;<span class=\"symbol\">:setting=&gt;<span class=\"string\">\"path.dead_letter_queue\"</span></span>, <span class=\"symbol\">:path=&gt;<span class=\"string\">\"/usr/share/logstash/data/dead_letter_queue\"</span></span>&#125;</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">10</span> <span class=\"number\">16</span><span class=\"symbol\">:</span><span class=\"number\">41</span><span class=\"symbol\">:</span><span class=\"number\">51.498</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command line options are specified</span><br><span class=\"line\">Configuration OK</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@logstash</span> ~]<span class=\"comment\"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"验证redis的数据是否被取出\"><a href=\"#验证redis的数据是否被取出\" class=\"headerlink\" title=\"验证redis的数据是否被取出\"></a>验证redis的数据是否被取出</h3><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@linux-redis ~]</span># <span class=\"selector-tag\">redis-cli</span> <span class=\"selector-tag\">-h</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">AUTH</span> 123321</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">SELECT</span> 0</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">KEYS</span> *</span><br><span class=\"line\">(<span class=\"selector-tag\">empty</span> <span class=\"selector-tag\">list</span> <span class=\"selector-tag\">or</span> <span class=\"selector-tag\">set</span>)     #这里数据已经为空</span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">SELECT</span> 1</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span><span class=\"selector-attr\">[1]</span>&gt; <span class=\"selector-tag\">KEYS</span> *</span><br><span class=\"line\">(<span class=\"selector-tag\">empty</span> <span class=\"selector-tag\">list</span> <span class=\"selector-tag\">or</span> <span class=\"selector-tag\">set</span>)     #这里数据已经为空</span><br></pre></td></tr></table></figure>\n<h3 id=\"head插件上验证数据\"><a href=\"#head插件上验证数据\" class=\"headerlink\" title=\"head插件上验证数据\"></a>head插件上验证数据</h3><p><img src=\"/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis01.png\" alt=\"redis01.png\"></p>\n<h3 id=\"kibana界面创建索引模式并查看数据\"><a href=\"#kibana界面创建索引模式并查看数据\" class=\"headerlink\" title=\"kibana界面创建索引模式并查看数据\"></a>kibana界面创建索引模式并查看数据</h3><p><img src=\"/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis02.png\" alt=\"redis02.png\"><br><img src=\"/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis03.png\" alt=\"redis03.png\"><br><img src=\"/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis04.png\" alt=\"redis04.png\"></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>用一台服务器部署<code>redis</code>服务，专门用于日志缓存使用，一般用于<code>web</code>服务器产生大量日志的场景。</p>\n<p>这里是使用一台专门用于部署<code>redis</code> ，一台专门部署了<code>logstash</code>，在<code>linux-elk1</code>ELK集群上面进行日志收集存到了<code>redis</code>服务器上面，然后通过专门的<code>logstash</code>服务器去<code>redis</code>服务器里面取出数据在放到<code>kibana</code>上面进行展示</p>\n</blockquote>\n<h2 id=\"部署redis\"><a href=\"#部署redis\" class=\"headerlink\" title=\"部署redis\"></a>部署redis</h2><h3 id=\"下载安装redis\"><a href=\"#下载安装redis\" class=\"headerlink\" title=\"下载安装redis\"></a>下载安装redis</h3><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># wget http://download.redis.io/releases/redis-5.0.0.tar.gz</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># tar -xvzf redis-5.0.0.tar.gz</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># mv redis-5.0.0 /usr/local/src/</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># ln -sv /usr/local/src/redis-5.0.0 /usr/local/redis</span></span><br><span class=\"line\"><span class=\"string\">\"/usr/local/redis\"</span> -&gt; <span class=\"string\">\"/usr/local/src/redis-5.0.0\"</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># cd /usr/local/redis/</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># make distclean</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis ~]<span class=\"comment\"># make</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"配置redis\"><a href=\"#配置redis\" class=\"headerlink\" title=\"配置redis\"></a>配置redis</h3><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis redis]<span class=\"comment\"># vim redis.conf</span></span><br><span class=\"line\">daemonize yes</span><br><span class=\"line\">bind <span class=\"number\">192.168</span>.<span class=\"number\">1.30</span></span><br><span class=\"line\">requirepass <span class=\"number\">123321</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis redis]<span class=\"comment\"># cp /usr/local/redis/src/redis-server /usr/bin/</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis redis]<span class=\"comment\"># cp /usr/local/redis/src/redis-cli /usr/bin/</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis redis]<span class=\"comment\"># redis-server /usr/local/redis/redis.conf </span></span><br><span class=\"line\"><span class=\"number\">4007</span><span class=\"symbol\">:C</span> <span class=\"number\">10</span> Jul <span class=\"number\">2019</span> <span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">24</span><span class=\"symbol\">:</span><span class=\"number\">30.367</span> <span class=\"comment\"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class=\"line\"><span class=\"number\">4007</span><span class=\"symbol\">:C</span> <span class=\"number\">10</span> Jul <span class=\"number\">2019</span> <span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">24</span><span class=\"symbol\">:</span><span class=\"number\">30.367</span> <span class=\"comment\"># Redis version=5.0.0, bits=64, commit=00000000, modified=0, pid=4007, just started</span></span><br><span class=\"line\"><span class=\"number\">4007</span><span class=\"symbol\">:C</span> <span class=\"number\">10</span> Jul <span class=\"number\">2019</span> <span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">24</span><span class=\"symbol\">:</span><span class=\"number\">30.367</span> <span class=\"comment\"># Configuration loaded</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-redis redis]<span class=\"comment\"># netstat -nlutp |grep 6379</span></span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.30</span><span class=\"symbol\">:</span><span class=\"number\">6379</span>       <span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span>.<span class=\"number\">0</span><span class=\"symbol\">:*</span>               LISTEN      <span class=\"number\">4008</span>/redis-server <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"测试redis\"><a href=\"#测试redis\" class=\"headerlink\" title=\"测试redis\"></a>测试redis</h3><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@linux-redis redis]</span># <span class=\"selector-tag\">redis-cli</span> <span class=\"selector-tag\">-h</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">AUTH</span> 123321</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">ping</span></span><br><span class=\"line\"><span class=\"selector-tag\">PONG</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">KEYS</span> *</span><br><span class=\"line\">(<span class=\"selector-tag\">empty</span> <span class=\"selector-tag\">list</span> <span class=\"selector-tag\">or</span> <span class=\"selector-tag\">set</span>)</span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">quit</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"配置logstash将日志写入redis\"><a href=\"#配置logstash将日志写入redis\" class=\"headerlink\" title=\"配置logstash将日志写入redis\"></a>配置logstash将日志写入redis</h2><blockquote>\n<p>将系统日志的通过<code>logstash</code>收集之后写入<code>redis</code>，然后通过另外的<code>logstash</code>将<code>redis</code>服务器的数据取出来。</p>\n</blockquote>\n<h3 id=\"配置logstash的配置文件\"><a href=\"#配置logstash的配置文件\" class=\"headerlink\" title=\"配置logstash的配置文件\"></a>配置logstash的配置文件</h3><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/system.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/var/log/messages\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"systemlog\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"2\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [<span class=\"built_in\">type</span>] == <span class=\"string\">\"systemlog\"</span> &#123;</span><br><span class=\"line\">        redis &#123;</span><br><span class=\"line\">            <span class=\"attr\">data_type</span> =&gt; <span class=\"string\">\"list\"</span></span><br><span class=\"line\">            <span class=\"attr\">host</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span></span><br><span class=\"line\">            <span class=\"attr\">password</span> =&gt; <span class=\"string\">\"123321\"</span></span><br><span class=\"line\">            <span class=\"attr\">port</span> =&gt; <span class=\"string\">\"6379\"</span></span><br><span class=\"line\">            <span class=\"attr\">db</span> =&gt; <span class=\"string\">\"0\"</span></span><br><span class=\"line\">            <span class=\"attr\">key</span> =&gt; <span class=\"string\">\"systemlog\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"检查logstash配置语法是否正确\"><a href=\"#检查logstash配置语法是否正确\" class=\"headerlink\" title=\"检查logstash配置语法是否正确\"></a>检查logstash配置语法是否正确</h3><figure class=\"highlight vhdl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system.conf -t</span><br><span class=\"line\"><span class=\"literal\">WARNING</span>: Could <span class=\"keyword\">not</span> find logstash.yml which <span class=\"keyword\">is</span> typically located <span class=\"keyword\">in</span> $LS_HOME/config <span class=\"keyword\">or</span> /etc/logstash. You can specify the path using <span class=\"comment\">--path.settings. Continuing using the defaults</span></span><br><span class=\"line\">Could <span class=\"keyword\">not</span> find log4j2 <span class=\"keyword\">configuration</span> at path /usr/share/logstash/config/log4j2.properties. Using <span class=\"keyword\">default</span> config which logs errors <span class=\"keyword\">to</span> the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">10</span> <span class=\"number\">14</span>:<span class=\"number\">46</span>:<span class=\"number\">46.324</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"symbol\">'pipelines</span>.yml' <span class=\"keyword\">file</span> because modules <span class=\"keyword\">or</span> command <span class=\"literal\">line</span> options are specified</span><br><span class=\"line\"><span class=\"keyword\">Configuration</span> OK</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]# systemctl restart logstash</span><br></pre></td></tr></table></figure>\n<h3 id=\"写入messages日志测试\"><a href=\"#写入messages日志测试\" class=\"headerlink\" title=\"写入messages日志测试\"></a>写入messages日志测试</h3><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"redis-test\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br><span class=\"line\">[root@linux-elk1 ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"systemlog\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"登录redis进行查看\"><a href=\"#登录redis进行查看\" class=\"headerlink\" title=\"登录redis进行查看\"></a>登录redis进行查看</h3><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@linux-redis ~]</span># <span class=\"selector-tag\">redis-cli</span> <span class=\"selector-tag\">-h</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">AUTH</span> 123321</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">SELECT</span> 0</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">KEYS</span> *</span><br><span class=\"line\">1) \"<span class=\"selector-tag\">systemlog</span>\"</span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">LLEN</span> <span class=\"selector-tag\">systemlog</span></span><br><span class=\"line\">(<span class=\"selector-tag\">integer</span>) 126</span><br></pre></td></tr></table></figure>\n<h2 id=\"配置logstash从redis中取出数据到elasticsearch\"><a href=\"#配置logstash从redis中取出数据到elasticsearch\" class=\"headerlink\" title=\"配置logstash从redis中取出数据到elasticsearch\"></a>配置logstash从redis中取出数据到elasticsearch</h2><blockquote>\n<p>配置专门<code>logstash</code>服务器从<code>redis</code>服务器读取指定的<code>key</code>的数据，并写入到<code>elasticsearch</code></p>\n</blockquote>\n<h3 id=\"编辑logstash配置文件\"><a href=\"#编辑logstash配置文件\" class=\"headerlink\" title=\"编辑logstash配置文件\"></a>编辑logstash配置文件</h3><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@logstash ~]<span class=\"comment\"># vim /etc/logstash/conf.d/redis-read.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    redis &#123;</span><br><span class=\"line\">        <span class=\"attr\">data_type</span> =&gt; <span class=\"string\">\"list\"</span></span><br><span class=\"line\">        <span class=\"attr\">host</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span></span><br><span class=\"line\">        <span class=\"attr\">password</span> =&gt; <span class=\"string\">\"123321\"</span></span><br><span class=\"line\">        <span class=\"attr\">port</span> =&gt; <span class=\"string\">\"6379\"</span></span><br><span class=\"line\">        <span class=\"attr\">db</span> =&gt; <span class=\"string\">\"0\"</span></span><br><span class=\"line\">        <span class=\"attr\">key</span> =&gt; <span class=\"string\">\"systemlog\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"redis-systemlog-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"测试logstash配置是否正确\"><a href=\"#测试logstash配置是否正确\" class=\"headerlink\" title=\"测试logstash配置是否正确\"></a>测试logstash配置是否正确</h3><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@logstash</span> ~]<span class=\"comment\"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-read.conf -t</span></span><br><span class=\"line\">OpenJDK <span class=\"number\">64</span>-Bit Server VM <span class=\"symbol\">warning:</span> If the number of processors is expected to increase from one, <span class=\"keyword\">then</span> you should configure the number of parallel GC threads appropriately using -<span class=\"symbol\">XX:</span>ParallelGCThreads=N</span><br><span class=\"line\"><span class=\"symbol\">WARNING:</span> Could <span class=\"keyword\">not</span> find logstash.yml which is typically located <span class=\"keyword\">in</span> <span class=\"variable\">$LS_HOME</span>/config <span class=\"keyword\">or</span> /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class=\"line\">Could <span class=\"keyword\">not</span> find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">10</span> <span class=\"number\">16</span><span class=\"symbol\">:</span><span class=\"number\">41</span><span class=\"symbol\">:</span><span class=\"number\">50.576</span> [main] writabledirectory - Creating directory &#123;<span class=\"symbol\">:setting=&gt;<span class=\"string\">\"path.queue\"</span></span>, <span class=\"symbol\">:path=&gt;<span class=\"string\">\"/usr/share/logstash/data/queue\"</span></span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">10</span> <span class=\"number\">16</span><span class=\"symbol\">:</span><span class=\"number\">41</span><span class=\"symbol\">:</span><span class=\"number\">50.649</span> [main] writabledirectory - Creating directory &#123;<span class=\"symbol\">:setting=&gt;<span class=\"string\">\"path.dead_letter_queue\"</span></span>, <span class=\"symbol\">:path=&gt;<span class=\"string\">\"/usr/share/logstash/data/dead_letter_queue\"</span></span>&#125;</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">10</span> <span class=\"number\">16</span><span class=\"symbol\">:</span><span class=\"number\">41</span><span class=\"symbol\">:</span><span class=\"number\">51.498</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command line options are specified</span><br><span class=\"line\">Configuration OK</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@logstash</span> ~]<span class=\"comment\"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"验证redis的数据是否被取出\"><a href=\"#验证redis的数据是否被取出\" class=\"headerlink\" title=\"验证redis的数据是否被取出\"></a>验证redis的数据是否被取出</h3><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@linux-redis ~]</span># <span class=\"selector-tag\">redis-cli</span> <span class=\"selector-tag\">-h</span> 192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">AUTH</span> 123321</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">SELECT</span> 0</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">KEYS</span> *</span><br><span class=\"line\">(<span class=\"selector-tag\">empty</span> <span class=\"selector-tag\">list</span> <span class=\"selector-tag\">or</span> <span class=\"selector-tag\">set</span>)     #这里数据已经为空</span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span>&gt; <span class=\"selector-tag\">SELECT</span> 1</span><br><span class=\"line\"><span class=\"selector-tag\">OK</span></span><br><span class=\"line\">192<span class=\"selector-class\">.168</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.30</span><span class=\"selector-pseudo\">:6379</span><span class=\"selector-attr\">[1]</span>&gt; <span class=\"selector-tag\">KEYS</span> *</span><br><span class=\"line\">(<span class=\"selector-tag\">empty</span> <span class=\"selector-tag\">list</span> <span class=\"selector-tag\">or</span> <span class=\"selector-tag\">set</span>)     #这里数据已经为空</span><br></pre></td></tr></table></figure>\n<h3 id=\"head插件上验证数据\"><a href=\"#head插件上验证数据\" class=\"headerlink\" title=\"head插件上验证数据\"></a>head插件上验证数据</h3><p><img src=\"/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis01.png\" alt=\"redis01.png\"></p>\n<h3 id=\"kibana界面创建索引模式并查看数据\"><a href=\"#kibana界面创建索引模式并查看数据\" class=\"headerlink\" title=\"kibana界面创建索引模式并查看数据\"></a>kibana界面创建索引模式并查看数据</h3><p><img src=\"/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis02.png\" alt=\"redis02.png\"><br><img src=\"/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis03.png\" alt=\"redis03.png\"><br><img src=\"/2019/07/05/ELK快速入门三-logstash收集日志写入redis/redis04.png\" alt=\"redis04.png\"></p>\n"},{"title":"存储服务之NFS","date":"2019-08-08T07:00:35.000Z","copyright":true,"_content":"\n## NFS介绍\n[官方文档](http://nfs.sourceforge.net/nfs-howto/)\n\n> `NFS（Network File System）`即网络文件系统，它最大的功能就是通过`TCP/IP`网络共享资源。在`NFS`的应用中，本地`NFS`的客户端应用可以透明地读写位于远端`NFS`服务器上的文件，就像访问本地文件一样。\n\n>`NFS`客户端一般是应用服务器（比如`web`，负载均衡等），可以通过挂载的方式将`NFS`服务器端共享的目录挂载到`NFS`客户端本地的目录下。\n\n> 因为`NFS`支持的功能相当的多，而不同的功能都会使用不同的程序来启动，每启动一个功能就会启用一些端口来传输数据，因此，`NFS`的功能所对应的端口才没有固定住，而是随机取用一些未被使用的小于`1024`的端口来作为传输之用。但如此一来又造成了客户端想要连上服务器时的困扰，因为客户端得要知道服务器端的相关端口才能够进行连接。\n\n>因此就需要远程过程调用`(RPC)`的服务，`RPC`最主要的功能就是在指定每个`NFS`功能所对应的` port number`，并且回报给客户端，让客户端可以连接正确的端口上去。那`RPC`又是如何知道每个`NFS`的端口呢？这是因为当服务器在启动`NFS`时会随机取用数个端口，并主动的想`RPC`注册，因此`RPC`可以知道每个端口对应的`NFS`功能，然后`RPC`又是固定使用` port 111`来监听客户端的需求并回报给客户端正确的端口，所以当然可以让`NFS`的启动更为轻松愉快了。\n\n>`NFS`在文件传送过程中依赖与`RPC`（远程过程调用）协议。`NFS`本身是没有提供信息传送的协议和功能的，但是能够用过网络进行图片，视频，附件等分享功能。只要用到NFS的地方都需要启动`RPC`服务，不论是`NFS`的服务端还是客户端。\n\n>`NFS`和`RPC`的关系：可以理解为`NFS`是一个网络文件系统（比喻为租房的房主），而`RPC`是负责信息的传输（中介），客户端（相当于租房的租客）。\n\n### NFS网络文件系统存在的意义\n实现数据共享，数据保持一致。如图所示：\n![image.png](存储服务之NFS/01.png)\n\n### NFS网络文件系统工作方式\n>1、在`nfs`服务器端创建共享目录\n>2、通过`mount`网络挂载，将`NFS`服务端共享目录挂载到`NFS`客户端本地目录\n>3、`NFS`客户端在挂载目录上创建、删除、查看数据等操作，等价于在服务端进行的创建、删除、查看数据等操作。\n\n![01.png](存储服务之NFS/02.png)\n如上图所示，在`NFS`服务器端设置一个共享目录`/web`后，其他有权限访问`NFS`服务器端的客户端都可以将这个共享目录`/web`挂载到客户端本地的某个挂载点（其实就是一个目录，这个挂载点可以自己随意指定），不同的客户端的挂载点可以不相同。\n客户端正确挂载完毕后，就可以通过`NFS`客户端的挂载点所在的`/opt/www`目录查看到`NFS`服务端`/web`共享出来的目录下的所有数据。在客户端查看时，`NFS`服务端的`/web`目录就相当于客户端本地的磁盘分区或目录，几乎感觉不到使用上的区别，根据`NFS`服务器端授予的`NFS`共享权限以及共享目录的本地系统权限，只要在指定的`NFS`客户端操作挂载的`/opt/www`目录，就可以将数据轻松的存取到`NFS`服务器端上的`/web`目录中了。\n\n\n### NFS工作流程\n![02.png](存储服务之NFS/03.png)\n\n### RPC服务工作原理\n![image.png](存储服务之NFS/04.png)\n\n\n\n\n\n## NFS部署示例\n### 环境规划\n| 操作系统           | 角色                      | IP           | HOST            |\n| ------------------ | ------------------------- | ------------ | --------------- |\n| CentOS release 7.4 | NFS Server                | 192.168.1.31 | nfs-server.com  |\n| CentOS release 7.4 | NFS Client1 (web server1) | 192.168.1.32 | nfs-client1.com |\n| CentOS release 7.4 | NFS Client2 (web server2) | 192.168.1.33 | nfs-client2.com |\n\n> 这里`NFS`客户端是`web`服务器，站点目录挂载`NFS`服务端。\n> 实验环境关闭防火墙、selinux、时间同步等\n\n### 具体操作步骤\n**服务端安装配置**\n1）检查是否安装`NFS、RPC`服务\n```\n[root@nfs-server ~]# rpm -aq |egrep \"nfs-utils|rpcbind\"\nrpcbind-0.2.0-42.el7.x86_64\nnfs-utils-1.3.0-0.48.el7.x86_64\n\n# 如果没有安装则进行安装\n# yum -y install nfs-utils rpcbind\n```\n2）启动`rpc`和`nfs`服务\n```\n[root@nfs-server ~]# systemctl start rpcbind\n[root@nfs-server ~]# systemctl enable rpcbind\n[root@nfs-server ~]# systemctl start nfs\n```\n3）可以通过`rpcinfo -p localhost`可以查看到绑定了`nfs`\n```\n[root@nfs-server ~]# rpcinfo -p localhost\n   program vers proto   port  service\n    100000    4   tcp    111  portmapper\n    100000    3   tcp    111  portmapper\n    100000    2   tcp    111  portmapper\n    100000    4   udp    111  portmapper\n    100000    3   udp    111  portmapper\n    100000    2   udp    111  portmapper\n    100005    1   udp  20048  mountd\n    100005    1   tcp  20048  mountd\n    100005    2   udp  20048  mountd\n    100005    2   tcp  20048  mountd\n    100005    3   udp  20048  mountd\n    100005    3   tcp  20048  mountd\n    100024    1   udp  60358  status\n    100024    1   tcp  34912  status\n    100003    3   tcp   2049  nfs\n    100003    4   tcp   2049  nfs\n    100227    3   tcp   2049  nfs_acl\n    100003    3   udp   2049  nfs\n    100003    4   udp   2049  nfs\n    100227    3   udp   2049  nfs_acl\n    100021    1   udp  38577  nlockmgr\n    100021    3   udp  38577  nlockmgr\n    100021    4   udp  38577  nlockmgr\n    100021    1   tcp  42193  nlockmgr\n    100021    3   tcp  42193  nlockmgr\n    100021    4   tcp  42193  nlockmgr\n```\n4）配置共享目录并重启`nfs`\n```\n[root@nfs-server ~]# mkdir /web\n[root@nfs-server ~]# vim /etc/exports\n/web    192.168.1.0/24(rw,sync,no_root_squash)  #不压制root(当client端使用root挂载时，也有root权限)\n[root@nfs-server ~]# systemctl restart nfs\n[root@nfs-server ~]# exportfs -v\n/web          \t192.168.1.0/24(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)\n```\n\n**客户端挂载测试**\n1）创建挂载目录并进行挂载\n```\n[root@nfs-client1 ~]# mkdir /opt/www\n[root@nfs-client1 ~]# showmount -e 192.168.1.31    #查看服务器共享目录\nExport list for 192.168.1.31:\n/web 192.168.1.0/24\n[root@nfs-client1 ~]# mount -t nfs 192.168.1.31:/web /opt/www/\n[root@nfs-client1 ~]# df -h\n文件系统                 容量  已用  可用 已用% 挂载点\n/dev/mapper/centos-root   20G  3.6G   16G   19% /\ndevtmpfs                 473M     0  473M    0% /dev\ntmpfs                    489M     0  489M    0% /dev/shm\ntmpfs                    489M   14M  475M    3% /run\ntmpfs                    489M     0  489M    0% /sys/fs/cgroup\n/dev/sda1                497M  154M  344M   31% /boot\ntmpfs                     98M     0   98M    0% /run/user/0\n192.168.1.31:/web         20G  3.6G   16G   19% /opt/www\n```\n2）在`client1`上的`/opt/www`创建一个测试文件\n```\n[root@nfs-client1 ~]# echo \"client1 create test file\" >> /opt/www/client1.txt\n```\n3）回到`nfs`上进行查看\n```\n[root@nfs-server ~]# ll /web/\n总用量 4\n-rw-r--r-- 1 root root 25 8月   9 14:41 client1.txt\n```\n4）安装`nginx`并配置站点目录为`/opt/www`\n```\n[root@nfs-client1 ~]# yum -y install nginx\n[root@nfs-client1 ~]# vim /etc/nginx/nginx.conf\nserver {\n        listen       80 default_server;\n        listen       [::]:80 default_server;\n        server_name  _;\n        root         /opt/www;\n...\n[root@nfs-client1 ~]# systemctl start nginx\n```\n上面的步骤同样在`client2`上面操作。\n\n**在nfs服务端创建站点首页，访问client客户端测试**\n```\n[root@nfs-server ~]# ll /web/\n总用量 8\n-rw-r--r-- 1 root root 25 8月   9 14:41 client1.txt\n-rw-r--r-- 1 root root 25 8月   9 15:37 client2.txt\n\n[root@nfs-server ~]# echo \"<h1>NFS server</h1>\" >> /web/index.html    #nfs服务端共享目录创建首页文件\n[root@nfs-server ~]# curl 192.168.1.32\n<h1>NFS server</h1>\n[root@nfs-server ~]# \n[root@nfs-server ~]# curl 192.168.1.33\n<h1>NFS server</h1>\n\n[root@nfs-client1 ~]# ll /opt/www/    #nfs客户端1上查看\n总用量 12\n-rw-r--r-- 1 root root 25 8月   9 14:41 client1.txt\n-rw-r--r-- 1 root root 25 8月   9 15:37 client2.txt\n-rw-r--r-- 1 root root 20 8月   9 15:41 index.html\n\n[root@nfs-client2 ~]# ll /opt/www/    #nfs客户端2上查看\n总用量 12\n-rw-r--r-- 1 root root 25 8月   9 14:41 client1.txt\n-rw-r--r-- 1 root root 25 8月   9 15:37 client2.txt\n-rw-r--r-- 1 root root 20 8月   9 15:41 index.html\n```\n通过测试可以看出，客户端挂载后，就完全相当于自己的一个目录或者文件，在负载均衡架构中一般通过这种方式做共享存储。\n\n\n### NFS配置参数说明\n#### nfs共享参数及作用\n通过 `man exports`可以查看帮助手册\n\n共享参数|作用\n---:|:---\nrw\\*|读写权限\nro|只读权限\nroot_squash|当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)\nno_root_squash|当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(常用)\nall_squash|无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户(常用)\nno_all_squash|无论NFS客户端使用什么账户访问，都不进行压缩\nsync\\*|同时将数据写入到内存与硬盘中，保证不丢失数据\nasync|优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据\nanonuid\\*|配置all_squash使用,指定NFS的用户UID,必须存在系统\nanongid\\*|配置all_squash使用,指定NFS的用户GID,必须存在系统\n\n\n#### 配置实例说明\n```\n[root@nfs-server ~]# cat /etc/exports\n#/web    192.168.1.0/24(rw,sync,no_root_squash)  #不压制root(当client端使用root挂载时，也有root权限)\n/web    192.168.1.32(rw,sync,no_root_squash) 192.168.1.33(rw,sync,all_squash,anonuid=2000,anongid=2000)\n```\n>\\#[共享目录]&emsp;  [客户端地址1(权限)]&emsp;  [客户端地址2(权限)] \n>1、共享目录：每一行最前面是共享出来的目录，比如上面我要共享`/web`目录，那么此选项就可以直接写`/web`目录，这个目录可以依照不同的权限共享给不同的目录。\n>2、客户端地址：客户端地址能够设置一个网络，也可以是单个主机。参数：如上面的读写权限`rw`，同步更新`sync`等待。\n>>1、客户端地址可以使用完整的IP或者网络号，例如`192.168.1.33 `或`192.168.1.0/24`\n>>2、同样可以使用主机名，但是这个主机名必须要在`/etc/hosts`中存在，或者可以通过`DNS`找到才行。\n\n\n\n\n","source":"_posts/存储服务之NFS.md","raw":"---\ntitle: 存储服务之NFS\ndate: 2019-08-08 15:00:35\ntags: Storage\ncategories: Storage\ncopyright: true\n---\n\n## NFS介绍\n[官方文档](http://nfs.sourceforge.net/nfs-howto/)\n\n> `NFS（Network File System）`即网络文件系统，它最大的功能就是通过`TCP/IP`网络共享资源。在`NFS`的应用中，本地`NFS`的客户端应用可以透明地读写位于远端`NFS`服务器上的文件，就像访问本地文件一样。\n\n>`NFS`客户端一般是应用服务器（比如`web`，负载均衡等），可以通过挂载的方式将`NFS`服务器端共享的目录挂载到`NFS`客户端本地的目录下。\n\n> 因为`NFS`支持的功能相当的多，而不同的功能都会使用不同的程序来启动，每启动一个功能就会启用一些端口来传输数据，因此，`NFS`的功能所对应的端口才没有固定住，而是随机取用一些未被使用的小于`1024`的端口来作为传输之用。但如此一来又造成了客户端想要连上服务器时的困扰，因为客户端得要知道服务器端的相关端口才能够进行连接。\n\n>因此就需要远程过程调用`(RPC)`的服务，`RPC`最主要的功能就是在指定每个`NFS`功能所对应的` port number`，并且回报给客户端，让客户端可以连接正确的端口上去。那`RPC`又是如何知道每个`NFS`的端口呢？这是因为当服务器在启动`NFS`时会随机取用数个端口，并主动的想`RPC`注册，因此`RPC`可以知道每个端口对应的`NFS`功能，然后`RPC`又是固定使用` port 111`来监听客户端的需求并回报给客户端正确的端口，所以当然可以让`NFS`的启动更为轻松愉快了。\n\n>`NFS`在文件传送过程中依赖与`RPC`（远程过程调用）协议。`NFS`本身是没有提供信息传送的协议和功能的，但是能够用过网络进行图片，视频，附件等分享功能。只要用到NFS的地方都需要启动`RPC`服务，不论是`NFS`的服务端还是客户端。\n\n>`NFS`和`RPC`的关系：可以理解为`NFS`是一个网络文件系统（比喻为租房的房主），而`RPC`是负责信息的传输（中介），客户端（相当于租房的租客）。\n\n### NFS网络文件系统存在的意义\n实现数据共享，数据保持一致。如图所示：\n![image.png](存储服务之NFS/01.png)\n\n### NFS网络文件系统工作方式\n>1、在`nfs`服务器端创建共享目录\n>2、通过`mount`网络挂载，将`NFS`服务端共享目录挂载到`NFS`客户端本地目录\n>3、`NFS`客户端在挂载目录上创建、删除、查看数据等操作，等价于在服务端进行的创建、删除、查看数据等操作。\n\n![01.png](存储服务之NFS/02.png)\n如上图所示，在`NFS`服务器端设置一个共享目录`/web`后，其他有权限访问`NFS`服务器端的客户端都可以将这个共享目录`/web`挂载到客户端本地的某个挂载点（其实就是一个目录，这个挂载点可以自己随意指定），不同的客户端的挂载点可以不相同。\n客户端正确挂载完毕后，就可以通过`NFS`客户端的挂载点所在的`/opt/www`目录查看到`NFS`服务端`/web`共享出来的目录下的所有数据。在客户端查看时，`NFS`服务端的`/web`目录就相当于客户端本地的磁盘分区或目录，几乎感觉不到使用上的区别，根据`NFS`服务器端授予的`NFS`共享权限以及共享目录的本地系统权限，只要在指定的`NFS`客户端操作挂载的`/opt/www`目录，就可以将数据轻松的存取到`NFS`服务器端上的`/web`目录中了。\n\n\n### NFS工作流程\n![02.png](存储服务之NFS/03.png)\n\n### RPC服务工作原理\n![image.png](存储服务之NFS/04.png)\n\n\n\n\n\n## NFS部署示例\n### 环境规划\n| 操作系统           | 角色                      | IP           | HOST            |\n| ------------------ | ------------------------- | ------------ | --------------- |\n| CentOS release 7.4 | NFS Server                | 192.168.1.31 | nfs-server.com  |\n| CentOS release 7.4 | NFS Client1 (web server1) | 192.168.1.32 | nfs-client1.com |\n| CentOS release 7.4 | NFS Client2 (web server2) | 192.168.1.33 | nfs-client2.com |\n\n> 这里`NFS`客户端是`web`服务器，站点目录挂载`NFS`服务端。\n> 实验环境关闭防火墙、selinux、时间同步等\n\n### 具体操作步骤\n**服务端安装配置**\n1）检查是否安装`NFS、RPC`服务\n```\n[root@nfs-server ~]# rpm -aq |egrep \"nfs-utils|rpcbind\"\nrpcbind-0.2.0-42.el7.x86_64\nnfs-utils-1.3.0-0.48.el7.x86_64\n\n# 如果没有安装则进行安装\n# yum -y install nfs-utils rpcbind\n```\n2）启动`rpc`和`nfs`服务\n```\n[root@nfs-server ~]# systemctl start rpcbind\n[root@nfs-server ~]# systemctl enable rpcbind\n[root@nfs-server ~]# systemctl start nfs\n```\n3）可以通过`rpcinfo -p localhost`可以查看到绑定了`nfs`\n```\n[root@nfs-server ~]# rpcinfo -p localhost\n   program vers proto   port  service\n    100000    4   tcp    111  portmapper\n    100000    3   tcp    111  portmapper\n    100000    2   tcp    111  portmapper\n    100000    4   udp    111  portmapper\n    100000    3   udp    111  portmapper\n    100000    2   udp    111  portmapper\n    100005    1   udp  20048  mountd\n    100005    1   tcp  20048  mountd\n    100005    2   udp  20048  mountd\n    100005    2   tcp  20048  mountd\n    100005    3   udp  20048  mountd\n    100005    3   tcp  20048  mountd\n    100024    1   udp  60358  status\n    100024    1   tcp  34912  status\n    100003    3   tcp   2049  nfs\n    100003    4   tcp   2049  nfs\n    100227    3   tcp   2049  nfs_acl\n    100003    3   udp   2049  nfs\n    100003    4   udp   2049  nfs\n    100227    3   udp   2049  nfs_acl\n    100021    1   udp  38577  nlockmgr\n    100021    3   udp  38577  nlockmgr\n    100021    4   udp  38577  nlockmgr\n    100021    1   tcp  42193  nlockmgr\n    100021    3   tcp  42193  nlockmgr\n    100021    4   tcp  42193  nlockmgr\n```\n4）配置共享目录并重启`nfs`\n```\n[root@nfs-server ~]# mkdir /web\n[root@nfs-server ~]# vim /etc/exports\n/web    192.168.1.0/24(rw,sync,no_root_squash)  #不压制root(当client端使用root挂载时，也有root权限)\n[root@nfs-server ~]# systemctl restart nfs\n[root@nfs-server ~]# exportfs -v\n/web          \t192.168.1.0/24(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)\n```\n\n**客户端挂载测试**\n1）创建挂载目录并进行挂载\n```\n[root@nfs-client1 ~]# mkdir /opt/www\n[root@nfs-client1 ~]# showmount -e 192.168.1.31    #查看服务器共享目录\nExport list for 192.168.1.31:\n/web 192.168.1.0/24\n[root@nfs-client1 ~]# mount -t nfs 192.168.1.31:/web /opt/www/\n[root@nfs-client1 ~]# df -h\n文件系统                 容量  已用  可用 已用% 挂载点\n/dev/mapper/centos-root   20G  3.6G   16G   19% /\ndevtmpfs                 473M     0  473M    0% /dev\ntmpfs                    489M     0  489M    0% /dev/shm\ntmpfs                    489M   14M  475M    3% /run\ntmpfs                    489M     0  489M    0% /sys/fs/cgroup\n/dev/sda1                497M  154M  344M   31% /boot\ntmpfs                     98M     0   98M    0% /run/user/0\n192.168.1.31:/web         20G  3.6G   16G   19% /opt/www\n```\n2）在`client1`上的`/opt/www`创建一个测试文件\n```\n[root@nfs-client1 ~]# echo \"client1 create test file\" >> /opt/www/client1.txt\n```\n3）回到`nfs`上进行查看\n```\n[root@nfs-server ~]# ll /web/\n总用量 4\n-rw-r--r-- 1 root root 25 8月   9 14:41 client1.txt\n```\n4）安装`nginx`并配置站点目录为`/opt/www`\n```\n[root@nfs-client1 ~]# yum -y install nginx\n[root@nfs-client1 ~]# vim /etc/nginx/nginx.conf\nserver {\n        listen       80 default_server;\n        listen       [::]:80 default_server;\n        server_name  _;\n        root         /opt/www;\n...\n[root@nfs-client1 ~]# systemctl start nginx\n```\n上面的步骤同样在`client2`上面操作。\n\n**在nfs服务端创建站点首页，访问client客户端测试**\n```\n[root@nfs-server ~]# ll /web/\n总用量 8\n-rw-r--r-- 1 root root 25 8月   9 14:41 client1.txt\n-rw-r--r-- 1 root root 25 8月   9 15:37 client2.txt\n\n[root@nfs-server ~]# echo \"<h1>NFS server</h1>\" >> /web/index.html    #nfs服务端共享目录创建首页文件\n[root@nfs-server ~]# curl 192.168.1.32\n<h1>NFS server</h1>\n[root@nfs-server ~]# \n[root@nfs-server ~]# curl 192.168.1.33\n<h1>NFS server</h1>\n\n[root@nfs-client1 ~]# ll /opt/www/    #nfs客户端1上查看\n总用量 12\n-rw-r--r-- 1 root root 25 8月   9 14:41 client1.txt\n-rw-r--r-- 1 root root 25 8月   9 15:37 client2.txt\n-rw-r--r-- 1 root root 20 8月   9 15:41 index.html\n\n[root@nfs-client2 ~]# ll /opt/www/    #nfs客户端2上查看\n总用量 12\n-rw-r--r-- 1 root root 25 8月   9 14:41 client1.txt\n-rw-r--r-- 1 root root 25 8月   9 15:37 client2.txt\n-rw-r--r-- 1 root root 20 8月   9 15:41 index.html\n```\n通过测试可以看出，客户端挂载后，就完全相当于自己的一个目录或者文件，在负载均衡架构中一般通过这种方式做共享存储。\n\n\n### NFS配置参数说明\n#### nfs共享参数及作用\n通过 `man exports`可以查看帮助手册\n\n共享参数|作用\n---:|:---\nrw\\*|读写权限\nro|只读权限\nroot_squash|当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)\nno_root_squash|当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(常用)\nall_squash|无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户(常用)\nno_all_squash|无论NFS客户端使用什么账户访问，都不进行压缩\nsync\\*|同时将数据写入到内存与硬盘中，保证不丢失数据\nasync|优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据\nanonuid\\*|配置all_squash使用,指定NFS的用户UID,必须存在系统\nanongid\\*|配置all_squash使用,指定NFS的用户GID,必须存在系统\n\n\n#### 配置实例说明\n```\n[root@nfs-server ~]# cat /etc/exports\n#/web    192.168.1.0/24(rw,sync,no_root_squash)  #不压制root(当client端使用root挂载时，也有root权限)\n/web    192.168.1.32(rw,sync,no_root_squash) 192.168.1.33(rw,sync,all_squash,anonuid=2000,anongid=2000)\n```\n>\\#[共享目录]&emsp;  [客户端地址1(权限)]&emsp;  [客户端地址2(权限)] \n>1、共享目录：每一行最前面是共享出来的目录，比如上面我要共享`/web`目录，那么此选项就可以直接写`/web`目录，这个目录可以依照不同的权限共享给不同的目录。\n>2、客户端地址：客户端地址能够设置一个网络，也可以是单个主机。参数：如上面的读写权限`rw`，同步更新`sync`等待。\n>>1、客户端地址可以使用完整的IP或者网络号，例如`192.168.1.33 `或`192.168.1.0/24`\n>>2、同样可以使用主机名，但是这个主机名必须要在`/etc/hosts`中存在，或者可以通过`DNS`找到才行。\n\n\n\n\n","slug":"存储服务之NFS","published":1,"updated":"2019-10-24T09:12:16.897Z","_id":"cjz3xyiof0009dstcam6n1ur0","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"NFS介绍\"><a href=\"#NFS介绍\" class=\"headerlink\" title=\"NFS介绍\"></a>NFS介绍</h2><p><a href=\"http://nfs.sourceforge.net/nfs-howto/\" target=\"_blank\" rel=\"noopener\">官方文档</a></p>\n<blockquote>\n<p><code>NFS（Network File System）</code>即网络文件系统，它最大的功能就是通过<code>TCP/IP</code>网络共享资源。在<code>NFS</code>的应用中，本地<code>NFS</code>的客户端应用可以透明地读写位于远端<code>NFS</code>服务器上的文件，就像访问本地文件一样。</p>\n</blockquote>\n<blockquote>\n<p><code>NFS</code>客户端一般是应用服务器（比如<code>web</code>，负载均衡等），可以通过挂载的方式将<code>NFS</code>服务器端共享的目录挂载到<code>NFS</code>客户端本地的目录下。</p>\n</blockquote>\n<blockquote>\n<p>因为<code>NFS</code>支持的功能相当的多，而不同的功能都会使用不同的程序来启动，每启动一个功能就会启用一些端口来传输数据，因此，<code>NFS</code>的功能所对应的端口才没有固定住，而是随机取用一些未被使用的小于<code>1024</code>的端口来作为传输之用。但如此一来又造成了客户端想要连上服务器时的困扰，因为客户端得要知道服务器端的相关端口才能够进行连接。</p>\n</blockquote>\n<blockquote>\n<p>因此就需要远程过程调用<code>(RPC)</code>的服务，<code>RPC</code>最主要的功能就是在指定每个<code>NFS</code>功能所对应的<code>port number</code>，并且回报给客户端，让客户端可以连接正确的端口上去。那<code>RPC</code>又是如何知道每个<code>NFS</code>的端口呢？这是因为当服务器在启动<code>NFS</code>时会随机取用数个端口，并主动的想<code>RPC</code>注册，因此<code>RPC</code>可以知道每个端口对应的<code>NFS</code>功能，然后<code>RPC</code>又是固定使用<code>port 111</code>来监听客户端的需求并回报给客户端正确的端口，所以当然可以让<code>NFS</code>的启动更为轻松愉快了。</p>\n</blockquote>\n<blockquote>\n<p><code>NFS</code>在文件传送过程中依赖与<code>RPC</code>（远程过程调用）协议。<code>NFS</code>本身是没有提供信息传送的协议和功能的，但是能够用过网络进行图片，视频，附件等分享功能。只要用到NFS的地方都需要启动<code>RPC</code>服务，不论是<code>NFS</code>的服务端还是客户端。</p>\n</blockquote>\n<blockquote>\n<p><code>NFS</code>和<code>RPC</code>的关系：可以理解为<code>NFS</code>是一个网络文件系统（比喻为租房的房主），而<code>RPC</code>是负责信息的传输（中介），客户端（相当于租房的租客）。</p>\n</blockquote>\n<h3 id=\"NFS网络文件系统存在的意义\"><a href=\"#NFS网络文件系统存在的意义\" class=\"headerlink\" title=\"NFS网络文件系统存在的意义\"></a>NFS网络文件系统存在的意义</h3><p>实现数据共享，数据保持一致。如图所示：<br><img src=\"/2019/08/08/存储服务之NFS/01.png\" alt=\"image.png\"></p>\n<h3 id=\"NFS网络文件系统工作方式\"><a href=\"#NFS网络文件系统工作方式\" class=\"headerlink\" title=\"NFS网络文件系统工作方式\"></a>NFS网络文件系统工作方式</h3><blockquote>\n<p>1、在<code>nfs</code>服务器端创建共享目录<br>2、通过<code>mount</code>网络挂载，将<code>NFS</code>服务端共享目录挂载到<code>NFS</code>客户端本地目录<br>3、<code>NFS</code>客户端在挂载目录上创建、删除、查看数据等操作，等价于在服务端进行的创建、删除、查看数据等操作。</p>\n</blockquote>\n<p><img src=\"/2019/08/08/存储服务之NFS/02.png\" alt=\"01.png\"><br>如上图所示，在<code>NFS</code>服务器端设置一个共享目录<code>/web</code>后，其他有权限访问<code>NFS</code>服务器端的客户端都可以将这个共享目录<code>/web</code>挂载到客户端本地的某个挂载点（其实就是一个目录，这个挂载点可以自己随意指定），不同的客户端的挂载点可以不相同。<br>客户端正确挂载完毕后，就可以通过<code>NFS</code>客户端的挂载点所在的<code>/opt/www</code>目录查看到<code>NFS</code>服务端<code>/web</code>共享出来的目录下的所有数据。在客户端查看时，<code>NFS</code>服务端的<code>/web</code>目录就相当于客户端本地的磁盘分区或目录，几乎感觉不到使用上的区别，根据<code>NFS</code>服务器端授予的<code>NFS</code>共享权限以及共享目录的本地系统权限，只要在指定的<code>NFS</code>客户端操作挂载的<code>/opt/www</code>目录，就可以将数据轻松的存取到<code>NFS</code>服务器端上的<code>/web</code>目录中了。</p>\n<h3 id=\"NFS工作流程\"><a href=\"#NFS工作流程\" class=\"headerlink\" title=\"NFS工作流程\"></a>NFS工作流程</h3><p><img src=\"/2019/08/08/存储服务之NFS/03.png\" alt=\"02.png\"></p>\n<h3 id=\"RPC服务工作原理\"><a href=\"#RPC服务工作原理\" class=\"headerlink\" title=\"RPC服务工作原理\"></a>RPC服务工作原理</h3><p><img src=\"/2019/08/08/存储服务之NFS/04.png\" alt=\"image.png\"></p>\n<h2 id=\"NFS部署示例\"><a href=\"#NFS部署示例\" class=\"headerlink\" title=\"NFS部署示例\"></a>NFS部署示例</h2><h3 id=\"环境规划\"><a href=\"#环境规划\" class=\"headerlink\" title=\"环境规划\"></a>环境规划</h3><table>\n<thead>\n<tr>\n<th>操作系统</th>\n<th>角色</th>\n<th>IP</th>\n<th>HOST</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CentOS release 7.4</td>\n<td>NFS Server</td>\n<td>192.168.1.31</td>\n<td>nfs-server.com</td>\n</tr>\n<tr>\n<td>CentOS release 7.4</td>\n<td>NFS Client1 (web server1)</td>\n<td>192.168.1.32</td>\n<td>nfs-client1.com</td>\n</tr>\n<tr>\n<td>CentOS release 7.4</td>\n<td>NFS Client2 (web server2)</td>\n<td>192.168.1.33</td>\n<td>nfs-client2.com</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>这里<code>NFS</code>客户端是<code>web</code>服务器，站点目录挂载<code>NFS</code>服务端。<br>实验环境关闭防火墙、selinux、时间同步等</p>\n</blockquote>\n<h3 id=\"具体操作步骤\"><a href=\"#具体操作步骤\" class=\"headerlink\" title=\"具体操作步骤\"></a>具体操作步骤</h3><p><strong>服务端安装配置</strong><br>1）检查是否安装<code>NFS、RPC</code>服务<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-server ~]# rpm -aq |egrep <span class=\"string\">\"nfs-utils|rpcbind\"</span></span><br><span class=\"line\">rpcbind<span class=\"number\">-0.2</span><span class=\"number\">.0</span><span class=\"number\">-42.</span>el7.x86_64</span><br><span class=\"line\">nfs-utils<span class=\"number\">-1.3</span><span class=\"number\">.0</span><span class=\"number\">-0.48</span>.el7.x86_64</span><br><span class=\"line\"></span><br><span class=\"line\"># 如果没有安装则进行安装</span><br><span class=\"line\"># yum -y install nfs-utils rpcbind</span><br></pre></td></tr></table></figure></p>\n<p>2）启动<code>rpc</code>和<code>nfs</code>服务<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># systemctl start rpcbind</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># systemctl enable rpcbind</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># systemctl start nfs</span></span><br></pre></td></tr></table></figure></p>\n<p>3）可以通过<code>rpcinfo -p localhost</code>可以查看到绑定了<code>nfs</code><br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># rpcinfo -p localhost</span></span><br><span class=\"line\">   program vers proto   port  service</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 4 </span>  tcp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 3 </span>  tcp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 2 </span>  tcp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 4 </span>  udp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 3 </span>  udp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 2 </span>  udp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 1 </span>  udp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 1 </span>  tcp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 2 </span>  udp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 2 </span>  tcp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 3 </span>  udp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 3 </span>  tcp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100024 </span>  <span class=\"number\"> 1 </span>  udp <span class=\"number\"> 60358 </span> status</span><br><span class=\"line\">   <span class=\"number\"> 100024 </span>  <span class=\"number\"> 1 </span>  tcp <span class=\"number\"> 34912 </span> status</span><br><span class=\"line\">   <span class=\"number\"> 100003 </span>  <span class=\"number\"> 3 </span>  tcp  <span class=\"number\"> 2049 </span> nfs</span><br><span class=\"line\">   <span class=\"number\"> 100003 </span>  <span class=\"number\"> 4 </span>  tcp  <span class=\"number\"> 2049 </span> nfs</span><br><span class=\"line\">   <span class=\"number\"> 100227 </span>  <span class=\"number\"> 3 </span>  tcp  <span class=\"number\"> 2049 </span> nfs_acl</span><br><span class=\"line\">   <span class=\"number\"> 100003 </span>  <span class=\"number\"> 3 </span>  udp  <span class=\"number\"> 2049 </span> nfs</span><br><span class=\"line\">   <span class=\"number\"> 100003 </span>  <span class=\"number\"> 4 </span>  udp  <span class=\"number\"> 2049 </span> nfs</span><br><span class=\"line\">   <span class=\"number\"> 100227 </span>  <span class=\"number\"> 3 </span>  udp  <span class=\"number\"> 2049 </span> nfs_acl</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 1 </span>  udp <span class=\"number\"> 38577 </span> nlockmgr</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 3 </span>  udp <span class=\"number\"> 38577 </span> nlockmgr</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 4 </span>  udp <span class=\"number\"> 38577 </span> nlockmgr</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 1 </span>  tcp <span class=\"number\"> 42193 </span> nlockmgr</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 3 </span>  tcp <span class=\"number\"> 42193 </span> nlockmgr</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 4 </span>  tcp <span class=\"number\"> 42193 </span> nlockmgr</span><br></pre></td></tr></table></figure></p>\n<p>4）配置共享目录并重启<code>nfs</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># mkdir /web</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># vim /etc/exports</span></span><br><span class=\"line\">/web    <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>(rw,sync,no_root_squash)  <span class=\"meta\">#不压制root(当client端使用root挂载时，也有root权限)</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># systemctl restart nfs</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># exportfs -v</span></span><br><span class=\"line\">/web          \t<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)</span><br></pre></td></tr></table></figure></p>\n<p><strong>客户端挂载测试</strong><br>1）创建挂载目录并进行挂载<br><figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-client1 ~]<span class=\"comment\"># mkdir /opt/www</span></span><br><span class=\"line\">[root@nfs-client1 ~]<span class=\"comment\"># showmount -e 192.168.1.31    #查看服务器共享目录</span></span><br><span class=\"line\">Export list <span class=\"keyword\">for</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span>:</span><br><span class=\"line\">/web <span class=\"number\">192.168</span>.<span class=\"number\">1.0</span>/<span class=\"number\">24</span></span><br><span class=\"line\">[root@nfs-client1 ~]<span class=\"comment\"># mount -t nfs 192.168.1.31:/web /opt/www/</span></span><br><span class=\"line\">[root@nfs-client1 ~]<span class=\"comment\"># df -h</span></span><br><span class=\"line\">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class=\"line\">/dev/mapper/centos-root   <span class=\"number\">20</span>G  <span class=\"number\">3.6</span>G   <span class=\"number\">16</span>G   <span class=\"number\">19</span>% <span class=\"regexp\">/</span></span><br><span class=\"line\"><span class=\"regexp\">devtmpfs                 473M     0  473M    0% /dev</span></span><br><span class=\"line\">tmpfs                    <span class=\"number\">489</span>M     <span class=\"number\">0</span>  <span class=\"number\">489</span>M    <span class=\"number\">0</span>% <span class=\"regexp\">/dev/shm</span></span><br><span class=\"line\">tmpfs                    <span class=\"number\">489</span>M   <span class=\"number\">14</span>M  <span class=\"number\">475</span>M    <span class=\"number\">3</span>% <span class=\"regexp\">/run</span></span><br><span class=\"line\"><span class=\"regexp\">tmpfs                    489M     0  489M    0% /sys</span><span class=\"regexp\">/fs/cgroup</span></span><br><span class=\"line\">/dev/sda1                <span class=\"number\">497</span>M  <span class=\"number\">154</span>M  <span class=\"number\">344</span>M   <span class=\"number\">31</span>% <span class=\"regexp\">/boot</span></span><br><span class=\"line\"><span class=\"regexp\">tmpfs                     98M     0   98M    0% /run</span><span class=\"regexp\">/user/</span><span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">192.168</span>.<span class=\"number\">1.31</span>:<span class=\"regexp\">/web         20G  3.6G   16G   19% /opt</span><span class=\"regexp\">/www</span></span><br></pre></td></tr></table></figure></p>\n<p>2）在<code>client1</code>上的<code>/opt/www</code>创建一个测试文件<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-client1 ~]<span class=\"meta\"># echo <span class=\"string\">\"client1 create test file\"</span> &gt;&gt; /opt/www/client1.txt</span></span><br></pre></td></tr></table></figure></p>\n<p>3）回到<code>nfs</code>上进行查看<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># ll /web/</span></span><br><span class=\"line\">总用量 4</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>14:41 client1.txt</span><br></pre></td></tr></table></figure></p>\n<p>4）安装<code>nginx</code>并配置站点目录为<code>/opt/www</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-client1 ~]# yum -y install nginx</span><br><span class=\"line\">[root@nfs-client1 ~]# vim /etc/nginx/nginx.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen       80 default_server;</span><br><span class=\"line\">        listen       [::]:80 default_server;</span><br><span class=\"line\">        server_name  _;</span><br><span class=\"line\">        root         /opt/www;</span><br><span class=\"line\"><span class=\"built_in\">..</span>.</span><br><span class=\"line\">[root@nfs-client1 ~]# systemctl start nginx</span><br></pre></td></tr></table></figure></p>\n<p>上面的步骤同样在<code>client2</code>上面操作。</p>\n<p><strong>在nfs服务端创建站点首页，访问client客户端测试</strong><br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># ll /web/</span></span><br><span class=\"line\">总用量 8</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>14:41 client1.txt</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>15:37 client2.txt</span><br><span class=\"line\"></span><br><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># echo \"&lt;h1&gt;NFS server&lt;/h1&gt;\" &gt;&gt; /web/index.html    #nfs服务端共享目录创建首页文件</span></span><br><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># curl 192.168.1.32</span></span><br><span class=\"line\">&lt;h1&gt;NFS server&lt;/h1&gt;</span><br><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># </span></span><br><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># curl 192.168.1.33</span></span><br><span class=\"line\">&lt;h1&gt;NFS server&lt;/h1&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@nfs-client1 ~]<span class=\"comment\"># ll /opt/www/    #nfs客户端1上查看</span></span><br><span class=\"line\">总用量 12</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>14:41 client1.txt</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>15:37 client2.txt</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 20 </span>8月  <span class=\"number\"> 9 </span>15:41 index.html</span><br><span class=\"line\"></span><br><span class=\"line\">[root@nfs-client2 ~]<span class=\"comment\"># ll /opt/www/    #nfs客户端2上查看</span></span><br><span class=\"line\">总用量 12</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>14:41 client1.txt</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>15:37 client2.txt</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 20 </span>8月  <span class=\"number\"> 9 </span>15:41 index.html</span><br></pre></td></tr></table></figure></p>\n<p>通过测试可以看出，客户端挂载后，就完全相当于自己的一个目录或者文件，在负载均衡架构中一般通过这种方式做共享存储。</p>\n<h3 id=\"NFS配置参数说明\"><a href=\"#NFS配置参数说明\" class=\"headerlink\" title=\"NFS配置参数说明\"></a>NFS配置参数说明</h3><h4 id=\"nfs共享参数及作用\"><a href=\"#nfs共享参数及作用\" class=\"headerlink\" title=\"nfs共享参数及作用\"></a>nfs共享参数及作用</h4><p>通过 <code>man exports</code>可以查看帮助手册</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:right\">共享参数</th>\n<th style=\"text-align:left\">作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:right\">rw*</td>\n<td style=\"text-align:left\">读写权限</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">ro</td>\n<td style=\"text-align:left\">只读权限</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">root_squash</td>\n<td style=\"text-align:left\">当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">no_root_squash</td>\n<td style=\"text-align:left\">当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(常用)</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">all_squash</td>\n<td style=\"text-align:left\">无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户(常用)</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">no_all_squash</td>\n<td style=\"text-align:left\">无论NFS客户端使用什么账户访问，都不进行压缩</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">sync*</td>\n<td style=\"text-align:left\">同时将数据写入到内存与硬盘中，保证不丢失数据</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">async</td>\n<td style=\"text-align:left\">优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">anonuid*</td>\n<td style=\"text-align:left\">配置all_squash使用,指定NFS的用户UID,必须存在系统</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">anongid*</td>\n<td style=\"text-align:left\">配置all_squash使用,指定NFS的用户GID,必须存在系统</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"配置实例说明\"><a href=\"#配置实例说明\" class=\"headerlink\" title=\"配置实例说明\"></a>配置实例说明</h4><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-server ~]# cat /etc/exports</span><br><span class=\"line\">#/web    <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>(rw,sync,no_root_squash)  #不压制root(当client端使用root挂载时，也有root权限)</span><br><span class=\"line\">/web    <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span>(rw,sync,no_root_squash) <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span>(rw,sync,all_squash,anonuid=<span class=\"number\">2000</span>,anongid=<span class=\"number\">2000</span>)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>#[共享目录]&emsp;  [客户端地址1(权限)]&emsp;  [客户端地址2(权限)]<br>1、共享目录：每一行最前面是共享出来的目录，比如上面我要共享<code>/web</code>目录，那么此选项就可以直接写<code>/web</code>目录，这个目录可以依照不同的权限共享给不同的目录。<br>2、客户端地址：客户端地址能够设置一个网络，也可以是单个主机。参数：如上面的读写权限<code>rw</code>，同步更新<code>sync</code>等待。</p>\n<blockquote>\n<p>1、客户端地址可以使用完整的IP或者网络号，例如<code>192.168.1.33</code>或<code>192.168.1.0/24</code><br>2、同样可以使用主机名，但是这个主机名必须要在<code>/etc/hosts</code>中存在，或者可以通过<code>DNS</code>找到才行。</p>\n</blockquote>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"NFS介绍\"><a href=\"#NFS介绍\" class=\"headerlink\" title=\"NFS介绍\"></a>NFS介绍</h2><p><a href=\"http://nfs.sourceforge.net/nfs-howto/\" target=\"_blank\" rel=\"noopener\">官方文档</a></p>\n<blockquote>\n<p><code>NFS（Network File System）</code>即网络文件系统，它最大的功能就是通过<code>TCP/IP</code>网络共享资源。在<code>NFS</code>的应用中，本地<code>NFS</code>的客户端应用可以透明地读写位于远端<code>NFS</code>服务器上的文件，就像访问本地文件一样。</p>\n</blockquote>\n<blockquote>\n<p><code>NFS</code>客户端一般是应用服务器（比如<code>web</code>，负载均衡等），可以通过挂载的方式将<code>NFS</code>服务器端共享的目录挂载到<code>NFS</code>客户端本地的目录下。</p>\n</blockquote>\n<blockquote>\n<p>因为<code>NFS</code>支持的功能相当的多，而不同的功能都会使用不同的程序来启动，每启动一个功能就会启用一些端口来传输数据，因此，<code>NFS</code>的功能所对应的端口才没有固定住，而是随机取用一些未被使用的小于<code>1024</code>的端口来作为传输之用。但如此一来又造成了客户端想要连上服务器时的困扰，因为客户端得要知道服务器端的相关端口才能够进行连接。</p>\n</blockquote>\n<blockquote>\n<p>因此就需要远程过程调用<code>(RPC)</code>的服务，<code>RPC</code>最主要的功能就是在指定每个<code>NFS</code>功能所对应的<code>port number</code>，并且回报给客户端，让客户端可以连接正确的端口上去。那<code>RPC</code>又是如何知道每个<code>NFS</code>的端口呢？这是因为当服务器在启动<code>NFS</code>时会随机取用数个端口，并主动的想<code>RPC</code>注册，因此<code>RPC</code>可以知道每个端口对应的<code>NFS</code>功能，然后<code>RPC</code>又是固定使用<code>port 111</code>来监听客户端的需求并回报给客户端正确的端口，所以当然可以让<code>NFS</code>的启动更为轻松愉快了。</p>\n</blockquote>\n<blockquote>\n<p><code>NFS</code>在文件传送过程中依赖与<code>RPC</code>（远程过程调用）协议。<code>NFS</code>本身是没有提供信息传送的协议和功能的，但是能够用过网络进行图片，视频，附件等分享功能。只要用到NFS的地方都需要启动<code>RPC</code>服务，不论是<code>NFS</code>的服务端还是客户端。</p>\n</blockquote>\n<blockquote>\n<p><code>NFS</code>和<code>RPC</code>的关系：可以理解为<code>NFS</code>是一个网络文件系统（比喻为租房的房主），而<code>RPC</code>是负责信息的传输（中介），客户端（相当于租房的租客）。</p>\n</blockquote>\n<h3 id=\"NFS网络文件系统存在的意义\"><a href=\"#NFS网络文件系统存在的意义\" class=\"headerlink\" title=\"NFS网络文件系统存在的意义\"></a>NFS网络文件系统存在的意义</h3><p>实现数据共享，数据保持一致。如图所示：<br><img src=\"/2019/08/08/存储服务之NFS/01.png\" alt=\"image.png\"></p>\n<h3 id=\"NFS网络文件系统工作方式\"><a href=\"#NFS网络文件系统工作方式\" class=\"headerlink\" title=\"NFS网络文件系统工作方式\"></a>NFS网络文件系统工作方式</h3><blockquote>\n<p>1、在<code>nfs</code>服务器端创建共享目录<br>2、通过<code>mount</code>网络挂载，将<code>NFS</code>服务端共享目录挂载到<code>NFS</code>客户端本地目录<br>3、<code>NFS</code>客户端在挂载目录上创建、删除、查看数据等操作，等价于在服务端进行的创建、删除、查看数据等操作。</p>\n</blockquote>\n<p><img src=\"/2019/08/08/存储服务之NFS/02.png\" alt=\"01.png\"><br>如上图所示，在<code>NFS</code>服务器端设置一个共享目录<code>/web</code>后，其他有权限访问<code>NFS</code>服务器端的客户端都可以将这个共享目录<code>/web</code>挂载到客户端本地的某个挂载点（其实就是一个目录，这个挂载点可以自己随意指定），不同的客户端的挂载点可以不相同。<br>客户端正确挂载完毕后，就可以通过<code>NFS</code>客户端的挂载点所在的<code>/opt/www</code>目录查看到<code>NFS</code>服务端<code>/web</code>共享出来的目录下的所有数据。在客户端查看时，<code>NFS</code>服务端的<code>/web</code>目录就相当于客户端本地的磁盘分区或目录，几乎感觉不到使用上的区别，根据<code>NFS</code>服务器端授予的<code>NFS</code>共享权限以及共享目录的本地系统权限，只要在指定的<code>NFS</code>客户端操作挂载的<code>/opt/www</code>目录，就可以将数据轻松的存取到<code>NFS</code>服务器端上的<code>/web</code>目录中了。</p>\n<h3 id=\"NFS工作流程\"><a href=\"#NFS工作流程\" class=\"headerlink\" title=\"NFS工作流程\"></a>NFS工作流程</h3><p><img src=\"/2019/08/08/存储服务之NFS/03.png\" alt=\"02.png\"></p>\n<h3 id=\"RPC服务工作原理\"><a href=\"#RPC服务工作原理\" class=\"headerlink\" title=\"RPC服务工作原理\"></a>RPC服务工作原理</h3><p><img src=\"/2019/08/08/存储服务之NFS/04.png\" alt=\"image.png\"></p>\n<h2 id=\"NFS部署示例\"><a href=\"#NFS部署示例\" class=\"headerlink\" title=\"NFS部署示例\"></a>NFS部署示例</h2><h3 id=\"环境规划\"><a href=\"#环境规划\" class=\"headerlink\" title=\"环境规划\"></a>环境规划</h3><table>\n<thead>\n<tr>\n<th>操作系统</th>\n<th>角色</th>\n<th>IP</th>\n<th>HOST</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CentOS release 7.4</td>\n<td>NFS Server</td>\n<td>192.168.1.31</td>\n<td>nfs-server.com</td>\n</tr>\n<tr>\n<td>CentOS release 7.4</td>\n<td>NFS Client1 (web server1)</td>\n<td>192.168.1.32</td>\n<td>nfs-client1.com</td>\n</tr>\n<tr>\n<td>CentOS release 7.4</td>\n<td>NFS Client2 (web server2)</td>\n<td>192.168.1.33</td>\n<td>nfs-client2.com</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>这里<code>NFS</code>客户端是<code>web</code>服务器，站点目录挂载<code>NFS</code>服务端。<br>实验环境关闭防火墙、selinux、时间同步等</p>\n</blockquote>\n<h3 id=\"具体操作步骤\"><a href=\"#具体操作步骤\" class=\"headerlink\" title=\"具体操作步骤\"></a>具体操作步骤</h3><p><strong>服务端安装配置</strong><br>1）检查是否安装<code>NFS、RPC</code>服务<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-server ~]# rpm -aq |egrep <span class=\"string\">\"nfs-utils|rpcbind\"</span></span><br><span class=\"line\">rpcbind<span class=\"number\">-0.2</span><span class=\"number\">.0</span><span class=\"number\">-42.</span>el7.x86_64</span><br><span class=\"line\">nfs-utils<span class=\"number\">-1.3</span><span class=\"number\">.0</span><span class=\"number\">-0.48</span>.el7.x86_64</span><br><span class=\"line\"></span><br><span class=\"line\"># 如果没有安装则进行安装</span><br><span class=\"line\"># yum -y install nfs-utils rpcbind</span><br></pre></td></tr></table></figure></p>\n<p>2）启动<code>rpc</code>和<code>nfs</code>服务<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># systemctl start rpcbind</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># systemctl enable rpcbind</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># systemctl start nfs</span></span><br></pre></td></tr></table></figure></p>\n<p>3）可以通过<code>rpcinfo -p localhost</code>可以查看到绑定了<code>nfs</code><br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># rpcinfo -p localhost</span></span><br><span class=\"line\">   program vers proto   port  service</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 4 </span>  tcp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 3 </span>  tcp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 2 </span>  tcp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 4 </span>  udp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 3 </span>  udp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100000 </span>  <span class=\"number\"> 2 </span>  udp   <span class=\"number\"> 111 </span> portmapper</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 1 </span>  udp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 1 </span>  tcp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 2 </span>  udp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 2 </span>  tcp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 3 </span>  udp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100005 </span>  <span class=\"number\"> 3 </span>  tcp <span class=\"number\"> 20048 </span> mountd</span><br><span class=\"line\">   <span class=\"number\"> 100024 </span>  <span class=\"number\"> 1 </span>  udp <span class=\"number\"> 60358 </span> status</span><br><span class=\"line\">   <span class=\"number\"> 100024 </span>  <span class=\"number\"> 1 </span>  tcp <span class=\"number\"> 34912 </span> status</span><br><span class=\"line\">   <span class=\"number\"> 100003 </span>  <span class=\"number\"> 3 </span>  tcp  <span class=\"number\"> 2049 </span> nfs</span><br><span class=\"line\">   <span class=\"number\"> 100003 </span>  <span class=\"number\"> 4 </span>  tcp  <span class=\"number\"> 2049 </span> nfs</span><br><span class=\"line\">   <span class=\"number\"> 100227 </span>  <span class=\"number\"> 3 </span>  tcp  <span class=\"number\"> 2049 </span> nfs_acl</span><br><span class=\"line\">   <span class=\"number\"> 100003 </span>  <span class=\"number\"> 3 </span>  udp  <span class=\"number\"> 2049 </span> nfs</span><br><span class=\"line\">   <span class=\"number\"> 100003 </span>  <span class=\"number\"> 4 </span>  udp  <span class=\"number\"> 2049 </span> nfs</span><br><span class=\"line\">   <span class=\"number\"> 100227 </span>  <span class=\"number\"> 3 </span>  udp  <span class=\"number\"> 2049 </span> nfs_acl</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 1 </span>  udp <span class=\"number\"> 38577 </span> nlockmgr</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 3 </span>  udp <span class=\"number\"> 38577 </span> nlockmgr</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 4 </span>  udp <span class=\"number\"> 38577 </span> nlockmgr</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 1 </span>  tcp <span class=\"number\"> 42193 </span> nlockmgr</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 3 </span>  tcp <span class=\"number\"> 42193 </span> nlockmgr</span><br><span class=\"line\">   <span class=\"number\"> 100021 </span>  <span class=\"number\"> 4 </span>  tcp <span class=\"number\"> 42193 </span> nlockmgr</span><br></pre></td></tr></table></figure></p>\n<p>4）配置共享目录并重启<code>nfs</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># mkdir /web</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># vim /etc/exports</span></span><br><span class=\"line\">/web    <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>(rw,sync,no_root_squash)  <span class=\"meta\">#不压制root(当client端使用root挂载时，也有root权限)</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># systemctl restart nfs</span></span><br><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-server ~]<span class=\"meta\"># exportfs -v</span></span><br><span class=\"line\">/web          \t<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)</span><br></pre></td></tr></table></figure></p>\n<p><strong>客户端挂载测试</strong><br>1）创建挂载目录并进行挂载<br><figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-client1 ~]<span class=\"comment\"># mkdir /opt/www</span></span><br><span class=\"line\">[root@nfs-client1 ~]<span class=\"comment\"># showmount -e 192.168.1.31    #查看服务器共享目录</span></span><br><span class=\"line\">Export list <span class=\"keyword\">for</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span>:</span><br><span class=\"line\">/web <span class=\"number\">192.168</span>.<span class=\"number\">1.0</span>/<span class=\"number\">24</span></span><br><span class=\"line\">[root@nfs-client1 ~]<span class=\"comment\"># mount -t nfs 192.168.1.31:/web /opt/www/</span></span><br><span class=\"line\">[root@nfs-client1 ~]<span class=\"comment\"># df -h</span></span><br><span class=\"line\">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class=\"line\">/dev/mapper/centos-root   <span class=\"number\">20</span>G  <span class=\"number\">3.6</span>G   <span class=\"number\">16</span>G   <span class=\"number\">19</span>% <span class=\"regexp\">/</span></span><br><span class=\"line\"><span class=\"regexp\">devtmpfs                 473M     0  473M    0% /dev</span></span><br><span class=\"line\">tmpfs                    <span class=\"number\">489</span>M     <span class=\"number\">0</span>  <span class=\"number\">489</span>M    <span class=\"number\">0</span>% <span class=\"regexp\">/dev/shm</span></span><br><span class=\"line\">tmpfs                    <span class=\"number\">489</span>M   <span class=\"number\">14</span>M  <span class=\"number\">475</span>M    <span class=\"number\">3</span>% <span class=\"regexp\">/run</span></span><br><span class=\"line\"><span class=\"regexp\">tmpfs                    489M     0  489M    0% /sys</span><span class=\"regexp\">/fs/cgroup</span></span><br><span class=\"line\">/dev/sda1                <span class=\"number\">497</span>M  <span class=\"number\">154</span>M  <span class=\"number\">344</span>M   <span class=\"number\">31</span>% <span class=\"regexp\">/boot</span></span><br><span class=\"line\"><span class=\"regexp\">tmpfs                     98M     0   98M    0% /run</span><span class=\"regexp\">/user/</span><span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">192.168</span>.<span class=\"number\">1.31</span>:<span class=\"regexp\">/web         20G  3.6G   16G   19% /opt</span><span class=\"regexp\">/www</span></span><br></pre></td></tr></table></figure></p>\n<p>2）在<code>client1</code>上的<code>/opt/www</code>创建一个测试文件<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@nfs</span>-client1 ~]<span class=\"meta\"># echo <span class=\"string\">\"client1 create test file\"</span> &gt;&gt; /opt/www/client1.txt</span></span><br></pre></td></tr></table></figure></p>\n<p>3）回到<code>nfs</code>上进行查看<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># ll /web/</span></span><br><span class=\"line\">总用量 4</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>14:41 client1.txt</span><br></pre></td></tr></table></figure></p>\n<p>4）安装<code>nginx</code>并配置站点目录为<code>/opt/www</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-client1 ~]# yum -y install nginx</span><br><span class=\"line\">[root@nfs-client1 ~]# vim /etc/nginx/nginx.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen       80 default_server;</span><br><span class=\"line\">        listen       [::]:80 default_server;</span><br><span class=\"line\">        server_name  _;</span><br><span class=\"line\">        root         /opt/www;</span><br><span class=\"line\"><span class=\"built_in\">..</span>.</span><br><span class=\"line\">[root@nfs-client1 ~]# systemctl start nginx</span><br></pre></td></tr></table></figure></p>\n<p>上面的步骤同样在<code>client2</code>上面操作。</p>\n<p><strong>在nfs服务端创建站点首页，访问client客户端测试</strong><br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># ll /web/</span></span><br><span class=\"line\">总用量 8</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>14:41 client1.txt</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>15:37 client2.txt</span><br><span class=\"line\"></span><br><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># echo \"&lt;h1&gt;NFS server&lt;/h1&gt;\" &gt;&gt; /web/index.html    #nfs服务端共享目录创建首页文件</span></span><br><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># curl 192.168.1.32</span></span><br><span class=\"line\">&lt;h1&gt;NFS server&lt;/h1&gt;</span><br><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># </span></span><br><span class=\"line\">[root@nfs-server ~]<span class=\"comment\"># curl 192.168.1.33</span></span><br><span class=\"line\">&lt;h1&gt;NFS server&lt;/h1&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@nfs-client1 ~]<span class=\"comment\"># ll /opt/www/    #nfs客户端1上查看</span></span><br><span class=\"line\">总用量 12</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>14:41 client1.txt</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>15:37 client2.txt</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 20 </span>8月  <span class=\"number\"> 9 </span>15:41 index.html</span><br><span class=\"line\"></span><br><span class=\"line\">[root@nfs-client2 ~]<span class=\"comment\"># ll /opt/www/    #nfs客户端2上查看</span></span><br><span class=\"line\">总用量 12</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>14:41 client1.txt</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 25 </span>8月  <span class=\"number\"> 9 </span>15:37 client2.txt</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>root root<span class=\"number\"> 20 </span>8月  <span class=\"number\"> 9 </span>15:41 index.html</span><br></pre></td></tr></table></figure></p>\n<p>通过测试可以看出，客户端挂载后，就完全相当于自己的一个目录或者文件，在负载均衡架构中一般通过这种方式做共享存储。</p>\n<h3 id=\"NFS配置参数说明\"><a href=\"#NFS配置参数说明\" class=\"headerlink\" title=\"NFS配置参数说明\"></a>NFS配置参数说明</h3><h4 id=\"nfs共享参数及作用\"><a href=\"#nfs共享参数及作用\" class=\"headerlink\" title=\"nfs共享参数及作用\"></a>nfs共享参数及作用</h4><p>通过 <code>man exports</code>可以查看帮助手册</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:right\">共享参数</th>\n<th style=\"text-align:left\">作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:right\">rw*</td>\n<td style=\"text-align:left\">读写权限</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">ro</td>\n<td style=\"text-align:left\">只读权限</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">root_squash</td>\n<td style=\"text-align:left\">当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">no_root_squash</td>\n<td style=\"text-align:left\">当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(常用)</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">all_squash</td>\n<td style=\"text-align:left\">无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户(常用)</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">no_all_squash</td>\n<td style=\"text-align:left\">无论NFS客户端使用什么账户访问，都不进行压缩</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">sync*</td>\n<td style=\"text-align:left\">同时将数据写入到内存与硬盘中，保证不丢失数据</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">async</td>\n<td style=\"text-align:left\">优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">anonuid*</td>\n<td style=\"text-align:left\">配置all_squash使用,指定NFS的用户UID,必须存在系统</td>\n</tr>\n<tr>\n<td style=\"text-align:right\">anongid*</td>\n<td style=\"text-align:left\">配置all_squash使用,指定NFS的用户GID,必须存在系统</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"配置实例说明\"><a href=\"#配置实例说明\" class=\"headerlink\" title=\"配置实例说明\"></a>配置实例说明</h4><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@nfs-server ~]# cat /etc/exports</span><br><span class=\"line\">#/web    <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>(rw,sync,no_root_squash)  #不压制root(当client端使用root挂载时，也有root权限)</span><br><span class=\"line\">/web    <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span>(rw,sync,no_root_squash) <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span>(rw,sync,all_squash,anonuid=<span class=\"number\">2000</span>,anongid=<span class=\"number\">2000</span>)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>#[共享目录]&emsp;  [客户端地址1(权限)]&emsp;  [客户端地址2(权限)]<br>1、共享目录：每一行最前面是共享出来的目录，比如上面我要共享<code>/web</code>目录，那么此选项就可以直接写<code>/web</code>目录，这个目录可以依照不同的权限共享给不同的目录。<br>2、客户端地址：客户端地址能够设置一个网络，也可以是单个主机。参数：如上面的读写权限<code>rw</code>，同步更新<code>sync</code>等待。</p>\n<blockquote>\n<p>1、客户端地址可以使用完整的IP或者网络号，例如<code>192.168.1.33</code>或<code>192.168.1.0/24</code><br>2、同样可以使用主机名，但是这个主机名必须要在<code>/etc/hosts</code>中存在，或者可以通过<code>DNS</code>找到才行。</p>\n</blockquote>\n</blockquote>\n"},{"title":"ELK快速入门一-基本部署","date":"2019-07-05T04:25:22.000Z","copyright":true,"_content":"\n\n\n## ELK简介\n>什么是ELK？通俗来讲，ELK是由Elasticsearch、Logstash、Kibana 三个开源软件组成的一个组合体，这三个软件当中，每个软件用于完成不同的功能，ELK又称ELKstack，官网 https://www.elastic.co/ ， ELK主要优点有如下几个：\n>1、处理方式灵活：elasticsearch是实时全文索引，具有强大的搜索功能\n>2、配置相对简单：elasticsearch全部使用JSON接口，logstash使用模块配置，kibana的配置文件部分更简单\n>3、检索性能高：基于优秀的设计，虽然每次查询都是实时，但是也可以达到百亿级数据的查询秒级响应\n>4、集群线性扩展：elasticsearch和logstash都可以灵活线性扩展\n>5、前端操作绚丽：kibana的前端设计比较绚丽，而且操作简单\n\n### Elasticsearch\n>`elasticsearch`是一个高度可扩展全文搜索和分析引擎，基于` Apache Lucene` 构建，能对大容量的数据进行接近实时的存储、搜索和分析操作，可以处理大规模日志数据，比如`Nginx`、`Tomcat`、系统日志等功能。\n\n### Logstash\n>数据收集引擎。它支持动态的从各种数据源搜集数据，并对数据进行过滤、分析、丰富、统一格式等操作，然后存储到用户指定的位置；支持普通`log`、自定义`json`格式的日志解析。\n\n### Kibana\n>数据分析和可视化平台。通常与 `Elasticsearch` 配合使用，对其中数据进行搜索、分析和以统计图表的方式展示。\n\n\n\n\n## ELK部署环境准备\n> 这里实验所使用系统`CentOS 7.4 x86_64`，服务器信息如下。并关闭防火墙和`selinux`，及`host`绑定等。本文所使用所有的软件包 [下载](https://pan.baidu.com/s/1ighWPeYVqK6AGZQn55Y_pw)  提取码：`ow1b`\n\n| IPAddr       | HostName               | Mem  \n| ------------ | ---------------------- | ---- \n| 192.168.1.31 | linux-elk1.exmaple.com | 3G   \n| 192.168.1.32 | linux-elk2.exmaple.com | 3G   \n\n```\nepel源配置\n# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n```\n\n## Elasticsearch部署\n>因为`elasticsearch`服务运行需要`java`环境，因此两台`elasticsearch`服务器需要安装`java`环境。\n\n\n### 安装JDK\n>`centos7`默认是安装了`jdk`，如果需要安装高版本可以使用一下步骤，这里使用下面的yum安装`jdk 1.8.0_211` 。注意：两个节点都要安装。\n\n```\n方法一：yum安装下载好的JDK包，将下载好的软件包上传到服务器进行安装，首先卸载自带的jdk；再进行安装。\n下载地址：https://pan.baidu.com/s/1VK1iCnvouppZ06jsVBOaRw  提取码：lofc\n\n[root@linux-elk1 ~]# rpm -qa |grep jdk |xargs yum -y remove {}\\;\n[root@linux-elk1 ~]# yum -y localinstall jdk-8u211-linux-x64.rpm\n[root@linux-elk1 ~]# java -version\njava version \"1.8.0_211\"\nJava(TM) SE Runtime Environment (build 1.8.0_211-b12)\nJava HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)\n\n方法二：源码安装JDK，将下载的软件包上传到服务器进行安装。\n下载地址：https://pan.baidu.com/s/1AAPyPzhdclNNCb0m6ooVYQ  提取码：x18u\n\n[root@linux-elk1 ~]# tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/\n[root@linux-elk1 ~]# ln -s /usr/local/jdk1.8.0_211 /usr/local/java\n[root@linux-elk1 ~]# sed -i.ori '$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile\n[root@linux-elk1 ~]# source /etc/profile\n[root@linux-elk1 ~]# java -version\njava version \"1.8.0_211\"\nJava(TM) SE Runtime Environment (build 1.8.0_211-b12)\nJava HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)\n```\n\n\n### 安装Elasticsearch\n> 两台节点都需要安装elasticsearch，使用yum安装会很慢，所以先下载下来传到服务器进行安装，官网下载地址：https://www.elastic.co/cn/downloads/past-releases#elasticsearch\n> 本文所使用的包下载：https://pan.baidu.com/s/1djYOs3PQjtq16VkPMETAWg  提取码：b15v\n\n```\n将下载的elasticsearch包上传到服务器进行安装。\n[root@linux-elk1 ~]# yum -y localinstall elasticsearch-6.8.1.rpm\n[root@linux-elk2 ~]# yum -y localinstall elasticsearch-6.8.1.rpm\n\n\n配置elasticsearch，linux-elk2配置一个相同的节点，通过组播进行通信，如果无法通过组播查询，修改成单播即可。\n[root@linux-elk1 ~]# vim /etc/elasticsearch/elasticsearch.yml\ncluster.name: ELK-Cluster    #ELK的集群名称，名称相同即属于是同一个集群\nnode.name: elk-node1    #本机在集群内的节点名称\npath.data: /elk/data    #数据存放目录\npath.logs: /elk/logs    #日志保存目录\nbootstrap.memory_lock: true    #服务启动的时候锁定足够的内存，防止数据写入swap\nnetwork.host: 192.168.1.31    #监听的IP地址\nhttp.port: 9200    #服务监听的端口\ndiscovery.zen.ping.unicast.hosts: [\"192.168.1.31\", \"192.168.1.32\"]    #单播配置一台即可\n\n\n修改内存限制，内存锁定需要进行配置需要2g以上内存，否则会导致无法启动elasticsearch。\n[root@linux-elk1 ~]# vim /usr/lib/systemd/system/elasticsearch.service\n# 在[Service]下加入下面这行内容\nLimitMEMLOCK=infinity\n[root@linux-elk1 ~]# systemctl daemon-reload\n[root@linux-elk1 ~]# vim /etc/elasticsearch/jvm.options\n-Xms2g\n-Xmx2g     #最小和最大内存限制，为什么最小和最大设置一样大？参考：https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html\n\n\n创建数据目录和日志目录及权限修改\n[root@linux-elk1 ~]# mkdir -p /elk/{data,logs}\n[root@linux-elk1 ~]# chown elasticsearch.elasticsearch /elk/ -R\n\n\n启动elasticsearch及检查端口是否处于监听状态\n[root@linux-elk1 ~]# systemctl start elasticsearch\n[root@linux-elk1 ~]# netstat -nltup |grep java\ntcp6       0      0 192.168.1.31:9200       :::*                    LISTEN      12887/java          \ntcp6       0      0 192.168.1.31:9300       :::*                    LISTEN      12887/java\n\n\n\n将配置文件copy到linux-elk2上面并进行修改，配置启动等。\n[root@linux-elk1 ~]# scp /etc/elasticsearch/elasticsearch.yml 192.168.1.32:/etc/elasticsearch/elasticsearch.yml\n[root@linux-elk2 ~]# grep ^[a-Z] /etc/elasticsearch/elasticsearch.yml \ncluster.name: ELK-Cluster\nnode.name: elk-node2\npath.data: /elk/data\npath.logs: /elk/logs\nbootstrap.memory_lock: true\nnetwork.host: 192.168.1.32\nhttp.port: 9200\ndiscovery.zen.ping.unicast.hosts: [\"192.168.1.31\", \"192.168.1.32\"]\n[root@linux-elk2 ~]# vim /usr/lib/systemd/system/elasticsearch.service\n# 在[Service]下加入下面这行内容\nLimitMEMLOCK=infinity\n[root@linux-elk2 ~]# systemctl daemon-reload\n[root@linux-elk2 ~]# vim /etc/elasticsearch/jvm.options\n-Xms2g\n-Xmx2g\n[root@linux-elk2 ~]# mkdir -p /elk/{data,logs}\n[root@linux-elk2 ~]# chown elasticsearch.elasticsearch /elk/ -R\n[root@linux-elk2 ~]# systemctl start elasticsearch\n[root@linux-elk2 ~]#  netstat -nltup |grep java\ntcp6       0      0 192.168.1.32:9200       :::*                    LISTEN      18667/java          \ntcp6       0      0 192.168.1.32:9300       :::*                    LISTEN      18667/java \n```\n通过浏览器访问`elasticsearch`端口\n![elk01.png](ELK快速入门一-基本部署/elk01.png)\n![elk02.png](ELK快速入门一-基本部署/elk02.png)\n\n\n\n\n#### 监控elasticsearch集群状态\n>通过shell命令获取集群状态，这里获取到的是一个json格式的返回值，例如对status进行分析，如果等于green(绿色)就是运行在正常，等于yellow(黄色)表示副本分片丢失，red(红色)表示主分片丢失。\n```\n[root@linux-elk1 ~]# curl http://192.168.1.31:9200/_cluster/health?pretty=true\n{\n  \"cluster_name\" : \"ELK-Cluster\",\n  \"status\" : \"green\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 2,\n  \"number_of_data_nodes\" : 2,\n  \"active_primary_shards\" : 0,\n  \"active_shards\" : 0,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 0,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 100.0\n}\n\n[root@linux-elk1 ~]# curl http://192.168.1.32:9200/_cluster/health?pretty=true\n{\n  \"cluster_name\" : \"ELK-Cluster\",\n  \"status\" : \"green\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 2,\n  \"number_of_data_nodes\" : 2,\n  \"active_primary_shards\" : 0,\n  \"active_shards\" : 0,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 0,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 100.0\n}\n```\n\n\n#### 安装elasticsearch插件head\n>我们不可能经常通过命令来查看集群的信息，所以就使用到了插件 --`head`。件是为了完成不同的功能，官方提供了一些插件但大部分是收费的，另外也有一些开发爱好者提供的插件，可以实现对`elasticsearch`集群的状态监控与管理配置等功能。\n>head：主要用来做集群管理的插件\n>下载地址：https://github.com/mobz/elasticsearch-head\n\n1）安装\n```\n# 安装npm和git\n[root@linux-elk1 ~]# yum -y install npm git\n\n# 安装elasticsearch-head插件\n[root@linux-elk1 ~]# cd /usr/local/src/\n[root@linux-elk1 src]# git clone git://github.com/mobz/elasticsearch-head.git\n[root@linux-elk1 src]# cd elasticsearch-head/\n[root@linux-elk1 elasticsearch-head]# npm install grunt -save --registry=https://registry.npm.taobao.org\n[root@linux-elk1 elasticsearch-head]# ll node_modules/grunt    #确定该目录有生成文件\n总用量 24\ndrwxr-xr-x. 2 root root   19 4月   6 2016 bin\n-rw-r--r--. 1 root root 7111 4月   6 2016 CHANGELOG\ndrwxr-xr-x. 4 root root   47 7月   4 09:21 lib\n-rw-r--r--. 1 root root 1592 3月  23 2016 LICENSE\ndrwxr-xr-x. 5 root root   50 7月   4 09:21 node_modules\n-rw-r--r--. 1 root root 4108 7月   4 09:21 package.json\n-rw-r--r--. 1 root root  878 2月  12 2016 README.md\n[root@linux-elk1 elasticsearch-head]# npm install --registry=https://registry.npm.taobao.org    #执行安装\n[root@linux-elk1 elasticsearch-head]# npm run start &    #后台启动服务\n[root@linux-elk1 ~]# ss -nlt |grep 9100\nLISTEN     0      128          *:9100                     *:* \n\n#------------------------补充说明------------------------\n由于上面npm安装时候超级慢，使用taobao源同样慢，这里将已安装的打成了包，可以直接下载使用即可\n下载地址：https://pan.baidu.com/s/16zDlecKVfmkEeInPcRx9NQ   提取码：h890\n[root@linux-elk1 ~]# yum -y install npm\n[root@linux-elk1 ~]# cd /usr/local/src/\n[root@linux-elk1 src]# ls\nelasticsearch-head.tar.gz\n[root@linux-elk1 src]# tar xvzf elasticsearch-head.tar.gz\n[root@linux-elk1 src]# cd elasticsearch-head/\n[root@linux-elk1 elasticsearch-head]# npm run start &\n#--------------------------------------------------------\n\n# 修改elasticsearch服务配置文件，开启跨域访问支持，然后重启elasticsearch服务\n[root@linux-elk1 ~]# vim /etc/elasticsearch/elasticsearch.yml\nhttp.cors.enabled: true     #最下方添加\nhttp.cors.allow-origin: \"*\"\n```\n\n为了方便管理`elasticsearch-head`插件，编写一个启动脚本\n```\n[root@linux-elk1 ~]# vim /usr/bin/elasticsearch-head\n#!/bin/bash\n#desc: elasticsearch-head service manager\n#date: 2019\n\ndata=\"cd /usr/local/src/elasticsearch-head/; nohup npm run start > /dev/null 2>&1 & \"\n\nfunction START (){\n    eval $data && echo -e \"elasticsearch-head start\\033[32m     ok\\033[0m\"\n}\n\nfunction STOP (){\n    ps -ef |grep grunt |grep -v \"grep\" |awk '{print $2}' |xargs kill -s 9 > /dev/null && echo -e \"elasticsearch-head stop\\033[32m      ok\\033[0m\"\n}\n\ncase \"$1\" in\n    start)\n        START\n        ;;\n    stop)\n        STOP\n        ;;\n    restart)\n        STOP\n        sleep 3\n        START\n        ;;\n    *)\n        echo \"Usage: elasticsearch-head (start|stop|restart)\"\n        ;;\nesac\n\n[root@linux-elk1 ~]# chmod +x /usr/bin/elasticsearch-head\n```\n\n\n2）浏览器访问`9100端口`，将连接地址修改为`elasticsearch`地址。\n![elk03.png](ELK快速入门一-基本部署/elk03.png)\n![elk04.png](ELK快速入门一-基本部署/elk04.png)\n\n3）测试提交数据\n![elk05.png](ELK快速入门一-基本部署/elk05.png)\n\n4）验证索引是否存在\n![elk06.png](ELK快速入门一-基本部署/elk06.png)\n\n5）查看数据\n![elk07.png](ELK快速入门一-基本部署/elk07.png)\n\n6）Master和Slave的区别：\n>`Master`的职责：\n>统计各`node`节点状态信息、集群状态信息统计、索引的创建和删除、索引分配的管理、关闭`node`节点等\n>`Savle`的职责：\n>同步数据、等待机会称为`Master`\n\n\n\n## Logstash部署\n>Logstash 是一个开源的数据收集引擎，可以水平伸缩，而且logstash是整个ELK当中拥有最多插件的一个组件，其可以接收来自不同来源的数据并同意输出到指定的且可以是多个不同目的地。官网下载地址：https://www.elastic.co/cn/downloads/past-releases#logstash\n\n### 安装logstash\n```\n[root@linux-elk1 ~]# wget https://artifacts.elastic.co/downloads/logstash/logstash-6.8.1.rpm\n[root@linux-elk1 ~]# yum -y localinstall logstash-6.8.1.rpm\n```\n### 测试logstash是否正常\n1）测试标准输入输出\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -e 'input { stdin {} } output { stdout { codec => rubydebug} }'  \nhello world    #输入\n\n{\n      \"@version\" => \"1\",    #事件版本号，一个事件就是一个ruby对象\n    \"@timestamp\" => 2019-07-04T04:30:35.106Z,    #当前事件发生的事件\n          \"host\" => \"linux-elk1.exmaple.com\",    #标记事件发生在哪里\n       \"message\" => \"hello world\"    #消息的具体内容\n}\n```\n2）测试输出到文件\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash   -e 'input { stdin{} } output { file { path => \"/tmp/log-%{+YYYY.MM.dd}messages.gz\"}}'\nhello world   #输入\n[INFO ] 2019-07-04 17:33:06.065 [[main]>worker0] file - Opening file {:path=>\"/tmp/log-2019.07.04messages.gz\"}\n\n[root@linux-elk1 ~]# tail /tmp/log-2019.07.04messages.gz \n{\"message\":\"hello world\",\"@version\":\"1\",\"host\":\"linux-elk1.exmaple.com\",\"@timestamp\":\"2019-07-04T09:33:05.698Z\"}\n```\n3）测试输出到elasticsearch\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash   -e 'input {  stdin{} } output { elasticsearch {hosts => [\"192.168.1.31:9200\"] index => \"mytest-%{+YYYY.MM.dd}\" }}'\n```\n4）elasticsearch服务器验证收到数据\n```\n[root@linux-elk1 ~]# ll /elk/data/nodes/0/indices/\n总用量 0\ndrwxr-xr-x. 8 elasticsearch elasticsearch 65 7月   4 17:23 4jaihRq6Qu6NQWVxbuRQZg\ndrwxr-xr-x. 8 elasticsearch elasticsearch 65 7月   4 17:22 kkd_RCldSeaCX3y1XKzdgA\n```\n![elk08.png](ELK快速入门一-基本部署/elk08.png)\n\n\n\n\n## kibana部署\n>`Kibana`是一个通过调用`elasticsearch`服务器进行图形化展示搜索结果的开源项目。官网下载地址：https://www.elastic.co/cn/downloads/past-releases#kibana\n\n### 安装kibana\n```\n[root@linux-elk1 ~]# wget https://artifacts.elastic.co/downloads/kibana/kibana-6.8.1-x86_64.rpm\n[root@linux-elk1 ~]# yum -y localinstall kibana-6.8.1-x86_64.rpm\n[root@linux-elk1 ~]# vim /etc/kibana/kibana.yml \n[root@linux-elk1 ~]# grep ^[a-Z] /etc/kibana/kibana.yml \nserver.port: 5601    #监听端口\nserver.host: \"192.168.1.31\"    #监听地址\nelasticsearch.hosts: [\"http://192.168.1.31:9200\"]    #elasticsearch服务器地址\ni18n.locale: \"zh-CN\"    #修改为中文\n```\n### 启动kibana并验证\n```\n[root@linux-elk1 ~]# systemctl start kibana\n[root@linux-elk1 ~]# systemctl enable kibana\n[root@linux-elk1 ~]# ss -nlt  |grep 5601\nLISTEN     0      128    192.168.1.31:5601                     *:*\n```\n### 查看状态\n![elk09.png](ELK快速入门一-基本部署/elk09.png)\n\n\n\n\n## 通过logstash收集系统message日志\n>说明：通过`logstash`收集别的日志文件，前提需要`logstash`用户对被收集的日志文件有读的权限并对写入的文件有写的权限\n\n1）配置`logstash`配置文件\n```\n[root@linux-elk1 ~]# vim /etc/logstash/conf.d/system-log.conf\ninput {\n    file {\n        path => \"/var/log/messages\"    #日志路径\n        type => \"systemlog\"            #类型，自定义，在进行多个日志收集存储时可以通过该项进行判断输出\n        start_position => \"beginning\"        #logstash 从什么位置开始读取文件数据，默认是结束位置，也就是说 logstash 进程会以类似 tail -F 的形式运行。如果你是要导入原有数据，把这个设定改成 \"beginning\"，logstash 进程就从头开始读取，类似 less +F 的形式运行。\n\t\tstat_interval => \"2\"    #logstash 每隔多久检查一次被监听文件状态（是否有更新），默认是 1 秒\n    }\n}\n\noutput {\n    elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]        #elasticsearch服务器地址\n        index => \"logstash-%{type}-%{+YYYY.MM.dd}\"    #索引名称\n    }\n}\n```\n2）检测配置文件语法是否有错误\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system-log.conf -t    #检测配置文件是否有语法错误\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-05 10:09:59.423 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n[INFO ] 2019-07-05 10:10:27.993 [LogStash::Runner] runner - Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash\n```\n3）修改日志文件的权限并重启`logstash`\n```\n[root@linux-elk1 ~]# ll /var/log/messages     \n-rw-------. 1 root root 786219 7月   5 10:10 /var/log/messages\n#这里可以看到该日志文件是600权限，而elasticsearch是运行在elasticsearch用户下，这样elasticsearch是无法收集日志的。所以这里需要更改日志的权限，否则会报权限拒绝的错误。在日志中查看/var/log/logstash/logstash-plain.log 是否有错误。\n[root@linux-elk1 ~]# chmod 644 /var/log/messages\n[root@linux-elk1 ~]# systemctl  restart logstash\n```\n4）elasticsearch界面查看并查询\n![elk10.png](ELK快速入门一-基本部署/elk10.png)\n![elk11.png](ELK快速入门一-基本部署/elk11.png)\n5）kibana界面创建索引并查看\n![elk12.png](ELK快速入门一-基本部署/elk12.png)\n![elk13.png](ELK快速入门一-基本部署/elk13.png)\n![elk14.png](ELK快速入门一-基本部署/elk14.png)\n![elk15.png](ELK快速入门一-基本部署/elk15.png)\n\n\n\n","source":"_posts/ELK快速入门一-基本部署.md","raw":"---\ntitle: ELK快速入门一-基本部署\ndate: 2019-07-05 12:25:22\ntags: ELK\ncategories: ELK\ncopyright: true\n---\n\n\n\n## ELK简介\n>什么是ELK？通俗来讲，ELK是由Elasticsearch、Logstash、Kibana 三个开源软件组成的一个组合体，这三个软件当中，每个软件用于完成不同的功能，ELK又称ELKstack，官网 https://www.elastic.co/ ， ELK主要优点有如下几个：\n>1、处理方式灵活：elasticsearch是实时全文索引，具有强大的搜索功能\n>2、配置相对简单：elasticsearch全部使用JSON接口，logstash使用模块配置，kibana的配置文件部分更简单\n>3、检索性能高：基于优秀的设计，虽然每次查询都是实时，但是也可以达到百亿级数据的查询秒级响应\n>4、集群线性扩展：elasticsearch和logstash都可以灵活线性扩展\n>5、前端操作绚丽：kibana的前端设计比较绚丽，而且操作简单\n\n### Elasticsearch\n>`elasticsearch`是一个高度可扩展全文搜索和分析引擎，基于` Apache Lucene` 构建，能对大容量的数据进行接近实时的存储、搜索和分析操作，可以处理大规模日志数据，比如`Nginx`、`Tomcat`、系统日志等功能。\n\n### Logstash\n>数据收集引擎。它支持动态的从各种数据源搜集数据，并对数据进行过滤、分析、丰富、统一格式等操作，然后存储到用户指定的位置；支持普通`log`、自定义`json`格式的日志解析。\n\n### Kibana\n>数据分析和可视化平台。通常与 `Elasticsearch` 配合使用，对其中数据进行搜索、分析和以统计图表的方式展示。\n\n\n\n\n## ELK部署环境准备\n> 这里实验所使用系统`CentOS 7.4 x86_64`，服务器信息如下。并关闭防火墙和`selinux`，及`host`绑定等。本文所使用所有的软件包 [下载](https://pan.baidu.com/s/1ighWPeYVqK6AGZQn55Y_pw)  提取码：`ow1b`\n\n| IPAddr       | HostName               | Mem  \n| ------------ | ---------------------- | ---- \n| 192.168.1.31 | linux-elk1.exmaple.com | 3G   \n| 192.168.1.32 | linux-elk2.exmaple.com | 3G   \n\n```\nepel源配置\n# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n```\n\n## Elasticsearch部署\n>因为`elasticsearch`服务运行需要`java`环境，因此两台`elasticsearch`服务器需要安装`java`环境。\n\n\n### 安装JDK\n>`centos7`默认是安装了`jdk`，如果需要安装高版本可以使用一下步骤，这里使用下面的yum安装`jdk 1.8.0_211` 。注意：两个节点都要安装。\n\n```\n方法一：yum安装下载好的JDK包，将下载好的软件包上传到服务器进行安装，首先卸载自带的jdk；再进行安装。\n下载地址：https://pan.baidu.com/s/1VK1iCnvouppZ06jsVBOaRw  提取码：lofc\n\n[root@linux-elk1 ~]# rpm -qa |grep jdk |xargs yum -y remove {}\\;\n[root@linux-elk1 ~]# yum -y localinstall jdk-8u211-linux-x64.rpm\n[root@linux-elk1 ~]# java -version\njava version \"1.8.0_211\"\nJava(TM) SE Runtime Environment (build 1.8.0_211-b12)\nJava HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)\n\n方法二：源码安装JDK，将下载的软件包上传到服务器进行安装。\n下载地址：https://pan.baidu.com/s/1AAPyPzhdclNNCb0m6ooVYQ  提取码：x18u\n\n[root@linux-elk1 ~]# tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/\n[root@linux-elk1 ~]# ln -s /usr/local/jdk1.8.0_211 /usr/local/java\n[root@linux-elk1 ~]# sed -i.ori '$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile\n[root@linux-elk1 ~]# source /etc/profile\n[root@linux-elk1 ~]# java -version\njava version \"1.8.0_211\"\nJava(TM) SE Runtime Environment (build 1.8.0_211-b12)\nJava HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)\n```\n\n\n### 安装Elasticsearch\n> 两台节点都需要安装elasticsearch，使用yum安装会很慢，所以先下载下来传到服务器进行安装，官网下载地址：https://www.elastic.co/cn/downloads/past-releases#elasticsearch\n> 本文所使用的包下载：https://pan.baidu.com/s/1djYOs3PQjtq16VkPMETAWg  提取码：b15v\n\n```\n将下载的elasticsearch包上传到服务器进行安装。\n[root@linux-elk1 ~]# yum -y localinstall elasticsearch-6.8.1.rpm\n[root@linux-elk2 ~]# yum -y localinstall elasticsearch-6.8.1.rpm\n\n\n配置elasticsearch，linux-elk2配置一个相同的节点，通过组播进行通信，如果无法通过组播查询，修改成单播即可。\n[root@linux-elk1 ~]# vim /etc/elasticsearch/elasticsearch.yml\ncluster.name: ELK-Cluster    #ELK的集群名称，名称相同即属于是同一个集群\nnode.name: elk-node1    #本机在集群内的节点名称\npath.data: /elk/data    #数据存放目录\npath.logs: /elk/logs    #日志保存目录\nbootstrap.memory_lock: true    #服务启动的时候锁定足够的内存，防止数据写入swap\nnetwork.host: 192.168.1.31    #监听的IP地址\nhttp.port: 9200    #服务监听的端口\ndiscovery.zen.ping.unicast.hosts: [\"192.168.1.31\", \"192.168.1.32\"]    #单播配置一台即可\n\n\n修改内存限制，内存锁定需要进行配置需要2g以上内存，否则会导致无法启动elasticsearch。\n[root@linux-elk1 ~]# vim /usr/lib/systemd/system/elasticsearch.service\n# 在[Service]下加入下面这行内容\nLimitMEMLOCK=infinity\n[root@linux-elk1 ~]# systemctl daemon-reload\n[root@linux-elk1 ~]# vim /etc/elasticsearch/jvm.options\n-Xms2g\n-Xmx2g     #最小和最大内存限制，为什么最小和最大设置一样大？参考：https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html\n\n\n创建数据目录和日志目录及权限修改\n[root@linux-elk1 ~]# mkdir -p /elk/{data,logs}\n[root@linux-elk1 ~]# chown elasticsearch.elasticsearch /elk/ -R\n\n\n启动elasticsearch及检查端口是否处于监听状态\n[root@linux-elk1 ~]# systemctl start elasticsearch\n[root@linux-elk1 ~]# netstat -nltup |grep java\ntcp6       0      0 192.168.1.31:9200       :::*                    LISTEN      12887/java          \ntcp6       0      0 192.168.1.31:9300       :::*                    LISTEN      12887/java\n\n\n\n将配置文件copy到linux-elk2上面并进行修改，配置启动等。\n[root@linux-elk1 ~]# scp /etc/elasticsearch/elasticsearch.yml 192.168.1.32:/etc/elasticsearch/elasticsearch.yml\n[root@linux-elk2 ~]# grep ^[a-Z] /etc/elasticsearch/elasticsearch.yml \ncluster.name: ELK-Cluster\nnode.name: elk-node2\npath.data: /elk/data\npath.logs: /elk/logs\nbootstrap.memory_lock: true\nnetwork.host: 192.168.1.32\nhttp.port: 9200\ndiscovery.zen.ping.unicast.hosts: [\"192.168.1.31\", \"192.168.1.32\"]\n[root@linux-elk2 ~]# vim /usr/lib/systemd/system/elasticsearch.service\n# 在[Service]下加入下面这行内容\nLimitMEMLOCK=infinity\n[root@linux-elk2 ~]# systemctl daemon-reload\n[root@linux-elk2 ~]# vim /etc/elasticsearch/jvm.options\n-Xms2g\n-Xmx2g\n[root@linux-elk2 ~]# mkdir -p /elk/{data,logs}\n[root@linux-elk2 ~]# chown elasticsearch.elasticsearch /elk/ -R\n[root@linux-elk2 ~]# systemctl start elasticsearch\n[root@linux-elk2 ~]#  netstat -nltup |grep java\ntcp6       0      0 192.168.1.32:9200       :::*                    LISTEN      18667/java          \ntcp6       0      0 192.168.1.32:9300       :::*                    LISTEN      18667/java \n```\n通过浏览器访问`elasticsearch`端口\n![elk01.png](ELK快速入门一-基本部署/elk01.png)\n![elk02.png](ELK快速入门一-基本部署/elk02.png)\n\n\n\n\n#### 监控elasticsearch集群状态\n>通过shell命令获取集群状态，这里获取到的是一个json格式的返回值，例如对status进行分析，如果等于green(绿色)就是运行在正常，等于yellow(黄色)表示副本分片丢失，red(红色)表示主分片丢失。\n```\n[root@linux-elk1 ~]# curl http://192.168.1.31:9200/_cluster/health?pretty=true\n{\n  \"cluster_name\" : \"ELK-Cluster\",\n  \"status\" : \"green\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 2,\n  \"number_of_data_nodes\" : 2,\n  \"active_primary_shards\" : 0,\n  \"active_shards\" : 0,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 0,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 100.0\n}\n\n[root@linux-elk1 ~]# curl http://192.168.1.32:9200/_cluster/health?pretty=true\n{\n  \"cluster_name\" : \"ELK-Cluster\",\n  \"status\" : \"green\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 2,\n  \"number_of_data_nodes\" : 2,\n  \"active_primary_shards\" : 0,\n  \"active_shards\" : 0,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 0,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 100.0\n}\n```\n\n\n#### 安装elasticsearch插件head\n>我们不可能经常通过命令来查看集群的信息，所以就使用到了插件 --`head`。件是为了完成不同的功能，官方提供了一些插件但大部分是收费的，另外也有一些开发爱好者提供的插件，可以实现对`elasticsearch`集群的状态监控与管理配置等功能。\n>head：主要用来做集群管理的插件\n>下载地址：https://github.com/mobz/elasticsearch-head\n\n1）安装\n```\n# 安装npm和git\n[root@linux-elk1 ~]# yum -y install npm git\n\n# 安装elasticsearch-head插件\n[root@linux-elk1 ~]# cd /usr/local/src/\n[root@linux-elk1 src]# git clone git://github.com/mobz/elasticsearch-head.git\n[root@linux-elk1 src]# cd elasticsearch-head/\n[root@linux-elk1 elasticsearch-head]# npm install grunt -save --registry=https://registry.npm.taobao.org\n[root@linux-elk1 elasticsearch-head]# ll node_modules/grunt    #确定该目录有生成文件\n总用量 24\ndrwxr-xr-x. 2 root root   19 4月   6 2016 bin\n-rw-r--r--. 1 root root 7111 4月   6 2016 CHANGELOG\ndrwxr-xr-x. 4 root root   47 7月   4 09:21 lib\n-rw-r--r--. 1 root root 1592 3月  23 2016 LICENSE\ndrwxr-xr-x. 5 root root   50 7月   4 09:21 node_modules\n-rw-r--r--. 1 root root 4108 7月   4 09:21 package.json\n-rw-r--r--. 1 root root  878 2月  12 2016 README.md\n[root@linux-elk1 elasticsearch-head]# npm install --registry=https://registry.npm.taobao.org    #执行安装\n[root@linux-elk1 elasticsearch-head]# npm run start &    #后台启动服务\n[root@linux-elk1 ~]# ss -nlt |grep 9100\nLISTEN     0      128          *:9100                     *:* \n\n#------------------------补充说明------------------------\n由于上面npm安装时候超级慢，使用taobao源同样慢，这里将已安装的打成了包，可以直接下载使用即可\n下载地址：https://pan.baidu.com/s/16zDlecKVfmkEeInPcRx9NQ   提取码：h890\n[root@linux-elk1 ~]# yum -y install npm\n[root@linux-elk1 ~]# cd /usr/local/src/\n[root@linux-elk1 src]# ls\nelasticsearch-head.tar.gz\n[root@linux-elk1 src]# tar xvzf elasticsearch-head.tar.gz\n[root@linux-elk1 src]# cd elasticsearch-head/\n[root@linux-elk1 elasticsearch-head]# npm run start &\n#--------------------------------------------------------\n\n# 修改elasticsearch服务配置文件，开启跨域访问支持，然后重启elasticsearch服务\n[root@linux-elk1 ~]# vim /etc/elasticsearch/elasticsearch.yml\nhttp.cors.enabled: true     #最下方添加\nhttp.cors.allow-origin: \"*\"\n```\n\n为了方便管理`elasticsearch-head`插件，编写一个启动脚本\n```\n[root@linux-elk1 ~]# vim /usr/bin/elasticsearch-head\n#!/bin/bash\n#desc: elasticsearch-head service manager\n#date: 2019\n\ndata=\"cd /usr/local/src/elasticsearch-head/; nohup npm run start > /dev/null 2>&1 & \"\n\nfunction START (){\n    eval $data && echo -e \"elasticsearch-head start\\033[32m     ok\\033[0m\"\n}\n\nfunction STOP (){\n    ps -ef |grep grunt |grep -v \"grep\" |awk '{print $2}' |xargs kill -s 9 > /dev/null && echo -e \"elasticsearch-head stop\\033[32m      ok\\033[0m\"\n}\n\ncase \"$1\" in\n    start)\n        START\n        ;;\n    stop)\n        STOP\n        ;;\n    restart)\n        STOP\n        sleep 3\n        START\n        ;;\n    *)\n        echo \"Usage: elasticsearch-head (start|stop|restart)\"\n        ;;\nesac\n\n[root@linux-elk1 ~]# chmod +x /usr/bin/elasticsearch-head\n```\n\n\n2）浏览器访问`9100端口`，将连接地址修改为`elasticsearch`地址。\n![elk03.png](ELK快速入门一-基本部署/elk03.png)\n![elk04.png](ELK快速入门一-基本部署/elk04.png)\n\n3）测试提交数据\n![elk05.png](ELK快速入门一-基本部署/elk05.png)\n\n4）验证索引是否存在\n![elk06.png](ELK快速入门一-基本部署/elk06.png)\n\n5）查看数据\n![elk07.png](ELK快速入门一-基本部署/elk07.png)\n\n6）Master和Slave的区别：\n>`Master`的职责：\n>统计各`node`节点状态信息、集群状态信息统计、索引的创建和删除、索引分配的管理、关闭`node`节点等\n>`Savle`的职责：\n>同步数据、等待机会称为`Master`\n\n\n\n## Logstash部署\n>Logstash 是一个开源的数据收集引擎，可以水平伸缩，而且logstash是整个ELK当中拥有最多插件的一个组件，其可以接收来自不同来源的数据并同意输出到指定的且可以是多个不同目的地。官网下载地址：https://www.elastic.co/cn/downloads/past-releases#logstash\n\n### 安装logstash\n```\n[root@linux-elk1 ~]# wget https://artifacts.elastic.co/downloads/logstash/logstash-6.8.1.rpm\n[root@linux-elk1 ~]# yum -y localinstall logstash-6.8.1.rpm\n```\n### 测试logstash是否正常\n1）测试标准输入输出\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -e 'input { stdin {} } output { stdout { codec => rubydebug} }'  \nhello world    #输入\n\n{\n      \"@version\" => \"1\",    #事件版本号，一个事件就是一个ruby对象\n    \"@timestamp\" => 2019-07-04T04:30:35.106Z,    #当前事件发生的事件\n          \"host\" => \"linux-elk1.exmaple.com\",    #标记事件发生在哪里\n       \"message\" => \"hello world\"    #消息的具体内容\n}\n```\n2）测试输出到文件\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash   -e 'input { stdin{} } output { file { path => \"/tmp/log-%{+YYYY.MM.dd}messages.gz\"}}'\nhello world   #输入\n[INFO ] 2019-07-04 17:33:06.065 [[main]>worker0] file - Opening file {:path=>\"/tmp/log-2019.07.04messages.gz\"}\n\n[root@linux-elk1 ~]# tail /tmp/log-2019.07.04messages.gz \n{\"message\":\"hello world\",\"@version\":\"1\",\"host\":\"linux-elk1.exmaple.com\",\"@timestamp\":\"2019-07-04T09:33:05.698Z\"}\n```\n3）测试输出到elasticsearch\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash   -e 'input {  stdin{} } output { elasticsearch {hosts => [\"192.168.1.31:9200\"] index => \"mytest-%{+YYYY.MM.dd}\" }}'\n```\n4）elasticsearch服务器验证收到数据\n```\n[root@linux-elk1 ~]# ll /elk/data/nodes/0/indices/\n总用量 0\ndrwxr-xr-x. 8 elasticsearch elasticsearch 65 7月   4 17:23 4jaihRq6Qu6NQWVxbuRQZg\ndrwxr-xr-x. 8 elasticsearch elasticsearch 65 7月   4 17:22 kkd_RCldSeaCX3y1XKzdgA\n```\n![elk08.png](ELK快速入门一-基本部署/elk08.png)\n\n\n\n\n## kibana部署\n>`Kibana`是一个通过调用`elasticsearch`服务器进行图形化展示搜索结果的开源项目。官网下载地址：https://www.elastic.co/cn/downloads/past-releases#kibana\n\n### 安装kibana\n```\n[root@linux-elk1 ~]# wget https://artifacts.elastic.co/downloads/kibana/kibana-6.8.1-x86_64.rpm\n[root@linux-elk1 ~]# yum -y localinstall kibana-6.8.1-x86_64.rpm\n[root@linux-elk1 ~]# vim /etc/kibana/kibana.yml \n[root@linux-elk1 ~]# grep ^[a-Z] /etc/kibana/kibana.yml \nserver.port: 5601    #监听端口\nserver.host: \"192.168.1.31\"    #监听地址\nelasticsearch.hosts: [\"http://192.168.1.31:9200\"]    #elasticsearch服务器地址\ni18n.locale: \"zh-CN\"    #修改为中文\n```\n### 启动kibana并验证\n```\n[root@linux-elk1 ~]# systemctl start kibana\n[root@linux-elk1 ~]# systemctl enable kibana\n[root@linux-elk1 ~]# ss -nlt  |grep 5601\nLISTEN     0      128    192.168.1.31:5601                     *:*\n```\n### 查看状态\n![elk09.png](ELK快速入门一-基本部署/elk09.png)\n\n\n\n\n## 通过logstash收集系统message日志\n>说明：通过`logstash`收集别的日志文件，前提需要`logstash`用户对被收集的日志文件有读的权限并对写入的文件有写的权限\n\n1）配置`logstash`配置文件\n```\n[root@linux-elk1 ~]# vim /etc/logstash/conf.d/system-log.conf\ninput {\n    file {\n        path => \"/var/log/messages\"    #日志路径\n        type => \"systemlog\"            #类型，自定义，在进行多个日志收集存储时可以通过该项进行判断输出\n        start_position => \"beginning\"        #logstash 从什么位置开始读取文件数据，默认是结束位置，也就是说 logstash 进程会以类似 tail -F 的形式运行。如果你是要导入原有数据，把这个设定改成 \"beginning\"，logstash 进程就从头开始读取，类似 less +F 的形式运行。\n\t\tstat_interval => \"2\"    #logstash 每隔多久检查一次被监听文件状态（是否有更新），默认是 1 秒\n    }\n}\n\noutput {\n    elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]        #elasticsearch服务器地址\n        index => \"logstash-%{type}-%{+YYYY.MM.dd}\"    #索引名称\n    }\n}\n```\n2）检测配置文件语法是否有错误\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system-log.conf -t    #检测配置文件是否有语法错误\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-05 10:09:59.423 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n[INFO ] 2019-07-05 10:10:27.993 [LogStash::Runner] runner - Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash\n```\n3）修改日志文件的权限并重启`logstash`\n```\n[root@linux-elk1 ~]# ll /var/log/messages     \n-rw-------. 1 root root 786219 7月   5 10:10 /var/log/messages\n#这里可以看到该日志文件是600权限，而elasticsearch是运行在elasticsearch用户下，这样elasticsearch是无法收集日志的。所以这里需要更改日志的权限，否则会报权限拒绝的错误。在日志中查看/var/log/logstash/logstash-plain.log 是否有错误。\n[root@linux-elk1 ~]# chmod 644 /var/log/messages\n[root@linux-elk1 ~]# systemctl  restart logstash\n```\n4）elasticsearch界面查看并查询\n![elk10.png](ELK快速入门一-基本部署/elk10.png)\n![elk11.png](ELK快速入门一-基本部署/elk11.png)\n5）kibana界面创建索引并查看\n![elk12.png](ELK快速入门一-基本部署/elk12.png)\n![elk13.png](ELK快速入门一-基本部署/elk13.png)\n![elk14.png](ELK快速入门一-基本部署/elk14.png)\n![elk15.png](ELK快速入门一-基本部署/elk15.png)\n\n\n\n","slug":"ELK快速入门一-基本部署","published":1,"updated":"2019-10-24T09:12:16.845Z","_id":"cjz3xyiot000adstcdo126x0a","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"ELK简介\"><a href=\"#ELK简介\" class=\"headerlink\" title=\"ELK简介\"></a>ELK简介</h2><blockquote>\n<p>什么是ELK？通俗来讲，ELK是由Elasticsearch、Logstash、Kibana 三个开源软件组成的一个组合体，这三个软件当中，每个软件用于完成不同的功能，ELK又称ELKstack，官网 <a href=\"https://www.elastic.co/\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/</a> ， ELK主要优点有如下几个：<br>1、处理方式灵活：elasticsearch是实时全文索引，具有强大的搜索功能<br>2、配置相对简单：elasticsearch全部使用JSON接口，logstash使用模块配置，kibana的配置文件部分更简单<br>3、检索性能高：基于优秀的设计，虽然每次查询都是实时，但是也可以达到百亿级数据的查询秒级响应<br>4、集群线性扩展：elasticsearch和logstash都可以灵活线性扩展<br>5、前端操作绚丽：kibana的前端设计比较绚丽，而且操作简单</p>\n</blockquote>\n<h3 id=\"Elasticsearch\"><a href=\"#Elasticsearch\" class=\"headerlink\" title=\"Elasticsearch\"></a>Elasticsearch</h3><blockquote>\n<p><code>elasticsearch</code>是一个高度可扩展全文搜索和分析引擎，基于<code>Apache Lucene</code> 构建，能对大容量的数据进行接近实时的存储、搜索和分析操作，可以处理大规模日志数据，比如<code>Nginx</code>、<code>Tomcat</code>、系统日志等功能。</p>\n</blockquote>\n<h3 id=\"Logstash\"><a href=\"#Logstash\" class=\"headerlink\" title=\"Logstash\"></a>Logstash</h3><blockquote>\n<p>数据收集引擎。它支持动态的从各种数据源搜集数据，并对数据进行过滤、分析、丰富、统一格式等操作，然后存储到用户指定的位置；支持普通<code>log</code>、自定义<code>json</code>格式的日志解析。</p>\n</blockquote>\n<h3 id=\"Kibana\"><a href=\"#Kibana\" class=\"headerlink\" title=\"Kibana\"></a>Kibana</h3><blockquote>\n<p>数据分析和可视化平台。通常与 <code>Elasticsearch</code> 配合使用，对其中数据进行搜索、分析和以统计图表的方式展示。</p>\n</blockquote>\n<h2 id=\"ELK部署环境准备\"><a href=\"#ELK部署环境准备\" class=\"headerlink\" title=\"ELK部署环境准备\"></a>ELK部署环境准备</h2><blockquote>\n<p>这里实验所使用系统<code>CentOS 7.4 x86_64</code>，服务器信息如下。并关闭防火墙和<code>selinux</code>，及<code>host</code>绑定等。本文所使用所有的软件包 <a href=\"https://pan.baidu.com/s/1ighWPeYVqK6AGZQn55Y_pw\" target=\"_blank\" rel=\"noopener\">下载</a>  提取码：<code>ow1b</code></p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>IPAddr</th>\n<th>HostName</th>\n<th>Mem  </th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>192.168.1.31</td>\n<td>linux-elk1.exmaple.com</td>\n<td>3G   </td>\n</tr>\n<tr>\n<td>192.168.1.32</td>\n<td>linux-elk2.exmaple.com</td>\n<td>3G   </td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">epel源配置</span><br><span class=\"line\"># wget -O <span class=\"regexp\">/etc/yum</span>.repos.d<span class=\"regexp\">/epel.repo http:/</span><span class=\"regexp\">/mirrors.aliyun.com/</span>repo<span class=\"regexp\">/epel-7.repo</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Elasticsearch部署\"><a href=\"#Elasticsearch部署\" class=\"headerlink\" title=\"Elasticsearch部署\"></a>Elasticsearch部署</h2><blockquote>\n<p>因为<code>elasticsearch</code>服务运行需要<code>java</code>环境，因此两台<code>elasticsearch</code>服务器需要安装<code>java</code>环境。</p>\n</blockquote>\n<h3 id=\"安装JDK\"><a href=\"#安装JDK\" class=\"headerlink\" title=\"安装JDK\"></a>安装JDK</h3><blockquote>\n<p><code>centos7</code>默认是安装了<code>jdk</code>，如果需要安装高版本可以使用一下步骤，这里使用下面的yum安装<code>jdk 1.8.0_211</code> 。注意：两个节点都要安装。</p>\n</blockquote>\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">方法一：yum安装下载好的JDK包，将下载好的软件包上传到服务器进行安装，首先卸载自带的jdk；再进行安装。</span><br><span class=\"line\">下载地址：https:<span class=\"regexp\">//pan</span>.baidu.com/<span class=\"keyword\">s</span>/<span class=\"number\">1</span>VK1iCnvouppZ06jsVBOaRw  提取码：lofc</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># rpm -qa |grep jdk |xargs yum -y remove &#123;&#125;\\;</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># yum -y localinstall jdk-8u211-linux-x64.rpm</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># java -version</span></span><br><span class=\"line\">java version <span class=\"string\">\"1.8.0_211\"</span></span><br><span class=\"line\">Java(TM) SE Runtime Environment (build <span class=\"number\">1.8</span>.<span class=\"number\">0_211</span>-b12)</span><br><span class=\"line\">Java HotSpot(TM) <span class=\"number\">64</span>-Bit Server VM (build <span class=\"number\">25.211</span>-b12, mixed mode)</span><br><span class=\"line\"></span><br><span class=\"line\">方法二：源码安装JDK，将下载的软件包上传到服务器进行安装。</span><br><span class=\"line\">下载地址：https:<span class=\"regexp\">//pan</span>.baidu.com/<span class=\"keyword\">s</span>/<span class=\"number\">1</span>AAPyPzhdclNNCb0m6ooVYQ  提取码：x18u</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># ln -s /usr/local/jdk1.8.0_211 /usr/local/java</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># sed -i.ori '$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># java -version</span></span><br><span class=\"line\">java version <span class=\"string\">\"1.8.0_211\"</span></span><br><span class=\"line\">Java(TM) SE Runtime Environment (build <span class=\"number\">1.8</span>.<span class=\"number\">0_211</span>-b12)</span><br><span class=\"line\">Java HotSpot(TM) <span class=\"number\">64</span>-Bit Server VM (build <span class=\"number\">25.211</span>-b12, mixed mode)</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装Elasticsearch\"><a href=\"#安装Elasticsearch\" class=\"headerlink\" title=\"安装Elasticsearch\"></a>安装Elasticsearch</h3><blockquote>\n<p>两台节点都需要安装elasticsearch，使用yum安装会很慢，所以先下载下来传到服务器进行安装，官网下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#elasticsearch\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/cn/downloads/past-releases#elasticsearch</a><br>本文所使用的包下载：<a href=\"https://pan.baidu.com/s/1djYOs3PQjtq16VkPMETAWg\" target=\"_blank\" rel=\"noopener\">https://pan.baidu.com/s/1djYOs3PQjtq16VkPMETAWg</a>  提取码：b15v</p>\n</blockquote>\n<figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">将下载的elasticsearch包上传到服务器进行安装。</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># yum -y localinstall elasticsearch-6.8.1.rpm</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># yum -y localinstall elasticsearch-6.8.1.rpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">配置elasticsearch，linux-elk2配置一个相同的节点，通过组播进行通信，如果无法通过组播查询，修改成单播即可。</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># vim /etc/elasticsearch/elasticsearch.yml</span></span><br><span class=\"line\"><span class=\"symbol\">cluster.name:</span> ELK-Cluster    <span class=\"comment\">#ELK的集群名称，名称相同即属于是同一个集群</span></span><br><span class=\"line\"><span class=\"symbol\">node.name:</span> elk-node1    <span class=\"comment\">#本机在集群内的节点名称</span></span><br><span class=\"line\"><span class=\"symbol\">path.data:</span> /elk/data    <span class=\"comment\">#数据存放目录</span></span><br><span class=\"line\"><span class=\"symbol\">path.logs:</span> /elk/logs    <span class=\"comment\">#日志保存目录</span></span><br><span class=\"line\"><span class=\"symbol\">bootstrap.memory_lock:</span> <span class=\"keyword\">true</span>    <span class=\"comment\">#服务启动的时候锁定足够的内存，防止数据写入swap</span></span><br><span class=\"line\"><span class=\"symbol\">network.host:</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span>    <span class=\"comment\">#监听的IP地址</span></span><br><span class=\"line\"><span class=\"symbol\">http.port:</span> <span class=\"number\">9200</span>    <span class=\"comment\">#服务监听的端口</span></span><br><span class=\"line\"><span class=\"symbol\">discovery.zen.ping.unicast.hosts:</span> [<span class=\"string\">\"192.168.1.31\"</span>, <span class=\"string\">\"192.168.1.32\"</span>]    <span class=\"comment\">#单播配置一台即可</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">修改内存限制，内存锁定需要进行配置需要<span class=\"number\">2</span>g以上内存，否则会导致无法启动elasticsearch。</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># vim /usr/lib/systemd/system/elasticsearch.service</span></span><br><span class=\"line\"><span class=\"comment\"># 在[Service]下加入下面这行内容</span></span><br><span class=\"line\">LimitMEMLOCK=infinity</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># vim /etc/elasticsearch/jvm.options</span></span><br><span class=\"line\">-Xms2g</span><br><span class=\"line\">-Xmx2g     <span class=\"comment\">#最小和最大内存限制，为什么最小和最大设置一样大？参考：https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">创建数据目录和日志目录及权限修改</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># mkdir -p /elk/&#123;data,logs&#125;</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># chown elasticsearch.elasticsearch /elk/ -R</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">启动elasticsearch及检查端口是否处于监听状态</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># systemctl start elasticsearch</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># netstat -nltup |grep java</span></span><br><span class=\"line\">tcp6       <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span><span class=\"symbol\">:</span><span class=\"number\">9200</span>       ::<span class=\"symbol\">:*</span>                    LISTEN      <span class=\"number\">12887</span>/java          </span><br><span class=\"line\">tcp6       <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span><span class=\"symbol\">:</span><span class=\"number\">9300</span>       ::<span class=\"symbol\">:*</span>                    LISTEN      <span class=\"number\">12887</span>/java</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">将配置文件copy到linux-elk2上面并进行修改，配置启动等。</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># scp /etc/elasticsearch/elasticsearch.yml 192.168.1.32:/etc/elasticsearch/elasticsearch.yml</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># grep ^[a-Z] /etc/elasticsearch/elasticsearch.yml </span></span><br><span class=\"line\"><span class=\"symbol\">cluster.name:</span> ELK-Cluster</span><br><span class=\"line\"><span class=\"symbol\">node.name:</span> elk-node2</span><br><span class=\"line\"><span class=\"symbol\">path.data:</span> /elk/data</span><br><span class=\"line\"><span class=\"symbol\">path.logs:</span> /elk/logs</span><br><span class=\"line\"><span class=\"symbol\">bootstrap.memory_lock:</span> <span class=\"keyword\">true</span></span><br><span class=\"line\"><span class=\"symbol\">network.host:</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span></span><br><span class=\"line\"><span class=\"symbol\">http.port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"symbol\">discovery.zen.ping.unicast.hosts:</span> [<span class=\"string\">\"192.168.1.31\"</span>, <span class=\"string\">\"192.168.1.32\"</span>]</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># vim /usr/lib/systemd/system/elasticsearch.service</span></span><br><span class=\"line\"><span class=\"comment\"># 在[Service]下加入下面这行内容</span></span><br><span class=\"line\">LimitMEMLOCK=infinity</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># vim /etc/elasticsearch/jvm.options</span></span><br><span class=\"line\">-Xms2g</span><br><span class=\"line\">-Xmx2g</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># mkdir -p /elk/&#123;data,logs&#125;</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># chown elasticsearch.elasticsearch /elk/ -R</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># systemctl start elasticsearch</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\">#  netstat -nltup |grep java</span></span><br><span class=\"line\">tcp6       <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span><span class=\"symbol\">:</span><span class=\"number\">9200</span>       ::<span class=\"symbol\">:*</span>                    LISTEN      <span class=\"number\">18667</span>/java          </span><br><span class=\"line\">tcp6       <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span><span class=\"symbol\">:</span><span class=\"number\">9300</span>       ::<span class=\"symbol\">:*</span>                    LISTEN      <span class=\"number\">18667</span>/java</span><br></pre></td></tr></table></figure>\n<p>通过浏览器访问<code>elasticsearch</code>端口<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk01.png\" alt=\"elk01.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk02.png\" alt=\"elk02.png\"></p>\n<h4 id=\"监控elasticsearch集群状态\"><a href=\"#监控elasticsearch集群状态\" class=\"headerlink\" title=\"监控elasticsearch集群状态\"></a>监控elasticsearch集群状态</h4><blockquote>\n<p>通过shell命令获取集群状态，这里获取到的是一个json格式的返回值，例如对status进行分析，如果等于green(绿色)就是运行在正常，等于yellow(黄色)表示副本分片丢失，red(红色)表示主分片丢失。<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"meta\"># curl http:<span class=\"comment\">//192.168.1.31:9200/_cluster/health?pretty=true</span></span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"cluster_name\"</span> : <span class=\"string\">\"ELK-Cluster\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"status\"</span> : <span class=\"string\">\"green\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"timed_out\"</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_nodes\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_data_nodes\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_primary_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"relocating_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"initializing_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"unassigned_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"delayed_unassigned_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_pending_tasks\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_in_flight_fetch\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"task_max_waiting_in_queue_millis\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_shards_percent_as_number\"</span> : <span class=\"number\">100.0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"meta\"># curl http:<span class=\"comment\">//192.168.1.32:9200/_cluster/health?pretty=true</span></span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"cluster_name\"</span> : <span class=\"string\">\"ELK-Cluster\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"status\"</span> : <span class=\"string\">\"green\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"timed_out\"</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_nodes\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_data_nodes\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_primary_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"relocating_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"initializing_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"unassigned_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"delayed_unassigned_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_pending_tasks\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_in_flight_fetch\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"task_max_waiting_in_queue_millis\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_shards_percent_as_number\"</span> : <span class=\"number\">100.0</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"安装elasticsearch插件head\"><a href=\"#安装elasticsearch插件head\" class=\"headerlink\" title=\"安装elasticsearch插件head\"></a>安装elasticsearch插件head</h4><blockquote>\n<p>我们不可能经常通过命令来查看集群的信息，所以就使用到了插件 –<code>head</code>。件是为了完成不同的功能，官方提供了一些插件但大部分是收费的，另外也有一些开发爱好者提供的插件，可以实现对<code>elasticsearch</code>集群的状态监控与管理配置等功能。<br>head：主要用来做集群管理的插件<br>下载地址：<a href=\"https://github.com/mobz/elasticsearch-head\" target=\"_blank\" rel=\"noopener\">https://github.com/mobz/elasticsearch-head</a></p>\n</blockquote>\n<p>1）安装<br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装npm和git</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># yum -y install npm git</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装elasticsearch-head插件</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># cd /usr/local/src/</span></span><br><span class=\"line\">[root@linux-elk1 src]<span class=\"comment\"># git clone git://github.com/mobz/elasticsearch-head.git</span></span><br><span class=\"line\">[root@linux-elk1 src]<span class=\"comment\"># cd elasticsearch-head/</span></span><br><span class=\"line\">[root@linux-elk1 elasticsearch-head]<span class=\"comment\"># npm install grunt -save --registry=https://registry.npm.taobao.org</span></span><br><span class=\"line\">[root@linux-elk1 elasticsearch-head]<span class=\"comment\"># ll node_modules/grunt    #确定该目录有生成文件</span></span><br><span class=\"line\">总用量 <span class=\"number\">24</span></span><br><span class=\"line\">drwxr-xr-x. <span class=\"number\">2</span> root root   <span class=\"number\">19</span> <span class=\"number\">4</span>月   <span class=\"number\">6</span> <span class=\"number\">2016</span> bin</span><br><span class=\"line\">-rw-r--r--. <span class=\"number\">1</span> root root <span class=\"number\">7111</span> <span class=\"number\">4</span>月   <span class=\"number\">6</span> <span class=\"number\">2016</span> CHANGELOG</span><br><span class=\"line\">drwxr-xr-x. <span class=\"number\">4</span> root root   <span class=\"number\">47</span> <span class=\"number\">7</span>月   <span class=\"number\">4</span> 09:<span class=\"number\">21</span> lib</span><br><span class=\"line\">-rw-r--r--. <span class=\"number\">1</span> root root <span class=\"number\">1592</span> <span class=\"number\">3</span>月  <span class=\"number\">23</span> <span class=\"number\">2016</span> LICENSE</span><br><span class=\"line\">drwxr-xr-x. <span class=\"number\">5</span> root root   <span class=\"number\">50</span> <span class=\"number\">7</span>月   <span class=\"number\">4</span> 09:<span class=\"number\">21</span> node_modules</span><br><span class=\"line\">-rw-r--r--. <span class=\"number\">1</span> root root <span class=\"number\">4108</span> <span class=\"number\">7</span>月   <span class=\"number\">4</span> 09:<span class=\"number\">21</span> package.json</span><br><span class=\"line\">-rw-r--r--. <span class=\"number\">1</span> root root  <span class=\"number\">878</span> <span class=\"number\">2</span>月  <span class=\"number\">12</span> <span class=\"number\">2016</span> README.md</span><br><span class=\"line\">[root@linux-elk1 elasticsearch-head]<span class=\"comment\"># npm install --registry=https://registry.npm.taobao.org    #执行安装</span></span><br><span class=\"line\">[root@linux-elk1 elasticsearch-head]<span class=\"comment\"># npm run start &amp;    #后台启动服务</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># ss -nlt |grep 9100</span></span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">128</span>          *:<span class=\"number\">9100</span>                     *:* </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#------------------------补充说明------------------------</span></span><br><span class=\"line\">由于上面npm安装时候超级慢，使用taobao源同样慢，这里将已安装的打成了包，可以直接下载使用即可</span><br><span class=\"line\">下载地址：https:<span class=\"regexp\">//pan</span>.baidu.com/<span class=\"keyword\">s</span>/<span class=\"number\">16</span>zDlecKVfmkEeInPcRx9NQ   提取码：h89<span class=\"number\">0</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># yum -y install npm</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># cd /usr/local/src/</span></span><br><span class=\"line\">[root@linux-elk1 src]<span class=\"comment\"># ls</span></span><br><span class=\"line\">elasticsearch-head.tar.gz</span><br><span class=\"line\">[root@linux-elk1 src]<span class=\"comment\"># tar xvzf elasticsearch-head.tar.gz</span></span><br><span class=\"line\">[root@linux-elk1 src]<span class=\"comment\"># cd elasticsearch-head/</span></span><br><span class=\"line\">[root@linux-elk1 elasticsearch-head]<span class=\"comment\"># npm run start &amp;</span></span><br><span class=\"line\"><span class=\"comment\">#--------------------------------------------------------</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改elasticsearch服务配置文件，开启跨域访问支持，然后重启elasticsearch服务</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/elasticsearch/elasticsearch.yml</span></span><br><span class=\"line\">http.cors.enabled: true     <span class=\"comment\">#最下方添加</span></span><br><span class=\"line\">http.cors.allow-origin: <span class=\"string\">\"*\"</span></span><br></pre></td></tr></table></figure></p>\n<p>为了方便管理<code>elasticsearch-head</code>插件，编写一个启动脚本<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /usr/bin/elasticsearch-head</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#desc: elasticsearch-head service manager</span></span><br><span class=\"line\"><span class=\"comment\">#date: 2019</span></span><br><span class=\"line\"></span><br><span class=\"line\">data=<span class=\"string\">\"cd /usr/local/src/elasticsearch-head/; nohup npm run start &gt; /dev/null 2&gt;&amp;1 &amp; \"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">START</span></span> ()&#123;</span><br><span class=\"line\">    <span class=\"built_in\">eval</span> <span class=\"variable\">$data</span> &amp;&amp; <span class=\"built_in\">echo</span> -e <span class=\"string\">\"elasticsearch-head start\\033[32m     ok\\033[0m\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">STOP</span></span> ()&#123;</span><br><span class=\"line\">    ps -ef |grep grunt |grep -v <span class=\"string\">\"grep\"</span> |awk <span class=\"string\">'&#123;print $2&#125;'</span> |xargs <span class=\"built_in\">kill</span> -s 9 &gt; /dev/null &amp;&amp; <span class=\"built_in\">echo</span> -e <span class=\"string\">\"elasticsearch-head stop\\033[32m      ok\\033[0m\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">    start)</span><br><span class=\"line\">        START</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">    stop)</span><br><span class=\"line\">        STOP</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">    restart)</span><br><span class=\"line\">        STOP</span><br><span class=\"line\">        sleep 3</span><br><span class=\"line\">        START</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">    *)</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"Usage: elasticsearch-head (start|stop|restart)\"</span></span><br><span class=\"line\">        ;;</span><br><span class=\"line\"><span class=\"keyword\">esac</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># chmod +x /usr/bin/elasticsearch-head</span></span><br></pre></td></tr></table></figure></p>\n<p>2）浏览器访问<code>9100端口</code>，将连接地址修改为<code>elasticsearch</code>地址。<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk03.png\" alt=\"elk03.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk04.png\" alt=\"elk04.png\"></p>\n<p>3）测试提交数据<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk05.png\" alt=\"elk05.png\"></p>\n<p>4）验证索引是否存在<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk06.png\" alt=\"elk06.png\"></p>\n<p>5）查看数据<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk07.png\" alt=\"elk07.png\"></p>\n<p>6）Master和Slave的区别：</p>\n<blockquote>\n<p><code>Master</code>的职责：<br>统计各<code>node</code>节点状态信息、集群状态信息统计、索引的创建和删除、索引分配的管理、关闭<code>node</code>节点等<br><code>Savle</code>的职责：<br>同步数据、等待机会称为<code>Master</code></p>\n</blockquote>\n<h2 id=\"Logstash部署\"><a href=\"#Logstash部署\" class=\"headerlink\" title=\"Logstash部署\"></a>Logstash部署</h2><blockquote>\n<p>Logstash 是一个开源的数据收集引擎，可以水平伸缩，而且logstash是整个ELK当中拥有最多插件的一个组件，其可以接收来自不同来源的数据并同意输出到指定的且可以是多个不同目的地。官网下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#logstash\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/cn/downloads/past-releases#logstash</a></p>\n</blockquote>\n<h3 id=\"安装logstash\"><a href=\"#安装logstash\" class=\"headerlink\" title=\"安装logstash\"></a>安装logstash</h3><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># wget https://artifacts.elastic.co/downloads/logstash/logstash-6.8.1.rpm</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># yum -y localinstall logstash-6.8.1.rpm</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"测试logstash是否正常\"><a href=\"#测试logstash是否正常\" class=\"headerlink\" title=\"测试logstash是否正常\"></a>测试logstash是否正常</h3><p>1）测试标准输入输出<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># /usr/share/logstash/bin/logstash -e 'input &#123; stdin &#123;&#125; &#125; output &#123; stdout &#123; codec =&gt; rubydebug&#125; &#125;'  </span></span><br><span class=\"line\">hello world    <span class=\"comment\">#输入</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,    <span class=\"comment\">#事件版本号，一个事件就是一个ruby对象</span></span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-04</span>T04:<span class=\"number\">30</span>:<span class=\"number\">35.106</span>Z,    <span class=\"comment\">#当前事件发生的事件</span></span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"linux-elk1.exmaple.com\"</span>,    <span class=\"comment\">#标记事件发生在哪里</span></span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"hello world\"</span>    <span class=\"comment\">#消息的具体内容</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）测试输出到文件<br><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># /usr/share/logstash/bin/logstash   -e 'input &#123; stdin&#123;&#125; &#125; output &#123; file &#123; path =&gt; \"/tmp/log-%&#123;+YYYY.MM.dd&#125;messages.gz\"&#125;&#125;'</span></span><br><span class=\"line\">hello world   <span class=\"comment\">#输入</span></span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">04</span> <span class=\"number\">17</span><span class=\"symbol\">:</span><span class=\"number\">33</span><span class=\"symbol\">:</span><span class=\"number\">06</span>.<span class=\"number\">065</span> [[main]&gt;worker<span class=\"number\">0</span>] file - Opening file &#123;<span class=\"symbol\">:path=&gt;<span class=\"string\">\"/tmp/log-2019.07.04messages.gz\"</span></span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># tail /tmp/log-2019.07.04messages.gz </span></span><br><span class=\"line\">&#123;<span class=\"string\">\"message\"</span><span class=\"symbol\">:<span class=\"string\">\"hello world\"</span></span>,<span class=\"string\">\"@version\"</span><span class=\"symbol\">:<span class=\"string\">\"1\"</span></span>,<span class=\"string\">\"host\"</span><span class=\"symbol\">:<span class=\"string\">\"linux-elk1.exmaple.com\"</span></span>,<span class=\"string\">\"@timestamp\"</span><span class=\"symbol\">:<span class=\"string\">\"2019-07-04T09:33:05.698Z\"</span></span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）测试输出到elasticsearch<br><figure class=\"highlight ocaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash   -e <span class=\"symbol\">'input</span> &#123;  stdin&#123;&#125; &#125; output &#123; elasticsearch &#123;hosts =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>] index =&gt; <span class=\"string\">\"mytest-%&#123;+YYYY.MM.dd&#125;\"</span> &#125;&#125;<span class=\"string\">'</span></span><br></pre></td></tr></table></figure></p>\n<p>4）elasticsearch服务器验证收到数据<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># ll /elk/data/nodes/0/indices/</span></span><br><span class=\"line\">总用量 0</span><br><span class=\"line\">drwxr-xr-x.<span class=\"number\"> 8 </span>elasticsearch elasticsearch<span class=\"number\"> 65 </span>7月  <span class=\"number\"> 4 </span>17:23 4jaihRq6Qu6NQWVxbuRQZg</span><br><span class=\"line\">drwxr-xr-x.<span class=\"number\"> 8 </span>elasticsearch elasticsearch<span class=\"number\"> 65 </span>7月  <span class=\"number\"> 4 </span>17:22 kkd_RCldSeaCX3y1XKzdgA</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk08.png\" alt=\"elk08.png\"></p>\n<h2 id=\"kibana部署\"><a href=\"#kibana部署\" class=\"headerlink\" title=\"kibana部署\"></a>kibana部署</h2><blockquote>\n<p><code>Kibana</code>是一个通过调用<code>elasticsearch</code>服务器进行图形化展示搜索结果的开源项目。官网下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#kibana\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/cn/downloads/past-releases#kibana</a></p>\n</blockquote>\n<h3 id=\"安装kibana\"><a href=\"#安装kibana\" class=\"headerlink\" title=\"安装kibana\"></a>安装kibana</h3><figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># wget https://artifacts.elastic.co/downloads/kibana/kibana-6.8.1-x86_64.rpm</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># yum -y localinstall kibana-6.8.1-x86_64.rpm</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/kibana/kibana.yml </span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># grep ^[a-Z] /etc/kibana/kibana.yml </span></span><br><span class=\"line\">server.port: <span class=\"number\">5601</span>    <span class=\"comment\">#监听端口</span></span><br><span class=\"line\">server.host: <span class=\"string\">\"192.168.1.31\"</span>    <span class=\"comment\">#监听地址</span></span><br><span class=\"line\">elasticsearch.hosts: [<span class=\"string\">\"http://192.168.1.31:9200\"</span>]    <span class=\"comment\">#elasticsearch服务器地址</span></span><br><span class=\"line\">i18n.locale: <span class=\"string\">\"zh-CN\"</span>    <span class=\"comment\">#修改为中文</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"启动kibana并验证\"><a href=\"#启动kibana并验证\" class=\"headerlink\" title=\"启动kibana并验证\"></a>启动kibana并验证</h3><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># systemctl start kibana</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># systemctl enable kibana</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># ss -nlt  |grep 5601</span></span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">128</span>    <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span><span class=\"symbol\">:</span><span class=\"number\">5601</span>                     *<span class=\"symbol\">:*</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"查看状态\"><a href=\"#查看状态\" class=\"headerlink\" title=\"查看状态\"></a>查看状态</h3><p><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk09.png\" alt=\"elk09.png\"></p>\n<h2 id=\"通过logstash收集系统message日志\"><a href=\"#通过logstash收集系统message日志\" class=\"headerlink\" title=\"通过logstash收集系统message日志\"></a>通过logstash收集系统message日志</h2><blockquote>\n<p>说明：通过<code>logstash</code>收集别的日志文件，前提需要<code>logstash</code>用户对被收集的日志文件有读的权限并对写入的文件有写的权限</p>\n</blockquote>\n<p>1）配置<code>logstash</code>配置文件<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/system-log.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/var/log/messages\"</span>    <span class=\"comment\">#日志路径</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"systemlog\"</span>            <span class=\"comment\">#类型，自定义，在进行多个日志收集存储时可以通过该项进行判断输出</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span>        <span class=\"comment\">#logstash 从什么位置开始读取文件数据，默认是结束位置，也就是说 logstash 进程会以类似 tail -F 的形式运行。如果你是要导入原有数据，把这个设定改成 \"beginning\"，logstash 进程就从头开始读取，类似 less +F 的形式运行。</span></span><br><span class=\"line\">\t\t<span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"2\"</span>    <span class=\"comment\">#logstash 每隔多久检查一次被监听文件状态（是否有更新），默认是 1 秒</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]        <span class=\"comment\">#elasticsearch服务器地址</span></span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"logstash-%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;\"</span>    <span class=\"comment\">#索引名称</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）检测配置文件语法是否有错误<br><figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system-<span class=\"built_in\">log</span>.conf -t    #检测配置文件是否有语法错误</span><br><span class=\"line\">WARNING: Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> logstash.yml which is typically located <span class=\"keyword\">in</span> $LS_HOME/<span class=\"built_in\">config</span> <span class=\"keyword\">or</span> /etc/logstash. You can specify the <span class=\"built_in\">path</span> using <span class=\"comment\">--path.settings. Continuing using the defaults</span></span><br><span class=\"line\">Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> log4j2 configuration at <span class=\"built_in\">path</span> /usr/share/logstash/<span class=\"built_in\">config</span>/log4j2.properties. Using default <span class=\"built_in\">config</span> which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-05</span> <span class=\"number\">10</span>:<span class=\"number\">09</span>:<span class=\"number\">59.423</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command line options are specified</span><br><span class=\"line\">Configuration OK</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-05</span> <span class=\"number\">10</span>:<span class=\"number\">10</span>:<span class=\"number\">27.993</span> [LogStash::Runner] runner - Using <span class=\"built_in\">config</span>.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br></pre></td></tr></table></figure></p>\n<p>3）修改日志文件的权限并重启<code>logstash</code><br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# ll /<span class=\"keyword\">var</span>/<span class=\"keyword\">log</span>/messages     </span><br><span class=\"line\">-rw-------. 1 root root 786219 7月   5 10:10 /<span class=\"keyword\">var</span>/<span class=\"keyword\">log</span>/messages</span><br><span class=\"line\">#这里可以看到该日志文件是600权限，而elasticsearch是运行在elasticsearch用户下，这样elasticsearch是无法收集日志的。所以这里需要更改日志的权限，否则会报权限拒绝的错误。在日志中查看/<span class=\"keyword\">var</span>/<span class=\"keyword\">log</span>/logstash/logstash-plain.<span class=\"keyword\">log</span> 是否有错误。</span><br><span class=\"line\">[root@linux-elk1 ~]# chmod 644 /<span class=\"keyword\">var</span>/<span class=\"keyword\">log</span>/messages</span><br><span class=\"line\">[root@linux-elk1 ~]# systemctl  restart logstash</span><br></pre></td></tr></table></figure></p>\n<p>4）elasticsearch界面查看并查询<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk10.png\" alt=\"elk10.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk11.png\" alt=\"elk11.png\"><br>5）kibana界面创建索引并查看<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk12.png\" alt=\"elk12.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk13.png\" alt=\"elk13.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk14.png\" alt=\"elk14.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk15.png\" alt=\"elk15.png\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"ELK简介\"><a href=\"#ELK简介\" class=\"headerlink\" title=\"ELK简介\"></a>ELK简介</h2><blockquote>\n<p>什么是ELK？通俗来讲，ELK是由Elasticsearch、Logstash、Kibana 三个开源软件组成的一个组合体，这三个软件当中，每个软件用于完成不同的功能，ELK又称ELKstack，官网 <a href=\"https://www.elastic.co/\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/</a> ， ELK主要优点有如下几个：<br>1、处理方式灵活：elasticsearch是实时全文索引，具有强大的搜索功能<br>2、配置相对简单：elasticsearch全部使用JSON接口，logstash使用模块配置，kibana的配置文件部分更简单<br>3、检索性能高：基于优秀的设计，虽然每次查询都是实时，但是也可以达到百亿级数据的查询秒级响应<br>4、集群线性扩展：elasticsearch和logstash都可以灵活线性扩展<br>5、前端操作绚丽：kibana的前端设计比较绚丽，而且操作简单</p>\n</blockquote>\n<h3 id=\"Elasticsearch\"><a href=\"#Elasticsearch\" class=\"headerlink\" title=\"Elasticsearch\"></a>Elasticsearch</h3><blockquote>\n<p><code>elasticsearch</code>是一个高度可扩展全文搜索和分析引擎，基于<code>Apache Lucene</code> 构建，能对大容量的数据进行接近实时的存储、搜索和分析操作，可以处理大规模日志数据，比如<code>Nginx</code>、<code>Tomcat</code>、系统日志等功能。</p>\n</blockquote>\n<h3 id=\"Logstash\"><a href=\"#Logstash\" class=\"headerlink\" title=\"Logstash\"></a>Logstash</h3><blockquote>\n<p>数据收集引擎。它支持动态的从各种数据源搜集数据，并对数据进行过滤、分析、丰富、统一格式等操作，然后存储到用户指定的位置；支持普通<code>log</code>、自定义<code>json</code>格式的日志解析。</p>\n</blockquote>\n<h3 id=\"Kibana\"><a href=\"#Kibana\" class=\"headerlink\" title=\"Kibana\"></a>Kibana</h3><blockquote>\n<p>数据分析和可视化平台。通常与 <code>Elasticsearch</code> 配合使用，对其中数据进行搜索、分析和以统计图表的方式展示。</p>\n</blockquote>\n<h2 id=\"ELK部署环境准备\"><a href=\"#ELK部署环境准备\" class=\"headerlink\" title=\"ELK部署环境准备\"></a>ELK部署环境准备</h2><blockquote>\n<p>这里实验所使用系统<code>CentOS 7.4 x86_64</code>，服务器信息如下。并关闭防火墙和<code>selinux</code>，及<code>host</code>绑定等。本文所使用所有的软件包 <a href=\"https://pan.baidu.com/s/1ighWPeYVqK6AGZQn55Y_pw\" target=\"_blank\" rel=\"noopener\">下载</a>  提取码：<code>ow1b</code></p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>IPAddr</th>\n<th>HostName</th>\n<th>Mem  </th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>192.168.1.31</td>\n<td>linux-elk1.exmaple.com</td>\n<td>3G   </td>\n</tr>\n<tr>\n<td>192.168.1.32</td>\n<td>linux-elk2.exmaple.com</td>\n<td>3G   </td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">epel源配置</span><br><span class=\"line\"># wget -O <span class=\"regexp\">/etc/yum</span>.repos.d<span class=\"regexp\">/epel.repo http:/</span><span class=\"regexp\">/mirrors.aliyun.com/</span>repo<span class=\"regexp\">/epel-7.repo</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Elasticsearch部署\"><a href=\"#Elasticsearch部署\" class=\"headerlink\" title=\"Elasticsearch部署\"></a>Elasticsearch部署</h2><blockquote>\n<p>因为<code>elasticsearch</code>服务运行需要<code>java</code>环境，因此两台<code>elasticsearch</code>服务器需要安装<code>java</code>环境。</p>\n</blockquote>\n<h3 id=\"安装JDK\"><a href=\"#安装JDK\" class=\"headerlink\" title=\"安装JDK\"></a>安装JDK</h3><blockquote>\n<p><code>centos7</code>默认是安装了<code>jdk</code>，如果需要安装高版本可以使用一下步骤，这里使用下面的yum安装<code>jdk 1.8.0_211</code> 。注意：两个节点都要安装。</p>\n</blockquote>\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">方法一：yum安装下载好的JDK包，将下载好的软件包上传到服务器进行安装，首先卸载自带的jdk；再进行安装。</span><br><span class=\"line\">下载地址：https:<span class=\"regexp\">//pan</span>.baidu.com/<span class=\"keyword\">s</span>/<span class=\"number\">1</span>VK1iCnvouppZ06jsVBOaRw  提取码：lofc</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># rpm -qa |grep jdk |xargs yum -y remove &#123;&#125;\\;</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># yum -y localinstall jdk-8u211-linux-x64.rpm</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># java -version</span></span><br><span class=\"line\">java version <span class=\"string\">\"1.8.0_211\"</span></span><br><span class=\"line\">Java(TM) SE Runtime Environment (build <span class=\"number\">1.8</span>.<span class=\"number\">0_211</span>-b12)</span><br><span class=\"line\">Java HotSpot(TM) <span class=\"number\">64</span>-Bit Server VM (build <span class=\"number\">25.211</span>-b12, mixed mode)</span><br><span class=\"line\"></span><br><span class=\"line\">方法二：源码安装JDK，将下载的软件包上传到服务器进行安装。</span><br><span class=\"line\">下载地址：https:<span class=\"regexp\">//pan</span>.baidu.com/<span class=\"keyword\">s</span>/<span class=\"number\">1</span>AAPyPzhdclNNCb0m6ooVYQ  提取码：x18u</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># tar xf jdk-8u211-linux-x64.tar.gz -C /usr/local/</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># ln -s /usr/local/jdk1.8.0_211 /usr/local/java</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># sed -i.ori '$a export JAVA_HOME=/usr/local/java \\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH \\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar' /etc/profile</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># java -version</span></span><br><span class=\"line\">java version <span class=\"string\">\"1.8.0_211\"</span></span><br><span class=\"line\">Java(TM) SE Runtime Environment (build <span class=\"number\">1.8</span>.<span class=\"number\">0_211</span>-b12)</span><br><span class=\"line\">Java HotSpot(TM) <span class=\"number\">64</span>-Bit Server VM (build <span class=\"number\">25.211</span>-b12, mixed mode)</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装Elasticsearch\"><a href=\"#安装Elasticsearch\" class=\"headerlink\" title=\"安装Elasticsearch\"></a>安装Elasticsearch</h3><blockquote>\n<p>两台节点都需要安装elasticsearch，使用yum安装会很慢，所以先下载下来传到服务器进行安装，官网下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#elasticsearch\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/cn/downloads/past-releases#elasticsearch</a><br>本文所使用的包下载：<a href=\"https://pan.baidu.com/s/1djYOs3PQjtq16VkPMETAWg\" target=\"_blank\" rel=\"noopener\">https://pan.baidu.com/s/1djYOs3PQjtq16VkPMETAWg</a>  提取码：b15v</p>\n</blockquote>\n<figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">将下载的elasticsearch包上传到服务器进行安装。</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># yum -y localinstall elasticsearch-6.8.1.rpm</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># yum -y localinstall elasticsearch-6.8.1.rpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">配置elasticsearch，linux-elk2配置一个相同的节点，通过组播进行通信，如果无法通过组播查询，修改成单播即可。</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># vim /etc/elasticsearch/elasticsearch.yml</span></span><br><span class=\"line\"><span class=\"symbol\">cluster.name:</span> ELK-Cluster    <span class=\"comment\">#ELK的集群名称，名称相同即属于是同一个集群</span></span><br><span class=\"line\"><span class=\"symbol\">node.name:</span> elk-node1    <span class=\"comment\">#本机在集群内的节点名称</span></span><br><span class=\"line\"><span class=\"symbol\">path.data:</span> /elk/data    <span class=\"comment\">#数据存放目录</span></span><br><span class=\"line\"><span class=\"symbol\">path.logs:</span> /elk/logs    <span class=\"comment\">#日志保存目录</span></span><br><span class=\"line\"><span class=\"symbol\">bootstrap.memory_lock:</span> <span class=\"keyword\">true</span>    <span class=\"comment\">#服务启动的时候锁定足够的内存，防止数据写入swap</span></span><br><span class=\"line\"><span class=\"symbol\">network.host:</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span>    <span class=\"comment\">#监听的IP地址</span></span><br><span class=\"line\"><span class=\"symbol\">http.port:</span> <span class=\"number\">9200</span>    <span class=\"comment\">#服务监听的端口</span></span><br><span class=\"line\"><span class=\"symbol\">discovery.zen.ping.unicast.hosts:</span> [<span class=\"string\">\"192.168.1.31\"</span>, <span class=\"string\">\"192.168.1.32\"</span>]    <span class=\"comment\">#单播配置一台即可</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">修改内存限制，内存锁定需要进行配置需要<span class=\"number\">2</span>g以上内存，否则会导致无法启动elasticsearch。</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># vim /usr/lib/systemd/system/elasticsearch.service</span></span><br><span class=\"line\"><span class=\"comment\"># 在[Service]下加入下面这行内容</span></span><br><span class=\"line\">LimitMEMLOCK=infinity</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># vim /etc/elasticsearch/jvm.options</span></span><br><span class=\"line\">-Xms2g</span><br><span class=\"line\">-Xmx2g     <span class=\"comment\">#最小和最大内存限制，为什么最小和最大设置一样大？参考：https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">创建数据目录和日志目录及权限修改</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># mkdir -p /elk/&#123;data,logs&#125;</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># chown elasticsearch.elasticsearch /elk/ -R</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">启动elasticsearch及检查端口是否处于监听状态</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># systemctl start elasticsearch</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># netstat -nltup |grep java</span></span><br><span class=\"line\">tcp6       <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span><span class=\"symbol\">:</span><span class=\"number\">9200</span>       ::<span class=\"symbol\">:*</span>                    LISTEN      <span class=\"number\">12887</span>/java          </span><br><span class=\"line\">tcp6       <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span><span class=\"symbol\">:</span><span class=\"number\">9300</span>       ::<span class=\"symbol\">:*</span>                    LISTEN      <span class=\"number\">12887</span>/java</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">将配置文件copy到linux-elk2上面并进行修改，配置启动等。</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># scp /etc/elasticsearch/elasticsearch.yml 192.168.1.32:/etc/elasticsearch/elasticsearch.yml</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># grep ^[a-Z] /etc/elasticsearch/elasticsearch.yml </span></span><br><span class=\"line\"><span class=\"symbol\">cluster.name:</span> ELK-Cluster</span><br><span class=\"line\"><span class=\"symbol\">node.name:</span> elk-node2</span><br><span class=\"line\"><span class=\"symbol\">path.data:</span> /elk/data</span><br><span class=\"line\"><span class=\"symbol\">path.logs:</span> /elk/logs</span><br><span class=\"line\"><span class=\"symbol\">bootstrap.memory_lock:</span> <span class=\"keyword\">true</span></span><br><span class=\"line\"><span class=\"symbol\">network.host:</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span></span><br><span class=\"line\"><span class=\"symbol\">http.port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"symbol\">discovery.zen.ping.unicast.hosts:</span> [<span class=\"string\">\"192.168.1.31\"</span>, <span class=\"string\">\"192.168.1.32\"</span>]</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># vim /usr/lib/systemd/system/elasticsearch.service</span></span><br><span class=\"line\"><span class=\"comment\"># 在[Service]下加入下面这行内容</span></span><br><span class=\"line\">LimitMEMLOCK=infinity</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># vim /etc/elasticsearch/jvm.options</span></span><br><span class=\"line\">-Xms2g</span><br><span class=\"line\">-Xmx2g</span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># mkdir -p /elk/&#123;data,logs&#125;</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># chown elasticsearch.elasticsearch /elk/ -R</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\"># systemctl start elasticsearch</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk2 ~]<span class=\"comment\">#  netstat -nltup |grep java</span></span><br><span class=\"line\">tcp6       <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span><span class=\"symbol\">:</span><span class=\"number\">9200</span>       ::<span class=\"symbol\">:*</span>                    LISTEN      <span class=\"number\">18667</span>/java          </span><br><span class=\"line\">tcp6       <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span><span class=\"symbol\">:</span><span class=\"number\">9300</span>       ::<span class=\"symbol\">:*</span>                    LISTEN      <span class=\"number\">18667</span>/java</span><br></pre></td></tr></table></figure>\n<p>通过浏览器访问<code>elasticsearch</code>端口<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk01.png\" alt=\"elk01.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk02.png\" alt=\"elk02.png\"></p>\n<h4 id=\"监控elasticsearch集群状态\"><a href=\"#监控elasticsearch集群状态\" class=\"headerlink\" title=\"监控elasticsearch集群状态\"></a>监控elasticsearch集群状态</h4><blockquote>\n<p>通过shell命令获取集群状态，这里获取到的是一个json格式的返回值，例如对status进行分析，如果等于green(绿色)就是运行在正常，等于yellow(黄色)表示副本分片丢失，red(红色)表示主分片丢失。<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"meta\"># curl http:<span class=\"comment\">//192.168.1.31:9200/_cluster/health?pretty=true</span></span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"cluster_name\"</span> : <span class=\"string\">\"ELK-Cluster\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"status\"</span> : <span class=\"string\">\"green\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"timed_out\"</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_nodes\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_data_nodes\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_primary_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"relocating_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"initializing_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"unassigned_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"delayed_unassigned_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_pending_tasks\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_in_flight_fetch\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"task_max_waiting_in_queue_millis\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_shards_percent_as_number\"</span> : <span class=\"number\">100.0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"meta\"># curl http:<span class=\"comment\">//192.168.1.32:9200/_cluster/health?pretty=true</span></span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"cluster_name\"</span> : <span class=\"string\">\"ELK-Cluster\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"status\"</span> : <span class=\"string\">\"green\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"timed_out\"</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_nodes\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_data_nodes\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_primary_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"relocating_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"initializing_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"unassigned_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"delayed_unassigned_shards\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_pending_tasks\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"number_of_in_flight_fetch\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"task_max_waiting_in_queue_millis\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"active_shards_percent_as_number\"</span> : <span class=\"number\">100.0</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"安装elasticsearch插件head\"><a href=\"#安装elasticsearch插件head\" class=\"headerlink\" title=\"安装elasticsearch插件head\"></a>安装elasticsearch插件head</h4><blockquote>\n<p>我们不可能经常通过命令来查看集群的信息，所以就使用到了插件 –<code>head</code>。件是为了完成不同的功能，官方提供了一些插件但大部分是收费的，另外也有一些开发爱好者提供的插件，可以实现对<code>elasticsearch</code>集群的状态监控与管理配置等功能。<br>head：主要用来做集群管理的插件<br>下载地址：<a href=\"https://github.com/mobz/elasticsearch-head\" target=\"_blank\" rel=\"noopener\">https://github.com/mobz/elasticsearch-head</a></p>\n</blockquote>\n<p>1）安装<br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装npm和git</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># yum -y install npm git</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装elasticsearch-head插件</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># cd /usr/local/src/</span></span><br><span class=\"line\">[root@linux-elk1 src]<span class=\"comment\"># git clone git://github.com/mobz/elasticsearch-head.git</span></span><br><span class=\"line\">[root@linux-elk1 src]<span class=\"comment\"># cd elasticsearch-head/</span></span><br><span class=\"line\">[root@linux-elk1 elasticsearch-head]<span class=\"comment\"># npm install grunt -save --registry=https://registry.npm.taobao.org</span></span><br><span class=\"line\">[root@linux-elk1 elasticsearch-head]<span class=\"comment\"># ll node_modules/grunt    #确定该目录有生成文件</span></span><br><span class=\"line\">总用量 <span class=\"number\">24</span></span><br><span class=\"line\">drwxr-xr-x. <span class=\"number\">2</span> root root   <span class=\"number\">19</span> <span class=\"number\">4</span>月   <span class=\"number\">6</span> <span class=\"number\">2016</span> bin</span><br><span class=\"line\">-rw-r--r--. <span class=\"number\">1</span> root root <span class=\"number\">7111</span> <span class=\"number\">4</span>月   <span class=\"number\">6</span> <span class=\"number\">2016</span> CHANGELOG</span><br><span class=\"line\">drwxr-xr-x. <span class=\"number\">4</span> root root   <span class=\"number\">47</span> <span class=\"number\">7</span>月   <span class=\"number\">4</span> 09:<span class=\"number\">21</span> lib</span><br><span class=\"line\">-rw-r--r--. <span class=\"number\">1</span> root root <span class=\"number\">1592</span> <span class=\"number\">3</span>月  <span class=\"number\">23</span> <span class=\"number\">2016</span> LICENSE</span><br><span class=\"line\">drwxr-xr-x. <span class=\"number\">5</span> root root   <span class=\"number\">50</span> <span class=\"number\">7</span>月   <span class=\"number\">4</span> 09:<span class=\"number\">21</span> node_modules</span><br><span class=\"line\">-rw-r--r--. <span class=\"number\">1</span> root root <span class=\"number\">4108</span> <span class=\"number\">7</span>月   <span class=\"number\">4</span> 09:<span class=\"number\">21</span> package.json</span><br><span class=\"line\">-rw-r--r--. <span class=\"number\">1</span> root root  <span class=\"number\">878</span> <span class=\"number\">2</span>月  <span class=\"number\">12</span> <span class=\"number\">2016</span> README.md</span><br><span class=\"line\">[root@linux-elk1 elasticsearch-head]<span class=\"comment\"># npm install --registry=https://registry.npm.taobao.org    #执行安装</span></span><br><span class=\"line\">[root@linux-elk1 elasticsearch-head]<span class=\"comment\"># npm run start &amp;    #后台启动服务</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># ss -nlt |grep 9100</span></span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">128</span>          *:<span class=\"number\">9100</span>                     *:* </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#------------------------补充说明------------------------</span></span><br><span class=\"line\">由于上面npm安装时候超级慢，使用taobao源同样慢，这里将已安装的打成了包，可以直接下载使用即可</span><br><span class=\"line\">下载地址：https:<span class=\"regexp\">//pan</span>.baidu.com/<span class=\"keyword\">s</span>/<span class=\"number\">16</span>zDlecKVfmkEeInPcRx9NQ   提取码：h89<span class=\"number\">0</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># yum -y install npm</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># cd /usr/local/src/</span></span><br><span class=\"line\">[root@linux-elk1 src]<span class=\"comment\"># ls</span></span><br><span class=\"line\">elasticsearch-head.tar.gz</span><br><span class=\"line\">[root@linux-elk1 src]<span class=\"comment\"># tar xvzf elasticsearch-head.tar.gz</span></span><br><span class=\"line\">[root@linux-elk1 src]<span class=\"comment\"># cd elasticsearch-head/</span></span><br><span class=\"line\">[root@linux-elk1 elasticsearch-head]<span class=\"comment\"># npm run start &amp;</span></span><br><span class=\"line\"><span class=\"comment\">#--------------------------------------------------------</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改elasticsearch服务配置文件，开启跨域访问支持，然后重启elasticsearch服务</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/elasticsearch/elasticsearch.yml</span></span><br><span class=\"line\">http.cors.enabled: true     <span class=\"comment\">#最下方添加</span></span><br><span class=\"line\">http.cors.allow-origin: <span class=\"string\">\"*\"</span></span><br></pre></td></tr></table></figure></p>\n<p>为了方便管理<code>elasticsearch-head</code>插件，编写一个启动脚本<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /usr/bin/elasticsearch-head</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#desc: elasticsearch-head service manager</span></span><br><span class=\"line\"><span class=\"comment\">#date: 2019</span></span><br><span class=\"line\"></span><br><span class=\"line\">data=<span class=\"string\">\"cd /usr/local/src/elasticsearch-head/; nohup npm run start &gt; /dev/null 2&gt;&amp;1 &amp; \"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">START</span></span> ()&#123;</span><br><span class=\"line\">    <span class=\"built_in\">eval</span> <span class=\"variable\">$data</span> &amp;&amp; <span class=\"built_in\">echo</span> -e <span class=\"string\">\"elasticsearch-head start\\033[32m     ok\\033[0m\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">STOP</span></span> ()&#123;</span><br><span class=\"line\">    ps -ef |grep grunt |grep -v <span class=\"string\">\"grep\"</span> |awk <span class=\"string\">'&#123;print $2&#125;'</span> |xargs <span class=\"built_in\">kill</span> -s 9 &gt; /dev/null &amp;&amp; <span class=\"built_in\">echo</span> -e <span class=\"string\">\"elasticsearch-head stop\\033[32m      ok\\033[0m\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">    start)</span><br><span class=\"line\">        START</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">    stop)</span><br><span class=\"line\">        STOP</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">    restart)</span><br><span class=\"line\">        STOP</span><br><span class=\"line\">        sleep 3</span><br><span class=\"line\">        START</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">    *)</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"Usage: elasticsearch-head (start|stop|restart)\"</span></span><br><span class=\"line\">        ;;</span><br><span class=\"line\"><span class=\"keyword\">esac</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># chmod +x /usr/bin/elasticsearch-head</span></span><br></pre></td></tr></table></figure></p>\n<p>2）浏览器访问<code>9100端口</code>，将连接地址修改为<code>elasticsearch</code>地址。<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk03.png\" alt=\"elk03.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk04.png\" alt=\"elk04.png\"></p>\n<p>3）测试提交数据<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk05.png\" alt=\"elk05.png\"></p>\n<p>4）验证索引是否存在<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk06.png\" alt=\"elk06.png\"></p>\n<p>5）查看数据<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk07.png\" alt=\"elk07.png\"></p>\n<p>6）Master和Slave的区别：</p>\n<blockquote>\n<p><code>Master</code>的职责：<br>统计各<code>node</code>节点状态信息、集群状态信息统计、索引的创建和删除、索引分配的管理、关闭<code>node</code>节点等<br><code>Savle</code>的职责：<br>同步数据、等待机会称为<code>Master</code></p>\n</blockquote>\n<h2 id=\"Logstash部署\"><a href=\"#Logstash部署\" class=\"headerlink\" title=\"Logstash部署\"></a>Logstash部署</h2><blockquote>\n<p>Logstash 是一个开源的数据收集引擎，可以水平伸缩，而且logstash是整个ELK当中拥有最多插件的一个组件，其可以接收来自不同来源的数据并同意输出到指定的且可以是多个不同目的地。官网下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#logstash\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/cn/downloads/past-releases#logstash</a></p>\n</blockquote>\n<h3 id=\"安装logstash\"><a href=\"#安装logstash\" class=\"headerlink\" title=\"安装logstash\"></a>安装logstash</h3><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># wget https://artifacts.elastic.co/downloads/logstash/logstash-6.8.1.rpm</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># yum -y localinstall logstash-6.8.1.rpm</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"测试logstash是否正常\"><a href=\"#测试logstash是否正常\" class=\"headerlink\" title=\"测试logstash是否正常\"></a>测试logstash是否正常</h3><p>1）测试标准输入输出<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># /usr/share/logstash/bin/logstash -e 'input &#123; stdin &#123;&#125; &#125; output &#123; stdout &#123; codec =&gt; rubydebug&#125; &#125;'  </span></span><br><span class=\"line\">hello world    <span class=\"comment\">#输入</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,    <span class=\"comment\">#事件版本号，一个事件就是一个ruby对象</span></span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-04</span>T04:<span class=\"number\">30</span>:<span class=\"number\">35.106</span>Z,    <span class=\"comment\">#当前事件发生的事件</span></span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"linux-elk1.exmaple.com\"</span>,    <span class=\"comment\">#标记事件发生在哪里</span></span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"hello world\"</span>    <span class=\"comment\">#消息的具体内容</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）测试输出到文件<br><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># /usr/share/logstash/bin/logstash   -e 'input &#123; stdin&#123;&#125; &#125; output &#123; file &#123; path =&gt; \"/tmp/log-%&#123;+YYYY.MM.dd&#125;messages.gz\"&#125;&#125;'</span></span><br><span class=\"line\">hello world   <span class=\"comment\">#输入</span></span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">04</span> <span class=\"number\">17</span><span class=\"symbol\">:</span><span class=\"number\">33</span><span class=\"symbol\">:</span><span class=\"number\">06</span>.<span class=\"number\">065</span> [[main]&gt;worker<span class=\"number\">0</span>] file - Opening file &#123;<span class=\"symbol\">:path=&gt;<span class=\"string\">\"/tmp/log-2019.07.04messages.gz\"</span></span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># tail /tmp/log-2019.07.04messages.gz </span></span><br><span class=\"line\">&#123;<span class=\"string\">\"message\"</span><span class=\"symbol\">:<span class=\"string\">\"hello world\"</span></span>,<span class=\"string\">\"@version\"</span><span class=\"symbol\">:<span class=\"string\">\"1\"</span></span>,<span class=\"string\">\"host\"</span><span class=\"symbol\">:<span class=\"string\">\"linux-elk1.exmaple.com\"</span></span>,<span class=\"string\">\"@timestamp\"</span><span class=\"symbol\">:<span class=\"string\">\"2019-07-04T09:33:05.698Z\"</span></span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）测试输出到elasticsearch<br><figure class=\"highlight ocaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash   -e <span class=\"symbol\">'input</span> &#123;  stdin&#123;&#125; &#125; output &#123; elasticsearch &#123;hosts =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>] index =&gt; <span class=\"string\">\"mytest-%&#123;+YYYY.MM.dd&#125;\"</span> &#125;&#125;<span class=\"string\">'</span></span><br></pre></td></tr></table></figure></p>\n<p>4）elasticsearch服务器验证收到数据<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># ll /elk/data/nodes/0/indices/</span></span><br><span class=\"line\">总用量 0</span><br><span class=\"line\">drwxr-xr-x.<span class=\"number\"> 8 </span>elasticsearch elasticsearch<span class=\"number\"> 65 </span>7月  <span class=\"number\"> 4 </span>17:23 4jaihRq6Qu6NQWVxbuRQZg</span><br><span class=\"line\">drwxr-xr-x.<span class=\"number\"> 8 </span>elasticsearch elasticsearch<span class=\"number\"> 65 </span>7月  <span class=\"number\"> 4 </span>17:22 kkd_RCldSeaCX3y1XKzdgA</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk08.png\" alt=\"elk08.png\"></p>\n<h2 id=\"kibana部署\"><a href=\"#kibana部署\" class=\"headerlink\" title=\"kibana部署\"></a>kibana部署</h2><blockquote>\n<p><code>Kibana</code>是一个通过调用<code>elasticsearch</code>服务器进行图形化展示搜索结果的开源项目。官网下载地址：<a href=\"https://www.elastic.co/cn/downloads/past-releases#kibana\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/cn/downloads/past-releases#kibana</a></p>\n</blockquote>\n<h3 id=\"安装kibana\"><a href=\"#安装kibana\" class=\"headerlink\" title=\"安装kibana\"></a>安装kibana</h3><figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># wget https://artifacts.elastic.co/downloads/kibana/kibana-6.8.1-x86_64.rpm</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># yum -y localinstall kibana-6.8.1-x86_64.rpm</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/kibana/kibana.yml </span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># grep ^[a-Z] /etc/kibana/kibana.yml </span></span><br><span class=\"line\">server.port: <span class=\"number\">5601</span>    <span class=\"comment\">#监听端口</span></span><br><span class=\"line\">server.host: <span class=\"string\">\"192.168.1.31\"</span>    <span class=\"comment\">#监听地址</span></span><br><span class=\"line\">elasticsearch.hosts: [<span class=\"string\">\"http://192.168.1.31:9200\"</span>]    <span class=\"comment\">#elasticsearch服务器地址</span></span><br><span class=\"line\">i18n.locale: <span class=\"string\">\"zh-CN\"</span>    <span class=\"comment\">#修改为中文</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"启动kibana并验证\"><a href=\"#启动kibana并验证\" class=\"headerlink\" title=\"启动kibana并验证\"></a>启动kibana并验证</h3><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># systemctl start kibana</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># systemctl enable kibana</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># ss -nlt  |grep 5601</span></span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">128</span>    <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span><span class=\"symbol\">:</span><span class=\"number\">5601</span>                     *<span class=\"symbol\">:*</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"查看状态\"><a href=\"#查看状态\" class=\"headerlink\" title=\"查看状态\"></a>查看状态</h3><p><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk09.png\" alt=\"elk09.png\"></p>\n<h2 id=\"通过logstash收集系统message日志\"><a href=\"#通过logstash收集系统message日志\" class=\"headerlink\" title=\"通过logstash收集系统message日志\"></a>通过logstash收集系统message日志</h2><blockquote>\n<p>说明：通过<code>logstash</code>收集别的日志文件，前提需要<code>logstash</code>用户对被收集的日志文件有读的权限并对写入的文件有写的权限</p>\n</blockquote>\n<p>1）配置<code>logstash</code>配置文件<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/system-log.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/var/log/messages\"</span>    <span class=\"comment\">#日志路径</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"systemlog\"</span>            <span class=\"comment\">#类型，自定义，在进行多个日志收集存储时可以通过该项进行判断输出</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span>        <span class=\"comment\">#logstash 从什么位置开始读取文件数据，默认是结束位置，也就是说 logstash 进程会以类似 tail -F 的形式运行。如果你是要导入原有数据，把这个设定改成 \"beginning\"，logstash 进程就从头开始读取，类似 less +F 的形式运行。</span></span><br><span class=\"line\">\t\t<span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"2\"</span>    <span class=\"comment\">#logstash 每隔多久检查一次被监听文件状态（是否有更新），默认是 1 秒</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]        <span class=\"comment\">#elasticsearch服务器地址</span></span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"logstash-%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;\"</span>    <span class=\"comment\">#索引名称</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）检测配置文件语法是否有错误<br><figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/system-<span class=\"built_in\">log</span>.conf -t    #检测配置文件是否有语法错误</span><br><span class=\"line\">WARNING: Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> logstash.yml which is typically located <span class=\"keyword\">in</span> $LS_HOME/<span class=\"built_in\">config</span> <span class=\"keyword\">or</span> /etc/logstash. You can specify the <span class=\"built_in\">path</span> using <span class=\"comment\">--path.settings. Continuing using the defaults</span></span><br><span class=\"line\">Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> log4j2 configuration at <span class=\"built_in\">path</span> /usr/share/logstash/<span class=\"built_in\">config</span>/log4j2.properties. Using default <span class=\"built_in\">config</span> which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-05</span> <span class=\"number\">10</span>:<span class=\"number\">09</span>:<span class=\"number\">59.423</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command line options are specified</span><br><span class=\"line\">Configuration OK</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-05</span> <span class=\"number\">10</span>:<span class=\"number\">10</span>:<span class=\"number\">27.993</span> [LogStash::Runner] runner - Using <span class=\"built_in\">config</span>.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br></pre></td></tr></table></figure></p>\n<p>3）修改日志文件的权限并重启<code>logstash</code><br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# ll /<span class=\"keyword\">var</span>/<span class=\"keyword\">log</span>/messages     </span><br><span class=\"line\">-rw-------. 1 root root 786219 7月   5 10:10 /<span class=\"keyword\">var</span>/<span class=\"keyword\">log</span>/messages</span><br><span class=\"line\">#这里可以看到该日志文件是600权限，而elasticsearch是运行在elasticsearch用户下，这样elasticsearch是无法收集日志的。所以这里需要更改日志的权限，否则会报权限拒绝的错误。在日志中查看/<span class=\"keyword\">var</span>/<span class=\"keyword\">log</span>/logstash/logstash-plain.<span class=\"keyword\">log</span> 是否有错误。</span><br><span class=\"line\">[root@linux-elk1 ~]# chmod 644 /<span class=\"keyword\">var</span>/<span class=\"keyword\">log</span>/messages</span><br><span class=\"line\">[root@linux-elk1 ~]# systemctl  restart logstash</span><br></pre></td></tr></table></figure></p>\n<p>4）elasticsearch界面查看并查询<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk10.png\" alt=\"elk10.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk11.png\" alt=\"elk11.png\"><br>5）kibana界面创建索引并查看<br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk12.png\" alt=\"elk12.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk13.png\" alt=\"elk13.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk14.png\" alt=\"elk14.png\"><br><img src=\"/2019/07/05/ELK快速入门一-基本部署/elk15.png\" alt=\"elk15.png\"></p>\n"},{"title":"ELK快速入门二-通过logstash收集日志","date":"2019-07-05T06:30:35.000Z","copyright":true,"_content":"## 说明\n>这里的环境接着上面的ELK快速入门-基本部署文章继续下面的操作。\n\n\n## 收集多个日志文件\n1）`logstash`配置文件编写\n```\n[root@linux-elk1 ~]# vim /etc/logstash/conf.d/system-log.conf\ninput {\n    file {\n        path => \"/var/log/messages\"\n        type => \"systemlog\"\n        start_position => \"beginning\"\n        stat_interval => \"3\"\n    }\n    file {\n        path => \"/var/log/secure\"\n        type => \"securelog\"\n        start_position => \"beginning\"\n        stat_interval => \"3\"\n    }\n}\n\noutput {\n    if [type] == \"systemlog\" { \n        elasticsearch {\n            hosts => [\"192.168.1.31:9200\"]\n            index => \"system-log-%{+YYYY.MM.dd}\"\n        }\n    }\n    if [type] == \"securelog\" { \n        elasticsearch {\n            hosts => [\"192.168.1.31:9200\"]\n            index => \"secure-log-%{+YYYY.MM.dd}\"\n        }\n    }\n}\n```\n2）给日志文件赋予可读权限并重启`logstash`\n```\n[root@linux-elk1 ~]# chmod 644 /var/log/secure \n[root@linux-elk1 ~]# chmod 644 /var/log/messages\n[root@linux-elk1 ~]# systemctl restart logstash\n```\n3）向被收集的文件中写入数据；是为了马上能在`elasticsearch`的`web`界面和`klbana`的`web`界面里面查看到数据。\n```\n[root@linux-elk1 ~]# echo \"test\" >> /var/log/secure \n[root@linux-elk1 ~]# echo \"test\" >> /var/log/messages\n```\n4）在`kibana`界面添加`system-log`索引模式\n![log01.png](ELK快速入门二-通过logstash收集日志/log01.png)\n![log02.png](ELK快速入门二-通过logstash收集日志/log02.png)\n5）在`kibana`界面添加`secure-log`索引模式\n![log03.png](ELK快速入门二-通过logstash收集日志/log03.png)\n![log04.png](ELK快速入门二-通过logstash收集日志/log04.png)\n6）`kibana`查看日志\n![log05.png](ELK快速入门二-通过logstash收集日志/log05.png)\n\n\n\n\n\n\n## 收集tomcat和java日志\n>收集`Tomcat`服务器的访问日志以及`Tomcat`错误日志进行实时统计，在`kibana`页面进行搜索展示，每台`Tomcat`服务器需要安装`logstash`负责收集日志，然后将日志发给`elasticsearch`进行分析，在通过`kibana`在前端展示。\n\n### 部署tomcat服务\n>说明，我这里在`linux-elk2`节点上面装`tomcat`\n\n1）下载并安装`tomcat`\n```\n[root@linux-elk2 ~]# cd /usr/local/\n[root@linux-elk2 local]# wget http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-9/v9.0.21/bin/apache-tomcat-9.0.21.tar.gz\n[root@linux-elk2 local]# tar xvzf apache-tomcat-9.0.21.tar.gz\n[root@linux-elk2 local]# ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat\n```\n2）测试页面准备\n```\n[root@linux-elk2 local]# cd /usr/local/tomcat/webapps/\n[root@linux-elk2 webapps]# mkdir webdir\n[root@linux-elk2 webapps]# echo \"<h1>Welcome to Tomcat</h1>\"  > /usr/local/tomcat/webapps/webdir/index.html\n```\n3）`tomcat`日志转`json`\n```\n[root@linux-elk2 tomcat]# vim /usr/local/tomcat/conf/server.xml\n        <Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"logs\"\n               prefix=\"localhost_access_log\" suffix=\".txt\"\n               pattern=\"{&quot;clientip&quot;:&quot;%h&quot;,&quot;ClientUser&quot;:&quot;%l&quot;,&quot;authenticated&quot;:&quot;%u&quot;,&quot;AccessTime&quot;:&quot;%t&quot;,&quot;method&quot;:&quot;%r&quot;,&quot;status&quot;:&quot;%s&quot;,&quot;SendBytes&quot;:&quot;%b&quot;,&quot;Query?string&quot;:&quot;%q&quot;,&quot;partner&quot;:&quot;%{Referer}i&quot;,&quot;AgentVersion&quot;:&quot;%{User-Agent}i&quot;}\"/>\n```\n4）启动`tomcat`，并进行访问测试生成日志\n```\n[root@linux-elk2 tomcat]# /usr/local/tomcat/bin/startup.sh\n[root@linux-elk2 tomcat]# ss -nlt |grep 8080\nLISTEN     0      100         :::8080                    :::*\n[root@linux-elk2 tomcat]# ab -n100 -c100 http://192.168.1.32:8080/webdir/\n\n[root@linux-elk2 ~]# tailf /usr/local/tomcat/logs/localhost_access_log.2019-07-05.log \n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n```\n5）验证日志是否为`json`格式，http://www.kjson.com/\n![log06.png](ELK快速入门二-通过logstash收集日志/log06.png)\n\n### 配置logstash收集tomcat日志\n>说明：如果是需要收集别的服务器上面的`tomcat`日志，那么在所需要收集的服务器上面都得安装`logstash`。此处是在`linux-elk2`节点上面部署的`tomcat`，之前安装过`logstash`。\n\n1）配置`logstash`\n```\n[root@linux-elk2 ~]# vim /etc/logstash/conf.d/tomcat.conf\ninput {\n    file {\n        path => \"/usr/local/tomcat/logs/localhost_access_log.*.log\"\n        type => \"tomcat-access-log\"\n        start_position => \"beginning\"\n        stat_interval => \"2\"\n    }\n}\n\noutput {\n    elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]\n        index => \"logstash-tomcat-132-accesslog-%{+YYYY.MM.dd}\"\n    }\n    file {\n        path => \"/tmp/logstash-tomcat-132-accesslog-%{+YYYY.MM.dd}\"\n    }\n}\n```\n2）检测配置文件语法，并重启`logstash`\n```\n[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tomcat.conf -tWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-05 17:04:34.583 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n\n[root@linux-elk2 ~]# /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd\n[root@linux-elk2 ~]# systemctl start logstash\n```\n3）权限修改，不然`elasticsearch`界面和`kibana`界面是无法查看到的\n```\n[root@linux-elk2 ~]# ll /usr/local/tomcat/logs/ -d\ndrwxr-xr-x 2 root root 197 7月   5 16:36 /usr/local/tomcat/logs/\n[root@linux-elk2 ~]# ll /usr/local/tomcat/logs/\n总用量 64\n-rw-r----- 1 root root 14228 7月   5 16:36 catalina.2019-07-05.log\n-rw-r----- 1 root root 14228 7月   5 16:36 catalina.out\n-rw-r----- 1 root root     0 7月   5 16:25 host-manager.2019-07-05.log\n-rw-r----- 1 root root  1074 7月   5 16:36 localhost.2019-07-05.log\n-rw-r----- 1 root root 26762 7月   5 17:23 localhost_access_log.2019-07-05.log\n-rw-r----- 1 root root     0 7月   5 16:25 manager.2019-07-05.log\n[root@linux-elk2 ~]# chown logstash.logstash /usr/local/tomcat/logs/ -R\n[root@linux-elk2 ~]# ll /usr/local/tomcat/logs/\n总用量 64\n-rw-r----- 1 logstash logstash 14228 7月   5 16:36 catalina.2019-07-05.log\n-rw-r----- 1 logstash logstash 14228 7月   5 16:36 catalina.out\n-rw-r----- 1 logstash logstash     0 7月   5 16:25 host-manager.2019-07-05.log\n-rw-r----- 1 logstash logstash  1074 7月   5 16:36 localhost.2019-07-05.log\n-rw-r----- 1 logstash logstash 26762 7月   5 17:23 localhost_access_log.2019-07-05.log\n-rw-r----- 1 logstash logstash     0 7月   5 16:25 manager.2019-07-05.log\n```\n4）访问`elasticsearch`界面验证插件\n![log07.png](ELK快速入门二-通过logstash收集日志/log07.png)\n数据浏览\n![log08.png](ELK快速入门二-通过logstash收集日志/log08.png)\n\n5）在`kibana`上添加索引模式\n![log09.png](ELK快速入门二-通过logstash收集日志/log09.png)\n![log10.png](ELK快速入门二-通过logstash收集日志/log10.png)\n6）`kibana`验证数据\n![log11.png](ELK快速入门二-通过logstash收集日志/log11.png)\n\n\n\n### 配置logstash收集java日志\n>使用codec的multiline插件实现多行匹配，这是一个可以将多行进行合并的插件，而且可以使用what指定将匹配到的行与前面的行合并还是和后面的行合并，https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html\n\n语法格式：\n```\ninput {\n    stdin {\n        codec => multiline {\n            pattern => \"^\\[\"    #当遇到[开头的行时候将多行进行合并\n            negate => true      #true为匹配成功进行操作，false为不成功进行操\n            what => \"previous\"  #与上面的行合并，如果是下面的行合并就是\n        }\n    }\n}\n```\n命令行测试输入输出：\n```\n[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -e 'input { stdin { codec => multiline { pattern => \"^\\[\" negate => true what => \"previous\" } } } output { stdout { codec => rubydebug }}'\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-08 15:28:04.938 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\n[INFO ] 2019-07-08 15:28:04.968 [LogStash::Runner] runner - Starting Logstash {\"logstash.version\"=>\"6.8.1\"}\n[INFO ] 2019-07-08 15:28:19.167 [Converge PipelineAction::Create<main>] pipeline - Starting pipeline {:pipeline_id=>\"main\", \"pipeline.workers\"=>1, \"pipeline.batch.size\"=>125, \"pipeline.batch.delay\"=>50}\n[INFO ] 2019-07-08 15:28:19.918 [Converge PipelineAction::Create<main>] pipeline - Pipeline started successfully {:pipeline_id=>\"main\", :thread=>\"#<Thread:0xc8dd9a1 run>\"}\nThe stdin plugin is now waiting for input:\n111111\n222222\naaaaaa\n[44444\n{\n    \"@timestamp\" => 2019-07-08T07:34:48.063Z,\n          \"tags\" => [\n        [0] \"multiline\"\n    ],\n      \"@version\" => \"1\",\n       \"message\" => \"[12\\n111111\\n222222\\naaaaaa\",\n          \"host\" => \"linux-elk2.exmaple.com\"\n}\n\n444444\naaaaaa\n[77777\n{\n    \"@timestamp\" => 2019-07-08T07:35:51.522Z,\n          \"tags\" => [\n        [0] \"multiline\"\n    ],\n      \"@version\" => \"1\",\n       \"message\" => \"[44444\\n444444\\naaaaaa\",\n          \"host\" => \"linux-elk2.exmaple.com\"\n}\n```\n**示例：收集ELK集群日志**\n1）观察日志文件，`elk`集群日志都是以`\"[\"`开头并且每一个信息都是如此。\n```\n[root@linux-elk2 ~]# tailf /elk/logs/ELK-Cluster.log \n[2019-07-08T11:26:37,774][INFO ][o.e.c.m.MetaDataIndexTemplateService] [elk-node2] adding template [kibana_index_template:.kibana] for index patterns [.kibana]\n[2019-07-08T11:26:47,664][INFO ][o.e.c.m.MetaDataIndexTemplateService] [elk-node2] adding template [kibana_index_template:.kibana] for index patterns [.kibana]\n[2019-07-08T11:33:55,150][INFO ][o.e.c.m.MetaDataIndexTemplateService] [elk-node2] adding template [kibana_index_template:.kibana] for index patterns [.kibana]\n[2019-07-08T11:33:55,197][INFO ][o.e.c.m.MetaDataMappingService] [elk-node2] [.kibana_1/yRee-8HYS8KiVwnuADXAbA] update_mapping [doc]\n[2019-07-08T11:33:55,822][INFO ][o.e.c.m.MetaDataIndexTemplateService] [elk-node2] adding template [kibana_index_template:.kibana] for index patterns [.kibana]\n[2019-07-08T11:33:55,905][INFO ][o.e.c.m.MetaDataMappingService] [elk-node2] [.kibana_1/yRee-8HYS8KiVwnuADXAbA] update_mapping [doc]\n[2019-07-08T11:33:57,026][INFO ][o.e.c.m.MetaDataIndexTemplateService] [elk-node2] adding template [kibana_index_template:.kibana] for index patterns [.kibana]\n[2019-07-08T11:43:20,262][WARN ][o.e.m.j.JvmGcMonitorService] [elk-node2] [gc][young][8759][66] duration [1.3s], collections [1]/[1.7s], total [1.3s]/[4s], memory [176mb]->[111.6mb]/[1.9gb], all_pools {[young] [64.8mb]->[706.4kb]/[66.5mb]}{[survivor] [3.3mb]->[3mb]/[8.3mb]}{[old] [107.8mb]->[107.8mb]/[1.9gb]}\n[2019-07-08T11:43:20,388][WARN ][o.e.m.j.JvmGcMonitorService] [elk-node2] [gc][8759] overhead, spent [1.3s] collecting in the last [1.7s]\n[2019-07-08T11:44:42,955][INFO ][o.e.x.m.p.NativeController] [elk-node2] Native controller process has stopped - no new native processes can be started\n```\n2）配置`logstash`\n```\n[root@linux-elk2 ~]# vim /etc/logstash/conf.d/java.conf\ninput {\n    file {\n        path => \"/elk/logs/ELK-Cluster.log\"\n        type => \"java-elk-cluster-log\"\n        start_position => \"beginning\"\n        stat_interval => \"2\"\n        code => multiline {\n            pattern => \"^\\[\"    #以\"[\"开头进行正则匹配，匹配规则\n            negate => \"true\"  #正则匹配成功，false匹配不成功\n            what => \"previous\"  #和前面的内容进行合并,如果是和下面的合并就是next\n        }\n    }\n}\n\noutput {\n    if [type] == \"java-elk-cluster-log\" {\n        elasticsearch {\n            hosts => [\"192.168.1.31:9200\"]\n            index => \"java-elk-cluster-log-%{+YYYY.MM.dd}\"\n        }\n    }\n}\n```\n3）检查配置文件语法是否有误并重启`logstash`\n```\n[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/java.conf -t\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-08 15:49:51.996 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n[INFO ] 2019-07-08 15:50:04.438 [LogStash::Runner] runner - Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash\n\n[root@linux-elk2 ~]# systemctl restart logstash\n```\n4）访问`elasticsearch`界面验证数据\n![log12.png](ELK快速入门二-通过logstash收集日志/log12.png)\n5）在`kibana`上添加索引验证模式\n![log13.png](ELK快速入门二-通过logstash收集日志/log13.png)\n![log14.png](ELK快速入门二-通过logstash收集日志/log14.png)\n6）`kibana`验证数据\n![log15.png](ELK快速入门二-通过logstash收集日志/log15.png)\n\n\n\n\n## 收集Nginx访问日志\n>收集`nginx`的`json`访问日志，这里为了测试，是在一台新的服务器上面安装了`nginx`和`logstash`\n\n1）安装nginx并准备一个测试页面\n```\n[root@node01 ~]# yum -y install nginx\n[root@node01 ~]# echo \"<h1>whelcom to nginx server</h1>\" > /usr/share/nginx/html/index.html\n[root@node01 ~]# systemctl start nginx \n[root@node01 ~]# curl localhost\n<h1>whelcom to nginx server</h1>\n```\n2）将nginx日志转换成json格式\n```\n[root@node01 ~]# vim /etc/nginx/nginx.conf\n    log_format access_json '{\"@timestamp\":\"$time_iso8601\",'\n                           '\"host\":\"$server_addr\",'\n                           '\"clientip\":\"$remote_addr\",'\n                           '\"size\":$body_bytes_sent,'\n                           '\"responsetime\":$request_time,'\n                           '\"upstreamtime\":\"$upstream_response_time\",'\n                           '\"upstreamhost\":\"$upstream_addr\",'\n                           '\"http_host\":\"$host\",'\n                           '\"url\":\"$uri\",'\n                           '\"domain\":\"$host\",'\n                           '\"xff\":\"$http_x_forwarded_for\",'\n                           '\"referer\":\"$http_referer\",'\n                           '\"status\":\"$status\"}';\n\n    access_log  /var/log/nginx/access.log  access_json;\n\n[root@node01 ~]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@node01 ~]# systemctl restart nginx\n```\n3）访问一次，确认日志为`json`格式\n![log16.png](ELK快速入门二-通过logstash收集日志/log16.png)\n\n```\n[root@node01 ~]# tail /var/log/nginx/access.log\n{\"@timestamp\":\"2019-07-09T11:21:28+08:00\",\"host\":\"192.168.1.30\",\"clientip\":\"192.168.1.144\",\"size\":33,\"responsetime\":0.000,\"upstreamtime\":\"-\",\"upstreamhost\":\"-\",\"http_host\":\"192.168.1.30\",\"url\":\"/index.html\",\"domain\":\"192.168.1.30\",\"xff\":\"-\",\"referer\":\"-\",\"status\":\"200\"}\n```\n4）安装`logstash`并配置收集`nginx`日志\n```\n#将logstash软件包copy到nginx服务器上\n[root@linux-elk1 ~]# scp logstash-6.8.1.rpm 192.168.1.30:/root/\n#安装logstash\n[root@node01 ~]# yum -y localinstall logstash-6.8.1.rpm\n#生成logstash.service启动文件\n[root@node01 ~]# /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd\n#将logstash启动用户更改为root，不然可能会导致收集不到日志\n[root@node01 ~]# vim /etc/systemd/system/logstash.service\nUser=root\nGroup=root\n[root@node01 ~]# systemctl daemon-reload\n\n[root@node01 ~]# vim /etc/logstash/conf.d/nginx.conf\ninput {\n    file {\n        path => \"/var/log/nginx/access.log\"\n        type => \"nginx-accesslog\"\n        start_position => \"beginning\"\n        stat_interval => \"2\"\n        codec => json\n    }\n}\n\noutput {\n    if [type] == \"nginx-accesslog\" {\n        elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]\n        index => \"logstash-nginx-accesslog-30-%{+YYYY.MM.dd}\"\n        }\n    }\n}\n```\n5）检查配置文件语法是否有误并重启`logstash`\n```\n[root@node01 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf -t\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-09 11:26:04.277 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n[INFO ] 2019-07-09 11:26:09.055 [LogStash::Runner] runner - Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash\n\n[root@node01 ~]# systemctl restart logstash\n```\n\n6）在`kibana`上添加索引验证模式\n![log17.png](ELK快速入门二-通过logstash收集日志/log17.png)\n![log18.png](ELK快速入门二-通过logstash收集日志/log18.png)\n\n7）在`kibana`上验证数据,可以通过添加筛选，让日志更加了然名目\n![log19.png](ELK快速入门二-通过logstash收集日志/log19.png)\n\n\n\n\n\n\n\n## 收集TCP/UDP日志\n>通过`logstash`的`tcp/udp`插件收集日志，通常用于在向`elasticsearch`日志补录丢失的部分日志，可以将丢失的日志通过一个`TCP`端口直接写入到`elasticsearch`服务器。\n\n### 进行收集测试\n1）logstash配置\n```\n[root@linux-elk1 ~]# vim /etc/logstash/conf.d/tcp.conf\ninput {\n    tcp {\n        port => 9889\n        type => \"tcplog\"\n        mode => \"server\"\n    }\n}\n\noutput {\n    stdout {\n        codec => rubydebug\n    }\n}\n```\n2）验证端口是否启动成功\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcp.conf \nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-09 18:12:07.538 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\n[INFO ] 2019-07-09 18:12:07.551 [LogStash::Runner] runner - Starting Logstash {\"logstash.version\"=>\"6.8.1\"}\n[INFO ] 2019-07-09 18:12:14.416 [Converge PipelineAction::Create<main>] pipeline - Starting pipeline {:pipeline_id=>\"main\", \"pipeline.workers\"=>2, \"pipeline.batch.size\"=>125, \"pipeline.batch.delay\"=>50}\n[INFO ] 2019-07-09 18:12:14.885 [Converge PipelineAction::Create<main>] pipeline - Pipeline started successfully {:pipeline_id=>\"main\", :thread=>\"#<Thread:0x240c27a6 sleep>\"}\n[INFO ] 2019-07-09 18:12:14.911 [[main]<tcp] tcp - Starting tcp input listener {:address=>\"0.0.0.0:9889\", :ssl_enable=>\"false\"}\n[INFO ] 2019-07-09 18:12:14.953 [Ruby-0-Thread-1: /usr/share/logstash/lib/bootstrap/environment.rb:6] agent - Pipelines running {:count=>1, :running_pipelines=>[:main], :non_running_pipelines=>[]}\n[INFO ] 2019-07-09 18:12:15.223 [Api Webserver] agent - Successfully started Logstash API endpoint {:port=>9600}\n\n\n# 新开一个终端验证端口\n[root@linux-elk1 ~]# netstat -nlutp |grep 9889\ntcp6       0      0 :::9889                 :::*                    LISTEN      112455/java\n```\n3）在别的服务器通过nc命令进行测试，查看logstash是否收到数据\n```\n\n# echo \"nc test\" | nc 192.168.1.31 9889    #在另外一台服务器上执行\n\n# 在上面启动logstash的那个终端查看\n{\n       \"message\" => \"nc test\",\n          \"host\" => \"192.168.1.30\",\n          \"type\" => \"tcplog\",\n      \"@version\" => \"1\",\n    \"@timestamp\" => 2019-07-09T10:16:48.139Z,\n          \"port\" => 37102\n}\n```\n4）通过nc命令发送一个文件，查看logstash收到的数据\n```\n# nc 192.168.1.31 9889 < /etc/passwd    #同样在上面执行nc那台服务器上执行\n\n# 同样还是在上面启动logstash的那个终端查看\n{\n       \"message\" => \"mysql:x:27:27:MariaDB Server:/var/lib/mysql:/sbin/nologin\",\n          \"host\" => \"192.168.1.30\",\n          \"type\" => \"tcplog\",\n      \"@version\" => \"1\",\n    \"@timestamp\" => 2019-07-09T10:18:29.186Z,\n          \"port\" => 37104\n}\n{\n       \"message\" => \"logstash:x:989:984:logstash:/usr/share/logstash:/sbin/nologin\",\n          \"host\" => \"192.168.1.30\",\n          \"type\" => \"tcplog\",\n      \"@version\" => \"1\",\n    \"@timestamp\" => 2019-07-09T10:18:29.187Z,\n          \"port\" => 37104\n}\n```\n5）通过伪设备的方式发送消息：\n在类Unix操作系统中，设备节点并不一定要对应物理设备。没有这种对应关系的设备是伪设备。操作系统运用了它们提供的多种功能，tcp只是dev下面众多伪设备当中的一种设备。\n```\n# echo \"伪设备\" >/dev/tcp/192.168.1.31/9889    #同样在上面执行nc那台服务器上执行\n\n# 同样还是在上面启动logstash的那个终端查看\n{\n       \"message\" => \"伪设备\",\n          \"host\" => \"192.168.1.30\",\n          \"type\" => \"tcplog\",\n      \"@version\" => \"1\",\n    \"@timestamp\" => 2019-07-09T10:21:32.487Z,\n          \"port\" => 37106\n}\n```\n6）将输出更改到elasticsearch\n```\n[root@linux-elk1 ~]# vim /etc/logstash/conf.d/tcp.conf\ninput {\n    tcp {\n        port => 9889\n        type => \"tcplog\"\n        mode => \"server\"\n    }\n}\n\noutput {\n    elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]\n        index => \"logstash-tcp-log-%{+YYYY.MM.dd}\"\n    }\n}\n```\n7）通过nc命令或伪设备输入日志\n```\n# echo \"伪设备 1\" >/dev/tcp/192.168.1.31/9889\n# echo \"伪设备 2\" >/dev/tcp/192.168.1.31/9889\n```\n8）在kibana界面创建索引模式\n![log20.png](ELK快速入门二-通过logstash收集日志/log20.png)\n![log21.png](ELK快速入门二-通过logstash收集日志/log21.png)\n9）验证数据\n![log22.png](ELK快速入门二-通过logstash收集日志/log22.png)\n\n\n\n\n\n\n\n\n\n","source":"_posts/ELK快速入门二-通过logstash收集日志.md","raw":"---\ntitle: ELK快速入门二-通过logstash收集日志\ndate: 2019-07-05 14:30:35\ntags: ELK\ncategories: ELK\ncopyright: true\n---\n## 说明\n>这里的环境接着上面的ELK快速入门-基本部署文章继续下面的操作。\n\n\n## 收集多个日志文件\n1）`logstash`配置文件编写\n```\n[root@linux-elk1 ~]# vim /etc/logstash/conf.d/system-log.conf\ninput {\n    file {\n        path => \"/var/log/messages\"\n        type => \"systemlog\"\n        start_position => \"beginning\"\n        stat_interval => \"3\"\n    }\n    file {\n        path => \"/var/log/secure\"\n        type => \"securelog\"\n        start_position => \"beginning\"\n        stat_interval => \"3\"\n    }\n}\n\noutput {\n    if [type] == \"systemlog\" { \n        elasticsearch {\n            hosts => [\"192.168.1.31:9200\"]\n            index => \"system-log-%{+YYYY.MM.dd}\"\n        }\n    }\n    if [type] == \"securelog\" { \n        elasticsearch {\n            hosts => [\"192.168.1.31:9200\"]\n            index => \"secure-log-%{+YYYY.MM.dd}\"\n        }\n    }\n}\n```\n2）给日志文件赋予可读权限并重启`logstash`\n```\n[root@linux-elk1 ~]# chmod 644 /var/log/secure \n[root@linux-elk1 ~]# chmod 644 /var/log/messages\n[root@linux-elk1 ~]# systemctl restart logstash\n```\n3）向被收集的文件中写入数据；是为了马上能在`elasticsearch`的`web`界面和`klbana`的`web`界面里面查看到数据。\n```\n[root@linux-elk1 ~]# echo \"test\" >> /var/log/secure \n[root@linux-elk1 ~]# echo \"test\" >> /var/log/messages\n```\n4）在`kibana`界面添加`system-log`索引模式\n![log01.png](ELK快速入门二-通过logstash收集日志/log01.png)\n![log02.png](ELK快速入门二-通过logstash收集日志/log02.png)\n5）在`kibana`界面添加`secure-log`索引模式\n![log03.png](ELK快速入门二-通过logstash收集日志/log03.png)\n![log04.png](ELK快速入门二-通过logstash收集日志/log04.png)\n6）`kibana`查看日志\n![log05.png](ELK快速入门二-通过logstash收集日志/log05.png)\n\n\n\n\n\n\n## 收集tomcat和java日志\n>收集`Tomcat`服务器的访问日志以及`Tomcat`错误日志进行实时统计，在`kibana`页面进行搜索展示，每台`Tomcat`服务器需要安装`logstash`负责收集日志，然后将日志发给`elasticsearch`进行分析，在通过`kibana`在前端展示。\n\n### 部署tomcat服务\n>说明，我这里在`linux-elk2`节点上面装`tomcat`\n\n1）下载并安装`tomcat`\n```\n[root@linux-elk2 ~]# cd /usr/local/\n[root@linux-elk2 local]# wget http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-9/v9.0.21/bin/apache-tomcat-9.0.21.tar.gz\n[root@linux-elk2 local]# tar xvzf apache-tomcat-9.0.21.tar.gz\n[root@linux-elk2 local]# ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat\n```\n2）测试页面准备\n```\n[root@linux-elk2 local]# cd /usr/local/tomcat/webapps/\n[root@linux-elk2 webapps]# mkdir webdir\n[root@linux-elk2 webapps]# echo \"<h1>Welcome to Tomcat</h1>\"  > /usr/local/tomcat/webapps/webdir/index.html\n```\n3）`tomcat`日志转`json`\n```\n[root@linux-elk2 tomcat]# vim /usr/local/tomcat/conf/server.xml\n        <Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"logs\"\n               prefix=\"localhost_access_log\" suffix=\".txt\"\n               pattern=\"{&quot;clientip&quot;:&quot;%h&quot;,&quot;ClientUser&quot;:&quot;%l&quot;,&quot;authenticated&quot;:&quot;%u&quot;,&quot;AccessTime&quot;:&quot;%t&quot;,&quot;method&quot;:&quot;%r&quot;,&quot;status&quot;:&quot;%s&quot;,&quot;SendBytes&quot;:&quot;%b&quot;,&quot;Query?string&quot;:&quot;%q&quot;,&quot;partner&quot;:&quot;%{Referer}i&quot;,&quot;AgentVersion&quot;:&quot;%{User-Agent}i&quot;}\"/>\n```\n4）启动`tomcat`，并进行访问测试生成日志\n```\n[root@linux-elk2 tomcat]# /usr/local/tomcat/bin/startup.sh\n[root@linux-elk2 tomcat]# ss -nlt |grep 8080\nLISTEN     0      100         :::8080                    :::*\n[root@linux-elk2 tomcat]# ab -n100 -c100 http://192.168.1.32:8080/webdir/\n\n[root@linux-elk2 ~]# tailf /usr/local/tomcat/logs/localhost_access_log.2019-07-05.log \n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n{\"clientip\":\"192.168.1.32\",\"ClientUser\":\"-\",\"authenticated\":\"-\",\"AccessTime\":\"[05/Jul/2019:16:39:18 +0800]\",\"method\":\"GET /webdir/ HTTP/1.0\",\"status\":\"200\",\"SendBytes\":\"27\",\"Query?string\":\"\",\"partner\":\"-\",\"AgentVersion\":\"ApacheBench/2.3\"}\n```\n5）验证日志是否为`json`格式，http://www.kjson.com/\n![log06.png](ELK快速入门二-通过logstash收集日志/log06.png)\n\n### 配置logstash收集tomcat日志\n>说明：如果是需要收集别的服务器上面的`tomcat`日志，那么在所需要收集的服务器上面都得安装`logstash`。此处是在`linux-elk2`节点上面部署的`tomcat`，之前安装过`logstash`。\n\n1）配置`logstash`\n```\n[root@linux-elk2 ~]# vim /etc/logstash/conf.d/tomcat.conf\ninput {\n    file {\n        path => \"/usr/local/tomcat/logs/localhost_access_log.*.log\"\n        type => \"tomcat-access-log\"\n        start_position => \"beginning\"\n        stat_interval => \"2\"\n    }\n}\n\noutput {\n    elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]\n        index => \"logstash-tomcat-132-accesslog-%{+YYYY.MM.dd}\"\n    }\n    file {\n        path => \"/tmp/logstash-tomcat-132-accesslog-%{+YYYY.MM.dd}\"\n    }\n}\n```\n2）检测配置文件语法，并重启`logstash`\n```\n[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tomcat.conf -tWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-05 17:04:34.583 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n\n[root@linux-elk2 ~]# /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd\n[root@linux-elk2 ~]# systemctl start logstash\n```\n3）权限修改，不然`elasticsearch`界面和`kibana`界面是无法查看到的\n```\n[root@linux-elk2 ~]# ll /usr/local/tomcat/logs/ -d\ndrwxr-xr-x 2 root root 197 7月   5 16:36 /usr/local/tomcat/logs/\n[root@linux-elk2 ~]# ll /usr/local/tomcat/logs/\n总用量 64\n-rw-r----- 1 root root 14228 7月   5 16:36 catalina.2019-07-05.log\n-rw-r----- 1 root root 14228 7月   5 16:36 catalina.out\n-rw-r----- 1 root root     0 7月   5 16:25 host-manager.2019-07-05.log\n-rw-r----- 1 root root  1074 7月   5 16:36 localhost.2019-07-05.log\n-rw-r----- 1 root root 26762 7月   5 17:23 localhost_access_log.2019-07-05.log\n-rw-r----- 1 root root     0 7月   5 16:25 manager.2019-07-05.log\n[root@linux-elk2 ~]# chown logstash.logstash /usr/local/tomcat/logs/ -R\n[root@linux-elk2 ~]# ll /usr/local/tomcat/logs/\n总用量 64\n-rw-r----- 1 logstash logstash 14228 7月   5 16:36 catalina.2019-07-05.log\n-rw-r----- 1 logstash logstash 14228 7月   5 16:36 catalina.out\n-rw-r----- 1 logstash logstash     0 7月   5 16:25 host-manager.2019-07-05.log\n-rw-r----- 1 logstash logstash  1074 7月   5 16:36 localhost.2019-07-05.log\n-rw-r----- 1 logstash logstash 26762 7月   5 17:23 localhost_access_log.2019-07-05.log\n-rw-r----- 1 logstash logstash     0 7月   5 16:25 manager.2019-07-05.log\n```\n4）访问`elasticsearch`界面验证插件\n![log07.png](ELK快速入门二-通过logstash收集日志/log07.png)\n数据浏览\n![log08.png](ELK快速入门二-通过logstash收集日志/log08.png)\n\n5）在`kibana`上添加索引模式\n![log09.png](ELK快速入门二-通过logstash收集日志/log09.png)\n![log10.png](ELK快速入门二-通过logstash收集日志/log10.png)\n6）`kibana`验证数据\n![log11.png](ELK快速入门二-通过logstash收集日志/log11.png)\n\n\n\n### 配置logstash收集java日志\n>使用codec的multiline插件实现多行匹配，这是一个可以将多行进行合并的插件，而且可以使用what指定将匹配到的行与前面的行合并还是和后面的行合并，https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html\n\n语法格式：\n```\ninput {\n    stdin {\n        codec => multiline {\n            pattern => \"^\\[\"    #当遇到[开头的行时候将多行进行合并\n            negate => true      #true为匹配成功进行操作，false为不成功进行操\n            what => \"previous\"  #与上面的行合并，如果是下面的行合并就是\n        }\n    }\n}\n```\n命令行测试输入输出：\n```\n[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -e 'input { stdin { codec => multiline { pattern => \"^\\[\" negate => true what => \"previous\" } } } output { stdout { codec => rubydebug }}'\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-08 15:28:04.938 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\n[INFO ] 2019-07-08 15:28:04.968 [LogStash::Runner] runner - Starting Logstash {\"logstash.version\"=>\"6.8.1\"}\n[INFO ] 2019-07-08 15:28:19.167 [Converge PipelineAction::Create<main>] pipeline - Starting pipeline {:pipeline_id=>\"main\", \"pipeline.workers\"=>1, \"pipeline.batch.size\"=>125, \"pipeline.batch.delay\"=>50}\n[INFO ] 2019-07-08 15:28:19.918 [Converge PipelineAction::Create<main>] pipeline - Pipeline started successfully {:pipeline_id=>\"main\", :thread=>\"#<Thread:0xc8dd9a1 run>\"}\nThe stdin plugin is now waiting for input:\n111111\n222222\naaaaaa\n[44444\n{\n    \"@timestamp\" => 2019-07-08T07:34:48.063Z,\n          \"tags\" => [\n        [0] \"multiline\"\n    ],\n      \"@version\" => \"1\",\n       \"message\" => \"[12\\n111111\\n222222\\naaaaaa\",\n          \"host\" => \"linux-elk2.exmaple.com\"\n}\n\n444444\naaaaaa\n[77777\n{\n    \"@timestamp\" => 2019-07-08T07:35:51.522Z,\n          \"tags\" => [\n        [0] \"multiline\"\n    ],\n      \"@version\" => \"1\",\n       \"message\" => \"[44444\\n444444\\naaaaaa\",\n          \"host\" => \"linux-elk2.exmaple.com\"\n}\n```\n**示例：收集ELK集群日志**\n1）观察日志文件，`elk`集群日志都是以`\"[\"`开头并且每一个信息都是如此。\n```\n[root@linux-elk2 ~]# tailf /elk/logs/ELK-Cluster.log \n[2019-07-08T11:26:37,774][INFO ][o.e.c.m.MetaDataIndexTemplateService] [elk-node2] adding template [kibana_index_template:.kibana] for index patterns [.kibana]\n[2019-07-08T11:26:47,664][INFO ][o.e.c.m.MetaDataIndexTemplateService] [elk-node2] adding template [kibana_index_template:.kibana] for index patterns [.kibana]\n[2019-07-08T11:33:55,150][INFO ][o.e.c.m.MetaDataIndexTemplateService] [elk-node2] adding template [kibana_index_template:.kibana] for index patterns [.kibana]\n[2019-07-08T11:33:55,197][INFO ][o.e.c.m.MetaDataMappingService] [elk-node2] [.kibana_1/yRee-8HYS8KiVwnuADXAbA] update_mapping [doc]\n[2019-07-08T11:33:55,822][INFO ][o.e.c.m.MetaDataIndexTemplateService] [elk-node2] adding template [kibana_index_template:.kibana] for index patterns [.kibana]\n[2019-07-08T11:33:55,905][INFO ][o.e.c.m.MetaDataMappingService] [elk-node2] [.kibana_1/yRee-8HYS8KiVwnuADXAbA] update_mapping [doc]\n[2019-07-08T11:33:57,026][INFO ][o.e.c.m.MetaDataIndexTemplateService] [elk-node2] adding template [kibana_index_template:.kibana] for index patterns [.kibana]\n[2019-07-08T11:43:20,262][WARN ][o.e.m.j.JvmGcMonitorService] [elk-node2] [gc][young][8759][66] duration [1.3s], collections [1]/[1.7s], total [1.3s]/[4s], memory [176mb]->[111.6mb]/[1.9gb], all_pools {[young] [64.8mb]->[706.4kb]/[66.5mb]}{[survivor] [3.3mb]->[3mb]/[8.3mb]}{[old] [107.8mb]->[107.8mb]/[1.9gb]}\n[2019-07-08T11:43:20,388][WARN ][o.e.m.j.JvmGcMonitorService] [elk-node2] [gc][8759] overhead, spent [1.3s] collecting in the last [1.7s]\n[2019-07-08T11:44:42,955][INFO ][o.e.x.m.p.NativeController] [elk-node2] Native controller process has stopped - no new native processes can be started\n```\n2）配置`logstash`\n```\n[root@linux-elk2 ~]# vim /etc/logstash/conf.d/java.conf\ninput {\n    file {\n        path => \"/elk/logs/ELK-Cluster.log\"\n        type => \"java-elk-cluster-log\"\n        start_position => \"beginning\"\n        stat_interval => \"2\"\n        code => multiline {\n            pattern => \"^\\[\"    #以\"[\"开头进行正则匹配，匹配规则\n            negate => \"true\"  #正则匹配成功，false匹配不成功\n            what => \"previous\"  #和前面的内容进行合并,如果是和下面的合并就是next\n        }\n    }\n}\n\noutput {\n    if [type] == \"java-elk-cluster-log\" {\n        elasticsearch {\n            hosts => [\"192.168.1.31:9200\"]\n            index => \"java-elk-cluster-log-%{+YYYY.MM.dd}\"\n        }\n    }\n}\n```\n3）检查配置文件语法是否有误并重启`logstash`\n```\n[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/java.conf -t\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-08 15:49:51.996 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n[INFO ] 2019-07-08 15:50:04.438 [LogStash::Runner] runner - Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash\n\n[root@linux-elk2 ~]# systemctl restart logstash\n```\n4）访问`elasticsearch`界面验证数据\n![log12.png](ELK快速入门二-通过logstash收集日志/log12.png)\n5）在`kibana`上添加索引验证模式\n![log13.png](ELK快速入门二-通过logstash收集日志/log13.png)\n![log14.png](ELK快速入门二-通过logstash收集日志/log14.png)\n6）`kibana`验证数据\n![log15.png](ELK快速入门二-通过logstash收集日志/log15.png)\n\n\n\n\n## 收集Nginx访问日志\n>收集`nginx`的`json`访问日志，这里为了测试，是在一台新的服务器上面安装了`nginx`和`logstash`\n\n1）安装nginx并准备一个测试页面\n```\n[root@node01 ~]# yum -y install nginx\n[root@node01 ~]# echo \"<h1>whelcom to nginx server</h1>\" > /usr/share/nginx/html/index.html\n[root@node01 ~]# systemctl start nginx \n[root@node01 ~]# curl localhost\n<h1>whelcom to nginx server</h1>\n```\n2）将nginx日志转换成json格式\n```\n[root@node01 ~]# vim /etc/nginx/nginx.conf\n    log_format access_json '{\"@timestamp\":\"$time_iso8601\",'\n                           '\"host\":\"$server_addr\",'\n                           '\"clientip\":\"$remote_addr\",'\n                           '\"size\":$body_bytes_sent,'\n                           '\"responsetime\":$request_time,'\n                           '\"upstreamtime\":\"$upstream_response_time\",'\n                           '\"upstreamhost\":\"$upstream_addr\",'\n                           '\"http_host\":\"$host\",'\n                           '\"url\":\"$uri\",'\n                           '\"domain\":\"$host\",'\n                           '\"xff\":\"$http_x_forwarded_for\",'\n                           '\"referer\":\"$http_referer\",'\n                           '\"status\":\"$status\"}';\n\n    access_log  /var/log/nginx/access.log  access_json;\n\n[root@node01 ~]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@node01 ~]# systemctl restart nginx\n```\n3）访问一次，确认日志为`json`格式\n![log16.png](ELK快速入门二-通过logstash收集日志/log16.png)\n\n```\n[root@node01 ~]# tail /var/log/nginx/access.log\n{\"@timestamp\":\"2019-07-09T11:21:28+08:00\",\"host\":\"192.168.1.30\",\"clientip\":\"192.168.1.144\",\"size\":33,\"responsetime\":0.000,\"upstreamtime\":\"-\",\"upstreamhost\":\"-\",\"http_host\":\"192.168.1.30\",\"url\":\"/index.html\",\"domain\":\"192.168.1.30\",\"xff\":\"-\",\"referer\":\"-\",\"status\":\"200\"}\n```\n4）安装`logstash`并配置收集`nginx`日志\n```\n#将logstash软件包copy到nginx服务器上\n[root@linux-elk1 ~]# scp logstash-6.8.1.rpm 192.168.1.30:/root/\n#安装logstash\n[root@node01 ~]# yum -y localinstall logstash-6.8.1.rpm\n#生成logstash.service启动文件\n[root@node01 ~]# /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd\n#将logstash启动用户更改为root，不然可能会导致收集不到日志\n[root@node01 ~]# vim /etc/systemd/system/logstash.service\nUser=root\nGroup=root\n[root@node01 ~]# systemctl daemon-reload\n\n[root@node01 ~]# vim /etc/logstash/conf.d/nginx.conf\ninput {\n    file {\n        path => \"/var/log/nginx/access.log\"\n        type => \"nginx-accesslog\"\n        start_position => \"beginning\"\n        stat_interval => \"2\"\n        codec => json\n    }\n}\n\noutput {\n    if [type] == \"nginx-accesslog\" {\n        elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]\n        index => \"logstash-nginx-accesslog-30-%{+YYYY.MM.dd}\"\n        }\n    }\n}\n```\n5）检查配置文件语法是否有误并重启`logstash`\n```\n[root@node01 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf -t\nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-09 11:26:04.277 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\nConfiguration OK\n[INFO ] 2019-07-09 11:26:09.055 [LogStash::Runner] runner - Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash\n\n[root@node01 ~]# systemctl restart logstash\n```\n\n6）在`kibana`上添加索引验证模式\n![log17.png](ELK快速入门二-通过logstash收集日志/log17.png)\n![log18.png](ELK快速入门二-通过logstash收集日志/log18.png)\n\n7）在`kibana`上验证数据,可以通过添加筛选，让日志更加了然名目\n![log19.png](ELK快速入门二-通过logstash收集日志/log19.png)\n\n\n\n\n\n\n\n## 收集TCP/UDP日志\n>通过`logstash`的`tcp/udp`插件收集日志，通常用于在向`elasticsearch`日志补录丢失的部分日志，可以将丢失的日志通过一个`TCP`端口直接写入到`elasticsearch`服务器。\n\n### 进行收集测试\n1）logstash配置\n```\n[root@linux-elk1 ~]# vim /etc/logstash/conf.d/tcp.conf\ninput {\n    tcp {\n        port => 9889\n        type => \"tcplog\"\n        mode => \"server\"\n    }\n}\n\noutput {\n    stdout {\n        codec => rubydebug\n    }\n}\n```\n2）验证端口是否启动成功\n```\n[root@linux-elk1 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcp.conf \nWARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults\nCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console\n[WARN ] 2019-07-09 18:12:07.538 [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified\n[INFO ] 2019-07-09 18:12:07.551 [LogStash::Runner] runner - Starting Logstash {\"logstash.version\"=>\"6.8.1\"}\n[INFO ] 2019-07-09 18:12:14.416 [Converge PipelineAction::Create<main>] pipeline - Starting pipeline {:pipeline_id=>\"main\", \"pipeline.workers\"=>2, \"pipeline.batch.size\"=>125, \"pipeline.batch.delay\"=>50}\n[INFO ] 2019-07-09 18:12:14.885 [Converge PipelineAction::Create<main>] pipeline - Pipeline started successfully {:pipeline_id=>\"main\", :thread=>\"#<Thread:0x240c27a6 sleep>\"}\n[INFO ] 2019-07-09 18:12:14.911 [[main]<tcp] tcp - Starting tcp input listener {:address=>\"0.0.0.0:9889\", :ssl_enable=>\"false\"}\n[INFO ] 2019-07-09 18:12:14.953 [Ruby-0-Thread-1: /usr/share/logstash/lib/bootstrap/environment.rb:6] agent - Pipelines running {:count=>1, :running_pipelines=>[:main], :non_running_pipelines=>[]}\n[INFO ] 2019-07-09 18:12:15.223 [Api Webserver] agent - Successfully started Logstash API endpoint {:port=>9600}\n\n\n# 新开一个终端验证端口\n[root@linux-elk1 ~]# netstat -nlutp |grep 9889\ntcp6       0      0 :::9889                 :::*                    LISTEN      112455/java\n```\n3）在别的服务器通过nc命令进行测试，查看logstash是否收到数据\n```\n\n# echo \"nc test\" | nc 192.168.1.31 9889    #在另外一台服务器上执行\n\n# 在上面启动logstash的那个终端查看\n{\n       \"message\" => \"nc test\",\n          \"host\" => \"192.168.1.30\",\n          \"type\" => \"tcplog\",\n      \"@version\" => \"1\",\n    \"@timestamp\" => 2019-07-09T10:16:48.139Z,\n          \"port\" => 37102\n}\n```\n4）通过nc命令发送一个文件，查看logstash收到的数据\n```\n# nc 192.168.1.31 9889 < /etc/passwd    #同样在上面执行nc那台服务器上执行\n\n# 同样还是在上面启动logstash的那个终端查看\n{\n       \"message\" => \"mysql:x:27:27:MariaDB Server:/var/lib/mysql:/sbin/nologin\",\n          \"host\" => \"192.168.1.30\",\n          \"type\" => \"tcplog\",\n      \"@version\" => \"1\",\n    \"@timestamp\" => 2019-07-09T10:18:29.186Z,\n          \"port\" => 37104\n}\n{\n       \"message\" => \"logstash:x:989:984:logstash:/usr/share/logstash:/sbin/nologin\",\n          \"host\" => \"192.168.1.30\",\n          \"type\" => \"tcplog\",\n      \"@version\" => \"1\",\n    \"@timestamp\" => 2019-07-09T10:18:29.187Z,\n          \"port\" => 37104\n}\n```\n5）通过伪设备的方式发送消息：\n在类Unix操作系统中，设备节点并不一定要对应物理设备。没有这种对应关系的设备是伪设备。操作系统运用了它们提供的多种功能，tcp只是dev下面众多伪设备当中的一种设备。\n```\n# echo \"伪设备\" >/dev/tcp/192.168.1.31/9889    #同样在上面执行nc那台服务器上执行\n\n# 同样还是在上面启动logstash的那个终端查看\n{\n       \"message\" => \"伪设备\",\n          \"host\" => \"192.168.1.30\",\n          \"type\" => \"tcplog\",\n      \"@version\" => \"1\",\n    \"@timestamp\" => 2019-07-09T10:21:32.487Z,\n          \"port\" => 37106\n}\n```\n6）将输出更改到elasticsearch\n```\n[root@linux-elk1 ~]# vim /etc/logstash/conf.d/tcp.conf\ninput {\n    tcp {\n        port => 9889\n        type => \"tcplog\"\n        mode => \"server\"\n    }\n}\n\noutput {\n    elasticsearch {\n        hosts => [\"192.168.1.31:9200\"]\n        index => \"logstash-tcp-log-%{+YYYY.MM.dd}\"\n    }\n}\n```\n7）通过nc命令或伪设备输入日志\n```\n# echo \"伪设备 1\" >/dev/tcp/192.168.1.31/9889\n# echo \"伪设备 2\" >/dev/tcp/192.168.1.31/9889\n```\n8）在kibana界面创建索引模式\n![log20.png](ELK快速入门二-通过logstash收集日志/log20.png)\n![log21.png](ELK快速入门二-通过logstash收集日志/log21.png)\n9）验证数据\n![log22.png](ELK快速入门二-通过logstash收集日志/log22.png)\n\n\n\n\n\n\n\n\n\n","slug":"ELK快速入门二-通过logstash收集日志","published":1,"updated":"2019-10-24T09:12:16.862Z","_id":"cjz3xyitr000hdstc81arw9mu","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h2><blockquote>\n<p>这里的环境接着上面的ELK快速入门-基本部署文章继续下面的操作。</p>\n</blockquote>\n<h2 id=\"收集多个日志文件\"><a href=\"#收集多个日志文件\" class=\"headerlink\" title=\"收集多个日志文件\"></a>收集多个日志文件</h2><p>1）<code>logstash</code>配置文件编写<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/system-log.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/var/log/messages\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"systemlog\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"3\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">file</span> &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/var/log/secure\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"securelog\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"3\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [<span class=\"built_in\">type</span>] == <span class=\"string\">\"systemlog\"</span> &#123; </span><br><span class=\"line\">        elasticsearch &#123;</span><br><span class=\"line\">            <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">            <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"system-log-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if [type] == <span class=\"string\">\"securelog\"</span> &#123; </span><br><span class=\"line\">        <span class=\"keyword\">elasticsearch</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">            <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"secure-log-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）给日志文件赋予可读权限并重启<code>logstash</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># chmod 644 /var/log/secure </span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># chmod 644 /var/log/messages</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p>\n<p>3）向被收集的文件中写入数据；是为了马上能在<code>elasticsearch</code>的<code>web</code>界面和<code>klbana</code>的<code>web</code>界面里面查看到数据。<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"test\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/secure </span><br><span class=\"line\">[root@linux-elk1 ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"test\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br></pre></td></tr></table></figure></p>\n<p>4）在<code>kibana</code>界面添加<code>system-log</code>索引模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log01.png\" alt=\"log01.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log02.png\" alt=\"log02.png\"><br>5）在<code>kibana</code>界面添加<code>secure-log</code>索引模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log03.png\" alt=\"log03.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log04.png\" alt=\"log04.png\"><br>6）<code>kibana</code>查看日志<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log05.png\" alt=\"log05.png\"></p>\n<h2 id=\"收集tomcat和java日志\"><a href=\"#收集tomcat和java日志\" class=\"headerlink\" title=\"收集tomcat和java日志\"></a>收集tomcat和java日志</h2><blockquote>\n<p>收集<code>Tomcat</code>服务器的访问日志以及<code>Tomcat</code>错误日志进行实时统计，在<code>kibana</code>页面进行搜索展示，每台<code>Tomcat</code>服务器需要安装<code>logstash</code>负责收集日志，然后将日志发给<code>elasticsearch</code>进行分析，在通过<code>kibana</code>在前端展示。</p>\n</blockquote>\n<h3 id=\"部署tomcat服务\"><a href=\"#部署tomcat服务\" class=\"headerlink\" title=\"部署tomcat服务\"></a>部署tomcat服务</h3><blockquote>\n<p>说明，我这里在<code>linux-elk2</code>节点上面装<code>tomcat</code></p>\n</blockquote>\n<p>1）下载并安装<code>tomcat</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 ~]<span class=\"meta\"># cd /usr/local/</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 <span class=\"keyword\">local</span>]<span class=\"meta\"># wget http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-9/v9.0.21/bin/apache-tomcat-9.0.21.tar.gz</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 <span class=\"keyword\">local</span>]<span class=\"meta\"># tar xvzf apache-tomcat-9.0.21.tar.gz</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 <span class=\"keyword\">local</span>]<span class=\"meta\"># ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat</span></span><br></pre></td></tr></table></figure></p>\n<p>2）测试页面准备<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 <span class=\"keyword\">local</span>]<span class=\"meta\"># cd /usr/local/tomcat/webapps/</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 webapps]<span class=\"meta\"># mkdir webdir</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 webapps]<span class=\"meta\"># echo <span class=\"string\">\"&lt;h1&gt;Welcome to Tomcat&lt;/h1&gt;\"</span>  &gt; /usr/local/tomcat/webapps/webdir/index.html</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>tomcat</code>日志转<code>json</code><br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 tomcat]<span class=\"meta\"># vim /usr/local/tomcat/conf/server.xml</span></span><br><span class=\"line\">        <span class=\"params\">&lt;Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"logs\"</span></span><br><span class=\"line\"><span class=\"params\">               prefix=\"localhost_access_log\" suffix=\".txt\"</span></span><br><span class=\"line\"><span class=\"params\">               pattern=\"&#123;<span class=\"variable\">&amp;quot</span>;clientip<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%h<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;ClientUser<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%l<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;authenticated<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%u<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;AccessTime<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%t<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;method<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%r<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;status<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%s<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;SendBytes<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%b<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;Query?string<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%q<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;partner<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%&#123;Referer&#125;i<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;AgentVersion<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%&#123;User-Agent&#125;i<span class=\"variable\">&amp;quot</span>;&#125;\"/&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>4）启动<code>tomcat</code>，并进行访问测试生成日志<br><figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@linux-elk2 tomcat]</span># /usr/local/tomcat/bin/startup.sh</span><br><span class=\"line\"><span class=\"string\">[root@linux-elk2 tomcat]</span># ss -nlt |grep <span class=\"number\">8080</span></span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">100</span>         :::<span class=\"number\">8080</span>                    :::*</span><br><span class=\"line\"><span class=\"string\">[root@linux-elk2 tomcat]</span># ab -n100 -c100 http://<span class=\"number\">192.168.1.32:8080</span>/webdir/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@linux-elk2 ~]</span># tailf /usr/local/tomcat/logs/localhost_access_log.<span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">05</span>.log </span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>5）验证日志是否为<code>json</code>格式，<a href=\"http://www.kjson.com/\" target=\"_blank\" rel=\"noopener\">http://www.kjson.com/</a><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log06.png\" alt=\"log06.png\"></p>\n<h3 id=\"配置logstash收集tomcat日志\"><a href=\"#配置logstash收集tomcat日志\" class=\"headerlink\" title=\"配置logstash收集tomcat日志\"></a>配置logstash收集tomcat日志</h3><blockquote>\n<p>说明：如果是需要收集别的服务器上面的<code>tomcat</code>日志，那么在所需要收集的服务器上面都得安装<code>logstash</code>。此处是在<code>linux-elk2</code>节点上面部署的<code>tomcat</code>，之前安装过<code>logstash</code>。</p>\n</blockquote>\n<p>1）配置<code>logstash</code><br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/tomcat.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/usr/local/tomcat/logs/localhost_access_log.*.log\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"tomcat-access-log\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"2\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"logstash-tomcat-132-accesslog-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">file</span> &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/tmp/logstash-tomcat-132-accesslog-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）检测配置文件语法，并重启<code>logstash</code><br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tomcat.conf -tWARNING: Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> logstash.yml which is typically located in $LS_HOME/<span class=\"built_in\">config</span> <span class=\"keyword\">or</span> /etc/logstash. You can specify the path <span class=\"keyword\">using</span> --path.settings. Continuing <span class=\"keyword\">using</span> the defaults</span><br><span class=\"line\">Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> log4j2 configuration at path /usr/share/logstash/<span class=\"built_in\">config</span>/log4j2.properties. Using <span class=\"built_in\">default</span> <span class=\"built_in\">config</span> which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-05</span> <span class=\"number\">17</span>:<span class=\"number\">04</span>:<span class=\"number\">34.583</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command <span class=\"built_in\">line</span> options are specified</span><br><span class=\"line\">Configuration OK</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk2 ~]# /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd</span><br><span class=\"line\">[root@linux-elk2 ~]<span class=\"meta\"># systemctl start logstash</span></span><br></pre></td></tr></table></figure></p>\n<p>3）权限修改，不然<code>elasticsearch</code>界面和<code>kibana</code>界面是无法查看到的<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># ll /usr/local/tomcat/logs/ -d</span></span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>root root<span class=\"number\"> 197 </span>7月  <span class=\"number\"> 5 </span>16:36 /usr/local/tomcat/logs/</span><br><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># ll /usr/local/tomcat/logs/</span></span><br><span class=\"line\">总用量 64</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root<span class=\"number\"> 14228 </span>7月  <span class=\"number\"> 5 </span>16:36 catalina.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root<span class=\"number\"> 14228 </span>7月  <span class=\"number\"> 5 </span>16:36 catalina.out</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root    <span class=\"number\"> 0 </span>7月  <span class=\"number\"> 5 </span>16:25 host-manager.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root <span class=\"number\"> 1074 </span>7月  <span class=\"number\"> 5 </span>16:36 localhost.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root<span class=\"number\"> 26762 </span>7月  <span class=\"number\"> 5 </span>17:23 localhost_access_log.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root    <span class=\"number\"> 0 </span>7月  <span class=\"number\"> 5 </span>16:25 manager.2019-07-05.log</span><br><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># chown logstash.logstash /usr/local/tomcat/logs/ -R</span></span><br><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># ll /usr/local/tomcat/logs/</span></span><br><span class=\"line\">总用量 64</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash<span class=\"number\"> 14228 </span>7月  <span class=\"number\"> 5 </span>16:36 catalina.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash<span class=\"number\"> 14228 </span>7月  <span class=\"number\"> 5 </span>16:36 catalina.out</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash    <span class=\"number\"> 0 </span>7月  <span class=\"number\"> 5 </span>16:25 host-manager.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash <span class=\"number\"> 1074 </span>7月  <span class=\"number\"> 5 </span>16:36 localhost.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash<span class=\"number\"> 26762 </span>7月  <span class=\"number\"> 5 </span>17:23 localhost_access_log.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash    <span class=\"number\"> 0 </span>7月  <span class=\"number\"> 5 </span>16:25 manager.2019-07-05.log</span><br></pre></td></tr></table></figure></p>\n<p>4）访问<code>elasticsearch</code>界面验证插件<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log07.png\" alt=\"log07.png\"><br>数据浏览<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log08.png\" alt=\"log08.png\"></p>\n<p>5）在<code>kibana</code>上添加索引模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log09.png\" alt=\"log09.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log10.png\" alt=\"log10.png\"><br>6）<code>kibana</code>验证数据<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log11.png\" alt=\"log11.png\"></p>\n<h3 id=\"配置logstash收集java日志\"><a href=\"#配置logstash收集java日志\" class=\"headerlink\" title=\"配置logstash收集java日志\"></a>配置logstash收集java日志</h3><blockquote>\n<p>使用codec的multiline插件实现多行匹配，这是一个可以将多行进行合并的插件，而且可以使用what指定将匹配到的行与前面的行合并还是和后面的行合并，<a href=\"https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html</a></p>\n</blockquote>\n<p>语法格式：<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    stdin &#123;</span><br><span class=\"line\">        <span class=\"attr\">codec</span> =&gt; multiline &#123;</span><br><span class=\"line\">            <span class=\"attr\">pattern</span> =&gt; <span class=\"string\">\"^\\[\"</span>    <span class=\"comment\">#当遇到[开头的行时候将多行进行合并</span></span><br><span class=\"line\">            <span class=\"attr\">negate</span> =&gt; <span class=\"keyword\">true</span>      <span class=\"comment\">#true为匹配成功进行操作，false为不成功进行操</span></span><br><span class=\"line\">            <span class=\"attr\">what</span> =&gt; <span class=\"string\">\"previous\"</span>  <span class=\"comment\">#与上面的行合并，如果是下面的行合并就是</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>命令行测试输入输出：<br><figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -e 'input &#123; stdin &#123; codec =&gt; multiline &#123; <span class=\"built_in\">pattern</span> =&gt; <span class=\"string\">\"^\\[\"</span> negate =&gt; true what =&gt; <span class=\"string\">\"previous\"</span> &#125; &#125; &#125; output &#123; stdout &#123; codec =&gt; rubydebug &#125;&#125;'</span><br><span class=\"line\">WARNING: Could not find logstash.yml which is typically located <span class=\"built_in\">in</span> $LS_HOME/config or /etc/logstash. You can specify the path <span class=\"built_in\">using</span> --path.settings. Continuing <span class=\"built_in\">using</span> the defaults</span><br><span class=\"line\">Could not find log4j2 configuration <span class=\"built_in\">at</span> path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">28</span>:<span class=\"number\">04.938</span> [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">28</span>:<span class=\"number\">04.968</span> [LogStash::Runner] runner - Starting Logstash &#123;<span class=\"string\">\"logstash.version\"</span>=&gt;<span class=\"string\">\"6.8.1\"</span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">28</span>:<span class=\"number\">19.167</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Starting pipeline &#123;:pipeline_id=&gt;<span class=\"string\">\"main\"</span>, <span class=\"string\">\"pipeline.workers\"</span>=&gt;<span class=\"number\">1</span>, <span class=\"string\">\"pipeline.batch.size\"</span>=&gt;<span class=\"number\">125</span>, <span class=\"string\">\"pipeline.batch.delay\"</span>=&gt;<span class=\"number\">50</span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">28</span>:<span class=\"number\">19.918</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Pipeline started successfully &#123;:pipeline_id=&gt;<span class=\"string\">\"main\"</span>, :thread=&gt;<span class=\"string\">\"#&lt;Thread:0xc8dd9a1 run&gt;\"</span>&#125;</span><br><span class=\"line\">The stdin plugin is now waiting <span class=\"keyword\">for</span> input:</span><br><span class=\"line\"><span class=\"number\">111111</span></span><br><span class=\"line\"><span class=\"number\">222222</span></span><br><span class=\"line\">aaaaaa</span><br><span class=\"line\">[<span class=\"number\">44444</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span>T07:<span class=\"number\">34</span>:<span class=\"number\">48.063</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"tags\"</span> =&gt; [</span><br><span class=\"line\">        [<span class=\"number\">0</span>] <span class=\"string\">\"multiline\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"[12\\n111111\\n222222\\naaaaaa\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"linux-elk2.exmaple.com\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">444444</span></span><br><span class=\"line\">aaaaaa</span><br><span class=\"line\">[<span class=\"number\">77777</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span>T07:<span class=\"number\">35</span>:<span class=\"number\">51.522</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"tags\"</span> =&gt; [</span><br><span class=\"line\">        [<span class=\"number\">0</span>] <span class=\"string\">\"multiline\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"[44444\\n444444\\naaaaaa\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"linux-elk2.exmaple.com\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例：收集ELK集群日志</strong><br>1）观察日志文件，<code>elk</code>集群日志都是以<code>&quot;[&quot;</code>开头并且每一个信息都是如此。<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]# tailf /elk/logs/ELK-Cluster.log </span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:26:37,774</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class=\"emphasis\">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:26:47,664</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class=\"emphasis\">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:33:55,150</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class=\"emphasis\">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:33:55,197</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataMappingService</span>] [elk-node2] [.kibana<span class=\"emphasis\">_1/yRee-8HYS8KiVwnuADXAbA] update_</span>mapping [doc]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:33:55,822</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class=\"emphasis\">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:33:55,905</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataMappingService</span>] [elk-node2] [.kibana<span class=\"emphasis\">_1/yRee-8HYS8KiVwnuADXAbA] update_</span>mapping [doc]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:33:57,026</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class=\"emphasis\">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:43:20,262</span>][<span class=\"symbol\">WARN </span>][<span class=\"string\">o.e.m.j.JvmGcMonitorService</span>] [<span class=\"string\">elk-node2</span>] [<span class=\"string\">gc</span>][<span class=\"symbol\">young</span>][<span class=\"string\">8759</span>][<span class=\"symbol\">66</span>] duration [1.3s], collections [1]/[1.7s], total [1.3s]/[4s], memory [176mb]-&gt;[111.6mb]/[1.9gb], all_pools &#123;[young] [64.8mb]-&gt;[706.4kb]/[66.5mb]&#125;&#123;[survivor] [3.3mb]-&gt;[3mb]/[8.3mb]&#125;&#123;[old] [107.8mb]-&gt;[107.8mb]/[1.9gb]&#125;</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:43:20,388</span>][<span class=\"symbol\">WARN </span>][<span class=\"string\">o.e.m.j.JvmGcMonitorService</span>] [<span class=\"string\">elk-node2</span>] [<span class=\"string\">gc</span>][<span class=\"symbol\">8759</span>] overhead, spent [1.3s] collecting in the last [1.7s]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:44:42,955</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.x.m.p.NativeController</span>] [elk-node2] Native controller process has stopped - no new native processes can be started</span><br></pre></td></tr></table></figure></p>\n<p>2）配置<code>logstash</code><br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/java.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/elk/logs/ELK-Cluster.log\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"java-elk-cluster-log\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"2\"</span></span><br><span class=\"line\">        <span class=\"attr\">code</span> =&gt; multiline &#123;</span><br><span class=\"line\">            <span class=\"attr\">pattern</span> =&gt; <span class=\"string\">\"^\\[\"</span>    <span class=\"comment\">#以\"[\"开头进行正则匹配，匹配规则</span></span><br><span class=\"line\">            <span class=\"attr\">negate</span> =&gt; <span class=\"string\">\"true\"</span>  <span class=\"comment\">#正则匹配成功，false匹配不成功</span></span><br><span class=\"line\">            <span class=\"attr\">what</span> =&gt; <span class=\"string\">\"previous\"</span>  <span class=\"comment\">#和前面的内容进行合并,如果是和下面的合并就是next</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [<span class=\"built_in\">type</span>] == <span class=\"string\">\"java-elk-cluster-log\"</span> &#123;</span><br><span class=\"line\">        elasticsearch &#123;</span><br><span class=\"line\">            <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">            <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"java-elk-cluster-log-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）检查配置文件语法是否有误并重启<code>logstash</code><br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/java.conf -t</span><br><span class=\"line\">WARNING: Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> logstash.yml which is typically located in $LS_HOME/<span class=\"built_in\">config</span> <span class=\"keyword\">or</span> /etc/logstash. You can specify the path <span class=\"keyword\">using</span> --path.settings. Continuing <span class=\"keyword\">using</span> the defaults</span><br><span class=\"line\">Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> log4j2 configuration at path /usr/share/logstash/<span class=\"built_in\">config</span>/log4j2.properties. Using <span class=\"built_in\">default</span> <span class=\"built_in\">config</span> which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">49</span>:<span class=\"number\">51.996</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command <span class=\"built_in\">line</span> options are specified</span><br><span class=\"line\">Configuration OK</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">50</span>:<span class=\"number\">04.438</span> [LogStash::Runner] runner - Using <span class=\"built_in\">config</span>.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk2 ~]<span class=\"meta\"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p>\n<p>4）访问<code>elasticsearch</code>界面验证数据<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log12.png\" alt=\"log12.png\"><br>5）在<code>kibana</code>上添加索引验证模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log13.png\" alt=\"log13.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log14.png\" alt=\"log14.png\"><br>6）<code>kibana</code>验证数据<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log15.png\" alt=\"log15.png\"></p>\n<h2 id=\"收集Nginx访问日志\"><a href=\"#收集Nginx访问日志\" class=\"headerlink\" title=\"收集Nginx访问日志\"></a>收集Nginx访问日志</h2><blockquote>\n<p>收集<code>nginx</code>的<code>json</code>访问日志，这里为了测试，是在一台新的服务器上面安装了<code>nginx</code>和<code>logstash</code></p>\n</blockquote>\n<p>1）安装nginx并准备一个测试页面<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@node01</span> ~]<span class=\"meta\"># yum -y install nginx</span></span><br><span class=\"line\">[root<span class=\"symbol\">@node01</span> ~]<span class=\"meta\"># echo <span class=\"string\">\"&lt;h1&gt;whelcom to nginx server&lt;/h1&gt;\"</span> &gt; /usr/share/nginx/html/index.html</span></span><br><span class=\"line\">[root<span class=\"symbol\">@node01</span> ~]<span class=\"meta\"># systemctl start nginx </span></span><br><span class=\"line\">[root<span class=\"symbol\">@node01</span> ~]<span class=\"meta\"># curl localhost</span></span><br><span class=\"line\">&lt;h1&gt;whelcom <span class=\"keyword\">to</span> nginx server&lt;/h1&gt;</span><br></pre></td></tr></table></figure></p>\n<p>2）将nginx日志转换成json格式<br><figure class=\"highlight julia\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"meta\">@node01</span> ~]<span class=\"comment\"># vim /etc/nginx/nginx.conf</span></span><br><span class=\"line\">    log_format access_json '&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"<span class=\"variable\">$time_iso8601</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"host\"</span>:<span class=\"string\">\"<span class=\"variable\">$server_addr</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"<span class=\"variable\">$remote_addr</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"size\"</span>:$body_bytes_sent,'</span><br><span class=\"line\">                           '<span class=\"string\">\"responsetime\"</span>:$request_time,'</span><br><span class=\"line\">                           '<span class=\"string\">\"upstreamtime\"</span>:<span class=\"string\">\"<span class=\"variable\">$upstream_response_time</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"upstreamhost\"</span>:<span class=\"string\">\"<span class=\"variable\">$upstream_addr</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"http_host\"</span>:<span class=\"string\">\"<span class=\"variable\">$host</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"url\"</span>:<span class=\"string\">\"<span class=\"variable\">$uri</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"domain\"</span>:<span class=\"string\">\"<span class=\"variable\">$host</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"xff\"</span>:<span class=\"string\">\"<span class=\"variable\">$http_x_forwarded_for</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"referer\"</span>:<span class=\"string\">\"<span class=\"variable\">$http_referer</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"status\"</span>:<span class=\"string\">\"<span class=\"variable\">$status</span>\"</span>&#125;';</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /var/log/nginx/access.log  access_json;</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"meta\">@node01</span> ~]<span class=\"comment\"># nginx -t</span></span><br><span class=\"line\">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class=\"line\">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class=\"line\">[root<span class=\"meta\">@node01</span> ~]<span class=\"comment\"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure></p>\n<p>3）访问一次，确认日志为<code>json</code>格式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log16.png\" alt=\"log16.png\"></p>\n<figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@node01 ~]# tail /var/<span class=\"keyword\">log</span>/nginx/access.<span class=\"keyword\">log</span></span><br><span class=\"line\">&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"2019-07-09T11:21:28+08:00\"</span>,<span class=\"string\">\"host\"</span>:<span class=\"string\">\"192.168.1.30\"</span>,<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.144\"</span>,<span class=\"string\">\"size\"</span>:<span class=\"number\">33</span>,<span class=\"string\">\"responsetime\"</span>:<span class=\"number\">0.000</span>,<span class=\"string\">\"upstreamtime\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"upstreamhost\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"http_host\"</span>:<span class=\"string\">\"192.168.1.30\"</span>,<span class=\"string\">\"url\"</span>:<span class=\"string\">\"/index.html\"</span>,<span class=\"string\">\"domain\"</span>:<span class=\"string\">\"192.168.1.30\"</span>,<span class=\"string\">\"xff\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"referer\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>&#125;</span><br></pre></td></tr></table></figure>\n<p>4）安装<code>logstash</code>并配置收集<code>nginx</code>日志<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#将logstash软件包copy到nginx服务器上</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># scp logstash-6.8.1.rpm 192.168.1.30:/root/</span></span><br><span class=\"line\"><span class=\"comment\">#安装logstash</span></span><br><span class=\"line\">[root@node01 ~]<span class=\"comment\"># yum -y localinstall logstash-6.8.1.rpm</span></span><br><span class=\"line\"><span class=\"comment\">#生成logstash.service启动文件</span></span><br><span class=\"line\">[root@node01 ~]<span class=\"comment\"># /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd</span></span><br><span class=\"line\"><span class=\"comment\">#将logstash启动用户更改为root，不然可能会导致收集不到日志</span></span><br><span class=\"line\">[root@node01 ~]<span class=\"comment\"># vim /etc/systemd/system/logstash.service</span></span><br><span class=\"line\">User=root</span><br><span class=\"line\">Group=root</span><br><span class=\"line\">[root@node01 ~]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@node01 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/nginx.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/var/log/nginx/access.log\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"nginx-accesslog\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"2\"</span></span><br><span class=\"line\">        <span class=\"attr\">codec</span> =&gt; json</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [<span class=\"built_in\">type</span>] == <span class=\"string\">\"nginx-accesslog\"</span> &#123;</span><br><span class=\"line\">        elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"logstash-nginx-accesslog-30-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>5）检查配置文件语法是否有误并重启<code>logstash</code><br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@node01 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf -t</span><br><span class=\"line\">WARNING: Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> logstash.yml which is typically located in $LS_HOME/<span class=\"built_in\">config</span> <span class=\"keyword\">or</span> /etc/logstash. You can specify the path <span class=\"keyword\">using</span> --path.settings. Continuing <span class=\"keyword\">using</span> the defaults</span><br><span class=\"line\">Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> log4j2 configuration at path /usr/share/logstash/<span class=\"built_in\">config</span>/log4j2.properties. Using <span class=\"built_in\">default</span> <span class=\"built_in\">config</span> which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span> <span class=\"number\">11</span>:<span class=\"number\">26</span>:<span class=\"number\">04.277</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command <span class=\"built_in\">line</span> options are specified</span><br><span class=\"line\">Configuration OK</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span> <span class=\"number\">11</span>:<span class=\"number\">26</span>:<span class=\"number\">09.055</span> [LogStash::Runner] runner - Using <span class=\"built_in\">config</span>.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br><span class=\"line\"></span><br><span class=\"line\">[root@node01 ~]<span class=\"meta\"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p>\n<p>6）在<code>kibana</code>上添加索引验证模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log17.png\" alt=\"log17.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log18.png\" alt=\"log18.png\"></p>\n<p>7）在<code>kibana</code>上验证数据,可以通过添加筛选，让日志更加了然名目<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log19.png\" alt=\"log19.png\"></p>\n<h2 id=\"收集TCP-UDP日志\"><a href=\"#收集TCP-UDP日志\" class=\"headerlink\" title=\"收集TCP/UDP日志\"></a>收集TCP/UDP日志</h2><blockquote>\n<p>通过<code>logstash</code>的<code>tcp/udp</code>插件收集日志，通常用于在向<code>elasticsearch</code>日志补录丢失的部分日志，可以将丢失的日志通过一个<code>TCP</code>端口直接写入到<code>elasticsearch</code>服务器。</p>\n</blockquote>\n<h3 id=\"进行收集测试\"><a href=\"#进行收集测试\" class=\"headerlink\" title=\"进行收集测试\"></a>进行收集测试</h3><p>1）logstash配置<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class=\"line\">input &#123;</span><br><span class=\"line\">    tcp &#123;</span><br><span class=\"line\">       <span class=\"built_in\"> port </span>=&gt; 9889</span><br><span class=\"line\">       <span class=\"built_in\"> type </span>=&gt; <span class=\"string\">\"tcplog\"</span></span><br><span class=\"line\">        mode =&gt; <span class=\"string\">\"server\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">    stdout &#123;</span><br><span class=\"line\">        codec =&gt; rubydebug</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）验证端口是否启动成功<br><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcp.conf </span></span><br><span class=\"line\"><span class=\"symbol\">WARNING:</span> Could <span class=\"keyword\">not</span> find logstash.yml which is typically located <span class=\"keyword\">in</span> <span class=\"variable\">$LS_HOME</span>/config <span class=\"keyword\">or</span> /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class=\"line\">Could <span class=\"keyword\">not</span> find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">07</span>.<span class=\"number\">538</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command line options are specified</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">07</span>.<span class=\"number\">551</span> [LogStash::Runner] runner - Starting Logstash &#123;<span class=\"string\">\"logstash.version\"</span>=&gt;<span class=\"string\">\"6.8.1\"</span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">14.416</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Starting pipeline &#123;<span class=\"symbol\">:pipeline_id=&gt;<span class=\"string\">\"main\"</span></span>, <span class=\"string\">\"pipeline.workers\"</span>=&gt;<span class=\"number\">2</span>, <span class=\"string\">\"pipeline.batch.size\"</span>=&gt;<span class=\"number\">125</span>, <span class=\"string\">\"pipeline.batch.delay\"</span>=&gt;<span class=\"number\">50</span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">14.885</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Pipeline started successfully &#123;<span class=\"symbol\">:pipeline_id=&gt;<span class=\"string\">\"main\"</span></span>, <span class=\"symbol\">:thread=&gt;<span class=\"string\">\"#&lt;Thread:0x240c27a6 sleep&gt;\"</span></span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">14.911</span> [[main]&lt;tcp] tcp - Starting tcp input listener &#123;<span class=\"symbol\">:address=&gt;<span class=\"string\">\"0.0.0.0:9889\"</span></span>, <span class=\"symbol\">:ssl_enable=&gt;<span class=\"string\">\"false\"</span></span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">14.953</span> [Ruby-<span class=\"number\">0</span>-Thread-<span class=\"number\">1</span>: <span class=\"regexp\">/usr/share</span><span class=\"regexp\">/logstash/lib</span><span class=\"regexp\">/bootstrap/environment</span>.<span class=\"symbol\">rb:</span><span class=\"number\">6</span>] agent - Pipelines running &#123;<span class=\"symbol\">:count=&gt;</span><span class=\"number\">1</span>, <span class=\"symbol\">:running_pipelines=&gt;</span>[<span class=\"symbol\">:main</span>], <span class=\"symbol\">:non_running_pipelines=&gt;[]</span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">15.223</span> [Api Webserver] agent - Successfully started Logstash API endpoint &#123;<span class=\"symbol\">:port=&gt;</span><span class=\"number\">9600</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 新开一个终端验证端口</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># netstat -nlutp |grep 9889</span></span><br><span class=\"line\">tcp6       <span class=\"number\">0</span>      <span class=\"number\">0</span> ::<span class=\"symbol\">:</span><span class=\"number\">9889</span>                 ::<span class=\"symbol\">:*</span>                    LISTEN      <span class=\"number\">112455</span>/java</span><br></pre></td></tr></table></figure></p>\n<p>3）在别的服务器通过nc命令进行测试，查看logstash是否收到数据<br><figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># echo <span class=\"string\">\"nc test\"</span> | <span class=\"type\">nc</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> <span class=\"number\">9889</span>    #在另外一台服务器上执行</span><br><span class=\"line\"></span><br><span class=\"line\"># 在上面启动logstash的那个终端查看</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"nc test\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"type\"</span> =&gt; <span class=\"string\">\"tcplog\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span>T10:<span class=\"number\">16</span>:<span class=\"number\">48.139</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"port\"</span> =&gt; <span class=\"number\">37102</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>4）通过nc命令发送一个文件，查看logstash收到的数据<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># nc 192.168.1.31 9889 &lt; /etc/passwd    #同样在上面执行nc那台服务器上执行</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 同样还是在上面启动logstash的那个终端查看</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"mysql:x:27:27:MariaDB Server:/var/lib/mysql:/sbin/nologin\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"type\"</span> =&gt; <span class=\"string\">\"tcplog\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span>T10:<span class=\"number\">18</span>:<span class=\"number\">29.186</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"port\"</span> =&gt; <span class=\"number\">37104</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"logstash:x:989:984:logstash:/usr/share/logstash:/sbin/nologin\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"type\"</span> =&gt; <span class=\"string\">\"tcplog\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span>T10:<span class=\"number\">18</span>:<span class=\"number\">29.187</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"port\"</span> =&gt; <span class=\"number\">37104</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>5）通过伪设备的方式发送消息：<br>在类Unix操作系统中，设备节点并不一定要对应物理设备。没有这种对应关系的设备是伪设备。操作系统运用了它们提供的多种功能，tcp只是dev下面众多伪设备当中的一种设备。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># echo \"伪设备\" &gt;/dev/tcp/192.168.1.31/9889    #同样在上面执行nc那台服务器上执行</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 同样还是在上面启动logstash的那个终端查看</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"伪设备\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"type\"</span> =&gt; <span class=\"string\">\"tcplog\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span>T10:<span class=\"number\">21</span>:<span class=\"number\">32.487</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"port\"</span> =&gt; <span class=\"number\">37106</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>6）将输出更改到elasticsearch<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class=\"line\">input &#123;</span><br><span class=\"line\">    tcp &#123;</span><br><span class=\"line\">       <span class=\"built_in\"> port </span>=&gt; 9889</span><br><span class=\"line\">       <span class=\"built_in\"> type </span>=&gt; <span class=\"string\">\"tcplog\"</span></span><br><span class=\"line\">        mode =&gt; <span class=\"string\">\"server\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">        index =&gt; <span class=\"string\">\"logstash-tcp-log-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>7）通过nc命令或伪设备输入日志<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># echo <span class=\"string\">\"伪设备 1\"</span> &gt;/dev/tcp/<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span>/<span class=\"number\">9889</span></span><br><span class=\"line\"># echo <span class=\"string\">\"伪设备 2\"</span> &gt;/dev/tcp/<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span>/<span class=\"number\">9889</span></span><br></pre></td></tr></table></figure></p>\n<p>8）在kibana界面创建索引模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log20.png\" alt=\"log20.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log21.png\" alt=\"log21.png\"><br>9）验证数据<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log22.png\" alt=\"log22.png\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h2><blockquote>\n<p>这里的环境接着上面的ELK快速入门-基本部署文章继续下面的操作。</p>\n</blockquote>\n<h2 id=\"收集多个日志文件\"><a href=\"#收集多个日志文件\" class=\"headerlink\" title=\"收集多个日志文件\"></a>收集多个日志文件</h2><p>1）<code>logstash</code>配置文件编写<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/system-log.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/var/log/messages\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"systemlog\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"3\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">file</span> &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/var/log/secure\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"securelog\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"3\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [<span class=\"built_in\">type</span>] == <span class=\"string\">\"systemlog\"</span> &#123; </span><br><span class=\"line\">        elasticsearch &#123;</span><br><span class=\"line\">            <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">            <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"system-log-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if [type] == <span class=\"string\">\"securelog\"</span> &#123; </span><br><span class=\"line\">        <span class=\"keyword\">elasticsearch</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">            <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"secure-log-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）给日志文件赋予可读权限并重启<code>logstash</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># chmod 644 /var/log/secure </span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># chmod 644 /var/log/messages</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk1 ~]<span class=\"meta\"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p>\n<p>3）向被收集的文件中写入数据；是为了马上能在<code>elasticsearch</code>的<code>web</code>界面和<code>klbana</code>的<code>web</code>界面里面查看到数据。<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"test\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/secure </span><br><span class=\"line\">[root@linux-elk1 ~]# <span class=\"keyword\">echo</span> <span class=\"string\">\"test\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">messages</span></span><br></pre></td></tr></table></figure></p>\n<p>4）在<code>kibana</code>界面添加<code>system-log</code>索引模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log01.png\" alt=\"log01.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log02.png\" alt=\"log02.png\"><br>5）在<code>kibana</code>界面添加<code>secure-log</code>索引模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log03.png\" alt=\"log03.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log04.png\" alt=\"log04.png\"><br>6）<code>kibana</code>查看日志<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log05.png\" alt=\"log05.png\"></p>\n<h2 id=\"收集tomcat和java日志\"><a href=\"#收集tomcat和java日志\" class=\"headerlink\" title=\"收集tomcat和java日志\"></a>收集tomcat和java日志</h2><blockquote>\n<p>收集<code>Tomcat</code>服务器的访问日志以及<code>Tomcat</code>错误日志进行实时统计，在<code>kibana</code>页面进行搜索展示，每台<code>Tomcat</code>服务器需要安装<code>logstash</code>负责收集日志，然后将日志发给<code>elasticsearch</code>进行分析，在通过<code>kibana</code>在前端展示。</p>\n</blockquote>\n<h3 id=\"部署tomcat服务\"><a href=\"#部署tomcat服务\" class=\"headerlink\" title=\"部署tomcat服务\"></a>部署tomcat服务</h3><blockquote>\n<p>说明，我这里在<code>linux-elk2</code>节点上面装<code>tomcat</code></p>\n</blockquote>\n<p>1）下载并安装<code>tomcat</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 ~]<span class=\"meta\"># cd /usr/local/</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 <span class=\"keyword\">local</span>]<span class=\"meta\"># wget http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-9/v9.0.21/bin/apache-tomcat-9.0.21.tar.gz</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 <span class=\"keyword\">local</span>]<span class=\"meta\"># tar xvzf apache-tomcat-9.0.21.tar.gz</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 <span class=\"keyword\">local</span>]<span class=\"meta\"># ln -s /usr/local/apache-tomcat-9.0.21 /usr/local/tomcat</span></span><br></pre></td></tr></table></figure></p>\n<p>2）测试页面准备<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 <span class=\"keyword\">local</span>]<span class=\"meta\"># cd /usr/local/tomcat/webapps/</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 webapps]<span class=\"meta\"># mkdir webdir</span></span><br><span class=\"line\">[root<span class=\"symbol\">@linux</span>-elk2 webapps]<span class=\"meta\"># echo <span class=\"string\">\"&lt;h1&gt;Welcome to Tomcat&lt;/h1&gt;\"</span>  &gt; /usr/local/tomcat/webapps/webdir/index.html</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>tomcat</code>日志转<code>json</code><br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 tomcat]<span class=\"meta\"># vim /usr/local/tomcat/conf/server.xml</span></span><br><span class=\"line\">        <span class=\"params\">&lt;Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"logs\"</span></span><br><span class=\"line\"><span class=\"params\">               prefix=\"localhost_access_log\" suffix=\".txt\"</span></span><br><span class=\"line\"><span class=\"params\">               pattern=\"&#123;<span class=\"variable\">&amp;quot</span>;clientip<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%h<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;ClientUser<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%l<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;authenticated<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%u<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;AccessTime<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%t<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;method<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%r<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;status<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%s<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;SendBytes<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%b<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;Query?string<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%q<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;partner<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%&#123;Referer&#125;i<span class=\"variable\">&amp;quot</span>;,<span class=\"variable\">&amp;quot</span>;AgentVersion<span class=\"variable\">&amp;quot</span>;:<span class=\"variable\">&amp;quot</span>;%&#123;User-Agent&#125;i<span class=\"variable\">&amp;quot</span>;&#125;\"/&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>4）启动<code>tomcat</code>，并进行访问测试生成日志<br><figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@linux-elk2 tomcat]</span># /usr/local/tomcat/bin/startup.sh</span><br><span class=\"line\"><span class=\"string\">[root@linux-elk2 tomcat]</span># ss -nlt |grep <span class=\"number\">8080</span></span><br><span class=\"line\">LISTEN     <span class=\"number\">0</span>      <span class=\"number\">100</span>         :::<span class=\"number\">8080</span>                    :::*</span><br><span class=\"line\"><span class=\"string\">[root@linux-elk2 tomcat]</span># ab -n100 -c100 http://<span class=\"number\">192.168.1.32:8080</span>/webdir/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@linux-elk2 ~]</span># tailf /usr/local/tomcat/logs/localhost_access_log.<span class=\"number\">2019</span>-<span class=\"number\">07</span>-<span class=\"number\">05</span>.log </span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.32\"</span>,<span class=\"string\">\"ClientUser\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"authenticated\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AccessTime\"</span>:<span class=\"string\">\"[05/Jul/2019:16:39:18 +0800]\"</span>,<span class=\"string\">\"method\"</span>:<span class=\"string\">\"<span class=\"keyword\">GET</span> /webdir/ HTTP/1.0\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>,<span class=\"string\">\"SendBytes\"</span>:<span class=\"string\">\"27\"</span>,<span class=\"string\">\"Query?string\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"partner\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"AgentVersion\"</span>:<span class=\"string\">\"ApacheBench/2.3\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>5）验证日志是否为<code>json</code>格式，<a href=\"http://www.kjson.com/\" target=\"_blank\" rel=\"noopener\">http://www.kjson.com/</a><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log06.png\" alt=\"log06.png\"></p>\n<h3 id=\"配置logstash收集tomcat日志\"><a href=\"#配置logstash收集tomcat日志\" class=\"headerlink\" title=\"配置logstash收集tomcat日志\"></a>配置logstash收集tomcat日志</h3><blockquote>\n<p>说明：如果是需要收集别的服务器上面的<code>tomcat</code>日志，那么在所需要收集的服务器上面都得安装<code>logstash</code>。此处是在<code>linux-elk2</code>节点上面部署的<code>tomcat</code>，之前安装过<code>logstash</code>。</p>\n</blockquote>\n<p>1）配置<code>logstash</code><br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/tomcat.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/usr/local/tomcat/logs/localhost_access_log.*.log\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"tomcat-access-log\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"2\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"logstash-tomcat-132-accesslog-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">file</span> &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/tmp/logstash-tomcat-132-accesslog-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）检测配置文件语法，并重启<code>logstash</code><br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tomcat.conf -tWARNING: Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> logstash.yml which is typically located in $LS_HOME/<span class=\"built_in\">config</span> <span class=\"keyword\">or</span> /etc/logstash. You can specify the path <span class=\"keyword\">using</span> --path.settings. Continuing <span class=\"keyword\">using</span> the defaults</span><br><span class=\"line\">Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> log4j2 configuration at path /usr/share/logstash/<span class=\"built_in\">config</span>/log4j2.properties. Using <span class=\"built_in\">default</span> <span class=\"built_in\">config</span> which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-05</span> <span class=\"number\">17</span>:<span class=\"number\">04</span>:<span class=\"number\">34.583</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command <span class=\"built_in\">line</span> options are specified</span><br><span class=\"line\">Configuration OK</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk2 ~]# /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd</span><br><span class=\"line\">[root@linux-elk2 ~]<span class=\"meta\"># systemctl start logstash</span></span><br></pre></td></tr></table></figure></p>\n<p>3）权限修改，不然<code>elasticsearch</code>界面和<code>kibana</code>界面是无法查看到的<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># ll /usr/local/tomcat/logs/ -d</span></span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>root root<span class=\"number\"> 197 </span>7月  <span class=\"number\"> 5 </span>16:36 /usr/local/tomcat/logs/</span><br><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># ll /usr/local/tomcat/logs/</span></span><br><span class=\"line\">总用量 64</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root<span class=\"number\"> 14228 </span>7月  <span class=\"number\"> 5 </span>16:36 catalina.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root<span class=\"number\"> 14228 </span>7月  <span class=\"number\"> 5 </span>16:36 catalina.out</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root    <span class=\"number\"> 0 </span>7月  <span class=\"number\"> 5 </span>16:25 host-manager.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root <span class=\"number\"> 1074 </span>7月  <span class=\"number\"> 5 </span>16:36 localhost.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root<span class=\"number\"> 26762 </span>7月  <span class=\"number\"> 5 </span>17:23 localhost_access_log.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>root root    <span class=\"number\"> 0 </span>7月  <span class=\"number\"> 5 </span>16:25 manager.2019-07-05.log</span><br><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># chown logstash.logstash /usr/local/tomcat/logs/ -R</span></span><br><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># ll /usr/local/tomcat/logs/</span></span><br><span class=\"line\">总用量 64</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash<span class=\"number\"> 14228 </span>7月  <span class=\"number\"> 5 </span>16:36 catalina.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash<span class=\"number\"> 14228 </span>7月  <span class=\"number\"> 5 </span>16:36 catalina.out</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash    <span class=\"number\"> 0 </span>7月  <span class=\"number\"> 5 </span>16:25 host-manager.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash <span class=\"number\"> 1074 </span>7月  <span class=\"number\"> 5 </span>16:36 localhost.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash<span class=\"number\"> 26762 </span>7月  <span class=\"number\"> 5 </span>17:23 localhost_access_log.2019-07-05.log</span><br><span class=\"line\">-rw-r-----<span class=\"number\"> 1 </span>logstash logstash    <span class=\"number\"> 0 </span>7月  <span class=\"number\"> 5 </span>16:25 manager.2019-07-05.log</span><br></pre></td></tr></table></figure></p>\n<p>4）访问<code>elasticsearch</code>界面验证插件<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log07.png\" alt=\"log07.png\"><br>数据浏览<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log08.png\" alt=\"log08.png\"></p>\n<p>5）在<code>kibana</code>上添加索引模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log09.png\" alt=\"log09.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log10.png\" alt=\"log10.png\"><br>6）<code>kibana</code>验证数据<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log11.png\" alt=\"log11.png\"></p>\n<h3 id=\"配置logstash收集java日志\"><a href=\"#配置logstash收集java日志\" class=\"headerlink\" title=\"配置logstash收集java日志\"></a>配置logstash收集java日志</h3><blockquote>\n<p>使用codec的multiline插件实现多行匹配，这是一个可以将多行进行合并的插件，而且可以使用what指定将匹配到的行与前面的行合并还是和后面的行合并，<a href=\"https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html</a></p>\n</blockquote>\n<p>语法格式：<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    stdin &#123;</span><br><span class=\"line\">        <span class=\"attr\">codec</span> =&gt; multiline &#123;</span><br><span class=\"line\">            <span class=\"attr\">pattern</span> =&gt; <span class=\"string\">\"^\\[\"</span>    <span class=\"comment\">#当遇到[开头的行时候将多行进行合并</span></span><br><span class=\"line\">            <span class=\"attr\">negate</span> =&gt; <span class=\"keyword\">true</span>      <span class=\"comment\">#true为匹配成功进行操作，false为不成功进行操</span></span><br><span class=\"line\">            <span class=\"attr\">what</span> =&gt; <span class=\"string\">\"previous\"</span>  <span class=\"comment\">#与上面的行合并，如果是下面的行合并就是</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>命令行测试输入输出：<br><figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -e 'input &#123; stdin &#123; codec =&gt; multiline &#123; <span class=\"built_in\">pattern</span> =&gt; <span class=\"string\">\"^\\[\"</span> negate =&gt; true what =&gt; <span class=\"string\">\"previous\"</span> &#125; &#125; &#125; output &#123; stdout &#123; codec =&gt; rubydebug &#125;&#125;'</span><br><span class=\"line\">WARNING: Could not find logstash.yml which is typically located <span class=\"built_in\">in</span> $LS_HOME/config or /etc/logstash. You can specify the path <span class=\"built_in\">using</span> --path.settings. Continuing <span class=\"built_in\">using</span> the defaults</span><br><span class=\"line\">Could not find log4j2 configuration <span class=\"built_in\">at</span> path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">28</span>:<span class=\"number\">04.938</span> [LogStash::Runner] multilocal - Ignoring the 'pipelines.yml' file because modules or command line options are specified</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">28</span>:<span class=\"number\">04.968</span> [LogStash::Runner] runner - Starting Logstash &#123;<span class=\"string\">\"logstash.version\"</span>=&gt;<span class=\"string\">\"6.8.1\"</span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">28</span>:<span class=\"number\">19.167</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Starting pipeline &#123;:pipeline_id=&gt;<span class=\"string\">\"main\"</span>, <span class=\"string\">\"pipeline.workers\"</span>=&gt;<span class=\"number\">1</span>, <span class=\"string\">\"pipeline.batch.size\"</span>=&gt;<span class=\"number\">125</span>, <span class=\"string\">\"pipeline.batch.delay\"</span>=&gt;<span class=\"number\">50</span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">28</span>:<span class=\"number\">19.918</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Pipeline started successfully &#123;:pipeline_id=&gt;<span class=\"string\">\"main\"</span>, :thread=&gt;<span class=\"string\">\"#&lt;Thread:0xc8dd9a1 run&gt;\"</span>&#125;</span><br><span class=\"line\">The stdin plugin is now waiting <span class=\"keyword\">for</span> input:</span><br><span class=\"line\"><span class=\"number\">111111</span></span><br><span class=\"line\"><span class=\"number\">222222</span></span><br><span class=\"line\">aaaaaa</span><br><span class=\"line\">[<span class=\"number\">44444</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span>T07:<span class=\"number\">34</span>:<span class=\"number\">48.063</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"tags\"</span> =&gt; [</span><br><span class=\"line\">        [<span class=\"number\">0</span>] <span class=\"string\">\"multiline\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"[12\\n111111\\n222222\\naaaaaa\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"linux-elk2.exmaple.com\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">444444</span></span><br><span class=\"line\">aaaaaa</span><br><span class=\"line\">[<span class=\"number\">77777</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span>T07:<span class=\"number\">35</span>:<span class=\"number\">51.522</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"tags\"</span> =&gt; [</span><br><span class=\"line\">        [<span class=\"number\">0</span>] <span class=\"string\">\"multiline\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"[44444\\n444444\\naaaaaa\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"linux-elk2.exmaple.com\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例：收集ELK集群日志</strong><br>1）观察日志文件，<code>elk</code>集群日志都是以<code>&quot;[&quot;</code>开头并且每一个信息都是如此。<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]# tailf /elk/logs/ELK-Cluster.log </span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:26:37,774</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class=\"emphasis\">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:26:47,664</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class=\"emphasis\">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:33:55,150</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class=\"emphasis\">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:33:55,197</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataMappingService</span>] [elk-node2] [.kibana<span class=\"emphasis\">_1/yRee-8HYS8KiVwnuADXAbA] update_</span>mapping [doc]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:33:55,822</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class=\"emphasis\">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:33:55,905</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataMappingService</span>] [elk-node2] [.kibana<span class=\"emphasis\">_1/yRee-8HYS8KiVwnuADXAbA] update_</span>mapping [doc]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:33:57,026</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.c.m.MetaDataIndexTemplateService</span>] [elk-node2] adding template [kibana<span class=\"emphasis\">_index_</span>template:.kibana] for index patterns [.kibana]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:43:20,262</span>][<span class=\"symbol\">WARN </span>][<span class=\"string\">o.e.m.j.JvmGcMonitorService</span>] [<span class=\"string\">elk-node2</span>] [<span class=\"string\">gc</span>][<span class=\"symbol\">young</span>][<span class=\"string\">8759</span>][<span class=\"symbol\">66</span>] duration [1.3s], collections [1]/[1.7s], total [1.3s]/[4s], memory [176mb]-&gt;[111.6mb]/[1.9gb], all_pools &#123;[young] [64.8mb]-&gt;[706.4kb]/[66.5mb]&#125;&#123;[survivor] [3.3mb]-&gt;[3mb]/[8.3mb]&#125;&#123;[old] [107.8mb]-&gt;[107.8mb]/[1.9gb]&#125;</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:43:20,388</span>][<span class=\"symbol\">WARN </span>][<span class=\"string\">o.e.m.j.JvmGcMonitorService</span>] [<span class=\"string\">elk-node2</span>] [<span class=\"string\">gc</span>][<span class=\"symbol\">8759</span>] overhead, spent [1.3s] collecting in the last [1.7s]</span><br><span class=\"line\">[<span class=\"string\">2019-07-08T11:44:42,955</span>][<span class=\"symbol\">INFO </span>][<span class=\"string\">o.e.x.m.p.NativeController</span>] [elk-node2] Native controller process has stopped - no new native processes can be started</span><br></pre></td></tr></table></figure></p>\n<p>2）配置<code>logstash</code><br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/java.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/elk/logs/ELK-Cluster.log\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"java-elk-cluster-log\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"2\"</span></span><br><span class=\"line\">        <span class=\"attr\">code</span> =&gt; multiline &#123;</span><br><span class=\"line\">            <span class=\"attr\">pattern</span> =&gt; <span class=\"string\">\"^\\[\"</span>    <span class=\"comment\">#以\"[\"开头进行正则匹配，匹配规则</span></span><br><span class=\"line\">            <span class=\"attr\">negate</span> =&gt; <span class=\"string\">\"true\"</span>  <span class=\"comment\">#正则匹配成功，false匹配不成功</span></span><br><span class=\"line\">            <span class=\"attr\">what</span> =&gt; <span class=\"string\">\"previous\"</span>  <span class=\"comment\">#和前面的内容进行合并,如果是和下面的合并就是next</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [<span class=\"built_in\">type</span>] == <span class=\"string\">\"java-elk-cluster-log\"</span> &#123;</span><br><span class=\"line\">        elasticsearch &#123;</span><br><span class=\"line\">            <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">            <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"java-elk-cluster-log-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）检查配置文件语法是否有误并重启<code>logstash</code><br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk2 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/java.conf -t</span><br><span class=\"line\">WARNING: Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> logstash.yml which is typically located in $LS_HOME/<span class=\"built_in\">config</span> <span class=\"keyword\">or</span> /etc/logstash. You can specify the path <span class=\"keyword\">using</span> --path.settings. Continuing <span class=\"keyword\">using</span> the defaults</span><br><span class=\"line\">Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> log4j2 configuration at path /usr/share/logstash/<span class=\"built_in\">config</span>/log4j2.properties. Using <span class=\"built_in\">default</span> <span class=\"built_in\">config</span> which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">49</span>:<span class=\"number\">51.996</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command <span class=\"built_in\">line</span> options are specified</span><br><span class=\"line\">Configuration OK</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-08</span> <span class=\"number\">15</span>:<span class=\"number\">50</span>:<span class=\"number\">04.438</span> [LogStash::Runner] runner - Using <span class=\"built_in\">config</span>.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br><span class=\"line\"></span><br><span class=\"line\">[root@linux-elk2 ~]<span class=\"meta\"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p>\n<p>4）访问<code>elasticsearch</code>界面验证数据<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log12.png\" alt=\"log12.png\"><br>5）在<code>kibana</code>上添加索引验证模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log13.png\" alt=\"log13.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log14.png\" alt=\"log14.png\"><br>6）<code>kibana</code>验证数据<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log15.png\" alt=\"log15.png\"></p>\n<h2 id=\"收集Nginx访问日志\"><a href=\"#收集Nginx访问日志\" class=\"headerlink\" title=\"收集Nginx访问日志\"></a>收集Nginx访问日志</h2><blockquote>\n<p>收集<code>nginx</code>的<code>json</code>访问日志，这里为了测试，是在一台新的服务器上面安装了<code>nginx</code>和<code>logstash</code></p>\n</blockquote>\n<p>1）安装nginx并准备一个测试页面<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@node01</span> ~]<span class=\"meta\"># yum -y install nginx</span></span><br><span class=\"line\">[root<span class=\"symbol\">@node01</span> ~]<span class=\"meta\"># echo <span class=\"string\">\"&lt;h1&gt;whelcom to nginx server&lt;/h1&gt;\"</span> &gt; /usr/share/nginx/html/index.html</span></span><br><span class=\"line\">[root<span class=\"symbol\">@node01</span> ~]<span class=\"meta\"># systemctl start nginx </span></span><br><span class=\"line\">[root<span class=\"symbol\">@node01</span> ~]<span class=\"meta\"># curl localhost</span></span><br><span class=\"line\">&lt;h1&gt;whelcom <span class=\"keyword\">to</span> nginx server&lt;/h1&gt;</span><br></pre></td></tr></table></figure></p>\n<p>2）将nginx日志转换成json格式<br><figure class=\"highlight julia\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"meta\">@node01</span> ~]<span class=\"comment\"># vim /etc/nginx/nginx.conf</span></span><br><span class=\"line\">    log_format access_json '&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"<span class=\"variable\">$time_iso8601</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"host\"</span>:<span class=\"string\">\"<span class=\"variable\">$server_addr</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"<span class=\"variable\">$remote_addr</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"size\"</span>:$body_bytes_sent,'</span><br><span class=\"line\">                           '<span class=\"string\">\"responsetime\"</span>:$request_time,'</span><br><span class=\"line\">                           '<span class=\"string\">\"upstreamtime\"</span>:<span class=\"string\">\"<span class=\"variable\">$upstream_response_time</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"upstreamhost\"</span>:<span class=\"string\">\"<span class=\"variable\">$upstream_addr</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"http_host\"</span>:<span class=\"string\">\"<span class=\"variable\">$host</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"url\"</span>:<span class=\"string\">\"<span class=\"variable\">$uri</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"domain\"</span>:<span class=\"string\">\"<span class=\"variable\">$host</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"xff\"</span>:<span class=\"string\">\"<span class=\"variable\">$http_x_forwarded_for</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"referer\"</span>:<span class=\"string\">\"<span class=\"variable\">$http_referer</span>\"</span>,'</span><br><span class=\"line\">                           '<span class=\"string\">\"status\"</span>:<span class=\"string\">\"<span class=\"variable\">$status</span>\"</span>&#125;';</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /var/log/nginx/access.log  access_json;</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"meta\">@node01</span> ~]<span class=\"comment\"># nginx -t</span></span><br><span class=\"line\">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class=\"line\">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class=\"line\">[root<span class=\"meta\">@node01</span> ~]<span class=\"comment\"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure></p>\n<p>3）访问一次，确认日志为<code>json</code>格式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log16.png\" alt=\"log16.png\"></p>\n<figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@node01 ~]# tail /var/<span class=\"keyword\">log</span>/nginx/access.<span class=\"keyword\">log</span></span><br><span class=\"line\">&#123;<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"2019-07-09T11:21:28+08:00\"</span>,<span class=\"string\">\"host\"</span>:<span class=\"string\">\"192.168.1.30\"</span>,<span class=\"string\">\"clientip\"</span>:<span class=\"string\">\"192.168.1.144\"</span>,<span class=\"string\">\"size\"</span>:<span class=\"number\">33</span>,<span class=\"string\">\"responsetime\"</span>:<span class=\"number\">0.000</span>,<span class=\"string\">\"upstreamtime\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"upstreamhost\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"http_host\"</span>:<span class=\"string\">\"192.168.1.30\"</span>,<span class=\"string\">\"url\"</span>:<span class=\"string\">\"/index.html\"</span>,<span class=\"string\">\"domain\"</span>:<span class=\"string\">\"192.168.1.30\"</span>,<span class=\"string\">\"xff\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"referer\"</span>:<span class=\"string\">\"-\"</span>,<span class=\"string\">\"status\"</span>:<span class=\"string\">\"200\"</span>&#125;</span><br></pre></td></tr></table></figure>\n<p>4）安装<code>logstash</code>并配置收集<code>nginx</code>日志<br><figure class=\"highlight puppet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#将logstash软件包copy到nginx服务器上</span></span><br><span class=\"line\">[root@linux-elk1 ~]<span class=\"comment\"># scp logstash-6.8.1.rpm 192.168.1.30:/root/</span></span><br><span class=\"line\"><span class=\"comment\">#安装logstash</span></span><br><span class=\"line\">[root@node01 ~]<span class=\"comment\"># yum -y localinstall logstash-6.8.1.rpm</span></span><br><span class=\"line\"><span class=\"comment\">#生成logstash.service启动文件</span></span><br><span class=\"line\">[root@node01 ~]<span class=\"comment\"># /usr/share/logstash/bin/system-install /etc/logstash/startup.options systemd</span></span><br><span class=\"line\"><span class=\"comment\">#将logstash启动用户更改为root，不然可能会导致收集不到日志</span></span><br><span class=\"line\">[root@node01 ~]<span class=\"comment\"># vim /etc/systemd/system/logstash.service</span></span><br><span class=\"line\">User=root</span><br><span class=\"line\">Group=root</span><br><span class=\"line\">[root@node01 ~]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@node01 ~]<span class=\"comment\"># vim /etc/logstash/conf.d/nginx.conf</span></span><br><span class=\"line\"><span class=\"keyword\">input</span> &#123;</span><br><span class=\"line\">    file &#123;</span><br><span class=\"line\">        <span class=\"attr\">path</span> =&gt; <span class=\"string\">\"/var/log/nginx/access.log\"</span></span><br><span class=\"line\">        <span class=\"attr\">type</span> =&gt; <span class=\"string\">\"nginx-accesslog\"</span></span><br><span class=\"line\">        <span class=\"attr\">start_position</span> =&gt; <span class=\"string\">\"beginning\"</span></span><br><span class=\"line\">        <span class=\"attr\">stat_interval</span> =&gt; <span class=\"string\">\"2\"</span></span><br><span class=\"line\">        <span class=\"attr\">codec</span> =&gt; json</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">output</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [<span class=\"built_in\">type</span>] == <span class=\"string\">\"nginx-accesslog\"</span> &#123;</span><br><span class=\"line\">        elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"attr\">hosts</span> =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">        <span class=\"attr\">index</span> =&gt; <span class=\"string\">\"logstash-nginx-accesslog-30-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>5）检查配置文件语法是否有误并重启<code>logstash</code><br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@node01 ~]# /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx.conf -t</span><br><span class=\"line\">WARNING: Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> logstash.yml which is typically located in $LS_HOME/<span class=\"built_in\">config</span> <span class=\"keyword\">or</span> /etc/logstash. You can specify the path <span class=\"keyword\">using</span> --path.settings. Continuing <span class=\"keyword\">using</span> the defaults</span><br><span class=\"line\">Could <span class=\"keyword\">not</span> <span class=\"built_in\">find</span> log4j2 configuration at path /usr/share/logstash/<span class=\"built_in\">config</span>/log4j2.properties. Using <span class=\"built_in\">default</span> <span class=\"built_in\">config</span> which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span> <span class=\"number\">11</span>:<span class=\"number\">26</span>:<span class=\"number\">04.277</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command <span class=\"built_in\">line</span> options are specified</span><br><span class=\"line\">Configuration OK</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span> <span class=\"number\">11</span>:<span class=\"number\">26</span>:<span class=\"number\">09.055</span> [LogStash::Runner] runner - Using <span class=\"built_in\">config</span>.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br><span class=\"line\"></span><br><span class=\"line\">[root@node01 ~]<span class=\"meta\"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p>\n<p>6）在<code>kibana</code>上添加索引验证模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log17.png\" alt=\"log17.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log18.png\" alt=\"log18.png\"></p>\n<p>7）在<code>kibana</code>上验证数据,可以通过添加筛选，让日志更加了然名目<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log19.png\" alt=\"log19.png\"></p>\n<h2 id=\"收集TCP-UDP日志\"><a href=\"#收集TCP-UDP日志\" class=\"headerlink\" title=\"收集TCP/UDP日志\"></a>收集TCP/UDP日志</h2><blockquote>\n<p>通过<code>logstash</code>的<code>tcp/udp</code>插件收集日志，通常用于在向<code>elasticsearch</code>日志补录丢失的部分日志，可以将丢失的日志通过一个<code>TCP</code>端口直接写入到<code>elasticsearch</code>服务器。</p>\n</blockquote>\n<h3 id=\"进行收集测试\"><a href=\"#进行收集测试\" class=\"headerlink\" title=\"进行收集测试\"></a>进行收集测试</h3><p>1）logstash配置<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class=\"line\">input &#123;</span><br><span class=\"line\">    tcp &#123;</span><br><span class=\"line\">       <span class=\"built_in\"> port </span>=&gt; 9889</span><br><span class=\"line\">       <span class=\"built_in\"> type </span>=&gt; <span class=\"string\">\"tcplog\"</span></span><br><span class=\"line\">        mode =&gt; <span class=\"string\">\"server\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">    stdout &#123;</span><br><span class=\"line\">        codec =&gt; rubydebug</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>2）验证端口是否启动成功<br><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcp.conf </span></span><br><span class=\"line\"><span class=\"symbol\">WARNING:</span> Could <span class=\"keyword\">not</span> find logstash.yml which is typically located <span class=\"keyword\">in</span> <span class=\"variable\">$LS_HOME</span>/config <span class=\"keyword\">or</span> /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class=\"line\">Could <span class=\"keyword\">not</span> find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config which logs errors to the console</span><br><span class=\"line\">[WARN ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">07</span>.<span class=\"number\">538</span> [LogStash::Runner] multilocal - Ignoring the <span class=\"string\">'pipelines.yml'</span> file because modules <span class=\"keyword\">or</span> command line options are specified</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">07</span>.<span class=\"number\">551</span> [LogStash::Runner] runner - Starting Logstash &#123;<span class=\"string\">\"logstash.version\"</span>=&gt;<span class=\"string\">\"6.8.1\"</span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">14.416</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Starting pipeline &#123;<span class=\"symbol\">:pipeline_id=&gt;<span class=\"string\">\"main\"</span></span>, <span class=\"string\">\"pipeline.workers\"</span>=&gt;<span class=\"number\">2</span>, <span class=\"string\">\"pipeline.batch.size\"</span>=&gt;<span class=\"number\">125</span>, <span class=\"string\">\"pipeline.batch.delay\"</span>=&gt;<span class=\"number\">50</span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">14.885</span> [Converge PipelineAction::Create&lt;main&gt;] pipeline - Pipeline started successfully &#123;<span class=\"symbol\">:pipeline_id=&gt;<span class=\"string\">\"main\"</span></span>, <span class=\"symbol\">:thread=&gt;<span class=\"string\">\"#&lt;Thread:0x240c27a6 sleep&gt;\"</span></span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">14.911</span> [[main]&lt;tcp] tcp - Starting tcp input listener &#123;<span class=\"symbol\">:address=&gt;<span class=\"string\">\"0.0.0.0:9889\"</span></span>, <span class=\"symbol\">:ssl_enable=&gt;<span class=\"string\">\"false\"</span></span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">14.953</span> [Ruby-<span class=\"number\">0</span>-Thread-<span class=\"number\">1</span>: <span class=\"regexp\">/usr/share</span><span class=\"regexp\">/logstash/lib</span><span class=\"regexp\">/bootstrap/environment</span>.<span class=\"symbol\">rb:</span><span class=\"number\">6</span>] agent - Pipelines running &#123;<span class=\"symbol\">:count=&gt;</span><span class=\"number\">1</span>, <span class=\"symbol\">:running_pipelines=&gt;</span>[<span class=\"symbol\">:main</span>], <span class=\"symbol\">:non_running_pipelines=&gt;[]</span>&#125;</span><br><span class=\"line\">[INFO ] <span class=\"number\">2019</span>-<span class=\"number\">07</span>-09 <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">15.223</span> [Api Webserver] agent - Successfully started Logstash API endpoint &#123;<span class=\"symbol\">:port=&gt;</span><span class=\"number\">9600</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 新开一个终端验证端口</span></span><br><span class=\"line\">[root<span class=\"variable\">@linux</span>-elk1 ~]<span class=\"comment\"># netstat -nlutp |grep 9889</span></span><br><span class=\"line\">tcp6       <span class=\"number\">0</span>      <span class=\"number\">0</span> ::<span class=\"symbol\">:</span><span class=\"number\">9889</span>                 ::<span class=\"symbol\">:*</span>                    LISTEN      <span class=\"number\">112455</span>/java</span><br></pre></td></tr></table></figure></p>\n<p>3）在别的服务器通过nc命令进行测试，查看logstash是否收到数据<br><figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># echo <span class=\"string\">\"nc test\"</span> | <span class=\"type\">nc</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> <span class=\"number\">9889</span>    #在另外一台服务器上执行</span><br><span class=\"line\"></span><br><span class=\"line\"># 在上面启动logstash的那个终端查看</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"nc test\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"type\"</span> =&gt; <span class=\"string\">\"tcplog\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span>T10:<span class=\"number\">16</span>:<span class=\"number\">48.139</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"port\"</span> =&gt; <span class=\"number\">37102</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>4）通过nc命令发送一个文件，查看logstash收到的数据<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># nc 192.168.1.31 9889 &lt; /etc/passwd    #同样在上面执行nc那台服务器上执行</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 同样还是在上面启动logstash的那个终端查看</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"mysql:x:27:27:MariaDB Server:/var/lib/mysql:/sbin/nologin\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"type\"</span> =&gt; <span class=\"string\">\"tcplog\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span>T10:<span class=\"number\">18</span>:<span class=\"number\">29.186</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"port\"</span> =&gt; <span class=\"number\">37104</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"logstash:x:989:984:logstash:/usr/share/logstash:/sbin/nologin\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"type\"</span> =&gt; <span class=\"string\">\"tcplog\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span>T10:<span class=\"number\">18</span>:<span class=\"number\">29.187</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"port\"</span> =&gt; <span class=\"number\">37104</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>5）通过伪设备的方式发送消息：<br>在类Unix操作系统中，设备节点并不一定要对应物理设备。没有这种对应关系的设备是伪设备。操作系统运用了它们提供的多种功能，tcp只是dev下面众多伪设备当中的一种设备。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># echo \"伪设备\" &gt;/dev/tcp/192.168.1.31/9889    #同样在上面执行nc那台服务器上执行</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 同样还是在上面启动logstash的那个终端查看</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">       <span class=\"string\">\"message\"</span> =&gt; <span class=\"string\">\"伪设备\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.30\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"type\"</span> =&gt; <span class=\"string\">\"tcplog\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"@version\"</span> =&gt; <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"@timestamp\"</span> =&gt; <span class=\"number\">2019</span><span class=\"number\">-07</span><span class=\"number\">-09</span>T10:<span class=\"number\">21</span>:<span class=\"number\">32.487</span>Z,</span><br><span class=\"line\">          <span class=\"string\">\"port\"</span> =&gt; <span class=\"number\">37106</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>6）将输出更改到elasticsearch<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@linux-elk1 ~]# vim /etc/logstash/conf.d/tcp.conf</span><br><span class=\"line\">input &#123;</span><br><span class=\"line\">    tcp &#123;</span><br><span class=\"line\">       <span class=\"built_in\"> port </span>=&gt; 9889</span><br><span class=\"line\">       <span class=\"built_in\"> type </span>=&gt; <span class=\"string\">\"tcplog\"</span></span><br><span class=\"line\">        mode =&gt; <span class=\"string\">\"server\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">\"192.168.1.31:9200\"</span>]</span><br><span class=\"line\">        index =&gt; <span class=\"string\">\"logstash-tcp-log-%&#123;+YYYY.MM.dd&#125;\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>7）通过nc命令或伪设备输入日志<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># echo <span class=\"string\">\"伪设备 1\"</span> &gt;/dev/tcp/<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span>/<span class=\"number\">9889</span></span><br><span class=\"line\"># echo <span class=\"string\">\"伪设备 2\"</span> &gt;/dev/tcp/<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span>/<span class=\"number\">9889</span></span><br></pre></td></tr></table></figure></p>\n<p>8）在kibana界面创建索引模式<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log20.png\" alt=\"log20.png\"><br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log21.png\" alt=\"log21.png\"><br>9）验证数据<br><img src=\"/2019/07/05/ELK快速入门二-通过logstash收集日志/log22.png\" alt=\"log22.png\"></p>\n"},{"title":"PHP配合inotify实现光闸ftp功能","date":"2019-08-06T04:13:22.000Z","copyright":true,"_content":"\n## PHP配合inotify实现光闸ftp功能\n### 前言\n>由于业务需要，内外网的数据需要进行实时交互同步，由于环境因素，只能通过`ftp`进行文件的交互传输。且没有硬件设备（光闸）；鉴于这种情况下，首先考虑到的是通过`shell`脚本进行自动上传下载文件。然而在实施部署过程中发现，通过`shell`脚本方式进行文件的上传下载每一个文件都会建立一次连接。（由于环境因素，ftp通过网闸再通过`vpn`建立一次连接巨慢，大概需要几十秒。）可是项目站点必须是实时进行文件的传输，且每次可能是多个文件，多者甚至上百个。经过探讨考虑到使用`rsync+inotify`，通过rsync的守护进程模式进行文件的传输。可是这种项目迟早得换成光闸走`ftp`进行文件的传输。而后又考虑直接在代码里面实现建立`ftp`的长连接进行文件传输（建立一次连接，然后一直处于监听模式，发现有文件就及时进行传送）,这样一来又考虑到目录的监听情况，开始准备使用`inotify-tools`进行监听然后调用`php`代码里面的`ftp`长连接进程，随后又在`php`官方发现`php`也有一个`inotify`可以用来进行目录的监听，然后触发动作。\n>于是，最终方案就是在内外网两台服务器上面搭建`ftp`服务，然后通过`php`脚本进行目录的监听并上传到`ftp`服务器。\n\n>具体实现流程说明\n>1、内外网的服务器均安装`ftp`。\n>2、内外网的服务器均安装`php`及`php`的`inotify`插件。\n>3、内外网的服务器均安装`redis`。（`php`分为两个文件，一个为文件(`listen.php`)用于监听，一个文件(`upFile.php`)用于上传文件，由于开始没有存入`redis`，导致文件堆积，然后一直阻塞。故最终方案通过监听文件将监听到发生变化的文件路径存入到`redis`里，然后通过`upfile`脚本将文件上传到`ftp`）\n\n\n### 环境说明\n|      IP      |        主机名        | 系统版本  | 网络说明 |\n| :----------: | :------------------: | :-------: | :------: |\n| 192.168.1.32 | internet.example.com | CenTOS7.4 | 模拟外网 |\n| 192.168.1.33 |   lan.example.com    | CenTOS7.4 | 模拟内网 |\n\n\n>1、这里是通过两台虚拟机进行模拟内外网。且上面真实项目操作系统为`CenTOS6.5`；这里使用`CenTOS7.5`模拟。\n>2、两台服务器需要安装软件有：`vsftpd`、`php`、`php`插件`inotify`\n>3、外网的`/opt/ftp/out`目录只要有新的文件产生就会自动触发监听然后传送至内网的`/opt/ftp/come`目录。\n>4、反之一样，内网的`/opt/ftp/out`目录只要有新的文件产生就会自动触发监听然后传送至外网的`/opt/ftp/come`目录。\n\n### 项目结构图\n![image.png](PHP配合inotify实现光闸ftp功能/01.png)\n\n## 具体实验步骤\n### 安装配置vsftpd\n>说明：内外网都需要配置`vsftpd`，配置`vsftpd`虚拟用户可参考 https://www.cnblogs.com/yanjieli/p/10723108.html\n\n```\n# mkdir -p /opt/ftp/{come,out}    #创建对应的数据目录\n# yum -y install vsftpd    #安装vsftpd\n# useradd -s /sbin/nologin apache    #由于项目站点所使用的apache用户，所以这里为了防止权限问题，这里也是用apache用户作为虚拟用户\n# chown apache.apache /opt/ftp/ -R    #将数据目录权限改为apache用户\n# cat >/etc/vsftpd/logins.txt<<-EOF    #创建ftp虚拟账号和密码，一行账号一行密码\nftp_come_user\nFtp_come_password@Qaz123\nEOF\n\n# db_load -T -t hash -f /etc/vsftpd/logins.txt /etc/vsftpd/login.db    #将密码文件转换成db格式\n# chmod 600 /etc/vsftpd/login.db    #更改db文件的权限\n\n# cat >/etc/pam.d/ftp<<-EOF    #定义pam认证文件\nauth  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\naccount  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\nEOF\n\n# cp /etc/vsftpd/vsftpd.conf{,.back}    #备份配置文件\n# vim /etc/vsftpd/vsftpd.conf    #编辑vsftpd主配置文件\nanonymous_enable=NO\nlocal_enable=YES\nwrite_enable=NO\nanon_upload_enable=NO\nanon_mkdir_write_enable=NO\nanon_other_write_enable=NO\nchroot_local_user=YES\nallow_writeable_chroot=YES\nguest_enable=YES\nguest_username=apache\nlisten=YES\nlisten_port=21\npasv_enable=YES\npasv_address=192.168.1.32    #内网的那台改成对应内网的IP地址\npasv_min_port=10000\npasv_max_port=10088\nanon_world_readable_only=NO\nuser_config_dir=/etc/vsftpd/user_conf\ntcp_wrappers=YES\n\n# vim /etc/vsftpd/user_conf/ftp_come_user    #编辑虚拟用户的子配置文件\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nanon_umask=022\nlocal_root=/opt/ftp/come\n\n# systemctl start vsftpd    #启动ftp\n```\n\n### 测试ftp\n1）在外网（`192.168.1.32`）上访问内网（`192.168.1.33`）的`ftp`\n```\n[root@internet ~]# dd if=/dev/zero of=testfile bs=1M count=100    #创建一个测试文件用于测试上传\n[root@internet ~]# lftp ftp_come_user:Ftp_come_password@Qaz123@192.168.1.33    #通过lftp工具连接ftp\nlftp ftp_come_user@192.168.1.33:~> lcd\nlcd 成功, 本地目录=/root\nlftp ftp_come_user@192.168.1.33:~> put testfile\n104857600 bytes transferred in 2 seconds (55.59M/s)\nlftp ftp_come_user@192.168.1.33:/> ls\n-rw-r--r--    1 1001     1001     104857600 Aug 05 12:41 testfile\n```\n2）在内网（`192.168.1.33`）上访问外网（`192.168.1.32`）的`ftp`\n```\n[root@lan ~]# dd if=/dev/zero of=testfile1 bs=1M count=100    #同样创建一个测试文件\n[root@lan ~]# lftp ftp_come_user:Ftp_come_password@Qaz123@192.168.1.32\nlftp ftp_come_user@192.168.1.32:~> put testfile1\n104857600 bytes transferred in 3 seconds (31.87M/s)              \nlftp ftp_come_user@192.168.1.32:/>\nlftp ftp_come_user@192.168.1.32:/> ls\n-rw-r--r--    1 1001     1001     104857600 Aug 05 12:45 testfile1\n```\n3）在内网的`/opt/ftp/come`目录验证是否存在`testfile`文件\n```\n[root@lan ~]# ll /opt/ftp/come/\n总用量 102400\n-rw-r--r-- 1 apache apache 104857600 8月   5 20:41 testfile\n```\n4）在外网的`/opt/ftp/come`目录验证是否存在`testfile1`文件\n```\n[root@internet ~]# ll /opt/ftp/come/\n总用量 102400\n-rw-r--r-- 1 apache apache 104857600 8月   5 20:45 testfile1\n```\n通过测试`ftp`已经`ok`\n\n\n### 安装配置redis\n> 生产环境`redis`可能端口不一样，然后根据不同的进行配置即可。同时设置连接密码，（这里只是测试，所以两边的配置一样）\n\n```\n# yum -y install redis    #安装redis\n# cp /etc/redis.conf{,.back}    #拷贝redis配置文件\n# vim /etc/redis.conf    #编辑redis配置文件\ndaemonize yes    #开启后台常驻进程\nrequirepass obohna7Fogai9ahnahth    #设置redis连接密码\n# systemctl start redis    #启动redis\n# netstat -nlutp |grep 6379    #检查端口是否打开\ntcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN      7139/redis-server 1\n```\n\n### 安装php及inotify插件\n1）`yum`安装`php`\n```\n# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n# rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm\n# yum install --enablerepo=remi,remi-php56 php php-opcache php-pecl-apcu php-devel php-mbstring php-mcrypt php-mysqlnd php-phpunit-PHPUnit php-pecl-xdebug php-pecl-xhprof php-pdo php-pear php-fpm php-cli php-xml php-bcmath php-process php-gd php-common php-memcache php-redis php-pspell  php-fpm  php-mysql php-common php-mssql\n```\n2）安装`php`插件`inotify`\n```\n# wget http://pecl.php.net/get/inotify-0.1.6.tgz    #下载软件包\n# tar xf inotify-0.1.6.tgz    #解压软件包\n# yum install gcc gcc-c++ make    #安装编译工具\n# tar xf inotify-0.1.6.tgz\n# cd inotify-0.1.6/\n# phpize\n# ./configure --with-php-config=/usr/bin/php-config --enable-inotify\n# make && make install\n# echo \"extension = inotify.so\" >> /etc/php.d/inotify.ini\n# php -i|grep inotify\n# systemctl start php-fpm\n```\n\n### 编写PHP脚本\n>内外网其实一样，只是配置的连接信息不一样。\n\n1）监听脚本(`listen.php`)\n```\n[root@internet ~]# mkdir /home/script\n[root@internet ~]# vim /home/script/listen.php\n<?php\n/**\n * Created by PhpStorm.\n * User: ADMIN\n * Date: 2019/7/31\n * Time: 19:21\n */\n\ndefine('REDIS_HOST','127.0.0.1'); //redis连接主机\ndefine('REDIS_PASSWORD','obohna7Fogai9ahnahth');  //redis连接密码\ndefine('REDIS_PORT','6379');  //redis端口\n\ndefine('__LISTEN_DIR__',\"/opt/ftp/out\");  //本地监听目录\n\n\nclass Monitor{\n\n    private $dir = '';\n\n    //文件新增事件回调\n    private $onfileAdd;\n\n    public $timeout = 1;\n\n    public function __construct($dir,$onfileAdd)\n    {\n        if (!extension_loaded('inotify')) {\n            echo '请安装inotify扩展', PHP_EOL;\n            exit;\n        }\n\n        $this->dir = $dir;\n\n        $this->onfileAdd = $onfileAdd;\n\n        $this->run();\n    }\n\n    //对目录进行监控\n    public function run()\n    {\n        $dirs = $this->getDirs($this->dir);\n        if (empty($dirs)) {\n            return false;\n        }\n        $fd = inotify_init();\n        //设置为非阻塞模式\n        stream_set_blocking($fd, 0);\n        $watcher = [];\n        foreach ($dirs as $dir) {\n            $watch = inotify_add_watch($fd, $dir, IN_MODIFY | IN_CREATE | IN_DELETE | IN_DELETE_SELF | IN_CLOSE_WRITE);\n            if (!$watch) {\n                echo \"{$dir} 添加监控错误\", PHP_EOL;\n                exit;\n            }\n            $watcher[$watch] = $dir;\n        }\n        while (true) {\n            $reads = [$fd];\n            $write = [];\n            $except = [];\n            if (stream_select($reads, $write, $except, $this->timeout) > 0) {\n                if (!empty($reads)) {\n                    foreach ($reads as $read) {\n                        //从可读流中读取数据\n                        $events = inotify_read($read);\n                        $fileName = '';\n                        foreach ($events as $event) {\n\n                            //文件改变\n                            $fileChg = false;\n                            //目录改变\n                            $dirChg = false;\n\n                            $fileName = $event['name'];\n                            switch ($event['mask']) {\n                                case IN_CREATE:     //创建   IN_CLOSE_WRITE  写入结束\n                                case IN_DELETE:\n                                    $fileChg = true;\n                                    break;\n                                case 1073742080:\n                                case 1073742336:\n                                    $dirChg = true;\n                                    break;\n                            }\n\n                            if ($fileChg) {\n                                $filepath = $watcher[$event['wd']] . '/' . $fileName;\n                                if($watcher[$event['wd']] == $this->dir){\n                                    $newfile = $fileName;\n                                }else{\n                                    $newfile = str_replace($this->dir,'.',$filepath);\n                                }\n\n                                echo date('Y-m-d H:i:s') . \" | 事件目录：\" . $filepath .  \"，事件出现：{$event['mask']} ，文件/目录 {$fileName} 发生改变\" . PHP_EOL;\n                                echo date('Y-m-d H:i:s') . \" | \" . $newfile . PHP_EOL;\n//                                echo \"文件 {$fileName} 发生改变\", PHP_EOL;\n//                            echo shell_exec($this->cmd), PHP_EOL;\n//                                SysutilLogger::instance()->fileAdd(\"事件目录：\" . $watcher[$event['wd']] . \"，事件出现：{$event['mask']} ，文件/目录 {$fileName} 发生改变\");\n                                call_user_func_array($this->onfileAdd,[$filepath,$newfile]);\n\n                            }\n                            if ($dirChg) {\n//                                echo \"目录 {$fileName} 发生改变\", PHP_EOL;\n//                            echo shell_exec($this->cmd), PHP_EOL;\n                                //目录发生改变时  重新监听\n                                return $this->run();\n                            }\n                        }\n\n                    }\n                }\n            }\n        }\n        return true;\n    }\n\n    //递归的获取当前目录下所有子目录路径\n    public function getDirs($dir)\n    {\n        $dir = realpath($dir);\n        $dh = opendir($dir);\n        if (!$dh) {\n            return [];\n        }\n        $dirs = [];\n        $dirs[] = $dir;\n        while (($file = readdir($dh)) !== false) {\n            if ($file == '.' || $file == '..') {\n                continue;\n            }\n            $full = $dir . DIRECTORY_SEPARATOR . $file;\n            if (is_dir($full)) {\n                $dirs = array_merge($dirs, $this->getDirs($full));\n            }\n        }\n        closedir($dh);\n        return $dirs;\n    }\n\n}\n\nclass SysutilRedis {\n\n    private static $_instance;\n    private $m_redis = null;\n    private $mid_redis = null;      //律师中心redis实例\n\n    /**\n     * @return SysutilRedis|Redis\n     */\n    public static function instance()\n    {\n        if ( ! isset(SysutilRedis::$_instance))\n        {\n            SysutilRedis::$_instance = new SysutilRedis();\n        }\n        return SysutilRedis::$_instance;\n    }\n\n    /**\n     * @return null|Redis\n     */\n    public function getRedis()\n    {\n        if( !$this->m_redis ){\n            $this->m_redis = new Redis();\n            $this->m_redis->connect(REDIS_HOST,REDIS_PORT,10); //php客户端设置的ip及端口\n            $this->m_redis->auth(REDIS_PASSWORD);\n        }\n        return $this->m_redis;\n    }\n\n\n    public function close_redis()\n    {\n        if($this->m_redis) {\n            $this->m_redis->close();\n            $this->m_redis = null;\n        }\n        if($this->mid_redis) {\n            $this->mid_redis->close();\n            $this->mid_redis = null;\n        }\n    }\n\n    public function __destruct()\n    {\n        $this->close_redis();\n    }\n\n\n\n}\n\n\nclass Listenner {\n\n\n    public function run(){\n\n        $callBack = [$this,\"toRedis\"];\n\n        $listen_dir = __LISTEN_DIR__;\n\n        $monitor = new Monitor($listen_dir,$callBack);\n\n        $monitor->run();\n\n    }\n\n    /**\n     * @describe 文件回调\n     * @author zhouyong\n     */\n    public function toRedis($filename,$newfile){\n\n        $redis = SysutilRedis::instance()->getRedis();\n        $redis->select(9);\n        $cache_id = 'upload_file_list';\n        $data = [\n            'local' => $filename,\n            'remote' => $newfile\n        ];\n        $redis->rpush($cache_id, json_encode($data));\n    }\n\n\n}\n\n$listenner = new Listenner();\n\n$listenner->run();\n```\n2）上传文件脚本(`upFile.php`)\n```\n[root@internet ~]# vim /home/script/upFile.php\n<?php\n/**\n * Created by PhpStorm.\n * User: ADMIN\n * Date: 2019/7/31\n * Time: 19:21\n */\n\ndefine('REDIS_HOST','127.0.0.1'); //redis连接主机\ndefine('REDIS_PASSWORD','obohna7Fogai9ahnahth');  //redis连接密码\ndefine('REDIS_PORT','6379');  //redis端口\n\n\ndefine('FTP_HOST','192.168.1.33');  //内网ftp服务器\ndefine('FTP_PORT',21); //ftp端口\ndefine('FTP_USER','ftp_come_user');  //ftp连接账号\ndefine('FTP_PASS','Ftp_come_password@Qaz123');  //ftp连接密码\n\nclass SysutilFtp\n{\n\n    private static $instance;\n\n\n    public $off; // 返回操作状态(成功/失败)\n\n    public $conn_id; // FTP连接\n    /**\n     * 方法：FTP连接\n     * @FTP_HOST -- FTP主机\n     * @FTP_PORT -- 端口\n     * @FTP_USER -- 用户名\n     * @FTP_PASS -- 密码\n     */\n    private function __construct($FTP_HOST,$FTP_PORT,$FTP_USER,$FTP_PASS)\n    {\n        $this->conn_id = @ftp_connect($FTP_HOST,$FTP_PORT) or die(\"FTP服务器连接失败\");\n        @ftp_login($this->conn_id,$FTP_USER,$FTP_PASS) or die(\"FTP服务器登陆失败\");\n        @ftp_pasv($this->conn_id,1); // 打开被动模拟\n    }\n\n    /**\n     * @describe 获取ftp实例\n     */\n    public static function getInstance(){\n        if(!self::$instance){\n            self::$instance = new self(FTP_HOST,FTP_PORT,FTP_USER,FTP_PASS);\n            if(self::$instance){\n                echo date('Y-m-d H:i:s') . \" | connected !\" . PHP_EOL;\n            }\n        }\n        return self::$instance;\n    }\n\n    /**\n     * @describe 重连\n     * @author zhouyong\n     */\n    private function reConnect(){\n        echo date('Y-m-d H:i:s') . \" | closing connection ......\" . PHP_EOL;\n        //关闭当前链接\n        $this->close();\n        echo date('Y-m-d H:i:s') . \" | reconnecting....\" . PHP_EOL;\n        //开辟新连接\n        self::$instance = new self(FTP_HOST,FTP_PORT,FTP_USER,FTP_PASS);\n\n        echo date('Y-m-d H:i:s') . \" | connected !\" . PHP_EOL;\n    }\n    /**\n     * 方法：上传文件\n     * @path -- 本地路径\n     * @newpath -- 上传路径\n     * @type -- 若目标目录不存在则新建\n     * @return true\n     */\n    function up_file($path,$newpath,$type=true)\n    {\n        if($type) $this->dir_mkdirs($newpath);\n        echo date('Y-m-d H:i:s') . \" | 当前目录\" . ftp_pwd($this->conn_id) . PHP_EOL;\n        $newpath = ltrim($newpath,'.');\n        echo $newpath . PHP_EOL;\n        $this->off = @ftp_put($this->conn_id,$newpath,$path,FTP_BINARY);\n        if(!$this->off){\n//            echo \"文件上传失败，请检查权限及路径是否正确！\";\n//            echo \"文件上传失败，正在发起重连.....\";\n//            $this->reConnect();\n//            echo date('Y-m-d H:i:s') . \" | re-uploading file {$path} to {$newpath} ....\" . PHP_EOL;\n//            $this->up_file($path,$newpath,$type=true);\n            echo date('Y-m-d H:i:s') . \" | 上传失败\" . PHP_EOL;\n//            exit;\n            return false;\n        } else {\n            echo date('Y-m-d H:i:s') . \" | upload success !\" . PHP_EOL;\n            return true;\n        }\n    }\n    /**\n     * 方法：移动文件\n     * @path -- 原路径\n     * @newpath -- 新路径\n     * @type -- 若目标目录不存在则新建\n     */\n    function move_file($path,$newpath,$type=true)\n    {\n        if($type) $this->dir_mkdirs($newpath);\n        $this->off = @ftp_rename($this->conn_id,$path,$newpath);\n        if(!$this->off) echo \"文件移动失败，请检查权限及原路径是否正确！\";\n    }\n    /**\n     * 方法：复制文件\n     * 说明：由于FTP无复制命令,本方法变通操作为：下载后再上传到新的路径\n     * @path -- 原路径\n     * @newpath -- 新路径\n     * @type -- 若目标目录不存在则新建\n     */\n    function copy_file($path,$newpath,$type=true)\n    {\n        $downpath = \"c:/tmp.dat\";\n        $this->off = @ftp_get($this->conn_id,$downpath,$path,FTP_BINARY);// 下载\n        if(!$this->off) echo \"文件复制失败，请检查权限及原路径是否正确！\";\n        $this->up_file($downpath,$newpath,$type);\n    }\n    /**\n     * 方法：删除文件\n     * @path -- 路径\n     */\n    function del_file($path)\n    {\n        $this->off = @ftp_delete($this->conn_id,$path);\n        if(!$this->off) echo \"文件删除失败，请检查权限及路径是否正确！\";\n    }\n    /**\n     * 方法：生成目录\n     * @path -- 路径\n     */\n    function dir_mkdirs($path)\n    {\n        $path_arr = explode('/',$path); // 取目录数组\n        $file_name = array_pop($path_arr); // 弹出文件名\n        $path_div = count($path_arr); // 取层数\n        print_r($path_arr);\n        foreach($path_arr as $val) // 创建目录\n        {\n            if(@ftp_chdir($this->conn_id,$val) == FALSE)\n            {\n                $tmp = @ftp_mkdir($this->conn_id,$val);\n                echo date('Y-m-d H:i:s') . \" | 创建目录{$val}\" . PHP_EOL;\n                if($tmp == FALSE)\n                {\n                    echo date('Y-m-d H:i:s') . \" | 目录创建失败，请检查权限及路径是否正确！\" . PHP_EOL;\n                    exit;\n                }\n                @ftp_chdir($this->conn_id,$val);\n            }\n        }\n        echo date('Y-m-d H:i:s') . \" | 创建目录成功\" . PHP_EOL;\n\n        echo date('Y-m-d H:i:s') . \" | 当前目录\" . ftp_pwd($this->conn_id) . PHP_EOL;\n        for($i=1;$i<$path_div;$i++) // 回退到根\n        {\n            @ftp_cdup($this->conn_id);\n            echo date('Y-m-d H:i:s') . \" | 当前目录\" . ftp_pwd($this->conn_id) . PHP_EOL;\n        }\n    }\n\n    function ping(){\n        echo date(\"Y-m-d H:i:s\") . \" |  发送心跳数据 \" . PHP_EOL;\n        @ftp_raw($this->conn_id,'pingpong');\n    }\n    /**\n     * 方法：关闭FTP连接\n     */\n    function close()\n    {\n        @ftp_close($this->conn_id);\n    }\n}// class class_ftp end\n\n\nclass SysutilRedis {\n\n    private static $_instance;\n    private $m_redis = null;\n    private $mid_redis = null;      //律师中心redis实例\n\n    /**\n     * @return SysutilRedis\n     */\n    public static function instance(){\n        if ( ! isset(SysutilRedis::$_instance))\n        {\n            SysutilRedis::$_instance = new SysutilRedis();\n        }\n        return SysutilRedis::$_instance;\n    }\n\n    /**\n     * @return null|Redis\n     */\n    public function getRedis()\n    {\n        if( !$this->m_redis ){\n            $this->m_redis = new Redis();\n            $this->m_redis->connect(REDIS_HOST,REDIS_PORT,10); //php客户端设置的ip及端口\n            $this->m_redis->auth(REDIS_PASSWORD);\n        }\n        return $this->m_redis;\n    }\n\n\n    public function close_redis()\n    {\n        if($this->m_redis) {\n            $this->m_redis->close();\n            $this->m_redis = null;\n        }\n        if($this->mid_redis) {\n            $this->mid_redis->close();\n            $this->mid_redis = null;\n        }\n    }\n\n    public function __destruct()\n    {\n        $this->close_redis();\n    }\n\n\n\n}\n\n$redis = SysutilRedis::instance()->getRedis();\n$redis->select(9);\n$cache_id = 'upload_file_list';\n\n$no_data_time = 0;\n$ping = 3;      //心跳时间   每 x 秒发送一次心跳数据\nwhile (true){\n\n    $data = $redis->lRange($cache_id, 0, -1);\n    if (!empty($data)) {\n        $no_data_time = 0;\n        foreach ($data as $key => $value) {\n            $v = json_decode($value, true);\n            $result = up_file($v['local'],$v['remote']);\n            if($result){\n                $redis->select(9);\n                $redis->lPop($cache_id);\n            }else{\n                echo date(\"Y-m-d H:i:s\") . \"| 退出脚本\";\n                exit();\n            }\n\n        }\n    }else{\n        if($no_data_time > 0){\n            //查看没有事件的时间\n            $time = time();\n            if(($time - $no_data_time) > $ping){\n                //发送心跳  并重置时间\n                ping_ftp();\n                $no_data_time = $time;\n            }\n        }else{\n            $no_data_time = time();\n        }\n    }\n\n}\n\nfunction up_file($filename,$newfile){\n    echo date('Y-m-d H:i:s') . \" | $filename ,  $newfile\" . PHP_EOL;\n    $ftp = SysutilFtp::getInstance();\n    return $ftp->up_file($filename,$newfile);\n}\n\nfunction ping_ftp(){\n    $ftp = SysutilFtp::getInstance();\n    $ftp->ping();\n}\n```\n3）启动脚本并测试\n```\n#在一个终端启动listen.php脚本\n[root@internet ~]# php -f /home/script/listen.php\n\n\n#在另外一个终端启动upFile.php脚本\n[root@internet ~]# php -f /home/script/upFile.php \n2019-08-06 11:24:11 | connected !\n2019-08-06 11:24:11 |  发送心跳数据\n\n\n#在第三个终端往监听目录/opt/ftp/out目录新建一个文件或目录进行测试\n[root@internet ~]# echo \"test\" >> /opt/ftp/out/file1\n\n#分别可以在上面第一个终端和第二个终端看到日志信息\n终端一的信息：\n2019-08-06 11:36:26 | 事件目录：/opt/ftp/out/file1，事件出现：256 ，文件/目录 file1 发生改变\n2019-08-06 11:36:26 | file1\n\n终端二的信息：\n2019-08-06 11:36:26 | /opt/ftp/out/file1 ,  file1\nArray\n(\n)\n2019-08-06 11:36:26 | 创建目录成功\n2019-08-06 11:36:26 | 当前目录/\n2019-08-06 11:36:26 | 当前目录/\nfile1\n2019-08-06 11:36:26 | upload success !\n```\n\n\n### 管理两个脚本\n1）编写监控脚本，当进程挂掉便重启\n```\n# vim /home/script/process_alive.sh\n#!/bin/bash\n#用来监听listen脚本和upFile脚本\n\nDATE=[`date \"+%Y-%m-%d %H:%M:%S\"`]\n\nfunction phpScriptAlive {\n    script_dir=/home/script/\n    ps aux |grep -v grep |grep $1 >> /dev/null\n    if [[ $? != 0 ]]; then\n        nohup php -f ${script_dir}/$1 >> /var/log/$2 &\n        echo \"${DATE} 重启php脚本 $1\" >> /var/log/php_script_restart.log\n    fi\n}\n\nphpScriptAlive listen.php php_listen.log\nphpScriptAlive upFile.php php_upfile.log\n```\n\n2）添加到计划任务\n```\n# chmod +x /home/script/process_alive.sh \n# 监听php脚本进程\n* * * * * /bin/bash /home/script/process_alive.sh\n```\n3）查看日志；由于上面脚本里面写了将所有输出都记录到日志里面，所以后续直接查看日志即可\n```\n[root@internet ~]# tailf /var/log/php\nphp-fpm/                php_listen.log          php_script_restart.log  php_upfile.log\n[root@internet ~]# tailf /var/log/php_listen.log \n^C\n[root@internet ~]# tailf /var/log/php_upfile.log \n2019-08-06 12:01:18 |  发送心跳数据 \n2019-08-06 12:01:22 |  发送心跳数据 \n2019-08-06 12:01:26 |  发送心跳数据 \n2019-08-06 12:01:30 |  发送心跳数据 \n```\n4）再次往`/opt/ftp/out/`目录丢文件，便会自动同步到内网或者外网的`/opt/ftp/come`目录。\n```\n[root@internet ~]# echo \"sjdklf\" >> /opt/ftp/out/file111\n[root@internet ~]# for i in `seq 10`; do echo \"sjdlfjskldjf\" >> /opt/ftp/out/txt$i ; don\n\n#内网查看\n[root@lan ~]# ll /opt/ftp/come/\n总用量 48\n-rw-r--r-- 1 apache apache  5 8月   6 11:36 file1\n-rw-r--r-- 1 apache apache  7 8月   6 12:06 file111\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt1\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt10\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt2\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt3\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt4\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt5\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt6\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt7\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt8\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt9\n```\n\n\n\n\n\n","source":"_posts/PHP配合inotify实现光闸ftp功能.md","raw":"---\ntitle: PHP配合inotify实现光闸ftp功能\ndate: 2019-08-06 12:13:22\ntags: Linux\ncategories: Linux\ncopyright: true\n---\n\n## PHP配合inotify实现光闸ftp功能\n### 前言\n>由于业务需要，内外网的数据需要进行实时交互同步，由于环境因素，只能通过`ftp`进行文件的交互传输。且没有硬件设备（光闸）；鉴于这种情况下，首先考虑到的是通过`shell`脚本进行自动上传下载文件。然而在实施部署过程中发现，通过`shell`脚本方式进行文件的上传下载每一个文件都会建立一次连接。（由于环境因素，ftp通过网闸再通过`vpn`建立一次连接巨慢，大概需要几十秒。）可是项目站点必须是实时进行文件的传输，且每次可能是多个文件，多者甚至上百个。经过探讨考虑到使用`rsync+inotify`，通过rsync的守护进程模式进行文件的传输。可是这种项目迟早得换成光闸走`ftp`进行文件的传输。而后又考虑直接在代码里面实现建立`ftp`的长连接进行文件传输（建立一次连接，然后一直处于监听模式，发现有文件就及时进行传送）,这样一来又考虑到目录的监听情况，开始准备使用`inotify-tools`进行监听然后调用`php`代码里面的`ftp`长连接进程，随后又在`php`官方发现`php`也有一个`inotify`可以用来进行目录的监听，然后触发动作。\n>于是，最终方案就是在内外网两台服务器上面搭建`ftp`服务，然后通过`php`脚本进行目录的监听并上传到`ftp`服务器。\n\n>具体实现流程说明\n>1、内外网的服务器均安装`ftp`。\n>2、内外网的服务器均安装`php`及`php`的`inotify`插件。\n>3、内外网的服务器均安装`redis`。（`php`分为两个文件，一个为文件(`listen.php`)用于监听，一个文件(`upFile.php`)用于上传文件，由于开始没有存入`redis`，导致文件堆积，然后一直阻塞。故最终方案通过监听文件将监听到发生变化的文件路径存入到`redis`里，然后通过`upfile`脚本将文件上传到`ftp`）\n\n\n### 环境说明\n|      IP      |        主机名        | 系统版本  | 网络说明 |\n| :----------: | :------------------: | :-------: | :------: |\n| 192.168.1.32 | internet.example.com | CenTOS7.4 | 模拟外网 |\n| 192.168.1.33 |   lan.example.com    | CenTOS7.4 | 模拟内网 |\n\n\n>1、这里是通过两台虚拟机进行模拟内外网。且上面真实项目操作系统为`CenTOS6.5`；这里使用`CenTOS7.5`模拟。\n>2、两台服务器需要安装软件有：`vsftpd`、`php`、`php`插件`inotify`\n>3、外网的`/opt/ftp/out`目录只要有新的文件产生就会自动触发监听然后传送至内网的`/opt/ftp/come`目录。\n>4、反之一样，内网的`/opt/ftp/out`目录只要有新的文件产生就会自动触发监听然后传送至外网的`/opt/ftp/come`目录。\n\n### 项目结构图\n![image.png](PHP配合inotify实现光闸ftp功能/01.png)\n\n## 具体实验步骤\n### 安装配置vsftpd\n>说明：内外网都需要配置`vsftpd`，配置`vsftpd`虚拟用户可参考 https://www.cnblogs.com/yanjieli/p/10723108.html\n\n```\n# mkdir -p /opt/ftp/{come,out}    #创建对应的数据目录\n# yum -y install vsftpd    #安装vsftpd\n# useradd -s /sbin/nologin apache    #由于项目站点所使用的apache用户，所以这里为了防止权限问题，这里也是用apache用户作为虚拟用户\n# chown apache.apache /opt/ftp/ -R    #将数据目录权限改为apache用户\n# cat >/etc/vsftpd/logins.txt<<-EOF    #创建ftp虚拟账号和密码，一行账号一行密码\nftp_come_user\nFtp_come_password@Qaz123\nEOF\n\n# db_load -T -t hash -f /etc/vsftpd/logins.txt /etc/vsftpd/login.db    #将密码文件转换成db格式\n# chmod 600 /etc/vsftpd/login.db    #更改db文件的权限\n\n# cat >/etc/pam.d/ftp<<-EOF    #定义pam认证文件\nauth  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\naccount  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\nEOF\n\n# cp /etc/vsftpd/vsftpd.conf{,.back}    #备份配置文件\n# vim /etc/vsftpd/vsftpd.conf    #编辑vsftpd主配置文件\nanonymous_enable=NO\nlocal_enable=YES\nwrite_enable=NO\nanon_upload_enable=NO\nanon_mkdir_write_enable=NO\nanon_other_write_enable=NO\nchroot_local_user=YES\nallow_writeable_chroot=YES\nguest_enable=YES\nguest_username=apache\nlisten=YES\nlisten_port=21\npasv_enable=YES\npasv_address=192.168.1.32    #内网的那台改成对应内网的IP地址\npasv_min_port=10000\npasv_max_port=10088\nanon_world_readable_only=NO\nuser_config_dir=/etc/vsftpd/user_conf\ntcp_wrappers=YES\n\n# vim /etc/vsftpd/user_conf/ftp_come_user    #编辑虚拟用户的子配置文件\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nanon_umask=022\nlocal_root=/opt/ftp/come\n\n# systemctl start vsftpd    #启动ftp\n```\n\n### 测试ftp\n1）在外网（`192.168.1.32`）上访问内网（`192.168.1.33`）的`ftp`\n```\n[root@internet ~]# dd if=/dev/zero of=testfile bs=1M count=100    #创建一个测试文件用于测试上传\n[root@internet ~]# lftp ftp_come_user:Ftp_come_password@Qaz123@192.168.1.33    #通过lftp工具连接ftp\nlftp ftp_come_user@192.168.1.33:~> lcd\nlcd 成功, 本地目录=/root\nlftp ftp_come_user@192.168.1.33:~> put testfile\n104857600 bytes transferred in 2 seconds (55.59M/s)\nlftp ftp_come_user@192.168.1.33:/> ls\n-rw-r--r--    1 1001     1001     104857600 Aug 05 12:41 testfile\n```\n2）在内网（`192.168.1.33`）上访问外网（`192.168.1.32`）的`ftp`\n```\n[root@lan ~]# dd if=/dev/zero of=testfile1 bs=1M count=100    #同样创建一个测试文件\n[root@lan ~]# lftp ftp_come_user:Ftp_come_password@Qaz123@192.168.1.32\nlftp ftp_come_user@192.168.1.32:~> put testfile1\n104857600 bytes transferred in 3 seconds (31.87M/s)              \nlftp ftp_come_user@192.168.1.32:/>\nlftp ftp_come_user@192.168.1.32:/> ls\n-rw-r--r--    1 1001     1001     104857600 Aug 05 12:45 testfile1\n```\n3）在内网的`/opt/ftp/come`目录验证是否存在`testfile`文件\n```\n[root@lan ~]# ll /opt/ftp/come/\n总用量 102400\n-rw-r--r-- 1 apache apache 104857600 8月   5 20:41 testfile\n```\n4）在外网的`/opt/ftp/come`目录验证是否存在`testfile1`文件\n```\n[root@internet ~]# ll /opt/ftp/come/\n总用量 102400\n-rw-r--r-- 1 apache apache 104857600 8月   5 20:45 testfile1\n```\n通过测试`ftp`已经`ok`\n\n\n### 安装配置redis\n> 生产环境`redis`可能端口不一样，然后根据不同的进行配置即可。同时设置连接密码，（这里只是测试，所以两边的配置一样）\n\n```\n# yum -y install redis    #安装redis\n# cp /etc/redis.conf{,.back}    #拷贝redis配置文件\n# vim /etc/redis.conf    #编辑redis配置文件\ndaemonize yes    #开启后台常驻进程\nrequirepass obohna7Fogai9ahnahth    #设置redis连接密码\n# systemctl start redis    #启动redis\n# netstat -nlutp |grep 6379    #检查端口是否打开\ntcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN      7139/redis-server 1\n```\n\n### 安装php及inotify插件\n1）`yum`安装`php`\n```\n# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n# rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm\n# yum install --enablerepo=remi,remi-php56 php php-opcache php-pecl-apcu php-devel php-mbstring php-mcrypt php-mysqlnd php-phpunit-PHPUnit php-pecl-xdebug php-pecl-xhprof php-pdo php-pear php-fpm php-cli php-xml php-bcmath php-process php-gd php-common php-memcache php-redis php-pspell  php-fpm  php-mysql php-common php-mssql\n```\n2）安装`php`插件`inotify`\n```\n# wget http://pecl.php.net/get/inotify-0.1.6.tgz    #下载软件包\n# tar xf inotify-0.1.6.tgz    #解压软件包\n# yum install gcc gcc-c++ make    #安装编译工具\n# tar xf inotify-0.1.6.tgz\n# cd inotify-0.1.6/\n# phpize\n# ./configure --with-php-config=/usr/bin/php-config --enable-inotify\n# make && make install\n# echo \"extension = inotify.so\" >> /etc/php.d/inotify.ini\n# php -i|grep inotify\n# systemctl start php-fpm\n```\n\n### 编写PHP脚本\n>内外网其实一样，只是配置的连接信息不一样。\n\n1）监听脚本(`listen.php`)\n```\n[root@internet ~]# mkdir /home/script\n[root@internet ~]# vim /home/script/listen.php\n<?php\n/**\n * Created by PhpStorm.\n * User: ADMIN\n * Date: 2019/7/31\n * Time: 19:21\n */\n\ndefine('REDIS_HOST','127.0.0.1'); //redis连接主机\ndefine('REDIS_PASSWORD','obohna7Fogai9ahnahth');  //redis连接密码\ndefine('REDIS_PORT','6379');  //redis端口\n\ndefine('__LISTEN_DIR__',\"/opt/ftp/out\");  //本地监听目录\n\n\nclass Monitor{\n\n    private $dir = '';\n\n    //文件新增事件回调\n    private $onfileAdd;\n\n    public $timeout = 1;\n\n    public function __construct($dir,$onfileAdd)\n    {\n        if (!extension_loaded('inotify')) {\n            echo '请安装inotify扩展', PHP_EOL;\n            exit;\n        }\n\n        $this->dir = $dir;\n\n        $this->onfileAdd = $onfileAdd;\n\n        $this->run();\n    }\n\n    //对目录进行监控\n    public function run()\n    {\n        $dirs = $this->getDirs($this->dir);\n        if (empty($dirs)) {\n            return false;\n        }\n        $fd = inotify_init();\n        //设置为非阻塞模式\n        stream_set_blocking($fd, 0);\n        $watcher = [];\n        foreach ($dirs as $dir) {\n            $watch = inotify_add_watch($fd, $dir, IN_MODIFY | IN_CREATE | IN_DELETE | IN_DELETE_SELF | IN_CLOSE_WRITE);\n            if (!$watch) {\n                echo \"{$dir} 添加监控错误\", PHP_EOL;\n                exit;\n            }\n            $watcher[$watch] = $dir;\n        }\n        while (true) {\n            $reads = [$fd];\n            $write = [];\n            $except = [];\n            if (stream_select($reads, $write, $except, $this->timeout) > 0) {\n                if (!empty($reads)) {\n                    foreach ($reads as $read) {\n                        //从可读流中读取数据\n                        $events = inotify_read($read);\n                        $fileName = '';\n                        foreach ($events as $event) {\n\n                            //文件改变\n                            $fileChg = false;\n                            //目录改变\n                            $dirChg = false;\n\n                            $fileName = $event['name'];\n                            switch ($event['mask']) {\n                                case IN_CREATE:     //创建   IN_CLOSE_WRITE  写入结束\n                                case IN_DELETE:\n                                    $fileChg = true;\n                                    break;\n                                case 1073742080:\n                                case 1073742336:\n                                    $dirChg = true;\n                                    break;\n                            }\n\n                            if ($fileChg) {\n                                $filepath = $watcher[$event['wd']] . '/' . $fileName;\n                                if($watcher[$event['wd']] == $this->dir){\n                                    $newfile = $fileName;\n                                }else{\n                                    $newfile = str_replace($this->dir,'.',$filepath);\n                                }\n\n                                echo date('Y-m-d H:i:s') . \" | 事件目录：\" . $filepath .  \"，事件出现：{$event['mask']} ，文件/目录 {$fileName} 发生改变\" . PHP_EOL;\n                                echo date('Y-m-d H:i:s') . \" | \" . $newfile . PHP_EOL;\n//                                echo \"文件 {$fileName} 发生改变\", PHP_EOL;\n//                            echo shell_exec($this->cmd), PHP_EOL;\n//                                SysutilLogger::instance()->fileAdd(\"事件目录：\" . $watcher[$event['wd']] . \"，事件出现：{$event['mask']} ，文件/目录 {$fileName} 发生改变\");\n                                call_user_func_array($this->onfileAdd,[$filepath,$newfile]);\n\n                            }\n                            if ($dirChg) {\n//                                echo \"目录 {$fileName} 发生改变\", PHP_EOL;\n//                            echo shell_exec($this->cmd), PHP_EOL;\n                                //目录发生改变时  重新监听\n                                return $this->run();\n                            }\n                        }\n\n                    }\n                }\n            }\n        }\n        return true;\n    }\n\n    //递归的获取当前目录下所有子目录路径\n    public function getDirs($dir)\n    {\n        $dir = realpath($dir);\n        $dh = opendir($dir);\n        if (!$dh) {\n            return [];\n        }\n        $dirs = [];\n        $dirs[] = $dir;\n        while (($file = readdir($dh)) !== false) {\n            if ($file == '.' || $file == '..') {\n                continue;\n            }\n            $full = $dir . DIRECTORY_SEPARATOR . $file;\n            if (is_dir($full)) {\n                $dirs = array_merge($dirs, $this->getDirs($full));\n            }\n        }\n        closedir($dh);\n        return $dirs;\n    }\n\n}\n\nclass SysutilRedis {\n\n    private static $_instance;\n    private $m_redis = null;\n    private $mid_redis = null;      //律师中心redis实例\n\n    /**\n     * @return SysutilRedis|Redis\n     */\n    public static function instance()\n    {\n        if ( ! isset(SysutilRedis::$_instance))\n        {\n            SysutilRedis::$_instance = new SysutilRedis();\n        }\n        return SysutilRedis::$_instance;\n    }\n\n    /**\n     * @return null|Redis\n     */\n    public function getRedis()\n    {\n        if( !$this->m_redis ){\n            $this->m_redis = new Redis();\n            $this->m_redis->connect(REDIS_HOST,REDIS_PORT,10); //php客户端设置的ip及端口\n            $this->m_redis->auth(REDIS_PASSWORD);\n        }\n        return $this->m_redis;\n    }\n\n\n    public function close_redis()\n    {\n        if($this->m_redis) {\n            $this->m_redis->close();\n            $this->m_redis = null;\n        }\n        if($this->mid_redis) {\n            $this->mid_redis->close();\n            $this->mid_redis = null;\n        }\n    }\n\n    public function __destruct()\n    {\n        $this->close_redis();\n    }\n\n\n\n}\n\n\nclass Listenner {\n\n\n    public function run(){\n\n        $callBack = [$this,\"toRedis\"];\n\n        $listen_dir = __LISTEN_DIR__;\n\n        $monitor = new Monitor($listen_dir,$callBack);\n\n        $monitor->run();\n\n    }\n\n    /**\n     * @describe 文件回调\n     * @author zhouyong\n     */\n    public function toRedis($filename,$newfile){\n\n        $redis = SysutilRedis::instance()->getRedis();\n        $redis->select(9);\n        $cache_id = 'upload_file_list';\n        $data = [\n            'local' => $filename,\n            'remote' => $newfile\n        ];\n        $redis->rpush($cache_id, json_encode($data));\n    }\n\n\n}\n\n$listenner = new Listenner();\n\n$listenner->run();\n```\n2）上传文件脚本(`upFile.php`)\n```\n[root@internet ~]# vim /home/script/upFile.php\n<?php\n/**\n * Created by PhpStorm.\n * User: ADMIN\n * Date: 2019/7/31\n * Time: 19:21\n */\n\ndefine('REDIS_HOST','127.0.0.1'); //redis连接主机\ndefine('REDIS_PASSWORD','obohna7Fogai9ahnahth');  //redis连接密码\ndefine('REDIS_PORT','6379');  //redis端口\n\n\ndefine('FTP_HOST','192.168.1.33');  //内网ftp服务器\ndefine('FTP_PORT',21); //ftp端口\ndefine('FTP_USER','ftp_come_user');  //ftp连接账号\ndefine('FTP_PASS','Ftp_come_password@Qaz123');  //ftp连接密码\n\nclass SysutilFtp\n{\n\n    private static $instance;\n\n\n    public $off; // 返回操作状态(成功/失败)\n\n    public $conn_id; // FTP连接\n    /**\n     * 方法：FTP连接\n     * @FTP_HOST -- FTP主机\n     * @FTP_PORT -- 端口\n     * @FTP_USER -- 用户名\n     * @FTP_PASS -- 密码\n     */\n    private function __construct($FTP_HOST,$FTP_PORT,$FTP_USER,$FTP_PASS)\n    {\n        $this->conn_id = @ftp_connect($FTP_HOST,$FTP_PORT) or die(\"FTP服务器连接失败\");\n        @ftp_login($this->conn_id,$FTP_USER,$FTP_PASS) or die(\"FTP服务器登陆失败\");\n        @ftp_pasv($this->conn_id,1); // 打开被动模拟\n    }\n\n    /**\n     * @describe 获取ftp实例\n     */\n    public static function getInstance(){\n        if(!self::$instance){\n            self::$instance = new self(FTP_HOST,FTP_PORT,FTP_USER,FTP_PASS);\n            if(self::$instance){\n                echo date('Y-m-d H:i:s') . \" | connected !\" . PHP_EOL;\n            }\n        }\n        return self::$instance;\n    }\n\n    /**\n     * @describe 重连\n     * @author zhouyong\n     */\n    private function reConnect(){\n        echo date('Y-m-d H:i:s') . \" | closing connection ......\" . PHP_EOL;\n        //关闭当前链接\n        $this->close();\n        echo date('Y-m-d H:i:s') . \" | reconnecting....\" . PHP_EOL;\n        //开辟新连接\n        self::$instance = new self(FTP_HOST,FTP_PORT,FTP_USER,FTP_PASS);\n\n        echo date('Y-m-d H:i:s') . \" | connected !\" . PHP_EOL;\n    }\n    /**\n     * 方法：上传文件\n     * @path -- 本地路径\n     * @newpath -- 上传路径\n     * @type -- 若目标目录不存在则新建\n     * @return true\n     */\n    function up_file($path,$newpath,$type=true)\n    {\n        if($type) $this->dir_mkdirs($newpath);\n        echo date('Y-m-d H:i:s') . \" | 当前目录\" . ftp_pwd($this->conn_id) . PHP_EOL;\n        $newpath = ltrim($newpath,'.');\n        echo $newpath . PHP_EOL;\n        $this->off = @ftp_put($this->conn_id,$newpath,$path,FTP_BINARY);\n        if(!$this->off){\n//            echo \"文件上传失败，请检查权限及路径是否正确！\";\n//            echo \"文件上传失败，正在发起重连.....\";\n//            $this->reConnect();\n//            echo date('Y-m-d H:i:s') . \" | re-uploading file {$path} to {$newpath} ....\" . PHP_EOL;\n//            $this->up_file($path,$newpath,$type=true);\n            echo date('Y-m-d H:i:s') . \" | 上传失败\" . PHP_EOL;\n//            exit;\n            return false;\n        } else {\n            echo date('Y-m-d H:i:s') . \" | upload success !\" . PHP_EOL;\n            return true;\n        }\n    }\n    /**\n     * 方法：移动文件\n     * @path -- 原路径\n     * @newpath -- 新路径\n     * @type -- 若目标目录不存在则新建\n     */\n    function move_file($path,$newpath,$type=true)\n    {\n        if($type) $this->dir_mkdirs($newpath);\n        $this->off = @ftp_rename($this->conn_id,$path,$newpath);\n        if(!$this->off) echo \"文件移动失败，请检查权限及原路径是否正确！\";\n    }\n    /**\n     * 方法：复制文件\n     * 说明：由于FTP无复制命令,本方法变通操作为：下载后再上传到新的路径\n     * @path -- 原路径\n     * @newpath -- 新路径\n     * @type -- 若目标目录不存在则新建\n     */\n    function copy_file($path,$newpath,$type=true)\n    {\n        $downpath = \"c:/tmp.dat\";\n        $this->off = @ftp_get($this->conn_id,$downpath,$path,FTP_BINARY);// 下载\n        if(!$this->off) echo \"文件复制失败，请检查权限及原路径是否正确！\";\n        $this->up_file($downpath,$newpath,$type);\n    }\n    /**\n     * 方法：删除文件\n     * @path -- 路径\n     */\n    function del_file($path)\n    {\n        $this->off = @ftp_delete($this->conn_id,$path);\n        if(!$this->off) echo \"文件删除失败，请检查权限及路径是否正确！\";\n    }\n    /**\n     * 方法：生成目录\n     * @path -- 路径\n     */\n    function dir_mkdirs($path)\n    {\n        $path_arr = explode('/',$path); // 取目录数组\n        $file_name = array_pop($path_arr); // 弹出文件名\n        $path_div = count($path_arr); // 取层数\n        print_r($path_arr);\n        foreach($path_arr as $val) // 创建目录\n        {\n            if(@ftp_chdir($this->conn_id,$val) == FALSE)\n            {\n                $tmp = @ftp_mkdir($this->conn_id,$val);\n                echo date('Y-m-d H:i:s') . \" | 创建目录{$val}\" . PHP_EOL;\n                if($tmp == FALSE)\n                {\n                    echo date('Y-m-d H:i:s') . \" | 目录创建失败，请检查权限及路径是否正确！\" . PHP_EOL;\n                    exit;\n                }\n                @ftp_chdir($this->conn_id,$val);\n            }\n        }\n        echo date('Y-m-d H:i:s') . \" | 创建目录成功\" . PHP_EOL;\n\n        echo date('Y-m-d H:i:s') . \" | 当前目录\" . ftp_pwd($this->conn_id) . PHP_EOL;\n        for($i=1;$i<$path_div;$i++) // 回退到根\n        {\n            @ftp_cdup($this->conn_id);\n            echo date('Y-m-d H:i:s') . \" | 当前目录\" . ftp_pwd($this->conn_id) . PHP_EOL;\n        }\n    }\n\n    function ping(){\n        echo date(\"Y-m-d H:i:s\") . \" |  发送心跳数据 \" . PHP_EOL;\n        @ftp_raw($this->conn_id,'pingpong');\n    }\n    /**\n     * 方法：关闭FTP连接\n     */\n    function close()\n    {\n        @ftp_close($this->conn_id);\n    }\n}// class class_ftp end\n\n\nclass SysutilRedis {\n\n    private static $_instance;\n    private $m_redis = null;\n    private $mid_redis = null;      //律师中心redis实例\n\n    /**\n     * @return SysutilRedis\n     */\n    public static function instance(){\n        if ( ! isset(SysutilRedis::$_instance))\n        {\n            SysutilRedis::$_instance = new SysutilRedis();\n        }\n        return SysutilRedis::$_instance;\n    }\n\n    /**\n     * @return null|Redis\n     */\n    public function getRedis()\n    {\n        if( !$this->m_redis ){\n            $this->m_redis = new Redis();\n            $this->m_redis->connect(REDIS_HOST,REDIS_PORT,10); //php客户端设置的ip及端口\n            $this->m_redis->auth(REDIS_PASSWORD);\n        }\n        return $this->m_redis;\n    }\n\n\n    public function close_redis()\n    {\n        if($this->m_redis) {\n            $this->m_redis->close();\n            $this->m_redis = null;\n        }\n        if($this->mid_redis) {\n            $this->mid_redis->close();\n            $this->mid_redis = null;\n        }\n    }\n\n    public function __destruct()\n    {\n        $this->close_redis();\n    }\n\n\n\n}\n\n$redis = SysutilRedis::instance()->getRedis();\n$redis->select(9);\n$cache_id = 'upload_file_list';\n\n$no_data_time = 0;\n$ping = 3;      //心跳时间   每 x 秒发送一次心跳数据\nwhile (true){\n\n    $data = $redis->lRange($cache_id, 0, -1);\n    if (!empty($data)) {\n        $no_data_time = 0;\n        foreach ($data as $key => $value) {\n            $v = json_decode($value, true);\n            $result = up_file($v['local'],$v['remote']);\n            if($result){\n                $redis->select(9);\n                $redis->lPop($cache_id);\n            }else{\n                echo date(\"Y-m-d H:i:s\") . \"| 退出脚本\";\n                exit();\n            }\n\n        }\n    }else{\n        if($no_data_time > 0){\n            //查看没有事件的时间\n            $time = time();\n            if(($time - $no_data_time) > $ping){\n                //发送心跳  并重置时间\n                ping_ftp();\n                $no_data_time = $time;\n            }\n        }else{\n            $no_data_time = time();\n        }\n    }\n\n}\n\nfunction up_file($filename,$newfile){\n    echo date('Y-m-d H:i:s') . \" | $filename ,  $newfile\" . PHP_EOL;\n    $ftp = SysutilFtp::getInstance();\n    return $ftp->up_file($filename,$newfile);\n}\n\nfunction ping_ftp(){\n    $ftp = SysutilFtp::getInstance();\n    $ftp->ping();\n}\n```\n3）启动脚本并测试\n```\n#在一个终端启动listen.php脚本\n[root@internet ~]# php -f /home/script/listen.php\n\n\n#在另外一个终端启动upFile.php脚本\n[root@internet ~]# php -f /home/script/upFile.php \n2019-08-06 11:24:11 | connected !\n2019-08-06 11:24:11 |  发送心跳数据\n\n\n#在第三个终端往监听目录/opt/ftp/out目录新建一个文件或目录进行测试\n[root@internet ~]# echo \"test\" >> /opt/ftp/out/file1\n\n#分别可以在上面第一个终端和第二个终端看到日志信息\n终端一的信息：\n2019-08-06 11:36:26 | 事件目录：/opt/ftp/out/file1，事件出现：256 ，文件/目录 file1 发生改变\n2019-08-06 11:36:26 | file1\n\n终端二的信息：\n2019-08-06 11:36:26 | /opt/ftp/out/file1 ,  file1\nArray\n(\n)\n2019-08-06 11:36:26 | 创建目录成功\n2019-08-06 11:36:26 | 当前目录/\n2019-08-06 11:36:26 | 当前目录/\nfile1\n2019-08-06 11:36:26 | upload success !\n```\n\n\n### 管理两个脚本\n1）编写监控脚本，当进程挂掉便重启\n```\n# vim /home/script/process_alive.sh\n#!/bin/bash\n#用来监听listen脚本和upFile脚本\n\nDATE=[`date \"+%Y-%m-%d %H:%M:%S\"`]\n\nfunction phpScriptAlive {\n    script_dir=/home/script/\n    ps aux |grep -v grep |grep $1 >> /dev/null\n    if [[ $? != 0 ]]; then\n        nohup php -f ${script_dir}/$1 >> /var/log/$2 &\n        echo \"${DATE} 重启php脚本 $1\" >> /var/log/php_script_restart.log\n    fi\n}\n\nphpScriptAlive listen.php php_listen.log\nphpScriptAlive upFile.php php_upfile.log\n```\n\n2）添加到计划任务\n```\n# chmod +x /home/script/process_alive.sh \n# 监听php脚本进程\n* * * * * /bin/bash /home/script/process_alive.sh\n```\n3）查看日志；由于上面脚本里面写了将所有输出都记录到日志里面，所以后续直接查看日志即可\n```\n[root@internet ~]# tailf /var/log/php\nphp-fpm/                php_listen.log          php_script_restart.log  php_upfile.log\n[root@internet ~]# tailf /var/log/php_listen.log \n^C\n[root@internet ~]# tailf /var/log/php_upfile.log \n2019-08-06 12:01:18 |  发送心跳数据 \n2019-08-06 12:01:22 |  发送心跳数据 \n2019-08-06 12:01:26 |  发送心跳数据 \n2019-08-06 12:01:30 |  发送心跳数据 \n```\n4）再次往`/opt/ftp/out/`目录丢文件，便会自动同步到内网或者外网的`/opt/ftp/come`目录。\n```\n[root@internet ~]# echo \"sjdklf\" >> /opt/ftp/out/file111\n[root@internet ~]# for i in `seq 10`; do echo \"sjdlfjskldjf\" >> /opt/ftp/out/txt$i ; don\n\n#内网查看\n[root@lan ~]# ll /opt/ftp/come/\n总用量 48\n-rw-r--r-- 1 apache apache  5 8月   6 11:36 file1\n-rw-r--r-- 1 apache apache  7 8月   6 12:06 file111\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt1\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt10\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt2\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt3\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt4\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt5\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt6\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt7\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt8\n-rw-r--r-- 1 apache apache 13 8月   6 12:07 txt9\n```\n\n\n\n\n\n","slug":"PHP配合inotify实现光闸ftp功能","published":1,"updated":"2019-10-24T09:12:16.888Z","_id":"cjz3xyiuh000kdstcz1u3q8dr","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"PHP配合inotify实现光闸ftp功能\"><a href=\"#PHP配合inotify实现光闸ftp功能\" class=\"headerlink\" title=\"PHP配合inotify实现光闸ftp功能\"></a>PHP配合inotify实现光闸ftp功能</h2><h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><blockquote>\n<p>由于业务需要，内外网的数据需要进行实时交互同步，由于环境因素，只能通过<code>ftp</code>进行文件的交互传输。且没有硬件设备（光闸）；鉴于这种情况下，首先考虑到的是通过<code>shell</code>脚本进行自动上传下载文件。然而在实施部署过程中发现，通过<code>shell</code>脚本方式进行文件的上传下载每一个文件都会建立一次连接。（由于环境因素，ftp通过网闸再通过<code>vpn</code>建立一次连接巨慢，大概需要几十秒。）可是项目站点必须是实时进行文件的传输，且每次可能是多个文件，多者甚至上百个。经过探讨考虑到使用<code>rsync+inotify</code>，通过rsync的守护进程模式进行文件的传输。可是这种项目迟早得换成光闸走<code>ftp</code>进行文件的传输。而后又考虑直接在代码里面实现建立<code>ftp</code>的长连接进行文件传输（建立一次连接，然后一直处于监听模式，发现有文件就及时进行传送）,这样一来又考虑到目录的监听情况，开始准备使用<code>inotify-tools</code>进行监听然后调用<code>php</code>代码里面的<code>ftp</code>长连接进程，随后又在<code>php</code>官方发现<code>php</code>也有一个<code>inotify</code>可以用来进行目录的监听，然后触发动作。<br>于是，最终方案就是在内外网两台服务器上面搭建<code>ftp</code>服务，然后通过<code>php</code>脚本进行目录的监听并上传到<code>ftp</code>服务器。</p>\n</blockquote>\n<blockquote>\n<p>具体实现流程说明<br>1、内外网的服务器均安装<code>ftp</code>。<br>2、内外网的服务器均安装<code>php</code>及<code>php</code>的<code>inotify</code>插件。<br>3、内外网的服务器均安装<code>redis</code>。（<code>php</code>分为两个文件，一个为文件(<code>listen.php</code>)用于监听，一个文件(<code>upFile.php</code>)用于上传文件，由于开始没有存入<code>redis</code>，导致文件堆积，然后一直阻塞。故最终方案通过监听文件将监听到发生变化的文件路径存入到<code>redis</code>里，然后通过<code>upfile</code>脚本将文件上传到<code>ftp</code>）</p>\n</blockquote>\n<h3 id=\"环境说明\"><a href=\"#环境说明\" class=\"headerlink\" title=\"环境说明\"></a>环境说明</h3><table>\n<thead>\n<tr>\n<th style=\"text-align:center\">IP</th>\n<th style=\"text-align:center\">主机名</th>\n<th style=\"text-align:center\">系统版本</th>\n<th style=\"text-align:center\">网络说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">192.168.1.32</td>\n<td style=\"text-align:center\">internet.example.com</td>\n<td style=\"text-align:center\">CenTOS7.4</td>\n<td style=\"text-align:center\">模拟外网</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.33</td>\n<td style=\"text-align:center\">lan.example.com</td>\n<td style=\"text-align:center\">CenTOS7.4</td>\n<td style=\"text-align:center\">模拟内网</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>1、这里是通过两台虚拟机进行模拟内外网。且上面真实项目操作系统为<code>CenTOS6.5</code>；这里使用<code>CenTOS7.5</code>模拟。<br>2、两台服务器需要安装软件有：<code>vsftpd</code>、<code>php</code>、<code>php</code>插件<code>inotify</code><br>3、外网的<code>/opt/ftp/out</code>目录只要有新的文件产生就会自动触发监听然后传送至内网的<code>/opt/ftp/come</code>目录。<br>4、反之一样，内网的<code>/opt/ftp/out</code>目录只要有新的文件产生就会自动触发监听然后传送至外网的<code>/opt/ftp/come</code>目录。</p>\n</blockquote>\n<h3 id=\"项目结构图\"><a href=\"#项目结构图\" class=\"headerlink\" title=\"项目结构图\"></a>项目结构图</h3><p><img src=\"/2019/08/06/PHP配合inotify实现光闸ftp功能/01.png\" alt=\"image.png\"></p>\n<h2 id=\"具体实验步骤\"><a href=\"#具体实验步骤\" class=\"headerlink\" title=\"具体实验步骤\"></a>具体实验步骤</h2><h3 id=\"安装配置vsftpd\"><a href=\"#安装配置vsftpd\" class=\"headerlink\" title=\"安装配置vsftpd\"></a>安装配置vsftpd</h3><blockquote>\n<p>说明：内外网都需要配置<code>vsftpd</code>，配置<code>vsftpd</code>虚拟用户可参考 <a href=\"https://www.cnblogs.com/yanjieli/p/10723108.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/yanjieli/p/10723108.html</a></p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># mkdir -p /opt/ftp/&#123;come,out&#125;    #创建对应的数据目录</span></span><br><span class=\"line\"><span class=\"comment\"># yum -y install vsftpd    #安装vsftpd</span></span><br><span class=\"line\"><span class=\"comment\"># useradd -s /sbin/nologin apache    #由于项目站点所使用的apache用户，所以这里为了防止权限问题，这里也是用apache用户作为虚拟用户</span></span><br><span class=\"line\"><span class=\"comment\"># chown apache.apache /opt/ftp/ -R    #将数据目录权限改为apache用户</span></span><br><span class=\"line\"><span class=\"comment\"># cat &gt;/etc/vsftpd/logins.txt&lt;&lt;-EOF    #创建ftp虚拟账号和密码，一行账号一行密码</span></span><br><span class=\"line\">ftp_come_user</span><br><span class=\"line\">Ftp_come_password@Qaz123</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># db_load -T -t hash -f /etc/vsftpd/logins.txt /etc/vsftpd/login.db    #将密码文件转换成db格式</span></span><br><span class=\"line\"><span class=\"comment\"># chmod 600 /etc/vsftpd/login.db    #更改db文件的权限</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat &gt;/etc/pam.d/ftp&lt;&lt;-EOF    #定义pam认证文件</span></span><br><span class=\"line\">auth  required  /lib64/security/pam_userdb.so  <span class=\"attribute\">db</span>=/etc/vsftpd/login</span><br><span class=\"line\">account  required  /lib64/security/pam_userdb.so  <span class=\"attribute\">db</span>=/etc/vsftpd/login</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cp /etc/vsftpd/vsftpd.conf&#123;,.back&#125;    #备份配置文件</span></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/vsftpd.conf    #编辑vsftpd主配置文件</span></span><br><span class=\"line\"><span class=\"attribute\">anonymous_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">local_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">anon_upload_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">anon_mkdir_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">anon_other_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">chroot_local_user</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">allow_writeable_chroot</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">guest_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">guest_username</span>=apache</span><br><span class=\"line\"><span class=\"attribute\">listen</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">listen_port</span>=21</span><br><span class=\"line\"><span class=\"attribute\">pasv_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">pasv_address</span>=192.168.1.32    #内网的那台改成对应内网的IP地址</span><br><span class=\"line\"><span class=\"attribute\">pasv_min_port</span>=10000</span><br><span class=\"line\"><span class=\"attribute\">pasv_max_port</span>=10088</span><br><span class=\"line\"><span class=\"attribute\">anon_world_readable_only</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">user_config_dir</span>=/etc/vsftpd/user_conf</span><br><span class=\"line\"><span class=\"attribute\">tcp_wrappers</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftp_come_user    #编辑虚拟用户的子配置文件</span></span><br><span class=\"line\"><span class=\"attribute\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attribute\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">anon_umask</span>=022</span><br><span class=\"line\"><span class=\"attribute\">local_root</span>=/opt/ftp/come</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># systemctl start vsftpd    #启动ftp</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"测试ftp\"><a href=\"#测试ftp\" class=\"headerlink\" title=\"测试ftp\"></a>测试ftp</h3><p>1）在外网（<code>192.168.1.32</code>）上访问内网（<code>192.168.1.33</code>）的<code>ftp</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@internet ~]# dd <span class=\"attribute\">if</span>=/dev/zero <span class=\"attribute\">of</span>=testfile <span class=\"attribute\">bs</span>=1M <span class=\"attribute\">count</span>=100    #创建一个测试文件用于测试上传</span><br><span class=\"line\">[root@internet ~]# lftp ftp_come_user:Ftp_come_password@Qaz123@192.168.1.33    #通过lftp工具连接ftp</span><br><span class=\"line\">lftp ftp_come_user@192.168.1.33:~&gt; lcd</span><br><span class=\"line\">lcd 成功, 本地目录=/root</span><br><span class=\"line\">lftp ftp_come_user@192.168.1.33:~&gt; put testfile</span><br><span class=\"line\">104857600 bytes transferred <span class=\"keyword\">in</span> 2 seconds (55.59M/s)</span><br><span class=\"line\">lftp ftp_come_user@192.168.1.33:/&gt; ls</span><br><span class=\"line\">-rw-r--r--    1 1001     1001     104857600 Aug 05 12:41 testfile</span><br></pre></td></tr></table></figure></p>\n<p>2）在内网（<code>192.168.1.33</code>）上访问外网（<code>192.168.1.32</code>）的<code>ftp</code><br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@lan ~]<span class=\"comment\"># dd if=/dev/zero of=testfile1 bs=1M count=100    #同样创建一个测试文件</span></span><br><span class=\"line\">[root@lan ~]<span class=\"comment\"># lftp ftp_come_user:Ftp_come_password<span class=\"doctag\">@Qaz</span>123@192.168.1.32</span></span><br><span class=\"line\">lftp ftp_come_user@192.<span class=\"number\">168.1</span>.<span class=\"number\">32</span><span class=\"symbol\">:~&gt;</span> put testfile1</span><br><span class=\"line\"><span class=\"number\">104857600</span> bytes transferred <span class=\"keyword\">in</span> <span class=\"number\">3</span> seconds (<span class=\"number\">31.87</span>M/s)              </span><br><span class=\"line\">lftp ftp_come_user@192.<span class=\"number\">168.1</span>.<span class=\"number\">32</span><span class=\"symbol\">:/&gt;</span></span><br><span class=\"line\">lftp ftp_come_user@192.<span class=\"number\">168.1</span>.<span class=\"number\">32</span><span class=\"symbol\">:/&gt;</span> ls</span><br><span class=\"line\">-rw-r--r--    <span class=\"number\">1</span> <span class=\"number\">1001</span>     <span class=\"number\">1001</span>     <span class=\"number\">104857600</span> Aug <span class=\"number\">05</span> <span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">45</span> testfile1</span><br></pre></td></tr></table></figure></p>\n<p>3）在内网的<code>/opt/ftp/come</code>目录验证是否存在<code>testfile</code>文件<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@lan ~]<span class=\"comment\"># ll /opt/ftp/come/</span></span><br><span class=\"line\">总用量 102400</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 104857600 </span>8月  <span class=\"number\"> 5 </span>20:41 testfile</span><br></pre></td></tr></table></figure></p>\n<p>4）在外网的<code>/opt/ftp/come</code>目录验证是否存在<code>testfile1</code>文件<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@internet ~]<span class=\"comment\"># ll /opt/ftp/come/</span></span><br><span class=\"line\">总用量 102400</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 104857600 </span>8月  <span class=\"number\"> 5 </span>20:45 testfile1</span><br></pre></td></tr></table></figure></p>\n<p>通过测试<code>ftp</code>已经<code>ok</code></p>\n<h3 id=\"安装配置redis\"><a href=\"#安装配置redis\" class=\"headerlink\" title=\"安装配置redis\"></a>安装配置redis</h3><blockquote>\n<p>生产环境<code>redis</code>可能端口不一样，然后根据不同的进行配置即可。同时设置连接密码，（这里只是测试，所以两边的配置一样）</p>\n</blockquote>\n<figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># yum -y install redis    #安装redis</span><br><span class=\"line\"># cp /etc/redis.conf&#123;,.back&#125;    #拷贝redis配置文件</span><br><span class=\"line\"># vim /etc/redis.conf    #编辑redis配置文件</span><br><span class=\"line\">daemonize yes    #开启后台常驻进程</span><br><span class=\"line\">requirepass obohna7Fogai9ahnahth    #设置redis连接密码</span><br><span class=\"line\"># systemctl start redis    #启动redis</span><br><span class=\"line\"># netstat -nlutp |grep <span class=\"number\">6379</span>    #检查端口是否打开</span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">6379</span>          <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span>:*               LISTEN      <span class=\"number\">7139</span>/redis-server <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"安装php及inotify插件\"><a href=\"#安装php及inotify插件\" class=\"headerlink\" title=\"安装php及inotify插件\"></a>安装php及inotify插件</h3><p>1）<code>yum</code>安装<code>php</code><br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class=\"line\"><span class=\"meta\"># rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm</span></span><br><span class=\"line\"><span class=\"meta\"># yum install --enablerepo=remi,remi-php56 php php-opcache php-pecl-apcu php-devel php-mbstring php-mcrypt php-mysqlnd php-phpunit-PHPUnit php-pecl-xdebug php-pecl-xhprof php-pdo php-pear php-fpm php-cli php-xml php-bcmath php-process php-gd php-common php-memcache php-redis php-pspell  php-fpm  php-mysql php-common php-mssql</span></span><br></pre></td></tr></table></figure></p>\n<p>2）安装<code>php</code>插件<code>inotify</code><br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># wget http://pecl.php.net/get/inotify-0.1.6.tgz    #下载软件包</span></span><br><span class=\"line\"><span class=\"meta\"># tar xf inotify-0.1.6.tgz    #解压软件包</span></span><br><span class=\"line\"><span class=\"meta\"># yum install gcc gcc-c++ make    #安装编译工具</span></span><br><span class=\"line\"><span class=\"meta\"># tar xf inotify-0.1.6.tgz</span></span><br><span class=\"line\"><span class=\"meta\"># cd inotify-0.1.6/</span></span><br><span class=\"line\"><span class=\"meta\"># phpize</span></span><br><span class=\"line\"><span class=\"meta\"># ./configure --with-php-config=/usr/bin/php-config --enable-inotify</span></span><br><span class=\"line\"><span class=\"meta\"># make &amp;&amp; make install</span></span><br><span class=\"line\"><span class=\"meta\"># echo \"extension = inotify.so\" &gt;&gt; /etc/php.d/inotify.ini</span></span><br><span class=\"line\"><span class=\"meta\"># php -i|grep inotify</span></span><br><span class=\"line\"><span class=\"meta\"># systemctl start php-fpm</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"编写PHP脚本\"><a href=\"#编写PHP脚本\" class=\"headerlink\" title=\"编写PHP脚本\"></a>编写PHP脚本</h3><blockquote>\n<p>内外网其实一样，只是配置的连接信息不一样。</p>\n</blockquote>\n<p>1）监听脚本(<code>listen.php</code>)<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@internet ~]<span class=\"comment\"># mkdir /home/script</span></span><br><span class=\"line\">[root@internet ~]<span class=\"comment\"># vim /home/script/listen.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by PhpStorm.</span></span><br><span class=\"line\"><span class=\"comment\"> * User: ADMIN</span></span><br><span class=\"line\"><span class=\"comment\"> * Date: 2019/7/31</span></span><br><span class=\"line\"><span class=\"comment\"> * Time: 19:21</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_HOST'</span>,<span class=\"string\">'127.0.0.1'</span>); <span class=\"comment\">//redis连接主机</span></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_PASSWORD'</span>,<span class=\"string\">'obohna7Fogai9ahnahth'</span>);  <span class=\"comment\">//redis连接密码</span></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_PORT'</span>,<span class=\"string\">'6379'</span>);  <span class=\"comment\">//redis端口</span></span><br><span class=\"line\"></span><br><span class=\"line\">define(<span class=\"string\">'__LISTEN_DIR__'</span>,<span class=\"string\">\"/opt/ftp/out\"</span>);  <span class=\"comment\">//本地监听目录</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Monitor</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $dir = <span class=\"string\">''</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//文件新增事件回调</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $onfileAdd;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> $timeout = <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($dir,$onfileAdd)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!extension_loaded(<span class=\"string\">'inotify'</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">'请安装inotify扩展'</span>, PHP_EOL;</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;dir = $dir;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;onfileAdd = $onfileAdd;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//对目录进行监控</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">run</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $dirs = <span class=\"keyword\">$this</span>-&gt;getDirs(<span class=\"keyword\">$this</span>-&gt;dir);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">empty</span>($dirs)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        $fd = inotify_init();</span><br><span class=\"line\">        <span class=\"comment\">//设置为非阻塞模式</span></span><br><span class=\"line\">        stream_set_blocking($fd, <span class=\"number\">0</span>);</span><br><span class=\"line\">        $watcher = [];</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($dirs <span class=\"keyword\">as</span> $dir) &#123;</span><br><span class=\"line\">            $watch = inotify_add_watch($fd, $dir, IN_MODIFY | IN_CREATE | IN_DELETE | IN_DELETE_SELF | IN_CLOSE_WRITE);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!$watch) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> <span class=\"string\">\"&#123;$dir&#125; 添加监控错误\"</span>, PHP_EOL;</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            $watcher[$watch] = $dir;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">            $reads = [$fd];</span><br><span class=\"line\">            $write = [];</span><br><span class=\"line\">            $except = [];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (stream_select($reads, $write, $except, <span class=\"keyword\">$this</span>-&gt;timeout) &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($reads)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">foreach</span> ($reads <span class=\"keyword\">as</span> $read) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">//从可读流中读取数据</span></span><br><span class=\"line\">                        $events = inotify_read($read);</span><br><span class=\"line\">                        $fileName = <span class=\"string\">''</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">foreach</span> ($events <span class=\"keyword\">as</span> $event) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"comment\">//文件改变</span></span><br><span class=\"line\">                            $fileChg = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                            <span class=\"comment\">//目录改变</span></span><br><span class=\"line\">                            $dirChg = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                            $fileName = $event[<span class=\"string\">'name'</span>];</span><br><span class=\"line\">                            <span class=\"keyword\">switch</span> ($event[<span class=\"string\">'mask'</span>]) &#123;</span><br><span class=\"line\">                                <span class=\"keyword\">case</span> IN_CREATE:     <span class=\"comment\">//创建   IN_CLOSE_WRITE  写入结束</span></span><br><span class=\"line\">                                <span class=\"keyword\">case</span> IN_DELETE:</span><br><span class=\"line\">                                    $fileChg = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                                <span class=\"keyword\">case</span> <span class=\"number\">1073742080</span>:</span><br><span class=\"line\">                                <span class=\"keyword\">case</span> <span class=\"number\">1073742336</span>:</span><br><span class=\"line\">                                    $dirChg = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"keyword\">if</span> ($fileChg) &#123;</span><br><span class=\"line\">                                $filepath = $watcher[$event[<span class=\"string\">'wd'</span>]] . <span class=\"string\">'/'</span> . $fileName;</span><br><span class=\"line\">                                <span class=\"keyword\">if</span>($watcher[$event[<span class=\"string\">'wd'</span>]] == <span class=\"keyword\">$this</span>-&gt;dir)&#123;</span><br><span class=\"line\">                                    $newfile = $fileName;</span><br><span class=\"line\">                                &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                                    $newfile = str_replace(<span class=\"keyword\">$this</span>-&gt;dir,<span class=\"string\">'.'</span>,$filepath);</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                                <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 事件目录：\"</span> . $filepath .  <span class=\"string\">\"，事件出现：&#123;$event['mask']&#125; ，文件/目录 &#123;$fileName&#125; 发生改变\"</span> . PHP_EOL;</span><br><span class=\"line\">                                <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | \"</span> . $newfile . PHP_EOL;</span><br><span class=\"line\"><span class=\"comment\">//                                echo \"文件 &#123;$fileName&#125; 发生改变\", PHP_EOL;</span></span><br><span class=\"line\"><span class=\"comment\">//                            echo shell_exec($this-&gt;cmd), PHP_EOL;</span></span><br><span class=\"line\"><span class=\"comment\">//                                SysutilLogger::instance()-&gt;fileAdd(\"事件目录：\" . $watcher[$event['wd']] . \"，事件出现：&#123;$event['mask']&#125; ，文件/目录 &#123;$fileName&#125; 发生改变\");</span></span><br><span class=\"line\">                                call_user_func_array(<span class=\"keyword\">$this</span>-&gt;onfileAdd,[$filepath,$newfile]);</span><br><span class=\"line\"></span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> ($dirChg) &#123;</span><br><span class=\"line\"><span class=\"comment\">//                                echo \"目录 &#123;$fileName&#125; 发生改变\", PHP_EOL;</span></span><br><span class=\"line\"><span class=\"comment\">//                            echo shell_exec($this-&gt;cmd), PHP_EOL;</span></span><br><span class=\"line\">                                <span class=\"comment\">//目录发生改变时  重新监听</span></span><br><span class=\"line\">                                <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;run();</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//递归的获取当前目录下所有子目录路径</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getDirs</span><span class=\"params\">($dir)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $dir = realpath($dir);</span><br><span class=\"line\">        $dh = opendir($dir);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!$dh) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> [];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        $dirs = [];</span><br><span class=\"line\">        $dirs[] = $dir;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (($file = readdir($dh)) !== <span class=\"keyword\">false</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ($file == <span class=\"string\">'.'</span> || $file == <span class=\"string\">'..'</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            $full = $dir . DIRECTORY_SEPARATOR . $file;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (is_dir($full)) &#123;</span><br><span class=\"line\">                $dirs = array_merge($dirs, <span class=\"keyword\">$this</span>-&gt;getDirs($full));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        closedir($dh);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $dirs;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SysutilRedis</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_instance;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $m_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $mid_redis = <span class=\"keyword\">null</span>;      <span class=\"comment\">//律师中心redis实例</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> SysutilRedis|Redis</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">instance</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( ! <span class=\"keyword\">isset</span>(SysutilRedis::$_instance))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            SysutilRedis::$_instance = <span class=\"keyword\">new</span> SysutilRedis();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> SysutilRedis::$_instance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> null|Redis</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getRedis</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( !<span class=\"keyword\">$this</span>-&gt;m_redis )&#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis = <span class=\"keyword\">new</span> Redis();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;connect(REDIS_HOST,REDIS_PORT,<span class=\"number\">10</span>); <span class=\"comment\">//php客户端设置的ip及端口</span></span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;auth(REDIS_PASSWORD);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;m_redis;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">close_redis</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;m_redis) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;close();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;mid_redis) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;mid_redis-&gt;close();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;mid_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;close_redis();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Listenner</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">run</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        $callBack = [<span class=\"keyword\">$this</span>,<span class=\"string\">\"toRedis\"</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">        $listen_dir = __LISTEN_DIR__;</span><br><span class=\"line\"></span><br><span class=\"line\">        $monitor = <span class=\"keyword\">new</span> Monitor($listen_dir,$callBack);</span><br><span class=\"line\"></span><br><span class=\"line\">        $monitor-&gt;run();</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@describe</span> 文件回调</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> zhouyong</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">toRedis</span><span class=\"params\">($filename,$newfile)</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        $redis = SysutilRedis::instance()-&gt;getRedis();</span><br><span class=\"line\">        $redis-&gt;select(<span class=\"number\">9</span>);</span><br><span class=\"line\">        $cache_id = <span class=\"string\">'upload_file_list'</span>;</span><br><span class=\"line\">        $data = [</span><br><span class=\"line\">            <span class=\"string\">'local'</span> =&gt; $filename,</span><br><span class=\"line\">            <span class=\"string\">'remote'</span> =&gt; $newfile</span><br><span class=\"line\">        ];</span><br><span class=\"line\">        $redis-&gt;rpush($cache_id, json_encode($data));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$listenner = <span class=\"keyword\">new</span> Listenner();</span><br><span class=\"line\"></span><br><span class=\"line\">$listenner-&gt;run();</span><br></pre></td></tr></table></figure></p>\n<p>2）上传文件脚本(<code>upFile.php</code>)<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@internet ~]<span class=\"comment\"># vim /home/script/upFile.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by PhpStorm.</span></span><br><span class=\"line\"><span class=\"comment\"> * User: ADMIN</span></span><br><span class=\"line\"><span class=\"comment\"> * Date: 2019/7/31</span></span><br><span class=\"line\"><span class=\"comment\"> * Time: 19:21</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_HOST'</span>,<span class=\"string\">'127.0.0.1'</span>); <span class=\"comment\">//redis连接主机</span></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_PASSWORD'</span>,<span class=\"string\">'obohna7Fogai9ahnahth'</span>);  <span class=\"comment\">//redis连接密码</span></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_PORT'</span>,<span class=\"string\">'6379'</span>);  <span class=\"comment\">//redis端口</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">define(<span class=\"string\">'FTP_HOST'</span>,<span class=\"string\">'192.168.1.33'</span>);  <span class=\"comment\">//内网ftp服务器</span></span><br><span class=\"line\">define(<span class=\"string\">'FTP_PORT'</span>,<span class=\"number\">21</span>); <span class=\"comment\">//ftp端口</span></span><br><span class=\"line\">define(<span class=\"string\">'FTP_USER'</span>,<span class=\"string\">'ftp_come_user'</span>);  <span class=\"comment\">//ftp连接账号</span></span><br><span class=\"line\">define(<span class=\"string\">'FTP_PASS'</span>,<span class=\"string\">'Ftp_come_password@Qaz123'</span>);  <span class=\"comment\">//ftp连接密码</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SysutilFtp</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $instance;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> $off; <span class=\"comment\">// 返回操作状态(成功/失败)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> $conn_id; <span class=\"comment\">// FTP连接</span></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：FTP连接</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@FTP</span>_HOST -- FTP主机</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@FTP</span>_PORT -- 端口</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@FTP</span>_USER -- 用户名</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@FTP</span>_PASS -- 密码</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($FTP_HOST,$FTP_PORT,$FTP_USER,$FTP_PASS)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;conn_id = @ftp_connect($FTP_HOST,$FTP_PORT) <span class=\"keyword\">or</span> <span class=\"keyword\">die</span>(<span class=\"string\">\"FTP服务器连接失败\"</span>);</span><br><span class=\"line\">        @ftp_login(<span class=\"keyword\">$this</span>-&gt;conn_id,$FTP_USER,$FTP_PASS) <span class=\"keyword\">or</span> <span class=\"keyword\">die</span>(<span class=\"string\">\"FTP服务器登陆失败\"</span>);</span><br><span class=\"line\">        @ftp_pasv(<span class=\"keyword\">$this</span>-&gt;conn_id,<span class=\"number\">1</span>); <span class=\"comment\">// 打开被动模拟</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@describe</span> 获取ftp实例</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getInstance</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"keyword\">self</span>::$instance)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">self</span>::$instance = <span class=\"keyword\">new</span> <span class=\"keyword\">self</span>(FTP_HOST,FTP_PORT,FTP_USER,FTP_PASS);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(<span class=\"keyword\">self</span>::$instance)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | connected !\"</span> . PHP_EOL;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>::$instance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@describe</span> 重连</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> zhouyong</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">reConnect</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | closing connection ......\"</span> . PHP_EOL;</span><br><span class=\"line\">        <span class=\"comment\">//关闭当前链接</span></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;close();</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | reconnecting....\"</span> . PHP_EOL;</span><br><span class=\"line\">        <span class=\"comment\">//开辟新连接</span></span><br><span class=\"line\">        <span class=\"keyword\">self</span>::$instance = <span class=\"keyword\">new</span> <span class=\"keyword\">self</span>(FTP_HOST,FTP_PORT,FTP_USER,FTP_PASS);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | connected !\"</span> . PHP_EOL;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：上传文件</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@path</span> -- 本地路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@newpath</span> -- 上传路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@type</span> -- 若目标目录不存在则新建</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> true</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">up_file</span><span class=\"params\">($path,$newpath,$type=true)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($type) <span class=\"keyword\">$this</span>-&gt;dir_mkdirs($newpath);</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 当前目录\"</span> . ftp_pwd(<span class=\"keyword\">$this</span>-&gt;conn_id) . PHP_EOL;</span><br><span class=\"line\">        $newpath = ltrim($newpath,<span class=\"string\">'.'</span>);</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> $newpath . PHP_EOL;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;off = @ftp_put(<span class=\"keyword\">$this</span>-&gt;conn_id,$newpath,$path,FTP_BINARY);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"keyword\">$this</span>-&gt;off)&#123;</span><br><span class=\"line\"><span class=\"comment\">//            echo \"文件上传失败，请检查权限及路径是否正确！\";</span></span><br><span class=\"line\"><span class=\"comment\">//            echo \"文件上传失败，正在发起重连.....\";</span></span><br><span class=\"line\"><span class=\"comment\">//            $this-&gt;reConnect();</span></span><br><span class=\"line\"><span class=\"comment\">//            echo date('Y-m-d H:i:s') . \" | re-uploading file &#123;$path&#125; to &#123;$newpath&#125; ....\" . PHP_EOL;</span></span><br><span class=\"line\"><span class=\"comment\">//            $this-&gt;up_file($path,$newpath,$type=true);</span></span><br><span class=\"line\">            <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 上传失败\"</span> . PHP_EOL;</span><br><span class=\"line\"><span class=\"comment\">//            exit;</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | upload success !\"</span> . PHP_EOL;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：移动文件</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@path</span> -- 原路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@newpath</span> -- 新路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@type</span> -- 若目标目录不存在则新建</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">move_file</span><span class=\"params\">($path,$newpath,$type=true)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($type) <span class=\"keyword\">$this</span>-&gt;dir_mkdirs($newpath);</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;off = @ftp_rename(<span class=\"keyword\">$this</span>-&gt;conn_id,$path,$newpath);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"keyword\">$this</span>-&gt;off) <span class=\"keyword\">echo</span> <span class=\"string\">\"文件移动失败，请检查权限及原路径是否正确！\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：复制文件</span></span><br><span class=\"line\"><span class=\"comment\">     * 说明：由于FTP无复制命令,本方法变通操作为：下载后再上传到新的路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@path</span> -- 原路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@newpath</span> -- 新路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@type</span> -- 若目标目录不存在则新建</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">copy_file</span><span class=\"params\">($path,$newpath,$type=true)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $downpath = <span class=\"string\">\"c:/tmp.dat\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;off = @ftp_get(<span class=\"keyword\">$this</span>-&gt;conn_id,$downpath,$path,FTP_BINARY);<span class=\"comment\">// 下载</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"keyword\">$this</span>-&gt;off) <span class=\"keyword\">echo</span> <span class=\"string\">\"文件复制失败，请检查权限及原路径是否正确！\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;up_file($downpath,$newpath,$type);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：删除文件</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@path</span> -- 路径</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">del_file</span><span class=\"params\">($path)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;off = @ftp_delete(<span class=\"keyword\">$this</span>-&gt;conn_id,$path);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"keyword\">$this</span>-&gt;off) <span class=\"keyword\">echo</span> <span class=\"string\">\"文件删除失败，请检查权限及路径是否正确！\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：生成目录</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@path</span> -- 路径</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">dir_mkdirs</span><span class=\"params\">($path)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $path_arr = explode(<span class=\"string\">'/'</span>,$path); <span class=\"comment\">// 取目录数组</span></span><br><span class=\"line\">        $file_name = array_pop($path_arr); <span class=\"comment\">// 弹出文件名</span></span><br><span class=\"line\">        $path_div = count($path_arr); <span class=\"comment\">// 取层数</span></span><br><span class=\"line\">        print_r($path_arr);</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span>($path_arr <span class=\"keyword\">as</span> $val) <span class=\"comment\">// 创建目录</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(@ftp_chdir(<span class=\"keyword\">$this</span>-&gt;conn_id,$val) == <span class=\"keyword\">FALSE</span>)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                $tmp = @ftp_mkdir(<span class=\"keyword\">$this</span>-&gt;conn_id,$val);</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 创建目录&#123;$val&#125;\"</span> . PHP_EOL;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>($tmp == <span class=\"keyword\">FALSE</span>)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 目录创建失败，请检查权限及路径是否正确！\"</span> . PHP_EOL;</span><br><span class=\"line\">                    <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                @ftp_chdir(<span class=\"keyword\">$this</span>-&gt;conn_id,$val);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 创建目录成功\"</span> . PHP_EOL;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 当前目录\"</span> . ftp_pwd(<span class=\"keyword\">$this</span>-&gt;conn_id) . PHP_EOL;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>($i=<span class=\"number\">1</span>;$i&lt;$path_div;$i++) <span class=\"comment\">// 回退到根</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            @ftp_cdup(<span class=\"keyword\">$this</span>-&gt;conn_id);</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 当前目录\"</span> . ftp_pwd(<span class=\"keyword\">$this</span>-&gt;conn_id) . PHP_EOL;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ping</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">\"Y-m-d H:i:s\"</span>) . <span class=\"string\">\" |  发送心跳数据 \"</span> . PHP_EOL;</span><br><span class=\"line\">        @ftp_raw(<span class=\"keyword\">$this</span>-&gt;conn_id,<span class=\"string\">'pingpong'</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：关闭FTP连接</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">close</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        @ftp_close(<span class=\"keyword\">$this</span>-&gt;conn_id);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"comment\">// class class_ftp end</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SysutilRedis</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_instance;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $m_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $mid_redis = <span class=\"keyword\">null</span>;      <span class=\"comment\">//律师中心redis实例</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> SysutilRedis</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">instance</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( ! <span class=\"keyword\">isset</span>(SysutilRedis::$_instance))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            SysutilRedis::$_instance = <span class=\"keyword\">new</span> SysutilRedis();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> SysutilRedis::$_instance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> null|Redis</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getRedis</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( !<span class=\"keyword\">$this</span>-&gt;m_redis )&#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis = <span class=\"keyword\">new</span> Redis();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;connect(REDIS_HOST,REDIS_PORT,<span class=\"number\">10</span>); <span class=\"comment\">//php客户端设置的ip及端口</span></span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;auth(REDIS_PASSWORD);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;m_redis;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">close_redis</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;m_redis) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;close();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;mid_redis) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;mid_redis-&gt;close();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;mid_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;close_redis();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$redis = SysutilRedis::instance()-&gt;getRedis();</span><br><span class=\"line\">$redis-&gt;select(<span class=\"number\">9</span>);</span><br><span class=\"line\">$cache_id = <span class=\"string\">'upload_file_list'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$no_data_time = <span class=\"number\">0</span>;</span><br><span class=\"line\">$ping = <span class=\"number\">3</span>;      <span class=\"comment\">//心跳时间   每 x 秒发送一次心跳数据</span></span><br><span class=\"line\"><span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    $data = $redis-&gt;lRange($cache_id, <span class=\"number\">0</span>, <span class=\"number\">-1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($data)) &#123;</span><br><span class=\"line\">        $no_data_time = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($data <span class=\"keyword\">as</span> $key =&gt; $value) &#123;</span><br><span class=\"line\">            $v = json_decode($value, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">            $result = up_file($v[<span class=\"string\">'local'</span>],$v[<span class=\"string\">'remote'</span>]);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>($result)&#123;</span><br><span class=\"line\">                $redis-&gt;select(<span class=\"number\">9</span>);</span><br><span class=\"line\">                $redis-&gt;lPop($cache_id);</span><br><span class=\"line\">            &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> date(<span class=\"string\">\"Y-m-d H:i:s\"</span>) . <span class=\"string\">\"| 退出脚本\"</span>;</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($no_data_time &gt; <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">            <span class=\"comment\">//查看没有事件的时间</span></span><br><span class=\"line\">            $time = time();</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(($time - $no_data_time) &gt; $ping)&#123;</span><br><span class=\"line\">                <span class=\"comment\">//发送心跳  并重置时间</span></span><br><span class=\"line\">                ping_ftp();</span><br><span class=\"line\">                $no_data_time = $time;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            $no_data_time = time();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">up_file</span><span class=\"params\">($filename,$newfile)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | $filename ,  $newfile\"</span> . PHP_EOL;</span><br><span class=\"line\">    $ftp = SysutilFtp::getInstance();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $ftp-&gt;up_file($filename,$newfile);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ping_ftp</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    $ftp = SysutilFtp::getInstance();</span><br><span class=\"line\">    $ftp-&gt;ping();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）启动脚本并测试<br><figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#在一个终端启动listen.php脚本</span><br><span class=\"line\">[root@internet ~]# php -f /home/script/listen.php</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#在另外一个终端启动upFile.php脚本</span><br><span class=\"line\">[root@internet ~]# php -f /home/script/upFile.php </span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:24:11 | connected !</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:24:11 |  发送心跳数据</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#在第三个终端往监听目录/opt/ftp/out目录新建一个文件或目录进行测试</span><br><span class=\"line\">[root@internet ~]# echo \"test\" &gt;&gt; /opt/ftp/out/file1</span><br><span class=\"line\"></span><br><span class=\"line\">#分别可以在上面第一个终端和第二个终端看到日志信息</span><br><span class=\"line\">终端一的信息：</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | 事件目录：/opt/ftp/out/file1，事件出现：256 ，文件/目录 file1 发生改变</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | file1</span><br><span class=\"line\"></span><br><span class=\"line\">终端二的信息：</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | /opt/ftp/out/file1 ,  file1</span><br><span class=\"line\">Array</span><br><span class=\"line\">(</span><br><span class=\"line\">)</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | 创建目录成功</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | 当前目录/</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | 当前目录/</span><br><span class=\"line\">file1</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | upload success !</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"管理两个脚本\"><a href=\"#管理两个脚本\" class=\"headerlink\" title=\"管理两个脚本\"></a>管理两个脚本</h3><p>1）编写监控脚本，当进程挂掉便重启<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /home/script/process_alive.sh</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#用来监听listen脚本和upFile脚本</span></span><br><span class=\"line\"></span><br><span class=\"line\">DATE=[`date <span class=\"string\">\"+%Y-%m-%d %H:%M:%S\"</span>`]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> phpScriptAlive &#123;</span><br><span class=\"line\">    script_dir=/home/script/</span><br><span class=\"line\">    ps aux |grep -v grep |grep <span class=\"variable\">$1</span> &gt;&gt; /dev/null</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ $? != 0 ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        nohup php -f <span class=\"variable\">$&#123;script_dir&#125;</span>/<span class=\"variable\">$1</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"variable\">$2</span> &amp;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;DATE&#125;</span> 重启php脚本 <span class=\"variable\">$1</span>\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/php_script_restart.log</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">phpScriptAlive listen.php php_listen.log</span><br><span class=\"line\">phpScriptAlive upFile.php php_upfile.log</span><br></pre></td></tr></table></figure></p>\n<p>2）添加到计划任务<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># chmod +x /home/script/process_alive.sh </span></span><br><span class=\"line\"><span class=\"section\"># 监听php脚本进程</span></span><br><span class=\"line\"><span class=\"bullet\">* </span><span class=\"bullet\">* *</span> <span class=\"bullet\">* *</span> /bin/bash /home/script/process_alive.sh</span><br></pre></td></tr></table></figure></p>\n<p>3）查看日志；由于上面脚本里面写了将所有输出都记录到日志里面，所以后续直接查看日志即可<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@internet ~]</span># <span class=\"selector-tag\">tailf</span> /<span class=\"selector-tag\">var</span>/<span class=\"selector-tag\">log</span>/<span class=\"selector-tag\">php</span></span><br><span class=\"line\"><span class=\"selector-tag\">php-fpm</span>/                <span class=\"selector-tag\">php_listen</span><span class=\"selector-class\">.log</span>          <span class=\"selector-tag\">php_script_restart</span><span class=\"selector-class\">.log</span>  <span class=\"selector-tag\">php_upfile</span><span class=\"selector-class\">.log</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@internet ~]</span># <span class=\"selector-tag\">tailf</span> /<span class=\"selector-tag\">var</span>/<span class=\"selector-tag\">log</span>/<span class=\"selector-tag\">php_listen</span><span class=\"selector-class\">.log</span> </span><br><span class=\"line\">^<span class=\"selector-tag\">C</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@internet ~]</span># <span class=\"selector-tag\">tailf</span> /<span class=\"selector-tag\">var</span>/<span class=\"selector-tag\">log</span>/<span class=\"selector-tag\">php_upfile</span><span class=\"selector-class\">.log</span> </span><br><span class=\"line\"><span class=\"selector-tag\">2019-08-06</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:01</span><span class=\"selector-pseudo\">:18</span> |  发送心跳数据 </span><br><span class=\"line\"><span class=\"selector-tag\">2019-08-06</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:01</span><span class=\"selector-pseudo\">:22</span> |  发送心跳数据 </span><br><span class=\"line\"><span class=\"selector-tag\">2019-08-06</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:01</span><span class=\"selector-pseudo\">:26</span> |  发送心跳数据 </span><br><span class=\"line\"><span class=\"selector-tag\">2019-08-06</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:01</span><span class=\"selector-pseudo\">:30</span> |  发送心跳数据</span><br></pre></td></tr></table></figure></p>\n<p>4）再次往<code>/opt/ftp/out/</code>目录丢文件，便会自动同步到内网或者外网的<code>/opt/ftp/come</code>目录。<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@internet ~]<span class=\"comment\"># echo \"sjdklf\" &gt;&gt; /opt/ftp/out/file111</span></span><br><span class=\"line\">[root@internet ~]<span class=\"comment\"># for i in `seq 10`; do echo \"sjdlfjskldjf\" &gt;&gt; /opt/ftp/out/txt$i ; don</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#内网查看</span></span><br><span class=\"line\">[root@lan ~]<span class=\"comment\"># ll /opt/ftp/come/</span></span><br><span class=\"line\">总用量 48</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache <span class=\"number\"> 5 </span>8月  <span class=\"number\"> 6 </span>11:36 file1</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache <span class=\"number\"> 7 </span>8月  <span class=\"number\"> 6 </span>12:06 file111</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt1</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt10</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt2</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt3</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt4</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt5</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt6</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt7</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt8</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt9</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"PHP配合inotify实现光闸ftp功能\"><a href=\"#PHP配合inotify实现光闸ftp功能\" class=\"headerlink\" title=\"PHP配合inotify实现光闸ftp功能\"></a>PHP配合inotify实现光闸ftp功能</h2><h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><blockquote>\n<p>由于业务需要，内外网的数据需要进行实时交互同步，由于环境因素，只能通过<code>ftp</code>进行文件的交互传输。且没有硬件设备（光闸）；鉴于这种情况下，首先考虑到的是通过<code>shell</code>脚本进行自动上传下载文件。然而在实施部署过程中发现，通过<code>shell</code>脚本方式进行文件的上传下载每一个文件都会建立一次连接。（由于环境因素，ftp通过网闸再通过<code>vpn</code>建立一次连接巨慢，大概需要几十秒。）可是项目站点必须是实时进行文件的传输，且每次可能是多个文件，多者甚至上百个。经过探讨考虑到使用<code>rsync+inotify</code>，通过rsync的守护进程模式进行文件的传输。可是这种项目迟早得换成光闸走<code>ftp</code>进行文件的传输。而后又考虑直接在代码里面实现建立<code>ftp</code>的长连接进行文件传输（建立一次连接，然后一直处于监听模式，发现有文件就及时进行传送）,这样一来又考虑到目录的监听情况，开始准备使用<code>inotify-tools</code>进行监听然后调用<code>php</code>代码里面的<code>ftp</code>长连接进程，随后又在<code>php</code>官方发现<code>php</code>也有一个<code>inotify</code>可以用来进行目录的监听，然后触发动作。<br>于是，最终方案就是在内外网两台服务器上面搭建<code>ftp</code>服务，然后通过<code>php</code>脚本进行目录的监听并上传到<code>ftp</code>服务器。</p>\n</blockquote>\n<blockquote>\n<p>具体实现流程说明<br>1、内外网的服务器均安装<code>ftp</code>。<br>2、内外网的服务器均安装<code>php</code>及<code>php</code>的<code>inotify</code>插件。<br>3、内外网的服务器均安装<code>redis</code>。（<code>php</code>分为两个文件，一个为文件(<code>listen.php</code>)用于监听，一个文件(<code>upFile.php</code>)用于上传文件，由于开始没有存入<code>redis</code>，导致文件堆积，然后一直阻塞。故最终方案通过监听文件将监听到发生变化的文件路径存入到<code>redis</code>里，然后通过<code>upfile</code>脚本将文件上传到<code>ftp</code>）</p>\n</blockquote>\n<h3 id=\"环境说明\"><a href=\"#环境说明\" class=\"headerlink\" title=\"环境说明\"></a>环境说明</h3><table>\n<thead>\n<tr>\n<th style=\"text-align:center\">IP</th>\n<th style=\"text-align:center\">主机名</th>\n<th style=\"text-align:center\">系统版本</th>\n<th style=\"text-align:center\">网络说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">192.168.1.32</td>\n<td style=\"text-align:center\">internet.example.com</td>\n<td style=\"text-align:center\">CenTOS7.4</td>\n<td style=\"text-align:center\">模拟外网</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.33</td>\n<td style=\"text-align:center\">lan.example.com</td>\n<td style=\"text-align:center\">CenTOS7.4</td>\n<td style=\"text-align:center\">模拟内网</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>1、这里是通过两台虚拟机进行模拟内外网。且上面真实项目操作系统为<code>CenTOS6.5</code>；这里使用<code>CenTOS7.5</code>模拟。<br>2、两台服务器需要安装软件有：<code>vsftpd</code>、<code>php</code>、<code>php</code>插件<code>inotify</code><br>3、外网的<code>/opt/ftp/out</code>目录只要有新的文件产生就会自动触发监听然后传送至内网的<code>/opt/ftp/come</code>目录。<br>4、反之一样，内网的<code>/opt/ftp/out</code>目录只要有新的文件产生就会自动触发监听然后传送至外网的<code>/opt/ftp/come</code>目录。</p>\n</blockquote>\n<h3 id=\"项目结构图\"><a href=\"#项目结构图\" class=\"headerlink\" title=\"项目结构图\"></a>项目结构图</h3><p><img src=\"/2019/08/06/PHP配合inotify实现光闸ftp功能/01.png\" alt=\"image.png\"></p>\n<h2 id=\"具体实验步骤\"><a href=\"#具体实验步骤\" class=\"headerlink\" title=\"具体实验步骤\"></a>具体实验步骤</h2><h3 id=\"安装配置vsftpd\"><a href=\"#安装配置vsftpd\" class=\"headerlink\" title=\"安装配置vsftpd\"></a>安装配置vsftpd</h3><blockquote>\n<p>说明：内外网都需要配置<code>vsftpd</code>，配置<code>vsftpd</code>虚拟用户可参考 <a href=\"https://www.cnblogs.com/yanjieli/p/10723108.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/yanjieli/p/10723108.html</a></p>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># mkdir -p /opt/ftp/&#123;come,out&#125;    #创建对应的数据目录</span></span><br><span class=\"line\"><span class=\"comment\"># yum -y install vsftpd    #安装vsftpd</span></span><br><span class=\"line\"><span class=\"comment\"># useradd -s /sbin/nologin apache    #由于项目站点所使用的apache用户，所以这里为了防止权限问题，这里也是用apache用户作为虚拟用户</span></span><br><span class=\"line\"><span class=\"comment\"># chown apache.apache /opt/ftp/ -R    #将数据目录权限改为apache用户</span></span><br><span class=\"line\"><span class=\"comment\"># cat &gt;/etc/vsftpd/logins.txt&lt;&lt;-EOF    #创建ftp虚拟账号和密码，一行账号一行密码</span></span><br><span class=\"line\">ftp_come_user</span><br><span class=\"line\">Ftp_come_password@Qaz123</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># db_load -T -t hash -f /etc/vsftpd/logins.txt /etc/vsftpd/login.db    #将密码文件转换成db格式</span></span><br><span class=\"line\"><span class=\"comment\"># chmod 600 /etc/vsftpd/login.db    #更改db文件的权限</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat &gt;/etc/pam.d/ftp&lt;&lt;-EOF    #定义pam认证文件</span></span><br><span class=\"line\">auth  required  /lib64/security/pam_userdb.so  <span class=\"attribute\">db</span>=/etc/vsftpd/login</span><br><span class=\"line\">account  required  /lib64/security/pam_userdb.so  <span class=\"attribute\">db</span>=/etc/vsftpd/login</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cp /etc/vsftpd/vsftpd.conf&#123;,.back&#125;    #备份配置文件</span></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/vsftpd.conf    #编辑vsftpd主配置文件</span></span><br><span class=\"line\"><span class=\"attribute\">anonymous_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">local_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">anon_upload_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">anon_mkdir_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">anon_other_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">chroot_local_user</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">allow_writeable_chroot</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">guest_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">guest_username</span>=apache</span><br><span class=\"line\"><span class=\"attribute\">listen</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">listen_port</span>=21</span><br><span class=\"line\"><span class=\"attribute\">pasv_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">pasv_address</span>=192.168.1.32    #内网的那台改成对应内网的IP地址</span><br><span class=\"line\"><span class=\"attribute\">pasv_min_port</span>=10000</span><br><span class=\"line\"><span class=\"attribute\">pasv_max_port</span>=10088</span><br><span class=\"line\"><span class=\"attribute\">anon_world_readable_only</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"attribute\">user_config_dir</span>=/etc/vsftpd/user_conf</span><br><span class=\"line\"><span class=\"attribute\">tcp_wrappers</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftp_come_user    #编辑虚拟用户的子配置文件</span></span><br><span class=\"line\"><span class=\"attribute\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attribute\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attribute\">anon_umask</span>=022</span><br><span class=\"line\"><span class=\"attribute\">local_root</span>=/opt/ftp/come</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># systemctl start vsftpd    #启动ftp</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"测试ftp\"><a href=\"#测试ftp\" class=\"headerlink\" title=\"测试ftp\"></a>测试ftp</h3><p>1）在外网（<code>192.168.1.32</code>）上访问内网（<code>192.168.1.33</code>）的<code>ftp</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@internet ~]# dd <span class=\"attribute\">if</span>=/dev/zero <span class=\"attribute\">of</span>=testfile <span class=\"attribute\">bs</span>=1M <span class=\"attribute\">count</span>=100    #创建一个测试文件用于测试上传</span><br><span class=\"line\">[root@internet ~]# lftp ftp_come_user:Ftp_come_password@Qaz123@192.168.1.33    #通过lftp工具连接ftp</span><br><span class=\"line\">lftp ftp_come_user@192.168.1.33:~&gt; lcd</span><br><span class=\"line\">lcd 成功, 本地目录=/root</span><br><span class=\"line\">lftp ftp_come_user@192.168.1.33:~&gt; put testfile</span><br><span class=\"line\">104857600 bytes transferred <span class=\"keyword\">in</span> 2 seconds (55.59M/s)</span><br><span class=\"line\">lftp ftp_come_user@192.168.1.33:/&gt; ls</span><br><span class=\"line\">-rw-r--r--    1 1001     1001     104857600 Aug 05 12:41 testfile</span><br></pre></td></tr></table></figure></p>\n<p>2）在内网（<code>192.168.1.33</code>）上访问外网（<code>192.168.1.32</code>）的<code>ftp</code><br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@lan ~]<span class=\"comment\"># dd if=/dev/zero of=testfile1 bs=1M count=100    #同样创建一个测试文件</span></span><br><span class=\"line\">[root@lan ~]<span class=\"comment\"># lftp ftp_come_user:Ftp_come_password<span class=\"doctag\">@Qaz</span>123@192.168.1.32</span></span><br><span class=\"line\">lftp ftp_come_user@192.<span class=\"number\">168.1</span>.<span class=\"number\">32</span><span class=\"symbol\">:~&gt;</span> put testfile1</span><br><span class=\"line\"><span class=\"number\">104857600</span> bytes transferred <span class=\"keyword\">in</span> <span class=\"number\">3</span> seconds (<span class=\"number\">31.87</span>M/s)              </span><br><span class=\"line\">lftp ftp_come_user@192.<span class=\"number\">168.1</span>.<span class=\"number\">32</span><span class=\"symbol\">:/&gt;</span></span><br><span class=\"line\">lftp ftp_come_user@192.<span class=\"number\">168.1</span>.<span class=\"number\">32</span><span class=\"symbol\">:/&gt;</span> ls</span><br><span class=\"line\">-rw-r--r--    <span class=\"number\">1</span> <span class=\"number\">1001</span>     <span class=\"number\">1001</span>     <span class=\"number\">104857600</span> Aug <span class=\"number\">05</span> <span class=\"number\">12</span><span class=\"symbol\">:</span><span class=\"number\">45</span> testfile1</span><br></pre></td></tr></table></figure></p>\n<p>3）在内网的<code>/opt/ftp/come</code>目录验证是否存在<code>testfile</code>文件<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@lan ~]<span class=\"comment\"># ll /opt/ftp/come/</span></span><br><span class=\"line\">总用量 102400</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 104857600 </span>8月  <span class=\"number\"> 5 </span>20:41 testfile</span><br></pre></td></tr></table></figure></p>\n<p>4）在外网的<code>/opt/ftp/come</code>目录验证是否存在<code>testfile1</code>文件<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@internet ~]<span class=\"comment\"># ll /opt/ftp/come/</span></span><br><span class=\"line\">总用量 102400</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 104857600 </span>8月  <span class=\"number\"> 5 </span>20:45 testfile1</span><br></pre></td></tr></table></figure></p>\n<p>通过测试<code>ftp</code>已经<code>ok</code></p>\n<h3 id=\"安装配置redis\"><a href=\"#安装配置redis\" class=\"headerlink\" title=\"安装配置redis\"></a>安装配置redis</h3><blockquote>\n<p>生产环境<code>redis</code>可能端口不一样，然后根据不同的进行配置即可。同时设置连接密码，（这里只是测试，所以两边的配置一样）</p>\n</blockquote>\n<figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># yum -y install redis    #安装redis</span><br><span class=\"line\"># cp /etc/redis.conf&#123;,.back&#125;    #拷贝redis配置文件</span><br><span class=\"line\"># vim /etc/redis.conf    #编辑redis配置文件</span><br><span class=\"line\">daemonize yes    #开启后台常驻进程</span><br><span class=\"line\">requirepass obohna7Fogai9ahnahth    #设置redis连接密码</span><br><span class=\"line\"># systemctl start redis    #启动redis</span><br><span class=\"line\"># netstat -nlutp |grep <span class=\"number\">6379</span>    #检查端口是否打开</span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">6379</span>          <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span>:*               LISTEN      <span class=\"number\">7139</span>/redis-server <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"安装php及inotify插件\"><a href=\"#安装php及inotify插件\" class=\"headerlink\" title=\"安装php及inotify插件\"></a>安装php及inotify插件</h3><p>1）<code>yum</code>安装<code>php</code><br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class=\"line\"><span class=\"meta\"># rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm</span></span><br><span class=\"line\"><span class=\"meta\"># yum install --enablerepo=remi,remi-php56 php php-opcache php-pecl-apcu php-devel php-mbstring php-mcrypt php-mysqlnd php-phpunit-PHPUnit php-pecl-xdebug php-pecl-xhprof php-pdo php-pear php-fpm php-cli php-xml php-bcmath php-process php-gd php-common php-memcache php-redis php-pspell  php-fpm  php-mysql php-common php-mssql</span></span><br></pre></td></tr></table></figure></p>\n<p>2）安装<code>php</code>插件<code>inotify</code><br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># wget http://pecl.php.net/get/inotify-0.1.6.tgz    #下载软件包</span></span><br><span class=\"line\"><span class=\"meta\"># tar xf inotify-0.1.6.tgz    #解压软件包</span></span><br><span class=\"line\"><span class=\"meta\"># yum install gcc gcc-c++ make    #安装编译工具</span></span><br><span class=\"line\"><span class=\"meta\"># tar xf inotify-0.1.6.tgz</span></span><br><span class=\"line\"><span class=\"meta\"># cd inotify-0.1.6/</span></span><br><span class=\"line\"><span class=\"meta\"># phpize</span></span><br><span class=\"line\"><span class=\"meta\"># ./configure --with-php-config=/usr/bin/php-config --enable-inotify</span></span><br><span class=\"line\"><span class=\"meta\"># make &amp;&amp; make install</span></span><br><span class=\"line\"><span class=\"meta\"># echo \"extension = inotify.so\" &gt;&gt; /etc/php.d/inotify.ini</span></span><br><span class=\"line\"><span class=\"meta\"># php -i|grep inotify</span></span><br><span class=\"line\"><span class=\"meta\"># systemctl start php-fpm</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"编写PHP脚本\"><a href=\"#编写PHP脚本\" class=\"headerlink\" title=\"编写PHP脚本\"></a>编写PHP脚本</h3><blockquote>\n<p>内外网其实一样，只是配置的连接信息不一样。</p>\n</blockquote>\n<p>1）监听脚本(<code>listen.php</code>)<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@internet ~]<span class=\"comment\"># mkdir /home/script</span></span><br><span class=\"line\">[root@internet ~]<span class=\"comment\"># vim /home/script/listen.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by PhpStorm.</span></span><br><span class=\"line\"><span class=\"comment\"> * User: ADMIN</span></span><br><span class=\"line\"><span class=\"comment\"> * Date: 2019/7/31</span></span><br><span class=\"line\"><span class=\"comment\"> * Time: 19:21</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_HOST'</span>,<span class=\"string\">'127.0.0.1'</span>); <span class=\"comment\">//redis连接主机</span></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_PASSWORD'</span>,<span class=\"string\">'obohna7Fogai9ahnahth'</span>);  <span class=\"comment\">//redis连接密码</span></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_PORT'</span>,<span class=\"string\">'6379'</span>);  <span class=\"comment\">//redis端口</span></span><br><span class=\"line\"></span><br><span class=\"line\">define(<span class=\"string\">'__LISTEN_DIR__'</span>,<span class=\"string\">\"/opt/ftp/out\"</span>);  <span class=\"comment\">//本地监听目录</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Monitor</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $dir = <span class=\"string\">''</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//文件新增事件回调</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $onfileAdd;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> $timeout = <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($dir,$onfileAdd)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!extension_loaded(<span class=\"string\">'inotify'</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">'请安装inotify扩展'</span>, PHP_EOL;</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;dir = $dir;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;onfileAdd = $onfileAdd;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//对目录进行监控</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">run</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $dirs = <span class=\"keyword\">$this</span>-&gt;getDirs(<span class=\"keyword\">$this</span>-&gt;dir);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">empty</span>($dirs)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        $fd = inotify_init();</span><br><span class=\"line\">        <span class=\"comment\">//设置为非阻塞模式</span></span><br><span class=\"line\">        stream_set_blocking($fd, <span class=\"number\">0</span>);</span><br><span class=\"line\">        $watcher = [];</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($dirs <span class=\"keyword\">as</span> $dir) &#123;</span><br><span class=\"line\">            $watch = inotify_add_watch($fd, $dir, IN_MODIFY | IN_CREATE | IN_DELETE | IN_DELETE_SELF | IN_CLOSE_WRITE);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!$watch) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> <span class=\"string\">\"&#123;$dir&#125; 添加监控错误\"</span>, PHP_EOL;</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            $watcher[$watch] = $dir;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">            $reads = [$fd];</span><br><span class=\"line\">            $write = [];</span><br><span class=\"line\">            $except = [];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (stream_select($reads, $write, $except, <span class=\"keyword\">$this</span>-&gt;timeout) &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($reads)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">foreach</span> ($reads <span class=\"keyword\">as</span> $read) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">//从可读流中读取数据</span></span><br><span class=\"line\">                        $events = inotify_read($read);</span><br><span class=\"line\">                        $fileName = <span class=\"string\">''</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">foreach</span> ($events <span class=\"keyword\">as</span> $event) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"comment\">//文件改变</span></span><br><span class=\"line\">                            $fileChg = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                            <span class=\"comment\">//目录改变</span></span><br><span class=\"line\">                            $dirChg = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                            $fileName = $event[<span class=\"string\">'name'</span>];</span><br><span class=\"line\">                            <span class=\"keyword\">switch</span> ($event[<span class=\"string\">'mask'</span>]) &#123;</span><br><span class=\"line\">                                <span class=\"keyword\">case</span> IN_CREATE:     <span class=\"comment\">//创建   IN_CLOSE_WRITE  写入结束</span></span><br><span class=\"line\">                                <span class=\"keyword\">case</span> IN_DELETE:</span><br><span class=\"line\">                                    $fileChg = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                                <span class=\"keyword\">case</span> <span class=\"number\">1073742080</span>:</span><br><span class=\"line\">                                <span class=\"keyword\">case</span> <span class=\"number\">1073742336</span>:</span><br><span class=\"line\">                                    $dirChg = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"keyword\">if</span> ($fileChg) &#123;</span><br><span class=\"line\">                                $filepath = $watcher[$event[<span class=\"string\">'wd'</span>]] . <span class=\"string\">'/'</span> . $fileName;</span><br><span class=\"line\">                                <span class=\"keyword\">if</span>($watcher[$event[<span class=\"string\">'wd'</span>]] == <span class=\"keyword\">$this</span>-&gt;dir)&#123;</span><br><span class=\"line\">                                    $newfile = $fileName;</span><br><span class=\"line\">                                &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                                    $newfile = str_replace(<span class=\"keyword\">$this</span>-&gt;dir,<span class=\"string\">'.'</span>,$filepath);</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                                <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 事件目录：\"</span> . $filepath .  <span class=\"string\">\"，事件出现：&#123;$event['mask']&#125; ，文件/目录 &#123;$fileName&#125; 发生改变\"</span> . PHP_EOL;</span><br><span class=\"line\">                                <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | \"</span> . $newfile . PHP_EOL;</span><br><span class=\"line\"><span class=\"comment\">//                                echo \"文件 &#123;$fileName&#125; 发生改变\", PHP_EOL;</span></span><br><span class=\"line\"><span class=\"comment\">//                            echo shell_exec($this-&gt;cmd), PHP_EOL;</span></span><br><span class=\"line\"><span class=\"comment\">//                                SysutilLogger::instance()-&gt;fileAdd(\"事件目录：\" . $watcher[$event['wd']] . \"，事件出现：&#123;$event['mask']&#125; ，文件/目录 &#123;$fileName&#125; 发生改变\");</span></span><br><span class=\"line\">                                call_user_func_array(<span class=\"keyword\">$this</span>-&gt;onfileAdd,[$filepath,$newfile]);</span><br><span class=\"line\"></span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> ($dirChg) &#123;</span><br><span class=\"line\"><span class=\"comment\">//                                echo \"目录 &#123;$fileName&#125; 发生改变\", PHP_EOL;</span></span><br><span class=\"line\"><span class=\"comment\">//                            echo shell_exec($this-&gt;cmd), PHP_EOL;</span></span><br><span class=\"line\">                                <span class=\"comment\">//目录发生改变时  重新监听</span></span><br><span class=\"line\">                                <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;run();</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//递归的获取当前目录下所有子目录路径</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getDirs</span><span class=\"params\">($dir)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $dir = realpath($dir);</span><br><span class=\"line\">        $dh = opendir($dir);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!$dh) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> [];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        $dirs = [];</span><br><span class=\"line\">        $dirs[] = $dir;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (($file = readdir($dh)) !== <span class=\"keyword\">false</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ($file == <span class=\"string\">'.'</span> || $file == <span class=\"string\">'..'</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            $full = $dir . DIRECTORY_SEPARATOR . $file;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (is_dir($full)) &#123;</span><br><span class=\"line\">                $dirs = array_merge($dirs, <span class=\"keyword\">$this</span>-&gt;getDirs($full));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        closedir($dh);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $dirs;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SysutilRedis</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_instance;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $m_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $mid_redis = <span class=\"keyword\">null</span>;      <span class=\"comment\">//律师中心redis实例</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> SysutilRedis|Redis</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">instance</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( ! <span class=\"keyword\">isset</span>(SysutilRedis::$_instance))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            SysutilRedis::$_instance = <span class=\"keyword\">new</span> SysutilRedis();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> SysutilRedis::$_instance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> null|Redis</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getRedis</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( !<span class=\"keyword\">$this</span>-&gt;m_redis )&#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis = <span class=\"keyword\">new</span> Redis();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;connect(REDIS_HOST,REDIS_PORT,<span class=\"number\">10</span>); <span class=\"comment\">//php客户端设置的ip及端口</span></span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;auth(REDIS_PASSWORD);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;m_redis;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">close_redis</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;m_redis) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;close();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;mid_redis) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;mid_redis-&gt;close();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;mid_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;close_redis();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Listenner</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">run</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        $callBack = [<span class=\"keyword\">$this</span>,<span class=\"string\">\"toRedis\"</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">        $listen_dir = __LISTEN_DIR__;</span><br><span class=\"line\"></span><br><span class=\"line\">        $monitor = <span class=\"keyword\">new</span> Monitor($listen_dir,$callBack);</span><br><span class=\"line\"></span><br><span class=\"line\">        $monitor-&gt;run();</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@describe</span> 文件回调</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> zhouyong</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">toRedis</span><span class=\"params\">($filename,$newfile)</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        $redis = SysutilRedis::instance()-&gt;getRedis();</span><br><span class=\"line\">        $redis-&gt;select(<span class=\"number\">9</span>);</span><br><span class=\"line\">        $cache_id = <span class=\"string\">'upload_file_list'</span>;</span><br><span class=\"line\">        $data = [</span><br><span class=\"line\">            <span class=\"string\">'local'</span> =&gt; $filename,</span><br><span class=\"line\">            <span class=\"string\">'remote'</span> =&gt; $newfile</span><br><span class=\"line\">        ];</span><br><span class=\"line\">        $redis-&gt;rpush($cache_id, json_encode($data));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$listenner = <span class=\"keyword\">new</span> Listenner();</span><br><span class=\"line\"></span><br><span class=\"line\">$listenner-&gt;run();</span><br></pre></td></tr></table></figure></p>\n<p>2）上传文件脚本(<code>upFile.php</code>)<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@internet ~]<span class=\"comment\"># vim /home/script/upFile.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by PhpStorm.</span></span><br><span class=\"line\"><span class=\"comment\"> * User: ADMIN</span></span><br><span class=\"line\"><span class=\"comment\"> * Date: 2019/7/31</span></span><br><span class=\"line\"><span class=\"comment\"> * Time: 19:21</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_HOST'</span>,<span class=\"string\">'127.0.0.1'</span>); <span class=\"comment\">//redis连接主机</span></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_PASSWORD'</span>,<span class=\"string\">'obohna7Fogai9ahnahth'</span>);  <span class=\"comment\">//redis连接密码</span></span><br><span class=\"line\">define(<span class=\"string\">'REDIS_PORT'</span>,<span class=\"string\">'6379'</span>);  <span class=\"comment\">//redis端口</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">define(<span class=\"string\">'FTP_HOST'</span>,<span class=\"string\">'192.168.1.33'</span>);  <span class=\"comment\">//内网ftp服务器</span></span><br><span class=\"line\">define(<span class=\"string\">'FTP_PORT'</span>,<span class=\"number\">21</span>); <span class=\"comment\">//ftp端口</span></span><br><span class=\"line\">define(<span class=\"string\">'FTP_USER'</span>,<span class=\"string\">'ftp_come_user'</span>);  <span class=\"comment\">//ftp连接账号</span></span><br><span class=\"line\">define(<span class=\"string\">'FTP_PASS'</span>,<span class=\"string\">'Ftp_come_password@Qaz123'</span>);  <span class=\"comment\">//ftp连接密码</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SysutilFtp</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $instance;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> $off; <span class=\"comment\">// 返回操作状态(成功/失败)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> $conn_id; <span class=\"comment\">// FTP连接</span></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：FTP连接</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@FTP</span>_HOST -- FTP主机</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@FTP</span>_PORT -- 端口</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@FTP</span>_USER -- 用户名</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@FTP</span>_PASS -- 密码</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($FTP_HOST,$FTP_PORT,$FTP_USER,$FTP_PASS)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;conn_id = @ftp_connect($FTP_HOST,$FTP_PORT) <span class=\"keyword\">or</span> <span class=\"keyword\">die</span>(<span class=\"string\">\"FTP服务器连接失败\"</span>);</span><br><span class=\"line\">        @ftp_login(<span class=\"keyword\">$this</span>-&gt;conn_id,$FTP_USER,$FTP_PASS) <span class=\"keyword\">or</span> <span class=\"keyword\">die</span>(<span class=\"string\">\"FTP服务器登陆失败\"</span>);</span><br><span class=\"line\">        @ftp_pasv(<span class=\"keyword\">$this</span>-&gt;conn_id,<span class=\"number\">1</span>); <span class=\"comment\">// 打开被动模拟</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@describe</span> 获取ftp实例</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getInstance</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"keyword\">self</span>::$instance)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">self</span>::$instance = <span class=\"keyword\">new</span> <span class=\"keyword\">self</span>(FTP_HOST,FTP_PORT,FTP_USER,FTP_PASS);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(<span class=\"keyword\">self</span>::$instance)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | connected !\"</span> . PHP_EOL;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>::$instance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@describe</span> 重连</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span> zhouyong</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">reConnect</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | closing connection ......\"</span> . PHP_EOL;</span><br><span class=\"line\">        <span class=\"comment\">//关闭当前链接</span></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;close();</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | reconnecting....\"</span> . PHP_EOL;</span><br><span class=\"line\">        <span class=\"comment\">//开辟新连接</span></span><br><span class=\"line\">        <span class=\"keyword\">self</span>::$instance = <span class=\"keyword\">new</span> <span class=\"keyword\">self</span>(FTP_HOST,FTP_PORT,FTP_USER,FTP_PASS);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | connected !\"</span> . PHP_EOL;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：上传文件</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@path</span> -- 本地路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@newpath</span> -- 上传路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@type</span> -- 若目标目录不存在则新建</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> true</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">up_file</span><span class=\"params\">($path,$newpath,$type=true)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($type) <span class=\"keyword\">$this</span>-&gt;dir_mkdirs($newpath);</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 当前目录\"</span> . ftp_pwd(<span class=\"keyword\">$this</span>-&gt;conn_id) . PHP_EOL;</span><br><span class=\"line\">        $newpath = ltrim($newpath,<span class=\"string\">'.'</span>);</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> $newpath . PHP_EOL;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;off = @ftp_put(<span class=\"keyword\">$this</span>-&gt;conn_id,$newpath,$path,FTP_BINARY);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"keyword\">$this</span>-&gt;off)&#123;</span><br><span class=\"line\"><span class=\"comment\">//            echo \"文件上传失败，请检查权限及路径是否正确！\";</span></span><br><span class=\"line\"><span class=\"comment\">//            echo \"文件上传失败，正在发起重连.....\";</span></span><br><span class=\"line\"><span class=\"comment\">//            $this-&gt;reConnect();</span></span><br><span class=\"line\"><span class=\"comment\">//            echo date('Y-m-d H:i:s') . \" | re-uploading file &#123;$path&#125; to &#123;$newpath&#125; ....\" . PHP_EOL;</span></span><br><span class=\"line\"><span class=\"comment\">//            $this-&gt;up_file($path,$newpath,$type=true);</span></span><br><span class=\"line\">            <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 上传失败\"</span> . PHP_EOL;</span><br><span class=\"line\"><span class=\"comment\">//            exit;</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | upload success !\"</span> . PHP_EOL;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：移动文件</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@path</span> -- 原路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@newpath</span> -- 新路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@type</span> -- 若目标目录不存在则新建</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">move_file</span><span class=\"params\">($path,$newpath,$type=true)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($type) <span class=\"keyword\">$this</span>-&gt;dir_mkdirs($newpath);</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;off = @ftp_rename(<span class=\"keyword\">$this</span>-&gt;conn_id,$path,$newpath);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"keyword\">$this</span>-&gt;off) <span class=\"keyword\">echo</span> <span class=\"string\">\"文件移动失败，请检查权限及原路径是否正确！\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：复制文件</span></span><br><span class=\"line\"><span class=\"comment\">     * 说明：由于FTP无复制命令,本方法变通操作为：下载后再上传到新的路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@path</span> -- 原路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@newpath</span> -- 新路径</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@type</span> -- 若目标目录不存在则新建</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">copy_file</span><span class=\"params\">($path,$newpath,$type=true)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $downpath = <span class=\"string\">\"c:/tmp.dat\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;off = @ftp_get(<span class=\"keyword\">$this</span>-&gt;conn_id,$downpath,$path,FTP_BINARY);<span class=\"comment\">// 下载</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"keyword\">$this</span>-&gt;off) <span class=\"keyword\">echo</span> <span class=\"string\">\"文件复制失败，请检查权限及原路径是否正确！\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;up_file($downpath,$newpath,$type);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：删除文件</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@path</span> -- 路径</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">del_file</span><span class=\"params\">($path)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;off = @ftp_delete(<span class=\"keyword\">$this</span>-&gt;conn_id,$path);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"keyword\">$this</span>-&gt;off) <span class=\"keyword\">echo</span> <span class=\"string\">\"文件删除失败，请检查权限及路径是否正确！\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：生成目录</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@path</span> -- 路径</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">dir_mkdirs</span><span class=\"params\">($path)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $path_arr = explode(<span class=\"string\">'/'</span>,$path); <span class=\"comment\">// 取目录数组</span></span><br><span class=\"line\">        $file_name = array_pop($path_arr); <span class=\"comment\">// 弹出文件名</span></span><br><span class=\"line\">        $path_div = count($path_arr); <span class=\"comment\">// 取层数</span></span><br><span class=\"line\">        print_r($path_arr);</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span>($path_arr <span class=\"keyword\">as</span> $val) <span class=\"comment\">// 创建目录</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(@ftp_chdir(<span class=\"keyword\">$this</span>-&gt;conn_id,$val) == <span class=\"keyword\">FALSE</span>)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                $tmp = @ftp_mkdir(<span class=\"keyword\">$this</span>-&gt;conn_id,$val);</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 创建目录&#123;$val&#125;\"</span> . PHP_EOL;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>($tmp == <span class=\"keyword\">FALSE</span>)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 目录创建失败，请检查权限及路径是否正确！\"</span> . PHP_EOL;</span><br><span class=\"line\">                    <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                @ftp_chdir(<span class=\"keyword\">$this</span>-&gt;conn_id,$val);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 创建目录成功\"</span> . PHP_EOL;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 当前目录\"</span> . ftp_pwd(<span class=\"keyword\">$this</span>-&gt;conn_id) . PHP_EOL;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>($i=<span class=\"number\">1</span>;$i&lt;$path_div;$i++) <span class=\"comment\">// 回退到根</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            @ftp_cdup(<span class=\"keyword\">$this</span>-&gt;conn_id);</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | 当前目录\"</span> . ftp_pwd(<span class=\"keyword\">$this</span>-&gt;conn_id) . PHP_EOL;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ping</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> date(<span class=\"string\">\"Y-m-d H:i:s\"</span>) . <span class=\"string\">\" |  发送心跳数据 \"</span> . PHP_EOL;</span><br><span class=\"line\">        @ftp_raw(<span class=\"keyword\">$this</span>-&gt;conn_id,<span class=\"string\">'pingpong'</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 方法：关闭FTP连接</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">close</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        @ftp_close(<span class=\"keyword\">$this</span>-&gt;conn_id);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"comment\">// class class_ftp end</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SysutilRedis</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_instance;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $m_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $mid_redis = <span class=\"keyword\">null</span>;      <span class=\"comment\">//律师中心redis实例</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> SysutilRedis</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">instance</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( ! <span class=\"keyword\">isset</span>(SysutilRedis::$_instance))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            SysutilRedis::$_instance = <span class=\"keyword\">new</span> SysutilRedis();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> SysutilRedis::$_instance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> null|Redis</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getRedis</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( !<span class=\"keyword\">$this</span>-&gt;m_redis )&#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis = <span class=\"keyword\">new</span> Redis();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;connect(REDIS_HOST,REDIS_PORT,<span class=\"number\">10</span>); <span class=\"comment\">//php客户端设置的ip及端口</span></span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;auth(REDIS_PASSWORD);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;m_redis;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">close_redis</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;m_redis) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis-&gt;close();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;m_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;mid_redis) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;mid_redis-&gt;close();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;mid_redis = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;close_redis();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$redis = SysutilRedis::instance()-&gt;getRedis();</span><br><span class=\"line\">$redis-&gt;select(<span class=\"number\">9</span>);</span><br><span class=\"line\">$cache_id = <span class=\"string\">'upload_file_list'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$no_data_time = <span class=\"number\">0</span>;</span><br><span class=\"line\">$ping = <span class=\"number\">3</span>;      <span class=\"comment\">//心跳时间   每 x 秒发送一次心跳数据</span></span><br><span class=\"line\"><span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    $data = $redis-&gt;lRange($cache_id, <span class=\"number\">0</span>, <span class=\"number\">-1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($data)) &#123;</span><br><span class=\"line\">        $no_data_time = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($data <span class=\"keyword\">as</span> $key =&gt; $value) &#123;</span><br><span class=\"line\">            $v = json_decode($value, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">            $result = up_file($v[<span class=\"string\">'local'</span>],$v[<span class=\"string\">'remote'</span>]);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>($result)&#123;</span><br><span class=\"line\">                $redis-&gt;select(<span class=\"number\">9</span>);</span><br><span class=\"line\">                $redis-&gt;lPop($cache_id);</span><br><span class=\"line\">            &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> date(<span class=\"string\">\"Y-m-d H:i:s\"</span>) . <span class=\"string\">\"| 退出脚本\"</span>;</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($no_data_time &gt; <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">            <span class=\"comment\">//查看没有事件的时间</span></span><br><span class=\"line\">            $time = time();</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(($time - $no_data_time) &gt; $ping)&#123;</span><br><span class=\"line\">                <span class=\"comment\">//发送心跳  并重置时间</span></span><br><span class=\"line\">                ping_ftp();</span><br><span class=\"line\">                $no_data_time = $time;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            $no_data_time = time();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">up_file</span><span class=\"params\">($filename,$newfile)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>) . <span class=\"string\">\" | $filename ,  $newfile\"</span> . PHP_EOL;</span><br><span class=\"line\">    $ftp = SysutilFtp::getInstance();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $ftp-&gt;up_file($filename,$newfile);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ping_ftp</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    $ftp = SysutilFtp::getInstance();</span><br><span class=\"line\">    $ftp-&gt;ping();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）启动脚本并测试<br><figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#在一个终端启动listen.php脚本</span><br><span class=\"line\">[root@internet ~]# php -f /home/script/listen.php</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#在另外一个终端启动upFile.php脚本</span><br><span class=\"line\">[root@internet ~]# php -f /home/script/upFile.php </span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:24:11 | connected !</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:24:11 |  发送心跳数据</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#在第三个终端往监听目录/opt/ftp/out目录新建一个文件或目录进行测试</span><br><span class=\"line\">[root@internet ~]# echo \"test\" &gt;&gt; /opt/ftp/out/file1</span><br><span class=\"line\"></span><br><span class=\"line\">#分别可以在上面第一个终端和第二个终端看到日志信息</span><br><span class=\"line\">终端一的信息：</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | 事件目录：/opt/ftp/out/file1，事件出现：256 ，文件/目录 file1 发生改变</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | file1</span><br><span class=\"line\"></span><br><span class=\"line\">终端二的信息：</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | /opt/ftp/out/file1 ,  file1</span><br><span class=\"line\">Array</span><br><span class=\"line\">(</span><br><span class=\"line\">)</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | 创建目录成功</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | 当前目录/</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | 当前目录/</span><br><span class=\"line\">file1</span><br><span class=\"line\">2019<span class=\"string\">-08</span><span class=\"string\">-06</span> 11:36:26 | upload success !</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"管理两个脚本\"><a href=\"#管理两个脚本\" class=\"headerlink\" title=\"管理两个脚本\"></a>管理两个脚本</h3><p>1）编写监控脚本，当进程挂掉便重启<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /home/script/process_alive.sh</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#用来监听listen脚本和upFile脚本</span></span><br><span class=\"line\"></span><br><span class=\"line\">DATE=[`date <span class=\"string\">\"+%Y-%m-%d %H:%M:%S\"</span>`]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> phpScriptAlive &#123;</span><br><span class=\"line\">    script_dir=/home/script/</span><br><span class=\"line\">    ps aux |grep -v grep |grep <span class=\"variable\">$1</span> &gt;&gt; /dev/null</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ $? != 0 ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        nohup php -f <span class=\"variable\">$&#123;script_dir&#125;</span>/<span class=\"variable\">$1</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/<span class=\"variable\">$2</span> &amp;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;DATE&#125;</span> 重启php脚本 <span class=\"variable\">$1</span>\"</span> &gt;&gt; /var/<span class=\"built_in\">log</span>/php_script_restart.log</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">phpScriptAlive listen.php php_listen.log</span><br><span class=\"line\">phpScriptAlive upFile.php php_upfile.log</span><br></pre></td></tr></table></figure></p>\n<p>2）添加到计划任务<br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># chmod +x /home/script/process_alive.sh </span></span><br><span class=\"line\"><span class=\"section\"># 监听php脚本进程</span></span><br><span class=\"line\"><span class=\"bullet\">* </span><span class=\"bullet\">* *</span> <span class=\"bullet\">* *</span> /bin/bash /home/script/process_alive.sh</span><br></pre></td></tr></table></figure></p>\n<p>3）查看日志；由于上面脚本里面写了将所有输出都记录到日志里面，所以后续直接查看日志即可<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@internet ~]</span># <span class=\"selector-tag\">tailf</span> /<span class=\"selector-tag\">var</span>/<span class=\"selector-tag\">log</span>/<span class=\"selector-tag\">php</span></span><br><span class=\"line\"><span class=\"selector-tag\">php-fpm</span>/                <span class=\"selector-tag\">php_listen</span><span class=\"selector-class\">.log</span>          <span class=\"selector-tag\">php_script_restart</span><span class=\"selector-class\">.log</span>  <span class=\"selector-tag\">php_upfile</span><span class=\"selector-class\">.log</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@internet ~]</span># <span class=\"selector-tag\">tailf</span> /<span class=\"selector-tag\">var</span>/<span class=\"selector-tag\">log</span>/<span class=\"selector-tag\">php_listen</span><span class=\"selector-class\">.log</span> </span><br><span class=\"line\">^<span class=\"selector-tag\">C</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@internet ~]</span># <span class=\"selector-tag\">tailf</span> /<span class=\"selector-tag\">var</span>/<span class=\"selector-tag\">log</span>/<span class=\"selector-tag\">php_upfile</span><span class=\"selector-class\">.log</span> </span><br><span class=\"line\"><span class=\"selector-tag\">2019-08-06</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:01</span><span class=\"selector-pseudo\">:18</span> |  发送心跳数据 </span><br><span class=\"line\"><span class=\"selector-tag\">2019-08-06</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:01</span><span class=\"selector-pseudo\">:22</span> |  发送心跳数据 </span><br><span class=\"line\"><span class=\"selector-tag\">2019-08-06</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:01</span><span class=\"selector-pseudo\">:26</span> |  发送心跳数据 </span><br><span class=\"line\"><span class=\"selector-tag\">2019-08-06</span> <span class=\"selector-tag\">12</span><span class=\"selector-pseudo\">:01</span><span class=\"selector-pseudo\">:30</span> |  发送心跳数据</span><br></pre></td></tr></table></figure></p>\n<p>4）再次往<code>/opt/ftp/out/</code>目录丢文件，便会自动同步到内网或者外网的<code>/opt/ftp/come</code>目录。<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@internet ~]<span class=\"comment\"># echo \"sjdklf\" &gt;&gt; /opt/ftp/out/file111</span></span><br><span class=\"line\">[root@internet ~]<span class=\"comment\"># for i in `seq 10`; do echo \"sjdlfjskldjf\" &gt;&gt; /opt/ftp/out/txt$i ; don</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#内网查看</span></span><br><span class=\"line\">[root@lan ~]<span class=\"comment\"># ll /opt/ftp/come/</span></span><br><span class=\"line\">总用量 48</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache <span class=\"number\"> 5 </span>8月  <span class=\"number\"> 6 </span>11:36 file1</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache <span class=\"number\"> 7 </span>8月  <span class=\"number\"> 6 </span>12:06 file111</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt1</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt10</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt2</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt3</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt4</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt5</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt6</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt7</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt8</span><br><span class=\"line\">-rw-r--r--<span class=\"number\"> 1 </span>apache apache<span class=\"number\"> 13 </span>8月  <span class=\"number\"> 6 </span>12:07 txt9</span><br></pre></td></tr></table></figure></p>\n"},{"title":"网络RAID技术DRBD","date":"2019-08-08T07:00:35.000Z","copyright":true,"_content":"# DRBD简介\n[官方文档](https://docs.linbit.com/docs/users-guide-8.4/)\n\n>DRBD的全称为：`Distributed Replicated Block Device(DRBD)`分布式块设备复制，`DRBD`是由内核模块和相关脚本构成，用以构建高可用的集群。其实现方式是通过网络来镜像整个设备。可以把它看作是一种网络`RAID`。它允许用户在远程机器上建立一个本地块设备的实时镜像。\n\n## DRBD是如何工作的\n> `（DRBD Primary）`负责接收数据，把数据写到本地磁盘并发送给另一台主机`（DRBD Secondary）`。另一个主机再将数据存到自己的磁盘中。目前，`DRBD`每次只允许对一个节点进行读写访问，但这对于通常的故障切换高可用集群来说已经足够用了，有可能以后的版本支持两个节点进行读写存取。\n> `DRBD`协议说明\n> 1）数据一旦写入磁盘并发送到网络中就认为完成了写入操作。\n> 2）收到接收确认就认为完成了写入操作。\n> 3）收到写入确认就认为完成了写入操作。\n\n## DRBD与HA的关系\n>一个`DRBD`系统由两个节点构成，与`HA`集群类似，也有主节点和备用节点之分，在带有主要设备的节点上，应用程序和操作系统可以运行和访问`DRBD`设备`（/dev/drbd*）`。在主节点写入的数据通过`DRBD`设备存储到主节点的设备写入到备用节点的磁盘中。现在大部分的高可用性集群都会使用共享存储，而`DRBD`也可以作为一个共享存储设备，使用`DRBD`不需要太多的硬件的设备。因为它在`TCP/IP`网络中运行，所以，利用`DRBD`作为共享存储设备，节约很多成本，因为价格要比专用的存储网络便宜很多；其性能与稳定性方面也不错。\n\n# DRBD工作原理\n>`DRBD`是`linux`的内核的存储层中的一个分布式存储系统，可用使用`DRBD`在两台`Linux`服务器之间共享块设备，共享文件系统和数据。类似网络`RAID-1`，其工作的原理架构图如下：\n\n![image.png](网络RAID技术DRBD/01.jpg)\n\n# DRBD的特性\n>分布式复制块设备（`DRBD`技术）是一种基于软件的，无共享，复制的存储解决方案，在服务器之间的对块设备（硬盘、分区、逻辑卷等）进行镜像。\n>`DRBD`镜像数据的特性：\n>1）实时性：当某个应用程序完成对数据的修改时，复制功能立即发生\n>2）透明性：应用程序的数据存储在镜像块设备上是独立透明的，他们的数据在两个节点上都保存一份，因此，无论哪一台服务器宕机，都不会影响应用程序读取数据的操作，所以说是透明的。\n>3）同步镜像和异步镜像：同步镜像表示当应用程序提交本地的写操作后，数据会同步写到两个节点上去；异步镜像表示当应用程序提交写操作后，只有当本地的节点上完成写操作后，另一个节点才可以完成写操作。\n\n# DRBD的模式\n>`DRBD`共有2种模式，一种是`DRBD的主从模式`，另一种是`DRBD的双主模式`\n>**1）DRBD的主从模式：**\n>   这种模式下，其中一个节点作为主节点，另一个节点作为从节点。其中主节点可以执行读、写操作；从节点不可以挂载文件系统，因此也不可以执行读写操作。在这种模式下，资源在任何时间只能存储在主节点上。这种模式可用在任何的文件系统（`ext3、ext4、xfs`）等。默认这种模式下，一旦主节点发生故障，从节点需要手工将资源进行转移，且主节点变成从节点和从节点变成主节点需要手动进行切换。不能自动进行转移，因此比较麻烦。\n>为了解决手动将资源和节点进行转移，可以将`DRBD`做成高可用集群的资源代理`（RA）`，这样一旦其中的一个节点宕机，资源就会自动转移到另一个节点，从而保证服务的连续性。\n>**2）DRBD的双主模式:**\n>这是`DRBD8.0`之后的新特性，在双主模式下，任何资源在任何特定的时间都存在两个主节点。这种模式需要一个共享的集群文件系统，利用分布式的锁机制进行管理，如`GFS`和`OCFS2`。部署双主模式时，`DRBD`可以是负载均衡的集群，这就需要从两个并发的主节点中选取一个首选的访问数据。这种模式默认是禁用的，如果要是用的话必须在配置文件中进行申明。\n\n# DRBD的复制模式\n>`DRBD`的复制功能就是将应用程序提交的数据一份保存在本地节点，一份复制传输保存在另一份节点上。但是`DRBD`需要对传输的数据进行确认以便保证另一个节点的写操作完成，就需要用到`DRBD`的复制模式，`DRBD`有三种复制模式：\n\n**1）协议A：异步复制协议**\n>一旦本地磁盘写入已经完成，数据包已在发送队列中，则写被认为是完成的。在一个节点上发生故障时，可能发生数据丢失，因为被写入到远程节点上的数据可能仍在发送队列。尽管，在故障转移节点上的数据是一致的，但没有及时更新。这通常是用于地理上分开的节点。\n\n**2）协议B：内存同步（半同步）复制协议**\n>一旦本地磁盘写入已完成且复制数据包达到了对等节点则认为写在主节点上被认为是完成的。数据丢失可能发生在参加的两个节点同时故障的情况下，因为在传输中的数据可能不会被提交到磁盘。\n\n**3）协议C：同步复制协议**\n>只有在本地和远程节点的磁盘已经确认了写操作完成，写才被认为完成。没有任何数据丢失，所以这是一个集群节点的流行模式，但`I/O`吞吐量依赖于网络带宽。一般使用`协议C`，但选择`C协议`将影响流量，从而影响网络延迟。为了数据可靠性，我们在生产环境使用时须慎重选择使用哪一种协议。\n\n# DRBD配置文件说明\n```\nDRBD的主配置文件为/etc/drbd.conf；为了管理的便捷性，\n目前通常会将配置文件分成多个部分，且都保存至/etc/drbd.d目录中，主配置文件中仅使用\"include\"指令将这些配置文件片断整合起来。通常，/etc/drbd.d目录中的配置文件\n为global_common.conf和所有以.res结尾的文件。其中global_common.conf中主要定义global段和common段，而每一个.res的文件用于定义一个资源。\n  \n在配置文件中，global段仅能出现一次，且如果所有的配置信息都保存至同一个配置文件中而不分开为多个文件的话，global段必须位于配置文件的最开始处。目前global段中\n可以定义的参数仅有minor-count, dialog-refresh, disable-ip-verification和usage-count。\n  \ncommon段则用于定义被每一个资源默认继承的参数，可以在资源定义中使用的参数都可以在common段中定义。实际应用中，common段并非必须，但建议将多个资源共享的参数定\n义为common段中的参数以降低配置文件的复杂度。\n  \nresource段则用于定义DRBD资源，每个资源通常定义在一个单独的位于/etc/drbd.d目录中的以.res结尾的文件中。资源在定义时必须为其命名，名字可以由非空白的ASCII字符\n组成。每一个资源段的定义中至少要包含两个host子段，以定义此资源关联至的节点，其它参数均可以从common段或DRBD的默认中进行继承而无须定义。\n  \nDRBD配置文件\n[root@drbd1 ~]# cat /etc/drbd.d/global_common.conf\nglobal {\n usage-count yes;         //是否参加DRBD使用者统计，默认是参加\n # minor-count dialog-refresh disable-ip-verification  //这里是global可以使用的参数\n #minor-count：32         //从（设备）个数，取值范围1~255，默认值为32。该选项设定了允许定义的resource个数，当要定义的resource超过了此选项的设定时，需要重新载入DRBD内核模块。\n #disable-ip-verification：no   //是否禁用ip检查\n   \n}\ncommon {\n protocol C;      //指定复制协议,复制协议共有三种，为协议A，B，C，默认协议为协议C\n handlers {       //该配置段用来定义一系列处理器，用来回应特定事件。\n  # These are EXAMPLE handlers only.\n  # They may have severe implications,\n  # like hard resetting the node under certain circumstances.\n  # Be careful when chosing your poison.\n  # pri-on-incon-degr \"/usr/lib/DRBD/notify-pri-on-incon-degr.sh; /usr/lib/DRBD/notify-emergency-reboot.sh; echo b > /proc/sysrq-trigger ; reboot -f\";\n  # pri-lost-after-sb \"/usr/lib/DRBD/notify-pri-lost-after-sb.sh; /usr/lib/DRBD/notify-emergency-reboot.sh; echo b > /proc/sysrq-trigger ; reboot -f\";\n  # local-io-error \"/usr/lib/DRBD/notify-io-error.sh; /usr/lib/DRBD/notify-emergency-shutdown.sh; echo o > /proc/sysrq-trigger ; halt -f\";\n  # fence-peer \"/usr/lib/DRBD/crm-fence-peer.sh\";\n  # split-brain \"/usr/lib/DRBD/notify-split-brain.sh root\";\n  # out-of-sync \"/usr/lib/DRBD/notify-out-of-sync.sh root\";\n  # before-resync-target \"/usr/lib/DRBD/snapshot-resync-target-lvm.sh -p 15 -- -c 16k\";\n  # after-resync-target /usr/lib/DRBD/unsnapshot-resync-target-lvm.sh;\n }\n startup {    //#DRBD同步时使用的验证方式和密码。该配置段用来更加精细地调节DRBD属性，它作用于配置节点在启动或重启时。常用选项有：\n  # wfc-timeout degr-wfc-timeout outdated-wfc-timeout wait-after-sb\n  wfc-timeout：  //该选项设定一个时间值，单位是秒。在启用DRBD块时，初始化脚本DRBD会阻塞启动进程的运行，直到对等节点的出现。该选项就是用来限制这个等待时间的，默认为0，即不限制，永远等待。\n  degr-wfc-timeout：  //该选项也设定一个时间值，单位为秒。也是用于限制等待时间，只是作用的情形不同：它作用于一个降级集群（即那些只剩下一个节点的集群）在重启时的等待时间。\n  outdated-wfc-timeout：  //同上，也是用来设定等待时间，单位为秒。它用于设定等待过期节点的时间\n }\n disk {\n  # on-io-error fencing use-bmbv no-disk-barrier no-disk-flushes   //这里是disk段内可以定义的参数\n  # no-disk-drain no-md-flushes max-bio-bvecs                      //这里是disk段内可以定义的参数\n  on-io-error： detach      //选项：此选项设定了一个策略，如果底层设备向上层设备报告发生I/O错误，将按照该策略进行处理。有效的策略包括：\n    detach      //发生I/O错误的节点将放弃底层设备，以diskless mode继续工作。在diskless mode下，只要还有网络连接，DRBD将从secondary node读写数据，而不需要failover（故障转移）。该策略会导致一定的损失，但好处也很明显，DRBD服务不会中断。官方推荐和默认策略。\n    pass_on       //把I/O错误报告给上层设备。如果错误发生在primary节点，把它报告给文件系统，由上层设备处理这些错误（例如，它会导致文件系统以只读方式重新挂载），它可能会导致DRBD停止提供服务；如果发生在secondary节点，则忽略该错误（因为secondary节点没有上层设备可以报告）。该策略曾经是默认策略，但现在已被detach所取代。\n    call-local-io-error   //调用预定义的本地local-io-error脚本进行处理。该策略需要在resource（或common）配置段的handlers部分，预定义一个相应的local-io-error命令调用。该策略完全由管理员通过local-io-error命令（或脚本）调用来控制如何处理I/O错误。\n  fencing：               //该选项设定一个策略来避免split brain的状况。有效的策略包括：\n    dont-care：  //默认策略。不采取任何隔离措施。\n    resource-only：   //在此策略下，如果一个节点处于split brain状态，它将尝试隔离对端节点的磁盘。这个操作通过调用fence-peer处理器来实现。fence-peer处理器将通过其它通信路径到达对等节点，并在这个对等节点上调用DRBDadm outdate res命令\n    resource-and-stonith：   //在此策略下，如果一个节点处于split brain状态，它将停止I/O操作，并调用fence-peer处理器。处理器通过其它通信路径到达对等节点，并在这个对等节点上调用DRBDadm outdate res命令。如果无法到达对等节点，它将向对等端发送关机命令。一旦问题解决，I/O操作将重新进行。如果处理器失败，你可以使用resume-io命令来重新开始I/O操作。\n    \n }\n net {        //该配置段用来精细地调节DRBD的属性，网络相关的属性。常用的选项有：\n  # sndbuf-size rcvbuf-size timeout connect-int ping-int ping-timeout max-buffers     //这里是net段内可以定义的参数\n  # max-epoch-size ko-count allow-two-primaries cram-hmac-alg shared-secret      //这里是net段内可以定义的参数\n  # after-sb-0pri after-sb-1pri after-sb-2pri data-integrity-alg no-tcp-cork      //这里是net段内可以定义的参数\n  sndbuf-size：     //该选项用来调节TCP send buffer的大小，DRBD 8.2.7以前的版本，默认值为0，意味着自动调节大小；新版本的DRBD的默认值为128KiB。高吞吐量的网络（例如专用的千兆网卡，或负载均衡中绑定的连接）中，增加到512K比较合适，或者可以更高，但是最好不要超过2M。\n  timeout：        //该选项设定一个时间值，单位为0.1秒。如果搭档节点没有在此时间内发来应答包，那么就认为搭档节点已经死亡，因此将断开这次TCP/IP连接。默认值为60，即6秒。该选项的值必须小于connect-int和ping-int的值。\n  connect-int：     //如果无法立即连接上远程DRBD设备，系统将断续尝试连接。该选项设定的就是两次尝试间隔时间。单位为秒，默认值为10秒。\n  ping-timeout：    //该选项设定一个时间值，单位是0.1秒。如果对端节点没有在此时间内应答keep-alive包，它将被认为已经死亡。默认值是500ms。\n  max-buffers：     //该选项设定一个由DRBD分配的最大请求数，单位是页面大小（PAGE_SIZE），大多数系统中，页面大小为4KB。这些buffer用来存储那些即将写入磁盘的数据。最小值为32（即128KB）。这个值大一点好。\n  max-epoch-size：    //该选项设定了两次write barriers之间最大的数据块数。如果选项的值小于10，将影响系统性能。大一点好\n  ko-count：     //该选项设定一个值，把该选项设定的值 乘以 timeout设定的值，得到一个数字N，如果secondary节点没有在此时间内完成单次写请求，它将从集群中被移除（即，primary node进入StandAlong模式）。取值范围0~200，默认值为0，即禁用该功能。\n  allow-two-primaries：   //这个是DRBD8.0及以后版本才支持的新特性，允许一个集群中有两个primary node。该模式需要特定文件系统的支撑，目前只有OCFS2和GFS可以，传统的ext3、ext4、xfs等都不行！\n  cram-hmac-alg：    //该选项可以用来指定HMAC算法来启用对端节点授权。DRBD强烈建议启用对端点授权机制。可以指定/proc/crypto文件中识别的任一算法。必须在此指定算法，以明确启用对端节点授权机制，实现数据加密传输。\n  shared-secret：    //该选项用来设定在对端节点授权中使用的密码，最长64个字符。\n  data-integrity-alg：   //该选项设定内核支持的一个算法，用于网络上的用户数据的一致性校验。通常的数据一致性校验，由TCP/IP头中所包含的16位校验和来进行，而该选项可以使用内核所支持的任一算法。该功能默认关闭。\n }\n syncer {       //该配置段用来更加精细地调节服务的同步进程。常用选项有\n  # rate after al-extents use-rle cpu-mask verify-alg csums-alg\n  rate：    //设置同步时的速率，默认为250KB。默认的单位是KB/sec，也允许使用K、M和G，如40M。注意：syncer中的速率是以bytes，而不是bits来设定的。配置文件中的这个选项设置的速率是永久性的，但可使用下列命令临时地改变rate的值：DRBDsetup /dev/DRBDN syncer -r 100M。如果想重新恢复成drbd.conf配置文件中设定的速率，执行如下命令： DRBDadm adjust resource\n  verify-alg：    //该选项指定一个用于在线校验的算法，内核一般都会支持md5、sha1和crc32c校验算法。在线校验默认关闭，必须在此选项设定参数，以明确启用在线设备校验。DRBD支持在线设备校验，它以一种高效的方式对不同节点的数据进行一致性校验。在线校验会影响CPU负载和使用，但影响比较轻微。DRBD 8.2.5及以后版本支持此功能。一旦启用了该功能，你就可以使用下列命令进行一个在线校验： DRBDadm verify resource。该命令对指定的resource进行检验，如果检测到有数据块没有同步，它会标记这些块，并往内核日志中写入一条信息。这个过程不会影响正在使用该设备的程序。\n                    如果检测到未同步的块，当检验结束后，你就可以如下命令重新同步它们：DRBDadm disconnect resource   or   DRBDadm connetc resource\n }\n}\n  \ncommon段是用来定义共享的资源参数，以减少资源定义的重复性。common段是非必须的。resource段一般为DRBD上每一个节点来定义其资源参数的。\n资源配置文件详解 \n  \n  \n[root@drbd1 ~]# cat /etc/drbd.d/web.res\nresource web {       //web为资源名称\n on ha1.xsl.com {                       //on后面为节点的名称,有几个节点就有几个on段，这里是定义节点ha1.xsl.com上的资源\n  device   /dev/DRBD0;       //定义DRBD虚拟块设备，这个设备事先不要格式化。\n  disk /dev/sda6;        //定义存储磁盘为/dev/sda6,该分区创建完成之后就行了，不要进行格式化操作\n  address 192.168.108.199:7789;      //定义DRBD监听的地址和端口，以便和对端进行通信\n  meta-disk  internal;       //该参数有2个选项：internal和externally，其中internal表示将元数据和数据存储在同一个磁盘上；而externally表示将元数据和数据分开存储，元数据被放在另一个磁盘上。\n }\n on ha2.xsl.com {        //这里是定义节点ha2.xsl.com上的资源\n  device /dev/DRBD0;\n  disk /dev/sda6;\n  address 192.168.108.201:7789;\n  meta-disk internal;\n }\n}\n```\n\n\n# DRBD安装配置（主从模式）\n**环境说明**\n>这里使用所用环境为`centos7.4`操作系统\n>在下面的操作步骤中`# command`的命令表示主从节点服务器都需要执行。\n\n| IP           | 主机名            | 角色说明 |\n| ------------ | ----------------- | -------- |\n| 192.168.1.31 | drbd1.cluster.com | 主服务器 |\n| 192.168.1.32 | drbd2.cluster.com | 从服务器 |\n\n## 具体步骤\n1）两台机器上添加`DRBD`磁盘，进行分区，不做格式化，并在本地系统创建`/data`目录，不做挂载操作\n```\n在drbd1服务器上操作\n[root@drbd1 ~]# lsblk \n......\nsdb               8:16   0   10G  0 disk\n[root@drbd1 ~]# fdisk /dev/sdb\n依次输入\"n->p->1->回车->回车-w\"\n\n在drbd2服务器上操作\n[root@drbd2 ~]# lsblk \n......\nsdb               8:16   0   10G  0 disk\n[root@drbd2 ~]# fdisk /dev/sdb\n依次输入\"n->p->1->回车->回车-w\"\n```\n\n2）两台服务器之间的防火墙要允许互相访问，这里测试关闭`selinux`和防火墙(两台服务器同样操作)\n```\n# systemctl stop firewalld\n# setenforce 0     //临时性关闭；永久关闭需修改/etc/sysconfig/selinux的SELINUX为disable\n```\n\n3）`hosts`绑定（两台服务器同样操作）\n```\n# vim /etc/hosts\n192.168.1.31    drbd1.cluster.com\n192.168.1.32    drbd2.cluster.com\n```\n\n4）两台服务器进行时间同步（两台服务器同样操作）\n```\n# yum -y install ntpdate\n# ntpdate -u asia.pool.ntp.org\n```\n\n5）`DRBD`安装配置（两台服务器同样操作）\n```\n这里使用yum方式安装\n# rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\n# yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm\n# yum -y install kmod-drbd84 drbd86-utils \n\n因为在执行yum -y install kmod-drbd84 drbd86-utils时，对内核kernel进行了update，要重新启动服务器，更新后的内核才会生效。\n加载模块：\n# reboot\n# modprobe drbd\n查看模块是否已添加上\n# lsmod |grep drbd\ndrbd                  397041  0 \nlibcrc32c              12644  4 xfs,drbd,nf_nat,nf_conntrack\n```\n\n6）`DRBD`配置（两台服务器上同样操作）\n```\n# cat /etc/drbd.conf     //主配置文件\n# You can find an example in  /usr/share/doc/drbd.../drbd.conf.example\n\ninclude \"drbd.d/global_common.conf\";\ninclude \"drbd.d/*.res\";\n\n备份配置文件\n# cp /etc/drbd.d/global_common.conf{,.bak} \n# vim /etc/drbd.d/global_common.conf    //全局配置文件\nglobal {\n\tusage-count no;     #是否参加DRBD使用统计，默认为yes。官方统计drbd的装机量\n}\ncommon {\n    protocol C;    #使用DRBD的同步协议\n\thandlers {\n\t}\n\tstartup {\n\t}\n\toptions {\n\t}\n\tdisk {\n                on-io-error detach;    #配置I/O错误处理策略为分离\n\t}\n\tnet {\n\t}\n    syncer {\n                rate 30M;     #设置主备节点同步时的网络速率\n    }\n}\n\n# vim /etc/drbd.d/r0.res    #创建资源\nresource r0 {\n    on drbd1.cluster.com {\n        device    /dev/drbd0;    #drbd1服务器上的DRBD虚拟块设备，事先不要格式化\n        disk      /dev/sdb1;\n        address   192.168.1.31:7789;    #DRBD监听的地址和端口，端口可以自定义。\n        meta-disk internal;\n    }\n\n    on drbd2.cluster.com {\n        device    /dev/drbd0;    #drbd2服务器上的DRBD虚拟块设备，事先不要格式化\n        disk      /dev/sdb1;\n        address   192.168.1.32:7789;\n        meta-disk internal;\n    }\n}\n```\n\n7）在两台服务器上分别启用`r0`资源（两台服务器上同样操作）\n```\n# drbdadm create-md r0\ninitializing activity log\ninitializing bitmap (320 KB) to all zero\nWriting meta data...\nNew drbd meta data block successfully created.\n\n# 启动drbd(注意：需要两边服务器同时启动方能生效)\n[root@drbd1 ~]# systemctl start drbd\n[root@drbd2 ~]# systemctl start drbd\n\n# 查看状态（两台机器上都执行查看）\n# cat /proc/drbd\nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----\n    ns:0 nr:0 dw:0 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:10484380\n\n#由上面两台主机的DRBD状态查看结果里的ro:Secondary/Secondary表示两台主机的状态都是备机状态，ds是磁盘状态，\n```\n\n8）将`drbd1`服务器配置为`DRBD`的主节点，进行初始化设备同步\n```\n[root@drbd1 ~]# drbdsetup /dev/drbd0 primary --force\n[root@drbd1 ~]# cat /proc/drbd \nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----\n    ns:2418688 nr:0 dw:0 dr:2420808 al:8 bm:0 lo:0 pe:1 ua:0 ap:0 ep:1 wo:f oos:8066716\n\t[===>................] sync'ed: 23.1% (7876/10236)M\n\tfinish: 0:03:08 speed: 42,792 (37,776) K/sec\n###同步完成时状态如下\n[root@drbd1 ~]# cat /proc/drbd     #drbd1上查看\nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----\n    ns:10484380 nr:0 dw:0 dr:10486500 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n[root@drbd2 ~]# cat /proc/drbd     #drbd2上查看\nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Secondary/Primary ds:UpToDate/UpToDate C r-----\n    ns:0 nr:10484380 dw:10484380 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n\n#说明：\nro在主从服务器上分别显示 Primary/Secondary和Secondary/Primary\nds显示UpToDate/UpToDate 表示主从配置成功\n```\n\n9）挂载`DRBD`（`drbd1`主节点服务器上操作）\n```\n#先格式化/dev/drbd0\n[root@drbd1 ~]# mkfs.ext4 /dev/drbd0\n\n#创建挂载目录，然后进行挂载\n[root@drbd1 ~]# mkdir /data\n[root@drbd1 ~]# mount /dev/drbd0 /data\n[root@drbd1 ~]# df -h\n文件系统                 容量  已用  可用 已用% 挂载点\n/dev/mapper/centos-root   20G  3.7G   16G   20% /\ndevtmpfs                 471M     0  471M    0% /dev\ntmpfs                    487M     0  487M    0% /dev/shm\ntmpfs                    487M  7.1M  480M    2% /run\ntmpfs                    487M     0  487M    0% /sys/fs/cgroup\n/dev/sda1                497M  193M  305M   39% /boot\ntmpfs                     98M     0   98M    0% /run/user/0\n/dev/drbd0               9.8G   37M  9.2G    1% /data\n\n特别注意：\n从节点(Secondary)上不允许对DRBD设备进行任何操作，包括只读，所有的读写操作只能在主节点(Primary)上进行。\n只有当主节点(Primary)挂掉时，从节点(Secondary)才能提示为主节点(Primary)。\n```\n\n## DRBD主备故障切换测试\n>模拟主节点(`drbd1.cluster.com`）发生故障，从节点（`drbd2.cluster.com`）接管并提升为主节点。\n\n1）主节点上操作\n```\n# 创建测试文件并取消挂载\n[root@drbd1 ~]# cd /data/\n[root@drbd1 data]# touch test01 test02 test03\n[root@drbd1 data]# cd \n[root@drbd1 ~]# umount /data\n\n[root@drbd1 ~]# drbdsetup /dev/drbd0 secondary        //将主节点设置为DRBD的备节点。在实际生产环境中，直接在(Secondary）节点上提权（即设置为主节点）即可。\n[root@drbd1 ~]# cat /proc/drbd \nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----\n    ns:10783808 nr:0 dw:299428 dr:10488701 al:82 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n\n注意：这里实际生产环境若Primary主节点宕机，在Secondary状态信息中ro的值会显示为Secondary/Unknown,只需要进行DRBD提权操作即可。\n```\n\n2）备节点上操作\n```\n[root@drbd2 ~]# drbdsetup /dev/drbd0 primary\n[root@drbd2 ~]# cat /proc/drbd \nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----\n    ns:0 nr:10783808 dw:10783808 dr:2120 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n\n#挂载验证数据\n[root@drbd2 ~]# mkdir /data\n[root@drbd2 ~]# mount /dev/drbd0 /data\n[root@drbd2 ~]# df -h\n文件系统                 容量  已用  可用 已用% 挂载点\n/dev/mapper/centos-root   20G  3.7G   16G   20% /\ndevtmpfs                 471M     0  471M    0% /dev\ntmpfs                    487M     0  487M    0% /dev/shm\ntmpfs                    487M  7.1M  480M    2% /run\ntmpfs                    487M     0  487M    0% /sys/fs/cgroup\n/dev/sda1                497M  193M  305M   39% /boot\ntmpfs                     98M     0   98M    0% /run/user/0\n/dev/drbd0               9.8G   37M  9.2G    1% /data\n\n[root@drbd2 ~]# cd /data/\n[root@drbd2 data]# ls\ntest01  test02  test03\n```\n\n到此，`DRBD`的主从环境的部署工作已经完成。不过上面是记录的是主备手动切换，至于保证`DRBD`主从结构的智能切换，实现高可用，还需里用到`Keepalived`或`Heartbeat`来实现了（会在`DRBD`主端挂掉的情况下，自动切换从端为主端并自动挂载`/data`分区）\n\n# 相关配置操作\n## 资源的连接状态详细介绍\n如何查看资源连接状态？\n```\n[root@drbd1 ~]# drbdadm cstate r0    #r0为资源名称\nConnected\n```\n资源的连接状态；一个资源可能有一下连接状态的一种\n```\n StandAlone 独立的：网络配置不可用；资源还没有被连接或是被管理断开（使用 drbdadm disconnect 命令），或是由于出现认证失败或是脑裂的情况 \n Disconnecting 断开：断开只是临时状态，下一个状态是StandAlone独立的 modprobe drbd\n Unconnected 悬空：是尝试连接前的临时状态，可能下一个状态为WFconnection和WFReportParams \n Timeout 超时：与对等节点连接超时，也是临时状态，下一个状态为Unconected悬空 \n BrokerPipe：与对等节点连接丢失，也是临时状态，下一个状态为Unconected悬空 \n NetworkFailure：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空 \n ProtocolError：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空 \n TearDown 拆解：临时状态，对等节点关闭，下一个状态为Unconected悬空 \n WFConnection：等待和对等节点建立网络连接 \n WFReportParams：已经建立TCP连接，本节点等待从对等节点传来的第一个网络包 \n Connected 连接：DRBD已经建立连接，数据镜像现在可用，节点处于正常状态 \n StartingSyncS：完全同步，有管理员发起的刚刚开始同步，未来可能的状态为SyncSource或PausedSyncS \n StartingSyncT：完全同步，有管理员发起的刚刚开始同步，下一状态为WFSyncUUID \n WFBitMapS：部分同步刚刚开始，下一步可能的状态为SyncSource或PausedSyncS \n WFBitMapT：部分同步刚刚开始，下一步可能的状态为WFSyncUUID \n WFSyncUUID：同步即将开始，下一步可能的状态为SyncTarget或PausedSyncT \n SyncSource：以本节点为同步源的同步正在进行 \n SyncTarget：以本节点为同步目标的同步正在进行 \n PausedSyncS：以本地节点是一个持续同步的源，但是目前同步已经暂停，可能是因为另外一个同步正在进行或是使用命令(drbdadm pause-sync)暂停了同步 \n PausedSyncT：以本地节点为持续同步的目标，但是目前同步已经暂停，这可以是因为另外一个同步正在进行或是使用命令(drbdadm pause-sync)暂停了同步 \n VerifyS：以本地节点为验证源的线上设备验证正在执行 \n VerifyT：以本地节点为验证目标的线上设备验证正在执行 \n```\n\n## 资源角色\n查看资源角色命令\n```\n[root@drbd1 ~]# drbdadm role r0\nSecondary/Primary\n[root@drbd1 ~]# cat /proc/drbd \nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Secondary/Primary ds:UpToDate/UpToDate C r-----\n    ns:10783808 nr:24 dw:299452 dr:10488701 al:82 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n\n注释：\nParimary 主：资源目前为主，并且可能正在被读取或写入，如果不是双主只会出现在两个节点中的其中一个节点上 \nSecondary 次：资源目前为次，正常接收对等节点的更新 \nUnknown 未知：资源角色目前未知，本地的资源不会出现这种状态\n```\n\n## 硬盘数据状态\n查看硬盘状态命令\n```\n[root@drbd1 ~]# drbdadm dstate r0\nUpToDate/UpToDate\n```\n本地和对等节点的硬盘有可能为下列状态之一：\n```\n Diskless 无盘：本地没有块设备分配给DRBD使用，这表示没有可用的设备，或者使用drbdadm命令手工分离或是底层的I/O错误导致自动分离 \n Attaching：读取无数据时候的瞬间状态 \n Failed 失败：本地块设备报告I/O错误的下一个状态，其下一个状态为Diskless无盘 \n Negotiating：在已经连接的DRBD设置进行Attach读取无数据前的瞬间状态 \n Inconsistent：数据是不一致的，在两个节点上（初始的完全同步前）这种状态出现后立即创建一个新的资源。此外，在同步期间（同步目标）在一个节点上出现这种状态 \n Outdated：数据资源是一致的，但是已经过时 \n DUnknown：当对等节点网络连接不可用时出现这种状态 \n Consistent：一个没有连接的节点数据一致，当建立连接时，它决定数据是UpToDate或是Outdated \n UpToDate：一致的最新的数据状态，这个状态为正常状态\n```","source":"_posts/网络RAID技术DRBD.md","raw":"---\ntitle: 网络RAID技术DRBD\ndate: 2019-08-08 15:00:35\ntags: Storage\ncategories: Storage\ncopyright: true\n---\n# DRBD简介\n[官方文档](https://docs.linbit.com/docs/users-guide-8.4/)\n\n>DRBD的全称为：`Distributed Replicated Block Device(DRBD)`分布式块设备复制，`DRBD`是由内核模块和相关脚本构成，用以构建高可用的集群。其实现方式是通过网络来镜像整个设备。可以把它看作是一种网络`RAID`。它允许用户在远程机器上建立一个本地块设备的实时镜像。\n\n## DRBD是如何工作的\n> `（DRBD Primary）`负责接收数据，把数据写到本地磁盘并发送给另一台主机`（DRBD Secondary）`。另一个主机再将数据存到自己的磁盘中。目前，`DRBD`每次只允许对一个节点进行读写访问，但这对于通常的故障切换高可用集群来说已经足够用了，有可能以后的版本支持两个节点进行读写存取。\n> `DRBD`协议说明\n> 1）数据一旦写入磁盘并发送到网络中就认为完成了写入操作。\n> 2）收到接收确认就认为完成了写入操作。\n> 3）收到写入确认就认为完成了写入操作。\n\n## DRBD与HA的关系\n>一个`DRBD`系统由两个节点构成，与`HA`集群类似，也有主节点和备用节点之分，在带有主要设备的节点上，应用程序和操作系统可以运行和访问`DRBD`设备`（/dev/drbd*）`。在主节点写入的数据通过`DRBD`设备存储到主节点的设备写入到备用节点的磁盘中。现在大部分的高可用性集群都会使用共享存储，而`DRBD`也可以作为一个共享存储设备，使用`DRBD`不需要太多的硬件的设备。因为它在`TCP/IP`网络中运行，所以，利用`DRBD`作为共享存储设备，节约很多成本，因为价格要比专用的存储网络便宜很多；其性能与稳定性方面也不错。\n\n# DRBD工作原理\n>`DRBD`是`linux`的内核的存储层中的一个分布式存储系统，可用使用`DRBD`在两台`Linux`服务器之间共享块设备，共享文件系统和数据。类似网络`RAID-1`，其工作的原理架构图如下：\n\n![image.png](网络RAID技术DRBD/01.jpg)\n\n# DRBD的特性\n>分布式复制块设备（`DRBD`技术）是一种基于软件的，无共享，复制的存储解决方案，在服务器之间的对块设备（硬盘、分区、逻辑卷等）进行镜像。\n>`DRBD`镜像数据的特性：\n>1）实时性：当某个应用程序完成对数据的修改时，复制功能立即发生\n>2）透明性：应用程序的数据存储在镜像块设备上是独立透明的，他们的数据在两个节点上都保存一份，因此，无论哪一台服务器宕机，都不会影响应用程序读取数据的操作，所以说是透明的。\n>3）同步镜像和异步镜像：同步镜像表示当应用程序提交本地的写操作后，数据会同步写到两个节点上去；异步镜像表示当应用程序提交写操作后，只有当本地的节点上完成写操作后，另一个节点才可以完成写操作。\n\n# DRBD的模式\n>`DRBD`共有2种模式，一种是`DRBD的主从模式`，另一种是`DRBD的双主模式`\n>**1）DRBD的主从模式：**\n>   这种模式下，其中一个节点作为主节点，另一个节点作为从节点。其中主节点可以执行读、写操作；从节点不可以挂载文件系统，因此也不可以执行读写操作。在这种模式下，资源在任何时间只能存储在主节点上。这种模式可用在任何的文件系统（`ext3、ext4、xfs`）等。默认这种模式下，一旦主节点发生故障，从节点需要手工将资源进行转移，且主节点变成从节点和从节点变成主节点需要手动进行切换。不能自动进行转移，因此比较麻烦。\n>为了解决手动将资源和节点进行转移，可以将`DRBD`做成高可用集群的资源代理`（RA）`，这样一旦其中的一个节点宕机，资源就会自动转移到另一个节点，从而保证服务的连续性。\n>**2）DRBD的双主模式:**\n>这是`DRBD8.0`之后的新特性，在双主模式下，任何资源在任何特定的时间都存在两个主节点。这种模式需要一个共享的集群文件系统，利用分布式的锁机制进行管理，如`GFS`和`OCFS2`。部署双主模式时，`DRBD`可以是负载均衡的集群，这就需要从两个并发的主节点中选取一个首选的访问数据。这种模式默认是禁用的，如果要是用的话必须在配置文件中进行申明。\n\n# DRBD的复制模式\n>`DRBD`的复制功能就是将应用程序提交的数据一份保存在本地节点，一份复制传输保存在另一份节点上。但是`DRBD`需要对传输的数据进行确认以便保证另一个节点的写操作完成，就需要用到`DRBD`的复制模式，`DRBD`有三种复制模式：\n\n**1）协议A：异步复制协议**\n>一旦本地磁盘写入已经完成，数据包已在发送队列中，则写被认为是完成的。在一个节点上发生故障时，可能发生数据丢失，因为被写入到远程节点上的数据可能仍在发送队列。尽管，在故障转移节点上的数据是一致的，但没有及时更新。这通常是用于地理上分开的节点。\n\n**2）协议B：内存同步（半同步）复制协议**\n>一旦本地磁盘写入已完成且复制数据包达到了对等节点则认为写在主节点上被认为是完成的。数据丢失可能发生在参加的两个节点同时故障的情况下，因为在传输中的数据可能不会被提交到磁盘。\n\n**3）协议C：同步复制协议**\n>只有在本地和远程节点的磁盘已经确认了写操作完成，写才被认为完成。没有任何数据丢失，所以这是一个集群节点的流行模式，但`I/O`吞吐量依赖于网络带宽。一般使用`协议C`，但选择`C协议`将影响流量，从而影响网络延迟。为了数据可靠性，我们在生产环境使用时须慎重选择使用哪一种协议。\n\n# DRBD配置文件说明\n```\nDRBD的主配置文件为/etc/drbd.conf；为了管理的便捷性，\n目前通常会将配置文件分成多个部分，且都保存至/etc/drbd.d目录中，主配置文件中仅使用\"include\"指令将这些配置文件片断整合起来。通常，/etc/drbd.d目录中的配置文件\n为global_common.conf和所有以.res结尾的文件。其中global_common.conf中主要定义global段和common段，而每一个.res的文件用于定义一个资源。\n  \n在配置文件中，global段仅能出现一次，且如果所有的配置信息都保存至同一个配置文件中而不分开为多个文件的话，global段必须位于配置文件的最开始处。目前global段中\n可以定义的参数仅有minor-count, dialog-refresh, disable-ip-verification和usage-count。\n  \ncommon段则用于定义被每一个资源默认继承的参数，可以在资源定义中使用的参数都可以在common段中定义。实际应用中，common段并非必须，但建议将多个资源共享的参数定\n义为common段中的参数以降低配置文件的复杂度。\n  \nresource段则用于定义DRBD资源，每个资源通常定义在一个单独的位于/etc/drbd.d目录中的以.res结尾的文件中。资源在定义时必须为其命名，名字可以由非空白的ASCII字符\n组成。每一个资源段的定义中至少要包含两个host子段，以定义此资源关联至的节点，其它参数均可以从common段或DRBD的默认中进行继承而无须定义。\n  \nDRBD配置文件\n[root@drbd1 ~]# cat /etc/drbd.d/global_common.conf\nglobal {\n usage-count yes;         //是否参加DRBD使用者统计，默认是参加\n # minor-count dialog-refresh disable-ip-verification  //这里是global可以使用的参数\n #minor-count：32         //从（设备）个数，取值范围1~255，默认值为32。该选项设定了允许定义的resource个数，当要定义的resource超过了此选项的设定时，需要重新载入DRBD内核模块。\n #disable-ip-verification：no   //是否禁用ip检查\n   \n}\ncommon {\n protocol C;      //指定复制协议,复制协议共有三种，为协议A，B，C，默认协议为协议C\n handlers {       //该配置段用来定义一系列处理器，用来回应特定事件。\n  # These are EXAMPLE handlers only.\n  # They may have severe implications,\n  # like hard resetting the node under certain circumstances.\n  # Be careful when chosing your poison.\n  # pri-on-incon-degr \"/usr/lib/DRBD/notify-pri-on-incon-degr.sh; /usr/lib/DRBD/notify-emergency-reboot.sh; echo b > /proc/sysrq-trigger ; reboot -f\";\n  # pri-lost-after-sb \"/usr/lib/DRBD/notify-pri-lost-after-sb.sh; /usr/lib/DRBD/notify-emergency-reboot.sh; echo b > /proc/sysrq-trigger ; reboot -f\";\n  # local-io-error \"/usr/lib/DRBD/notify-io-error.sh; /usr/lib/DRBD/notify-emergency-shutdown.sh; echo o > /proc/sysrq-trigger ; halt -f\";\n  # fence-peer \"/usr/lib/DRBD/crm-fence-peer.sh\";\n  # split-brain \"/usr/lib/DRBD/notify-split-brain.sh root\";\n  # out-of-sync \"/usr/lib/DRBD/notify-out-of-sync.sh root\";\n  # before-resync-target \"/usr/lib/DRBD/snapshot-resync-target-lvm.sh -p 15 -- -c 16k\";\n  # after-resync-target /usr/lib/DRBD/unsnapshot-resync-target-lvm.sh;\n }\n startup {    //#DRBD同步时使用的验证方式和密码。该配置段用来更加精细地调节DRBD属性，它作用于配置节点在启动或重启时。常用选项有：\n  # wfc-timeout degr-wfc-timeout outdated-wfc-timeout wait-after-sb\n  wfc-timeout：  //该选项设定一个时间值，单位是秒。在启用DRBD块时，初始化脚本DRBD会阻塞启动进程的运行，直到对等节点的出现。该选项就是用来限制这个等待时间的，默认为0，即不限制，永远等待。\n  degr-wfc-timeout：  //该选项也设定一个时间值，单位为秒。也是用于限制等待时间，只是作用的情形不同：它作用于一个降级集群（即那些只剩下一个节点的集群）在重启时的等待时间。\n  outdated-wfc-timeout：  //同上，也是用来设定等待时间，单位为秒。它用于设定等待过期节点的时间\n }\n disk {\n  # on-io-error fencing use-bmbv no-disk-barrier no-disk-flushes   //这里是disk段内可以定义的参数\n  # no-disk-drain no-md-flushes max-bio-bvecs                      //这里是disk段内可以定义的参数\n  on-io-error： detach      //选项：此选项设定了一个策略，如果底层设备向上层设备报告发生I/O错误，将按照该策略进行处理。有效的策略包括：\n    detach      //发生I/O错误的节点将放弃底层设备，以diskless mode继续工作。在diskless mode下，只要还有网络连接，DRBD将从secondary node读写数据，而不需要failover（故障转移）。该策略会导致一定的损失，但好处也很明显，DRBD服务不会中断。官方推荐和默认策略。\n    pass_on       //把I/O错误报告给上层设备。如果错误发生在primary节点，把它报告给文件系统，由上层设备处理这些错误（例如，它会导致文件系统以只读方式重新挂载），它可能会导致DRBD停止提供服务；如果发生在secondary节点，则忽略该错误（因为secondary节点没有上层设备可以报告）。该策略曾经是默认策略，但现在已被detach所取代。\n    call-local-io-error   //调用预定义的本地local-io-error脚本进行处理。该策略需要在resource（或common）配置段的handlers部分，预定义一个相应的local-io-error命令调用。该策略完全由管理员通过local-io-error命令（或脚本）调用来控制如何处理I/O错误。\n  fencing：               //该选项设定一个策略来避免split brain的状况。有效的策略包括：\n    dont-care：  //默认策略。不采取任何隔离措施。\n    resource-only：   //在此策略下，如果一个节点处于split brain状态，它将尝试隔离对端节点的磁盘。这个操作通过调用fence-peer处理器来实现。fence-peer处理器将通过其它通信路径到达对等节点，并在这个对等节点上调用DRBDadm outdate res命令\n    resource-and-stonith：   //在此策略下，如果一个节点处于split brain状态，它将停止I/O操作，并调用fence-peer处理器。处理器通过其它通信路径到达对等节点，并在这个对等节点上调用DRBDadm outdate res命令。如果无法到达对等节点，它将向对等端发送关机命令。一旦问题解决，I/O操作将重新进行。如果处理器失败，你可以使用resume-io命令来重新开始I/O操作。\n    \n }\n net {        //该配置段用来精细地调节DRBD的属性，网络相关的属性。常用的选项有：\n  # sndbuf-size rcvbuf-size timeout connect-int ping-int ping-timeout max-buffers     //这里是net段内可以定义的参数\n  # max-epoch-size ko-count allow-two-primaries cram-hmac-alg shared-secret      //这里是net段内可以定义的参数\n  # after-sb-0pri after-sb-1pri after-sb-2pri data-integrity-alg no-tcp-cork      //这里是net段内可以定义的参数\n  sndbuf-size：     //该选项用来调节TCP send buffer的大小，DRBD 8.2.7以前的版本，默认值为0，意味着自动调节大小；新版本的DRBD的默认值为128KiB。高吞吐量的网络（例如专用的千兆网卡，或负载均衡中绑定的连接）中，增加到512K比较合适，或者可以更高，但是最好不要超过2M。\n  timeout：        //该选项设定一个时间值，单位为0.1秒。如果搭档节点没有在此时间内发来应答包，那么就认为搭档节点已经死亡，因此将断开这次TCP/IP连接。默认值为60，即6秒。该选项的值必须小于connect-int和ping-int的值。\n  connect-int：     //如果无法立即连接上远程DRBD设备，系统将断续尝试连接。该选项设定的就是两次尝试间隔时间。单位为秒，默认值为10秒。\n  ping-timeout：    //该选项设定一个时间值，单位是0.1秒。如果对端节点没有在此时间内应答keep-alive包，它将被认为已经死亡。默认值是500ms。\n  max-buffers：     //该选项设定一个由DRBD分配的最大请求数，单位是页面大小（PAGE_SIZE），大多数系统中，页面大小为4KB。这些buffer用来存储那些即将写入磁盘的数据。最小值为32（即128KB）。这个值大一点好。\n  max-epoch-size：    //该选项设定了两次write barriers之间最大的数据块数。如果选项的值小于10，将影响系统性能。大一点好\n  ko-count：     //该选项设定一个值，把该选项设定的值 乘以 timeout设定的值，得到一个数字N，如果secondary节点没有在此时间内完成单次写请求，它将从集群中被移除（即，primary node进入StandAlong模式）。取值范围0~200，默认值为0，即禁用该功能。\n  allow-two-primaries：   //这个是DRBD8.0及以后版本才支持的新特性，允许一个集群中有两个primary node。该模式需要特定文件系统的支撑，目前只有OCFS2和GFS可以，传统的ext3、ext4、xfs等都不行！\n  cram-hmac-alg：    //该选项可以用来指定HMAC算法来启用对端节点授权。DRBD强烈建议启用对端点授权机制。可以指定/proc/crypto文件中识别的任一算法。必须在此指定算法，以明确启用对端节点授权机制，实现数据加密传输。\n  shared-secret：    //该选项用来设定在对端节点授权中使用的密码，最长64个字符。\n  data-integrity-alg：   //该选项设定内核支持的一个算法，用于网络上的用户数据的一致性校验。通常的数据一致性校验，由TCP/IP头中所包含的16位校验和来进行，而该选项可以使用内核所支持的任一算法。该功能默认关闭。\n }\n syncer {       //该配置段用来更加精细地调节服务的同步进程。常用选项有\n  # rate after al-extents use-rle cpu-mask verify-alg csums-alg\n  rate：    //设置同步时的速率，默认为250KB。默认的单位是KB/sec，也允许使用K、M和G，如40M。注意：syncer中的速率是以bytes，而不是bits来设定的。配置文件中的这个选项设置的速率是永久性的，但可使用下列命令临时地改变rate的值：DRBDsetup /dev/DRBDN syncer -r 100M。如果想重新恢复成drbd.conf配置文件中设定的速率，执行如下命令： DRBDadm adjust resource\n  verify-alg：    //该选项指定一个用于在线校验的算法，内核一般都会支持md5、sha1和crc32c校验算法。在线校验默认关闭，必须在此选项设定参数，以明确启用在线设备校验。DRBD支持在线设备校验，它以一种高效的方式对不同节点的数据进行一致性校验。在线校验会影响CPU负载和使用，但影响比较轻微。DRBD 8.2.5及以后版本支持此功能。一旦启用了该功能，你就可以使用下列命令进行一个在线校验： DRBDadm verify resource。该命令对指定的resource进行检验，如果检测到有数据块没有同步，它会标记这些块，并往内核日志中写入一条信息。这个过程不会影响正在使用该设备的程序。\n                    如果检测到未同步的块，当检验结束后，你就可以如下命令重新同步它们：DRBDadm disconnect resource   or   DRBDadm connetc resource\n }\n}\n  \ncommon段是用来定义共享的资源参数，以减少资源定义的重复性。common段是非必须的。resource段一般为DRBD上每一个节点来定义其资源参数的。\n资源配置文件详解 \n  \n  \n[root@drbd1 ~]# cat /etc/drbd.d/web.res\nresource web {       //web为资源名称\n on ha1.xsl.com {                       //on后面为节点的名称,有几个节点就有几个on段，这里是定义节点ha1.xsl.com上的资源\n  device   /dev/DRBD0;       //定义DRBD虚拟块设备，这个设备事先不要格式化。\n  disk /dev/sda6;        //定义存储磁盘为/dev/sda6,该分区创建完成之后就行了，不要进行格式化操作\n  address 192.168.108.199:7789;      //定义DRBD监听的地址和端口，以便和对端进行通信\n  meta-disk  internal;       //该参数有2个选项：internal和externally，其中internal表示将元数据和数据存储在同一个磁盘上；而externally表示将元数据和数据分开存储，元数据被放在另一个磁盘上。\n }\n on ha2.xsl.com {        //这里是定义节点ha2.xsl.com上的资源\n  device /dev/DRBD0;\n  disk /dev/sda6;\n  address 192.168.108.201:7789;\n  meta-disk internal;\n }\n}\n```\n\n\n# DRBD安装配置（主从模式）\n**环境说明**\n>这里使用所用环境为`centos7.4`操作系统\n>在下面的操作步骤中`# command`的命令表示主从节点服务器都需要执行。\n\n| IP           | 主机名            | 角色说明 |\n| ------------ | ----------------- | -------- |\n| 192.168.1.31 | drbd1.cluster.com | 主服务器 |\n| 192.168.1.32 | drbd2.cluster.com | 从服务器 |\n\n## 具体步骤\n1）两台机器上添加`DRBD`磁盘，进行分区，不做格式化，并在本地系统创建`/data`目录，不做挂载操作\n```\n在drbd1服务器上操作\n[root@drbd1 ~]# lsblk \n......\nsdb               8:16   0   10G  0 disk\n[root@drbd1 ~]# fdisk /dev/sdb\n依次输入\"n->p->1->回车->回车-w\"\n\n在drbd2服务器上操作\n[root@drbd2 ~]# lsblk \n......\nsdb               8:16   0   10G  0 disk\n[root@drbd2 ~]# fdisk /dev/sdb\n依次输入\"n->p->1->回车->回车-w\"\n```\n\n2）两台服务器之间的防火墙要允许互相访问，这里测试关闭`selinux`和防火墙(两台服务器同样操作)\n```\n# systemctl stop firewalld\n# setenforce 0     //临时性关闭；永久关闭需修改/etc/sysconfig/selinux的SELINUX为disable\n```\n\n3）`hosts`绑定（两台服务器同样操作）\n```\n# vim /etc/hosts\n192.168.1.31    drbd1.cluster.com\n192.168.1.32    drbd2.cluster.com\n```\n\n4）两台服务器进行时间同步（两台服务器同样操作）\n```\n# yum -y install ntpdate\n# ntpdate -u asia.pool.ntp.org\n```\n\n5）`DRBD`安装配置（两台服务器同样操作）\n```\n这里使用yum方式安装\n# rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\n# yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm\n# yum -y install kmod-drbd84 drbd86-utils \n\n因为在执行yum -y install kmod-drbd84 drbd86-utils时，对内核kernel进行了update，要重新启动服务器，更新后的内核才会生效。\n加载模块：\n# reboot\n# modprobe drbd\n查看模块是否已添加上\n# lsmod |grep drbd\ndrbd                  397041  0 \nlibcrc32c              12644  4 xfs,drbd,nf_nat,nf_conntrack\n```\n\n6）`DRBD`配置（两台服务器上同样操作）\n```\n# cat /etc/drbd.conf     //主配置文件\n# You can find an example in  /usr/share/doc/drbd.../drbd.conf.example\n\ninclude \"drbd.d/global_common.conf\";\ninclude \"drbd.d/*.res\";\n\n备份配置文件\n# cp /etc/drbd.d/global_common.conf{,.bak} \n# vim /etc/drbd.d/global_common.conf    //全局配置文件\nglobal {\n\tusage-count no;     #是否参加DRBD使用统计，默认为yes。官方统计drbd的装机量\n}\ncommon {\n    protocol C;    #使用DRBD的同步协议\n\thandlers {\n\t}\n\tstartup {\n\t}\n\toptions {\n\t}\n\tdisk {\n                on-io-error detach;    #配置I/O错误处理策略为分离\n\t}\n\tnet {\n\t}\n    syncer {\n                rate 30M;     #设置主备节点同步时的网络速率\n    }\n}\n\n# vim /etc/drbd.d/r0.res    #创建资源\nresource r0 {\n    on drbd1.cluster.com {\n        device    /dev/drbd0;    #drbd1服务器上的DRBD虚拟块设备，事先不要格式化\n        disk      /dev/sdb1;\n        address   192.168.1.31:7789;    #DRBD监听的地址和端口，端口可以自定义。\n        meta-disk internal;\n    }\n\n    on drbd2.cluster.com {\n        device    /dev/drbd0;    #drbd2服务器上的DRBD虚拟块设备，事先不要格式化\n        disk      /dev/sdb1;\n        address   192.168.1.32:7789;\n        meta-disk internal;\n    }\n}\n```\n\n7）在两台服务器上分别启用`r0`资源（两台服务器上同样操作）\n```\n# drbdadm create-md r0\ninitializing activity log\ninitializing bitmap (320 KB) to all zero\nWriting meta data...\nNew drbd meta data block successfully created.\n\n# 启动drbd(注意：需要两边服务器同时启动方能生效)\n[root@drbd1 ~]# systemctl start drbd\n[root@drbd2 ~]# systemctl start drbd\n\n# 查看状态（两台机器上都执行查看）\n# cat /proc/drbd\nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----\n    ns:0 nr:0 dw:0 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:10484380\n\n#由上面两台主机的DRBD状态查看结果里的ro:Secondary/Secondary表示两台主机的状态都是备机状态，ds是磁盘状态，\n```\n\n8）将`drbd1`服务器配置为`DRBD`的主节点，进行初始化设备同步\n```\n[root@drbd1 ~]# drbdsetup /dev/drbd0 primary --force\n[root@drbd1 ~]# cat /proc/drbd \nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----\n    ns:2418688 nr:0 dw:0 dr:2420808 al:8 bm:0 lo:0 pe:1 ua:0 ap:0 ep:1 wo:f oos:8066716\n\t[===>................] sync'ed: 23.1% (7876/10236)M\n\tfinish: 0:03:08 speed: 42,792 (37,776) K/sec\n###同步完成时状态如下\n[root@drbd1 ~]# cat /proc/drbd     #drbd1上查看\nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----\n    ns:10484380 nr:0 dw:0 dr:10486500 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n[root@drbd2 ~]# cat /proc/drbd     #drbd2上查看\nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Secondary/Primary ds:UpToDate/UpToDate C r-----\n    ns:0 nr:10484380 dw:10484380 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n\n#说明：\nro在主从服务器上分别显示 Primary/Secondary和Secondary/Primary\nds显示UpToDate/UpToDate 表示主从配置成功\n```\n\n9）挂载`DRBD`（`drbd1`主节点服务器上操作）\n```\n#先格式化/dev/drbd0\n[root@drbd1 ~]# mkfs.ext4 /dev/drbd0\n\n#创建挂载目录，然后进行挂载\n[root@drbd1 ~]# mkdir /data\n[root@drbd1 ~]# mount /dev/drbd0 /data\n[root@drbd1 ~]# df -h\n文件系统                 容量  已用  可用 已用% 挂载点\n/dev/mapper/centos-root   20G  3.7G   16G   20% /\ndevtmpfs                 471M     0  471M    0% /dev\ntmpfs                    487M     0  487M    0% /dev/shm\ntmpfs                    487M  7.1M  480M    2% /run\ntmpfs                    487M     0  487M    0% /sys/fs/cgroup\n/dev/sda1                497M  193M  305M   39% /boot\ntmpfs                     98M     0   98M    0% /run/user/0\n/dev/drbd0               9.8G   37M  9.2G    1% /data\n\n特别注意：\n从节点(Secondary)上不允许对DRBD设备进行任何操作，包括只读，所有的读写操作只能在主节点(Primary)上进行。\n只有当主节点(Primary)挂掉时，从节点(Secondary)才能提示为主节点(Primary)。\n```\n\n## DRBD主备故障切换测试\n>模拟主节点(`drbd1.cluster.com`）发生故障，从节点（`drbd2.cluster.com`）接管并提升为主节点。\n\n1）主节点上操作\n```\n# 创建测试文件并取消挂载\n[root@drbd1 ~]# cd /data/\n[root@drbd1 data]# touch test01 test02 test03\n[root@drbd1 data]# cd \n[root@drbd1 ~]# umount /data\n\n[root@drbd1 ~]# drbdsetup /dev/drbd0 secondary        //将主节点设置为DRBD的备节点。在实际生产环境中，直接在(Secondary）节点上提权（即设置为主节点）即可。\n[root@drbd1 ~]# cat /proc/drbd \nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----\n    ns:10783808 nr:0 dw:299428 dr:10488701 al:82 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n\n注意：这里实际生产环境若Primary主节点宕机，在Secondary状态信息中ro的值会显示为Secondary/Unknown,只需要进行DRBD提权操作即可。\n```\n\n2）备节点上操作\n```\n[root@drbd2 ~]# drbdsetup /dev/drbd0 primary\n[root@drbd2 ~]# cat /proc/drbd \nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----\n    ns:0 nr:10783808 dw:10783808 dr:2120 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n\n#挂载验证数据\n[root@drbd2 ~]# mkdir /data\n[root@drbd2 ~]# mount /dev/drbd0 /data\n[root@drbd2 ~]# df -h\n文件系统                 容量  已用  可用 已用% 挂载点\n/dev/mapper/centos-root   20G  3.7G   16G   20% /\ndevtmpfs                 471M     0  471M    0% /dev\ntmpfs                    487M     0  487M    0% /dev/shm\ntmpfs                    487M  7.1M  480M    2% /run\ntmpfs                    487M     0  487M    0% /sys/fs/cgroup\n/dev/sda1                497M  193M  305M   39% /boot\ntmpfs                     98M     0   98M    0% /run/user/0\n/dev/drbd0               9.8G   37M  9.2G    1% /data\n\n[root@drbd2 ~]# cd /data/\n[root@drbd2 data]# ls\ntest01  test02  test03\n```\n\n到此，`DRBD`的主从环境的部署工作已经完成。不过上面是记录的是主备手动切换，至于保证`DRBD`主从结构的智能切换，实现高可用，还需里用到`Keepalived`或`Heartbeat`来实现了（会在`DRBD`主端挂掉的情况下，自动切换从端为主端并自动挂载`/data`分区）\n\n# 相关配置操作\n## 资源的连接状态详细介绍\n如何查看资源连接状态？\n```\n[root@drbd1 ~]# drbdadm cstate r0    #r0为资源名称\nConnected\n```\n资源的连接状态；一个资源可能有一下连接状态的一种\n```\n StandAlone 独立的：网络配置不可用；资源还没有被连接或是被管理断开（使用 drbdadm disconnect 命令），或是由于出现认证失败或是脑裂的情况 \n Disconnecting 断开：断开只是临时状态，下一个状态是StandAlone独立的 modprobe drbd\n Unconnected 悬空：是尝试连接前的临时状态，可能下一个状态为WFconnection和WFReportParams \n Timeout 超时：与对等节点连接超时，也是临时状态，下一个状态为Unconected悬空 \n BrokerPipe：与对等节点连接丢失，也是临时状态，下一个状态为Unconected悬空 \n NetworkFailure：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空 \n ProtocolError：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空 \n TearDown 拆解：临时状态，对等节点关闭，下一个状态为Unconected悬空 \n WFConnection：等待和对等节点建立网络连接 \n WFReportParams：已经建立TCP连接，本节点等待从对等节点传来的第一个网络包 \n Connected 连接：DRBD已经建立连接，数据镜像现在可用，节点处于正常状态 \n StartingSyncS：完全同步，有管理员发起的刚刚开始同步，未来可能的状态为SyncSource或PausedSyncS \n StartingSyncT：完全同步，有管理员发起的刚刚开始同步，下一状态为WFSyncUUID \n WFBitMapS：部分同步刚刚开始，下一步可能的状态为SyncSource或PausedSyncS \n WFBitMapT：部分同步刚刚开始，下一步可能的状态为WFSyncUUID \n WFSyncUUID：同步即将开始，下一步可能的状态为SyncTarget或PausedSyncT \n SyncSource：以本节点为同步源的同步正在进行 \n SyncTarget：以本节点为同步目标的同步正在进行 \n PausedSyncS：以本地节点是一个持续同步的源，但是目前同步已经暂停，可能是因为另外一个同步正在进行或是使用命令(drbdadm pause-sync)暂停了同步 \n PausedSyncT：以本地节点为持续同步的目标，但是目前同步已经暂停，这可以是因为另外一个同步正在进行或是使用命令(drbdadm pause-sync)暂停了同步 \n VerifyS：以本地节点为验证源的线上设备验证正在执行 \n VerifyT：以本地节点为验证目标的线上设备验证正在执行 \n```\n\n## 资源角色\n查看资源角色命令\n```\n[root@drbd1 ~]# drbdadm role r0\nSecondary/Primary\n[root@drbd1 ~]# cat /proc/drbd \nversion: 8.4.11-1 (api:1/proto:86-101)\nGIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@, 2018-11-03 01:26:55\n 0: cs:Connected ro:Secondary/Primary ds:UpToDate/UpToDate C r-----\n    ns:10783808 nr:24 dw:299452 dr:10488701 al:82 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n\n注释：\nParimary 主：资源目前为主，并且可能正在被读取或写入，如果不是双主只会出现在两个节点中的其中一个节点上 \nSecondary 次：资源目前为次，正常接收对等节点的更新 \nUnknown 未知：资源角色目前未知，本地的资源不会出现这种状态\n```\n\n## 硬盘数据状态\n查看硬盘状态命令\n```\n[root@drbd1 ~]# drbdadm dstate r0\nUpToDate/UpToDate\n```\n本地和对等节点的硬盘有可能为下列状态之一：\n```\n Diskless 无盘：本地没有块设备分配给DRBD使用，这表示没有可用的设备，或者使用drbdadm命令手工分离或是底层的I/O错误导致自动分离 \n Attaching：读取无数据时候的瞬间状态 \n Failed 失败：本地块设备报告I/O错误的下一个状态，其下一个状态为Diskless无盘 \n Negotiating：在已经连接的DRBD设置进行Attach读取无数据前的瞬间状态 \n Inconsistent：数据是不一致的，在两个节点上（初始的完全同步前）这种状态出现后立即创建一个新的资源。此外，在同步期间（同步目标）在一个节点上出现这种状态 \n Outdated：数据资源是一致的，但是已经过时 \n DUnknown：当对等节点网络连接不可用时出现这种状态 \n Consistent：一个没有连接的节点数据一致，当建立连接时，它决定数据是UpToDate或是Outdated \n UpToDate：一致的最新的数据状态，这个状态为正常状态\n```","slug":"网络RAID技术DRBD","published":1,"updated":"2019-10-24T09:12:16.899Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck24hnl8y00004dnrqq7fnoi4","content":"<h1 id=\"DRBD简介\"><a href=\"#DRBD简介\" class=\"headerlink\" title=\"DRBD简介\"></a>DRBD简介</h1><p><a href=\"https://docs.linbit.com/docs/users-guide-8.4/\" target=\"_blank\" rel=\"noopener\">官方文档</a></p>\n<blockquote>\n<p>DRBD的全称为：<code>Distributed Replicated Block Device(DRBD)</code>分布式块设备复制，<code>DRBD</code>是由内核模块和相关脚本构成，用以构建高可用的集群。其实现方式是通过网络来镜像整个设备。可以把它看作是一种网络<code>RAID</code>。它允许用户在远程机器上建立一个本地块设备的实时镜像。</p>\n</blockquote>\n<h2 id=\"DRBD是如何工作的\"><a href=\"#DRBD是如何工作的\" class=\"headerlink\" title=\"DRBD是如何工作的\"></a>DRBD是如何工作的</h2><blockquote>\n<p><code>（DRBD Primary）</code>负责接收数据，把数据写到本地磁盘并发送给另一台主机<code>（DRBD Secondary）</code>。另一个主机再将数据存到自己的磁盘中。目前，<code>DRBD</code>每次只允许对一个节点进行读写访问，但这对于通常的故障切换高可用集群来说已经足够用了，有可能以后的版本支持两个节点进行读写存取。<br><code>DRBD</code>协议说明<br>1）数据一旦写入磁盘并发送到网络中就认为完成了写入操作。<br>2）收到接收确认就认为完成了写入操作。<br>3）收到写入确认就认为完成了写入操作。</p>\n</blockquote>\n<h2 id=\"DRBD与HA的关系\"><a href=\"#DRBD与HA的关系\" class=\"headerlink\" title=\"DRBD与HA的关系\"></a>DRBD与HA的关系</h2><blockquote>\n<p>一个<code>DRBD</code>系统由两个节点构成，与<code>HA</code>集群类似，也有主节点和备用节点之分，在带有主要设备的节点上，应用程序和操作系统可以运行和访问<code>DRBD</code>设备<code>（/dev/drbd*）</code>。在主节点写入的数据通过<code>DRBD</code>设备存储到主节点的设备写入到备用节点的磁盘中。现在大部分的高可用性集群都会使用共享存储，而<code>DRBD</code>也可以作为一个共享存储设备，使用<code>DRBD</code>不需要太多的硬件的设备。因为它在<code>TCP/IP</code>网络中运行，所以，利用<code>DRBD</code>作为共享存储设备，节约很多成本，因为价格要比专用的存储网络便宜很多；其性能与稳定性方面也不错。</p>\n</blockquote>\n<h1 id=\"DRBD工作原理\"><a href=\"#DRBD工作原理\" class=\"headerlink\" title=\"DRBD工作原理\"></a>DRBD工作原理</h1><blockquote>\n<p><code>DRBD</code>是<code>linux</code>的内核的存储层中的一个分布式存储系统，可用使用<code>DRBD</code>在两台<code>Linux</code>服务器之间共享块设备，共享文件系统和数据。类似网络<code>RAID-1</code>，其工作的原理架构图如下：</p>\n</blockquote>\n<p><img src=\"/2019/08/08/网络RAID技术DRBD/01.jpg\" alt=\"image.png\"></p>\n<h1 id=\"DRBD的特性\"><a href=\"#DRBD的特性\" class=\"headerlink\" title=\"DRBD的特性\"></a>DRBD的特性</h1><blockquote>\n<p>分布式复制块设备（<code>DRBD</code>技术）是一种基于软件的，无共享，复制的存储解决方案，在服务器之间的对块设备（硬盘、分区、逻辑卷等）进行镜像。<br><code>DRBD</code>镜像数据的特性：<br>1）实时性：当某个应用程序完成对数据的修改时，复制功能立即发生<br>2）透明性：应用程序的数据存储在镜像块设备上是独立透明的，他们的数据在两个节点上都保存一份，因此，无论哪一台服务器宕机，都不会影响应用程序读取数据的操作，所以说是透明的。<br>3）同步镜像和异步镜像：同步镜像表示当应用程序提交本地的写操作后，数据会同步写到两个节点上去；异步镜像表示当应用程序提交写操作后，只有当本地的节点上完成写操作后，另一个节点才可以完成写操作。</p>\n</blockquote>\n<h1 id=\"DRBD的模式\"><a href=\"#DRBD的模式\" class=\"headerlink\" title=\"DRBD的模式\"></a>DRBD的模式</h1><blockquote>\n<p><code>DRBD</code>共有2种模式，一种是<code>DRBD的主从模式</code>，另一种是<code>DRBD的双主模式</code><br><strong>1）DRBD的主从模式：</strong><br>  这种模式下，其中一个节点作为主节点，另一个节点作为从节点。其中主节点可以执行读、写操作；从节点不可以挂载文件系统，因此也不可以执行读写操作。在这种模式下，资源在任何时间只能存储在主节点上。这种模式可用在任何的文件系统（<code>ext3、ext4、xfs</code>）等。默认这种模式下，一旦主节点发生故障，从节点需要手工将资源进行转移，且主节点变成从节点和从节点变成主节点需要手动进行切换。不能自动进行转移，因此比较麻烦。<br>为了解决手动将资源和节点进行转移，可以将<code>DRBD</code>做成高可用集群的资源代理<code>（RA）</code>，这样一旦其中的一个节点宕机，资源就会自动转移到另一个节点，从而保证服务的连续性。<br><strong>2）DRBD的双主模式:</strong><br>这是<code>DRBD8.0</code>之后的新特性，在双主模式下，任何资源在任何特定的时间都存在两个主节点。这种模式需要一个共享的集群文件系统，利用分布式的锁机制进行管理，如<code>GFS</code>和<code>OCFS2</code>。部署双主模式时，<code>DRBD</code>可以是负载均衡的集群，这就需要从两个并发的主节点中选取一个首选的访问数据。这种模式默认是禁用的，如果要是用的话必须在配置文件中进行申明。</p>\n</blockquote>\n<h1 id=\"DRBD的复制模式\"><a href=\"#DRBD的复制模式\" class=\"headerlink\" title=\"DRBD的复制模式\"></a>DRBD的复制模式</h1><blockquote>\n<p><code>DRBD</code>的复制功能就是将应用程序提交的数据一份保存在本地节点，一份复制传输保存在另一份节点上。但是<code>DRBD</code>需要对传输的数据进行确认以便保证另一个节点的写操作完成，就需要用到<code>DRBD</code>的复制模式，<code>DRBD</code>有三种复制模式：</p>\n</blockquote>\n<p><strong>1）协议A：异步复制协议</strong></p>\n<blockquote>\n<p>一旦本地磁盘写入已经完成，数据包已在发送队列中，则写被认为是完成的。在一个节点上发生故障时，可能发生数据丢失，因为被写入到远程节点上的数据可能仍在发送队列。尽管，在故障转移节点上的数据是一致的，但没有及时更新。这通常是用于地理上分开的节点。</p>\n</blockquote>\n<p><strong>2）协议B：内存同步（半同步）复制协议</strong></p>\n<blockquote>\n<p>一旦本地磁盘写入已完成且复制数据包达到了对等节点则认为写在主节点上被认为是完成的。数据丢失可能发生在参加的两个节点同时故障的情况下，因为在传输中的数据可能不会被提交到磁盘。</p>\n</blockquote>\n<p><strong>3）协议C：同步复制协议</strong></p>\n<blockquote>\n<p>只有在本地和远程节点的磁盘已经确认了写操作完成，写才被认为完成。没有任何数据丢失，所以这是一个集群节点的流行模式，但<code>I/O</code>吞吐量依赖于网络带宽。一般使用<code>协议C</code>，但选择<code>C协议</code>将影响流量，从而影响网络延迟。为了数据可靠性，我们在生产环境使用时须慎重选择使用哪一种协议。</p>\n</blockquote>\n<h1 id=\"DRBD配置文件说明\"><a href=\"#DRBD配置文件说明\" class=\"headerlink\" title=\"DRBD配置文件说明\"></a>DRBD配置文件说明</h1><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DRBD的主配置文件为/etc/drbd.<span class=\"keyword\">conf</span>；为了管理的便捷性，</span><br><span class=\"line\">目前通常会将配置文件分成多个部分，且都保存至/etc/drbd.<span class=\"keyword\">d</span>目录中，主配置文件中仅使用<span class=\"string\">\"include\"</span>指令将这些配置文件片断整合起来。通常，/etc/drbd.<span class=\"keyword\">d</span>目录中的配置文件</span><br><span class=\"line\">为global_common.<span class=\"keyword\">conf</span>和所有以.res结尾的文件。其中global_common.<span class=\"keyword\">conf</span>中主要定义<span class=\"keyword\">global</span>段和common段，而每一个.res的文件用于定义一个资源。</span><br><span class=\"line\">  </span><br><span class=\"line\">在配置文件中，<span class=\"keyword\">global</span>段仅能出现一次，且如果所有的配置信息都保存至同一个配置文件中而不分开为多个文件的话，<span class=\"keyword\">global</span>段必须位于配置文件的最开始处。目前<span class=\"keyword\">global</span>段中</span><br><span class=\"line\">可以定义的参数仅有minor-<span class=\"keyword\">count</span>, dialog-refresh, disable-ip-verification和usage-<span class=\"keyword\">count</span>。</span><br><span class=\"line\">  </span><br><span class=\"line\">common段则用于定义被每一个资源默认继承的参数，可以在资源定义中使用的参数都可以在common段中定义。实际应用中，common段并非必须，但建议将多个资源共享的参数定</span><br><span class=\"line\">义为common段中的参数以降低配置文件的复杂度。</span><br><span class=\"line\">  </span><br><span class=\"line\">resource段则用于定义DRBD资源，每个资源通常定义在一个单独的位于/etc/drbd.<span class=\"keyword\">d</span>目录中的以.res结尾的文件中。资源在定义时必须为其命名，名字可以由非空白的ASCII字符</span><br><span class=\"line\">组成。每一个资源段的定义中至少要包含两个host子段，以定义此资源关联至的节点，其它参数均可以从common段或DRBD的默认中进行继承而无须定义。</span><br><span class=\"line\">  </span><br><span class=\"line\">DRBD配置文件</span><br><span class=\"line\">[root@drbd1 ~]# <span class=\"keyword\">cat</span> /etc/drbd.<span class=\"keyword\">d</span>/global_common.<span class=\"keyword\">conf</span></span><br><span class=\"line\"><span class=\"keyword\">global</span> &#123;</span><br><span class=\"line\"> usage-<span class=\"keyword\">count</span> yes;         <span class=\"comment\">//是否参加DRBD使用者统计，默认是参加</span></span><br><span class=\"line\"> # minor-<span class=\"keyword\">count</span> dialog-refresh disable-ip-verification  <span class=\"comment\">//这里是global可以使用的参数</span></span><br><span class=\"line\"> #minor-<span class=\"keyword\">count</span>：32         <span class=\"comment\">//从（设备）个数，取值范围1~255，默认值为32。该选项设定了允许定义的resource个数，当要定义的resource超过了此选项的设定时，需要重新载入DRBD内核模块。</span></span><br><span class=\"line\"> #disable-ip-verification：<span class=\"keyword\">no</span>   <span class=\"comment\">//是否禁用ip检查</span></span><br><span class=\"line\">   </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">common &#123;</span><br><span class=\"line\"> protocol C;      <span class=\"comment\">//指定复制协议,复制协议共有三种，为协议A，B，C，默认协议为协议C</span></span><br><span class=\"line\"> handlers &#123;       <span class=\"comment\">//该配置段用来定义一系列处理器，用来回应特定事件。</span></span><br><span class=\"line\">  # These are EXAMPLE handlers only.</span><br><span class=\"line\">  # They may have severe implications,</span><br><span class=\"line\">  # like hard resetting the node under certain circumstances.</span><br><span class=\"line\">  # Be careful when chosing your poison.</span><br><span class=\"line\">  # pri-<span class=\"keyword\">on</span>-incon-degr <span class=\"string\">\"/usr/lib/DRBD/notify-pri-on-incon-degr.sh; /usr/lib/DRBD/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f\"</span>;</span><br><span class=\"line\">  # pri-lost-after-sb <span class=\"string\">\"/usr/lib/DRBD/notify-pri-lost-after-sb.sh; /usr/lib/DRBD/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f\"</span>;</span><br><span class=\"line\">  # <span class=\"keyword\">local</span>-io-<span class=\"keyword\">error</span> <span class=\"string\">\"/usr/lib/DRBD/notify-io-error.sh; /usr/lib/DRBD/notify-emergency-shutdown.sh; echo o &gt; /proc/sysrq-trigger ; halt -f\"</span>;</span><br><span class=\"line\">  # fence-peer <span class=\"string\">\"/usr/lib/DRBD/crm-fence-peer.sh\"</span>;</span><br><span class=\"line\">  # <span class=\"keyword\">split</span>-brain <span class=\"string\">\"/usr/lib/DRBD/notify-split-brain.sh root\"</span>;</span><br><span class=\"line\">  # <span class=\"keyword\">out</span>-of-sync <span class=\"string\">\"/usr/lib/DRBD/notify-out-of-sync.sh root\"</span>;</span><br><span class=\"line\">  # before-resync-target <span class=\"string\">\"/usr/lib/DRBD/snapshot-resync-target-lvm.sh -p 15 -- -c 16k\"</span>;</span><br><span class=\"line\">  # after-resync-target /usr/lib/DRBD/unsnapshot-resync-target-lvm.<span class=\"keyword\">sh</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> startup &#123;    <span class=\"comment\">//#DRBD同步时使用的验证方式和密码。该配置段用来更加精细地调节DRBD属性，它作用于配置节点在启动或重启时。常用选项有：</span></span><br><span class=\"line\">  # wfc-timeout degr-wfc-timeout outdated-wfc-timeout wait-after-sb</span><br><span class=\"line\">  wfc-timeout：  <span class=\"comment\">//该选项设定一个时间值，单位是秒。在启用DRBD块时，初始化脚本DRBD会阻塞启动进程的运行，直到对等节点的出现。该选项就是用来限制这个等待时间的，默认为0，即不限制，永远等待。</span></span><br><span class=\"line\">  degr-wfc-timeout：  <span class=\"comment\">//该选项也设定一个时间值，单位为秒。也是用于限制等待时间，只是作用的情形不同：它作用于一个降级集群（即那些只剩下一个节点的集群）在重启时的等待时间。</span></span><br><span class=\"line\">  outdated-wfc-timeout：  <span class=\"comment\">//同上，也是用来设定等待时间，单位为秒。它用于设定等待过期节点的时间</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> disk &#123;</span><br><span class=\"line\">  # <span class=\"keyword\">on</span>-io-<span class=\"keyword\">error</span> fencing <span class=\"keyword\">use</span>-bmbv <span class=\"keyword\">no</span>-disk-barrier <span class=\"keyword\">no</span>-disk-flushes   <span class=\"comment\">//这里是disk段内可以定义的参数</span></span><br><span class=\"line\">  # <span class=\"keyword\">no</span>-disk-drain <span class=\"keyword\">no</span>-md-flushes max-bio-bvecs                      <span class=\"comment\">//这里是disk段内可以定义的参数</span></span><br><span class=\"line\">  <span class=\"keyword\">on</span>-io-<span class=\"keyword\">error</span>： detach      <span class=\"comment\">//选项：此选项设定了一个策略，如果底层设备向上层设备报告发生I/O错误，将按照该策略进行处理。有效的策略包括：</span></span><br><span class=\"line\">    detach      <span class=\"comment\">//发生I/O错误的节点将放弃底层设备，以diskless mode继续工作。在diskless mode下，只要还有网络连接，DRBD将从secondary node读写数据，而不需要failover（故障转移）。该策略会导致一定的损失，但好处也很明显，DRBD服务不会中断。官方推荐和默认策略。</span></span><br><span class=\"line\">    pass_on       <span class=\"comment\">//把I/O错误报告给上层设备。如果错误发生在primary节点，把它报告给文件系统，由上层设备处理这些错误（例如，它会导致文件系统以只读方式重新挂载），它可能会导致DRBD停止提供服务；如果发生在secondary节点，则忽略该错误（因为secondary节点没有上层设备可以报告）。该策略曾经是默认策略，但现在已被detach所取代。</span></span><br><span class=\"line\">    call-<span class=\"keyword\">local</span>-io-<span class=\"keyword\">error</span>   <span class=\"comment\">//调用预定义的本地local-io-error脚本进行处理。该策略需要在resource（或common）配置段的handlers部分，预定义一个相应的local-io-error命令调用。该策略完全由管理员通过local-io-error命令（或脚本）调用来控制如何处理I/O错误。</span></span><br><span class=\"line\">  fencing：               <span class=\"comment\">//该选项设定一个策略来避免split brain的状况。有效的策略包括：</span></span><br><span class=\"line\">    dont-care：  <span class=\"comment\">//默认策略。不采取任何隔离措施。</span></span><br><span class=\"line\">    resource-only：   <span class=\"comment\">//在此策略下，如果一个节点处于split brain状态，它将尝试隔离对端节点的磁盘。这个操作通过调用fence-peer处理器来实现。fence-peer处理器将通过其它通信路径到达对等节点，并在这个对等节点上调用DRBDadm outdate res命令</span></span><br><span class=\"line\">    resource-and-stonith：   <span class=\"comment\">//在此策略下，如果一个节点处于split brain状态，它将停止I/O操作，并调用fence-peer处理器。处理器通过其它通信路径到达对等节点，并在这个对等节点上调用DRBDadm outdate res命令。如果无法到达对等节点，它将向对等端发送关机命令。一旦问题解决，I/O操作将重新进行。如果处理器失败，你可以使用resume-io命令来重新开始I/O操作。</span></span><br><span class=\"line\">    </span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">net</span> &#123;        <span class=\"comment\">//该配置段用来精细地调节DRBD的属性，网络相关的属性。常用的选项有：</span></span><br><span class=\"line\">  # sndbuf-size rcvbuf-size timeout connect-int ping-int ping-timeout max-buffers     <span class=\"comment\">//这里是net段内可以定义的参数</span></span><br><span class=\"line\">  # max-epoch-size ko-<span class=\"keyword\">count</span> allow-<span class=\"keyword\">two</span>-primaries cram-hmac-alg shared-secret      <span class=\"comment\">//这里是net段内可以定义的参数</span></span><br><span class=\"line\">  # after-sb-0pri after-sb-1pri after-sb-2pri data-integrity-alg <span class=\"keyword\">no</span>-tcp-cork      <span class=\"comment\">//这里是net段内可以定义的参数</span></span><br><span class=\"line\">  sndbuf-size：     <span class=\"comment\">//该选项用来调节TCP send buffer的大小，DRBD 8.2.7以前的版本，默认值为0，意味着自动调节大小；新版本的DRBD的默认值为128KiB。高吞吐量的网络（例如专用的千兆网卡，或负载均衡中绑定的连接）中，增加到512K比较合适，或者可以更高，但是最好不要超过2M。</span></span><br><span class=\"line\">  timeout：        <span class=\"comment\">//该选项设定一个时间值，单位为0.1秒。如果搭档节点没有在此时间内发来应答包，那么就认为搭档节点已经死亡，因此将断开这次TCP/IP连接。默认值为60，即6秒。该选项的值必须小于connect-int和ping-int的值。</span></span><br><span class=\"line\">  connect-int：     <span class=\"comment\">//如果无法立即连接上远程DRBD设备，系统将断续尝试连接。该选项设定的就是两次尝试间隔时间。单位为秒，默认值为10秒。</span></span><br><span class=\"line\">  ping-timeout：    <span class=\"comment\">//该选项设定一个时间值，单位是0.1秒。如果对端节点没有在此时间内应答keep-alive包，它将被认为已经死亡。默认值是500ms。</span></span><br><span class=\"line\">  max-buffers：     <span class=\"comment\">//该选项设定一个由DRBD分配的最大请求数，单位是页面大小（PAGE_SIZE），大多数系统中，页面大小为4KB。这些buffer用来存储那些即将写入磁盘的数据。最小值为32（即128KB）。这个值大一点好。</span></span><br><span class=\"line\">  max-epoch-size：    <span class=\"comment\">//该选项设定了两次write barriers之间最大的数据块数。如果选项的值小于10，将影响系统性能。大一点好</span></span><br><span class=\"line\">  ko-<span class=\"keyword\">count</span>：     <span class=\"comment\">//该选项设定一个值，把该选项设定的值 乘以 timeout设定的值，得到一个数字N，如果secondary节点没有在此时间内完成单次写请求，它将从集群中被移除（即，primary node进入StandAlong模式）。取值范围0~200，默认值为0，即禁用该功能。</span></span><br><span class=\"line\">  allow-<span class=\"keyword\">two</span>-primaries：   <span class=\"comment\">//这个是DRBD8.0及以后版本才支持的新特性，允许一个集群中有两个primary node。该模式需要特定文件系统的支撑，目前只有OCFS2和GFS可以，传统的ext3、ext4、xfs等都不行！</span></span><br><span class=\"line\">  cram-hmac-alg：    <span class=\"comment\">//该选项可以用来指定HMAC算法来启用对端节点授权。DRBD强烈建议启用对端点授权机制。可以指定/proc/crypto文件中识别的任一算法。必须在此指定算法，以明确启用对端节点授权机制，实现数据加密传输。</span></span><br><span class=\"line\">  shared-secret：    <span class=\"comment\">//该选项用来设定在对端节点授权中使用的密码，最长64个字符。</span></span><br><span class=\"line\">  data-integrity-alg：   <span class=\"comment\">//该选项设定内核支持的一个算法，用于网络上的用户数据的一致性校验。通常的数据一致性校验，由TCP/IP头中所包含的16位校验和来进行，而该选项可以使用内核所支持的任一算法。该功能默认关闭。</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> syncer &#123;       <span class=\"comment\">//该配置段用来更加精细地调节服务的同步进程。常用选项有</span></span><br><span class=\"line\">  # rate after al-extents <span class=\"keyword\">use</span>-rle cpu-mask verify-alg csums-alg</span><br><span class=\"line\">  rate：    <span class=\"comment\">//设置同步时的速率，默认为250KB。默认的单位是KB/sec，也允许使用K、M和G，如40M。注意：syncer中的速率是以bytes，而不是bits来设定的。配置文件中的这个选项设置的速率是永久性的，但可使用下列命令临时地改变rate的值：DRBDsetup /dev/DRBDN syncer -r 100M。如果想重新恢复成drbd.conf配置文件中设定的速率，执行如下命令： DRBDadm adjust resource</span></span><br><span class=\"line\">  verify-alg：    <span class=\"comment\">//该选项指定一个用于在线校验的算法，内核一般都会支持md5、sha1和crc32c校验算法。在线校验默认关闭，必须在此选项设定参数，以明确启用在线设备校验。DRBD支持在线设备校验，它以一种高效的方式对不同节点的数据进行一致性校验。在线校验会影响CPU负载和使用，但影响比较轻微。DRBD 8.2.5及以后版本支持此功能。一旦启用了该功能，你就可以使用下列命令进行一个在线校验： DRBDadm verify resource。该命令对指定的resource进行检验，如果检测到有数据块没有同步，它会标记这些块，并往内核日志中写入一条信息。这个过程不会影响正在使用该设备的程序。</span></span><br><span class=\"line\">                    如果检测到未同步的块，当检验结束后，你就可以如下命令重新同步它们：DRBDadm disconnect resource   or   DRBDadm connetc resource</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">common段是用来定义共享的资源参数，以减少资源定义的重复性。common段是非必须的。resource段一般为DRBD上每一个节点来定义其资源参数的。</span><br><span class=\"line\">资源配置文件详解 </span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">[root@drbd1 ~]# <span class=\"keyword\">cat</span> /etc/drbd.<span class=\"keyword\">d</span>/web.res</span><br><span class=\"line\">resource web &#123;       <span class=\"comment\">//web为资源名称</span></span><br><span class=\"line\"> <span class=\"keyword\">on</span> ha1.xsl.com &#123;                       <span class=\"comment\">//on后面为节点的名称,有几个节点就有几个on段，这里是定义节点ha1.xsl.com上的资源</span></span><br><span class=\"line\">  device   /dev/DRBD0;       <span class=\"comment\">//定义DRBD虚拟块设备，这个设备事先不要格式化。</span></span><br><span class=\"line\">  disk /dev/sda6;        <span class=\"comment\">//定义存储磁盘为/dev/sda6,该分区创建完成之后就行了，不要进行格式化操作</span></span><br><span class=\"line\">  address 192.168.108.199:7789;      <span class=\"comment\">//定义DRBD监听的地址和端口，以便和对端进行通信</span></span><br><span class=\"line\">  meta-disk  internal;       <span class=\"comment\">//该参数有2个选项：internal和externally，其中internal表示将元数据和数据存储在同一个磁盘上；而externally表示将元数据和数据分开存储，元数据被放在另一个磁盘上。</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">on</span> ha2.xsl.com &#123;        <span class=\"comment\">//这里是定义节点ha2.xsl.com上的资源</span></span><br><span class=\"line\">  device /dev/DRBD0;</span><br><span class=\"line\">  disk /dev/sda6;</span><br><span class=\"line\">  address 192.168.108.201:7789;</span><br><span class=\"line\">  meta-disk internal;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"DRBD安装配置（主从模式）\"><a href=\"#DRBD安装配置（主从模式）\" class=\"headerlink\" title=\"DRBD安装配置（主从模式）\"></a>DRBD安装配置（主从模式）</h1><p><strong>环境说明</strong></p>\n<blockquote>\n<p>这里使用所用环境为<code>centos7.4</code>操作系统<br>在下面的操作步骤中<code># command</code>的命令表示主从节点服务器都需要执行。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>IP</th>\n<th>主机名</th>\n<th>角色说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>192.168.1.31</td>\n<td>drbd1.cluster.com</td>\n<td>主服务器</td>\n</tr>\n<tr>\n<td>192.168.1.32</td>\n<td>drbd2.cluster.com</td>\n<td>从服务器</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"具体步骤\"><a href=\"#具体步骤\" class=\"headerlink\" title=\"具体步骤\"></a>具体步骤</h2><p>1）两台机器上添加<code>DRBD</code>磁盘，进行分区，不做格式化，并在本地系统创建<code>/data</code>目录，不做挂载操作<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在drbd1服务器上操作</span><br><span class=\"line\">[root@drbd1 ~]# lsblk </span><br><span class=\"line\">......</span><br><span class=\"line\">sdb               8:16   0   10G  0 disk</span><br><span class=\"line\">[root@drbd1 ~]# fdisk /dev/sdb</span><br><span class=\"line\">依次输入\"n-&gt;p-&gt;1-&gt;回车-&gt;回车-w\"</span><br><span class=\"line\"></span><br><span class=\"line\">在drbd2服务器上操作</span><br><span class=\"line\">[root@drbd2 ~]# lsblk </span><br><span class=\"line\">......</span><br><span class=\"line\">sdb               8:16   0   10G  0 disk</span><br><span class=\"line\">[root@drbd2 ~]# fdisk /dev/sdb</span><br><span class=\"line\">依次输入\"n-&gt;p-&gt;1-&gt;回车-&gt;回车-w\"</span><br></pre></td></tr></table></figure></p>\n<p>2）两台服务器之间的防火墙要允许互相访问，这里测试关闭<code>selinux</code>和防火墙(两台服务器同样操作)<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># systemctl stop firewalld</span></span><br><span class=\"line\"><span class=\"meta\"># setenforce 0     //临时性关闭；永久关闭需修改/etc/sysconfig/selinux的SELINUX为disable</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>hosts</code>绑定（两台服务器同样操作）<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># vim /etc/hosts</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span>    drbd1.cluster.com</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span>    drbd2.cluster.com</span><br></pre></td></tr></table></figure></p>\n<p>4）两台服务器进行时间同步（两台服务器同样操作）<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install ntpdate</span></span><br><span class=\"line\"><span class=\"meta\"># ntpdate -u asia.pool.ntp.org</span></span><br></pre></td></tr></table></figure></p>\n<p>5）<code>DRBD</code>安装配置（两台服务器同样操作）<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这里使用yum方式安装</span><br><span class=\"line\"><span class=\"meta\"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span><br><span class=\"line\"><span class=\"meta\"># yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span></span><br><span class=\"line\"><span class=\"meta\"># yum -y install kmod-drbd84 drbd86-utils </span></span><br><span class=\"line\"></span><br><span class=\"line\">因为在执行yum -y install kmod-drbd84 drbd86-utils时，对内核kernel进行了update，要重新启动服务器，更新后的内核才会生效。</span><br><span class=\"line\">加载模块：</span><br><span class=\"line\"><span class=\"meta\"># reboot</span></span><br><span class=\"line\"><span class=\"meta\"># modprobe drbd</span></span><br><span class=\"line\">查看模块是否已添加上</span><br><span class=\"line\"><span class=\"meta\"># lsmod |grep drbd</span></span><br><span class=\"line\">drbd                  <span class=\"number\">397041</span>  <span class=\"number\">0</span> </span><br><span class=\"line\">libcrc32c              <span class=\"number\">12644</span>  <span class=\"number\">4</span> xfs,drbd,nf_nat,nf_conntrack</span><br></pre></td></tr></table></figure></p>\n<p>6）<code>DRBD</code>配置（两台服务器上同样操作）<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cat /etc/drbd.conf     //主配置文件</span></span><br><span class=\"line\"><span class=\"comment\"># You can find an example in  /usr/share/doc/drbd.../drbd.conf.example</span></span><br><span class=\"line\"></span><br><span class=\"line\">include <span class=\"string\">\"drbd.d/global_common.conf\"</span>;</span><br><span class=\"line\">include <span class=\"string\">\"drbd.d/*.res\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">备份配置文件</span><br><span class=\"line\"><span class=\"comment\"># cp /etc/drbd.d/global_common.conf&#123;,.bak&#125; </span></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/drbd.d/global_common.conf    //全局配置文件</span></span><br><span class=\"line\">global &#123;</span><br><span class=\"line\">\tusage-count <span class=\"literal\">no</span>;     #是否参加DRBD使用统计，默认为<span class=\"literal\">yes</span>。官方统计drbd的装机量</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">common &#123;</span><br><span class=\"line\">    protocol C;    #使用DRBD的同步协议</span><br><span class=\"line\">\thandlers &#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tstartup &#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\toptions &#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tdisk &#123;</span><br><span class=\"line\">                on-io-<span class=\"builtin-name\">error</span> detach;    #配置I/O错误处理策略为分离</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tnet &#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    syncer &#123;</span><br><span class=\"line\">                rate 30M;     #设置主备节点同步时的网络速率</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/drbd.d/r0.res    #创建资源</span></span><br><span class=\"line\">resource r0 &#123;</span><br><span class=\"line\">    on drbd1.cluster.com &#123;</span><br><span class=\"line\">        device    /dev/drbd0;    #drbd1服务器上的DRBD虚拟块设备，事先不要格式化</span><br><span class=\"line\">        disk      /dev/sdb1;</span><br><span class=\"line\">       <span class=\"built_in\"> address </span>  192.168.1.31:7789;    #DRBD监听的地址和端口，端口可以自定义。</span><br><span class=\"line\">        meta-disk internal;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    on drbd2.cluster.com &#123;</span><br><span class=\"line\">        device    /dev/drbd0;    #drbd2服务器上的DRBD虚拟块设备，事先不要格式化</span><br><span class=\"line\">        disk      /dev/sdb1;</span><br><span class=\"line\">       <span class=\"built_in\"> address </span>  192.168.1.32:7789;</span><br><span class=\"line\">        meta-disk internal;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>7）在两台服务器上分别启用<code>r0</code>资源（两台服务器上同样操作）<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># <span class=\"selector-tag\">drbdadm</span> <span class=\"selector-tag\">create-md</span> <span class=\"selector-tag\">r0</span></span><br><span class=\"line\"><span class=\"selector-tag\">initializing</span> <span class=\"selector-tag\">activity</span> <span class=\"selector-tag\">log</span></span><br><span class=\"line\"><span class=\"selector-tag\">initializing</span> <span class=\"selector-tag\">bitmap</span> (<span class=\"number\">320</span> KB) <span class=\"selector-tag\">to</span> <span class=\"keyword\">all</span> <span class=\"selector-tag\">zero</span></span><br><span class=\"line\"><span class=\"selector-tag\">Writing</span> <span class=\"selector-tag\">meta</span> <span class=\"selector-tag\">data</span>...</span><br><span class=\"line\"><span class=\"selector-tag\">New</span> <span class=\"selector-tag\">drbd</span> <span class=\"selector-tag\">meta</span> <span class=\"selector-tag\">data</span> <span class=\"selector-tag\">block</span> <span class=\"selector-tag\">successfully</span> <span class=\"selector-tag\">created</span>.</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动<span class=\"selector-tag\">drbd</span>(注意：需要两边服务器同时启动方能生效)</span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">systemctl</span> <span class=\"selector-tag\">start</span> <span class=\"selector-tag\">drbd</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">systemctl</span> <span class=\"selector-tag\">start</span> <span class=\"selector-tag\">drbd</span></span><br><span class=\"line\"></span><br><span class=\"line\"># 查看状态（两台机器上都执行查看）</span><br><span class=\"line\"># <span class=\"selector-tag\">cat</span> /<span class=\"selector-tag\">proc</span>/<span class=\"selector-tag\">drbd</span></span><br><span class=\"line\"><span class=\"selector-tag\">version</span>: <span class=\"selector-tag\">8</span><span class=\"selector-class\">.4</span><span class=\"selector-class\">.11-1</span> (<span class=\"attribute\">api</span>:<span class=\"number\">1</span>/<span class=\"attribute\">proto</span>:<span class=\"number\">86</span>-<span class=\"number\">101</span>)</span><br><span class=\"line\"><span class=\"selector-tag\">GIT-hash</span>: <span class=\"selector-tag\">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"selector-tag\">build</span> <span class=\"selector-tag\">by</span> <span class=\"selector-tag\">mockbuild</span>@, <span class=\"selector-tag\">2018-11-03</span> <span class=\"selector-tag\">01</span><span class=\"selector-pseudo\">:26</span><span class=\"selector-pseudo\">:55</span></span><br><span class=\"line\"> <span class=\"selector-tag\">0</span>: <span class=\"selector-tag\">cs</span><span class=\"selector-pseudo\">:Connected</span> <span class=\"selector-tag\">ro</span><span class=\"selector-pseudo\">:Secondary</span>/<span class=\"selector-tag\">Secondary</span> <span class=\"selector-tag\">ds</span><span class=\"selector-pseudo\">:Inconsistent</span>/<span class=\"selector-tag\">Inconsistent</span> <span class=\"selector-tag\">C</span> <span class=\"selector-tag\">r-----</span></span><br><span class=\"line\">    <span class=\"selector-tag\">ns</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">nr</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">dw</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">dr</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">al</span><span class=\"selector-pseudo\">:8</span> <span class=\"selector-tag\">bm</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">lo</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">pe</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ua</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ap</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ep</span><span class=\"selector-pseudo\">:1</span> <span class=\"selector-tag\">wo</span><span class=\"selector-pseudo\">:f</span> <span class=\"selector-tag\">oos</span><span class=\"selector-pseudo\">:10484380</span></span><br><span class=\"line\"></span><br><span class=\"line\">#由上面两台主机的<span class=\"selector-tag\">DRBD</span>状态查看结果里的<span class=\"selector-tag\">ro</span><span class=\"selector-pseudo\">:Secondary</span>/<span class=\"selector-tag\">Secondary</span>表示两台主机的状态都是备机状态，<span class=\"selector-tag\">ds</span>是磁盘状态，</span><br></pre></td></tr></table></figure></p>\n<p>8）将<code>drbd1</code>服务器配置为<code>DRBD</code>的主节点，进行初始化设备同步<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@drbd1</span> <span class=\"string\">~]#</span> <span class=\"string\">drbdsetup</span> <span class=\"string\">/dev/drbd0</span> <span class=\"string\">primary</span> <span class=\"bullet\">--force</span></span><br><span class=\"line\"><span class=\"string\">[root@drbd1</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/proc/drbd</span> </span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"number\">8.4</span><span class=\"number\">.11</span><span class=\"bullet\">-1</span> <span class=\"string\">(api:1/proto:86-101)</span></span><br><span class=\"line\"><span class=\"attr\">GIT-hash:</span> <span class=\"number\">66145</span><span class=\"string\">a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"string\">build</span> <span class=\"string\">by</span> <span class=\"string\">mockbuild@,</span> <span class=\"number\">2018</span><span class=\"bullet\">-11</span><span class=\"bullet\">-03</span> <span class=\"number\">01</span><span class=\"string\">:26:55</span></span><br><span class=\"line\"> <span class=\"number\">0</span><span class=\"string\">:</span> <span class=\"attr\">cs:SyncSource</span> <span class=\"attr\">ro:Primary/Secondary</span> <span class=\"attr\">ds:UpToDate/Inconsistent</span> <span class=\"string\">C</span> <span class=\"string\">r-----</span></span><br><span class=\"line\"><span class=\"attr\">    ns:</span><span class=\"number\">2418688</span> <span class=\"attr\">nr:0</span> <span class=\"attr\">dw:0</span> <span class=\"attr\">dr:2420808</span> <span class=\"attr\">al:8</span> <span class=\"attr\">bm:0</span> <span class=\"attr\">lo:0</span> <span class=\"attr\">pe:1</span> <span class=\"attr\">ua:0</span> <span class=\"attr\">ap:0</span> <span class=\"attr\">ep:1</span> <span class=\"attr\">wo:f</span> <span class=\"attr\">oos:8066716</span></span><br><span class=\"line\">\t<span class=\"string\">[===&gt;................]</span> <span class=\"string\">sync'ed:</span> <span class=\"number\">23.1</span><span class=\"string\">%</span> <span class=\"string\">(7876/10236)M</span></span><br><span class=\"line\">\t<span class=\"attr\">finish:</span> <span class=\"number\">0</span><span class=\"string\">:03:08</span> <span class=\"attr\">speed:</span> <span class=\"number\">42</span><span class=\"string\">,792</span> <span class=\"string\">(37,776)</span> <span class=\"string\">K/sec</span></span><br><span class=\"line\"><span class=\"comment\">###同步完成时状态如下</span></span><br><span class=\"line\"><span class=\"string\">[root@drbd1</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/proc/drbd</span>     <span class=\"comment\">#drbd1上查看</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"number\">8.4</span><span class=\"number\">.11</span><span class=\"bullet\">-1</span> <span class=\"string\">(api:1/proto:86-101)</span></span><br><span class=\"line\"><span class=\"attr\">GIT-hash:</span> <span class=\"number\">66145</span><span class=\"string\">a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"string\">build</span> <span class=\"string\">by</span> <span class=\"string\">mockbuild@,</span> <span class=\"number\">2018</span><span class=\"bullet\">-11</span><span class=\"bullet\">-03</span> <span class=\"number\">01</span><span class=\"string\">:26:55</span></span><br><span class=\"line\"> <span class=\"number\">0</span><span class=\"string\">:</span> <span class=\"attr\">cs:Connected</span> <span class=\"attr\">ro:Primary/Secondary</span> <span class=\"attr\">ds:UpToDate/UpToDate</span> <span class=\"string\">C</span> <span class=\"string\">r-----</span></span><br><span class=\"line\"><span class=\"attr\">    ns:</span><span class=\"number\">10484380</span> <span class=\"attr\">nr:0</span> <span class=\"attr\">dw:0</span> <span class=\"attr\">dr:10486500</span> <span class=\"attr\">al:8</span> <span class=\"attr\">bm:0</span> <span class=\"attr\">lo:0</span> <span class=\"attr\">pe:0</span> <span class=\"attr\">ua:0</span> <span class=\"attr\">ap:0</span> <span class=\"attr\">ep:1</span> <span class=\"attr\">wo:f</span> <span class=\"attr\">oos:0</span></span><br><span class=\"line\"><span class=\"string\">[root@drbd2</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/proc/drbd</span>     <span class=\"comment\">#drbd2上查看</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"number\">8.4</span><span class=\"number\">.11</span><span class=\"bullet\">-1</span> <span class=\"string\">(api:1/proto:86-101)</span></span><br><span class=\"line\"><span class=\"attr\">GIT-hash:</span> <span class=\"number\">66145</span><span class=\"string\">a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"string\">build</span> <span class=\"string\">by</span> <span class=\"string\">mockbuild@,</span> <span class=\"number\">2018</span><span class=\"bullet\">-11</span><span class=\"bullet\">-03</span> <span class=\"number\">01</span><span class=\"string\">:26:55</span></span><br><span class=\"line\"> <span class=\"number\">0</span><span class=\"string\">:</span> <span class=\"attr\">cs:Connected</span> <span class=\"attr\">ro:Secondary/Primary</span> <span class=\"attr\">ds:UpToDate/UpToDate</span> <span class=\"string\">C</span> <span class=\"string\">r-----</span></span><br><span class=\"line\"><span class=\"attr\">    ns:</span><span class=\"number\">0</span> <span class=\"attr\">nr:10484380</span> <span class=\"attr\">dw:10484380</span> <span class=\"attr\">dr:0</span> <span class=\"attr\">al:8</span> <span class=\"attr\">bm:0</span> <span class=\"attr\">lo:0</span> <span class=\"attr\">pe:0</span> <span class=\"attr\">ua:0</span> <span class=\"attr\">ap:0</span> <span class=\"attr\">ep:1</span> <span class=\"attr\">wo:f</span> <span class=\"attr\">oos:0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#说明：</span></span><br><span class=\"line\"><span class=\"string\">ro在主从服务器上分别显示</span> <span class=\"string\">Primary/Secondary和Secondary/Primary</span></span><br><span class=\"line\"><span class=\"string\">ds显示UpToDate/UpToDate</span> <span class=\"string\">表示主从配置成功</span></span><br></pre></td></tr></table></figure></p>\n<p>9）挂载<code>DRBD</code>（<code>drbd1</code>主节点服务器上操作）<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#先格式化/dev/drbd0</span><br><span class=\"line\">[root@drbd1 ~]# mkfs.ext4 /dev/drbd0</span><br><span class=\"line\"></span><br><span class=\"line\">#创建挂载目录，然后进行挂载</span><br><span class=\"line\">[root@drbd1 ~]# mkdir /data</span><br><span class=\"line\">[root@drbd1 ~]# mount /dev/drbd0 /data</span><br><span class=\"line\">[root@drbd1 ~]# df -h</span><br><span class=\"line\">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class=\"line\">/dev/mapper/centos-root   <span class=\"number\">20</span>G  <span class=\"number\">3.7</span>G   <span class=\"number\">16</span>G   <span class=\"number\">20</span>% /</span><br><span class=\"line\">devtmpfs                 <span class=\"number\">471</span>M     <span class=\"number\">0</span>  <span class=\"number\">471</span>M    <span class=\"number\">0</span>% /dev</span><br><span class=\"line\">tmpfs                    <span class=\"number\">487</span>M     <span class=\"number\">0</span>  <span class=\"number\">487</span>M    <span class=\"number\">0</span>% /dev/shm</span><br><span class=\"line\">tmpfs                    <span class=\"number\">487</span>M  <span class=\"number\">7.1</span>M  <span class=\"number\">480</span>M    <span class=\"number\">2</span>% /run</span><br><span class=\"line\">tmpfs                    <span class=\"number\">487</span>M     <span class=\"number\">0</span>  <span class=\"number\">487</span>M    <span class=\"number\">0</span>% /sys/fs/cgroup</span><br><span class=\"line\">/dev/sda1                <span class=\"number\">497</span>M  <span class=\"number\">193</span>M  <span class=\"number\">305</span>M   <span class=\"number\">39</span>% /boot</span><br><span class=\"line\">tmpfs                     <span class=\"number\">98</span>M     <span class=\"number\">0</span>   <span class=\"number\">98</span>M    <span class=\"number\">0</span>% /run/user/<span class=\"number\">0</span></span><br><span class=\"line\">/dev/drbd0               <span class=\"number\">9.8</span>G   <span class=\"number\">37</span>M  <span class=\"number\">9.2</span>G    <span class=\"number\">1</span>% /data</span><br><span class=\"line\"></span><br><span class=\"line\">特别注意：</span><br><span class=\"line\">从节点(Secondary)上不允许对DRBD设备进行任何操作，包括只读，所有的读写操作只能在主节点(Primary)上进行。</span><br><span class=\"line\">只有当主节点(Primary)挂掉时，从节点(Secondary)才能提示为主节点(Primary)。</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"DRBD主备故障切换测试\"><a href=\"#DRBD主备故障切换测试\" class=\"headerlink\" title=\"DRBD主备故障切换测试\"></a>DRBD主备故障切换测试</h2><blockquote>\n<p>模拟主节点(<code>drbd1.cluster.com</code>）发生故障，从节点（<code>drbd2.cluster.com</code>）接管并提升为主节点。</p>\n</blockquote>\n<p>1）主节点上操作<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 创建测试文件并取消挂载</span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">cd</span> /<span class=\"selector-tag\">data</span>/</span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 data]</span># <span class=\"selector-tag\">touch</span> <span class=\"selector-tag\">test01</span> <span class=\"selector-tag\">test02</span> <span class=\"selector-tag\">test03</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 data]</span># <span class=\"selector-tag\">cd</span> </span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">umount</span> /<span class=\"selector-tag\">data</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">drbdsetup</span> /<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">drbd0</span> <span class=\"selector-tag\">secondary</span>        <span class=\"comment\">//将主节点设置为DRBD的备节点。在实际生产环境中，直接在(Secondary）节点上提权（即设置为主节点）即可。</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">cat</span> /<span class=\"selector-tag\">proc</span>/<span class=\"selector-tag\">drbd</span> </span><br><span class=\"line\"><span class=\"selector-tag\">version</span>: <span class=\"selector-tag\">8</span><span class=\"selector-class\">.4</span><span class=\"selector-class\">.11-1</span> (<span class=\"attribute\">api</span>:<span class=\"number\">1</span>/<span class=\"attribute\">proto</span>:<span class=\"number\">86</span>-<span class=\"number\">101</span>)</span><br><span class=\"line\"><span class=\"selector-tag\">GIT-hash</span>: <span class=\"selector-tag\">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"selector-tag\">build</span> <span class=\"selector-tag\">by</span> <span class=\"selector-tag\">mockbuild</span>@, <span class=\"selector-tag\">2018-11-03</span> <span class=\"selector-tag\">01</span><span class=\"selector-pseudo\">:26</span><span class=\"selector-pseudo\">:55</span></span><br><span class=\"line\"> <span class=\"selector-tag\">0</span>: <span class=\"selector-tag\">cs</span><span class=\"selector-pseudo\">:Connected</span> <span class=\"selector-tag\">ro</span><span class=\"selector-pseudo\">:Secondary</span>/<span class=\"selector-tag\">Secondary</span> <span class=\"selector-tag\">ds</span><span class=\"selector-pseudo\">:UpToDate</span>/<span class=\"selector-tag\">UpToDate</span> <span class=\"selector-tag\">C</span> <span class=\"selector-tag\">r-----</span></span><br><span class=\"line\">    <span class=\"selector-tag\">ns</span><span class=\"selector-pseudo\">:10783808</span> <span class=\"selector-tag\">nr</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">dw</span><span class=\"selector-pseudo\">:299428</span> <span class=\"selector-tag\">dr</span><span class=\"selector-pseudo\">:10488701</span> <span class=\"selector-tag\">al</span><span class=\"selector-pseudo\">:82</span> <span class=\"selector-tag\">bm</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">lo</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">pe</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ua</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ap</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ep</span><span class=\"selector-pseudo\">:1</span> <span class=\"selector-tag\">wo</span><span class=\"selector-pseudo\">:f</span> <span class=\"selector-tag\">oos</span><span class=\"selector-pseudo\">:0</span></span><br><span class=\"line\"></span><br><span class=\"line\">注意：这里实际生产环境若<span class=\"selector-tag\">Primary</span>主节点宕机，在<span class=\"selector-tag\">Secondary</span>状态信息中<span class=\"selector-tag\">ro</span>的值会显示为<span class=\"selector-tag\">Secondary</span>/<span class=\"selector-tag\">Unknown</span>,只需要进行<span class=\"selector-tag\">DRBD</span>提权操作即可。</span><br></pre></td></tr></table></figure></p>\n<p>2）备节点上操作<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">drbdsetup</span> /<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">drbd0</span> <span class=\"selector-tag\">primary</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">cat</span> /<span class=\"selector-tag\">proc</span>/<span class=\"selector-tag\">drbd</span> </span><br><span class=\"line\"><span class=\"selector-tag\">version</span>: <span class=\"selector-tag\">8</span><span class=\"selector-class\">.4</span><span class=\"selector-class\">.11-1</span> (<span class=\"attribute\">api</span>:<span class=\"number\">1</span>/<span class=\"attribute\">proto</span>:<span class=\"number\">86</span>-<span class=\"number\">101</span>)</span><br><span class=\"line\"><span class=\"selector-tag\">GIT-hash</span>: <span class=\"selector-tag\">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"selector-tag\">build</span> <span class=\"selector-tag\">by</span> <span class=\"selector-tag\">mockbuild</span>@, <span class=\"selector-tag\">2018-11-03</span> <span class=\"selector-tag\">01</span><span class=\"selector-pseudo\">:26</span><span class=\"selector-pseudo\">:55</span></span><br><span class=\"line\"> <span class=\"selector-tag\">0</span>: <span class=\"selector-tag\">cs</span><span class=\"selector-pseudo\">:Connected</span> <span class=\"selector-tag\">ro</span><span class=\"selector-pseudo\">:Primary</span>/<span class=\"selector-tag\">Secondary</span> <span class=\"selector-tag\">ds</span><span class=\"selector-pseudo\">:UpToDate</span>/<span class=\"selector-tag\">UpToDate</span> <span class=\"selector-tag\">C</span> <span class=\"selector-tag\">r-----</span></span><br><span class=\"line\">    <span class=\"selector-tag\">ns</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">nr</span><span class=\"selector-pseudo\">:10783808</span> <span class=\"selector-tag\">dw</span><span class=\"selector-pseudo\">:10783808</span> <span class=\"selector-tag\">dr</span><span class=\"selector-pseudo\">:2120</span> <span class=\"selector-tag\">al</span><span class=\"selector-pseudo\">:8</span> <span class=\"selector-tag\">bm</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">lo</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">pe</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ua</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ap</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ep</span><span class=\"selector-pseudo\">:1</span> <span class=\"selector-tag\">wo</span><span class=\"selector-pseudo\">:f</span> <span class=\"selector-tag\">oos</span><span class=\"selector-pseudo\">:0</span></span><br><span class=\"line\"></span><br><span class=\"line\">#挂载验证数据</span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">mkdir</span> /<span class=\"selector-tag\">data</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">mount</span> /<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">drbd0</span> /<span class=\"selector-tag\">data</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">df</span> <span class=\"selector-tag\">-h</span></span><br><span class=\"line\">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class=\"line\">/<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">mapper</span>/<span class=\"selector-tag\">centos-root</span>   <span class=\"selector-tag\">20G</span>  <span class=\"selector-tag\">3</span><span class=\"selector-class\">.7G</span>   <span class=\"selector-tag\">16G</span>   <span class=\"selector-tag\">20%</span> /</span><br><span class=\"line\"><span class=\"selector-tag\">devtmpfs</span>                 <span class=\"selector-tag\">471M</span>     <span class=\"selector-tag\">0</span>  <span class=\"selector-tag\">471M</span>    <span class=\"selector-tag\">0%</span> /<span class=\"selector-tag\">dev</span></span><br><span class=\"line\"><span class=\"selector-tag\">tmpfs</span>                    <span class=\"selector-tag\">487M</span>     <span class=\"selector-tag\">0</span>  <span class=\"selector-tag\">487M</span>    <span class=\"selector-tag\">0%</span> /<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">shm</span></span><br><span class=\"line\"><span class=\"selector-tag\">tmpfs</span>                    <span class=\"selector-tag\">487M</span>  <span class=\"selector-tag\">7</span><span class=\"selector-class\">.1M</span>  <span class=\"selector-tag\">480M</span>    <span class=\"selector-tag\">2%</span> /<span class=\"selector-tag\">run</span></span><br><span class=\"line\"><span class=\"selector-tag\">tmpfs</span>                    <span class=\"selector-tag\">487M</span>     <span class=\"selector-tag\">0</span>  <span class=\"selector-tag\">487M</span>    <span class=\"selector-tag\">0%</span> /<span class=\"selector-tag\">sys</span>/<span class=\"selector-tag\">fs</span>/<span class=\"selector-tag\">cgroup</span></span><br><span class=\"line\">/<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">sda1</span>                <span class=\"selector-tag\">497M</span>  <span class=\"selector-tag\">193M</span>  <span class=\"selector-tag\">305M</span>   <span class=\"selector-tag\">39%</span> /<span class=\"selector-tag\">boot</span></span><br><span class=\"line\"><span class=\"selector-tag\">tmpfs</span>                     <span class=\"selector-tag\">98M</span>     <span class=\"selector-tag\">0</span>   <span class=\"selector-tag\">98M</span>    <span class=\"selector-tag\">0%</span> /<span class=\"selector-tag\">run</span>/<span class=\"selector-tag\">user</span>/<span class=\"selector-tag\">0</span></span><br><span class=\"line\">/<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">drbd0</span>               <span class=\"selector-tag\">9</span><span class=\"selector-class\">.8G</span>   <span class=\"selector-tag\">37M</span>  <span class=\"selector-tag\">9</span><span class=\"selector-class\">.2G</span>    <span class=\"selector-tag\">1%</span> /<span class=\"selector-tag\">data</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">cd</span> /<span class=\"selector-tag\">data</span>/</span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 data]</span># <span class=\"selector-tag\">ls</span></span><br><span class=\"line\"><span class=\"selector-tag\">test01</span>  <span class=\"selector-tag\">test02</span>  <span class=\"selector-tag\">test03</span></span><br></pre></td></tr></table></figure></p>\n<p>到此，<code>DRBD</code>的主从环境的部署工作已经完成。不过上面是记录的是主备手动切换，至于保证<code>DRBD</code>主从结构的智能切换，实现高可用，还需里用到<code>Keepalived</code>或<code>Heartbeat</code>来实现了（会在<code>DRBD</code>主端挂掉的情况下，自动切换从端为主端并自动挂载<code>/data</code>分区）</p>\n<h1 id=\"相关配置操作\"><a href=\"#相关配置操作\" class=\"headerlink\" title=\"相关配置操作\"></a>相关配置操作</h1><h2 id=\"资源的连接状态详细介绍\"><a href=\"#资源的连接状态详细介绍\" class=\"headerlink\" title=\"资源的连接状态详细介绍\"></a>资源的连接状态详细介绍</h2><p>如何查看资源连接状态？<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@drbd1</span> ~]<span class=\"meta\"># drbdadm cstate r0    #r0为资源名称</span></span><br><span class=\"line\">Connected</span><br></pre></td></tr></table></figure></p>\n<p>资源的连接状态；一个资源可能有一下连接状态的一种<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">StandAlone 独立的：网络配置不可用；资源还没有被连接或是被管理断开（使用 drbdadm <span class=\"keyword\">disconnect </span>命令），或是由于出现认证失败或是脑裂的情况 </span><br><span class=\"line\"><span class=\"keyword\">Disconnecting </span>断开：断开只是临时状态，下一个状态是StandAlone独立的 modprobe drbd</span><br><span class=\"line\">Unconnected 悬空：是尝试连接前的临时状态，可能下一个状态为WFconnection和WFReportParams </span><br><span class=\"line\">Timeout 超时：与对等节点连接超时，也是临时状态，下一个状态为Unconected悬空 </span><br><span class=\"line\"><span class=\"keyword\">BrokerPipe：与对等节点连接丢失，也是临时状态，下一个状态为Unconected悬空 </span></span><br><span class=\"line\">NetworkFailure：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空 </span><br><span class=\"line\">ProtocolError：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空 </span><br><span class=\"line\">TearDown 拆解：临时状态，对等节点关闭，下一个状态为Unconected悬空 </span><br><span class=\"line\">WFConnection：等待和对等节点建立网络连接 </span><br><span class=\"line\">WFReportParams：已经建立TCP连接，本节点等待从对等节点传来的第一个网络包 </span><br><span class=\"line\">Connected 连接：DRBD已经建立连接，数据镜像现在可用，节点处于正常状态 </span><br><span class=\"line\">StartingSyncS：完全同步，有管理员发起的刚刚开始同步，未来可能的状态为<span class=\"keyword\">SyncSource或PausedSyncS </span></span><br><span class=\"line\">StartingSyncT：完全同步，有管理员发起的刚刚开始同步，下一状态为WFSyncUUID </span><br><span class=\"line\">WFBitMapS：部分同步刚刚开始，下一步可能的状态为<span class=\"keyword\">SyncSource或PausedSyncS </span></span><br><span class=\"line\">WFBitMapT：部分同步刚刚开始，下一步可能的状态为WFSyncUUID </span><br><span class=\"line\">WFSyncUUID：同步即将开始，下一步可能的状态为<span class=\"keyword\">SyncTarget或PausedSyncT </span></span><br><span class=\"line\"><span class=\"keyword\">SyncSource：以本节点为同步源的同步正在进行 </span></span><br><span class=\"line\"><span class=\"keyword\">SyncTarget：以本节点为同步目标的同步正在进行 </span></span><br><span class=\"line\"><span class=\"keyword\">PausedSyncS：以本地节点是一个持续同步的源，但是目前同步已经暂停，可能是因为另外一个同步正在进行或是使用命令(drbdadm </span><span class=\"keyword\">pause-sync)暂停了同步 </span></span><br><span class=\"line\"><span class=\"keyword\">PausedSyncT：以本地节点为持续同步的目标，但是目前同步已经暂停，这可以是因为另外一个同步正在进行或是使用命令(drbdadm </span><span class=\"keyword\">pause-sync)暂停了同步 </span></span><br><span class=\"line\">VerifyS：以本地节点为验证源的线上设备验证正在执行 </span><br><span class=\"line\">VerifyT：以本地节点为验证目标的线上设备验证正在执行</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"资源角色\"><a href=\"#资源角色\" class=\"headerlink\" title=\"资源角色\"></a>资源角色</h2><p>查看资源角色命令<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">drbdadm</span> <span class=\"selector-tag\">role</span> <span class=\"selector-tag\">r0</span></span><br><span class=\"line\"><span class=\"selector-tag\">Secondary</span>/<span class=\"selector-tag\">Primary</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">cat</span> /<span class=\"selector-tag\">proc</span>/<span class=\"selector-tag\">drbd</span> </span><br><span class=\"line\"><span class=\"selector-tag\">version</span>: <span class=\"selector-tag\">8</span><span class=\"selector-class\">.4</span><span class=\"selector-class\">.11-1</span> (<span class=\"attribute\">api</span>:<span class=\"number\">1</span>/<span class=\"attribute\">proto</span>:<span class=\"number\">86</span>-<span class=\"number\">101</span>)</span><br><span class=\"line\"><span class=\"selector-tag\">GIT-hash</span>: <span class=\"selector-tag\">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"selector-tag\">build</span> <span class=\"selector-tag\">by</span> <span class=\"selector-tag\">mockbuild</span>@, <span class=\"selector-tag\">2018-11-03</span> <span class=\"selector-tag\">01</span><span class=\"selector-pseudo\">:26</span><span class=\"selector-pseudo\">:55</span></span><br><span class=\"line\"> <span class=\"selector-tag\">0</span>: <span class=\"selector-tag\">cs</span><span class=\"selector-pseudo\">:Connected</span> <span class=\"selector-tag\">ro</span><span class=\"selector-pseudo\">:Secondary</span>/<span class=\"selector-tag\">Primary</span> <span class=\"selector-tag\">ds</span><span class=\"selector-pseudo\">:UpToDate</span>/<span class=\"selector-tag\">UpToDate</span> <span class=\"selector-tag\">C</span> <span class=\"selector-tag\">r-----</span></span><br><span class=\"line\">    <span class=\"selector-tag\">ns</span><span class=\"selector-pseudo\">:10783808</span> <span class=\"selector-tag\">nr</span><span class=\"selector-pseudo\">:24</span> <span class=\"selector-tag\">dw</span><span class=\"selector-pseudo\">:299452</span> <span class=\"selector-tag\">dr</span><span class=\"selector-pseudo\">:10488701</span> <span class=\"selector-tag\">al</span><span class=\"selector-pseudo\">:82</span> <span class=\"selector-tag\">bm</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">lo</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">pe</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ua</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ap</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ep</span><span class=\"selector-pseudo\">:1</span> <span class=\"selector-tag\">wo</span><span class=\"selector-pseudo\">:f</span> <span class=\"selector-tag\">oos</span><span class=\"selector-pseudo\">:0</span></span><br><span class=\"line\"></span><br><span class=\"line\">注释：</span><br><span class=\"line\"><span class=\"selector-tag\">Parimary</span> 主：资源目前为主，并且可能正在被读取或写入，如果不是双主只会出现在两个节点中的其中一个节点上 </span><br><span class=\"line\"><span class=\"selector-tag\">Secondary</span> 次：资源目前为次，正常接收对等节点的更新 </span><br><span class=\"line\"><span class=\"selector-tag\">Unknown</span> 未知：资源角色目前未知，本地的资源不会出现这种状态</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"硬盘数据状态\"><a href=\"#硬盘数据状态\" class=\"headerlink\" title=\"硬盘数据状态\"></a>硬盘数据状态</h2><p>查看硬盘状态命令<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@drbd1</span> ~]<span class=\"meta\"># drbdadm dstate r0</span></span><br><span class=\"line\">UpToDate/UpToDate</span><br></pre></td></tr></table></figure></p>\n<p>本地和对等节点的硬盘有可能为下列状态之一：<br><figure class=\"highlight mathematica\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Diskless 无盘：本地没有块设备分配给DRBD使用，这表示没有可用的设备，或者使用drbdadm命令手工分离或是底层的<span class=\"keyword\">I</span>/<span class=\"keyword\">O</span>错误导致自动分离 </span><br><span class=\"line\">Attaching：读取无数据时候的瞬间状态 </span><br><span class=\"line\">Failed 失败：本地块设备报告<span class=\"keyword\">I</span>/<span class=\"keyword\">O</span>错误的下一个状态，其下一个状态为Diskless无盘 </span><br><span class=\"line\">Negotiating：在已经连接的DRBD设置进行Attach读取无数据前的瞬间状态 </span><br><span class=\"line\">Inconsistent：数据是不一致的，在两个节点上（初始的完全同步前）这种状态出现后立即创建一个新的资源。此外，在同步期间（同步目标）在一个节点上出现这种状态 </span><br><span class=\"line\">Outdated：数据资源是一致的，但是已经过时 </span><br><span class=\"line\">DUnknown：当对等节点网络连接不可用时出现这种状态 </span><br><span class=\"line\">Consistent：一个没有连接的节点数据一致，当建立连接时，它决定数据是UpToDate或是Outdated </span><br><span class=\"line\">UpToDate：一致的最新的数据状态，这个状态为正常状态</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"DRBD简介\"><a href=\"#DRBD简介\" class=\"headerlink\" title=\"DRBD简介\"></a>DRBD简介</h1><p><a href=\"https://docs.linbit.com/docs/users-guide-8.4/\" target=\"_blank\" rel=\"noopener\">官方文档</a></p>\n<blockquote>\n<p>DRBD的全称为：<code>Distributed Replicated Block Device(DRBD)</code>分布式块设备复制，<code>DRBD</code>是由内核模块和相关脚本构成，用以构建高可用的集群。其实现方式是通过网络来镜像整个设备。可以把它看作是一种网络<code>RAID</code>。它允许用户在远程机器上建立一个本地块设备的实时镜像。</p>\n</blockquote>\n<h2 id=\"DRBD是如何工作的\"><a href=\"#DRBD是如何工作的\" class=\"headerlink\" title=\"DRBD是如何工作的\"></a>DRBD是如何工作的</h2><blockquote>\n<p><code>（DRBD Primary）</code>负责接收数据，把数据写到本地磁盘并发送给另一台主机<code>（DRBD Secondary）</code>。另一个主机再将数据存到自己的磁盘中。目前，<code>DRBD</code>每次只允许对一个节点进行读写访问，但这对于通常的故障切换高可用集群来说已经足够用了，有可能以后的版本支持两个节点进行读写存取。<br><code>DRBD</code>协议说明<br>1）数据一旦写入磁盘并发送到网络中就认为完成了写入操作。<br>2）收到接收确认就认为完成了写入操作。<br>3）收到写入确认就认为完成了写入操作。</p>\n</blockquote>\n<h2 id=\"DRBD与HA的关系\"><a href=\"#DRBD与HA的关系\" class=\"headerlink\" title=\"DRBD与HA的关系\"></a>DRBD与HA的关系</h2><blockquote>\n<p>一个<code>DRBD</code>系统由两个节点构成，与<code>HA</code>集群类似，也有主节点和备用节点之分，在带有主要设备的节点上，应用程序和操作系统可以运行和访问<code>DRBD</code>设备<code>（/dev/drbd*）</code>。在主节点写入的数据通过<code>DRBD</code>设备存储到主节点的设备写入到备用节点的磁盘中。现在大部分的高可用性集群都会使用共享存储，而<code>DRBD</code>也可以作为一个共享存储设备，使用<code>DRBD</code>不需要太多的硬件的设备。因为它在<code>TCP/IP</code>网络中运行，所以，利用<code>DRBD</code>作为共享存储设备，节约很多成本，因为价格要比专用的存储网络便宜很多；其性能与稳定性方面也不错。</p>\n</blockquote>\n<h1 id=\"DRBD工作原理\"><a href=\"#DRBD工作原理\" class=\"headerlink\" title=\"DRBD工作原理\"></a>DRBD工作原理</h1><blockquote>\n<p><code>DRBD</code>是<code>linux</code>的内核的存储层中的一个分布式存储系统，可用使用<code>DRBD</code>在两台<code>Linux</code>服务器之间共享块设备，共享文件系统和数据。类似网络<code>RAID-1</code>，其工作的原理架构图如下：</p>\n</blockquote>\n<p><img src=\"/2019/08/08/网络RAID技术DRBD/01.jpg\" alt=\"image.png\"></p>\n<h1 id=\"DRBD的特性\"><a href=\"#DRBD的特性\" class=\"headerlink\" title=\"DRBD的特性\"></a>DRBD的特性</h1><blockquote>\n<p>分布式复制块设备（<code>DRBD</code>技术）是一种基于软件的，无共享，复制的存储解决方案，在服务器之间的对块设备（硬盘、分区、逻辑卷等）进行镜像。<br><code>DRBD</code>镜像数据的特性：<br>1）实时性：当某个应用程序完成对数据的修改时，复制功能立即发生<br>2）透明性：应用程序的数据存储在镜像块设备上是独立透明的，他们的数据在两个节点上都保存一份，因此，无论哪一台服务器宕机，都不会影响应用程序读取数据的操作，所以说是透明的。<br>3）同步镜像和异步镜像：同步镜像表示当应用程序提交本地的写操作后，数据会同步写到两个节点上去；异步镜像表示当应用程序提交写操作后，只有当本地的节点上完成写操作后，另一个节点才可以完成写操作。</p>\n</blockquote>\n<h1 id=\"DRBD的模式\"><a href=\"#DRBD的模式\" class=\"headerlink\" title=\"DRBD的模式\"></a>DRBD的模式</h1><blockquote>\n<p><code>DRBD</code>共有2种模式，一种是<code>DRBD的主从模式</code>，另一种是<code>DRBD的双主模式</code><br><strong>1）DRBD的主从模式：</strong><br>  这种模式下，其中一个节点作为主节点，另一个节点作为从节点。其中主节点可以执行读、写操作；从节点不可以挂载文件系统，因此也不可以执行读写操作。在这种模式下，资源在任何时间只能存储在主节点上。这种模式可用在任何的文件系统（<code>ext3、ext4、xfs</code>）等。默认这种模式下，一旦主节点发生故障，从节点需要手工将资源进行转移，且主节点变成从节点和从节点变成主节点需要手动进行切换。不能自动进行转移，因此比较麻烦。<br>为了解决手动将资源和节点进行转移，可以将<code>DRBD</code>做成高可用集群的资源代理<code>（RA）</code>，这样一旦其中的一个节点宕机，资源就会自动转移到另一个节点，从而保证服务的连续性。<br><strong>2）DRBD的双主模式:</strong><br>这是<code>DRBD8.0</code>之后的新特性，在双主模式下，任何资源在任何特定的时间都存在两个主节点。这种模式需要一个共享的集群文件系统，利用分布式的锁机制进行管理，如<code>GFS</code>和<code>OCFS2</code>。部署双主模式时，<code>DRBD</code>可以是负载均衡的集群，这就需要从两个并发的主节点中选取一个首选的访问数据。这种模式默认是禁用的，如果要是用的话必须在配置文件中进行申明。</p>\n</blockquote>\n<h1 id=\"DRBD的复制模式\"><a href=\"#DRBD的复制模式\" class=\"headerlink\" title=\"DRBD的复制模式\"></a>DRBD的复制模式</h1><blockquote>\n<p><code>DRBD</code>的复制功能就是将应用程序提交的数据一份保存在本地节点，一份复制传输保存在另一份节点上。但是<code>DRBD</code>需要对传输的数据进行确认以便保证另一个节点的写操作完成，就需要用到<code>DRBD</code>的复制模式，<code>DRBD</code>有三种复制模式：</p>\n</blockquote>\n<p><strong>1）协议A：异步复制协议</strong></p>\n<blockquote>\n<p>一旦本地磁盘写入已经完成，数据包已在发送队列中，则写被认为是完成的。在一个节点上发生故障时，可能发生数据丢失，因为被写入到远程节点上的数据可能仍在发送队列。尽管，在故障转移节点上的数据是一致的，但没有及时更新。这通常是用于地理上分开的节点。</p>\n</blockquote>\n<p><strong>2）协议B：内存同步（半同步）复制协议</strong></p>\n<blockquote>\n<p>一旦本地磁盘写入已完成且复制数据包达到了对等节点则认为写在主节点上被认为是完成的。数据丢失可能发生在参加的两个节点同时故障的情况下，因为在传输中的数据可能不会被提交到磁盘。</p>\n</blockquote>\n<p><strong>3）协议C：同步复制协议</strong></p>\n<blockquote>\n<p>只有在本地和远程节点的磁盘已经确认了写操作完成，写才被认为完成。没有任何数据丢失，所以这是一个集群节点的流行模式，但<code>I/O</code>吞吐量依赖于网络带宽。一般使用<code>协议C</code>，但选择<code>C协议</code>将影响流量，从而影响网络延迟。为了数据可靠性，我们在生产环境使用时须慎重选择使用哪一种协议。</p>\n</blockquote>\n<h1 id=\"DRBD配置文件说明\"><a href=\"#DRBD配置文件说明\" class=\"headerlink\" title=\"DRBD配置文件说明\"></a>DRBD配置文件说明</h1><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DRBD的主配置文件为/etc/drbd.<span class=\"keyword\">conf</span>；为了管理的便捷性，</span><br><span class=\"line\">目前通常会将配置文件分成多个部分，且都保存至/etc/drbd.<span class=\"keyword\">d</span>目录中，主配置文件中仅使用<span class=\"string\">\"include\"</span>指令将这些配置文件片断整合起来。通常，/etc/drbd.<span class=\"keyword\">d</span>目录中的配置文件</span><br><span class=\"line\">为global_common.<span class=\"keyword\">conf</span>和所有以.res结尾的文件。其中global_common.<span class=\"keyword\">conf</span>中主要定义<span class=\"keyword\">global</span>段和common段，而每一个.res的文件用于定义一个资源。</span><br><span class=\"line\">  </span><br><span class=\"line\">在配置文件中，<span class=\"keyword\">global</span>段仅能出现一次，且如果所有的配置信息都保存至同一个配置文件中而不分开为多个文件的话，<span class=\"keyword\">global</span>段必须位于配置文件的最开始处。目前<span class=\"keyword\">global</span>段中</span><br><span class=\"line\">可以定义的参数仅有minor-<span class=\"keyword\">count</span>, dialog-refresh, disable-ip-verification和usage-<span class=\"keyword\">count</span>。</span><br><span class=\"line\">  </span><br><span class=\"line\">common段则用于定义被每一个资源默认继承的参数，可以在资源定义中使用的参数都可以在common段中定义。实际应用中，common段并非必须，但建议将多个资源共享的参数定</span><br><span class=\"line\">义为common段中的参数以降低配置文件的复杂度。</span><br><span class=\"line\">  </span><br><span class=\"line\">resource段则用于定义DRBD资源，每个资源通常定义在一个单独的位于/etc/drbd.<span class=\"keyword\">d</span>目录中的以.res结尾的文件中。资源在定义时必须为其命名，名字可以由非空白的ASCII字符</span><br><span class=\"line\">组成。每一个资源段的定义中至少要包含两个host子段，以定义此资源关联至的节点，其它参数均可以从common段或DRBD的默认中进行继承而无须定义。</span><br><span class=\"line\">  </span><br><span class=\"line\">DRBD配置文件</span><br><span class=\"line\">[root@drbd1 ~]# <span class=\"keyword\">cat</span> /etc/drbd.<span class=\"keyword\">d</span>/global_common.<span class=\"keyword\">conf</span></span><br><span class=\"line\"><span class=\"keyword\">global</span> &#123;</span><br><span class=\"line\"> usage-<span class=\"keyword\">count</span> yes;         <span class=\"comment\">//是否参加DRBD使用者统计，默认是参加</span></span><br><span class=\"line\"> # minor-<span class=\"keyword\">count</span> dialog-refresh disable-ip-verification  <span class=\"comment\">//这里是global可以使用的参数</span></span><br><span class=\"line\"> #minor-<span class=\"keyword\">count</span>：32         <span class=\"comment\">//从（设备）个数，取值范围1~255，默认值为32。该选项设定了允许定义的resource个数，当要定义的resource超过了此选项的设定时，需要重新载入DRBD内核模块。</span></span><br><span class=\"line\"> #disable-ip-verification：<span class=\"keyword\">no</span>   <span class=\"comment\">//是否禁用ip检查</span></span><br><span class=\"line\">   </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">common &#123;</span><br><span class=\"line\"> protocol C;      <span class=\"comment\">//指定复制协议,复制协议共有三种，为协议A，B，C，默认协议为协议C</span></span><br><span class=\"line\"> handlers &#123;       <span class=\"comment\">//该配置段用来定义一系列处理器，用来回应特定事件。</span></span><br><span class=\"line\">  # These are EXAMPLE handlers only.</span><br><span class=\"line\">  # They may have severe implications,</span><br><span class=\"line\">  # like hard resetting the node under certain circumstances.</span><br><span class=\"line\">  # Be careful when chosing your poison.</span><br><span class=\"line\">  # pri-<span class=\"keyword\">on</span>-incon-degr <span class=\"string\">\"/usr/lib/DRBD/notify-pri-on-incon-degr.sh; /usr/lib/DRBD/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f\"</span>;</span><br><span class=\"line\">  # pri-lost-after-sb <span class=\"string\">\"/usr/lib/DRBD/notify-pri-lost-after-sb.sh; /usr/lib/DRBD/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f\"</span>;</span><br><span class=\"line\">  # <span class=\"keyword\">local</span>-io-<span class=\"keyword\">error</span> <span class=\"string\">\"/usr/lib/DRBD/notify-io-error.sh; /usr/lib/DRBD/notify-emergency-shutdown.sh; echo o &gt; /proc/sysrq-trigger ; halt -f\"</span>;</span><br><span class=\"line\">  # fence-peer <span class=\"string\">\"/usr/lib/DRBD/crm-fence-peer.sh\"</span>;</span><br><span class=\"line\">  # <span class=\"keyword\">split</span>-brain <span class=\"string\">\"/usr/lib/DRBD/notify-split-brain.sh root\"</span>;</span><br><span class=\"line\">  # <span class=\"keyword\">out</span>-of-sync <span class=\"string\">\"/usr/lib/DRBD/notify-out-of-sync.sh root\"</span>;</span><br><span class=\"line\">  # before-resync-target <span class=\"string\">\"/usr/lib/DRBD/snapshot-resync-target-lvm.sh -p 15 -- -c 16k\"</span>;</span><br><span class=\"line\">  # after-resync-target /usr/lib/DRBD/unsnapshot-resync-target-lvm.<span class=\"keyword\">sh</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> startup &#123;    <span class=\"comment\">//#DRBD同步时使用的验证方式和密码。该配置段用来更加精细地调节DRBD属性，它作用于配置节点在启动或重启时。常用选项有：</span></span><br><span class=\"line\">  # wfc-timeout degr-wfc-timeout outdated-wfc-timeout wait-after-sb</span><br><span class=\"line\">  wfc-timeout：  <span class=\"comment\">//该选项设定一个时间值，单位是秒。在启用DRBD块时，初始化脚本DRBD会阻塞启动进程的运行，直到对等节点的出现。该选项就是用来限制这个等待时间的，默认为0，即不限制，永远等待。</span></span><br><span class=\"line\">  degr-wfc-timeout：  <span class=\"comment\">//该选项也设定一个时间值，单位为秒。也是用于限制等待时间，只是作用的情形不同：它作用于一个降级集群（即那些只剩下一个节点的集群）在重启时的等待时间。</span></span><br><span class=\"line\">  outdated-wfc-timeout：  <span class=\"comment\">//同上，也是用来设定等待时间，单位为秒。它用于设定等待过期节点的时间</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> disk &#123;</span><br><span class=\"line\">  # <span class=\"keyword\">on</span>-io-<span class=\"keyword\">error</span> fencing <span class=\"keyword\">use</span>-bmbv <span class=\"keyword\">no</span>-disk-barrier <span class=\"keyword\">no</span>-disk-flushes   <span class=\"comment\">//这里是disk段内可以定义的参数</span></span><br><span class=\"line\">  # <span class=\"keyword\">no</span>-disk-drain <span class=\"keyword\">no</span>-md-flushes max-bio-bvecs                      <span class=\"comment\">//这里是disk段内可以定义的参数</span></span><br><span class=\"line\">  <span class=\"keyword\">on</span>-io-<span class=\"keyword\">error</span>： detach      <span class=\"comment\">//选项：此选项设定了一个策略，如果底层设备向上层设备报告发生I/O错误，将按照该策略进行处理。有效的策略包括：</span></span><br><span class=\"line\">    detach      <span class=\"comment\">//发生I/O错误的节点将放弃底层设备，以diskless mode继续工作。在diskless mode下，只要还有网络连接，DRBD将从secondary node读写数据，而不需要failover（故障转移）。该策略会导致一定的损失，但好处也很明显，DRBD服务不会中断。官方推荐和默认策略。</span></span><br><span class=\"line\">    pass_on       <span class=\"comment\">//把I/O错误报告给上层设备。如果错误发生在primary节点，把它报告给文件系统，由上层设备处理这些错误（例如，它会导致文件系统以只读方式重新挂载），它可能会导致DRBD停止提供服务；如果发生在secondary节点，则忽略该错误（因为secondary节点没有上层设备可以报告）。该策略曾经是默认策略，但现在已被detach所取代。</span></span><br><span class=\"line\">    call-<span class=\"keyword\">local</span>-io-<span class=\"keyword\">error</span>   <span class=\"comment\">//调用预定义的本地local-io-error脚本进行处理。该策略需要在resource（或common）配置段的handlers部分，预定义一个相应的local-io-error命令调用。该策略完全由管理员通过local-io-error命令（或脚本）调用来控制如何处理I/O错误。</span></span><br><span class=\"line\">  fencing：               <span class=\"comment\">//该选项设定一个策略来避免split brain的状况。有效的策略包括：</span></span><br><span class=\"line\">    dont-care：  <span class=\"comment\">//默认策略。不采取任何隔离措施。</span></span><br><span class=\"line\">    resource-only：   <span class=\"comment\">//在此策略下，如果一个节点处于split brain状态，它将尝试隔离对端节点的磁盘。这个操作通过调用fence-peer处理器来实现。fence-peer处理器将通过其它通信路径到达对等节点，并在这个对等节点上调用DRBDadm outdate res命令</span></span><br><span class=\"line\">    resource-and-stonith：   <span class=\"comment\">//在此策略下，如果一个节点处于split brain状态，它将停止I/O操作，并调用fence-peer处理器。处理器通过其它通信路径到达对等节点，并在这个对等节点上调用DRBDadm outdate res命令。如果无法到达对等节点，它将向对等端发送关机命令。一旦问题解决，I/O操作将重新进行。如果处理器失败，你可以使用resume-io命令来重新开始I/O操作。</span></span><br><span class=\"line\">    </span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">net</span> &#123;        <span class=\"comment\">//该配置段用来精细地调节DRBD的属性，网络相关的属性。常用的选项有：</span></span><br><span class=\"line\">  # sndbuf-size rcvbuf-size timeout connect-int ping-int ping-timeout max-buffers     <span class=\"comment\">//这里是net段内可以定义的参数</span></span><br><span class=\"line\">  # max-epoch-size ko-<span class=\"keyword\">count</span> allow-<span class=\"keyword\">two</span>-primaries cram-hmac-alg shared-secret      <span class=\"comment\">//这里是net段内可以定义的参数</span></span><br><span class=\"line\">  # after-sb-0pri after-sb-1pri after-sb-2pri data-integrity-alg <span class=\"keyword\">no</span>-tcp-cork      <span class=\"comment\">//这里是net段内可以定义的参数</span></span><br><span class=\"line\">  sndbuf-size：     <span class=\"comment\">//该选项用来调节TCP send buffer的大小，DRBD 8.2.7以前的版本，默认值为0，意味着自动调节大小；新版本的DRBD的默认值为128KiB。高吞吐量的网络（例如专用的千兆网卡，或负载均衡中绑定的连接）中，增加到512K比较合适，或者可以更高，但是最好不要超过2M。</span></span><br><span class=\"line\">  timeout：        <span class=\"comment\">//该选项设定一个时间值，单位为0.1秒。如果搭档节点没有在此时间内发来应答包，那么就认为搭档节点已经死亡，因此将断开这次TCP/IP连接。默认值为60，即6秒。该选项的值必须小于connect-int和ping-int的值。</span></span><br><span class=\"line\">  connect-int：     <span class=\"comment\">//如果无法立即连接上远程DRBD设备，系统将断续尝试连接。该选项设定的就是两次尝试间隔时间。单位为秒，默认值为10秒。</span></span><br><span class=\"line\">  ping-timeout：    <span class=\"comment\">//该选项设定一个时间值，单位是0.1秒。如果对端节点没有在此时间内应答keep-alive包，它将被认为已经死亡。默认值是500ms。</span></span><br><span class=\"line\">  max-buffers：     <span class=\"comment\">//该选项设定一个由DRBD分配的最大请求数，单位是页面大小（PAGE_SIZE），大多数系统中，页面大小为4KB。这些buffer用来存储那些即将写入磁盘的数据。最小值为32（即128KB）。这个值大一点好。</span></span><br><span class=\"line\">  max-epoch-size：    <span class=\"comment\">//该选项设定了两次write barriers之间最大的数据块数。如果选项的值小于10，将影响系统性能。大一点好</span></span><br><span class=\"line\">  ko-<span class=\"keyword\">count</span>：     <span class=\"comment\">//该选项设定一个值，把该选项设定的值 乘以 timeout设定的值，得到一个数字N，如果secondary节点没有在此时间内完成单次写请求，它将从集群中被移除（即，primary node进入StandAlong模式）。取值范围0~200，默认值为0，即禁用该功能。</span></span><br><span class=\"line\">  allow-<span class=\"keyword\">two</span>-primaries：   <span class=\"comment\">//这个是DRBD8.0及以后版本才支持的新特性，允许一个集群中有两个primary node。该模式需要特定文件系统的支撑，目前只有OCFS2和GFS可以，传统的ext3、ext4、xfs等都不行！</span></span><br><span class=\"line\">  cram-hmac-alg：    <span class=\"comment\">//该选项可以用来指定HMAC算法来启用对端节点授权。DRBD强烈建议启用对端点授权机制。可以指定/proc/crypto文件中识别的任一算法。必须在此指定算法，以明确启用对端节点授权机制，实现数据加密传输。</span></span><br><span class=\"line\">  shared-secret：    <span class=\"comment\">//该选项用来设定在对端节点授权中使用的密码，最长64个字符。</span></span><br><span class=\"line\">  data-integrity-alg：   <span class=\"comment\">//该选项设定内核支持的一个算法，用于网络上的用户数据的一致性校验。通常的数据一致性校验，由TCP/IP头中所包含的16位校验和来进行，而该选项可以使用内核所支持的任一算法。该功能默认关闭。</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> syncer &#123;       <span class=\"comment\">//该配置段用来更加精细地调节服务的同步进程。常用选项有</span></span><br><span class=\"line\">  # rate after al-extents <span class=\"keyword\">use</span>-rle cpu-mask verify-alg csums-alg</span><br><span class=\"line\">  rate：    <span class=\"comment\">//设置同步时的速率，默认为250KB。默认的单位是KB/sec，也允许使用K、M和G，如40M。注意：syncer中的速率是以bytes，而不是bits来设定的。配置文件中的这个选项设置的速率是永久性的，但可使用下列命令临时地改变rate的值：DRBDsetup /dev/DRBDN syncer -r 100M。如果想重新恢复成drbd.conf配置文件中设定的速率，执行如下命令： DRBDadm adjust resource</span></span><br><span class=\"line\">  verify-alg：    <span class=\"comment\">//该选项指定一个用于在线校验的算法，内核一般都会支持md5、sha1和crc32c校验算法。在线校验默认关闭，必须在此选项设定参数，以明确启用在线设备校验。DRBD支持在线设备校验，它以一种高效的方式对不同节点的数据进行一致性校验。在线校验会影响CPU负载和使用，但影响比较轻微。DRBD 8.2.5及以后版本支持此功能。一旦启用了该功能，你就可以使用下列命令进行一个在线校验： DRBDadm verify resource。该命令对指定的resource进行检验，如果检测到有数据块没有同步，它会标记这些块，并往内核日志中写入一条信息。这个过程不会影响正在使用该设备的程序。</span></span><br><span class=\"line\">                    如果检测到未同步的块，当检验结束后，你就可以如下命令重新同步它们：DRBDadm disconnect resource   or   DRBDadm connetc resource</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">common段是用来定义共享的资源参数，以减少资源定义的重复性。common段是非必须的。resource段一般为DRBD上每一个节点来定义其资源参数的。</span><br><span class=\"line\">资源配置文件详解 </span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">[root@drbd1 ~]# <span class=\"keyword\">cat</span> /etc/drbd.<span class=\"keyword\">d</span>/web.res</span><br><span class=\"line\">resource web &#123;       <span class=\"comment\">//web为资源名称</span></span><br><span class=\"line\"> <span class=\"keyword\">on</span> ha1.xsl.com &#123;                       <span class=\"comment\">//on后面为节点的名称,有几个节点就有几个on段，这里是定义节点ha1.xsl.com上的资源</span></span><br><span class=\"line\">  device   /dev/DRBD0;       <span class=\"comment\">//定义DRBD虚拟块设备，这个设备事先不要格式化。</span></span><br><span class=\"line\">  disk /dev/sda6;        <span class=\"comment\">//定义存储磁盘为/dev/sda6,该分区创建完成之后就行了，不要进行格式化操作</span></span><br><span class=\"line\">  address 192.168.108.199:7789;      <span class=\"comment\">//定义DRBD监听的地址和端口，以便和对端进行通信</span></span><br><span class=\"line\">  meta-disk  internal;       <span class=\"comment\">//该参数有2个选项：internal和externally，其中internal表示将元数据和数据存储在同一个磁盘上；而externally表示将元数据和数据分开存储，元数据被放在另一个磁盘上。</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">on</span> ha2.xsl.com &#123;        <span class=\"comment\">//这里是定义节点ha2.xsl.com上的资源</span></span><br><span class=\"line\">  device /dev/DRBD0;</span><br><span class=\"line\">  disk /dev/sda6;</span><br><span class=\"line\">  address 192.168.108.201:7789;</span><br><span class=\"line\">  meta-disk internal;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"DRBD安装配置（主从模式）\"><a href=\"#DRBD安装配置（主从模式）\" class=\"headerlink\" title=\"DRBD安装配置（主从模式）\"></a>DRBD安装配置（主从模式）</h1><p><strong>环境说明</strong></p>\n<blockquote>\n<p>这里使用所用环境为<code>centos7.4</code>操作系统<br>在下面的操作步骤中<code># command</code>的命令表示主从节点服务器都需要执行。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>IP</th>\n<th>主机名</th>\n<th>角色说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>192.168.1.31</td>\n<td>drbd1.cluster.com</td>\n<td>主服务器</td>\n</tr>\n<tr>\n<td>192.168.1.32</td>\n<td>drbd2.cluster.com</td>\n<td>从服务器</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"具体步骤\"><a href=\"#具体步骤\" class=\"headerlink\" title=\"具体步骤\"></a>具体步骤</h2><p>1）两台机器上添加<code>DRBD</code>磁盘，进行分区，不做格式化，并在本地系统创建<code>/data</code>目录，不做挂载操作<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在drbd1服务器上操作</span><br><span class=\"line\">[root@drbd1 ~]# lsblk </span><br><span class=\"line\">......</span><br><span class=\"line\">sdb               8:16   0   10G  0 disk</span><br><span class=\"line\">[root@drbd1 ~]# fdisk /dev/sdb</span><br><span class=\"line\">依次输入\"n-&gt;p-&gt;1-&gt;回车-&gt;回车-w\"</span><br><span class=\"line\"></span><br><span class=\"line\">在drbd2服务器上操作</span><br><span class=\"line\">[root@drbd2 ~]# lsblk </span><br><span class=\"line\">......</span><br><span class=\"line\">sdb               8:16   0   10G  0 disk</span><br><span class=\"line\">[root@drbd2 ~]# fdisk /dev/sdb</span><br><span class=\"line\">依次输入\"n-&gt;p-&gt;1-&gt;回车-&gt;回车-w\"</span><br></pre></td></tr></table></figure></p>\n<p>2）两台服务器之间的防火墙要允许互相访问，这里测试关闭<code>selinux</code>和防火墙(两台服务器同样操作)<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># systemctl stop firewalld</span></span><br><span class=\"line\"><span class=\"meta\"># setenforce 0     //临时性关闭；永久关闭需修改/etc/sysconfig/selinux的SELINUX为disable</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>hosts</code>绑定（两台服务器同样操作）<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># vim /etc/hosts</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span>    drbd1.cluster.com</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span>    drbd2.cluster.com</span><br></pre></td></tr></table></figure></p>\n<p>4）两台服务器进行时间同步（两台服务器同样操作）<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install ntpdate</span></span><br><span class=\"line\"><span class=\"meta\"># ntpdate -u asia.pool.ntp.org</span></span><br></pre></td></tr></table></figure></p>\n<p>5）<code>DRBD</code>安装配置（两台服务器同样操作）<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这里使用yum方式安装</span><br><span class=\"line\"><span class=\"meta\"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span><br><span class=\"line\"><span class=\"meta\"># yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span></span><br><span class=\"line\"><span class=\"meta\"># yum -y install kmod-drbd84 drbd86-utils </span></span><br><span class=\"line\"></span><br><span class=\"line\">因为在执行yum -y install kmod-drbd84 drbd86-utils时，对内核kernel进行了update，要重新启动服务器，更新后的内核才会生效。</span><br><span class=\"line\">加载模块：</span><br><span class=\"line\"><span class=\"meta\"># reboot</span></span><br><span class=\"line\"><span class=\"meta\"># modprobe drbd</span></span><br><span class=\"line\">查看模块是否已添加上</span><br><span class=\"line\"><span class=\"meta\"># lsmod |grep drbd</span></span><br><span class=\"line\">drbd                  <span class=\"number\">397041</span>  <span class=\"number\">0</span> </span><br><span class=\"line\">libcrc32c              <span class=\"number\">12644</span>  <span class=\"number\">4</span> xfs,drbd,nf_nat,nf_conntrack</span><br></pre></td></tr></table></figure></p>\n<p>6）<code>DRBD</code>配置（两台服务器上同样操作）<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cat /etc/drbd.conf     //主配置文件</span></span><br><span class=\"line\"><span class=\"comment\"># You can find an example in  /usr/share/doc/drbd.../drbd.conf.example</span></span><br><span class=\"line\"></span><br><span class=\"line\">include <span class=\"string\">\"drbd.d/global_common.conf\"</span>;</span><br><span class=\"line\">include <span class=\"string\">\"drbd.d/*.res\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">备份配置文件</span><br><span class=\"line\"><span class=\"comment\"># cp /etc/drbd.d/global_common.conf&#123;,.bak&#125; </span></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/drbd.d/global_common.conf    //全局配置文件</span></span><br><span class=\"line\">global &#123;</span><br><span class=\"line\">\tusage-count <span class=\"literal\">no</span>;     #是否参加DRBD使用统计，默认为<span class=\"literal\">yes</span>。官方统计drbd的装机量</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">common &#123;</span><br><span class=\"line\">    protocol C;    #使用DRBD的同步协议</span><br><span class=\"line\">\thandlers &#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tstartup &#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\toptions &#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tdisk &#123;</span><br><span class=\"line\">                on-io-<span class=\"builtin-name\">error</span> detach;    #配置I/O错误处理策略为分离</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tnet &#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    syncer &#123;</span><br><span class=\"line\">                rate 30M;     #设置主备节点同步时的网络速率</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/drbd.d/r0.res    #创建资源</span></span><br><span class=\"line\">resource r0 &#123;</span><br><span class=\"line\">    on drbd1.cluster.com &#123;</span><br><span class=\"line\">        device    /dev/drbd0;    #drbd1服务器上的DRBD虚拟块设备，事先不要格式化</span><br><span class=\"line\">        disk      /dev/sdb1;</span><br><span class=\"line\">       <span class=\"built_in\"> address </span>  192.168.1.31:7789;    #DRBD监听的地址和端口，端口可以自定义。</span><br><span class=\"line\">        meta-disk internal;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    on drbd2.cluster.com &#123;</span><br><span class=\"line\">        device    /dev/drbd0;    #drbd2服务器上的DRBD虚拟块设备，事先不要格式化</span><br><span class=\"line\">        disk      /dev/sdb1;</span><br><span class=\"line\">       <span class=\"built_in\"> address </span>  192.168.1.32:7789;</span><br><span class=\"line\">        meta-disk internal;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>7）在两台服务器上分别启用<code>r0</code>资源（两台服务器上同样操作）<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># <span class=\"selector-tag\">drbdadm</span> <span class=\"selector-tag\">create-md</span> <span class=\"selector-tag\">r0</span></span><br><span class=\"line\"><span class=\"selector-tag\">initializing</span> <span class=\"selector-tag\">activity</span> <span class=\"selector-tag\">log</span></span><br><span class=\"line\"><span class=\"selector-tag\">initializing</span> <span class=\"selector-tag\">bitmap</span> (<span class=\"number\">320</span> KB) <span class=\"selector-tag\">to</span> <span class=\"keyword\">all</span> <span class=\"selector-tag\">zero</span></span><br><span class=\"line\"><span class=\"selector-tag\">Writing</span> <span class=\"selector-tag\">meta</span> <span class=\"selector-tag\">data</span>...</span><br><span class=\"line\"><span class=\"selector-tag\">New</span> <span class=\"selector-tag\">drbd</span> <span class=\"selector-tag\">meta</span> <span class=\"selector-tag\">data</span> <span class=\"selector-tag\">block</span> <span class=\"selector-tag\">successfully</span> <span class=\"selector-tag\">created</span>.</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动<span class=\"selector-tag\">drbd</span>(注意：需要两边服务器同时启动方能生效)</span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">systemctl</span> <span class=\"selector-tag\">start</span> <span class=\"selector-tag\">drbd</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">systemctl</span> <span class=\"selector-tag\">start</span> <span class=\"selector-tag\">drbd</span></span><br><span class=\"line\"></span><br><span class=\"line\"># 查看状态（两台机器上都执行查看）</span><br><span class=\"line\"># <span class=\"selector-tag\">cat</span> /<span class=\"selector-tag\">proc</span>/<span class=\"selector-tag\">drbd</span></span><br><span class=\"line\"><span class=\"selector-tag\">version</span>: <span class=\"selector-tag\">8</span><span class=\"selector-class\">.4</span><span class=\"selector-class\">.11-1</span> (<span class=\"attribute\">api</span>:<span class=\"number\">1</span>/<span class=\"attribute\">proto</span>:<span class=\"number\">86</span>-<span class=\"number\">101</span>)</span><br><span class=\"line\"><span class=\"selector-tag\">GIT-hash</span>: <span class=\"selector-tag\">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"selector-tag\">build</span> <span class=\"selector-tag\">by</span> <span class=\"selector-tag\">mockbuild</span>@, <span class=\"selector-tag\">2018-11-03</span> <span class=\"selector-tag\">01</span><span class=\"selector-pseudo\">:26</span><span class=\"selector-pseudo\">:55</span></span><br><span class=\"line\"> <span class=\"selector-tag\">0</span>: <span class=\"selector-tag\">cs</span><span class=\"selector-pseudo\">:Connected</span> <span class=\"selector-tag\">ro</span><span class=\"selector-pseudo\">:Secondary</span>/<span class=\"selector-tag\">Secondary</span> <span class=\"selector-tag\">ds</span><span class=\"selector-pseudo\">:Inconsistent</span>/<span class=\"selector-tag\">Inconsistent</span> <span class=\"selector-tag\">C</span> <span class=\"selector-tag\">r-----</span></span><br><span class=\"line\">    <span class=\"selector-tag\">ns</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">nr</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">dw</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">dr</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">al</span><span class=\"selector-pseudo\">:8</span> <span class=\"selector-tag\">bm</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">lo</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">pe</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ua</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ap</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ep</span><span class=\"selector-pseudo\">:1</span> <span class=\"selector-tag\">wo</span><span class=\"selector-pseudo\">:f</span> <span class=\"selector-tag\">oos</span><span class=\"selector-pseudo\">:10484380</span></span><br><span class=\"line\"></span><br><span class=\"line\">#由上面两台主机的<span class=\"selector-tag\">DRBD</span>状态查看结果里的<span class=\"selector-tag\">ro</span><span class=\"selector-pseudo\">:Secondary</span>/<span class=\"selector-tag\">Secondary</span>表示两台主机的状态都是备机状态，<span class=\"selector-tag\">ds</span>是磁盘状态，</span><br></pre></td></tr></table></figure></p>\n<p>8）将<code>drbd1</code>服务器配置为<code>DRBD</code>的主节点，进行初始化设备同步<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@drbd1</span> <span class=\"string\">~]#</span> <span class=\"string\">drbdsetup</span> <span class=\"string\">/dev/drbd0</span> <span class=\"string\">primary</span> <span class=\"bullet\">--force</span></span><br><span class=\"line\"><span class=\"string\">[root@drbd1</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/proc/drbd</span> </span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"number\">8.4</span><span class=\"number\">.11</span><span class=\"bullet\">-1</span> <span class=\"string\">(api:1/proto:86-101)</span></span><br><span class=\"line\"><span class=\"attr\">GIT-hash:</span> <span class=\"number\">66145</span><span class=\"string\">a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"string\">build</span> <span class=\"string\">by</span> <span class=\"string\">mockbuild@,</span> <span class=\"number\">2018</span><span class=\"bullet\">-11</span><span class=\"bullet\">-03</span> <span class=\"number\">01</span><span class=\"string\">:26:55</span></span><br><span class=\"line\"> <span class=\"number\">0</span><span class=\"string\">:</span> <span class=\"attr\">cs:SyncSource</span> <span class=\"attr\">ro:Primary/Secondary</span> <span class=\"attr\">ds:UpToDate/Inconsistent</span> <span class=\"string\">C</span> <span class=\"string\">r-----</span></span><br><span class=\"line\"><span class=\"attr\">    ns:</span><span class=\"number\">2418688</span> <span class=\"attr\">nr:0</span> <span class=\"attr\">dw:0</span> <span class=\"attr\">dr:2420808</span> <span class=\"attr\">al:8</span> <span class=\"attr\">bm:0</span> <span class=\"attr\">lo:0</span> <span class=\"attr\">pe:1</span> <span class=\"attr\">ua:0</span> <span class=\"attr\">ap:0</span> <span class=\"attr\">ep:1</span> <span class=\"attr\">wo:f</span> <span class=\"attr\">oos:8066716</span></span><br><span class=\"line\">\t<span class=\"string\">[===&gt;................]</span> <span class=\"string\">sync'ed:</span> <span class=\"number\">23.1</span><span class=\"string\">%</span> <span class=\"string\">(7876/10236)M</span></span><br><span class=\"line\">\t<span class=\"attr\">finish:</span> <span class=\"number\">0</span><span class=\"string\">:03:08</span> <span class=\"attr\">speed:</span> <span class=\"number\">42</span><span class=\"string\">,792</span> <span class=\"string\">(37,776)</span> <span class=\"string\">K/sec</span></span><br><span class=\"line\"><span class=\"comment\">###同步完成时状态如下</span></span><br><span class=\"line\"><span class=\"string\">[root@drbd1</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/proc/drbd</span>     <span class=\"comment\">#drbd1上查看</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"number\">8.4</span><span class=\"number\">.11</span><span class=\"bullet\">-1</span> <span class=\"string\">(api:1/proto:86-101)</span></span><br><span class=\"line\"><span class=\"attr\">GIT-hash:</span> <span class=\"number\">66145</span><span class=\"string\">a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"string\">build</span> <span class=\"string\">by</span> <span class=\"string\">mockbuild@,</span> <span class=\"number\">2018</span><span class=\"bullet\">-11</span><span class=\"bullet\">-03</span> <span class=\"number\">01</span><span class=\"string\">:26:55</span></span><br><span class=\"line\"> <span class=\"number\">0</span><span class=\"string\">:</span> <span class=\"attr\">cs:Connected</span> <span class=\"attr\">ro:Primary/Secondary</span> <span class=\"attr\">ds:UpToDate/UpToDate</span> <span class=\"string\">C</span> <span class=\"string\">r-----</span></span><br><span class=\"line\"><span class=\"attr\">    ns:</span><span class=\"number\">10484380</span> <span class=\"attr\">nr:0</span> <span class=\"attr\">dw:0</span> <span class=\"attr\">dr:10486500</span> <span class=\"attr\">al:8</span> <span class=\"attr\">bm:0</span> <span class=\"attr\">lo:0</span> <span class=\"attr\">pe:0</span> <span class=\"attr\">ua:0</span> <span class=\"attr\">ap:0</span> <span class=\"attr\">ep:1</span> <span class=\"attr\">wo:f</span> <span class=\"attr\">oos:0</span></span><br><span class=\"line\"><span class=\"string\">[root@drbd2</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/proc/drbd</span>     <span class=\"comment\">#drbd2上查看</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"number\">8.4</span><span class=\"number\">.11</span><span class=\"bullet\">-1</span> <span class=\"string\">(api:1/proto:86-101)</span></span><br><span class=\"line\"><span class=\"attr\">GIT-hash:</span> <span class=\"number\">66145</span><span class=\"string\">a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"string\">build</span> <span class=\"string\">by</span> <span class=\"string\">mockbuild@,</span> <span class=\"number\">2018</span><span class=\"bullet\">-11</span><span class=\"bullet\">-03</span> <span class=\"number\">01</span><span class=\"string\">:26:55</span></span><br><span class=\"line\"> <span class=\"number\">0</span><span class=\"string\">:</span> <span class=\"attr\">cs:Connected</span> <span class=\"attr\">ro:Secondary/Primary</span> <span class=\"attr\">ds:UpToDate/UpToDate</span> <span class=\"string\">C</span> <span class=\"string\">r-----</span></span><br><span class=\"line\"><span class=\"attr\">    ns:</span><span class=\"number\">0</span> <span class=\"attr\">nr:10484380</span> <span class=\"attr\">dw:10484380</span> <span class=\"attr\">dr:0</span> <span class=\"attr\">al:8</span> <span class=\"attr\">bm:0</span> <span class=\"attr\">lo:0</span> <span class=\"attr\">pe:0</span> <span class=\"attr\">ua:0</span> <span class=\"attr\">ap:0</span> <span class=\"attr\">ep:1</span> <span class=\"attr\">wo:f</span> <span class=\"attr\">oos:0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#说明：</span></span><br><span class=\"line\"><span class=\"string\">ro在主从服务器上分别显示</span> <span class=\"string\">Primary/Secondary和Secondary/Primary</span></span><br><span class=\"line\"><span class=\"string\">ds显示UpToDate/UpToDate</span> <span class=\"string\">表示主从配置成功</span></span><br></pre></td></tr></table></figure></p>\n<p>9）挂载<code>DRBD</code>（<code>drbd1</code>主节点服务器上操作）<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#先格式化/dev/drbd0</span><br><span class=\"line\">[root@drbd1 ~]# mkfs.ext4 /dev/drbd0</span><br><span class=\"line\"></span><br><span class=\"line\">#创建挂载目录，然后进行挂载</span><br><span class=\"line\">[root@drbd1 ~]# mkdir /data</span><br><span class=\"line\">[root@drbd1 ~]# mount /dev/drbd0 /data</span><br><span class=\"line\">[root@drbd1 ~]# df -h</span><br><span class=\"line\">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class=\"line\">/dev/mapper/centos-root   <span class=\"number\">20</span>G  <span class=\"number\">3.7</span>G   <span class=\"number\">16</span>G   <span class=\"number\">20</span>% /</span><br><span class=\"line\">devtmpfs                 <span class=\"number\">471</span>M     <span class=\"number\">0</span>  <span class=\"number\">471</span>M    <span class=\"number\">0</span>% /dev</span><br><span class=\"line\">tmpfs                    <span class=\"number\">487</span>M     <span class=\"number\">0</span>  <span class=\"number\">487</span>M    <span class=\"number\">0</span>% /dev/shm</span><br><span class=\"line\">tmpfs                    <span class=\"number\">487</span>M  <span class=\"number\">7.1</span>M  <span class=\"number\">480</span>M    <span class=\"number\">2</span>% /run</span><br><span class=\"line\">tmpfs                    <span class=\"number\">487</span>M     <span class=\"number\">0</span>  <span class=\"number\">487</span>M    <span class=\"number\">0</span>% /sys/fs/cgroup</span><br><span class=\"line\">/dev/sda1                <span class=\"number\">497</span>M  <span class=\"number\">193</span>M  <span class=\"number\">305</span>M   <span class=\"number\">39</span>% /boot</span><br><span class=\"line\">tmpfs                     <span class=\"number\">98</span>M     <span class=\"number\">0</span>   <span class=\"number\">98</span>M    <span class=\"number\">0</span>% /run/user/<span class=\"number\">0</span></span><br><span class=\"line\">/dev/drbd0               <span class=\"number\">9.8</span>G   <span class=\"number\">37</span>M  <span class=\"number\">9.2</span>G    <span class=\"number\">1</span>% /data</span><br><span class=\"line\"></span><br><span class=\"line\">特别注意：</span><br><span class=\"line\">从节点(Secondary)上不允许对DRBD设备进行任何操作，包括只读，所有的读写操作只能在主节点(Primary)上进行。</span><br><span class=\"line\">只有当主节点(Primary)挂掉时，从节点(Secondary)才能提示为主节点(Primary)。</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"DRBD主备故障切换测试\"><a href=\"#DRBD主备故障切换测试\" class=\"headerlink\" title=\"DRBD主备故障切换测试\"></a>DRBD主备故障切换测试</h2><blockquote>\n<p>模拟主节点(<code>drbd1.cluster.com</code>）发生故障，从节点（<code>drbd2.cluster.com</code>）接管并提升为主节点。</p>\n</blockquote>\n<p>1）主节点上操作<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 创建测试文件并取消挂载</span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">cd</span> /<span class=\"selector-tag\">data</span>/</span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 data]</span># <span class=\"selector-tag\">touch</span> <span class=\"selector-tag\">test01</span> <span class=\"selector-tag\">test02</span> <span class=\"selector-tag\">test03</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 data]</span># <span class=\"selector-tag\">cd</span> </span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">umount</span> /<span class=\"selector-tag\">data</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">drbdsetup</span> /<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">drbd0</span> <span class=\"selector-tag\">secondary</span>        <span class=\"comment\">//将主节点设置为DRBD的备节点。在实际生产环境中，直接在(Secondary）节点上提权（即设置为主节点）即可。</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">cat</span> /<span class=\"selector-tag\">proc</span>/<span class=\"selector-tag\">drbd</span> </span><br><span class=\"line\"><span class=\"selector-tag\">version</span>: <span class=\"selector-tag\">8</span><span class=\"selector-class\">.4</span><span class=\"selector-class\">.11-1</span> (<span class=\"attribute\">api</span>:<span class=\"number\">1</span>/<span class=\"attribute\">proto</span>:<span class=\"number\">86</span>-<span class=\"number\">101</span>)</span><br><span class=\"line\"><span class=\"selector-tag\">GIT-hash</span>: <span class=\"selector-tag\">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"selector-tag\">build</span> <span class=\"selector-tag\">by</span> <span class=\"selector-tag\">mockbuild</span>@, <span class=\"selector-tag\">2018-11-03</span> <span class=\"selector-tag\">01</span><span class=\"selector-pseudo\">:26</span><span class=\"selector-pseudo\">:55</span></span><br><span class=\"line\"> <span class=\"selector-tag\">0</span>: <span class=\"selector-tag\">cs</span><span class=\"selector-pseudo\">:Connected</span> <span class=\"selector-tag\">ro</span><span class=\"selector-pseudo\">:Secondary</span>/<span class=\"selector-tag\">Secondary</span> <span class=\"selector-tag\">ds</span><span class=\"selector-pseudo\">:UpToDate</span>/<span class=\"selector-tag\">UpToDate</span> <span class=\"selector-tag\">C</span> <span class=\"selector-tag\">r-----</span></span><br><span class=\"line\">    <span class=\"selector-tag\">ns</span><span class=\"selector-pseudo\">:10783808</span> <span class=\"selector-tag\">nr</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">dw</span><span class=\"selector-pseudo\">:299428</span> <span class=\"selector-tag\">dr</span><span class=\"selector-pseudo\">:10488701</span> <span class=\"selector-tag\">al</span><span class=\"selector-pseudo\">:82</span> <span class=\"selector-tag\">bm</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">lo</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">pe</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ua</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ap</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ep</span><span class=\"selector-pseudo\">:1</span> <span class=\"selector-tag\">wo</span><span class=\"selector-pseudo\">:f</span> <span class=\"selector-tag\">oos</span><span class=\"selector-pseudo\">:0</span></span><br><span class=\"line\"></span><br><span class=\"line\">注意：这里实际生产环境若<span class=\"selector-tag\">Primary</span>主节点宕机，在<span class=\"selector-tag\">Secondary</span>状态信息中<span class=\"selector-tag\">ro</span>的值会显示为<span class=\"selector-tag\">Secondary</span>/<span class=\"selector-tag\">Unknown</span>,只需要进行<span class=\"selector-tag\">DRBD</span>提权操作即可。</span><br></pre></td></tr></table></figure></p>\n<p>2）备节点上操作<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">drbdsetup</span> /<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">drbd0</span> <span class=\"selector-tag\">primary</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">cat</span> /<span class=\"selector-tag\">proc</span>/<span class=\"selector-tag\">drbd</span> </span><br><span class=\"line\"><span class=\"selector-tag\">version</span>: <span class=\"selector-tag\">8</span><span class=\"selector-class\">.4</span><span class=\"selector-class\">.11-1</span> (<span class=\"attribute\">api</span>:<span class=\"number\">1</span>/<span class=\"attribute\">proto</span>:<span class=\"number\">86</span>-<span class=\"number\">101</span>)</span><br><span class=\"line\"><span class=\"selector-tag\">GIT-hash</span>: <span class=\"selector-tag\">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"selector-tag\">build</span> <span class=\"selector-tag\">by</span> <span class=\"selector-tag\">mockbuild</span>@, <span class=\"selector-tag\">2018-11-03</span> <span class=\"selector-tag\">01</span><span class=\"selector-pseudo\">:26</span><span class=\"selector-pseudo\">:55</span></span><br><span class=\"line\"> <span class=\"selector-tag\">0</span>: <span class=\"selector-tag\">cs</span><span class=\"selector-pseudo\">:Connected</span> <span class=\"selector-tag\">ro</span><span class=\"selector-pseudo\">:Primary</span>/<span class=\"selector-tag\">Secondary</span> <span class=\"selector-tag\">ds</span><span class=\"selector-pseudo\">:UpToDate</span>/<span class=\"selector-tag\">UpToDate</span> <span class=\"selector-tag\">C</span> <span class=\"selector-tag\">r-----</span></span><br><span class=\"line\">    <span class=\"selector-tag\">ns</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">nr</span><span class=\"selector-pseudo\">:10783808</span> <span class=\"selector-tag\">dw</span><span class=\"selector-pseudo\">:10783808</span> <span class=\"selector-tag\">dr</span><span class=\"selector-pseudo\">:2120</span> <span class=\"selector-tag\">al</span><span class=\"selector-pseudo\">:8</span> <span class=\"selector-tag\">bm</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">lo</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">pe</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ua</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ap</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ep</span><span class=\"selector-pseudo\">:1</span> <span class=\"selector-tag\">wo</span><span class=\"selector-pseudo\">:f</span> <span class=\"selector-tag\">oos</span><span class=\"selector-pseudo\">:0</span></span><br><span class=\"line\"></span><br><span class=\"line\">#挂载验证数据</span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">mkdir</span> /<span class=\"selector-tag\">data</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">mount</span> /<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">drbd0</span> /<span class=\"selector-tag\">data</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">df</span> <span class=\"selector-tag\">-h</span></span><br><span class=\"line\">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class=\"line\">/<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">mapper</span>/<span class=\"selector-tag\">centos-root</span>   <span class=\"selector-tag\">20G</span>  <span class=\"selector-tag\">3</span><span class=\"selector-class\">.7G</span>   <span class=\"selector-tag\">16G</span>   <span class=\"selector-tag\">20%</span> /</span><br><span class=\"line\"><span class=\"selector-tag\">devtmpfs</span>                 <span class=\"selector-tag\">471M</span>     <span class=\"selector-tag\">0</span>  <span class=\"selector-tag\">471M</span>    <span class=\"selector-tag\">0%</span> /<span class=\"selector-tag\">dev</span></span><br><span class=\"line\"><span class=\"selector-tag\">tmpfs</span>                    <span class=\"selector-tag\">487M</span>     <span class=\"selector-tag\">0</span>  <span class=\"selector-tag\">487M</span>    <span class=\"selector-tag\">0%</span> /<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">shm</span></span><br><span class=\"line\"><span class=\"selector-tag\">tmpfs</span>                    <span class=\"selector-tag\">487M</span>  <span class=\"selector-tag\">7</span><span class=\"selector-class\">.1M</span>  <span class=\"selector-tag\">480M</span>    <span class=\"selector-tag\">2%</span> /<span class=\"selector-tag\">run</span></span><br><span class=\"line\"><span class=\"selector-tag\">tmpfs</span>                    <span class=\"selector-tag\">487M</span>     <span class=\"selector-tag\">0</span>  <span class=\"selector-tag\">487M</span>    <span class=\"selector-tag\">0%</span> /<span class=\"selector-tag\">sys</span>/<span class=\"selector-tag\">fs</span>/<span class=\"selector-tag\">cgroup</span></span><br><span class=\"line\">/<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">sda1</span>                <span class=\"selector-tag\">497M</span>  <span class=\"selector-tag\">193M</span>  <span class=\"selector-tag\">305M</span>   <span class=\"selector-tag\">39%</span> /<span class=\"selector-tag\">boot</span></span><br><span class=\"line\"><span class=\"selector-tag\">tmpfs</span>                     <span class=\"selector-tag\">98M</span>     <span class=\"selector-tag\">0</span>   <span class=\"selector-tag\">98M</span>    <span class=\"selector-tag\">0%</span> /<span class=\"selector-tag\">run</span>/<span class=\"selector-tag\">user</span>/<span class=\"selector-tag\">0</span></span><br><span class=\"line\">/<span class=\"selector-tag\">dev</span>/<span class=\"selector-tag\">drbd0</span>               <span class=\"selector-tag\">9</span><span class=\"selector-class\">.8G</span>   <span class=\"selector-tag\">37M</span>  <span class=\"selector-tag\">9</span><span class=\"selector-class\">.2G</span>    <span class=\"selector-tag\">1%</span> /<span class=\"selector-tag\">data</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 ~]</span># <span class=\"selector-tag\">cd</span> /<span class=\"selector-tag\">data</span>/</span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd2 data]</span># <span class=\"selector-tag\">ls</span></span><br><span class=\"line\"><span class=\"selector-tag\">test01</span>  <span class=\"selector-tag\">test02</span>  <span class=\"selector-tag\">test03</span></span><br></pre></td></tr></table></figure></p>\n<p>到此，<code>DRBD</code>的主从环境的部署工作已经完成。不过上面是记录的是主备手动切换，至于保证<code>DRBD</code>主从结构的智能切换，实现高可用，还需里用到<code>Keepalived</code>或<code>Heartbeat</code>来实现了（会在<code>DRBD</code>主端挂掉的情况下，自动切换从端为主端并自动挂载<code>/data</code>分区）</p>\n<h1 id=\"相关配置操作\"><a href=\"#相关配置操作\" class=\"headerlink\" title=\"相关配置操作\"></a>相关配置操作</h1><h2 id=\"资源的连接状态详细介绍\"><a href=\"#资源的连接状态详细介绍\" class=\"headerlink\" title=\"资源的连接状态详细介绍\"></a>资源的连接状态详细介绍</h2><p>如何查看资源连接状态？<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@drbd1</span> ~]<span class=\"meta\"># drbdadm cstate r0    #r0为资源名称</span></span><br><span class=\"line\">Connected</span><br></pre></td></tr></table></figure></p>\n<p>资源的连接状态；一个资源可能有一下连接状态的一种<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">StandAlone 独立的：网络配置不可用；资源还没有被连接或是被管理断开（使用 drbdadm <span class=\"keyword\">disconnect </span>命令），或是由于出现认证失败或是脑裂的情况 </span><br><span class=\"line\"><span class=\"keyword\">Disconnecting </span>断开：断开只是临时状态，下一个状态是StandAlone独立的 modprobe drbd</span><br><span class=\"line\">Unconnected 悬空：是尝试连接前的临时状态，可能下一个状态为WFconnection和WFReportParams </span><br><span class=\"line\">Timeout 超时：与对等节点连接超时，也是临时状态，下一个状态为Unconected悬空 </span><br><span class=\"line\"><span class=\"keyword\">BrokerPipe：与对等节点连接丢失，也是临时状态，下一个状态为Unconected悬空 </span></span><br><span class=\"line\">NetworkFailure：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空 </span><br><span class=\"line\">ProtocolError：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空 </span><br><span class=\"line\">TearDown 拆解：临时状态，对等节点关闭，下一个状态为Unconected悬空 </span><br><span class=\"line\">WFConnection：等待和对等节点建立网络连接 </span><br><span class=\"line\">WFReportParams：已经建立TCP连接，本节点等待从对等节点传来的第一个网络包 </span><br><span class=\"line\">Connected 连接：DRBD已经建立连接，数据镜像现在可用，节点处于正常状态 </span><br><span class=\"line\">StartingSyncS：完全同步，有管理员发起的刚刚开始同步，未来可能的状态为<span class=\"keyword\">SyncSource或PausedSyncS </span></span><br><span class=\"line\">StartingSyncT：完全同步，有管理员发起的刚刚开始同步，下一状态为WFSyncUUID </span><br><span class=\"line\">WFBitMapS：部分同步刚刚开始，下一步可能的状态为<span class=\"keyword\">SyncSource或PausedSyncS </span></span><br><span class=\"line\">WFBitMapT：部分同步刚刚开始，下一步可能的状态为WFSyncUUID </span><br><span class=\"line\">WFSyncUUID：同步即将开始，下一步可能的状态为<span class=\"keyword\">SyncTarget或PausedSyncT </span></span><br><span class=\"line\"><span class=\"keyword\">SyncSource：以本节点为同步源的同步正在进行 </span></span><br><span class=\"line\"><span class=\"keyword\">SyncTarget：以本节点为同步目标的同步正在进行 </span></span><br><span class=\"line\"><span class=\"keyword\">PausedSyncS：以本地节点是一个持续同步的源，但是目前同步已经暂停，可能是因为另外一个同步正在进行或是使用命令(drbdadm </span><span class=\"keyword\">pause-sync)暂停了同步 </span></span><br><span class=\"line\"><span class=\"keyword\">PausedSyncT：以本地节点为持续同步的目标，但是目前同步已经暂停，这可以是因为另外一个同步正在进行或是使用命令(drbdadm </span><span class=\"keyword\">pause-sync)暂停了同步 </span></span><br><span class=\"line\">VerifyS：以本地节点为验证源的线上设备验证正在执行 </span><br><span class=\"line\">VerifyT：以本地节点为验证目标的线上设备验证正在执行</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"资源角色\"><a href=\"#资源角色\" class=\"headerlink\" title=\"资源角色\"></a>资源角色</h2><p>查看资源角色命令<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">drbdadm</span> <span class=\"selector-tag\">role</span> <span class=\"selector-tag\">r0</span></span><br><span class=\"line\"><span class=\"selector-tag\">Secondary</span>/<span class=\"selector-tag\">Primary</span></span><br><span class=\"line\"><span class=\"selector-attr\">[root@drbd1 ~]</span># <span class=\"selector-tag\">cat</span> /<span class=\"selector-tag\">proc</span>/<span class=\"selector-tag\">drbd</span> </span><br><span class=\"line\"><span class=\"selector-tag\">version</span>: <span class=\"selector-tag\">8</span><span class=\"selector-class\">.4</span><span class=\"selector-class\">.11-1</span> (<span class=\"attribute\">api</span>:<span class=\"number\">1</span>/<span class=\"attribute\">proto</span>:<span class=\"number\">86</span>-<span class=\"number\">101</span>)</span><br><span class=\"line\"><span class=\"selector-tag\">GIT-hash</span>: <span class=\"selector-tag\">66145a308421e9c124ec391a7848ac20203bb03c</span> <span class=\"selector-tag\">build</span> <span class=\"selector-tag\">by</span> <span class=\"selector-tag\">mockbuild</span>@, <span class=\"selector-tag\">2018-11-03</span> <span class=\"selector-tag\">01</span><span class=\"selector-pseudo\">:26</span><span class=\"selector-pseudo\">:55</span></span><br><span class=\"line\"> <span class=\"selector-tag\">0</span>: <span class=\"selector-tag\">cs</span><span class=\"selector-pseudo\">:Connected</span> <span class=\"selector-tag\">ro</span><span class=\"selector-pseudo\">:Secondary</span>/<span class=\"selector-tag\">Primary</span> <span class=\"selector-tag\">ds</span><span class=\"selector-pseudo\">:UpToDate</span>/<span class=\"selector-tag\">UpToDate</span> <span class=\"selector-tag\">C</span> <span class=\"selector-tag\">r-----</span></span><br><span class=\"line\">    <span class=\"selector-tag\">ns</span><span class=\"selector-pseudo\">:10783808</span> <span class=\"selector-tag\">nr</span><span class=\"selector-pseudo\">:24</span> <span class=\"selector-tag\">dw</span><span class=\"selector-pseudo\">:299452</span> <span class=\"selector-tag\">dr</span><span class=\"selector-pseudo\">:10488701</span> <span class=\"selector-tag\">al</span><span class=\"selector-pseudo\">:82</span> <span class=\"selector-tag\">bm</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">lo</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">pe</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ua</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ap</span><span class=\"selector-pseudo\">:0</span> <span class=\"selector-tag\">ep</span><span class=\"selector-pseudo\">:1</span> <span class=\"selector-tag\">wo</span><span class=\"selector-pseudo\">:f</span> <span class=\"selector-tag\">oos</span><span class=\"selector-pseudo\">:0</span></span><br><span class=\"line\"></span><br><span class=\"line\">注释：</span><br><span class=\"line\"><span class=\"selector-tag\">Parimary</span> 主：资源目前为主，并且可能正在被读取或写入，如果不是双主只会出现在两个节点中的其中一个节点上 </span><br><span class=\"line\"><span class=\"selector-tag\">Secondary</span> 次：资源目前为次，正常接收对等节点的更新 </span><br><span class=\"line\"><span class=\"selector-tag\">Unknown</span> 未知：资源角色目前未知，本地的资源不会出现这种状态</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"硬盘数据状态\"><a href=\"#硬盘数据状态\" class=\"headerlink\" title=\"硬盘数据状态\"></a>硬盘数据状态</h2><p>查看硬盘状态命令<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@drbd1</span> ~]<span class=\"meta\"># drbdadm dstate r0</span></span><br><span class=\"line\">UpToDate/UpToDate</span><br></pre></td></tr></table></figure></p>\n<p>本地和对等节点的硬盘有可能为下列状态之一：<br><figure class=\"highlight mathematica\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Diskless 无盘：本地没有块设备分配给DRBD使用，这表示没有可用的设备，或者使用drbdadm命令手工分离或是底层的<span class=\"keyword\">I</span>/<span class=\"keyword\">O</span>错误导致自动分离 </span><br><span class=\"line\">Attaching：读取无数据时候的瞬间状态 </span><br><span class=\"line\">Failed 失败：本地块设备报告<span class=\"keyword\">I</span>/<span class=\"keyword\">O</span>错误的下一个状态，其下一个状态为Diskless无盘 </span><br><span class=\"line\">Negotiating：在已经连接的DRBD设置进行Attach读取无数据前的瞬间状态 </span><br><span class=\"line\">Inconsistent：数据是不一致的，在两个节点上（初始的完全同步前）这种状态出现后立即创建一个新的资源。此外，在同步期间（同步目标）在一个节点上出现这种状态 </span><br><span class=\"line\">Outdated：数据资源是一致的，但是已经过时 </span><br><span class=\"line\">DUnknown：当对等节点网络连接不可用时出现这种状态 </span><br><span class=\"line\">Consistent：一个没有连接的节点数据一致，当建立连接时，它决定数据是UpToDate或是Outdated </span><br><span class=\"line\">UpToDate：一致的最新的数据状态，这个状态为正常状态</span><br></pre></td></tr></table></figure></p>\n"},{"title":"Kubernetes 系统基础","date":"2019-10-24T09:20:22.000Z","copyright":true,"_content":"\n# Kubernetes介绍\n\n## 什么是Kubernetes？\n\n> `Kubernetes`是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。\n>\n> 使用`Kubernetes`可以：\n>\n> - 自动化容器的部署和复制\n> - 随时扩展或收缩容器规模\n> - 将容器组织成组，并且提供容器间的负载均衡\n> - 很容易地升级应用程序容器的新版本\n> - 节省资源，优化硬件资源的使用\n> - 提供容器弹性，如果容器失效就替换它，等等...\n\n\n\n## Kubernetes特点\n\n> - **便携性**：支持公有云、私有云、混合云、多重云(multi-cloud)\n> - **可扩展**：模块化、插件化、可组合、可挂载\n> - **自修复**：自动部署，自动重启，自动复制，自动伸缩扩展\n\n\n\n##Kubernetes特性\n\n> Kubernetes是一种用于在一组主机上运行和协同容器化应用程序的系统，旨在提供可预测性、可扩展性与高可用的性的方法来完全管理容器化应用程序和服务的生命周期的平台。\n>\n> 它具有以下几个重要的特性：\n>\n> 1. **自动装箱**：构建于容器之上，基于资源依赖及其他约束自动完成容器部署且不影响其可用性，并通过调度机制混合关键型应用和非关键型应用的工作负载于同一节点以提升资源利用率。\n> 2. **自我修复**：支持容器故障后自动重启、节点故障候重行调度容器，以及其他可用节点、健康状态检查失败后关闭容器并重新创建等自我修复机制。\n> 3. **水平扩展**：支持通过简单命令或UI手动水平扩展，以及基于CPU等资源负载率的自动水平扩展机制。\n> 4. **服务器发现和负载均衡**：Kubernetes通过其附加组件之一的KubeDNS（或CoreDNS）为系统内置了服务发现功能，它会为每个Service配置DNS名称，并允许集群内的客户端直接使用此名称发出访问请求，而Service则通过iptables或ipvs内建了负载均衡机制。\n> 5. **自动发布和回滚**：Kubernetes支持“灰度”更新应用程序或其配置信息，它会监控更新过程中应用程序的健康状态，以确保它不会在同一时刻杀掉所有的实例，而此过程中一旦有故障发生，就会立即自动执行回滚操作。\n> 6. **秘钥和配置管理**：Kubernetes允许存储和管理敏感信息，例如密码，Oauth令牌和ssh秘钥。可以部署和更新密码和应用程序配置，而无需重建容器，也不会再堆栈配置中暴露机密。\n> 7. **存储编排**：Kubernetes支持Pod对象按需自动挂载不同类型的存储系统，这包括节点本地存储、公有云服务商的云存储（如AWS和GCP等），以及网络存储系统（例如，NFS、ISCSI、GlusterFS、Ceph、Cinder和Flocker等）\n> 8. **批量处理执行**：除了服务型应用，Kubernetes还支持批处理作业及CI（持续集成），如果需要，一样可以实现容器故障后修复。\n\n\n\n# Kubernetes概述和术语\n\n> Kubernetes使用共享网络将多个物理机或虚拟机汇集到一个集群中，在各服务器之间进行通信，该集群是配置Kubernetes的所有组件、功能和工作负载的物理平台。集群中一台服务器（或高可用部署中的一组服务器）用作Master，负责管理整个集群，余下的其他机器用作Worker Node,它们是使用本地和外部资源接收和运行工作负载的服务器。集群中的这些主机可以是物理服务器，也可以是虚拟机（包括IaaS云端的VPS）\n\n![]((一)Kubernetes系统基础/kubernetescluster.png)\n\n**Master**\n\n> Master是集群的网关和中枢，负责诸如为用户和客户端暴露API、跟踪其它服务器的健康状态、以最优方式调度工作负载，以及编排其他组件之间的通信等任务，它是用户或客户端与集群之间的核心联络点，并负责Kubernetes系统的大多数集中式管控逻辑。单个Master节点即可完成其所有的功能，但出于冗余及负载均衡等目的，生产环境中通常需要协同部署多个此类主机。Master节点类似于蜂群中的蜂王。\n\n\n\n**Node**\n\n> Node是Kubernetes集群的工作节点，负责接收来自Master的工作指令并根据指令相应的创建或删除Pod对象，以及调整网络规则以合理地路由和转发流量等。理论上讲，Node可以是任何形式的计算设备，不过Master会统一将其抽象为Node对象进行管理。Node类似于蜂群中的工蜂，生产环境中，它们通常数量众多。\n\n\n\n----\n\n> Kubernetes将所有Node的资源集结于一处形成一台更强大的“服务器”，如下图，在用户将应用部署于其上时，Master会使用调度算法将其自动指派某个特定的Node运行，在Node加入集群或从集群中移除时，Master也会按需重行编排影响到的Pod（容器）。于是，用户无需关心其应用究竟运行于何处。\n\n\n\n![]((一)Kubernetes系统基础/cluster.png)\n\n> 从抽象的角度来讲，Kubernetes还有着众多的组件来支撑其内部的业务逻辑，包括运行应用、应用编排、服务暴露、应用恢复等，它们在Kubernetes中被抽象为Pod、Service、Controller等资源类型。\n\n\n\n## 常用的资源对象\n\n[十分钟带你理解Kubernetes核心概念](http://www.dockone.io/article/932)\n\n（1）Pod\n\n> Kubernetes并不直接运行容器，而是使用一个抽象的资源对象来封装一个或者多个容器，这个抽象即为Pod，它是Kubernetes的最小调度单元。同一Pod中的容器共享网络名称空间和存储资源，这些容器可经由本地回环接口lo直接通信，但彼此之间又在Mount、User及PID等名称空间上保持了隔离。尽管Pod中可以包含多个容器，但是作为最小调度单元，它应该尽可能地保持“小”，即通常只应该包含一个主容器，以及必要的辅助型容器（sidecar）\n\n![]((一)Kubernetes系统基础/pod.png)\n\n（2）资源标签\n\n> 标签（Label）是将资源进行分类的标识符，资源标签其实就是一个键值型（key/values）数据。标签旨在指定对象（如Pod等）辨识性的属性，这些属性仅对用户存在特定的意义，对Kubernetes集群来说并不直接表达核心系统语意。标签可以在对象创建时附加其上，并能够在创建后的任意时间进行添加和修改。一个对象可以拥有多个标签，一个标签也可以附加于多个对象（通常是同一类对象）之上。\n\n![]((一)Kubernetes系统基础/label.png)\n\n（3）标签选择器\n\n> 标签选择器（Selector）全称为”Label Selector“，它是一种根据Label来过滤符合条件的资源对象的机制。例如，将附有标签”role：backend“的所有Pod对象挑选出来归为一组就是标签选择器的一种应用，如下图所示，通常使用标签对资源对象进行分类，而后使用标签选择器挑选出它们，例如将其创建未某Service的端点。\n\n![]((一)Kubernetes系统基础/labels.png)\n\n（4）Pod控制器\n\n> 尽管Pod是kubernetes的最小调度单元，但用户通常并不会直接部署及管理Pod对象，而是要借助于另一类抽象——控制器（Controller）对其进行管理。用于工作负载的控制器是一种管理Pod生命周期的资源抽象，它们是kubernetes上的一类对象，而非单个资源对象，包括ReplicationController，ReplicaSet、Deployment、StatefulSet、Job等。已下图所示的Deployment控制器为例，它负责确保指定的Pod对象的副本数量精确符合定义，否则“多退少补”。使用控制器之后就不再需要手动管理Pod对象了，只需要声明应用的期望状态，控制器就会自动对其进行进程管理。\t\n\n![]((一)Kubernetes系统基础/deployment.png)\n\n（5）服务资源（Service）\n\n> Service是建立在一组Pod对象之上的资源抽象，它通过标签选择器选定一组Pod对象，并为这组Pod对象定义一个统一的固定访问入口（通常是一个IP地址），若Kubernetes集群存在DNS附件，它就会在Service创建时为其自动配置一个DNS名称以便客户端进行服务发现。到达Service IP的请求将被负载均衡至其后的端点——各个Pod对象之上，因此Service从本质上来讲是一个四层代理服务。另外，service还可以将集群外部流量引入到集群中来。\n\n\n\n（6）存储卷\n\n> 存储卷（Volume）是独立于容器文件系统之外的存储空间，常用于扩展容器的存储空间并为它提供持久存储能力。Kubernetes集群上的存储卷大体可以分为临时卷、本地卷和网络卷。临时卷和本地卷都位于Node本地，一旦Pod被调度至其他Node，此种类型的存储卷将无法访问到，因此临时卷和本地卷通常用于数据缓存，持久化的数据则需要放置于持久卷（persistent volume）之上。\n\n\n\n（7）Name和Namespace\n\n> 名称（Name）是Kubernetes集群中资源对象的标识符，它们的作用域通常是名称空间（Namespace），因此名称空间是名称的额外的限定机制。在同一名称空间中，同一类型资源对象的名称必须具有唯一性。名称空间通常用于实现租户或项目的资源隔离，从而形成逻辑分组，如下图所示，创建的Pod和Service等资源对象都属于名称空间级别，未指定时，他们都属于默认的名称空间“default”。\n\n![]((一)Kubernetes系统基础/namespace.png)\n\n（8）Annotation\n\n> Annotation（注释）是另一种附加在对象之上的键值类型的数据，但它拥有更大的数据容量。Annotation常用于将各种非标识型元数据（metadata）附加到对象上，但它不能用于标识和选择对象，通常也不会被Kubernetes直接使用，其主要目的是方便工具或用户的阅读和查找等。\n\n\n\n（9）Ingress\n\n> Kubernetes将Pod对象和外部网络环境进行了隔离，Pod和Service等对象间的通信都使用其内部专用地址进行，如若需要开放某些Pod对象提供给外部用户访问，则需要为其请求流量打开一个通往Kubernetes集群内部的通道，除了Service之外，Ingress也是这类通道的实现方式之一。\n\n\n\n# Kubernetes集群组件\n\n![]((一)Kubernetes系统基础/system.png)\n\n## Master组件\n\n> Kubernetes的集群控制平面由多个组件组成，这些组件可统一运行于单一Master节点，也可以以多副本的方式同时运行于多个节点，以为Master提供高可用功能，甚至还可以运行于Kubernetes集群自身之上。Master主要包括以下几个组件。\n\n（1）API Server\n\n> Api Server负责输出RESTful风格的Kubernetes API，它是发往集群的所有REST操作命令的接入点，并负责接收、校验并响应所有的REST请求，结果状态被持久存储于etcd中。因此，API Server是整个集群的网关。\n\n（2）ETCD\n\n> Kubernetes集群的所有状态信息都需要持久存储于存储系统etcd中，不过，etcd是由CoreOS基于Raft协议开发的分布式键值存储，可用于服务发现、共享配置以及一致性保障（例如数据库主节点选择、分布式锁等）。因此，etcd是独立的服务组件，并不隶属于Kubernetes集群自身。生产环境中应该以etcd集群的方式运行以确保其服务可用性。\n>\n> etcd不仅能够提供键值数据存储，而且还为其提供了监听（watch）机制，用于监听和推送变更。Kubernetes集群系统中，etcd中的键值发生变化时会通知到API Server，并由其通过watch API向客户端输出。基于watch机制，Kubernetes集群的各组件实现了高效协同。\n\n（3）Controller Manager\n\n> Kubernetes中，集群级别的大多数功能都是由几个被称为控制器的进程执行实现的，这几个进程被集成与kube-controller-manager守护进程中。由控制器完成的功能主要包括生命周期功能和API业务逻辑，具体如下\n>\n> - 生命周期功能：包括Namespace创建和生命周期、Event垃圾回收、Pod终止相关的垃圾回收、级联垃圾回收及Node垃圾回收等。\n> - API业务逻辑：例如，由ReplicaSet执行的Pod扩展等。\n\n（4）Scheduler\n\n> Kubernetes是用于部署和管理大规模容器应用的平台，根据集群规模的不同，其托管运行的容器很可能会数以千计甚至更多。API Server确认Pod对象的创建请求之后，便需要由Scheduler根据集群内各节点的可用资源状态，以及要运行的容器的资源需求做出调度决策，如下图所示。另外，Kubernetes还支持用户自定义调度器。\n\n![]((一)Kubernetes系统基础/scheduler.png)\n\n\n\n## Node组件\n\n> Node负责提供运行容器的各种依赖环境，并接收Master的管理。每个Node主要由以下几个组件构成。\n\n（1）kubelet\n\n> kubelet是运行于工作节点之上的守护进程，它从API Server接收关于Pod对象的配置信息并确保它们处于期望的状态（desired state，也可以说目标状态）kubelet会在API Server上注册当前工作节点，定期向Master汇报节点资源使用情况，并通过cAdvisor监控容器和节点的资源占用情况。\n\n（2）kube-proxy\n\n> 每个工作节点都需要运行一个kube-proxy守护进程，它能够按需为Service资源对象生成iptables或ipvs规则，从而捕获访问当前Service的ClusterIP的流量并将其转发至正确的后端Pod对象。\n\n（3）docker\n\n> docker用于运行容器\n\n## 核心附件\n\n> Kubernetes集群还依赖于一组称为\"附件\"(add-ons)的组件以提供完整的功能，它们通常是由第三方提供的特定应用程序，且托管运行于Kubernetes集群之上，如上图所示。\n\n- KubeDNS\n\n  > 在Kubernetes集群中调度运行提供DNS服务的Pod，同一集群中的其他pod可使用此DNS服务解决主机名。Kubernetes从1.11版本开始默认使用CoreDNS项目为集群提供服务注册和服务发现的动态名称解析服务，之前的版本中用到的是kube-dns项目，而SKyDNS则是更早一代的项目。\n\n- Kubernetes Dashboard\n\n  > Kubernetes集群的全部功能都要基于Web的UI，来管理集群中应用甚至是集群自身。\n\n- Heapster\n\n  > 容器和节点的性能监控与分析系统，它收集并解析多种指标数据，如资源利用率、生命周期事件等。新版本的Kubernetes中，其功能会逐渐由Prometheus结合其他组件所取代。\n\n- Ingress Controller\n\n  > Service是一种工作于传输层的负载均衡器，而Ingress是在应用层实现的HTTP(s)负载均衡机制。不过，Ingress资源自身不能进行“流量穿透”，它仅是一组路由规则的集合，这些规则需要通过Ingress控制器（Ingress Controller）发挥作用。目前，此类的可用项目有Nginx、Traefik、Envoy及HAProxy等。\n\n\n\n\n\n\n\n","source":"_posts/(一)Kubernetes系统基础.md","raw":"---\ntitle: Kubernetes 系统基础 \ndate: 2019-10-24 17:20:22\ntags: Kubernetes\ncategories: Kubernetes\ncopyright: true\n---\n\n# Kubernetes介绍\n\n## 什么是Kubernetes？\n\n> `Kubernetes`是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。\n>\n> 使用`Kubernetes`可以：\n>\n> - 自动化容器的部署和复制\n> - 随时扩展或收缩容器规模\n> - 将容器组织成组，并且提供容器间的负载均衡\n> - 很容易地升级应用程序容器的新版本\n> - 节省资源，优化硬件资源的使用\n> - 提供容器弹性，如果容器失效就替换它，等等...\n\n\n\n## Kubernetes特点\n\n> - **便携性**：支持公有云、私有云、混合云、多重云(multi-cloud)\n> - **可扩展**：模块化、插件化、可组合、可挂载\n> - **自修复**：自动部署，自动重启，自动复制，自动伸缩扩展\n\n\n\n##Kubernetes特性\n\n> Kubernetes是一种用于在一组主机上运行和协同容器化应用程序的系统，旨在提供可预测性、可扩展性与高可用的性的方法来完全管理容器化应用程序和服务的生命周期的平台。\n>\n> 它具有以下几个重要的特性：\n>\n> 1. **自动装箱**：构建于容器之上，基于资源依赖及其他约束自动完成容器部署且不影响其可用性，并通过调度机制混合关键型应用和非关键型应用的工作负载于同一节点以提升资源利用率。\n> 2. **自我修复**：支持容器故障后自动重启、节点故障候重行调度容器，以及其他可用节点、健康状态检查失败后关闭容器并重新创建等自我修复机制。\n> 3. **水平扩展**：支持通过简单命令或UI手动水平扩展，以及基于CPU等资源负载率的自动水平扩展机制。\n> 4. **服务器发现和负载均衡**：Kubernetes通过其附加组件之一的KubeDNS（或CoreDNS）为系统内置了服务发现功能，它会为每个Service配置DNS名称，并允许集群内的客户端直接使用此名称发出访问请求，而Service则通过iptables或ipvs内建了负载均衡机制。\n> 5. **自动发布和回滚**：Kubernetes支持“灰度”更新应用程序或其配置信息，它会监控更新过程中应用程序的健康状态，以确保它不会在同一时刻杀掉所有的实例，而此过程中一旦有故障发生，就会立即自动执行回滚操作。\n> 6. **秘钥和配置管理**：Kubernetes允许存储和管理敏感信息，例如密码，Oauth令牌和ssh秘钥。可以部署和更新密码和应用程序配置，而无需重建容器，也不会再堆栈配置中暴露机密。\n> 7. **存储编排**：Kubernetes支持Pod对象按需自动挂载不同类型的存储系统，这包括节点本地存储、公有云服务商的云存储（如AWS和GCP等），以及网络存储系统（例如，NFS、ISCSI、GlusterFS、Ceph、Cinder和Flocker等）\n> 8. **批量处理执行**：除了服务型应用，Kubernetes还支持批处理作业及CI（持续集成），如果需要，一样可以实现容器故障后修复。\n\n\n\n# Kubernetes概述和术语\n\n> Kubernetes使用共享网络将多个物理机或虚拟机汇集到一个集群中，在各服务器之间进行通信，该集群是配置Kubernetes的所有组件、功能和工作负载的物理平台。集群中一台服务器（或高可用部署中的一组服务器）用作Master，负责管理整个集群，余下的其他机器用作Worker Node,它们是使用本地和外部资源接收和运行工作负载的服务器。集群中的这些主机可以是物理服务器，也可以是虚拟机（包括IaaS云端的VPS）\n\n![]((一)Kubernetes系统基础/kubernetescluster.png)\n\n**Master**\n\n> Master是集群的网关和中枢，负责诸如为用户和客户端暴露API、跟踪其它服务器的健康状态、以最优方式调度工作负载，以及编排其他组件之间的通信等任务，它是用户或客户端与集群之间的核心联络点，并负责Kubernetes系统的大多数集中式管控逻辑。单个Master节点即可完成其所有的功能，但出于冗余及负载均衡等目的，生产环境中通常需要协同部署多个此类主机。Master节点类似于蜂群中的蜂王。\n\n\n\n**Node**\n\n> Node是Kubernetes集群的工作节点，负责接收来自Master的工作指令并根据指令相应的创建或删除Pod对象，以及调整网络规则以合理地路由和转发流量等。理论上讲，Node可以是任何形式的计算设备，不过Master会统一将其抽象为Node对象进行管理。Node类似于蜂群中的工蜂，生产环境中，它们通常数量众多。\n\n\n\n----\n\n> Kubernetes将所有Node的资源集结于一处形成一台更强大的“服务器”，如下图，在用户将应用部署于其上时，Master会使用调度算法将其自动指派某个特定的Node运行，在Node加入集群或从集群中移除时，Master也会按需重行编排影响到的Pod（容器）。于是，用户无需关心其应用究竟运行于何处。\n\n\n\n![]((一)Kubernetes系统基础/cluster.png)\n\n> 从抽象的角度来讲，Kubernetes还有着众多的组件来支撑其内部的业务逻辑，包括运行应用、应用编排、服务暴露、应用恢复等，它们在Kubernetes中被抽象为Pod、Service、Controller等资源类型。\n\n\n\n## 常用的资源对象\n\n[十分钟带你理解Kubernetes核心概念](http://www.dockone.io/article/932)\n\n（1）Pod\n\n> Kubernetes并不直接运行容器，而是使用一个抽象的资源对象来封装一个或者多个容器，这个抽象即为Pod，它是Kubernetes的最小调度单元。同一Pod中的容器共享网络名称空间和存储资源，这些容器可经由本地回环接口lo直接通信，但彼此之间又在Mount、User及PID等名称空间上保持了隔离。尽管Pod中可以包含多个容器，但是作为最小调度单元，它应该尽可能地保持“小”，即通常只应该包含一个主容器，以及必要的辅助型容器（sidecar）\n\n![]((一)Kubernetes系统基础/pod.png)\n\n（2）资源标签\n\n> 标签（Label）是将资源进行分类的标识符，资源标签其实就是一个键值型（key/values）数据。标签旨在指定对象（如Pod等）辨识性的属性，这些属性仅对用户存在特定的意义，对Kubernetes集群来说并不直接表达核心系统语意。标签可以在对象创建时附加其上，并能够在创建后的任意时间进行添加和修改。一个对象可以拥有多个标签，一个标签也可以附加于多个对象（通常是同一类对象）之上。\n\n![]((一)Kubernetes系统基础/label.png)\n\n（3）标签选择器\n\n> 标签选择器（Selector）全称为”Label Selector“，它是一种根据Label来过滤符合条件的资源对象的机制。例如，将附有标签”role：backend“的所有Pod对象挑选出来归为一组就是标签选择器的一种应用，如下图所示，通常使用标签对资源对象进行分类，而后使用标签选择器挑选出它们，例如将其创建未某Service的端点。\n\n![]((一)Kubernetes系统基础/labels.png)\n\n（4）Pod控制器\n\n> 尽管Pod是kubernetes的最小调度单元，但用户通常并不会直接部署及管理Pod对象，而是要借助于另一类抽象——控制器（Controller）对其进行管理。用于工作负载的控制器是一种管理Pod生命周期的资源抽象，它们是kubernetes上的一类对象，而非单个资源对象，包括ReplicationController，ReplicaSet、Deployment、StatefulSet、Job等。已下图所示的Deployment控制器为例，它负责确保指定的Pod对象的副本数量精确符合定义，否则“多退少补”。使用控制器之后就不再需要手动管理Pod对象了，只需要声明应用的期望状态，控制器就会自动对其进行进程管理。\t\n\n![]((一)Kubernetes系统基础/deployment.png)\n\n（5）服务资源（Service）\n\n> Service是建立在一组Pod对象之上的资源抽象，它通过标签选择器选定一组Pod对象，并为这组Pod对象定义一个统一的固定访问入口（通常是一个IP地址），若Kubernetes集群存在DNS附件，它就会在Service创建时为其自动配置一个DNS名称以便客户端进行服务发现。到达Service IP的请求将被负载均衡至其后的端点——各个Pod对象之上，因此Service从本质上来讲是一个四层代理服务。另外，service还可以将集群外部流量引入到集群中来。\n\n\n\n（6）存储卷\n\n> 存储卷（Volume）是独立于容器文件系统之外的存储空间，常用于扩展容器的存储空间并为它提供持久存储能力。Kubernetes集群上的存储卷大体可以分为临时卷、本地卷和网络卷。临时卷和本地卷都位于Node本地，一旦Pod被调度至其他Node，此种类型的存储卷将无法访问到，因此临时卷和本地卷通常用于数据缓存，持久化的数据则需要放置于持久卷（persistent volume）之上。\n\n\n\n（7）Name和Namespace\n\n> 名称（Name）是Kubernetes集群中资源对象的标识符，它们的作用域通常是名称空间（Namespace），因此名称空间是名称的额外的限定机制。在同一名称空间中，同一类型资源对象的名称必须具有唯一性。名称空间通常用于实现租户或项目的资源隔离，从而形成逻辑分组，如下图所示，创建的Pod和Service等资源对象都属于名称空间级别，未指定时，他们都属于默认的名称空间“default”。\n\n![]((一)Kubernetes系统基础/namespace.png)\n\n（8）Annotation\n\n> Annotation（注释）是另一种附加在对象之上的键值类型的数据，但它拥有更大的数据容量。Annotation常用于将各种非标识型元数据（metadata）附加到对象上，但它不能用于标识和选择对象，通常也不会被Kubernetes直接使用，其主要目的是方便工具或用户的阅读和查找等。\n\n\n\n（9）Ingress\n\n> Kubernetes将Pod对象和外部网络环境进行了隔离，Pod和Service等对象间的通信都使用其内部专用地址进行，如若需要开放某些Pod对象提供给外部用户访问，则需要为其请求流量打开一个通往Kubernetes集群内部的通道，除了Service之外，Ingress也是这类通道的实现方式之一。\n\n\n\n# Kubernetes集群组件\n\n![]((一)Kubernetes系统基础/system.png)\n\n## Master组件\n\n> Kubernetes的集群控制平面由多个组件组成，这些组件可统一运行于单一Master节点，也可以以多副本的方式同时运行于多个节点，以为Master提供高可用功能，甚至还可以运行于Kubernetes集群自身之上。Master主要包括以下几个组件。\n\n（1）API Server\n\n> Api Server负责输出RESTful风格的Kubernetes API，它是发往集群的所有REST操作命令的接入点，并负责接收、校验并响应所有的REST请求，结果状态被持久存储于etcd中。因此，API Server是整个集群的网关。\n\n（2）ETCD\n\n> Kubernetes集群的所有状态信息都需要持久存储于存储系统etcd中，不过，etcd是由CoreOS基于Raft协议开发的分布式键值存储，可用于服务发现、共享配置以及一致性保障（例如数据库主节点选择、分布式锁等）。因此，etcd是独立的服务组件，并不隶属于Kubernetes集群自身。生产环境中应该以etcd集群的方式运行以确保其服务可用性。\n>\n> etcd不仅能够提供键值数据存储，而且还为其提供了监听（watch）机制，用于监听和推送变更。Kubernetes集群系统中，etcd中的键值发生变化时会通知到API Server，并由其通过watch API向客户端输出。基于watch机制，Kubernetes集群的各组件实现了高效协同。\n\n（3）Controller Manager\n\n> Kubernetes中，集群级别的大多数功能都是由几个被称为控制器的进程执行实现的，这几个进程被集成与kube-controller-manager守护进程中。由控制器完成的功能主要包括生命周期功能和API业务逻辑，具体如下\n>\n> - 生命周期功能：包括Namespace创建和生命周期、Event垃圾回收、Pod终止相关的垃圾回收、级联垃圾回收及Node垃圾回收等。\n> - API业务逻辑：例如，由ReplicaSet执行的Pod扩展等。\n\n（4）Scheduler\n\n> Kubernetes是用于部署和管理大规模容器应用的平台，根据集群规模的不同，其托管运行的容器很可能会数以千计甚至更多。API Server确认Pod对象的创建请求之后，便需要由Scheduler根据集群内各节点的可用资源状态，以及要运行的容器的资源需求做出调度决策，如下图所示。另外，Kubernetes还支持用户自定义调度器。\n\n![]((一)Kubernetes系统基础/scheduler.png)\n\n\n\n## Node组件\n\n> Node负责提供运行容器的各种依赖环境，并接收Master的管理。每个Node主要由以下几个组件构成。\n\n（1）kubelet\n\n> kubelet是运行于工作节点之上的守护进程，它从API Server接收关于Pod对象的配置信息并确保它们处于期望的状态（desired state，也可以说目标状态）kubelet会在API Server上注册当前工作节点，定期向Master汇报节点资源使用情况，并通过cAdvisor监控容器和节点的资源占用情况。\n\n（2）kube-proxy\n\n> 每个工作节点都需要运行一个kube-proxy守护进程，它能够按需为Service资源对象生成iptables或ipvs规则，从而捕获访问当前Service的ClusterIP的流量并将其转发至正确的后端Pod对象。\n\n（3）docker\n\n> docker用于运行容器\n\n## 核心附件\n\n> Kubernetes集群还依赖于一组称为\"附件\"(add-ons)的组件以提供完整的功能，它们通常是由第三方提供的特定应用程序，且托管运行于Kubernetes集群之上，如上图所示。\n\n- KubeDNS\n\n  > 在Kubernetes集群中调度运行提供DNS服务的Pod，同一集群中的其他pod可使用此DNS服务解决主机名。Kubernetes从1.11版本开始默认使用CoreDNS项目为集群提供服务注册和服务发现的动态名称解析服务，之前的版本中用到的是kube-dns项目，而SKyDNS则是更早一代的项目。\n\n- Kubernetes Dashboard\n\n  > Kubernetes集群的全部功能都要基于Web的UI，来管理集群中应用甚至是集群自身。\n\n- Heapster\n\n  > 容器和节点的性能监控与分析系统，它收集并解析多种指标数据，如资源利用率、生命周期事件等。新版本的Kubernetes中，其功能会逐渐由Prometheus结合其他组件所取代。\n\n- Ingress Controller\n\n  > Service是一种工作于传输层的负载均衡器，而Ingress是在应用层实现的HTTP(s)负载均衡机制。不过，Ingress资源自身不能进行“流量穿透”，它仅是一组路由规则的集合，这些规则需要通过Ingress控制器（Ingress Controller）发挥作用。目前，此类的可用项目有Nginx、Traefik、Envoy及HAProxy等。\n\n\n\n\n\n\n\n","slug":"(一)Kubernetes系统基础","published":1,"updated":"2019-10-24T09:19:42.484Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck24hxdse00006wnr3w3gfnqu","content":"<h1 id=\"Kubernetes介绍\"><a href=\"#Kubernetes介绍\" class=\"headerlink\" title=\"Kubernetes介绍\"></a>Kubernetes介绍</h1><h2 id=\"什么是Kubernetes？\"><a href=\"#什么是Kubernetes？\" class=\"headerlink\" title=\"什么是Kubernetes？\"></a>什么是Kubernetes？</h2><blockquote>\n<p><code>Kubernetes</code>是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。</p>\n<p>使用<code>Kubernetes</code>可以：</p>\n<ul>\n<li>自动化容器的部署和复制</li>\n<li>随时扩展或收缩容器规模</li>\n<li>将容器组织成组，并且提供容器间的负载均衡</li>\n<li>很容易地升级应用程序容器的新版本</li>\n<li>节省资源，优化硬件资源的使用</li>\n<li>提供容器弹性，如果容器失效就替换它，等等…</li>\n</ul>\n</blockquote>\n<h2 id=\"Kubernetes特点\"><a href=\"#Kubernetes特点\" class=\"headerlink\" title=\"Kubernetes特点\"></a>Kubernetes特点</h2><blockquote>\n<ul>\n<li><strong>便携性</strong>：支持公有云、私有云、混合云、多重云(multi-cloud)</li>\n<li><strong>可扩展</strong>：模块化、插件化、可组合、可挂载</li>\n<li><strong>自修复</strong>：自动部署，自动重启，自动复制，自动伸缩扩展</li>\n</ul>\n</blockquote>\n<p>##Kubernetes特性</p>\n<blockquote>\n<p>Kubernetes是一种用于在一组主机上运行和协同容器化应用程序的系统，旨在提供可预测性、可扩展性与高可用的性的方法来完全管理容器化应用程序和服务的生命周期的平台。</p>\n<p>它具有以下几个重要的特性：</p>\n<ol>\n<li><strong>自动装箱</strong>：构建于容器之上，基于资源依赖及其他约束自动完成容器部署且不影响其可用性，并通过调度机制混合关键型应用和非关键型应用的工作负载于同一节点以提升资源利用率。</li>\n<li><strong>自我修复</strong>：支持容器故障后自动重启、节点故障候重行调度容器，以及其他可用节点、健康状态检查失败后关闭容器并重新创建等自我修复机制。</li>\n<li><strong>水平扩展</strong>：支持通过简单命令或UI手动水平扩展，以及基于CPU等资源负载率的自动水平扩展机制。</li>\n<li><strong>服务器发现和负载均衡</strong>：Kubernetes通过其附加组件之一的KubeDNS（或CoreDNS）为系统内置了服务发现功能，它会为每个Service配置DNS名称，并允许集群内的客户端直接使用此名称发出访问请求，而Service则通过iptables或ipvs内建了负载均衡机制。</li>\n<li><strong>自动发布和回滚</strong>：Kubernetes支持“灰度”更新应用程序或其配置信息，它会监控更新过程中应用程序的健康状态，以确保它不会在同一时刻杀掉所有的实例，而此过程中一旦有故障发生，就会立即自动执行回滚操作。</li>\n<li><strong>秘钥和配置管理</strong>：Kubernetes允许存储和管理敏感信息，例如密码，Oauth令牌和ssh秘钥。可以部署和更新密码和应用程序配置，而无需重建容器，也不会再堆栈配置中暴露机密。</li>\n<li><strong>存储编排</strong>：Kubernetes支持Pod对象按需自动挂载不同类型的存储系统，这包括节点本地存储、公有云服务商的云存储（如AWS和GCP等），以及网络存储系统（例如，NFS、ISCSI、GlusterFS、Ceph、Cinder和Flocker等）</li>\n<li><strong>批量处理执行</strong>：除了服务型应用，Kubernetes还支持批处理作业及CI（持续集成），如果需要，一样可以实现容器故障后修复。</li>\n</ol>\n</blockquote>\n<h1 id=\"Kubernetes概述和术语\"><a href=\"#Kubernetes概述和术语\" class=\"headerlink\" title=\"Kubernetes概述和术语\"></a>Kubernetes概述和术语</h1><blockquote>\n<p>Kubernetes使用共享网络将多个物理机或虚拟机汇集到一个集群中，在各服务器之间进行通信，该集群是配置Kubernetes的所有组件、功能和工作负载的物理平台。集群中一台服务器（或高可用部署中的一组服务器）用作Master，负责管理整个集群，余下的其他机器用作Worker Node,它们是使用本地和外部资源接收和运行工作负载的服务器。集群中的这些主机可以是物理服务器，也可以是虚拟机（包括IaaS云端的VPS）</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/kubernetescluster.png)</p>\n<p><strong>Master</strong></p>\n<blockquote>\n<p>Master是集群的网关和中枢，负责诸如为用户和客户端暴露API、跟踪其它服务器的健康状态、以最优方式调度工作负载，以及编排其他组件之间的通信等任务，它是用户或客户端与集群之间的核心联络点，并负责Kubernetes系统的大多数集中式管控逻辑。单个Master节点即可完成其所有的功能，但出于冗余及负载均衡等目的，生产环境中通常需要协同部署多个此类主机。Master节点类似于蜂群中的蜂王。</p>\n</blockquote>\n<p><strong>Node</strong></p>\n<blockquote>\n<p>Node是Kubernetes集群的工作节点，负责接收来自Master的工作指令并根据指令相应的创建或删除Pod对象，以及调整网络规则以合理地路由和转发流量等。理论上讲，Node可以是任何形式的计算设备，不过Master会统一将其抽象为Node对象进行管理。Node类似于蜂群中的工蜂，生产环境中，它们通常数量众多。</p>\n</blockquote>\n<hr>\n<blockquote>\n<p>Kubernetes将所有Node的资源集结于一处形成一台更强大的“服务器”，如下图，在用户将应用部署于其上时，Master会使用调度算法将其自动指派某个特定的Node运行，在Node加入集群或从集群中移除时，Master也会按需重行编排影响到的Pod（容器）。于是，用户无需关心其应用究竟运行于何处。</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/cluster.png)</p>\n<blockquote>\n<p>从抽象的角度来讲，Kubernetes还有着众多的组件来支撑其内部的业务逻辑，包括运行应用、应用编排、服务暴露、应用恢复等，它们在Kubernetes中被抽象为Pod、Service、Controller等资源类型。</p>\n</blockquote>\n<h2 id=\"常用的资源对象\"><a href=\"#常用的资源对象\" class=\"headerlink\" title=\"常用的资源对象\"></a>常用的资源对象</h2><p><a href=\"http://www.dockone.io/article/932\" target=\"_blank\" rel=\"noopener\">十分钟带你理解Kubernetes核心概念</a></p>\n<p>（1）Pod</p>\n<blockquote>\n<p>Kubernetes并不直接运行容器，而是使用一个抽象的资源对象来封装一个或者多个容器，这个抽象即为Pod，它是Kubernetes的最小调度单元。同一Pod中的容器共享网络名称空间和存储资源，这些容器可经由本地回环接口lo直接通信，但彼此之间又在Mount、User及PID等名称空间上保持了隔离。尽管Pod中可以包含多个容器，但是作为最小调度单元，它应该尽可能地保持“小”，即通常只应该包含一个主容器，以及必要的辅助型容器（sidecar）</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/pod.png)</p>\n<p>（2）资源标签</p>\n<blockquote>\n<p>标签（Label）是将资源进行分类的标识符，资源标签其实就是一个键值型（key/values）数据。标签旨在指定对象（如Pod等）辨识性的属性，这些属性仅对用户存在特定的意义，对Kubernetes集群来说并不直接表达核心系统语意。标签可以在对象创建时附加其上，并能够在创建后的任意时间进行添加和修改。一个对象可以拥有多个标签，一个标签也可以附加于多个对象（通常是同一类对象）之上。</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/label.png)</p>\n<p>（3）标签选择器</p>\n<blockquote>\n<p>标签选择器（Selector）全称为”Label Selector“，它是一种根据Label来过滤符合条件的资源对象的机制。例如，将附有标签”role：backend“的所有Pod对象挑选出来归为一组就是标签选择器的一种应用，如下图所示，通常使用标签对资源对象进行分类，而后使用标签选择器挑选出它们，例如将其创建未某Service的端点。</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/labels.png)</p>\n<p>（4）Pod控制器</p>\n<blockquote>\n<p>尽管Pod是kubernetes的最小调度单元，但用户通常并不会直接部署及管理Pod对象，而是要借助于另一类抽象——控制器（Controller）对其进行管理。用于工作负载的控制器是一种管理Pod生命周期的资源抽象，它们是kubernetes上的一类对象，而非单个资源对象，包括ReplicationController，ReplicaSet、Deployment、StatefulSet、Job等。已下图所示的Deployment控制器为例，它负责确保指定的Pod对象的副本数量精确符合定义，否则“多退少补”。使用控制器之后就不再需要手动管理Pod对象了，只需要声明应用的期望状态，控制器就会自动对其进行进程管理。    </p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/deployment.png)</p>\n<p>（5）服务资源（Service）</p>\n<blockquote>\n<p>Service是建立在一组Pod对象之上的资源抽象，它通过标签选择器选定一组Pod对象，并为这组Pod对象定义一个统一的固定访问入口（通常是一个IP地址），若Kubernetes集群存在DNS附件，它就会在Service创建时为其自动配置一个DNS名称以便客户端进行服务发现。到达Service IP的请求将被负载均衡至其后的端点——各个Pod对象之上，因此Service从本质上来讲是一个四层代理服务。另外，service还可以将集群外部流量引入到集群中来。</p>\n</blockquote>\n<p>（6）存储卷</p>\n<blockquote>\n<p>存储卷（Volume）是独立于容器文件系统之外的存储空间，常用于扩展容器的存储空间并为它提供持久存储能力。Kubernetes集群上的存储卷大体可以分为临时卷、本地卷和网络卷。临时卷和本地卷都位于Node本地，一旦Pod被调度至其他Node，此种类型的存储卷将无法访问到，因此临时卷和本地卷通常用于数据缓存，持久化的数据则需要放置于持久卷（persistent volume）之上。</p>\n</blockquote>\n<p>（7）Name和Namespace</p>\n<blockquote>\n<p>名称（Name）是Kubernetes集群中资源对象的标识符，它们的作用域通常是名称空间（Namespace），因此名称空间是名称的额外的限定机制。在同一名称空间中，同一类型资源对象的名称必须具有唯一性。名称空间通常用于实现租户或项目的资源隔离，从而形成逻辑分组，如下图所示，创建的Pod和Service等资源对象都属于名称空间级别，未指定时，他们都属于默认的名称空间“default”。</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/namespace.png)</p>\n<p>（8）Annotation</p>\n<blockquote>\n<p>Annotation（注释）是另一种附加在对象之上的键值类型的数据，但它拥有更大的数据容量。Annotation常用于将各种非标识型元数据（metadata）附加到对象上，但它不能用于标识和选择对象，通常也不会被Kubernetes直接使用，其主要目的是方便工具或用户的阅读和查找等。</p>\n</blockquote>\n<p>（9）Ingress</p>\n<blockquote>\n<p>Kubernetes将Pod对象和外部网络环境进行了隔离，Pod和Service等对象间的通信都使用其内部专用地址进行，如若需要开放某些Pod对象提供给外部用户访问，则需要为其请求流量打开一个通往Kubernetes集群内部的通道，除了Service之外，Ingress也是这类通道的实现方式之一。</p>\n</blockquote>\n<h1 id=\"Kubernetes集群组件\"><a href=\"#Kubernetes集群组件\" class=\"headerlink\" title=\"Kubernetes集群组件\"></a>Kubernetes集群组件</h1><p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/system.png)</p>\n<h2 id=\"Master组件\"><a href=\"#Master组件\" class=\"headerlink\" title=\"Master组件\"></a>Master组件</h2><blockquote>\n<p>Kubernetes的集群控制平面由多个组件组成，这些组件可统一运行于单一Master节点，也可以以多副本的方式同时运行于多个节点，以为Master提供高可用功能，甚至还可以运行于Kubernetes集群自身之上。Master主要包括以下几个组件。</p>\n</blockquote>\n<p>（1）API Server</p>\n<blockquote>\n<p>Api Server负责输出RESTful风格的Kubernetes API，它是发往集群的所有REST操作命令的接入点，并负责接收、校验并响应所有的REST请求，结果状态被持久存储于etcd中。因此，API Server是整个集群的网关。</p>\n</blockquote>\n<p>（2）ETCD</p>\n<blockquote>\n<p>Kubernetes集群的所有状态信息都需要持久存储于存储系统etcd中，不过，etcd是由CoreOS基于Raft协议开发的分布式键值存储，可用于服务发现、共享配置以及一致性保障（例如数据库主节点选择、分布式锁等）。因此，etcd是独立的服务组件，并不隶属于Kubernetes集群自身。生产环境中应该以etcd集群的方式运行以确保其服务可用性。</p>\n<p>etcd不仅能够提供键值数据存储，而且还为其提供了监听（watch）机制，用于监听和推送变更。Kubernetes集群系统中，etcd中的键值发生变化时会通知到API Server，并由其通过watch API向客户端输出。基于watch机制，Kubernetes集群的各组件实现了高效协同。</p>\n</blockquote>\n<p>（3）Controller Manager</p>\n<blockquote>\n<p>Kubernetes中，集群级别的大多数功能都是由几个被称为控制器的进程执行实现的，这几个进程被集成与kube-controller-manager守护进程中。由控制器完成的功能主要包括生命周期功能和API业务逻辑，具体如下</p>\n<ul>\n<li>生命周期功能：包括Namespace创建和生命周期、Event垃圾回收、Pod终止相关的垃圾回收、级联垃圾回收及Node垃圾回收等。</li>\n<li>API业务逻辑：例如，由ReplicaSet执行的Pod扩展等。</li>\n</ul>\n</blockquote>\n<p>（4）Scheduler</p>\n<blockquote>\n<p>Kubernetes是用于部署和管理大规模容器应用的平台，根据集群规模的不同，其托管运行的容器很可能会数以千计甚至更多。API Server确认Pod对象的创建请求之后，便需要由Scheduler根据集群内各节点的可用资源状态，以及要运行的容器的资源需求做出调度决策，如下图所示。另外，Kubernetes还支持用户自定义调度器。</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/scheduler.png)</p>\n<h2 id=\"Node组件\"><a href=\"#Node组件\" class=\"headerlink\" title=\"Node组件\"></a>Node组件</h2><blockquote>\n<p>Node负责提供运行容器的各种依赖环境，并接收Master的管理。每个Node主要由以下几个组件构成。</p>\n</blockquote>\n<p>（1）kubelet</p>\n<blockquote>\n<p>kubelet是运行于工作节点之上的守护进程，它从API Server接收关于Pod对象的配置信息并确保它们处于期望的状态（desired state，也可以说目标状态）kubelet会在API Server上注册当前工作节点，定期向Master汇报节点资源使用情况，并通过cAdvisor监控容器和节点的资源占用情况。</p>\n</blockquote>\n<p>（2）kube-proxy</p>\n<blockquote>\n<p>每个工作节点都需要运行一个kube-proxy守护进程，它能够按需为Service资源对象生成iptables或ipvs规则，从而捕获访问当前Service的ClusterIP的流量并将其转发至正确的后端Pod对象。</p>\n</blockquote>\n<p>（3）docker</p>\n<blockquote>\n<p>docker用于运行容器</p>\n</blockquote>\n<h2 id=\"核心附件\"><a href=\"#核心附件\" class=\"headerlink\" title=\"核心附件\"></a>核心附件</h2><blockquote>\n<p>Kubernetes集群还依赖于一组称为”附件”(add-ons)的组件以提供完整的功能，它们通常是由第三方提供的特定应用程序，且托管运行于Kubernetes集群之上，如上图所示。</p>\n</blockquote>\n<ul>\n<li><p>KubeDNS</p>\n<blockquote>\n<p>在Kubernetes集群中调度运行提供DNS服务的Pod，同一集群中的其他pod可使用此DNS服务解决主机名。Kubernetes从1.11版本开始默认使用CoreDNS项目为集群提供服务注册和服务发现的动态名称解析服务，之前的版本中用到的是kube-dns项目，而SKyDNS则是更早一代的项目。</p>\n</blockquote>\n</li>\n<li><p>Kubernetes Dashboard</p>\n<blockquote>\n<p>Kubernetes集群的全部功能都要基于Web的UI，来管理集群中应用甚至是集群自身。</p>\n</blockquote>\n</li>\n<li><p>Heapster</p>\n<blockquote>\n<p>容器和节点的性能监控与分析系统，它收集并解析多种指标数据，如资源利用率、生命周期事件等。新版本的Kubernetes中，其功能会逐渐由Prometheus结合其他组件所取代。</p>\n</blockquote>\n</li>\n<li><p>Ingress Controller</p>\n<blockquote>\n<p>Service是一种工作于传输层的负载均衡器，而Ingress是在应用层实现的HTTP(s)负载均衡机制。不过，Ingress资源自身不能进行“流量穿透”，它仅是一组路由规则的集合，这些规则需要通过Ingress控制器（Ingress Controller）发挥作用。目前，此类的可用项目有Nginx、Traefik、Envoy及HAProxy等。</p>\n</blockquote>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Kubernetes介绍\"><a href=\"#Kubernetes介绍\" class=\"headerlink\" title=\"Kubernetes介绍\"></a>Kubernetes介绍</h1><h2 id=\"什么是Kubernetes？\"><a href=\"#什么是Kubernetes？\" class=\"headerlink\" title=\"什么是Kubernetes？\"></a>什么是Kubernetes？</h2><blockquote>\n<p><code>Kubernetes</code>是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。</p>\n<p>使用<code>Kubernetes</code>可以：</p>\n<ul>\n<li>自动化容器的部署和复制</li>\n<li>随时扩展或收缩容器规模</li>\n<li>将容器组织成组，并且提供容器间的负载均衡</li>\n<li>很容易地升级应用程序容器的新版本</li>\n<li>节省资源，优化硬件资源的使用</li>\n<li>提供容器弹性，如果容器失效就替换它，等等…</li>\n</ul>\n</blockquote>\n<h2 id=\"Kubernetes特点\"><a href=\"#Kubernetes特点\" class=\"headerlink\" title=\"Kubernetes特点\"></a>Kubernetes特点</h2><blockquote>\n<ul>\n<li><strong>便携性</strong>：支持公有云、私有云、混合云、多重云(multi-cloud)</li>\n<li><strong>可扩展</strong>：模块化、插件化、可组合、可挂载</li>\n<li><strong>自修复</strong>：自动部署，自动重启，自动复制，自动伸缩扩展</li>\n</ul>\n</blockquote>\n<p>##Kubernetes特性</p>\n<blockquote>\n<p>Kubernetes是一种用于在一组主机上运行和协同容器化应用程序的系统，旨在提供可预测性、可扩展性与高可用的性的方法来完全管理容器化应用程序和服务的生命周期的平台。</p>\n<p>它具有以下几个重要的特性：</p>\n<ol>\n<li><strong>自动装箱</strong>：构建于容器之上，基于资源依赖及其他约束自动完成容器部署且不影响其可用性，并通过调度机制混合关键型应用和非关键型应用的工作负载于同一节点以提升资源利用率。</li>\n<li><strong>自我修复</strong>：支持容器故障后自动重启、节点故障候重行调度容器，以及其他可用节点、健康状态检查失败后关闭容器并重新创建等自我修复机制。</li>\n<li><strong>水平扩展</strong>：支持通过简单命令或UI手动水平扩展，以及基于CPU等资源负载率的自动水平扩展机制。</li>\n<li><strong>服务器发现和负载均衡</strong>：Kubernetes通过其附加组件之一的KubeDNS（或CoreDNS）为系统内置了服务发现功能，它会为每个Service配置DNS名称，并允许集群内的客户端直接使用此名称发出访问请求，而Service则通过iptables或ipvs内建了负载均衡机制。</li>\n<li><strong>自动发布和回滚</strong>：Kubernetes支持“灰度”更新应用程序或其配置信息，它会监控更新过程中应用程序的健康状态，以确保它不会在同一时刻杀掉所有的实例，而此过程中一旦有故障发生，就会立即自动执行回滚操作。</li>\n<li><strong>秘钥和配置管理</strong>：Kubernetes允许存储和管理敏感信息，例如密码，Oauth令牌和ssh秘钥。可以部署和更新密码和应用程序配置，而无需重建容器，也不会再堆栈配置中暴露机密。</li>\n<li><strong>存储编排</strong>：Kubernetes支持Pod对象按需自动挂载不同类型的存储系统，这包括节点本地存储、公有云服务商的云存储（如AWS和GCP等），以及网络存储系统（例如，NFS、ISCSI、GlusterFS、Ceph、Cinder和Flocker等）</li>\n<li><strong>批量处理执行</strong>：除了服务型应用，Kubernetes还支持批处理作业及CI（持续集成），如果需要，一样可以实现容器故障后修复。</li>\n</ol>\n</blockquote>\n<h1 id=\"Kubernetes概述和术语\"><a href=\"#Kubernetes概述和术语\" class=\"headerlink\" title=\"Kubernetes概述和术语\"></a>Kubernetes概述和术语</h1><blockquote>\n<p>Kubernetes使用共享网络将多个物理机或虚拟机汇集到一个集群中，在各服务器之间进行通信，该集群是配置Kubernetes的所有组件、功能和工作负载的物理平台。集群中一台服务器（或高可用部署中的一组服务器）用作Master，负责管理整个集群，余下的其他机器用作Worker Node,它们是使用本地和外部资源接收和运行工作负载的服务器。集群中的这些主机可以是物理服务器，也可以是虚拟机（包括IaaS云端的VPS）</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/kubernetescluster.png)</p>\n<p><strong>Master</strong></p>\n<blockquote>\n<p>Master是集群的网关和中枢，负责诸如为用户和客户端暴露API、跟踪其它服务器的健康状态、以最优方式调度工作负载，以及编排其他组件之间的通信等任务，它是用户或客户端与集群之间的核心联络点，并负责Kubernetes系统的大多数集中式管控逻辑。单个Master节点即可完成其所有的功能，但出于冗余及负载均衡等目的，生产环境中通常需要协同部署多个此类主机。Master节点类似于蜂群中的蜂王。</p>\n</blockquote>\n<p><strong>Node</strong></p>\n<blockquote>\n<p>Node是Kubernetes集群的工作节点，负责接收来自Master的工作指令并根据指令相应的创建或删除Pod对象，以及调整网络规则以合理地路由和转发流量等。理论上讲，Node可以是任何形式的计算设备，不过Master会统一将其抽象为Node对象进行管理。Node类似于蜂群中的工蜂，生产环境中，它们通常数量众多。</p>\n</blockquote>\n<hr>\n<blockquote>\n<p>Kubernetes将所有Node的资源集结于一处形成一台更强大的“服务器”，如下图，在用户将应用部署于其上时，Master会使用调度算法将其自动指派某个特定的Node运行，在Node加入集群或从集群中移除时，Master也会按需重行编排影响到的Pod（容器）。于是，用户无需关心其应用究竟运行于何处。</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/cluster.png)</p>\n<blockquote>\n<p>从抽象的角度来讲，Kubernetes还有着众多的组件来支撑其内部的业务逻辑，包括运行应用、应用编排、服务暴露、应用恢复等，它们在Kubernetes中被抽象为Pod、Service、Controller等资源类型。</p>\n</blockquote>\n<h2 id=\"常用的资源对象\"><a href=\"#常用的资源对象\" class=\"headerlink\" title=\"常用的资源对象\"></a>常用的资源对象</h2><p><a href=\"http://www.dockone.io/article/932\" target=\"_blank\" rel=\"noopener\">十分钟带你理解Kubernetes核心概念</a></p>\n<p>（1）Pod</p>\n<blockquote>\n<p>Kubernetes并不直接运行容器，而是使用一个抽象的资源对象来封装一个或者多个容器，这个抽象即为Pod，它是Kubernetes的最小调度单元。同一Pod中的容器共享网络名称空间和存储资源，这些容器可经由本地回环接口lo直接通信，但彼此之间又在Mount、User及PID等名称空间上保持了隔离。尽管Pod中可以包含多个容器，但是作为最小调度单元，它应该尽可能地保持“小”，即通常只应该包含一个主容器，以及必要的辅助型容器（sidecar）</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/pod.png)</p>\n<p>（2）资源标签</p>\n<blockquote>\n<p>标签（Label）是将资源进行分类的标识符，资源标签其实就是一个键值型（key/values）数据。标签旨在指定对象（如Pod等）辨识性的属性，这些属性仅对用户存在特定的意义，对Kubernetes集群来说并不直接表达核心系统语意。标签可以在对象创建时附加其上，并能够在创建后的任意时间进行添加和修改。一个对象可以拥有多个标签，一个标签也可以附加于多个对象（通常是同一类对象）之上。</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/label.png)</p>\n<p>（3）标签选择器</p>\n<blockquote>\n<p>标签选择器（Selector）全称为”Label Selector“，它是一种根据Label来过滤符合条件的资源对象的机制。例如，将附有标签”role：backend“的所有Pod对象挑选出来归为一组就是标签选择器的一种应用，如下图所示，通常使用标签对资源对象进行分类，而后使用标签选择器挑选出它们，例如将其创建未某Service的端点。</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/labels.png)</p>\n<p>（4）Pod控制器</p>\n<blockquote>\n<p>尽管Pod是kubernetes的最小调度单元，但用户通常并不会直接部署及管理Pod对象，而是要借助于另一类抽象——控制器（Controller）对其进行管理。用于工作负载的控制器是一种管理Pod生命周期的资源抽象，它们是kubernetes上的一类对象，而非单个资源对象，包括ReplicationController，ReplicaSet、Deployment、StatefulSet、Job等。已下图所示的Deployment控制器为例，它负责确保指定的Pod对象的副本数量精确符合定义，否则“多退少补”。使用控制器之后就不再需要手动管理Pod对象了，只需要声明应用的期望状态，控制器就会自动对其进行进程管理。    </p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/deployment.png)</p>\n<p>（5）服务资源（Service）</p>\n<blockquote>\n<p>Service是建立在一组Pod对象之上的资源抽象，它通过标签选择器选定一组Pod对象，并为这组Pod对象定义一个统一的固定访问入口（通常是一个IP地址），若Kubernetes集群存在DNS附件，它就会在Service创建时为其自动配置一个DNS名称以便客户端进行服务发现。到达Service IP的请求将被负载均衡至其后的端点——各个Pod对象之上，因此Service从本质上来讲是一个四层代理服务。另外，service还可以将集群外部流量引入到集群中来。</p>\n</blockquote>\n<p>（6）存储卷</p>\n<blockquote>\n<p>存储卷（Volume）是独立于容器文件系统之外的存储空间，常用于扩展容器的存储空间并为它提供持久存储能力。Kubernetes集群上的存储卷大体可以分为临时卷、本地卷和网络卷。临时卷和本地卷都位于Node本地，一旦Pod被调度至其他Node，此种类型的存储卷将无法访问到，因此临时卷和本地卷通常用于数据缓存，持久化的数据则需要放置于持久卷（persistent volume）之上。</p>\n</blockquote>\n<p>（7）Name和Namespace</p>\n<blockquote>\n<p>名称（Name）是Kubernetes集群中资源对象的标识符，它们的作用域通常是名称空间（Namespace），因此名称空间是名称的额外的限定机制。在同一名称空间中，同一类型资源对象的名称必须具有唯一性。名称空间通常用于实现租户或项目的资源隔离，从而形成逻辑分组，如下图所示，创建的Pod和Service等资源对象都属于名称空间级别，未指定时，他们都属于默认的名称空间“default”。</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/namespace.png)</p>\n<p>（8）Annotation</p>\n<blockquote>\n<p>Annotation（注释）是另一种附加在对象之上的键值类型的数据，但它拥有更大的数据容量。Annotation常用于将各种非标识型元数据（metadata）附加到对象上，但它不能用于标识和选择对象，通常也不会被Kubernetes直接使用，其主要目的是方便工具或用户的阅读和查找等。</p>\n</blockquote>\n<p>（9）Ingress</p>\n<blockquote>\n<p>Kubernetes将Pod对象和外部网络环境进行了隔离，Pod和Service等对象间的通信都使用其内部专用地址进行，如若需要开放某些Pod对象提供给外部用户访问，则需要为其请求流量打开一个通往Kubernetes集群内部的通道，除了Service之外，Ingress也是这类通道的实现方式之一。</p>\n</blockquote>\n<h1 id=\"Kubernetes集群组件\"><a href=\"#Kubernetes集群组件\" class=\"headerlink\" title=\"Kubernetes集群组件\"></a>Kubernetes集群组件</h1><p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/system.png)</p>\n<h2 id=\"Master组件\"><a href=\"#Master组件\" class=\"headerlink\" title=\"Master组件\"></a>Master组件</h2><blockquote>\n<p>Kubernetes的集群控制平面由多个组件组成，这些组件可统一运行于单一Master节点，也可以以多副本的方式同时运行于多个节点，以为Master提供高可用功能，甚至还可以运行于Kubernetes集群自身之上。Master主要包括以下几个组件。</p>\n</blockquote>\n<p>（1）API Server</p>\n<blockquote>\n<p>Api Server负责输出RESTful风格的Kubernetes API，它是发往集群的所有REST操作命令的接入点，并负责接收、校验并响应所有的REST请求，结果状态被持久存储于etcd中。因此，API Server是整个集群的网关。</p>\n</blockquote>\n<p>（2）ETCD</p>\n<blockquote>\n<p>Kubernetes集群的所有状态信息都需要持久存储于存储系统etcd中，不过，etcd是由CoreOS基于Raft协议开发的分布式键值存储，可用于服务发现、共享配置以及一致性保障（例如数据库主节点选择、分布式锁等）。因此，etcd是独立的服务组件，并不隶属于Kubernetes集群自身。生产环境中应该以etcd集群的方式运行以确保其服务可用性。</p>\n<p>etcd不仅能够提供键值数据存储，而且还为其提供了监听（watch）机制，用于监听和推送变更。Kubernetes集群系统中，etcd中的键值发生变化时会通知到API Server，并由其通过watch API向客户端输出。基于watch机制，Kubernetes集群的各组件实现了高效协同。</p>\n</blockquote>\n<p>（3）Controller Manager</p>\n<blockquote>\n<p>Kubernetes中，集群级别的大多数功能都是由几个被称为控制器的进程执行实现的，这几个进程被集成与kube-controller-manager守护进程中。由控制器完成的功能主要包括生命周期功能和API业务逻辑，具体如下</p>\n<ul>\n<li>生命周期功能：包括Namespace创建和生命周期、Event垃圾回收、Pod终止相关的垃圾回收、级联垃圾回收及Node垃圾回收等。</li>\n<li>API业务逻辑：例如，由ReplicaSet执行的Pod扩展等。</li>\n</ul>\n</blockquote>\n<p>（4）Scheduler</p>\n<blockquote>\n<p>Kubernetes是用于部署和管理大规模容器应用的平台，根据集群规模的不同，其托管运行的容器很可能会数以千计甚至更多。API Server确认Pod对象的创建请求之后，便需要由Scheduler根据集群内各节点的可用资源状态，以及要运行的容器的资源需求做出调度决策，如下图所示。另外，Kubernetes还支持用户自定义调度器。</p>\n</blockquote>\n<p><img src=\"/2019/10/24/(一)Kubernetes系统基础/(一\" alt>Kubernetes系统基础/scheduler.png)</p>\n<h2 id=\"Node组件\"><a href=\"#Node组件\" class=\"headerlink\" title=\"Node组件\"></a>Node组件</h2><blockquote>\n<p>Node负责提供运行容器的各种依赖环境，并接收Master的管理。每个Node主要由以下几个组件构成。</p>\n</blockquote>\n<p>（1）kubelet</p>\n<blockquote>\n<p>kubelet是运行于工作节点之上的守护进程，它从API Server接收关于Pod对象的配置信息并确保它们处于期望的状态（desired state，也可以说目标状态）kubelet会在API Server上注册当前工作节点，定期向Master汇报节点资源使用情况，并通过cAdvisor监控容器和节点的资源占用情况。</p>\n</blockquote>\n<p>（2）kube-proxy</p>\n<blockquote>\n<p>每个工作节点都需要运行一个kube-proxy守护进程，它能够按需为Service资源对象生成iptables或ipvs规则，从而捕获访问当前Service的ClusterIP的流量并将其转发至正确的后端Pod对象。</p>\n</blockquote>\n<p>（3）docker</p>\n<blockquote>\n<p>docker用于运行容器</p>\n</blockquote>\n<h2 id=\"核心附件\"><a href=\"#核心附件\" class=\"headerlink\" title=\"核心附件\"></a>核心附件</h2><blockquote>\n<p>Kubernetes集群还依赖于一组称为”附件”(add-ons)的组件以提供完整的功能，它们通常是由第三方提供的特定应用程序，且托管运行于Kubernetes集群之上，如上图所示。</p>\n</blockquote>\n<ul>\n<li><p>KubeDNS</p>\n<blockquote>\n<p>在Kubernetes集群中调度运行提供DNS服务的Pod，同一集群中的其他pod可使用此DNS服务解决主机名。Kubernetes从1.11版本开始默认使用CoreDNS项目为集群提供服务注册和服务发现的动态名称解析服务，之前的版本中用到的是kube-dns项目，而SKyDNS则是更早一代的项目。</p>\n</blockquote>\n</li>\n<li><p>Kubernetes Dashboard</p>\n<blockquote>\n<p>Kubernetes集群的全部功能都要基于Web的UI，来管理集群中应用甚至是集群自身。</p>\n</blockquote>\n</li>\n<li><p>Heapster</p>\n<blockquote>\n<p>容器和节点的性能监控与分析系统，它收集并解析多种指标数据，如资源利用率、生命周期事件等。新版本的Kubernetes中，其功能会逐渐由Prometheus结合其他组件所取代。</p>\n</blockquote>\n</li>\n<li><p>Ingress Controller</p>\n<blockquote>\n<p>Service是一种工作于传输层的负载均衡器，而Ingress是在应用层实现的HTTP(s)负载均衡机制。不过，Ingress资源自身不能进行“流量穿透”，它仅是一组路由规则的集合，这些规则需要通过Ingress控制器（Ingress Controller）发挥作用。目前，此类的可用项目有Nginx、Traefik、Envoy及HAProxy等。</p>\n</blockquote>\n</li>\n</ul>\n"}],"PostAsset":[{"_id":"source/_posts/Tomcat安装与部署/tomcat06.png","slug":"tomcat06.png","post":"cjxwlqrqj002ilctcnqawjqtj","modified":0,"renderable":0},{"_id":"source/_posts/Ansible之Roles/rolesdir.png","slug":"rolesdir.png","post":"cjxwlqrlf0012lctccjytlut2","modified":0,"renderable":0},{"_id":"source/_posts/saltstack状态判断unless与onlyif/01.png","slug":"01.png","post":"cjxwlqrkt000qlctc7ixp4qe4","modified":0,"renderable":0},{"_id":"source/_posts/Ansible项目实战lnmp/01.png","slug":"01.png","post":"cjxwlqrlq0019lctch80rsqyt","modified":0,"renderable":0},{"_id":"source/_posts/Ansible快速入门/ansible01.png","slug":"ansible01.png","post":"cjxwlqrlm0017lctc4yfk9i80","modified":0,"renderable":0},{"_id":"source/_posts/Ansible快速入门/ansible02.png","slug":"ansible02.png","post":"cjxwlqrlm0017lctc4yfk9i80","modified":0,"renderable":0},{"_id":"source/_posts/phpMyAdmin搭建/4.png","slug":"4.png","post":"cjxwlqrka000glctco5k5uoqg","modified":0,"renderable":0},{"_id":"source/_posts/phpMyAdmin搭建/6.png","slug":"6.png","post":"cjxwlqrka000glctco5k5uoqg","modified":0,"renderable":0},{"_id":"source/_posts/saltstack远程执行/01.png","slug":"01.png","post":"cjxwlqrkz000tlctcfmrxjbr9","modified":0,"renderable":0},{"_id":"source/_posts/saltstack远程执行/02.png","slug":"02.png","post":"cjxwlqrkz000tlctcfmrxjbr9","modified":0,"renderable":0},{"_id":"source/_posts/saltstack远程执行/03.png","slug":"03.png","post":"cjxwlqrkz000tlctcfmrxjbr9","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat+Nginx+Memcached综合案例/tomcat1.png","slug":"tomcat1.png","post":"cjxwlqrm0001elctctc1lfs4w","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat+Nginx+Memcached综合案例/tomcat2.png","slug":"tomcat2.png","post":"cjxwlqrm0001elctctc1lfs4w","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat+Nginx+Memcached综合案例/tomcat3.png","slug":"tomcat3.png","post":"cjxwlqrm0001elctctc1lfs4w","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat+Nginx+Memcached综合案例/tomcat4.png","slug":"tomcat4.png","post":"cjxwlqrm0001elctctc1lfs4w","modified":0,"renderable":0},{"_id":"source/_posts/saltstack配置管理/01.png","slug":"01.png","post":"cjxwlqrns0025lctcy7gtwsxy","modified":0,"renderable":0},{"_id":"source/_posts/saltstack基本入门/01.png","slug":"01.png","post":"cjxwlqrnq0024lctcyia0ow5a","modified":0,"renderable":0},{"_id":"source/_posts/saltstack基本入门/02.png","slug":"02.png","post":"cjxwlqrnq0024lctcyia0ow5a","modified":0,"renderable":0},{"_id":"source/_posts/Ansible之Playbook/shili01.png","slug":"shili01.png","post":"cjxwlqrqo002llctcvyy5yzln","modified":0,"renderable":0},{"_id":"source/_posts/Ansible之Playbook/shili02.png","slug":"shili02.png","post":"cjxwlqrqo002llctcvyy5yzln","modified":0,"renderable":0},{"_id":"source/_posts/Ansible之Playbook/shili03.png","slug":"shili03.png","post":"cjxwlqrqo002llctcvyy5yzln","modified":0,"renderable":0},{"_id":"source/_posts/saltstack项目实战/01.png","slug":"01.png","post":"cjxwlqrqd002flctc55dkujpm","modified":0,"renderable":0},{"_id":"source/_posts/saltstack项目实战/02.png","slug":"02.png","post":"cjxwlqrqd002flctc55dkujpm","modified":0,"renderable":0},{"_id":"source/_posts/saltstack项目实战/03.png","slug":"03.png","post":"cjxwlqrqd002flctc55dkujpm","modified":0,"renderable":0},{"_id":"source/_posts/saltstack项目实战/04.png","slug":"04.png","post":"cjxwlqrqd002flctc55dkujpm","modified":0,"renderable":0},{"_id":"source/_posts/saltstack项目实战/05.png","slug":"05.png","post":"cjxwlqrqd002flctc55dkujpm","modified":0,"renderable":0},{"_id":"source/_posts/saltstack项目实战/06.png","slug":"06.png","post":"cjxwlqrqd002flctc55dkujpm","modified":0,"renderable":0},{"_id":"source/_posts/saltstack项目实战/07.png","slug":"07.png","post":"cjxwlqrqd002flctc55dkujpm","modified":0,"renderable":0},{"_id":"source/_posts/Cobbler自动化部署/cobbler01.png","slug":"cobbler01.png","post":"cjxwlqrqg002glctcd5evuez3","modified":0,"renderable":0},{"_id":"source/_posts/Cobbler自动化部署/cobbler02.png","slug":"cobbler02.png","post":"cjxwlqrqg002glctcd5evuez3","modified":0,"renderable":0},{"_id":"source/_posts/Cobbler自动化部署/cobbler03.png","slug":"cobbler03.png","post":"cjxwlqrqg002glctcd5evuez3","modified":0,"renderable":0},{"_id":"source/_posts/Cobbler自动化部署/cobbler04.png","slug":"cobbler04.png","post":"cjxwlqrqg002glctcd5evuez3","modified":0,"renderable":0},{"_id":"source/_posts/Cobbler自动化部署/cobbler05.png","slug":"cobbler05.png","post":"cjxwlqrqg002glctcd5evuez3","modified":0,"renderable":0},{"_id":"source/_posts/Cobbler自动化部署/cobbler06.png","slug":"cobbler06.png","post":"cjxwlqrqg002glctcd5evuez3","modified":0,"renderable":0},{"_id":"source/_posts/Cobbler自动化部署/cobbler07.png","slug":"cobbler07.png","post":"cjxwlqrqg002glctcd5evuez3","modified":0,"renderable":0},{"_id":"source/_posts/Cobbler自动化部署/cobbler08.png","slug":"cobbler08.png","post":"cjxwlqrqg002glctcd5evuez3","modified":0,"renderable":0},{"_id":"source/_posts/Cobbler自动化部署/cobbler09.png","slug":"cobbler09.png","post":"cjxwlqrqg002glctcd5evuez3","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat安装与部署/tomcat01.png","slug":"tomcat01.png","post":"cjxwlqrqj002ilctcnqawjqtj","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat安装与部署/tomcat02.png","slug":"tomcat02.png","post":"cjxwlqrqj002ilctcnqawjqtj","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat安装与部署/tomcat03.png","slug":"tomcat03.png","post":"cjxwlqrqj002ilctcnqawjqtj","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat安装与部署/tomcat04.png","slug":"tomcat04.png","post":"cjxwlqrqj002ilctcnqawjqtj","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat安装与部署/tomcat05.png","slug":"tomcat05.png","post":"cjxwlqrqj002ilctcnqawjqtj","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat安装与部署/tomcat07.png","slug":"tomcat07.png","post":"cjxwlqrqj002ilctcnqawjqtj","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat安装与部署/tomcat08.png","slug":"tomcat08.png","post":"cjxwlqrqj002ilctcnqawjqtj","modified":0,"renderable":0},{"_id":"source/_posts/Tomcat安装与部署/tomcat09.png","slug":"tomcat09.png","post":"cjxwlqrqj002ilctcnqawjqtj","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门四-filebeat替代logstash收集日志/file02.png","slug":"file02.png","post":"cjz3xyigm0001dstca0f16i35","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门四-filebeat替代logstash收集日志/file01.png","slug":"file01.png","post":"cjz3xyigm0001dstca0f16i35","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门三-logstash收集日志写入redis/redis04.png","slug":"redis04.png","post":"cjz3xyiig0006dstcwqlyjqcl","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk11.png","slug":"elk11.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门五-配置nginx代理kibana/nginx01.png","slug":"nginx01.png","post":"cjz3xyifu0000dstchojk9zfj","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门五-配置nginx代理kibana/nginx02.png","slug":"nginx02.png","post":"cjz3xyifu0000dstchojk9zfj","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门四-filebeat替代logstash收集日志/file03.png","slug":"file03.png","post":"cjz3xyigm0001dstca0f16i35","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门三-logstash收集日志写入redis/redis01.png","slug":"redis01.png","post":"cjz3xyiig0006dstcwqlyjqcl","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门三-logstash收集日志写入redis/redis02.png","slug":"redis02.png","post":"cjz3xyiig0006dstcwqlyjqcl","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门三-logstash收集日志写入redis/redis03.png","slug":"redis03.png","post":"cjz3xyiig0006dstcwqlyjqcl","modified":0,"renderable":0},{"_id":"source/_posts/存储服务之NFS/01.png","slug":"01.png","post":"cjz3xyiof0009dstcam6n1ur0","modified":0,"renderable":0},{"_id":"source/_posts/存储服务之NFS/02.png","slug":"02.png","post":"cjz3xyiof0009dstcam6n1ur0","modified":0,"renderable":0},{"_id":"source/_posts/存储服务之NFS/03.png","slug":"03.png","post":"cjz3xyiof0009dstcam6n1ur0","modified":0,"renderable":0},{"_id":"source/_posts/存储服务之NFS/04.png","slug":"04.png","post":"cjz3xyiof0009dstcam6n1ur0","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk01.png","slug":"elk01.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk02.png","slug":"elk02.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk03.png","slug":"elk03.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk04.png","slug":"elk04.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk05.png","slug":"elk05.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk06.png","slug":"elk06.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk07.png","slug":"elk07.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk08.png","slug":"elk08.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk09.png","slug":"elk09.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk10.png","slug":"elk10.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk12.png","slug":"elk12.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk13.png","slug":"elk13.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk14.png","slug":"elk14.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门一-基本部署/elk15.png","slug":"elk15.png","post":"cjz3xyiot000adstcdo126x0a","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log01.png","slug":"log01.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log02.png","slug":"log02.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log03.png","slug":"log03.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log04.png","slug":"log04.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log05.png","slug":"log05.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log06.png","slug":"log06.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log07.png","slug":"log07.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log08.png","slug":"log08.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log09.png","slug":"log09.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log10.png","slug":"log10.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log11.png","slug":"log11.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log12.png","slug":"log12.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log13.png","slug":"log13.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log14.png","slug":"log14.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log15.png","slug":"log15.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log16.png","slug":"log16.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log17.png","slug":"log17.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log18.png","slug":"log18.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log19.png","slug":"log19.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log20.png","slug":"log20.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log21.png","slug":"log21.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/ELK快速入门二-通过logstash收集日志/log22.png","slug":"log22.png","post":"cjz3xyitr000hdstc81arw9mu","modified":0,"renderable":0},{"_id":"source/_posts/PHP配合inotify实现光闸ftp功能/01.png","slug":"01.png","post":"cjz3xyiuh000kdstcz1u3q8dr","modified":0,"renderable":0},{"_id":"source/_posts/网络RAID技术DRBD/01.jpg","slug":"01.jpg","post":"ck24hnl8y00004dnrqq7fnoi4","modified":0,"renderable":0},{"_id":"source/_posts/(一)Kubernetes系统基础/1.gif","post":"ck24hxdse00006wnr3w3gfnqu","slug":"1.gif","modified":1,"renderable":1},{"_id":"source/_posts/(一)Kubernetes系统基础/cluster.png","post":"ck24hxdse00006wnr3w3gfnqu","slug":"cluster.png","modified":1,"renderable":1},{"_id":"source/_posts/(一)Kubernetes系统基础/deployment.png","post":"ck24hxdse00006wnr3w3gfnqu","slug":"deployment.png","modified":1,"renderable":1},{"_id":"source/_posts/(一)Kubernetes系统基础/kubernetescluster.png","post":"ck24hxdse00006wnr3w3gfnqu","slug":"kubernetescluster.png","modified":1,"renderable":1},{"_id":"source/_posts/(一)Kubernetes系统基础/label.png","post":"ck24hxdse00006wnr3w3gfnqu","slug":"label.png","modified":1,"renderable":1},{"_id":"source/_posts/(一)Kubernetes系统基础/labels.png","post":"ck24hxdse00006wnr3w3gfnqu","slug":"labels.png","modified":1,"renderable":1},{"_id":"source/_posts/(一)Kubernetes系统基础/namespace.png","post":"ck24hxdse00006wnr3w3gfnqu","slug":"namespace.png","modified":1,"renderable":1},{"_id":"source/_posts/(一)Kubernetes系统基础/pod.png","post":"ck24hxdse00006wnr3w3gfnqu","slug":"pod.png","modified":1,"renderable":1},{"_id":"source/_posts/(一)Kubernetes系统基础/scheduler.png","post":"ck24hxdse00006wnr3w3gfnqu","slug":"scheduler.png","modified":1,"renderable":1},{"_id":"source/_posts/(一)Kubernetes系统基础/system.png","post":"ck24hxdse00006wnr3w3gfnqu","slug":"system.png","modified":1,"renderable":1}],"PostCategory":[{"post_id":"cjxwlqrcm0000lctcqojngy03","category_id":"cjxwlqrcx0002lctcnlv5wop8","_id":"cjxwlqrdf0007lctcbxj3j84k"},{"post_id":"cjxwlqrct0001lctc9hxr5k60","category_id":"cjxwlqrd80004lctcfy113hld","_id":"cjxwlqrdj0009lctcnz4l5kmk"},{"post_id":"cjxwlqrkg000jlctc4avv1a70","category_id":"cjxwlqrk8000elctc9uyi0mt2","_id":"cjxwlqrkv000rlctc0r3hsdb8"},{"post_id":"cjxwlqrju000alctc1h6slfn1","category_id":"cjxwlqrk8000elctc9uyi0mt2","_id":"cjxwlqrl1000ulctcud3c163g"},{"post_id":"cjxwlqrk0000clctca2p7ixnr","category_id":"cjxwlqrk8000elctc9uyi0mt2","_id":"cjxwlqrl6000ylctc8nhn6705"},{"post_id":"cjxwlqrka000glctco5k5uoqg","category_id":"cjxwlqrk8000elctc9uyi0mt2","_id":"cjxwlqrli0014lctclpf5qwe7"},{"post_id":"cjxwlqrkk000llctccnlax5cu","category_id":"cjxwlqrl5000xlctcbb3o1c57","_id":"cjxwlqrlx001clctc6fqgij5t"},{"post_id":"cjxwlqrkp000olctc8vqiftmr","category_id":"cjxwlqrl5000xlctcbb3o1c57","_id":"cjxwlqrm5001hlctcs4vc7ihb"},{"post_id":"cjxwlqrkt000qlctc7ixp4qe4","category_id":"cjxwlqrl5000xlctcbb3o1c57","_id":"cjxwlqrmd001llctclmr6dppz"},{"post_id":"cjxwlqrkz000tlctcfmrxjbr9","category_id":"cjxwlqrl5000xlctcbb3o1c57","_id":"cjxwlqrmi001plctc908bp8q3"},{"post_id":"cjxwlqrl2000vlctccstgkfe1","category_id":"cjxwlqrl5000xlctcbb3o1c57","_id":"cjxwlqrmm001slctcvy2v5j7p"},{"post_id":"cjxwlqrla0010lctc6qq10fec","category_id":"cjxwlqrmh001olctcioy5udyv","_id":"cjxwlqrmz001wlctchviqrity"},{"post_id":"cjxwlqrlf0012lctccjytlut2","category_id":"cjxwlqrmh001olctcioy5udyv","_id":"cjxwlqrn5001zlctclnmgb0ei"},{"post_id":"cjxwlqrlm0017lctc4yfk9i80","category_id":"cjxwlqrmh001olctcioy5udyv","_id":"cjxwlqrnb0021lctc4fh0zy98"},{"post_id":"cjxwlqrlq0019lctch80rsqyt","category_id":"cjxwlqrmh001olctcioy5udyv","_id":"cjxwlqrnc0022lctcuxw9g3b2"},{"post_id":"cjxwlqrm0001elctctc1lfs4w","category_id":"cjxwlqrn90020lctckyb7t8ek","_id":"cjxwlqrnd0023lctcgqggjc7c"},{"post_id":"cjxwlqrnq0024lctcyia0ow5a","category_id":"cjxwlqrl5000xlctcbb3o1c57","_id":"cjxwlqrny0029lctcexn465y3"},{"post_id":"cjxwlqrns0025lctcy7gtwsxy","category_id":"cjxwlqrl5000xlctcbb3o1c57","_id":"cjxwlqrob002clctcase312qo"},{"post_id":"cjxwlqrqd002flctc55dkujpm","category_id":"cjxwlqrl5000xlctcbb3o1c57","_id":"cjxwlqrqr002mlctc9a845wqt"},{"post_id":"cjxwlqrqj002ilctcnqawjqtj","category_id":"cjxwlqrn90020lctckyb7t8ek","_id":"cjxwlqrr2002plctc98f7nfjq"},{"post_id":"cjxwlqrqo002llctcvyy5yzln","category_id":"cjxwlqrmh001olctcioy5udyv","_id":"cjxwlqrr4002rlctcz5gmn94z"},{"post_id":"cjxwlqrqg002glctcd5evuez3","category_id":"cjxwlqrql002jlctcld92wkh7","_id":"cjxwlqrr6002slctcbm88iyga"},{"post_id":"cjz3xyifu0000dstchojk9zfj","category_id":"cjxwlqro8002alctcv5p9kksc","_id":"cjz3xyih00004dstciqz4lefn"},{"post_id":"cjz3xyigm0001dstca0f16i35","category_id":"cjxwlqro8002alctcv5p9kksc","_id":"cjz3xyih40005dstco3hdqhzi"},{"post_id":"cjz3xyiig0006dstcwqlyjqcl","category_id":"cjxwlqro8002alctcv5p9kksc","_id":"cjz3xyij40008dstcqmntz24y"},{"post_id":"cjz3xyiot000adstcdo126x0a","category_id":"cjxwlqro8002alctcv5p9kksc","_id":"cjz3xyiq2000edstcqq0cfewi"},{"post_id":"cjz3xyiof0009dstcam6n1ur0","category_id":"cjz3xyipi000bdstcn46t15ln","_id":"cjz3xyiqa000gdstcpqwubnyu"},{"post_id":"cjz3xyitr000hdstc81arw9mu","category_id":"cjxwlqro8002alctcv5p9kksc","_id":"cjz3xyiu3000jdstccueqvyhi"},{"post_id":"cjz3xyiuh000kdstcz1u3q8dr","category_id":"cjxwlqrd80004lctcfy113hld","_id":"cjz3xyiur000mdstckccynpu6"},{"post_id":"ck24hnl8y00004dnrqq7fnoi4","category_id":"cjz3xyipi000bdstcn46t15ln","_id":"ck24hnl9700024dnr6z5gwjd6"},{"post_id":"ck24hxdse00006wnr3w3gfnqu","category_id":"ck24hxdte00016wnruf1adni8","_id":"ck24hxdtj00046wnrn8ev79ad"}],"PostTag":[{"post_id":"cjxwlqrcm0000lctcqojngy03","tag_id":"cjxwlqrd30003lctc2s9utzq4","_id":"cjxwlqrdc0006lctcbkydjray"},{"post_id":"cjxwlqrct0001lctc9hxr5k60","tag_id":"cjxwlqrd30003lctc2s9utzq4","_id":"cjxwlqrdi0008lctcsitw8gf6"},{"post_id":"cjxwlqrju000alctc1h6slfn1","tag_id":"cjxwlqrd30003lctc2s9utzq4","_id":"cjxwlqrk9000flctc2kectvg4"},{"post_id":"cjxwlqrk0000clctca2p7ixnr","tag_id":"cjxwlqrd30003lctc2s9utzq4","_id":"cjxwlqrkf000ilctcjdrn2t91"},{"post_id":"cjxwlqrka000glctco5k5uoqg","tag_id":"cjxwlqrd30003lctc2s9utzq4","_id":"cjxwlqrkj000klctcvjt1t1ag"},{"post_id":"cjxwlqrkg000jlctc4avv1a70","tag_id":"cjxwlqrd30003lctc2s9utzq4","_id":"cjxwlqrko000nlctcpeqx4vsw"},{"post_id":"cjxwlqrkz000tlctcfmrxjbr9","tag_id":"cjxwlqrkr000plctcjnomepyp","_id":"cjxwlqrl8000zlctckjct7grn"},{"post_id":"cjxwlqrkk000llctccnlax5cu","tag_id":"cjxwlqrkr000plctcjnomepyp","_id":"cjxwlqrle0011lctci8awnajp"},{"post_id":"cjxwlqrl2000vlctccstgkfe1","tag_id":"cjxwlqrkr000plctcjnomepyp","_id":"cjxwlqrll0016lctcbbjx93fp"},{"post_id":"cjxwlqrkp000olctc8vqiftmr","tag_id":"cjxwlqrkr000plctcjnomepyp","_id":"cjxwlqrlo0018lctc2wt5z457"},{"post_id":"cjxwlqrkt000qlctc7ixp4qe4","tag_id":"cjxwlqrkr000plctcjnomepyp","_id":"cjxwlqrlz001dlctc17zjew89"},{"post_id":"cjxwlqrla0010lctc6qq10fec","tag_id":"cjxwlqrlv001alctchlehvpd0","_id":"cjxwlqrm8001ilctc67m68mog"},{"post_id":"cjxwlqrlf0012lctccjytlut2","tag_id":"cjxwlqrlv001alctchlehvpd0","_id":"cjxwlqrme001mlctcqenprecl"},{"post_id":"cjxwlqrlm0017lctc4yfk9i80","tag_id":"cjxwlqrlv001alctchlehvpd0","_id":"cjxwlqrmj001qlctc3gc6duj2"},{"post_id":"cjxwlqrlq0019lctch80rsqyt","tag_id":"cjxwlqrlv001alctchlehvpd0","_id":"cjxwlqrmw001ulctc2nm06hzf"},{"post_id":"cjxwlqrm0001elctctc1lfs4w","tag_id":"cjxwlqrmk001rlctc6n54trbe","_id":"cjxwlqrn0001xlctcr9j6uxon"},{"post_id":"cjxwlqrnq0024lctcyia0ow5a","tag_id":"cjxwlqrkr000plctcjnomepyp","_id":"cjxwlqrnu0026lctco89ajmln"},{"post_id":"cjxwlqrns0025lctcy7gtwsxy","tag_id":"cjxwlqrkr000plctcjnomepyp","_id":"cjxwlqrnx0028lctcz3lcz4zl"},{"post_id":"cjxwlqrqd002flctc55dkujpm","tag_id":"cjxwlqrkr000plctcjnomepyp","_id":"cjxwlqrqi002hlctcazrshtaa"},{"post_id":"cjxwlqrqj002ilctcnqawjqtj","tag_id":"cjxwlqrmk001rlctc6n54trbe","_id":"cjxwlqrqy002nlctczzmw8xxp"},{"post_id":"cjxwlqrqo002llctcvyy5yzln","tag_id":"cjxwlqrlv001alctchlehvpd0","_id":"cjxwlqrr1002olctcq7ms56e8"},{"post_id":"cjxwlqrqg002glctcd5evuez3","tag_id":"cjxwlqrqm002klctc7yn8f1w4","_id":"cjxwlqrr3002qlctctagn10jf"},{"post_id":"cjz3xyifu0000dstchojk9zfj","tag_id":"cjxwlqro9002blctc30crcgz8","_id":"cjz3xyigu0002dstc0yoc3r9o"},{"post_id":"cjz3xyigm0001dstca0f16i35","tag_id":"cjxwlqro9002blctc30crcgz8","_id":"cjz3xyigz0003dstcl2wcajac"},{"post_id":"cjz3xyiig0006dstcwqlyjqcl","tag_id":"cjxwlqro9002blctc30crcgz8","_id":"cjz3xyij00007dstci1090bp3"},{"post_id":"cjz3xyiot000adstcdo126x0a","tag_id":"cjxwlqro9002blctc30crcgz8","_id":"cjz3xyipr000ddstcie1cw145"},{"post_id":"cjz3xyiof0009dstcam6n1ur0","tag_id":"cjz3xyipm000cdstcri1rbajb","_id":"cjz3xyiq5000fdstctvaqu5an"},{"post_id":"cjz3xyitr000hdstc81arw9mu","tag_id":"cjxwlqro9002blctc30crcgz8","_id":"cjz3xyiu1000idstc1wdczpit"},{"post_id":"cjz3xyiuh000kdstcz1u3q8dr","tag_id":"cjz3xyiup000ldstc0mjp5y6n","_id":"cjz3xyiuv000ndstcice46tex"},{"post_id":"ck24hnl8y00004dnrqq7fnoi4","tag_id":"cjz3xyipm000cdstcri1rbajb","_id":"ck24hnl9600014dnriuwjgde3"},{"post_id":"ck24hxdse00006wnr3w3gfnqu","tag_id":"ck24hxdth00026wnrjq4t33ix","_id":"ck24hxdtj00036wnrardc7xf7"}],"Tag":[{"name":"Linux运维日常","_id":"cjxwlqrd30003lctc2s9utzq4"},{"name":"Saltstack","_id":"cjxwlqrkr000plctcjnomepyp"},{"name":"Ansible","_id":"cjxwlqrlv001alctchlehvpd0"},{"name":"Tomcat","_id":"cjxwlqrmk001rlctc6n54trbe"},{"name":"ELK","_id":"cjxwlqro9002blctc30crcgz8"},{"name":"Cobbler","_id":"cjxwlqrqm002klctc7yn8f1w4"},{"name":"Storage","_id":"cjz3xyipm000cdstcri1rbajb"},{"name":"Linux","_id":"cjz3xyiup000ldstc0mjp5y6n"},{"name":"Kubernetes","_id":"ck24hxdth00026wnrjq4t33ix"}]}}