{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":1,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":1,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/avatar.png","path":"images/avatar.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":1,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":1,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/avatar3.png","path":"images/avatar3.png","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/algolia-search.js","path":"js/src/algolia-search.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/exturl.js","path":"js/src/exturl.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/hook-duoshuo.js","path":"js/src/hook-duoshuo.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/js.cookie.js","path":"js/src/js.cookie.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/scroll-cookie.js","path":"js/src/scroll-cookie.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","path":"lib/canvas-nest/canvas-nest.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","path":"lib/algolia-instant-search/instantsearch.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","path":"lib/canvas-ribbon/canvas-ribbon.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fastclick/LICENSE","path":"lib/fastclick/LICENSE","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fastclick/README.md","path":"lib/fastclick/README.md","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fastclick/bower.json","path":"lib/fastclick/bower.json","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","path":"lib/font-awesome/HELP-US-OUT.txt","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/bower.json","path":"lib/font-awesome/bower.json","modified":1,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","path":"lib/jquery_lazyload/CONTRIBUTING.md","modified":1,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","path":"lib/jquery_lazyload/README.md","modified":1,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","path":"lib/jquery_lazyload/bower.json","modified":1,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","path":"lib/jquery_lazyload/jquery.scrollstop.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","path":"lib/jquery_lazyload/jquery.lazyload.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.js","path":"lib/needsharebutton/needsharebutton.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/font-embedded.css","path":"lib/needsharebutton/font-embedded.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.css","path":"lib/needsharebutton/needsharebutton.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/LICENSE","path":"lib/pace/LICENSE","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/README.md","path":"lib/pace/README.md","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","path":"lib/pace/pace-theme-barber-shop.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","path":"lib/pace/pace-theme-big-counter.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","path":"lib/pace/pace-theme-center-atom.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","path":"lib/pace/pace-theme-center-radar.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","path":"lib/pace/pace-theme-bounce.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","path":"lib/pace/pace-theme-center-circle.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","path":"lib/pace/pace-theme-center-simple.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","path":"lib/pace/pace-theme-corner-indicator.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","path":"lib/pace/pace-theme-flash.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","path":"lib/pace/pace-theme-fill-left.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","path":"lib/pace/pace-theme-mac-osx.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","path":"lib/pace/pace-theme-minimal.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","path":"lib/pace/pace-theme-loading-bar.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace.min.js","path":"lib/pace/pace.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","path":"lib/three/canvas_sphere.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/bower.json","path":"lib/velocity/bower.json","modified":1,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","path":"lib/three/canvas_lines.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/three/three-waves.min.js","path":"lib/three/three-waves.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","path":"lib/velocity/velocity.ui.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/Valine.min.js","path":"js/src/Valine.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/jquery/index.js","path":"lib/jquery/index.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/av-min.js","path":"js/src/av-min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","path":"lib/fancybox/source/fancybox_loading.gif","modified":1,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.css","path":"lib/Han/dist/han.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.js","path":"lib/Han/dist/han.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","path":"lib/fancybox/source/blank.gif","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","path":"lib/fancybox/source/fancybox_overlay.png","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","path":"lib/fancybox/source/fancybox_loading@2x.gif","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","path":"lib/fancybox/source/fancybox_sprite.png","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","path":"lib/fancybox/source/fancybox_sprite@2x.png","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","path":"lib/fancybox/source/jquery.fancybox.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","path":"lib/fastclick/lib/fastclick.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","path":"lib/fastclick/lib/fastclick.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","path":"lib/font-awesome/css/font-awesome.css.map","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","path":"lib/ua-parser-js/dist/ua-parser.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","path":"lib/ua-parser-js/dist/ua-parser.pack.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.css","path":"lib/Han/dist/han.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":1,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","path":"lib/Han/dist/font/han-space.otf","modified":1,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","path":"lib/Han/dist/font/han-space.woff","modified":1,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","path":"lib/Han/dist/font/han.otf","modified":1,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","path":"lib/Han/dist/font/han.woff","modified":1,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.woff2","path":"lib/Han/dist/font/han.woff2","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","path":"lib/fancybox/source/helpers/fancybox_buttons.png","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","path":"lib/fancybox/source/helpers/jquery.fancybox-media.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.js","path":"lib/Han/dist/han.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","path":"lib/font-awesome/fonts/FontAwesome.otf","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","path":"lib/font-awesome/fonts/fontawesome-webfont.ttf","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.js","path":"lib/velocity/velocity.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":1,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","path":"lib/algolia-instant-search/instantsearch.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/three/three.min.js","path":"lib/three/three.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","path":"lib/font-awesome/fonts/fontawesome-webfont.svg","modified":1,"renderable":1}],"Cache":[{"_id":"source/.DS_Store","hash":"cc75fbdb977a72e3c33a32b977ec965c1597d5c5","modified":1557936211109},{"_id":"themes/next/.bowerrc","hash":"3228a58ed0ece9f85e1e3136352094080b8dece1","modified":1514748788000},{"_id":"themes/next/.gitattributes","hash":"44bd4729c74ccb88110804f41746fec07bf487d4","modified":1514748788000},{"_id":"themes/next/.gitignore","hash":"0b5c2ffd41f66eb1849d6426ba8cf9649eeed329","modified":1514748788000},{"_id":"themes/next/.editorconfig","hash":"792fd2bd8174ece1a75d5fd24ab16594886f3a7f","modified":1514748788000},{"_id":"themes/next/.javascript_ignore","hash":"8a224b381155f10e6eb132a4d815c5b52962a9d1","modified":1514748788000},{"_id":"themes/next/.hound.yml","hash":"b76daa84c9ca3ad292c78412603370a367cc2bc3","modified":1514748788000},{"_id":"themes/next/.jshintrc","hash":"9928f81bd822f6a8d67fdbc909b517178533bca9","modified":1514748788000},{"_id":"themes/next/.stylintrc","hash":"b28e24704a5d8de08346c45286574c8e76cc109f","modified":1514748788000},{"_id":"themes/next/.travis.yml","hash":"d60d4a5375fea23d53b2156b764a99b2e56fa660","modified":1514748788000},{"_id":"themes/next/README.md","hash":"898213e66d34a46c3cf8446bf693bd50db0d3269","modified":1514748788000},{"_id":"themes/next/LICENSE","hash":"f293bcfcdc06c0b77ba13570bb8af55eb5c059fd","modified":1514748788000},{"_id":"themes/next/bower.json","hash":"0674f11d3d514e087a176da0e1d85c2286aa5fba","modified":1514748788000},{"_id":"themes/next/package.json","hash":"036d3a1346203d2f1a3958024df7f74e7ac07bfe","modified":1514748788000},{"_id":"themes/next/gulpfile.coffee","hash":"031bffc483e417b20e90eceb6cf358e7596d2e69","modified":1514748788000},{"_id":"themes/next/_config.yml","hash":"baa2bbe6e810fae74a0b6f726e5e81c5d4fe6a11","modified":1558615414150},{"_id":"themes/next/README.cn.md","hash":"58ffe752bc4b7f0069fcd6304bbc2d5ff7b80f89","modified":1514748788000},{"_id":"source/_posts/MySQL自动备份脚本.md","hash":"8ee5aaa0cf9ab6fcd9f1b98d4004a804e2647160","modified":1558099401438},{"_id":"source/_posts/ftp虚拟用户.md","hash":"2d5bbc0dadc9f492a1215d2929c0d6ec4e674a21","modified":1556030242762},{"_id":"source/_posts/Ansible Ad-hoc常用Module.md","hash":"86039af4222120a3e1a709e408e49ebb9148140b","modified":1558971102995},{"_id":"source/_posts/Ansible快速入门.md","hash":"2427b4811417b9286fb750495e5a07100ccb0a8c","modified":1558971102995},{"_id":"source/_posts/linux保存history到日志文件.md","hash":"bd29ec4a126f39b0feb431d10ece11811561b940","modified":1558530479030},{"_id":"source/_posts/linux下解压windows上压缩rar包.md","hash":"3d5d981f7556a44a9b132a1549a8d3ae5b22c495","modified":1556604910476},{"_id":"source/_posts/phpMyAdmin搭建.md","hash":"4233eca65b3534890a91f5822f46e4e34349b603","modified":1558099401439},{"_id":"source/_posts/phpRedisAdmin搭建.md","hash":"c32a0be5c2bc4e10f263c126611631876071da94","modified":1558099401439},{"_id":"source/_posts/saltstack使用salt-ssh.md","hash":"f3c2948a2af418839fca7ddcd15cab04aa79d653","modified":1558614597764},{"_id":"source/_posts/saltstack数据系统.md","hash":"331a69c03987f73ba57bb2c40b8cafd0177eb83f","modified":1558099401439},{"_id":"source/_posts/saltstack状态判断unless与onlyif.md","hash":"70e8388ebf584e752346cc798cc9f44acc9053c0","modified":1558099401440},{"_id":"source/_posts/saltstack远程执行.md","hash":"3afe2a6024ffd9545d927212b4b59d9dc466b93a","modified":1559049553931},{"_id":"source/_posts/saltstack接口salt-api.md","hash":"67ee2a5013fdb8caabf898541de226a200dccdcc","modified":1558624521768},{"_id":"source/_posts/saltstack基本入门.md","hash":"6dcf959a10ab7d6124c2b01d42a4391a95e82803","modified":1557837790857},{"_id":"source/categories/index.md","hash":"af423fcd07075032a3891c59f4c6704b453b561c","modified":1556159772750},{"_id":"source/_posts/saltstack配置管理.md","hash":"20129aef8ee0f3bd5d0ca707eec0042f8772f482","modified":1558099382898},{"_id":"source/_posts/saltstack项目实战.md","hash":"492e8946131e5284efbc7feb9d65cc1c00ee8edb","modified":1558530479031},{"_id":"source/photos/index.md","hash":"6c52c1388adffb027c83f747bc05133bec05508c","modified":1555951095074},{"_id":"source/tags/index.md","hash":"519745fc886e3e27fd53e7d567b98241f75a537e","modified":1556159772755},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"3b5eafd32abb718e56ccf8d1cee0607ad8ce611d","modified":1514748788000},{"_id":"themes/next/.github/ISSUE_TEMPLATE.md","hash":"352093a1b210c72136687fd2eee649244cee402c","modified":1514748788000},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"902f627155a65099e0a37842ff396a58d0dc306f","modified":1514748788000},{"_id":"themes/next/.github/browserstack_logo.png","hash":"a6c43887f64a7f48a2814e3714eaa1215e542037","modified":1514748788000},{"_id":"themes/next/layout/_layout.swig","hash":"129f3c8fdbd182624578840cc07278fd17eaf64e","modified":1556168041888},{"_id":"themes/next/layout/category.swig","hash":"4472255f4a3e3dd6d79201523a9526dcabdfbf18","modified":1514748788000},{"_id":"themes/next/layout/archive.swig","hash":"f0a8225feafd971419837cdb4bcfec98a4a59b2f","modified":1514748788000},{"_id":"themes/next/layout/page.swig","hash":"969caaee05bdea725e99016eb63d810893a73e99","modified":1514748788000},{"_id":"themes/next/layout/post.swig","hash":"b3589a8e46288a10d20e41c7a5985d2493725aec","modified":1514748788000},{"_id":"themes/next/layout/index.swig","hash":"783611349c941848a0e26ee2f1dc44dd14879bd1","modified":1514748788000},{"_id":"themes/next/layout/schedule.swig","hash":"d86f8de4e118f8c4d778b285c140474084a271db","modified":1514748788000},{"_id":"themes/next/layout/tag.swig","hash":"7e0a7d7d832883eddb1297483ad22c184e4368de","modified":1514748788000},{"_id":"themes/next/languages/de.yml","hash":"057e7df11ddeb1c8c15a5d7c5ff29430d725ec6b","modified":1514748788000},{"_id":"themes/next/languages/en.yml","hash":"7e680d9bb8f3a3a9d1ba1c9d312b3d257183dded","modified":1556168496047},{"_id":"themes/next/languages/default.yml","hash":"44ef3f26917f467459326c2c8be2f73e4d947f35","modified":1514748788000},{"_id":"themes/next/languages/fr-FR.yml","hash":"7e4eb7011b8feee641cfb11c6e73180b0ded1c0f","modified":1514748788000},{"_id":"themes/next/languages/id.yml","hash":"b5de1ea66dd9ef54cac9a1440eaa4e3f5fc011f5","modified":1514748788000},{"_id":"themes/next/languages/it.yml","hash":"aa595f2bda029f73ef7bfa104b4c55c3f4e9fb4c","modified":1514748788000},{"_id":"themes/next/languages/ja.yml","hash":"3c76e16fd19b262864475faa6854b718bc08c4d8","modified":1514748788000},{"_id":"themes/next/languages/nl-NL.yml","hash":"edca4f3598857dbc3cbf19ed412213329b6edd47","modified":1514748788000},{"_id":"themes/next/languages/pt-BR.yml","hash":"b1694ae766ed90277bcc4daca4b1cfa19cdcb72b","modified":1514748788000},{"_id":"themes/next/languages/pt.yml","hash":"44b61f2d085b827b507909a0b8f8ce31c6ef5d04","modified":1514748788000},{"_id":"themes/next/languages/ko.yml","hash":"ea5b46056e73ebcee121d5551627af35cbffc900","modified":1514748788000},{"_id":"themes/next/languages/ru.yml","hash":"98ec6f0b7183282e11cffc7ff586ceb82400dd75","modified":1514748788000},{"_id":"themes/next/languages/vi.yml","hash":"fd08d3c8d2c62965a98ac420fdaf95e54c25d97c","modified":1514748788000},{"_id":"themes/next/scripts/merge-configs.js","hash":"81e86717ecfb775986b945d17f0a4ba27532ef07","modified":1514748788000},{"_id":"themes/next/languages/zh-tw.yml","hash":"50b71abb3ecc0686f9739e179e2f829cd074ecd9","modified":1514748788000},{"_id":"themes/next/languages/zh-Hans.yml","hash":"7dac6b188c6a3902d01613383c5350f65d442f08","modified":1556168621773},{"_id":"themes/next/languages/zh-hk.yml","hash":"9396f41ae76e4fef99b257c93c7354e661f6e0fa","modified":1514748788000},{"_id":"themes/next/scripts/merge.js","hash":"9130dabe6a674c54b535f322b17d75fe6081472f","modified":1514748788000},{"_id":"themes/next/test/.jshintrc","hash":"19f93d13d1689fe033c82eb2d5f3ce30b6543cc0","modified":1514748788000},{"_id":"themes/next/test/helpers.js","hash":"a1f5de25154c3724ffc24a91ddc576cdbd60864f","modified":1514748788000},{"_id":"themes/next/test/intern.js","hash":"11fa8a4f5c3b4119a179ae0a2584c8187f907a73","modified":1514748788000},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"source/_posts/imgs/salt01.png","hash":"680d3cb476d5561e2f0fe20c9f62fb87dc56929a","modified":1559049553930},{"_id":"source/_posts/imgs/salt03.png","hash":"95ad81478ae7a8e095f8ce776df11aa8444e0ca0","modified":1559049553930},{"_id":"source/_posts/imgs/salt04.png","hash":"784057974cfaa2ff6c8968d444dd1bf6759c0df8","modified":1559049553931},{"_id":"source/_posts/imgs/salt02.png","hash":"57dc4a414ae7cf205d9088da4e422554257df936","modified":1559049553930},{"_id":"source/_posts/imgs/salt05.png","hash":"39d6666f7c6f67244822f8e9b3c19610913d09cb","modified":1559049553931},{"_id":"themes/next/layout/_custom/header.swig","hash":"adc83b19e793491b1c6ea0fd8b46cd9f32e592fc","modified":1514748788000},{"_id":"themes/next/layout/_custom/sidebar.swig","hash":"adc83b19e793491b1c6ea0fd8b46cd9f32e592fc","modified":1514748788000},{"_id":"themes/next/layout/_macro/my-copyright.swig","hash":"b6e335c7773b0af614a897b1cdd428d0d7f0d59e","modified":1555947276734},{"_id":"themes/next/layout/_macro/passage-end-tag.swig","hash":"f29b50d83bcdc9e70696b6a8a8917d8b2ad4be10","modified":1555935543509},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"31322a7f57936cf2dc62e824af5490da5354cf02","modified":1514748788000},{"_id":"themes/next/layout/_macro/reward.swig","hash":"56e8d8556cf474c56ae1bef9cb7bbd26554adb07","modified":1514748788000},{"_id":"themes/next/layout/_macro/post-copyright.swig","hash":"665a928604f99d2ba7dc4a4a9150178229568cc6","modified":1514748788000},{"_id":"themes/next/layout/_macro/post.swig","hash":"a2dce2d123e61bb99c1f98d9a4acbe465f992ff1","modified":1555947765151},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"39852700e4084ecccffa6d4669168e5cc0514c9e","modified":1514748788000},{"_id":"themes/next/layout/_partials/comments.swig","hash":"4a6f5b1792b2e5262b7fdab9a716b3108e2f09c7","modified":1514748788000},{"_id":"themes/next/layout/_partials/footer.swig","hash":"aa1ac4d03db4095709f95571dca47c30646dc34b","modified":1555939819838},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"6a54c3c85ff6b19d275827a327abbf4bd99b2ebf","modified":1514748788000},{"_id":"themes/next/layout/_partials/header.swig","hash":"ed042be6252848058c90109236ec988e392d91d4","modified":1514748788000},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"9e8e21d194ef44d271b1cca0bc1448c14d7edf4f","modified":1514748788000},{"_id":"themes/next/layout/_partials/search.swig","hash":"9dbd378e94abfcb3f864a5b8dbbf18d212ca2ee0","modified":1514748788000},{"_id":"themes/next/layout/_partials/head.swig","hash":"6b94fe8f3279daea5623c49ef4bb35917ba57510","modified":1514748788000},{"_id":"themes/next/layout/_partials/page-header.swig","hash":"1efd925d34a5d4ba2dc0838d9c86ba911e705fc9","modified":1514748788000},{"_id":"themes/next/layout/_third-party/copy-code.swig","hash":"c64e52f01d243e00190ed20c6dff33b1dfc950ad","modified":1556167993275},{"_id":"themes/next/layout/_third-party/exturl.swig","hash":"7c04a42319d728be356746363aff8ea247791d24","modified":1514748788000},{"_id":"themes/next/layout/_third-party/duoshuo-hot-articles.swig","hash":"5d4638c46aef65bf32a01681495b62416ccc98db","modified":1514748788000},{"_id":"themes/next/layout/_third-party/mathjax.swig","hash":"6d25596d6a7c57700d37b607f8d9a62d89708683","modified":1514748788000},{"_id":"themes/next/layout/_third-party/needsharebutton.swig","hash":"5fe0447cc88a5a63b530cf0426f93c4634811876","modified":1514748788000},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"fc93b1a7e6aed0dddb1f3910142b48d8ab61174e","modified":1514748788000},{"_id":"themes/next/layout/_third-party/schedule.swig","hash":"22369026c87fc23893c35a7f250b42f3bb1b60f1","modified":1514748788000},{"_id":"themes/next/layout/_third-party/scroll-cookie.swig","hash":"1ddb2336a1a19b47af3017047012c01ec5f54529","modified":1514748788000},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"03aaebe9d50f6acb007ec38cc04acd1cfceb404d","modified":1514748788000},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"766b2bdda29523ed6cd8d7aa197f996022f8fd94","modified":1514748788000},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"a266f96ad06ee87bdeae6e105a4b53cd587bbd04","modified":1514748788000},{"_id":"themes/next/scripts/tags/button.js","hash":"d023f10a00077f47082b0517e2ad666e6e994f60","modified":1514748788000},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"535fc542781021c4326dec24d8495cbb1387634a","modified":1514748788000},{"_id":"themes/next/scripts/tags/exturl.js","hash":"8d7e60f60779bde050d20fd76f6fdc36fc85e06d","modified":1514748788000},{"_id":"themes/next/scripts/tags/full-image.js","hash":"8eeb3fb89540299bdbb799edfdfdac3743b50596","modified":1514748788000},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"49252824cd53184dc9b97b2f2d87ff28e1b3ef27","modified":1514748788000},{"_id":"themes/next/scripts/tags/label.js","hash":"2f8f41a7316372f0d1ed6b51190dc4acd3e16fff","modified":1514748788000},{"_id":"themes/next/scripts/tags/lazy-image.js","hash":"eeeabede68cf263de9e6593ecf682f620da16f0a","modified":1514748788000},{"_id":"themes/next/scripts/tags/note.js","hash":"64de4e9d01cf3b491ffc7d53afdf148ee5ad9779","modified":1514748788000},{"_id":"themes/next/scripts/tags/tabs.js","hash":"5786545d51c38e8ca38d1bfc7dd9e946fc70a316","modified":1514748788000},{"_id":"themes/next/source/css/main.styl","hash":"20702c48d6053c92c5bcdbc68e8d0ef1369848a0","modified":1514748788000},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1514748788000},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1514748788000},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1514748788000},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1514748788000},{"_id":"themes/next/source/images/avatar.png","hash":"75dbfd5a1d3a64eb4fdd4dcc30127b243cead72c","modified":1558015543000},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1514748788000},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1514748788000},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1514748788000},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1514748788000},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1514748788000},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1514748788000},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1514748788000},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1514748788000},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1514748788000},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1514748788000},{"_id":"themes/next/source/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1514748788000},{"_id":"themes/next/source/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1514748788000},{"_id":"themes/next/source/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1514748788000},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1514748788000},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1514748788000},{"_id":"source/_posts/phpMyAdmin搭建/4.png","hash":"19c4b342d5c4a2d29e98611d7ddf4f2a9610d604","modified":1556262531412},{"_id":"themes/next/layout/_partials/head/custom-head.swig","hash":"9e1b9666efa77f4cf8d8261bcfa445a9ac608e53","modified":1514748788000},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"7ce76358411184482bb0934e70037949dd0da8ca","modified":1514748788000},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"957701729b85fb0c5bfcf2fb99c19d54582f91ed","modified":1514748788000},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"959b7e04a96a5596056e4009b73b6489c117597e","modified":1514748788000},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"eefe2388ff3d424694045eda21346989b123977c","modified":1514748788000},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"23e23dc0f76ef3c631f24c65277adf7ea517b383","modified":1514748788000},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"89c5a5240ecb223acfe1d12377df5562a943fd5d","modified":1514748788000},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"1f1107468aaf03f7d0dcd7eb2b653e2813a675b4","modified":1514748788000},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"048fd5e98149469f8c28c21ba3561a7a67952c9b","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/application-insights.swig","hash":"60426bf73f8a89ba61fb1be2df3ad5398e32c4ef","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/analytics-with-widget.swig","hash":"98df9d72e37dd071e882f2d5623c9d817815b139","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"deda6a814ed48debc694c4e0c466f06c127163d0","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/busuanzi-counter.swig","hash":"18e7bef8923d83ea42df6c97405e515a876cede4","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/cnzz-analytics.swig","hash":"8160b27bee0aa372c7dc7c8476c05bae57f58d0f","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/facebook-sdk.swig","hash":"a234c5cd1f75ca5731e814d0dbb92fdcf9240d1b","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/firestore.swig","hash":"1cd01c6e92ab1913d48e556a92bb4f28b6dc4996","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"5d9943d74cc2e0a91badcf4f755c6de77eab193a","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"5e9bb24c750b49513d9a65799e832f07410002ac","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/lean-analytics.swig","hash":"fc65b9c98a0a8ab43a5e7aabff6c5f03838e09c8","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/tencent-analytics.swig","hash":"3658414379e0e8a34c45c40feadc3edc8dc55f88","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/tencent-mta.swig","hash":"0ddc94ed4ba0c19627765fdf1abc4d8efbe53d5a","modified":1514748788000},{"_id":"themes/next/layout/_third-party/analytics/vkontakte-api.swig","hash":"c3971fd154d781088e1cc665035f8561a4098f4c","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"0e3378f7c39b2b0f69638290873ede6b6b6825c0","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"c316758546dc9ba6c60cb4d852c17ca6bb6d6724","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/duoshuo.swig","hash":"a356b2185d40914447fde817eb3d358ab6b3e4c3","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/gitment.swig","hash":"10160daceaa6f1ecf632323d422ebe2caae49ddf","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/hypercomments.swig","hash":"3e8dc5c6c912628a37e3b5f886bec7b2e5ed14ea","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/index.swig","hash":"aa0629277d751c55c6d973e7691bf84af9b17a60","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"8a2e393d2e49f7bf560766d8a07cd461bf3fce4f","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/youyan.swig","hash":"8b6650f77fe0a824c8075b2659e0403e0c78a705","modified":1514748788000},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"db61e9aba8d5d9d8df384c27a612b93d2b12742e","modified":1557753665172},{"_id":"themes/next/layout/_third-party/search/index.swig","hash":"c747fb5c6b1f500e8f0c583e44195878b66e4e29","modified":1514748788000},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"385c066af96bee30be2459dbec8aae1f15d382f5","modified":1514748788000},{"_id":"themes/next/layout/_third-party/search/tinysou.swig","hash":"cb3a5d36dbe1630bab84e03a52733a46df7c219b","modified":1514748788000},{"_id":"themes/next/layout/_third-party/seo/baidu-push.swig","hash":"c057b17f79e8261680fbae8dc4e81317a127c799","modified":1514748788000},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"069d1357c717572256e5cdee09574ebce529cbae","modified":1514748788000},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"a44acf9b0d0f44ef3dfc767376a95c984cc127de","modified":1514748788000},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a44acf9b0d0f44ef3dfc767376a95c984cc127de","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/Gemini.styl","hash":"2aa5b7166a85a8aa34b17792ae4f58a5a96df6cc","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"9ab65361ba0a12a986edd103e56492644c2db0b8","modified":1514748788000},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"82f9055955920ed88a2ab6a20ab02169abb2c634","modified":1514748788000},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"5395615efd23c7784dcdd87fb9b31dadc6fc061e","modified":1557926677516},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"be087dcc060e8179f7e7f60ab4feb65817bd3d9f","modified":1514748788000},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"99fbb4686ea9a3e03a4726ed7cf4d8f529034452","modified":1514748788000},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"f29165e36489a87ba32d17dddfd2720d84e3f3ec","modified":1514748788000},{"_id":"themes/next/source/css/_variables/base.styl","hash":"29c261fa6b4046322559074d75239c6b272fb8a3","modified":1514748788000},{"_id":"themes/next/source/images/avatar3.png","hash":"5b475bcde35a71d593059d4ca27d4c005bdfa180","modified":1558014485000},{"_id":"themes/next/source/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1514748788000},{"_id":"themes/next/source/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1514748788000},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"034bc8113e0966fe2096ba5b56061bbf10ef0512","modified":1514748788000},{"_id":"themes/next/source/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1514748788000},{"_id":"themes/next/source/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1514748788000},{"_id":"themes/next/source/js/src/js.cookie.js","hash":"9b37973a90fd50e71ea91682265715e45ae82c75","modified":1514748788000},{"_id":"themes/next/source/js/src/motion.js","hash":"754b294394f102c8fd9423a1789ddb1201677898","modified":1514748788000},{"_id":"themes/next/source/js/src/post-details.js","hash":"a13f45f7aa8291cf7244ec5ba93907d119c5dbdd","modified":1514748788000},{"_id":"themes/next/source/js/src/scroll-cookie.js","hash":"09dc828cbf5f31158ff6250d2bf7c3cde6365c67","modified":1514748788000},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1514748788000},{"_id":"themes/next/source/js/src/utils.js","hash":"9b1325801d27213083d1487a12b1a62b539ab6f8","modified":1514748788000},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1514748788000},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1514748788000},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","hash":"ff5915eb2596e890a2fc6697c864f861a1995ec0","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/.bower.json","hash":"cc40a9b11e52348e554c84e4a5c058056f6b7aeb","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/.gitattributes","hash":"2db21acfbd457452462f71cc4048a943ee61b8e0","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/.bower.json","hash":"93ebd5b35e632f714dcf1753e1f6db77ec74449b","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/LICENSE","hash":"dcd5b6b43095d9e90353a28b09cb269de8d4838e","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/README.md","hash":"1decd8e1adad2cd6db0ab50cf56de6035156f4ea","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/bower.json","hash":"13379463c7463b4b96d13556b46faa4cc38d81e6","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/.bower.json","hash":"a2aaaf12378db56bd10596ba3daae30950eac051","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/.npmignore","hash":"dcf470ab3a358103bb896a539cc03caeda10fa8b","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/.gitignore","hash":"69d152fa46b517141ec3b1114dd6134724494d83","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/bower.json","hash":"279a8a718ab6c930a67c41237f0aac166c1b9440","modified":1514748788000},{"_id":"themes/next/source/lib/jquery/.bower.json","hash":"91745c2cc6c946c7275f952b2b0760b880cea69e","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/.bower.json","hash":"b7638afc93e9cd350d0783565ee9a7da6805ad8e","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","hash":"4891864c24c28efecd81a6a8d3f261145190f901","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","hash":"895d50fa29759af7835256522e9dd7dac597765c","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","hash":"65bc85d12197e71c40a55c0cd7f6823995a05222","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1514748788000},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1514748788000},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.js","hash":"9885fd9bea5e7ebafc5b1de9d17be5e106248d96","modified":1514748788000},{"_id":"themes/next/source/lib/needsharebutton/font-embedded.css","hash":"c39d37278c1e178838732af21bd26cd0baeddfe0","modified":1514748788000},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.css","hash":"3ef0020a1815ca6151ea4886cd0d37421ae3695c","modified":1514748788000},{"_id":"themes/next/source/lib/pace/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1556202421981},{"_id":"themes/next/source/lib/pace/README.md","hash":"33b87ed998d59f117dc329f999a4ffc744b41e79","modified":1556202421981},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1556202421982},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1556202421982},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1556202421982},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1556202421983},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1556202421985},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1556202421985},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1556202421984},{"_id":"themes/next/source/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1556202421985},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","hash":"d8ea241a53c135a650f7335d2b6982b899fd58a9","modified":1514748788000},{"_id":"themes/next/source/lib/velocity/.bower.json","hash":"05f960846f1c7a93dab1d3f9a1121e86812e8c88","modified":1514748788000},{"_id":"themes/next/source/lib/velocity/bower.json","hash":"2ec99573e84c7117368beccb9e94b6bf35d2db03","modified":1514748788000},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","hash":"dce4a3b65f8bf958f973690caa7ec4952f353b0c","modified":1514748788000},{"_id":"themes/next/source/lib/three/three-waves.min.js","hash":"d968cba6b3a50b3626a02d67b544f349d83b147c","modified":1514748788000},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1514748788000},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","hash":"b4e960835d8700839e458e2cf7a3d7aed5b249ee","modified":1555861289608},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"d49abca8562d79c89ac7d323021f405d80721127","modified":1555861289601},{"_id":"themes/next/source/js/src/Valine.min.js","hash":"f3f7072297784338bc8dd8876df280355820fbf5","modified":1557751508334},{"_id":"themes/next/source/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1514748788000},{"_id":"themes/next/layout/_third-party/search/algolia-search/assets.swig","hash":"28ff4ed6714c59124569ffcbd10f1173d53ca923","modified":1514748788000},{"_id":"themes/next/layout/_third-party/search/algolia-search/dom.swig","hash":"ba698f49dd3a868c95b240d802f5b1b24ff287e4","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"4719ce717962663c5c33ef97b1119a0b3a4ecdc3","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"31050fc7a25784805b4843550151c93bfa55c9c8","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"7e509c7c28c59f905b847304dd3d14d94b6f3b8e","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"471f1627891aca5c0e1973e09fbcb01e1510d193","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"a6bb5256be6195e76addbda12f4ed7c662d65e7a","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"c5d48863f332ff8ce7c88dec2c893f709d7331d3","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"dd8a3b22fc2f222ac6e6c05bd8a773fb039169c0","modified":1514748788000},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"2186be20e317505cd31886f1291429cc21f76703","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"9c25c75311e1bd4d68df031d3f2ae6d141a90766","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"f7c44b0ee46cf2cf82a4c9455ba8d8b55299976f","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/mobile.styl","hash":"47a46583a1f3731157a3f53f80ed1ed5e2753e8e","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"ece571f38180febaf02ace8187ead8318a300ea7","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"a280a583b7615e939aaddbf778f5c108ef8a2a6c","modified":1514748788000},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"64f5d56c08d74a338813df1265580ca0cbf0190b","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"18c3336ee3d09bd2da6a876e1336539f03d5a973","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"c2d079788d6fc2e9a191ccdae94e50d55bf849dc","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"5ae7906dc7c1d9468c7f4b4a6feddddc555797a1","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"38e5df90c8689a71c978fd83ba74af3d4e4e5386","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"b0dcca862cd0cc6e732e33d975b476d744911742","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"98540f2bbc89f6cd806609da9ad42a1f73c01b28","modified":1556158705840},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"9a5581a770af8964064fef7afd3e16963e45547f","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"0efa036a15c18f5abb058b7c0fad1dd9ac5eed4c","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"8829bc556ca38bfec4add4f15a2f028092ac6d46","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"02fb8fa6b6c252b6bed469539cd057716606a787","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"a0e2030a606c934fb2c5c7373aaae04a1caac4c5","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"c4ed249798296f60bda02351fe6404fb3ef2126f","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"5b93958239d3d2bf9aeaede44eced2434d784462","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"215de948be49bcf14f06d500cef9f7035e406a43","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"2f878213cb24c5ddc18877f6d15ec5c5f57745ac","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"9d16fa3c14ed76b71229f022b63a02fd0f580958","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"69ecd6c97e7cdfd822ac8102b45ad0ede85050db","modified":1514748788000},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"8050a5b2683d1d77238c5762b6bd89c543daed6e","modified":1514748788000},{"_id":"themes/next/source/js/src/av-min.js","hash":"6097275a370ccb57eefb0e1949d3958fc0369983","modified":1557752242566},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/han.min.css","hash":"a0c9e32549a8b8cf327ab9227b037f323cdb60ee","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/han.min.js","hash":"f559c68a25065a14f47da954a7617d87263e409d","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1514748788000},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1514748788000},{"_id":"themes/next/source/lib/pace/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1556202421975},{"_id":"themes/next/source/lib/pace/.git/config","hash":"46d590e05dc25560a69d5cc71b337adad9654443","modified":1556202421977},{"_id":"themes/next/source/lib/pace/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1556202418158},{"_id":"themes/next/source/lib/pace/.git/index","hash":"f916936bb525ec0301660daa3f9c06252999005b","modified":1557584774948},{"_id":"themes/next/source/lib/pace/.git/packed-refs","hash":"a04f762b5ecb138fde3c5f6107d05494d8e4c905","modified":1556202421972},{"_id":"themes/next/source/lib/pace/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1556202421981},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1514748788000},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/han.css","hash":"bd40da3fba8735df5850956814e312bd7b3193d7","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d27448f199fc2f9980b601bc22b87f08b5d64dd1","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"7905a7f625702b45645d8be1268cb8af3f698c70","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"ae1ca14e51de67b07dba8f61ec79ee0e2e344574","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"8a2421cb9005352905fae9d41a847ae56957247e","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"49c2b2c14a1e7fcc810c6be4b632975d0204c281","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"6c00f6e0978f4d8f9a846a15579963728aaa6a17","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/highlight/diff.styl","hash":"96f32ea6c3265a3889e6abe57587f6e2a2a40dfb","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"25dc25f61a232f03ca72472b7852f882448ec185","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"b76387934fb6bb75212b23c1a194486892cc495e","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"f5aa2ba3bfffc15475e7e72a55b5c9d18609fdf5","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"4eff5b252d7b614e500fc7d52c97ce325e57d3ab","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"2039590632bba3943c39319d80ef630af7928185","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"9bf4362a4d0ae151ada84b219d39fbe5bb8c790e","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"a82afbb72d83ee394aedc7b37ac0008a9823b4f4","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/my-post-copyright.styl","hash":"1a510f995e665b28d85ba4d169b824276c40e4f3","modified":1555947304373},{"_id":"themes/next/source/css/_common/components/post/post-button.styl","hash":"e72a89e0f421444453e149ba32c77a64bd8e44e8","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"f54367c0feda6986c030cc4d15a0ca6ceea14bcb","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"2cdc094ecf907a02fce25ad4a607cd5c40da0f2b","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"535b3b4f8cb1eec2558e094320e7dfb01f94c0e7","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"0f7f522cc6bfb3401d5afd62b0fcdf48bb2d604b","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"aea21141015ca8c409d8b33e3e34ec505f464e93","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"387ce23bba52b22a586b2dfb4ec618fe1ffd3926","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"36332c8a91f089f545f3c3e8ea90d08aa4d6e60c","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"a5d8617a24d7cb6c5ad91ea621183ca2c0917331","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"017074ef58166e2d69c53bb7590a0e7a8947a1ed","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"a352ae5b1f8857393bf770d2e638bf15f0c9585d","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"10251257aceecb117233c9554dcf8ecfef8e2104","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"d5a4e4fc17f1f7e7c3a61b52d8e2e9677e139de7","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"e4055a0d2cd2b0ad9dc55928e2f3e7bd4e499da3","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"060c2602297128540d91c45f0bd307aa4a5f73e9","modified":1555946740712},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"0a6c0efffdf18bddbc1d1238feaed282b09cd0fe","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"f5e8fa6f6e632a2f87f09cf1a0bf069725be750b","modified":1555936921771},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"89dd4f8b1f1cce3ad46cf2256038472712387d02","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-dimmer.styl","hash":"efa5e5022e205b52786ce495d4879f5e7b8f84b2","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"9486ddd2cb255227db102d09a7df4cae0fabad72","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"45fa7193435a8eae9960267438750b4c9fa9587f","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"f7784aba0c1cd20d824c918c120012d57a5eaa2a","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"12937cae17c96c74d5c58db6cb29de3b2dfa14a2","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"50305b6ad7d09d2ffa4854e39f41ec1f4fe984fd","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"3623e7fa4324ec1307370f33d8f287a9e20a5578","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"c2abe4d87148e23e15d49ee225bc650de60baf46","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/exturl.styl","hash":"1b3cc9f4e5a7f6e05b4100e9990b37b20d4a2005","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"37e951e734a252fe8a81f452b963df2ba90bfe90","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"4851b981020c5cbc354a1af9b831a2dcb3cf9d39","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/label.styl","hash":"4a457d265d62f287c63d48764ce45d9bcfc9ec5a","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/note-modern.styl","hash":"ee7528900578ef4753effe05b346381c40de5499","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/tabs.styl","hash":"4ab5deed8c3b0c338212380f678f8382672e1bcb","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"ead0d0f2321dc71505788c7f689f92257cf14947","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/tags/note.styl","hash":"32c9156bea5bac9e9ad0b4c08ffbca8b3d9aac4b","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/algolia-search.styl","hash":"fd42777b9125fd8969dc39d4f15473e2b91b4142","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"93b08815c4d17e2b96fef8530ec1f1064dede6ef","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"d4e6d8d7b34dc69994593c208f875ae8f7e8a3ae","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/duoshuo.styl","hash":"2340dd9b3202c61d73cc708b790fac5adddbfc7f","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/gitment.styl","hash":"34935b40237c074be5f5e8818c14ccfd802b7439","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/han.styl","hash":"cce6772e2cdb4db85d35486ae4c6c59367fbdd40","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"327b5f63d55ec26f7663185c1a778440588d9803","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"d89c4b562b528e4746696b2ad8935764d133bdae","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/needsharebutton.styl","hash":"a5e3e6b4b4b814a9fe40b34d784fed67d6d977fa","modified":1514748788000},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"1ccfbd4d0f5754b2dc2719a91245c95f547a7652","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"5dc4859c66305f871e56cba78f64bfe3bf1b5f01","modified":1514748788000},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","hash":"07436f011b44051f61b8329c99de4bec64e86f4b","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","hash":"7a635062b10bf5662ae1d218ba0980171005d060","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","hash":"f1f6bb8f461f5672e000380195d3d2358a28494c","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","hash":"f38ff9b2eecaa17b50b66aa2dae87e9e7436d195","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/font/han.woff2","hash":"623af3ed5423371ac136a4fe0e8cc7bb7396037a","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1514748788000},{"_id":"themes/next/source/lib/Han/dist/han.js","hash":"e345397e0585c9fed1449e614ec13e0224acf2ab","modified":1514748788000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1514748788000},{"_id":"themes/next/source/lib/pace/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1556202418160},{"_id":"themes/next/source/lib/pace/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1556202418159},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/hooks/fsmonitor-watchman.sample","hash":"f7c0aa40cb0d620ff0bca3efe3521ec79e5d7156","modified":1556202418160},{"_id":"themes/next/source/lib/pace/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1556202418160},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1556202418162},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1556202418159},{"_id":"themes/next/source/lib/pace/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1556202418158},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1556202418161},{"_id":"themes/next/source/lib/pace/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1556202418162},{"_id":"themes/next/source/lib/pace/.git/logs/HEAD","hash":"a1e96ae1aa3f38847271435b43d48051e481f5a3","modified":1556202421976},{"_id":"themes/next/source/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1514748788000},{"_id":"themes/next/source/lib/pace/.git/objects/1c/159365320ef5dde63906912f3df067376b40d0","hash":"1dd6b7373c3f9c67e34aa319c9c08fd0f667156a","modified":1556202421962},{"_id":"themes/next/source/lib/pace/.git/objects/0c/dada082d621dbfdd00f7020c33dc751129167f","hash":"b490c11cdefde6b331a7d4ddb055e34ad08459d8","modified":1556202421952},{"_id":"themes/next/source/lib/pace/.git/objects/23/4f9b3e93f06a85cb2ec01acc872ccdc2bec7cb","hash":"63f8640eceff35a80175a102fcbd8789e690cfaa","modified":1556202421962},{"_id":"themes/next/source/lib/pace/.git/objects/35/a749d823ad0aae6111a76dc501a1170478f376","hash":"e757129fb6bca3170b62b05f3e850e4b55f3ae88","modified":1556202421961},{"_id":"themes/next/source/lib/pace/.git/objects/00/13175fe71888324d9142744034e8296501174a","hash":"0ad0e50f7fe91fe14491924aa4b1e2e8f060a5cd","modified":1556202421954},{"_id":"themes/next/source/lib/pace/.git/objects/2f/9eba51ec174b1e0c719d12cafa7c3c07140471","hash":"fc994d9d8b3b21ec7c941eea7e3862970e297e9b","modified":1556202421952},{"_id":"themes/next/source/lib/pace/.git/objects/3e/dcd352d2a1a60dbb6a43e7e9f00bab8b55791a","hash":"725bf5094855cd943dd1cd351906fb1ebec1d861","modified":1556202421955},{"_id":"themes/next/source/lib/pace/.git/objects/49/0db22b657dd64430d003fe2831905a54858b22","hash":"43694656c4c331cfa3667afca630bd486ac0d0fe","modified":1556202421959},{"_id":"themes/next/source/lib/pace/.git/objects/41/28e69301ad36a283c0fc523f3aef89644d2467","hash":"d8b985cf431fbdc5b4fa3be89e27db7a3437c920","modified":1556202421963},{"_id":"themes/next/source/lib/pace/.git/objects/61/fcbe3a99ad371eacdf3a3703883f8e95e072c8","hash":"480b60d684f9a077ade5dda0acfc75bcd9597aff","modified":1556202421951},{"_id":"themes/next/source/lib/pace/.git/objects/4d/fbb499a4f7b2f26a535c335cd66c966ff8b261","hash":"14e4cdcc137045c7efed32f796273d40c9fcef87","modified":1556202421960},{"_id":"themes/next/source/lib/pace/.git/objects/60/0378418401f2b0e7c58407a7bbc5a5196cfa51","hash":"20489d796247dda758599f40cbfcf14d194ef64a","modified":1556202421949},{"_id":"themes/next/source/lib/pace/.git/objects/53/3d55db0342c2b011ac05703c3b42e88a25c1ed","hash":"c48454760d2e04602a5499188b33d38839c58aee","modified":1556202421960},{"_id":"themes/next/source/lib/pace/.git/objects/82/8dcba3c8a21de08d1eb38f2eee453b51543188","hash":"629aad2ee2e564790e78cd46e99ad396544960ab","modified":1556202421956},{"_id":"themes/next/source/lib/pace/.git/objects/69/a20d65d83035fdb01734a8eabe3340f740a4cb","hash":"9e95b02d8e43ec92e06bee3f60dffb74e8e7b9fa","modified":1556202421953},{"_id":"themes/next/source/lib/pace/.git/objects/84/a17ac7b4fe9cea559de91f00af88f810bff7f1","hash":"b41b6d3cbccd75b711f0523bba1c26bf19b0a862","modified":1556202421948},{"_id":"themes/next/source/lib/pace/.git/objects/8b/b4535a79cc15127f8906b24c4e0bb4a38a5947","hash":"9c2d65a63f18929b09f3592dda064f24309ff98b","modified":1556202421957},{"_id":"themes/next/source/lib/pace/.git/objects/97/1e8a1f2ad6d45f693980c106af0aead9d1c215","hash":"e45f0963920a53a57f6b53d178e5b05a8e315189","modified":1556202421954},{"_id":"themes/next/source/lib/pace/.git/objects/9b/3058068409f2282607ebb91717d7a6a1406230","hash":"651c5857021e11dc397df86dbe0f01e6c7dc7f16","modified":1556202421958},{"_id":"themes/next/source/lib/pace/.git/objects/da/79363b808519d44a7eda67d7bc81e1587a06e8","hash":"0dc5dc27991da9a09d705e488bc3f1fe5a4d4728","modified":1556202421947},{"_id":"themes/next/source/lib/pace/.git/objects/aa/813c5a6398600e01b740696cd889eb3becad84","hash":"c62a1513ca820dc59fe1cd6d9ec16c92e0e2fbf0","modified":1556202421950},{"_id":"themes/next/source/lib/pace/.git/objects/a6/dbd9c99e726f621e2bdcd3c6fe2795a5d4272d","hash":"25350dd31f504af7206610ced355d162aabda8dd","modified":1556202421958},{"_id":"themes/next/source/lib/pace/.git/refs/heads/master","hash":"2cf353bc3f5e2816a3a0e05d3f154a777200f091","modified":1556202421976},{"_id":"themes/next/source/lib/pace/.git/objects/c0/05c71f1a000d8187df58083d215c962d7f5505","hash":"dffd212ca2ec705233fabe82a6f483d6be4b151d","modified":1556202421957},{"_id":"themes/next/source/lib/pace/.git/objects/de/79ab6539ac3702aaac64b879d95e6575f4eefa","hash":"0046fefd52ed4679e0fee757cc91ced94e3ddc12","modified":1556202421963},{"_id":"themes/next/source/lib/pace/.git/objects/f3/0e0a99bb016267bde55537dd47b3657ae59544","hash":"8bf0bc17a6111b6a82981073133f33cc8e815c41","modified":1556202421955},{"_id":"source/_posts/phpMyAdmin搭建/6.png","hash":"e5f1230ee77aeba32f983d3878be427212022f48","modified":1556263552536},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","hash":"9ccc6f8144f54e86df9a3fd33a18368d81cf3a4f","modified":1514748788000},{"_id":"themes/next/source/lib/pace/.git/logs/refs/heads/master","hash":"a1e96ae1aa3f38847271435b43d48051e481f5a3","modified":1556202421976},{"_id":"themes/next/source/lib/pace/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1556202421974},{"_id":"themes/next/source/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1514748788000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1514748788000},{"_id":"themes/next/source/lib/pace/.git/logs/refs/remotes/origin/HEAD","hash":"a1e96ae1aa3f38847271435b43d48051e481f5a3","modified":1556202421974},{"_id":"public/atom.xml","hash":"36cad0a423bc744a1449787ec4b63b4555c28bcc","modified":1559049581706},{"_id":"public/search.xml","hash":"cc8049a88cbeadad3d7b24e6631e488613346400","modified":1559049581706},{"_id":"public/categories/index.html","hash":"4be4dde41ae766bb5b97bbe794b61341ff865ac7","modified":1559049581726},{"_id":"public/photos/index.html","hash":"4b185c1e58386073a5cfdd36a32731a1e834b295","modified":1559049581726},{"_id":"public/tags/index.html","hash":"cc1a4a4bb5a8a71ae60016daae6fa724ad6abb52","modified":1559049581726},{"_id":"public/2019/05/28/saltstack远程执行/index.html","hash":"20384ff2c1136f7005e0f0e6a7c0d429bd4245f5","modified":1559049581726},{"_id":"public/2019/05/27/Ansible Ad-hoc常用Module/index.html","hash":"cb6c50a6ab1373417373cb01f3fc75ea5d63d08d","modified":1559049581726},{"_id":"public/2019/05/26/Ansible快速入门/index.html","hash":"f2365dfe50a2e8c2314a8469852ea6a3858dfe17","modified":1559049581726},{"_id":"public/2019/05/22/linux保存history到日志文件/index.html","hash":"a7e61a62dd983e7aafc0e6fa80dc61a0709c1d9a","modified":1559049581726},{"_id":"public/2019/05/21/saltstack项目实战/index.html","hash":"19522705e51564cf681ddbeb98a77849ba828721","modified":1559049581726},{"_id":"public/2019/05/20/saltstack接口salt-api/index.html","hash":"1da57cbb7dfb87de04b167df3373f07bc1a35a0f","modified":1559049581727},{"_id":"public/2019/05/20/saltstack使用salt-ssh/index.html","hash":"b0b6b9cadcc6f9029e0cc13602064c9073a28be3","modified":1559049581727},{"_id":"public/2019/05/17/saltstack数据系统/index.html","hash":"7471f5453ad4a25c33795b5edf43a5dce74af635","modified":1559049581727},{"_id":"public/2019/05/17/saltstack状态判断unless与onlyif/index.html","hash":"1593affe1419a35d67df4553e45be985801c555e","modified":1559049581727},{"_id":"public/2019/05/15/saltstack配置管理/index.html","hash":"10ba5dc63e925355a72d7e4ba5e8b6d1f8e113a1","modified":1559049581727},{"_id":"public/2019/05/13/saltstack基本入门/index.html","hash":"6e18cfe9df19d9db68df6e5262c76939e8447780","modified":1559049581727},{"_id":"public/2019/04/30/linux下解压windows上压缩rar包/index.html","hash":"d5ceecc97bc288fd2988e2eb8a29a01962c81ef6","modified":1559049581727},{"_id":"public/2019/04/26/phpRedisAdmin搭建/index.html","hash":"ad18a4fd7bc7d996bcb229e228c0ff0efbc668ac","modified":1559049581727},{"_id":"public/2019/04/26/phpMyAdmin搭建/index.html","hash":"df4fcea7086f68ddf73c7c5549869fbe1293b8e6","modified":1559049581727},{"_id":"public/2019/04/24/MySQL自动备份脚本/index.html","hash":"72d7975aa7ef0dd74b4330aecccef0cf5b4eb86f","modified":1559049581727},{"_id":"public/2019/04/23/ftp虚拟用户/index.html","hash":"4cfdb67eb046f208dde26769bd72fb2eabb7c609","modified":1559049581727},{"_id":"public/archives/index.html","hash":"71fcaf890677e50e4074dd393143fbf56f4e534a","modified":1559049581727},{"_id":"public/archives/page/2/index.html","hash":"1c25864ddea54c3ba86df57185f0178e836c53cc","modified":1559049581727},{"_id":"public/archives/2019/index.html","hash":"a400d7aeec6f92efe2ceb195983b14f5b407504b","modified":1559049581727},{"_id":"public/archives/2019/page/2/index.html","hash":"fd3bd4084248ffa070282ce6e5c9bbdf144c2c18","modified":1559049581728},{"_id":"public/archives/2019/04/index.html","hash":"dc3730d80ff3154d89d63af195900b2d1c614631","modified":1559049581728},{"_id":"public/archives/2019/05/index.html","hash":"e8bf5efb18b3f5b26450410f8b145f115ba061be","modified":1559049581728},{"_id":"public/archives/2019/05/page/2/index.html","hash":"630d88f869b0c4da6296a4eef6bc83d44b1afa08","modified":1559049581728},{"_id":"public/categories/Shell/index.html","hash":"72bc8aa89570a18c05e5c101a59351933bbf6118","modified":1559049581728},{"_id":"public/categories/Linux/index.html","hash":"ca96344ef916b4b67d5328328ef959aae94398ca","modified":1559049581728},{"_id":"public/categories/Linux运维日常/index.html","hash":"2003f29a0d80847ab7e8a53d3e53e1f58053a25c","modified":1559049581728},{"_id":"public/categories/Saltstack/index.html","hash":"b9274c5052aceb988a6d8125fd78dd73cb35ae19","modified":1559049581728},{"_id":"public/categories/Ansible/index.html","hash":"17027eceba50f0c967fc43c8083b301ea569a7a0","modified":1559049581728},{"_id":"public/index.html","hash":"4cf811e385cf3d53b58066d24b7800a4c3019ce0","modified":1559049581728},{"_id":"public/page/2/index.html","hash":"766cc3f1f3bb62e0e38d135816d97e9d6d4d75d8","modified":1559049581728},{"_id":"public/tags/Linux运维日常/index.html","hash":"f2dda31871e0751fc7835364247b2f6a1eeffff7","modified":1559049581728},{"_id":"public/tags/Saltstack/index.html","hash":"3eb07d906c1dc212e6853901c47e2db9404f103d","modified":1559049581728},{"_id":"public/tags/Ansible/index.html","hash":"ae63810cb37367d02bcdfb0e690a3c2a1f1dc2dc","modified":1559049581728},{"_id":"public/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1559049581733},{"_id":"public/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1559049581733},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1559049581734},{"_id":"public/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1559049581734},{"_id":"public/images/avatar.png","hash":"75dbfd5a1d3a64eb4fdd4dcc30127b243cead72c","modified":1559049581734},{"_id":"public/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1559049581734},{"_id":"public/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1559049581734},{"_id":"public/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1559049581734},{"_id":"public/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1559049581734},{"_id":"public/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1559049581734},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1559049581734},{"_id":"public/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1559049581734},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1559049581734},{"_id":"public/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1559049581734},{"_id":"public/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1559049581734},{"_id":"public/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1559049581734},{"_id":"public/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1559049581734},{"_id":"public/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1559049581734},{"_id":"public/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1559049581734},{"_id":"public/lib/fastclick/LICENSE","hash":"dcd5b6b43095d9e90353a28b09cb269de8d4838e","modified":1559049581734},{"_id":"public/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1559049581734},{"_id":"public/lib/pace/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1559049581734},{"_id":"public/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1559049581734},{"_id":"public/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1559049581734},{"_id":"public/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1559049581734},{"_id":"public/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1559049581734},{"_id":"public/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1559049581734},{"_id":"public/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1559049581734},{"_id":"public/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1559049581735},{"_id":"public/lib/Han/dist/font/han-space.otf","hash":"07436f011b44051f61b8329c99de4bec64e86f4b","modified":1559049581735},{"_id":"public/lib/Han/dist/font/han-space.woff","hash":"7a635062b10bf5662ae1d218ba0980171005d060","modified":1559049581735},{"_id":"public/lib/Han/dist/font/han.woff2","hash":"623af3ed5423371ac136a4fe0e8cc7bb7396037a","modified":1559049581735},{"_id":"public/lib/Han/dist/font/han.otf","hash":"f1f6bb8f461f5672e000380195d3d2358a28494c","modified":1559049581735},{"_id":"public/lib/Han/dist/font/han.woff","hash":"f38ff9b2eecaa17b50b66aa2dae87e9e7436d195","modified":1559049581735},{"_id":"public/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1559049581735},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1559049582115},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1559049582121},{"_id":"public/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1559049582128},{"_id":"public/js/src/bootstrap.js","hash":"034bc8113e0966fe2096ba5b56061bbf10ef0512","modified":1559049582128},{"_id":"public/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1559049582128},{"_id":"public/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1559049582128},{"_id":"public/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1559049582128},{"_id":"public/js/src/js.cookie.js","hash":"9b37973a90fd50e71ea91682265715e45ae82c75","modified":1559049582128},{"_id":"public/js/src/scroll-cookie.js","hash":"09dc828cbf5f31158ff6250d2bf7c3cde6365c67","modified":1559049582128},{"_id":"public/js/src/post-details.js","hash":"a13f45f7aa8291cf7244ec5ba93907d119c5dbdd","modified":1559049582128},{"_id":"public/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1559049582128},{"_id":"public/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1559049582128},{"_id":"public/lib/canvas-ribbon/canvas-ribbon.js","hash":"ff5915eb2596e890a2fc6697c864f861a1995ec0","modified":1559049582128},{"_id":"public/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1559049582128},{"_id":"public/lib/fastclick/bower.json","hash":"4dcecf83afddba148464d5339c93f6d0aa9f42e9","modified":1559049582128},{"_id":"public/lib/font-awesome/bower.json","hash":"64394a2a9aa00f8e321d8daa5e51a420f0e96dad","modified":1559049582128},{"_id":"public/lib/jquery_lazyload/bower.json","hash":"ae3c3b61e6e7f9e1d7e3585ad854380ecc04cf53","modified":1559049582129},{"_id":"public/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1559049582129},{"_id":"public/lib/needsharebutton/needsharebutton.css","hash":"3ef0020a1815ca6151ea4886cd0d37421ae3695c","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1559049582129},{"_id":"public/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1559049582129},{"_id":"public/lib/velocity/bower.json","hash":"0ef14e7ccdfba5db6eb3f8fc6aa3b47282c36409","modified":1559049582129},{"_id":"public/js/src/schemes/pisces.js","hash":"8050a5b2683d1d77238c5762b6bd89c543daed6e","modified":1559049582129},{"_id":"public/lib/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1559049582129},{"_id":"public/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1559049582129},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1559049582130},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1559049582130},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1559049582130},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1559049582130},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1559049582130},{"_id":"public/lib/fastclick/README.html","hash":"da3c74d484c73cc7df565e8abbfa4d6a5a18d4da","modified":1559049582130},{"_id":"public/lib/jquery_lazyload/CONTRIBUTING.html","hash":"a6358170d346af13b1452ac157b60505bec7015c","modified":1559049582130},{"_id":"public/lib/jquery_lazyload/README.html","hash":"bde24335f6bc09d8801c0dcd7274f71b466552bd","modified":1559049582130},{"_id":"public/lib/pace/README.html","hash":"58f2105ada5cc52dff5aabcecb92569ee84493a0","modified":1559049582130},{"_id":"public/css/main.css","hash":"399876ba3b134fb342a7abb3255be5e17d52cde5","modified":1559049582130},{"_id":"public/images/avatar3.png","hash":"5b475bcde35a71d593059d4ca27d4c005bdfa180","modified":1559049582130},{"_id":"public/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1559049582130},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1559049582130},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1559049582130},{"_id":"public/2019/04/26/phpMyAdmin搭建/4.png","hash":"19c4b342d5c4a2d29e98611d7ddf4f2a9610d604","modified":1559049582131},{"_id":"public/js/src/motion.js","hash":"754b294394f102c8fd9423a1789ddb1201677898","modified":1559049582134},{"_id":"public/js/src/utils.js","hash":"9b1325801d27213083d1487a12b1a62b539ab6f8","modified":1559049582134},{"_id":"public/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1559049582134},{"_id":"public/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1559049582134},{"_id":"public/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1559049582135},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"d49abca8562d79c89ac7d323021f405d80721127","modified":1559049582135},{"_id":"public/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1559049582135},{"_id":"public/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1559049582135},{"_id":"public/lib/needsharebutton/needsharebutton.js","hash":"9885fd9bea5e7ebafc5b1de9d17be5e106248d96","modified":1559049582138},{"_id":"public/lib/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1559049582139},{"_id":"public/lib/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1559049582143},{"_id":"public/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1559049582143},{"_id":"public/lib/three/canvas_sphere.min.js","hash":"d8ea241a53c135a650f7335d2b6982b899fd58a9","modified":1559049582149},{"_id":"public/lib/three/canvas_lines.min.js","hash":"dce4a3b65f8bf958f973690caa7ec4952f353b0c","modified":1559049582149},{"_id":"public/lib/three/three-waves.min.js","hash":"d968cba6b3a50b3626a02d67b544f349d83b147c","modified":1559049582150},{"_id":"public/lib/velocity/velocity.ui.js","hash":"b4e960835d8700839e458e2cf7a3d7aed5b249ee","modified":1559049582150},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1559049582150},{"_id":"public/lib/Han/dist/han.min.js","hash":"f559c68a25065a14f47da954a7617d87263e409d","modified":1559049582150},{"_id":"public/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1559049582150},{"_id":"public/lib/needsharebutton/font-embedded.css","hash":"c39d37278c1e178838732af21bd26cd0baeddfe0","modified":1559049582154},{"_id":"public/lib/Han/dist/han.min.css","hash":"a0c9e32549a8b8cf327ab9227b037f323cdb60ee","modified":1559049582154},{"_id":"public/lib/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1559049582155},{"_id":"public/lib/Han/dist/han.css","hash":"bd40da3fba8735df5850956814e312bd7b3193d7","modified":1559049582159},{"_id":"public/2019/04/26/phpMyAdmin搭建/6.png","hash":"e5f1230ee77aeba32f983d3878be427212022f48","modified":1559049582160},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1559049582163},{"_id":"public/js/src/Valine.min.js","hash":"f3f7072297784338bc8dd8876df280355820fbf5","modified":1559049582169},{"_id":"public/lib/Han/dist/han.js","hash":"e345397e0585c9fed1449e614ec13e0224acf2ab","modified":1559049582169},{"_id":"public/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1559049582171},{"_id":"public/js/src/av-min.js","hash":"6097275a370ccb57eefb0e1949d3958fc0369983","modified":1559049582174},{"_id":"public/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1559049582176},{"_id":"public/lib/algolia-instant-search/instantsearch.min.js","hash":"9ccc6f8144f54e86df9a3fd33a18368d81cf3a4f","modified":1559049582184},{"_id":"public/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1559049582187}],"Category":[{"name":"Shell","_id":"cjw7tv4h10002m834nnfgyznc"},{"name":"Linux","_id":"cjw7tv4h60007m834u0so38rx"},{"name":"Linux运维日常","_id":"cjw7tv4ha000fm834nwpnixyf"},{"name":"Saltstack","_id":"cjw7tv4hh000qm834nq8dr4q6"},{"name":"Ansible","_id":"cjw7tv4l90010m8348686vmk5"}],"Data":[],"Page":[{"title":"分类","date":"2019-04-22T12:36:46.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\ndate: 2019-04-22 20:36:46\ntype: \"categories\"\n---\n","updated":"2019-04-25T02:36:12.750Z","path":"categories/index.html","comments":1,"layout":"page","_id":"cjw7tv4l6000xm834cfiscj20","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"photos","date":"2019-04-22T16:36:22.000Z","type":"photos","_content":"","source":"photos/index.md","raw":"---\ntitle: photos\ndate: 2019-04-23 00:36:22\ntype: photos\n---\n","updated":"2019-04-22T16:38:15.074Z","path":"photos/index.html","comments":1,"layout":"page","_id":"cjw7tv4l8000zm834o3tzin6i","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"标签","date":"2019-04-22T11:56:18.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\ndate: 2019-04-22 19:56:18\ntype: \"tags\"\n---\n","updated":"2019-04-25T02:36:12.755Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cjw7tv4la0013m834nnm4ggrq","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"MySQL自动备份脚本","date":"2019-04-24T09:56:56.000Z","copyright":true,"_content":">通过 shell 脚本定时备份数据库，并定时清理\n\n```html\n#!/bin/bash\n#Desc:本地数据库备份脚本\n#Date:2017-12-24\n#by:Lee-YJ\n#运行脚本前先创建一个备份用户，并授予权限\n#mysql> grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";\n#mysql> flush privileges;\n\nmysqluser=back                    #用于数据库备份的用户名\nmysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码\nmysqlhost=127.0.0.1               #连接数据库的host\nbakpath=/opt/data/Back/DBbak          #备份数据库存放的路径\n\nbakdate=`date '+%Y%m%d'`\nbaktime=`date '+%H%M'`\n\n#----------------------------获取mysql中的数据库名---------------------------------\n/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test > /tmp/DBname\n\n#----------------------------数据库备份--mysqldump备份------------------------------\n\nif [ ! -d \"$bakpath\" ];then\n    mkdir -p $bakpath\nfi\n\ncd $bakpath\n\nif [ ! -d \"$bakdate\" ];then\n    mkdir $bakdate\nfi\n\ncd $bakdate\n\necho \"------------------------$bakdate$baktime-------------------------------------\" >> $bakpath/DBbak.log\nfor DBname in `cat /tmp/DBname`;do\n    if [ ! -d \"$DBname\" ];then\n        mkdir $DBname\n    fi\n    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  > $DBname/$baktime\\.sql\n    if [ $? = 0 ];then\n        echo \"$DBname Back OK!\" >> $bakpath/DBbak.log\n    else\n        echo \"$DBname Back ERROR!\" >> $bakpath/DBbak.log\n    fi\ndone\necho \"\" >> $bakpath/DBbak.log \n\n\n#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------\nshopt -s extglob\nolddate=`date '+%Y%m%d' -d \"-6 days\"`\ncd $bakpath/$olddate\nfor deldbname in `ls $bakpath/$olddate`;do\n    cd $deldbname\n    file=`ls| sort -R | head -n1`\n    rm -f !($file)\ndone\n\nif [ ! -d \"$bakpath/Oldest\" ];then\n    mkdir -p $bakpath/Oldest\nfi\n\nmv $bakpath/$olddate $bakpath/Oldest/\n\nrm -f /tmp/DBname\n\n\n\n```\n\n","source":"_posts/MySQL自动备份脚本.md","raw":"---\ntitle: MySQL自动备份脚本\ndate: 2019-04-24 17:56:56\ntags: Linux运维日常\ncategories: Shell\ncopyright: true\n---\n>通过 shell 脚本定时备份数据库，并定时清理\n\n```html\n#!/bin/bash\n#Desc:本地数据库备份脚本\n#Date:2017-12-24\n#by:Lee-YJ\n#运行脚本前先创建一个备份用户，并授予权限\n#mysql> grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";\n#mysql> flush privileges;\n\nmysqluser=back                    #用于数据库备份的用户名\nmysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码\nmysqlhost=127.0.0.1               #连接数据库的host\nbakpath=/opt/data/Back/DBbak          #备份数据库存放的路径\n\nbakdate=`date '+%Y%m%d'`\nbaktime=`date '+%H%M'`\n\n#----------------------------获取mysql中的数据库名---------------------------------\n/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test > /tmp/DBname\n\n#----------------------------数据库备份--mysqldump备份------------------------------\n\nif [ ! -d \"$bakpath\" ];then\n    mkdir -p $bakpath\nfi\n\ncd $bakpath\n\nif [ ! -d \"$bakdate\" ];then\n    mkdir $bakdate\nfi\n\ncd $bakdate\n\necho \"------------------------$bakdate$baktime-------------------------------------\" >> $bakpath/DBbak.log\nfor DBname in `cat /tmp/DBname`;do\n    if [ ! -d \"$DBname\" ];then\n        mkdir $DBname\n    fi\n    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  > $DBname/$baktime\\.sql\n    if [ $? = 0 ];then\n        echo \"$DBname Back OK!\" >> $bakpath/DBbak.log\n    else\n        echo \"$DBname Back ERROR!\" >> $bakpath/DBbak.log\n    fi\ndone\necho \"\" >> $bakpath/DBbak.log \n\n\n#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------\nshopt -s extglob\nolddate=`date '+%Y%m%d' -d \"-6 days\"`\ncd $bakpath/$olddate\nfor deldbname in `ls $bakpath/$olddate`;do\n    cd $deldbname\n    file=`ls| sort -R | head -n1`\n    rm -f !($file)\ndone\n\nif [ ! -d \"$bakpath/Oldest\" ];then\n    mkdir -p $bakpath/Oldest\nfi\n\nmv $bakpath/$olddate $bakpath/Oldest/\n\nrm -f /tmp/DBname\n\n\n\n```\n\n","slug":"MySQL自动备份脚本","published":1,"updated":"2019-05-17T13:23:21.438Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4gw0000m834osow5vqu","content":"<blockquote>\n<p>通过 shell 脚本定时备份数据库，并定时清理</p>\n</blockquote>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">#Desc:本地数据库备份脚本</span><br><span class=\"line\">#Date:2017-12-24</span><br><span class=\"line\">#by:Lee-YJ</span><br><span class=\"line\">#运行脚本前先创建一个备份用户，并授予权限</span><br><span class=\"line\">#mysql&gt; grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";</span><br><span class=\"line\">#mysql&gt; flush privileges;</span><br><span class=\"line\"></span><br><span class=\"line\">mysqluser=back                    #用于数据库备份的用户名</span><br><span class=\"line\">mysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码</span><br><span class=\"line\">mysqlhost=127.0.0.1               #连接数据库的host</span><br><span class=\"line\">bakpath=/opt/data/Back/DBbak          #备份数据库存放的路径</span><br><span class=\"line\"></span><br><span class=\"line\">bakdate=`date '+%Y%m%d'`</span><br><span class=\"line\">baktime=`date '+%H%M'`</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------获取mysql中的数据库名---------------------------------</span><br><span class=\"line\">/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test &gt; /tmp/DBname</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------数据库备份--mysqldump备份------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakpath</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakdate\" ];then</span><br><span class=\"line\">    mkdir $bakdate</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakdate</span><br><span class=\"line\"></span><br><span class=\"line\">echo \"------------------------$bakdate$baktime-------------------------------------\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">for DBname in `cat /tmp/DBname`;do</span><br><span class=\"line\">    if [ ! -d \"$DBname\" ];then</span><br><span class=\"line\">        mkdir $DBname</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  &gt; $DBname/$baktime\\.sql</span><br><span class=\"line\">    if [ $? = 0 ];then</span><br><span class=\"line\">        echo \"$DBname Back OK!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"$DBname Back ERROR!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    fi</span><br><span class=\"line\">done</span><br><span class=\"line\">echo \"\" &gt;&gt; $bakpath/DBbak.log </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------</span><br><span class=\"line\">shopt -s extglob</span><br><span class=\"line\">olddate=`date '+%Y%m%d' -d \"-6 days\"`</span><br><span class=\"line\">cd $bakpath/$olddate</span><br><span class=\"line\">for deldbname in `ls $bakpath/$olddate`;do</span><br><span class=\"line\">    cd $deldbname</span><br><span class=\"line\">    file=`ls| sort -R | head -n1`</span><br><span class=\"line\">    rm -f !($file)</span><br><span class=\"line\">done</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath/Oldest\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath/Oldest</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">mv $bakpath/$olddate $bakpath/Oldest/</span><br><span class=\"line\"></span><br><span class=\"line\">rm -f /tmp/DBname</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>通过 shell 脚本定时备份数据库，并定时清理</p>\n</blockquote>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">#Desc:本地数据库备份脚本</span><br><span class=\"line\">#Date:2017-12-24</span><br><span class=\"line\">#by:Lee-YJ</span><br><span class=\"line\">#运行脚本前先创建一个备份用户，并授予权限</span><br><span class=\"line\">#mysql&gt; grant select,insert,lock tables,show view,trigger  on *.* to back@\"127.0.0.1\" identified by \"oodaeh7phoe1iboh7Jua\";</span><br><span class=\"line\">#mysql&gt; flush privileges;</span><br><span class=\"line\"></span><br><span class=\"line\">mysqluser=back                    #用于数据库备份的用户名</span><br><span class=\"line\">mysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码</span><br><span class=\"line\">mysqlhost=127.0.0.1               #连接数据库的host</span><br><span class=\"line\">bakpath=/opt/data/Back/DBbak          #备份数据库存放的路径</span><br><span class=\"line\"></span><br><span class=\"line\">bakdate=`date '+%Y%m%d'`</span><br><span class=\"line\">baktime=`date '+%H%M'`</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------获取mysql中的数据库名---------------------------------</span><br><span class=\"line\">/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e \"show databases;\"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test &gt; /tmp/DBname</span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------数据库备份--mysqldump备份------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakpath</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakdate\" ];then</span><br><span class=\"line\">    mkdir $bakdate</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $bakdate</span><br><span class=\"line\"></span><br><span class=\"line\">echo \"------------------------$bakdate$baktime-------------------------------------\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">for DBname in `cat /tmp/DBname`;do</span><br><span class=\"line\">    if [ ! -d \"$DBname\" ];then</span><br><span class=\"line\">        mkdir $DBname</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  &gt; $DBname/$baktime\\.sql</span><br><span class=\"line\">    if [ $? = 0 ];then</span><br><span class=\"line\">        echo \"$DBname Back OK!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"$DBname Back ERROR!\" &gt;&gt; $bakpath/DBbak.log</span><br><span class=\"line\">    fi</span><br><span class=\"line\">done</span><br><span class=\"line\">echo \"\" &gt;&gt; $bakpath/DBbak.log </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------</span><br><span class=\"line\">shopt -s extglob</span><br><span class=\"line\">olddate=`date '+%Y%m%d' -d \"-6 days\"`</span><br><span class=\"line\">cd $bakpath/$olddate</span><br><span class=\"line\">for deldbname in `ls $bakpath/$olddate`;do</span><br><span class=\"line\">    cd $deldbname</span><br><span class=\"line\">    file=`ls| sort -R | head -n1`</span><br><span class=\"line\">    rm -f !($file)</span><br><span class=\"line\">done</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -d \"$bakpath/Oldest\" ];then</span><br><span class=\"line\">    mkdir -p $bakpath/Oldest</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">mv $bakpath/$olddate $bakpath/Oldest/</span><br><span class=\"line\"></span><br><span class=\"line\">rm -f /tmp/DBname</span><br></pre></td></tr></table></figure>\n"},{"title":"ftp虚拟用户","date":"2019-04-23T14:30:00.000Z","copyright":true,"_content":"### 需求：\n进（账户）\\\nusername: ftpComeSsbq\\\npassword: ftp_come_#@UkieO9\\\n上传文件的目录：/opt/ftp/come\n\n出（账户）\\\nusername: ftpOutSsbq\\\npassword: ftp_out_#@45oUkie\\\n上床文件的目录：/opt/ftp/out\n\n### 具体步骤\n\n1 安装软件\n```\n# yum -y install vsftpd\n```\n2 创建相应的ftp数据目录\n```\n# mkdir -p /opt/ftp/{come,out}\n```\n3 创建一个用户提供给虚拟用户使用\n```\n# useradd -s /sbin/nologin virtual\n```\n4 将ftp数据目录设置成virtual用户\n```\n# chown virtual. /opt/ftp/ -R\n# ll /opt/ftp/\ntotal 8\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 come\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 out\n```\n5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)\n```\n# vim /etc/vsftpd/logins.txt\nftpComeSsbq\nftp_come_#@UkieO9\nftpOutSsbq\nftp_out_#@45oUkie\n```\n6 将创建好的密码文件txt格式转换db格式\n```\n# db_load -T -t hash -f /etc/vsftpd/logins.txt /etc/vsftpd/login.db\n```\n7 定义db文件的权限\n```\n# chmod 600 /etc/vsftpd/login.db\n```\n8 定义pam认证文件\n```\n# vim /etc/pam.d/ftp\nauth  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\naccount  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\n```\n9 配置vsftpd主配置文件\n```\n# cp /etc/vsftpd/vsftpd.conf{,.bak}\n# vim /etc/vsftpd/vsftpd.conf\n#禁止匿名登录FTP服务器\nanonymous_enable=NO\n#允许本地用户登录FTP服务器\nlocal_enable=YES\n#可以上传(全局控制) \nwrite_enable=NO\n#匿名用户可以上传\nanon_upload_enable=NO\n#匿名用户可以建目录\nanon_mkdir_write_enable=NO\n#匿名用户修改删除\nanon_other_write_enable=NO\n#全部用户被限制在主目录\nchroot_local_user=YES\n#将所有用户看成虚拟用户guest\nguest_enable=YES\n#指定虚拟用户，也就是将guest用户映射到virtual用户\nguest_username=virtual\n#指定为独立服务\nlisten=YES\n#指定监听的端口\nlisten_port=21\n#开启被动模式\npasv_enable=YES\n#FTP服务器公网IP\npasv_address=120.79.93.66\n#设置被动模式下，建立数据传输可使用port范围的最小值\npasv_min_port=10000\n#设置被动模式下，建立数据传输可使用port范围的最大值\npasv_max_port=10088\n#是否允许匿名用户下载全局可读的文件\nanon_world_readable_only=NO\n#指定虚拟用户配置文件的路径\nuser_config_dir=/etc/vsftpd/user_conf\n```\n10 创建上面配置文件中指定的子配置文件目录 user_conf\n```\n# mkdir /etc/vsftpd/user_conf\n```\n11 定义 ftpComeSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpComeSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/come\n```\n12 定义 ftpOutSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpOutSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/out\n```\n13 启动vsftpd\n```\n# service vsftpd start\n```\n14 测试\n...\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/ftp虚拟用户.md","raw":"---\ntitle: ftp虚拟用户\ndate: 2019-04-23 22:30:00\ntags: Linux运维日常\ncategories: Linux\ncopyright: true\n---\n### 需求：\n进（账户）\\\nusername: ftpComeSsbq\\\npassword: ftp_come_#@UkieO9\\\n上传文件的目录：/opt/ftp/come\n\n出（账户）\\\nusername: ftpOutSsbq\\\npassword: ftp_out_#@45oUkie\\\n上床文件的目录：/opt/ftp/out\n\n### 具体步骤\n\n1 安装软件\n```\n# yum -y install vsftpd\n```\n2 创建相应的ftp数据目录\n```\n# mkdir -p /opt/ftp/{come,out}\n```\n3 创建一个用户提供给虚拟用户使用\n```\n# useradd -s /sbin/nologin virtual\n```\n4 将ftp数据目录设置成virtual用户\n```\n# chown virtual. /opt/ftp/ -R\n# ll /opt/ftp/\ntotal 8\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 come\ndrwxr-xr-x 2 virtual virtual 4096 Apr 17 12:07 out\n```\n5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)\n```\n# vim /etc/vsftpd/logins.txt\nftpComeSsbq\nftp_come_#@UkieO9\nftpOutSsbq\nftp_out_#@45oUkie\n```\n6 将创建好的密码文件txt格式转换db格式\n```\n# db_load -T -t hash -f /etc/vsftpd/logins.txt /etc/vsftpd/login.db\n```\n7 定义db文件的权限\n```\n# chmod 600 /etc/vsftpd/login.db\n```\n8 定义pam认证文件\n```\n# vim /etc/pam.d/ftp\nauth  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\naccount  required  /lib64/security/pam_userdb.so  db=/etc/vsftpd/login\n```\n9 配置vsftpd主配置文件\n```\n# cp /etc/vsftpd/vsftpd.conf{,.bak}\n# vim /etc/vsftpd/vsftpd.conf\n#禁止匿名登录FTP服务器\nanonymous_enable=NO\n#允许本地用户登录FTP服务器\nlocal_enable=YES\n#可以上传(全局控制) \nwrite_enable=NO\n#匿名用户可以上传\nanon_upload_enable=NO\n#匿名用户可以建目录\nanon_mkdir_write_enable=NO\n#匿名用户修改删除\nanon_other_write_enable=NO\n#全部用户被限制在主目录\nchroot_local_user=YES\n#将所有用户看成虚拟用户guest\nguest_enable=YES\n#指定虚拟用户，也就是将guest用户映射到virtual用户\nguest_username=virtual\n#指定为独立服务\nlisten=YES\n#指定监听的端口\nlisten_port=21\n#开启被动模式\npasv_enable=YES\n#FTP服务器公网IP\npasv_address=120.79.93.66\n#设置被动模式下，建立数据传输可使用port范围的最小值\npasv_min_port=10000\n#设置被动模式下，建立数据传输可使用port范围的最大值\npasv_max_port=10088\n#是否允许匿名用户下载全局可读的文件\nanon_world_readable_only=NO\n#指定虚拟用户配置文件的路径\nuser_config_dir=/etc/vsftpd/user_conf\n```\n10 创建上面配置文件中指定的子配置文件目录 user_conf\n```\n# mkdir /etc/vsftpd/user_conf\n```\n11 定义 ftpComeSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpComeSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/come\n```\n12 定义 ftpOutSsbq 用户的配置文件\n```\n# vim /etc/vsftpd/user_conf/ftpOutSsbq\nwrite_enable=YES\nanon_world_readable_only=no\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\nlocal_root=/opt/ftp/out\n```\n13 启动vsftpd\n```\n# service vsftpd start\n```\n14 测试\n...\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","slug":"ftp虚拟用户","published":1,"updated":"2019-04-23T14:37:22.762Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4h00001m834c2zgpj8v","content":"<h3 id=\"需求：\"><a href=\"#需求：\" class=\"headerlink\" title=\"需求：\"></a>需求：</h3><p>进（账户）\\<br>username: ftpComeSsbq\\<br>password: ftp<em>come</em>#@UkieO9\\<br>上传文件的目录：/opt/ftp/come</p>\n<p>出（账户）\\<br>username: ftpOutSsbq\\<br>password: ftp<em>out</em>#@45oUkie\\<br>上床文件的目录：/opt/ftp/out</p>\n<h3 id=\"具体步骤\"><a href=\"#具体步骤\" class=\"headerlink\" title=\"具体步骤\"></a>具体步骤</h3><p>1 安装软件<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install vsftpd</span></span><br></pre></td></tr></table></figure></p>\n<p>2 创建相应的ftp数据目录<br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># <span class=\"keyword\">mkdir</span> -p /opt/ftp/&#123;come,<span class=\"keyword\">out</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3 创建一个用户提供给虚拟用户使用<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># useradd -s /sbin/nologin virtual</span></span><br></pre></td></tr></table></figure></p>\n<p>4 将ftp数据目录设置成virtual用户<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># chown virtual. /opt/ftp/ -R</span></span><br><span class=\"line\"><span class=\"comment\"># ll /opt/ftp/</span></span><br><span class=\"line\">total 8</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 come</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 out</span><br></pre></td></tr></table></figure></p>\n<p>5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/logins.txt</span></span><br><span class=\"line\">ftpComeSsbq</span><br><span class=\"line\">ftp_come<span class=\"number\">_</span><span class=\"comment\">#<span class=\"doctag\">@UkieO</span>9</span></span><br><span class=\"line\">ftpOutSsbq</span><br><span class=\"line\">ftp_out<span class=\"number\">_</span><span class=\"comment\">#@45oUkie</span></span><br></pre></td></tr></table></figure></p>\n<p>6 将创建好的密码文件txt格式转换db格式<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># db_load -T -t hash -f <span class=\"regexp\">/etc/</span>vsftpd<span class=\"regexp\">/logins.txt /</span>etc<span class=\"regexp\">/vsftpd/</span>login.db</span><br></pre></td></tr></table></figure></p>\n<p>7 定义db文件的权限<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># chmod 600 /etc/vsftpd/login.db</span></span><br></pre></td></tr></table></figure></p>\n<p>8 定义pam认证文件<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/pam.d/ftp</span></span><br><span class=\"line\">auth  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br><span class=\"line\">account  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br></pre></td></tr></table></figure></p>\n<p>9 配置vsftpd主配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cp /etc/vsftpd/vsftpd.conf&#123;,.bak&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/vsftpd.conf</span></span><br><span class=\"line\"><span class=\"comment\">#禁止匿名登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">anonymous_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#允许本地用户登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">local_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#可以上传(全局控制) </span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以上传</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以建目录</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户修改删除</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#全部用户被限制在主目录</span></span><br><span class=\"line\"><span class=\"attr\">chroot_local_user</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#将所有用户看成虚拟用户guest</span></span><br><span class=\"line\"><span class=\"attr\">guest_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户，也就是将guest用户映射到virtual用户</span></span><br><span class=\"line\"><span class=\"attr\">guest_username</span>=virtual</span><br><span class=\"line\"><span class=\"comment\">#指定为独立服务</span></span><br><span class=\"line\"><span class=\"attr\">listen</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定监听的端口</span></span><br><span class=\"line\"><span class=\"attr\">listen_port</span>=<span class=\"number\">21</span></span><br><span class=\"line\"><span class=\"comment\">#开启被动模式</span></span><br><span class=\"line\"><span class=\"attr\">pasv_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#FTP服务器公网IP</span></span><br><span class=\"line\"><span class=\"attr\">pasv_address</span>=<span class=\"number\">120.79</span>.<span class=\"number\">93.66</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最小值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_min_port</span>=<span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最大值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_max_port</span>=<span class=\"number\">10088</span></span><br><span class=\"line\"><span class=\"comment\">#是否允许匿名用户下载全局可读的文件</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户配置文件的路径</span></span><br><span class=\"line\"><span class=\"attr\">user_config_dir</span>=/etc/vsftpd/user_conf</span><br></pre></td></tr></table></figure></p>\n<p>10 创建上面配置文件中指定的子配置文件目录 user_conf<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># mkdir /etc/vsftpd/user_conf</span></span><br></pre></td></tr></table></figure></p>\n<p>11 定义 ftpComeSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpComeSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/come</span><br></pre></td></tr></table></figure></p>\n<p>12 定义 ftpOutSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpOutSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/out</span><br></pre></td></tr></table></figure></p>\n<p>13 启动vsftpd<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># service vsftpd start</span></span><br></pre></td></tr></table></figure></p>\n<p>14 测试<br>…</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"需求：\"><a href=\"#需求：\" class=\"headerlink\" title=\"需求：\"></a>需求：</h3><p>进（账户）\\<br>username: ftpComeSsbq\\<br>password: ftp<em>come</em>#@UkieO9\\<br>上传文件的目录：/opt/ftp/come</p>\n<p>出（账户）\\<br>username: ftpOutSsbq\\<br>password: ftp<em>out</em>#@45oUkie\\<br>上床文件的目录：/opt/ftp/out</p>\n<h3 id=\"具体步骤\"><a href=\"#具体步骤\" class=\"headerlink\" title=\"具体步骤\"></a>具体步骤</h3><p>1 安装软件<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install vsftpd</span></span><br></pre></td></tr></table></figure></p>\n<p>2 创建相应的ftp数据目录<br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># <span class=\"keyword\">mkdir</span> -p /opt/ftp/&#123;come,<span class=\"keyword\">out</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3 创建一个用户提供给虚拟用户使用<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># useradd -s /sbin/nologin virtual</span></span><br></pre></td></tr></table></figure></p>\n<p>4 将ftp数据目录设置成virtual用户<br><figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># chown virtual. /opt/ftp/ -R</span></span><br><span class=\"line\"><span class=\"comment\"># ll /opt/ftp/</span></span><br><span class=\"line\">total 8</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 come</span><br><span class=\"line\">drwxr-xr-x<span class=\"number\"> 2 </span>virtual virtual<span class=\"number\"> 4096 </span>Apr<span class=\"number\"> 17 </span>12:07 out</span><br></pre></td></tr></table></figure></p>\n<p>5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/logins.txt</span></span><br><span class=\"line\">ftpComeSsbq</span><br><span class=\"line\">ftp_come<span class=\"number\">_</span><span class=\"comment\">#<span class=\"doctag\">@UkieO</span>9</span></span><br><span class=\"line\">ftpOutSsbq</span><br><span class=\"line\">ftp_out<span class=\"number\">_</span><span class=\"comment\">#@45oUkie</span></span><br></pre></td></tr></table></figure></p>\n<p>6 将创建好的密码文件txt格式转换db格式<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># db_load -T -t hash -f <span class=\"regexp\">/etc/</span>vsftpd<span class=\"regexp\">/logins.txt /</span>etc<span class=\"regexp\">/vsftpd/</span>login.db</span><br></pre></td></tr></table></figure></p>\n<p>7 定义db文件的权限<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># chmod 600 /etc/vsftpd/login.db</span></span><br></pre></td></tr></table></figure></p>\n<p>8 定义pam认证文件<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/pam.d/ftp</span></span><br><span class=\"line\">auth  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br><span class=\"line\">account  required  <span class=\"regexp\">/lib64/</span>security<span class=\"regexp\">/pam_userdb.so  db=/</span>etc<span class=\"regexp\">/vsftpd/</span>login</span><br></pre></td></tr></table></figure></p>\n<p>9 配置vsftpd主配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cp /etc/vsftpd/vsftpd.conf&#123;,.bak&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/vsftpd.conf</span></span><br><span class=\"line\"><span class=\"comment\">#禁止匿名登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">anonymous_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#允许本地用户登录FTP服务器</span></span><br><span class=\"line\"><span class=\"attr\">local_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#可以上传(全局控制) </span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以上传</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户可以建目录</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#匿名用户修改删除</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#全部用户被限制在主目录</span></span><br><span class=\"line\"><span class=\"attr\">chroot_local_user</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#将所有用户看成虚拟用户guest</span></span><br><span class=\"line\"><span class=\"attr\">guest_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户，也就是将guest用户映射到virtual用户</span></span><br><span class=\"line\"><span class=\"attr\">guest_username</span>=virtual</span><br><span class=\"line\"><span class=\"comment\">#指定为独立服务</span></span><br><span class=\"line\"><span class=\"attr\">listen</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#指定监听的端口</span></span><br><span class=\"line\"><span class=\"attr\">listen_port</span>=<span class=\"number\">21</span></span><br><span class=\"line\"><span class=\"comment\">#开启被动模式</span></span><br><span class=\"line\"><span class=\"attr\">pasv_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"comment\">#FTP服务器公网IP</span></span><br><span class=\"line\"><span class=\"attr\">pasv_address</span>=<span class=\"number\">120.79</span>.<span class=\"number\">93.66</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最小值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_min_port</span>=<span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"comment\">#设置被动模式下，建立数据传输可使用port范围的最大值</span></span><br><span class=\"line\"><span class=\"attr\">pasv_max_port</span>=<span class=\"number\">10088</span></span><br><span class=\"line\"><span class=\"comment\">#是否允许匿名用户下载全局可读的文件</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">NO</span></span><br><span class=\"line\"><span class=\"comment\">#指定虚拟用户配置文件的路径</span></span><br><span class=\"line\"><span class=\"attr\">user_config_dir</span>=/etc/vsftpd/user_conf</span><br></pre></td></tr></table></figure></p>\n<p>10 创建上面配置文件中指定的子配置文件目录 user_conf<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># mkdir /etc/vsftpd/user_conf</span></span><br></pre></td></tr></table></figure></p>\n<p>11 定义 ftpComeSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpComeSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/come</span><br></pre></td></tr></table></figure></p>\n<p>12 定义 ftpOutSsbq 用户的配置文件<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/vsftpd/user_conf/ftpOutSsbq</span></span><br><span class=\"line\"><span class=\"attr\">write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_world_readable_only</span>=<span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">anon_other_write_enable</span>=<span class=\"literal\">YES</span></span><br><span class=\"line\"><span class=\"attr\">local_root</span>=/opt/ftp/out</span><br></pre></td></tr></table></figure></p>\n<p>13 启动vsftpd<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># service vsftpd start</span></span><br></pre></td></tr></table></figure></p>\n<p>14 测试<br>…</p>\n"},{"title":"linux保存history到日志文件","date":"2019-05-22T08:30:09.000Z","copyright":true,"_content":">在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑`/etc/bashrc`文件记录历史命令到日志文件下面，并已登录来源`IP`，登录用户名，登录时间命名日志文件名字\n\n##### 查看默认的history\n![默认的history](https://upload-images.jianshu.io/upload_images/11763553-a2f73d6c0783224d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n##### 编辑/etc/bashrc\n编辑`/etc/bashrc`文件，加入以下内容，也可以放在`/etc/profile`文件里\n```\n# vim /etc/bashrc\nUSER_IP=$(echo -e \"\\033[31m\\033[1m`who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g'`\\033[0m\")\nIP=$(who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g')\nUSER=$(whoami)\nUSER_NAME=`echo -e \"\\033[36m\\033[1m$(whoami) \\033[0m\"`\nHISTFILESIZE=100000\nHISTSIZE=4096\nHISTTIMEFORMAT=\"%F %T  $USER_IP  $USER_NAME  \"\nif [ \"$USER_IP\" = \"\" ]\nthen\n   USER_IP=`hostname`\nfi\n\nif [ ! -d /var/log/history ]\nthen\n   mkdir /var/log/history\n   chmod 777 /var/log/history\nfi\n\nif [ ! -d /var/log/history/${LOGNAME} ]\nthen\n    mkdir /var/log/history/${LOGNAME}\n    chmod 300 /var/log/history/${LOGNAME}\nfi\nDT=`date \"+%Y%m%d_%H%M\"`\nexport HISTFILE=\"/var/log/history/${LOGNAME}/${DT}_${USER}_${IP}\"\nchmod 600 /var/log/history/${LOGNAME}/* 2>/dev/null\n```\n退出重新登录再次查看\n![](https://upload-images.jianshu.io/upload_images/11763553-dad4faed53395912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n查看前面保留的历史记录日志\n```\n[root@salt-master ~]# ll /var/log/history/\n总用量 0\nd-wx------. 2 root root 6 5月  22 14:27 root\n\n[root@salt-master ~]# ll /var/log/history/root/\n总用量 4\n-rw-------. 1 root root 123 5月  22 14:29 20190522_1427_root_192.168.1.123\n\n[root@salt-master ~]# cat /var/log/history/root/20190522_1427_root_192.168.1.123 \n#1558506461\nls\n#1558506467\nhistory\n#1558506519\nll /var/log/history/\n#1558506571\nll /var/log/history/root/\n#1558506574\nexit\n```","source":"_posts/linux保存history到日志文件.md","raw":"---\ntitle: linux保存history到日志文件\ndate: 2019-05-22 16:30:09\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n>在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑`/etc/bashrc`文件记录历史命令到日志文件下面，并已登录来源`IP`，登录用户名，登录时间命名日志文件名字\n\n##### 查看默认的history\n![默认的history](https://upload-images.jianshu.io/upload_images/11763553-a2f73d6c0783224d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n##### 编辑/etc/bashrc\n编辑`/etc/bashrc`文件，加入以下内容，也可以放在`/etc/profile`文件里\n```\n# vim /etc/bashrc\nUSER_IP=$(echo -e \"\\033[31m\\033[1m`who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g'`\\033[0m\")\nIP=$(who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g')\nUSER=$(whoami)\nUSER_NAME=`echo -e \"\\033[36m\\033[1m$(whoami) \\033[0m\"`\nHISTFILESIZE=100000\nHISTSIZE=4096\nHISTTIMEFORMAT=\"%F %T  $USER_IP  $USER_NAME  \"\nif [ \"$USER_IP\" = \"\" ]\nthen\n   USER_IP=`hostname`\nfi\n\nif [ ! -d /var/log/history ]\nthen\n   mkdir /var/log/history\n   chmod 777 /var/log/history\nfi\n\nif [ ! -d /var/log/history/${LOGNAME} ]\nthen\n    mkdir /var/log/history/${LOGNAME}\n    chmod 300 /var/log/history/${LOGNAME}\nfi\nDT=`date \"+%Y%m%d_%H%M\"`\nexport HISTFILE=\"/var/log/history/${LOGNAME}/${DT}_${USER}_${IP}\"\nchmod 600 /var/log/history/${LOGNAME}/* 2>/dev/null\n```\n退出重新登录再次查看\n![](https://upload-images.jianshu.io/upload_images/11763553-dad4faed53395912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n查看前面保留的历史记录日志\n```\n[root@salt-master ~]# ll /var/log/history/\n总用量 0\nd-wx------. 2 root root 6 5月  22 14:27 root\n\n[root@salt-master ~]# ll /var/log/history/root/\n总用量 4\n-rw-------. 1 root root 123 5月  22 14:29 20190522_1427_root_192.168.1.123\n\n[root@salt-master ~]# cat /var/log/history/root/20190522_1427_root_192.168.1.123 \n#1558506461\nls\n#1558506467\nhistory\n#1558506519\nll /var/log/history/\n#1558506571\nll /var/log/history/root/\n#1558506574\nexit\n```","slug":"linux保存history到日志文件","published":1,"updated":"2019-05-22T13:07:59.030Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4h30004m834o7msvchn","content":"<blockquote>\n<p>在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑<code>/etc/bashrc</code>文件记录历史命令到日志文件下面，并已登录来源<code>IP</code>，登录用户名，登录时间命名日志文件名字</p>\n</blockquote>\n<h5 id=\"查看默认的history\"><a href=\"#查看默认的history\" class=\"headerlink\" title=\"查看默认的history\"></a>查看默认的history</h5><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-a2f73d6c0783224d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"默认的history\"></p>\n<h5 id=\"编辑-etc-bashrc\"><a href=\"#编辑-etc-bashrc\" class=\"headerlink\" title=\"编辑/etc/bashrc\"></a>编辑/etc/bashrc</h5><p>编辑<code>/etc/bashrc</code>文件，加入以下内容，也可以放在<code>/etc/profile</code>文件里<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/bashrc</span></span><br><span class=\"line\">USER_IP=$(<span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\033[31m\\033[1m`who -u am i 2&gt;/dev/null| awk '&#123;print <span class=\"variable\">$NF</span>&#125;'|sed -e 's/[()]//g'`\\033[0m\"</span>)</span><br><span class=\"line\">IP=$(who -u am i 2&gt;/dev/null| awk <span class=\"string\">'&#123;print $NF&#125;'</span>|sed -e <span class=\"string\">'s/[()]//g'</span>)</span><br><span class=\"line\">USER=$(whoami)</span><br><span class=\"line\">USER_NAME=`<span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\033[36m\\033[1m<span class=\"variable\">$(whoami)</span> \\033[0m\"</span>`</span><br><span class=\"line\">HISTFILESIZE=100000</span><br><span class=\"line\">HISTSIZE=4096</span><br><span class=\"line\">HISTTIMEFORMAT=<span class=\"string\">\"%F %T  <span class=\"variable\">$USER_IP</span>  <span class=\"variable\">$USER_NAME</span>  \"</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$USER_IP</span>\"</span> = <span class=\"string\">\"\"</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">   USER_IP=`hostname`</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ ! -d /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">   mkdir /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span></span><br><span class=\"line\">   chmod 777 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ ! -d /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">    mkdir /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span></span><br><span class=\"line\">    chmod 300 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">DT=`date <span class=\"string\">\"+%Y%m%d_%H%M\"</span>`</span><br><span class=\"line\"><span class=\"built_in\">export</span> HISTFILE=<span class=\"string\">\"/var/log/history/<span class=\"variable\">$&#123;LOGNAME&#125;</span>/<span class=\"variable\">$&#123;DT&#125;</span>_<span class=\"variable\">$&#123;USER&#125;</span>_<span class=\"variable\">$&#123;IP&#125;</span>\"</span></span><br><span class=\"line\">chmod 600 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span>/* 2&gt;/dev/null</span><br></pre></td></tr></table></figure></p>\n<p>退出重新登录再次查看<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-dad4faed53395912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt><br>查看前面保留的历史记录日志<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/</span><br><span class=\"line\">总用量 <span class=\"number\">0</span></span><br><span class=\"line\">d-wx------. <span class=\"number\">2</span> root root <span class=\"number\">6</span> <span class=\"number\">5</span>月  <span class=\"number\">22</span> <span class=\"number\">14</span>:<span class=\"number\">27</span> root</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/</span><br><span class=\"line\">总用量 <span class=\"number\">4</span></span><br><span class=\"line\">-rw-------. <span class=\"number\">1</span> root root <span class=\"number\">123</span> <span class=\"number\">5</span>月  <span class=\"number\">22</span> <span class=\"number\">14</span>:<span class=\"number\">29</span> <span class=\"number\">20190522</span>_1427_root_192.<span class=\"number\">168.1</span>.<span class=\"number\">123</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/<span class=\"number\">20190522</span>_1427_root_192.<span class=\"number\">168.1</span>.<span class=\"number\">123</span> </span><br><span class=\"line\">#<span class=\"number\">1558506461</span></span><br><span class=\"line\"><span class=\"keyword\">ls</span></span><br><span class=\"line\">#<span class=\"number\">1558506467</span></span><br><span class=\"line\"><span class=\"keyword\">history</span></span><br><span class=\"line\">#<span class=\"number\">1558506519</span></span><br><span class=\"line\"><span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/</span><br><span class=\"line\">#<span class=\"number\">1558506571</span></span><br><span class=\"line\"><span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/</span><br><span class=\"line\">#<span class=\"number\">1558506574</span></span><br><span class=\"line\"><span class=\"keyword\">exit</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑<code>/etc/bashrc</code>文件记录历史命令到日志文件下面，并已登录来源<code>IP</code>，登录用户名，登录时间命名日志文件名字</p>\n</blockquote>\n<h5 id=\"查看默认的history\"><a href=\"#查看默认的history\" class=\"headerlink\" title=\"查看默认的history\"></a>查看默认的history</h5><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-a2f73d6c0783224d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"默认的history\"></p>\n<h5 id=\"编辑-etc-bashrc\"><a href=\"#编辑-etc-bashrc\" class=\"headerlink\" title=\"编辑/etc/bashrc\"></a>编辑/etc/bashrc</h5><p>编辑<code>/etc/bashrc</code>文件，加入以下内容，也可以放在<code>/etc/profile</code>文件里<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/bashrc</span></span><br><span class=\"line\">USER_IP=$(<span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\033[31m\\033[1m`who -u am i 2&gt;/dev/null| awk '&#123;print <span class=\"variable\">$NF</span>&#125;'|sed -e 's/[()]//g'`\\033[0m\"</span>)</span><br><span class=\"line\">IP=$(who -u am i 2&gt;/dev/null| awk <span class=\"string\">'&#123;print $NF&#125;'</span>|sed -e <span class=\"string\">'s/[()]//g'</span>)</span><br><span class=\"line\">USER=$(whoami)</span><br><span class=\"line\">USER_NAME=`<span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\033[36m\\033[1m<span class=\"variable\">$(whoami)</span> \\033[0m\"</span>`</span><br><span class=\"line\">HISTFILESIZE=100000</span><br><span class=\"line\">HISTSIZE=4096</span><br><span class=\"line\">HISTTIMEFORMAT=<span class=\"string\">\"%F %T  <span class=\"variable\">$USER_IP</span>  <span class=\"variable\">$USER_NAME</span>  \"</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$USER_IP</span>\"</span> = <span class=\"string\">\"\"</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">   USER_IP=`hostname`</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ ! -d /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">   mkdir /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span></span><br><span class=\"line\">   chmod 777 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ ! -d /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">    mkdir /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span></span><br><span class=\"line\">    chmod 300 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">DT=`date <span class=\"string\">\"+%Y%m%d_%H%M\"</span>`</span><br><span class=\"line\"><span class=\"built_in\">export</span> HISTFILE=<span class=\"string\">\"/var/log/history/<span class=\"variable\">$&#123;LOGNAME&#125;</span>/<span class=\"variable\">$&#123;DT&#125;</span>_<span class=\"variable\">$&#123;USER&#125;</span>_<span class=\"variable\">$&#123;IP&#125;</span>\"</span></span><br><span class=\"line\">chmod 600 /var/<span class=\"built_in\">log</span>/<span class=\"built_in\">history</span>/<span class=\"variable\">$&#123;LOGNAME&#125;</span>/* 2&gt;/dev/null</span><br></pre></td></tr></table></figure></p>\n<p>退出重新登录再次查看<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-dad4faed53395912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt><br>查看前面保留的历史记录日志<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/</span><br><span class=\"line\">总用量 <span class=\"number\">0</span></span><br><span class=\"line\">d-wx------. <span class=\"number\">2</span> root root <span class=\"number\">6</span> <span class=\"number\">5</span>月  <span class=\"number\">22</span> <span class=\"number\">14</span>:<span class=\"number\">27</span> root</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/</span><br><span class=\"line\">总用量 <span class=\"number\">4</span></span><br><span class=\"line\">-rw-------. <span class=\"number\">1</span> root root <span class=\"number\">123</span> <span class=\"number\">5</span>月  <span class=\"number\">22</span> <span class=\"number\">14</span>:<span class=\"number\">29</span> <span class=\"number\">20190522</span>_1427_root_192.<span class=\"number\">168.1</span>.<span class=\"number\">123</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/<span class=\"number\">20190522</span>_1427_root_192.<span class=\"number\">168.1</span>.<span class=\"number\">123</span> </span><br><span class=\"line\">#<span class=\"number\">1558506461</span></span><br><span class=\"line\"><span class=\"keyword\">ls</span></span><br><span class=\"line\">#<span class=\"number\">1558506467</span></span><br><span class=\"line\"><span class=\"keyword\">history</span></span><br><span class=\"line\">#<span class=\"number\">1558506519</span></span><br><span class=\"line\"><span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/</span><br><span class=\"line\">#<span class=\"number\">1558506571</span></span><br><span class=\"line\"><span class=\"keyword\">ll</span> /var/<span class=\"built_in\">log</span>/<span class=\"keyword\">history</span>/root/</span><br><span class=\"line\">#<span class=\"number\">1558506574</span></span><br><span class=\"line\"><span class=\"keyword\">exit</span></span><br></pre></td></tr></table></figure></p>\n"},{"title":"linux下解压windows上压缩rar包","date":"2019-04-30T05:48:55.000Z","copyright":true,"_content":"##### 下载\n``# wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz``\n##### 安装\n```\n# tar xvzf rarlinux-3.8.0.tar.gz\n# cd rar\n# make \n# make install\n```\n##### rar命令语法\n将 /etc 目录压缩为 etc.rar 命令为：\\\n``# rar a etc.rar /etc``\\\n将 etc.rar 解压 命令为：\\\n```\nrar x etc.rar\nunrar -e etc.rar\n```\n##### rar帮助手册\n```markdown\n# rar\n\nRAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008\nShareware version         Type RAR -? for help\n\nUsage:     rar <command> -<switch 1> -<switch N> <archive> <files...>\n               <@listfiles...> <path_to_extract\\>\n\n<Commands>\n  a             Add files to archive\n  c             Add archive comment\n  cf            Add files comment\n  ch            Change archive parameters\n  cw            Write archive comment to file\n  d             Delete files from archive\n  e             Extract files to current directory\n  f             Freshen files in archive\n  i[par]=<str>  Find string in archives\n  k             Lock archive\n  l[t,b]        List archive [technical, bare]\n  m[f]          Move to archive [files only]\n  p             Print file to stdout\n  r             Repair archive\n  rc            Reconstruct missing volumes\n  rn            Rename archived files\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[name|-]     Convert archive to or from SFX\n  t             Test archive files\n  u             Update files in archive\n  v[t,b]        Verbosely list archive [technical,bare]\n  x             Extract files with full path\n\n<Switches>\n  -             Stop switches scanning\n  ad            Append archive name to destination path\n  ag[format]    Generate archive name using the current date\n  ap<path>      Set path inside archive\n  as            Synchronize archive contents\n  av            Put authenticity verification (registered versions only)\n  av-           Disable authenticity verification check\n  c-            Disable comments show\n  cfg-          Disable read configuration\n  cl            Convert names to lower case\n  cu            Convert names to upper case\n  df            Delete files after archiving\n  dh            Open shared files\n  ds            Disable name sort for solid archive\n  dw            Wipe files after archiving\n  e[+]<attr>    Set file exclude and include attributes\n  ed            Do not add empty directories\n  en            Do not put 'end of archive' block\n  ep            Exclude paths from names\n  ep1           Exclude base directory from names\n  ep3           Expand paths to full including the drive letter\n  f             Freshen files\n  hp[password]  Encrypt both file data and headers\n  id[c,d,p,q]   Disable messages\n  ierr          Send all messages to stderr\n  ilog[name]    Log errors to file (registered versions only)\n  inul          Disable all messages\n  isnd          Enable sound\n  k             Lock archive\n  kb            Keep broken extracted files\n  m<0..5>       Set compression level (0-store...3-default...5-maximal)\n  mc<par>       Set advanced compression parameters\n  md<size>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)\n  ms[ext;ext]   Specify file types to store\n  n<file>       Include only specified file\n  n@            Read file names to include from stdin\n  n@<list>      Include files in specified list file\n  o[+|-]        Set the overwrite mode\n  ol            Save symbolic links as the link instead of the file\n  or            Rename files automatically\n  ow            Save or restore file owner and group\n  p[password]   Set password\n  p-            Do not query password\n  r             Recurse subdirectories\n  r0            Recurse subdirectories for wildcard names only\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[<N>,v[-],e] Create solid archive\n  s-            Disable solid archiving\n  sc<chr>[obj]  Specify the character set\n  sfx[name]     Create SFX archive\n  si[name]      Read data from standard input (stdin)\n  sl<size>      Process files with size less than specified\n  sm<size>      Process files with size more than specified\n  t             Test files after archiving\n  ta<date>      Process files modified after <date> in YYYYMMDDHHMMSS format\n  tb<date>      Process files modified before <date> in YYYYMMDDHHMMSS format\n  tk            Keep original archive time\n  tl            Set archive time to latest file\n  tn<time>      Process files newer than <time>\n  to<time>      Process files older than <time>\n  ts<m,c,a>[N]  Save or restore file time (modification, creation, access)\n  u             Update files\n  v             Create volumes with size autodetection or list all volumes\n  v<size>[k,b]  Create volumes with size=<size>*1000 [*1024, *1]\n  ver[n]        File version control\n  vn            Use the old style volume naming scheme\n  vp            Pause before each volume\n  w<path>       Assign work directory\n  x<file>       Exclude specified file\n  x@            Read file names to exclude from stdin\n  x@<list>      Exclude files in specified list file\n  y             Assume Yes on all queries\n  z[file]       Read archive comment from file\n```","source":"_posts/linux下解压windows上压缩rar包.md","raw":"---\ntitle: linux下解压windows上压缩rar包\ndate: 2019-04-30 13:48:55\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n##### 下载\n``# wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz``\n##### 安装\n```\n# tar xvzf rarlinux-3.8.0.tar.gz\n# cd rar\n# make \n# make install\n```\n##### rar命令语法\n将 /etc 目录压缩为 etc.rar 命令为：\\\n``# rar a etc.rar /etc``\\\n将 etc.rar 解压 命令为：\\\n```\nrar x etc.rar\nunrar -e etc.rar\n```\n##### rar帮助手册\n```markdown\n# rar\n\nRAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008\nShareware version         Type RAR -? for help\n\nUsage:     rar <command> -<switch 1> -<switch N> <archive> <files...>\n               <@listfiles...> <path_to_extract\\>\n\n<Commands>\n  a             Add files to archive\n  c             Add archive comment\n  cf            Add files comment\n  ch            Change archive parameters\n  cw            Write archive comment to file\n  d             Delete files from archive\n  e             Extract files to current directory\n  f             Freshen files in archive\n  i[par]=<str>  Find string in archives\n  k             Lock archive\n  l[t,b]        List archive [technical, bare]\n  m[f]          Move to archive [files only]\n  p             Print file to stdout\n  r             Repair archive\n  rc            Reconstruct missing volumes\n  rn            Rename archived files\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[name|-]     Convert archive to or from SFX\n  t             Test archive files\n  u             Update files in archive\n  v[t,b]        Verbosely list archive [technical,bare]\n  x             Extract files with full path\n\n<Switches>\n  -             Stop switches scanning\n  ad            Append archive name to destination path\n  ag[format]    Generate archive name using the current date\n  ap<path>      Set path inside archive\n  as            Synchronize archive contents\n  av            Put authenticity verification (registered versions only)\n  av-           Disable authenticity verification check\n  c-            Disable comments show\n  cfg-          Disable read configuration\n  cl            Convert names to lower case\n  cu            Convert names to upper case\n  df            Delete files after archiving\n  dh            Open shared files\n  ds            Disable name sort for solid archive\n  dw            Wipe files after archiving\n  e[+]<attr>    Set file exclude and include attributes\n  ed            Do not add empty directories\n  en            Do not put 'end of archive' block\n  ep            Exclude paths from names\n  ep1           Exclude base directory from names\n  ep3           Expand paths to full including the drive letter\n  f             Freshen files\n  hp[password]  Encrypt both file data and headers\n  id[c,d,p,q]   Disable messages\n  ierr          Send all messages to stderr\n  ilog[name]    Log errors to file (registered versions only)\n  inul          Disable all messages\n  isnd          Enable sound\n  k             Lock archive\n  kb            Keep broken extracted files\n  m<0..5>       Set compression level (0-store...3-default...5-maximal)\n  mc<par>       Set advanced compression parameters\n  md<size>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)\n  ms[ext;ext]   Specify file types to store\n  n<file>       Include only specified file\n  n@            Read file names to include from stdin\n  n@<list>      Include files in specified list file\n  o[+|-]        Set the overwrite mode\n  ol            Save symbolic links as the link instead of the file\n  or            Rename files automatically\n  ow            Save or restore file owner and group\n  p[password]   Set password\n  p-            Do not query password\n  r             Recurse subdirectories\n  r0            Recurse subdirectories for wildcard names only\n  rr[N]         Add data recovery record\n  rv[N]         Create recovery volumes\n  s[<N>,v[-],e] Create solid archive\n  s-            Disable solid archiving\n  sc<chr>[obj]  Specify the character set\n  sfx[name]     Create SFX archive\n  si[name]      Read data from standard input (stdin)\n  sl<size>      Process files with size less than specified\n  sm<size>      Process files with size more than specified\n  t             Test files after archiving\n  ta<date>      Process files modified after <date> in YYYYMMDDHHMMSS format\n  tb<date>      Process files modified before <date> in YYYYMMDDHHMMSS format\n  tk            Keep original archive time\n  tl            Set archive time to latest file\n  tn<time>      Process files newer than <time>\n  to<time>      Process files older than <time>\n  ts<m,c,a>[N]  Save or restore file time (modification, creation, access)\n  u             Update files\n  v             Create volumes with size autodetection or list all volumes\n  v<size>[k,b]  Create volumes with size=<size>*1000 [*1024, *1]\n  ver[n]        File version control\n  vn            Use the old style volume naming scheme\n  vp            Pause before each volume\n  w<path>       Assign work directory\n  x<file>       Exclude specified file\n  x@            Read file names to exclude from stdin\n  x@<list>      Exclude files in specified list file\n  y             Assume Yes on all queries\n  z[file]       Read archive comment from file\n```","slug":"linux下解压windows上压缩rar包","published":1,"updated":"2019-04-30T06:15:10.476Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4h40005m834skaps1lj","content":"<h5 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h5><p><code># wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz</code></p>\n<h5 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h5><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># tar xvzf rarlinux-3.8.0.tar.gz</span></span><br><span class=\"line\"><span class=\"meta\"># cd rar</span></span><br><span class=\"line\"><span class=\"meta\"># make </span></span><br><span class=\"line\"><span class=\"meta\"># make install</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"rar命令语法\"><a href=\"#rar命令语法\" class=\"headerlink\" title=\"rar命令语法\"></a>rar命令语法</h5><p>将 /etc 目录压缩为 etc.rar 命令为：\\<br><code># rar a etc.rar /etc</code>\\<br>将 etc.rar 解压 命令为：\\<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">rar</span> <span class=\"selector-tag\">x</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br><span class=\"line\"><span class=\"selector-tag\">unrar</span> <span class=\"selector-tag\">-e</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br></pre></td></tr></table></figure></p>\n<h5 id=\"rar帮助手册\"><a href=\"#rar帮助手册\" class=\"headerlink\" title=\"rar帮助手册\"></a>rar帮助手册</h5><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># rar</span></span><br><span class=\"line\"></span><br><span class=\"line\">RAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008</span><br><span class=\"line\">Shareware version         Type RAR -? for help</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:     rar <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">command</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">1</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">N</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">archive</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">files...</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"code\">               &lt;@listfiles...&gt; &lt;path_to_extract\\&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Commands</span>&gt;</span></span></span><br><span class=\"line\">  a             Add files to archive</span><br><span class=\"line\">  c             Add archive comment</span><br><span class=\"line\">  cf            Add files comment</span><br><span class=\"line\">  ch            Change archive parameters</span><br><span class=\"line\">  cw            Write archive comment to file</span><br><span class=\"line\">  d             Delete files from archive</span><br><span class=\"line\">  e             Extract files to current directory</span><br><span class=\"line\">  f             Freshen files in archive</span><br><span class=\"line\">  i[par]=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">str</span>&gt;</span></span>  Find string in archives</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  l[t,b]        List archive [technical, bare]</span><br><span class=\"line\">  m[f]          Move to archive [files only]</span><br><span class=\"line\">  p             Print file to stdout</span><br><span class=\"line\">  r             Repair archive</span><br><span class=\"line\">  rc            Reconstruct missing volumes</span><br><span class=\"line\">  rn            Rename archived files</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[name|-]     Convert archive to or from SFX</span><br><span class=\"line\">  t             Test archive files</span><br><span class=\"line\">  u             Update files in archive</span><br><span class=\"line\">  v[t,b]        Verbosely list archive [technical,bare]</span><br><span class=\"line\">  x             Extract files with full path</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Switches</span>&gt;</span></span></span><br><span class=\"line\">  -             Stop switches scanning</span><br><span class=\"line\">  ad            Append archive name to destination path</span><br><span class=\"line\">  ag[format]    Generate archive name using the current date</span><br><span class=\"line\">  ap<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>      Set path inside archive</span><br><span class=\"line\">  as            Synchronize archive contents</span><br><span class=\"line\">  av            Put authenticity verification (registered versions only)</span><br><span class=\"line\">  av-           Disable authenticity verification check</span><br><span class=\"line\">  c-            Disable comments show</span><br><span class=\"line\">  cfg-          Disable read configuration</span><br><span class=\"line\">  cl            Convert names to lower case</span><br><span class=\"line\">  cu            Convert names to upper case</span><br><span class=\"line\">  df            Delete files after archiving</span><br><span class=\"line\">  dh            Open shared files</span><br><span class=\"line\">  ds            Disable name sort for solid archive</span><br><span class=\"line\">  dw            Wipe files after archiving</span><br><span class=\"line\">  e[+]<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">attr</span>&gt;</span></span>    Set file exclude and include attributes</span><br><span class=\"line\">  ed            Do not add empty directories</span><br><span class=\"line\">  en            Do not put 'end of archive' block</span><br><span class=\"line\">  ep            Exclude paths from names</span><br><span class=\"line\">  ep1           Exclude base directory from names</span><br><span class=\"line\">  ep3           Expand paths to full including the drive letter</span><br><span class=\"line\">  f             Freshen files</span><br><span class=\"line\">  hp[password]  Encrypt both file data and headers</span><br><span class=\"line\">  id[c,d,p,q]   Disable messages</span><br><span class=\"line\">  ierr          Send all messages to stderr</span><br><span class=\"line\">  ilog[name]    Log errors to file (registered versions only)</span><br><span class=\"line\">  inul          Disable all messages</span><br><span class=\"line\">  isnd          Enable sound</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  kb            Keep broken extracted files</span><br><span class=\"line\">  m<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">0..5</span>&gt;</span></span>       Set compression level (0-store...3-default...5-maximal)</span><br><span class=\"line\">  mc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">par</span>&gt;</span></span>       Set advanced compression parameters</span><br><span class=\"line\">  md<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)</span><br><span class=\"line\">  ms[ext;ext]   Specify file types to store</span><br><span class=\"line\">  n<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Include only specified file</span><br><span class=\"line\">  n@            Read file names to include from stdin</span><br><span class=\"line\">  n@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Include files in specified list file</span><br><span class=\"line\">  o[+|-]        Set the overwrite mode</span><br><span class=\"line\">  ol            Save symbolic links as the link instead of the file</span><br><span class=\"line\">  or            Rename files automatically</span><br><span class=\"line\">  ow            Save or restore file owner and group</span><br><span class=\"line\">  p[password]   Set password</span><br><span class=\"line\">  p-            Do not query password</span><br><span class=\"line\">  r             Recurse subdirectories</span><br><span class=\"line\">  r0            Recurse subdirectories for wildcard names only</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">N</span>&gt;</span></span>,v[-],e] Create solid archive</span><br><span class=\"line\">  s-            Disable solid archiving</span><br><span class=\"line\">  sc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">chr</span>&gt;</span></span>[obj]  Specify the character set</span><br><span class=\"line\">  sfx[name]     Create SFX archive</span><br><span class=\"line\">  si[name]      Read data from standard input (stdin)</span><br><span class=\"line\">  sl<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size less than specified</span><br><span class=\"line\">  sm<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size more than specified</span><br><span class=\"line\">  t             Test files after archiving</span><br><span class=\"line\">  ta<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified after <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tb<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified before <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tk            Keep original archive time</span><br><span class=\"line\">  tl            Set archive time to latest file</span><br><span class=\"line\">  tn<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files newer than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  to<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files older than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  ts<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">m,c,a</span>&gt;</span></span>[N]  Save or restore file time (modification, creation, access)</span><br><span class=\"line\">  u             Update files</span><br><span class=\"line\">  v             Create volumes with size autodetection or list all volumes</span><br><span class=\"line\">  v<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>[k,b]  Create volumes with size=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span><span class=\"emphasis\">*1000 [*</span>1024, *1]</span><br><span class=\"line\">  ver[n]        File version control</span><br><span class=\"line\">  vn            Use the old style volume naming scheme</span><br><span class=\"line\">  vp            Pause before each volume</span><br><span class=\"line\">  w<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>       Assign work directory</span><br><span class=\"line\">  x<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Exclude specified file</span><br><span class=\"line\">  x@            Read file names to exclude from stdin</span><br><span class=\"line\">  x@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Exclude files in specified list file</span><br><span class=\"line\">  y             Assume Yes on all queries</span><br><span class=\"line\">  z[file]       Read archive comment from file</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h5 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h5><p><code># wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz</code></p>\n<h5 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h5><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># tar xvzf rarlinux-3.8.0.tar.gz</span></span><br><span class=\"line\"><span class=\"meta\"># cd rar</span></span><br><span class=\"line\"><span class=\"meta\"># make </span></span><br><span class=\"line\"><span class=\"meta\"># make install</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"rar命令语法\"><a href=\"#rar命令语法\" class=\"headerlink\" title=\"rar命令语法\"></a>rar命令语法</h5><p>将 /etc 目录压缩为 etc.rar 命令为：\\<br><code># rar a etc.rar /etc</code>\\<br>将 etc.rar 解压 命令为：\\<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">rar</span> <span class=\"selector-tag\">x</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br><span class=\"line\"><span class=\"selector-tag\">unrar</span> <span class=\"selector-tag\">-e</span> <span class=\"selector-tag\">etc</span><span class=\"selector-class\">.rar</span></span><br></pre></td></tr></table></figure></p>\n<h5 id=\"rar帮助手册\"><a href=\"#rar帮助手册\" class=\"headerlink\" title=\"rar帮助手册\"></a>rar帮助手册</h5><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># rar</span></span><br><span class=\"line\"></span><br><span class=\"line\">RAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008</span><br><span class=\"line\">Shareware version         Type RAR -? for help</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:     rar <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">command</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">1</span>&gt;</span></span> -<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">switch</span> <span class=\"attr\">N</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">archive</span>&gt;</span></span> <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">files...</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"code\">               &lt;@listfiles...&gt; &lt;path_to_extract\\&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Commands</span>&gt;</span></span></span><br><span class=\"line\">  a             Add files to archive</span><br><span class=\"line\">  c             Add archive comment</span><br><span class=\"line\">  cf            Add files comment</span><br><span class=\"line\">  ch            Change archive parameters</span><br><span class=\"line\">  cw            Write archive comment to file</span><br><span class=\"line\">  d             Delete files from archive</span><br><span class=\"line\">  e             Extract files to current directory</span><br><span class=\"line\">  f             Freshen files in archive</span><br><span class=\"line\">  i[par]=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">str</span>&gt;</span></span>  Find string in archives</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  l[t,b]        List archive [technical, bare]</span><br><span class=\"line\">  m[f]          Move to archive [files only]</span><br><span class=\"line\">  p             Print file to stdout</span><br><span class=\"line\">  r             Repair archive</span><br><span class=\"line\">  rc            Reconstruct missing volumes</span><br><span class=\"line\">  rn            Rename archived files</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[name|-]     Convert archive to or from SFX</span><br><span class=\"line\">  t             Test archive files</span><br><span class=\"line\">  u             Update files in archive</span><br><span class=\"line\">  v[t,b]        Verbosely list archive [technical,bare]</span><br><span class=\"line\">  x             Extract files with full path</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">Switches</span>&gt;</span></span></span><br><span class=\"line\">  -             Stop switches scanning</span><br><span class=\"line\">  ad            Append archive name to destination path</span><br><span class=\"line\">  ag[format]    Generate archive name using the current date</span><br><span class=\"line\">  ap<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>      Set path inside archive</span><br><span class=\"line\">  as            Synchronize archive contents</span><br><span class=\"line\">  av            Put authenticity verification (registered versions only)</span><br><span class=\"line\">  av-           Disable authenticity verification check</span><br><span class=\"line\">  c-            Disable comments show</span><br><span class=\"line\">  cfg-          Disable read configuration</span><br><span class=\"line\">  cl            Convert names to lower case</span><br><span class=\"line\">  cu            Convert names to upper case</span><br><span class=\"line\">  df            Delete files after archiving</span><br><span class=\"line\">  dh            Open shared files</span><br><span class=\"line\">  ds            Disable name sort for solid archive</span><br><span class=\"line\">  dw            Wipe files after archiving</span><br><span class=\"line\">  e[+]<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">attr</span>&gt;</span></span>    Set file exclude and include attributes</span><br><span class=\"line\">  ed            Do not add empty directories</span><br><span class=\"line\">  en            Do not put 'end of archive' block</span><br><span class=\"line\">  ep            Exclude paths from names</span><br><span class=\"line\">  ep1           Exclude base directory from names</span><br><span class=\"line\">  ep3           Expand paths to full including the drive letter</span><br><span class=\"line\">  f             Freshen files</span><br><span class=\"line\">  hp[password]  Encrypt both file data and headers</span><br><span class=\"line\">  id[c,d,p,q]   Disable messages</span><br><span class=\"line\">  ierr          Send all messages to stderr</span><br><span class=\"line\">  ilog[name]    Log errors to file (registered versions only)</span><br><span class=\"line\">  inul          Disable all messages</span><br><span class=\"line\">  isnd          Enable sound</span><br><span class=\"line\">  k             Lock archive</span><br><span class=\"line\">  kb            Keep broken extracted files</span><br><span class=\"line\">  m<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">0..5</span>&gt;</span></span>       Set compression level (0-store...3-default...5-maximal)</span><br><span class=\"line\">  mc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">par</span>&gt;</span></span>       Set advanced compression parameters</span><br><span class=\"line\">  md<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)</span><br><span class=\"line\">  ms[ext;ext]   Specify file types to store</span><br><span class=\"line\">  n<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Include only specified file</span><br><span class=\"line\">  n@            Read file names to include from stdin</span><br><span class=\"line\">  n@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Include files in specified list file</span><br><span class=\"line\">  o[+|-]        Set the overwrite mode</span><br><span class=\"line\">  ol            Save symbolic links as the link instead of the file</span><br><span class=\"line\">  or            Rename files automatically</span><br><span class=\"line\">  ow            Save or restore file owner and group</span><br><span class=\"line\">  p[password]   Set password</span><br><span class=\"line\">  p-            Do not query password</span><br><span class=\"line\">  r             Recurse subdirectories</span><br><span class=\"line\">  r0            Recurse subdirectories for wildcard names only</span><br><span class=\"line\">  rr[N]         Add data recovery record</span><br><span class=\"line\">  rv[N]         Create recovery volumes</span><br><span class=\"line\">  s[<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">N</span>&gt;</span></span>,v[-],e] Create solid archive</span><br><span class=\"line\">  s-            Disable solid archiving</span><br><span class=\"line\">  sc<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">chr</span>&gt;</span></span>[obj]  Specify the character set</span><br><span class=\"line\">  sfx[name]     Create SFX archive</span><br><span class=\"line\">  si[name]      Read data from standard input (stdin)</span><br><span class=\"line\">  sl<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size less than specified</span><br><span class=\"line\">  sm<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>      Process files with size more than specified</span><br><span class=\"line\">  t             Test files after archiving</span><br><span class=\"line\">  ta<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified after <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tb<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span>      Process files modified before <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class=\"line\">  tk            Keep original archive time</span><br><span class=\"line\">  tl            Set archive time to latest file</span><br><span class=\"line\">  tn<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files newer than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  to<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span>      Process files older than <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span></span></span><br><span class=\"line\">  ts<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">m,c,a</span>&gt;</span></span>[N]  Save or restore file time (modification, creation, access)</span><br><span class=\"line\">  u             Update files</span><br><span class=\"line\">  v             Create volumes with size autodetection or list all volumes</span><br><span class=\"line\">  v<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span>[k,b]  Create volumes with size=<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">size</span>&gt;</span></span><span class=\"emphasis\">*1000 [*</span>1024, *1]</span><br><span class=\"line\">  ver[n]        File version control</span><br><span class=\"line\">  vn            Use the old style volume naming scheme</span><br><span class=\"line\">  vp            Pause before each volume</span><br><span class=\"line\">  w<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span></span>       Assign work directory</span><br><span class=\"line\">  x<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">file</span>&gt;</span></span>       Exclude specified file</span><br><span class=\"line\">  x@            Read file names to exclude from stdin</span><br><span class=\"line\">  x@<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span>      Exclude files in specified list file</span><br><span class=\"line\">  y             Assume Yes on all queries</span><br><span class=\"line\">  z[file]       Read archive comment from file</span><br></pre></td></tr></table></figure>"},{"title":"phpMyAdmin搭建","date":"2019-04-26T07:30:09.000Z","copyright":true,"_content":"##### 在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\n\n- 下载phpMyAdmin\n官网地址：https://www.phpmyadmin.net/\n\n- 上传到服务器进行安装\n```html\n# unzip phpMyAdmin-4.8.5-all-languages.zip\n# mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin\n# chown apache. /opt/phpMyAdmin\n```\n- 编辑配置文件 config.default.php\n```\n# vim /opt/phpMyAdmin/libraries/config.default.php\n$cfg['Servers'][$i]['host'] = '130.39.113.45';\n$cfg['Servers'][$i]['port'] = '3306';\n$cfg['Servers'][$i]['socket'] = 'socket';\n$cfg['Servers'][$i]['user'] = 'tj_court';\n$cfg['Servers'][$i]['password'] = 'AigheiguSh4eesh0eey8';\n```\n- 配置nginx站点\n```html\n# vim phpMyAdmin.conf\nserver {\n    listen       80;\n    server_name  www.phpadmin.com;\n    autoindex off;\n\n    error_log  logs/phpadmin_error.log error;\n    access_log logs/phpadmin_access.log main;\n\n    location / {\n    root /opt/phpMyAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n- 配置完成后启动nginx访问配置的域名进行连接\n![](phpMyAdmin搭建/4.png)\n![](phpMyAdmin搭建/6.png)\n\n","source":"_posts/phpMyAdmin搭建.md","raw":"---\ntitle: phpMyAdmin搭建\ndate: 2019-04-26 15:30:09\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n##### 在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\n\n- 下载phpMyAdmin\n官网地址：https://www.phpmyadmin.net/\n\n- 上传到服务器进行安装\n```html\n# unzip phpMyAdmin-4.8.5-all-languages.zip\n# mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin\n# chown apache. /opt/phpMyAdmin\n```\n- 编辑配置文件 config.default.php\n```\n# vim /opt/phpMyAdmin/libraries/config.default.php\n$cfg['Servers'][$i]['host'] = '130.39.113.45';\n$cfg['Servers'][$i]['port'] = '3306';\n$cfg['Servers'][$i]['socket'] = 'socket';\n$cfg['Servers'][$i]['user'] = 'tj_court';\n$cfg['Servers'][$i]['password'] = 'AigheiguSh4eesh0eey8';\n```\n- 配置nginx站点\n```html\n# vim phpMyAdmin.conf\nserver {\n    listen       80;\n    server_name  www.phpadmin.com;\n    autoindex off;\n\n    error_log  logs/phpadmin_error.log error;\n    access_log logs/phpadmin_access.log main;\n\n    location / {\n    root /opt/phpMyAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n- 配置完成后启动nginx访问配置的域名进行连接\n![](phpMyAdmin搭建/4.png)\n![](phpMyAdmin搭建/6.png)\n\n","slug":"phpMyAdmin搭建","published":1,"updated":"2019-05-17T13:23:21.439Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4h50006m834634a9u9u","content":"<h5 id=\"在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\"><a href=\"#在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\" class=\"headerlink\" title=\"在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\"></a>在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。</h5><ul>\n<li><p>下载phpMyAdmin<br>官网地址：<a href=\"https://www.phpmyadmin.net/\" target=\"_blank\" rel=\"noopener\">https://www.phpmyadmin.net/</a></p>\n</li>\n<li><p>上传到服务器进行安装</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># unzip phpMyAdmin-4.8.5-all-languages.zip</span><br><span class=\"line\"># mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin</span><br><span class=\"line\"># chown apache. /opt/phpMyAdmin</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>编辑配置文件 config.default.php</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># vim /opt/phpMyAdmin/libraries/config.default.php</span></span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'host'</span>] = '130.39.113.45';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'port'</span>] = '3306';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'socket'</span>] = 'socket';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'user'</span>] = 'tj_court';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'password'</span>] = 'AigheiguSh4eesh0eey8';</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置nginx站点</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># vim phpMyAdmin.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  www.phpadmin.com;</span><br><span class=\"line\">    autoindex off;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_log  logs/phpadmin_error.log error;</span><br><span class=\"line\">    access_log logs/phpadmin_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">    root /opt/phpMyAdmin;</span><br><span class=\"line\">        index  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fastcgi_intercept_errors on;</span><br><span class=\"line\">    error_page  404             /404.html;</span><br><span class=\"line\">    location ~ \\.php$ &#123;</span><br><span class=\"line\">        root           html;</span><br><span class=\"line\">        fastcgi_pass   127.0.0.1:9000;</span><br><span class=\"line\">        fastcgi_index  index.php;</span><br><span class=\"line\">        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;</span><br><span class=\"line\">        include        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location ~ /\\. &#123;</span><br><span class=\"line\">        deny all;</span><br><span class=\"line\">        error_page  403             /404.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置完成后启动nginx访问配置的域名进行连接<br><img src=\"/2019/04/26/phpMyAdmin搭建/4.png\" alt><br><img src=\"/2019/04/26/phpMyAdmin搭建/6.png\" alt></p>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h5 id=\"在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\"><a href=\"#在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。\" class=\"headerlink\" title=\"在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。\"></a>在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。</h5><ul>\n<li><p>下载phpMyAdmin<br>官网地址：<a href=\"https://www.phpmyadmin.net/\" target=\"_blank\" rel=\"noopener\">https://www.phpmyadmin.net/</a></p>\n</li>\n<li><p>上传到服务器进行安装</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># unzip phpMyAdmin-4.8.5-all-languages.zip</span><br><span class=\"line\"># mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin</span><br><span class=\"line\"># chown apache. /opt/phpMyAdmin</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>编辑配置文件 config.default.php</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\"># vim /opt/phpMyAdmin/libraries/config.default.php</span></span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'host'</span>] = '130.39.113.45';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'port'</span>] = '3306';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'socket'</span>] = 'socket';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'user'</span>] = 'tj_court';</span><br><span class=\"line\">$cfg[<span class=\"string\">'Servers'</span>][<span class=\"symbol\">$i</span>][<span class=\"string\">'password'</span>] = 'AigheiguSh4eesh0eey8';</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置nginx站点</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># vim phpMyAdmin.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  www.phpadmin.com;</span><br><span class=\"line\">    autoindex off;</span><br><span class=\"line\"></span><br><span class=\"line\">    error_log  logs/phpadmin_error.log error;</span><br><span class=\"line\">    access_log logs/phpadmin_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">    root /opt/phpMyAdmin;</span><br><span class=\"line\">        index  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fastcgi_intercept_errors on;</span><br><span class=\"line\">    error_page  404             /404.html;</span><br><span class=\"line\">    location ~ \\.php$ &#123;</span><br><span class=\"line\">        root           html;</span><br><span class=\"line\">        fastcgi_pass   127.0.0.1:9000;</span><br><span class=\"line\">        fastcgi_index  index.php;</span><br><span class=\"line\">        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;</span><br><span class=\"line\">        include        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location ~ /\\. &#123;</span><br><span class=\"line\">        deny all;</span><br><span class=\"line\">        error_page  403             /404.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置完成后启动nginx访问配置的域名进行连接<br><img src=\"/2019/04/26/phpMyAdmin搭建/4.png\" alt><br><img src=\"/2019/04/26/phpMyAdmin搭建/6.png\" alt></p>\n</li>\n</ul>\n"},{"title":"saltstack使用salt-ssh","date":"2019-05-20T01:43:05.000Z","copyright":true,"_content":"## salt-ssh 介绍\n[参考官档](https://docs.saltstack.com/en/latest/topics/ssh/index.html)\n>`salt-ssh`是 `0.17.0` 新引入的一个功能，不需要minion对客户端进行管理，也可以不需要`master`；`salt-ssh`也支持`salt`大部分的功能：比如`grains`,`modules`,`state`等；`salt-ssh`没有使用`ZeroMQ`的通信架构，执行是串行模式\n\n## salt-ssh执行原理\n>- `salt-ssh`是在`salt`基础上打了一个`python`包上传到客户端的默认`tmp`目录下, 在客户端上面解压并执行返回结果,最后删除`tmp`上传的临时文件。\n>- `salt-minion`方法是`salt-mater`先执行语法验证，验证通过后发送到`minion`，`minion`收到`Msater`的状态文件默认保存在`/var/cache/salt/minion`\n>- `salt-ssh`和`salt-minion`可以共存，`salt-minion`不依赖于`ssh`服务\n\n\n## 安装配置\n1）安装`salt-ssh`\n```\n[root@salt-master ~]# yum -y install salt-ssh\n```\n2）修改`roster`文件，配置需要管理的机器\n```\n[root@salt-master ~]# vim /etc/salt/roster\nsalt-minion01:\n  host: 192.168.1.31\n  user: root\n  passwd: 123456\n  port: 22\n\nsalt-minion02:\n  host: 192.168.1.32\n  user: root\n  passwd: 123456\n  port: 22\n```\n3）管理测试 (说明，如果第一次需要输入`yes或no`进行`ssh`认证，可以加`-i`参数自动认证)\n```\n[root@salt-master ~]# salt-ssh '*' test.ping -i\nsalt-minion01:\n    True\nsalt-minion02:\n    True\n```\n4）`salt-ssh`命令参数\n```\n-r, –raw, –raw-shell # 直接使用shell命令\n–priv #指定SSH私有密钥文件\n–roster #定义使用哪个roster系统，如果定义了一个后端数据库，扫描方式，或者用户自定义的的roster系统，默认的就是/etc/salt/roster文件\n–roster-file #指定roster文件\n–refresh, –refresh-cache #刷新cache，如果target的grains改变会自动刷新\n–max-procs #指定进程数，默认为25\n-i, –ignore-host-keys #当ssh连接时，忽略keys\n–passwd #指定默认密码\n–key-deploy #配置keys 设置这个参数对于所有minions用来部署ssh-key认证，\n 这个参和–passwd结合起来使用会使初始化部署很快很方便。当调用master模块时，并加上参数 –key-deploy 即可在minions生成keys，下次开始就不使用密码\n```\n5）`salt-ssh`执行命令\n```\n[root@salt-master ~]# salt-ssh '*' -r \"uptime\"\nsalt-minion01:\n    ----------\n    retcode:\n        0\n    stderr:\n    stdout:\n        root@192.168.1.31's password: \n         10:06:08 up 1 day, 17:05,  2 users,  load average: 0.00, 0.01, 0.05\nsalt-minion02:\n    ----------\n    retcode:\n        0\n    stderr:\n    stdout:\n        root@192.168.1.32's password: \n         10:06:08 up 1 day, 17:16,  2 users,  load average: 0.03, 0.06, 0.06\n```\n6）`salt-ssh`执行状态模块\n```\n[root@salt-master ~]# salt-ssh '*' state.sls modules.haproxy.service saltenv=prod\nsalt-minion02:\n----------\n          ID: haproxy-install\n    Function: pkg.installed\n        Name: haproxy\n      Result: True\n     Comment: All specified packages are already installed\n     Started: 10:09:48.541019\n    Duration: 10161.705 ms\n     Changes:   \n----------\n          ID: haproxy-config\n    Function: file.managed\n        Name: /etc/haproxy/haproxy.cfg\n      Result: True\n     Comment: File /etc/haproxy/haproxy.cfg is in the correct state\n     Started: 10:09:59.020659\n    Duration: 54.263 ms\n     Changes:   \n----------\n          ID: haproxy-service\n    Function: service.running\n        Name: haproxy\n      Result: True\n     Comment: The service haproxy is already running\n     Started: 10:09:59.079110\n    Duration: 128.052 ms\n     Changes:   \n\nSummary for salt-minion02\n------------\nSucceeded: 3\nFailed:    0\n------------\nTotal states run:     3\nTotal run time:  10.344 s\nsalt-minion01:\n----------\n          ID: haproxy-install\n    Function: pkg.installed\n        Name: haproxy\n      Result: True\n     Comment: All specified packages are already installed\n     Started: 10:10:00.561015\n    Duration: 2862.018 ms\n     Changes:   \n----------\n          ID: haproxy-config\n    Function: file.managed\n        Name: /etc/haproxy/haproxy.cfg\n      Result: True\n     Comment: File /etc/haproxy/haproxy.cfg is in the correct state\n     Started: 10:10:03.905713\n    Duration: 220.443 ms\n     Changes:   \n----------\n          ID: haproxy-service\n    Function: service.running\n        Name: haproxy\n      Result: True\n     Comment: The service haproxy is already running\n     Started: 10:10:04.135607\n    Duration: 230.231 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 3\nFailed:    0\n------------\nTotal states run:     3\nTotal run time:   3.313 s\n```\n## Roster说明\n>`salt-ssh`需要一个名单系统来确定哪些执行目标，`Salt`的`0.17.0`版本中`salt-ssh`引入`roste`r系统\n`roster`系统编译成了一个数据结构，包含了`targets`，这些`targets`是一个目标系统主机列表和或如连接到这些`targets`。\n\n配置文件说明：\n```\n# target的信息\n    host:        # 远端主机的ip地址或者dns域名\n    user:        # 登录的用户\n    passwd:      # 用户密码,如果不使用此选项，则默认使用秘钥方式\n# 可选的部分\n    port:        #ssh端口\n    sudo:        #可以通过sudo\n    tty:         # 如果设置了sudo，设置这个参数为true\n    priv:        # ssh秘钥的文件路径\n    timeout:     # 当建立链接时等待响应时间的秒数\n    minion_opts: # minion的位置路径\n    thin_dir:    # target系统的存储目录，默认是/tmp/salt-<hash>\n    cmd_umask:   # 使用salt-call命令的umask值\n```","source":"_posts/saltstack使用salt-ssh.md","raw":"---\ntitle: saltstack使用salt-ssh\ndate: 2019-05-20 09:43:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## salt-ssh 介绍\n[参考官档](https://docs.saltstack.com/en/latest/topics/ssh/index.html)\n>`salt-ssh`是 `0.17.0` 新引入的一个功能，不需要minion对客户端进行管理，也可以不需要`master`；`salt-ssh`也支持`salt`大部分的功能：比如`grains`,`modules`,`state`等；`salt-ssh`没有使用`ZeroMQ`的通信架构，执行是串行模式\n\n## salt-ssh执行原理\n>- `salt-ssh`是在`salt`基础上打了一个`python`包上传到客户端的默认`tmp`目录下, 在客户端上面解压并执行返回结果,最后删除`tmp`上传的临时文件。\n>- `salt-minion`方法是`salt-mater`先执行语法验证，验证通过后发送到`minion`，`minion`收到`Msater`的状态文件默认保存在`/var/cache/salt/minion`\n>- `salt-ssh`和`salt-minion`可以共存，`salt-minion`不依赖于`ssh`服务\n\n\n## 安装配置\n1）安装`salt-ssh`\n```\n[root@salt-master ~]# yum -y install salt-ssh\n```\n2）修改`roster`文件，配置需要管理的机器\n```\n[root@salt-master ~]# vim /etc/salt/roster\nsalt-minion01:\n  host: 192.168.1.31\n  user: root\n  passwd: 123456\n  port: 22\n\nsalt-minion02:\n  host: 192.168.1.32\n  user: root\n  passwd: 123456\n  port: 22\n```\n3）管理测试 (说明，如果第一次需要输入`yes或no`进行`ssh`认证，可以加`-i`参数自动认证)\n```\n[root@salt-master ~]# salt-ssh '*' test.ping -i\nsalt-minion01:\n    True\nsalt-minion02:\n    True\n```\n4）`salt-ssh`命令参数\n```\n-r, –raw, –raw-shell # 直接使用shell命令\n–priv #指定SSH私有密钥文件\n–roster #定义使用哪个roster系统，如果定义了一个后端数据库，扫描方式，或者用户自定义的的roster系统，默认的就是/etc/salt/roster文件\n–roster-file #指定roster文件\n–refresh, –refresh-cache #刷新cache，如果target的grains改变会自动刷新\n–max-procs #指定进程数，默认为25\n-i, –ignore-host-keys #当ssh连接时，忽略keys\n–passwd #指定默认密码\n–key-deploy #配置keys 设置这个参数对于所有minions用来部署ssh-key认证，\n 这个参和–passwd结合起来使用会使初始化部署很快很方便。当调用master模块时，并加上参数 –key-deploy 即可在minions生成keys，下次开始就不使用密码\n```\n5）`salt-ssh`执行命令\n```\n[root@salt-master ~]# salt-ssh '*' -r \"uptime\"\nsalt-minion01:\n    ----------\n    retcode:\n        0\n    stderr:\n    stdout:\n        root@192.168.1.31's password: \n         10:06:08 up 1 day, 17:05,  2 users,  load average: 0.00, 0.01, 0.05\nsalt-minion02:\n    ----------\n    retcode:\n        0\n    stderr:\n    stdout:\n        root@192.168.1.32's password: \n         10:06:08 up 1 day, 17:16,  2 users,  load average: 0.03, 0.06, 0.06\n```\n6）`salt-ssh`执行状态模块\n```\n[root@salt-master ~]# salt-ssh '*' state.sls modules.haproxy.service saltenv=prod\nsalt-minion02:\n----------\n          ID: haproxy-install\n    Function: pkg.installed\n        Name: haproxy\n      Result: True\n     Comment: All specified packages are already installed\n     Started: 10:09:48.541019\n    Duration: 10161.705 ms\n     Changes:   \n----------\n          ID: haproxy-config\n    Function: file.managed\n        Name: /etc/haproxy/haproxy.cfg\n      Result: True\n     Comment: File /etc/haproxy/haproxy.cfg is in the correct state\n     Started: 10:09:59.020659\n    Duration: 54.263 ms\n     Changes:   \n----------\n          ID: haproxy-service\n    Function: service.running\n        Name: haproxy\n      Result: True\n     Comment: The service haproxy is already running\n     Started: 10:09:59.079110\n    Duration: 128.052 ms\n     Changes:   \n\nSummary for salt-minion02\n------------\nSucceeded: 3\nFailed:    0\n------------\nTotal states run:     3\nTotal run time:  10.344 s\nsalt-minion01:\n----------\n          ID: haproxy-install\n    Function: pkg.installed\n        Name: haproxy\n      Result: True\n     Comment: All specified packages are already installed\n     Started: 10:10:00.561015\n    Duration: 2862.018 ms\n     Changes:   \n----------\n          ID: haproxy-config\n    Function: file.managed\n        Name: /etc/haproxy/haproxy.cfg\n      Result: True\n     Comment: File /etc/haproxy/haproxy.cfg is in the correct state\n     Started: 10:10:03.905713\n    Duration: 220.443 ms\n     Changes:   \n----------\n          ID: haproxy-service\n    Function: service.running\n        Name: haproxy\n      Result: True\n     Comment: The service haproxy is already running\n     Started: 10:10:04.135607\n    Duration: 230.231 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 3\nFailed:    0\n------------\nTotal states run:     3\nTotal run time:   3.313 s\n```\n## Roster说明\n>`salt-ssh`需要一个名单系统来确定哪些执行目标，`Salt`的`0.17.0`版本中`salt-ssh`引入`roste`r系统\n`roster`系统编译成了一个数据结构，包含了`targets`，这些`targets`是一个目标系统主机列表和或如连接到这些`targets`。\n\n配置文件说明：\n```\n# target的信息\n    host:        # 远端主机的ip地址或者dns域名\n    user:        # 登录的用户\n    passwd:      # 用户密码,如果不使用此选项，则默认使用秘钥方式\n# 可选的部分\n    port:        #ssh端口\n    sudo:        #可以通过sudo\n    tty:         # 如果设置了sudo，设置这个参数为true\n    priv:        # ssh秘钥的文件路径\n    timeout:     # 当建立链接时等待响应时间的秒数\n    minion_opts: # minion的位置路径\n    thin_dir:    # target系统的存储目录，默认是/tmp/salt-<hash>\n    cmd_umask:   # 使用salt-call命令的umask值\n```","slug":"saltstack使用salt-ssh","published":1,"updated":"2019-05-23T12:29:57.764Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4h7000am834b061rzcy","content":"<h2 id=\"salt-ssh-介绍\"><a href=\"#salt-ssh-介绍\" class=\"headerlink\" title=\"salt-ssh 介绍\"></a>salt-ssh 介绍</h2><p><a href=\"https://docs.saltstack.com/en/latest/topics/ssh/index.html\" target=\"_blank\" rel=\"noopener\">参考官档</a></p>\n<blockquote>\n<p><code>salt-ssh</code>是 <code>0.17.0</code> 新引入的一个功能，不需要minion对客户端进行管理，也可以不需要<code>master</code>；<code>salt-ssh</code>也支持<code>salt</code>大部分的功能：比如<code>grains</code>,<code>modules</code>,<code>state</code>等；<code>salt-ssh</code>没有使用<code>ZeroMQ</code>的通信架构，执行是串行模式</p>\n</blockquote>\n<h2 id=\"salt-ssh执行原理\"><a href=\"#salt-ssh执行原理\" class=\"headerlink\" title=\"salt-ssh执行原理\"></a>salt-ssh执行原理</h2><blockquote>\n<ul>\n<li><code>salt-ssh</code>是在<code>salt</code>基础上打了一个<code>python</code>包上传到客户端的默认<code>tmp</code>目录下, 在客户端上面解压并执行返回结果,最后删除<code>tmp</code>上传的临时文件。</li>\n<li><code>salt-minion</code>方法是<code>salt-mater</code>先执行语法验证，验证通过后发送到<code>minion</code>，<code>minion</code>收到<code>Msater</code>的状态文件默认保存在<code>/var/cache/salt/minion</code></li>\n<li><code>salt-ssh</code>和<code>salt-minion</code>可以共存，<code>salt-minion</code>不依赖于<code>ssh</code>服务</li>\n</ul>\n</blockquote>\n<h2 id=\"安装配置\"><a href=\"#安装配置\" class=\"headerlink\" title=\"安装配置\"></a>安装配置</h2><p>1）安装<code>salt-ssh</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-ssh</span><br></pre></td></tr></table></figure></p>\n<p>2）修改<code>roster</code>文件，配置需要管理的机器<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">vim</span> <span class=\"string\">/etc/salt/roster</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span></span><br><span class=\"line\"><span class=\"attr\">  user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  passwd:</span> <span class=\"number\">123456</span></span><br><span class=\"line\"><span class=\"attr\">  port:</span> <span class=\"number\">22</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"><span class=\"attr\">  user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  passwd:</span> <span class=\"number\">123456</span></span><br><span class=\"line\"><span class=\"attr\">  port:</span> <span class=\"number\">22</span></span><br></pre></td></tr></table></figure></p>\n<p>3）管理测试 (说明，如果第一次需要输入<code>yes或no</code>进行<code>ssh</code>认证，可以加<code>-i</code>参数自动认证)<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-ssh</span> <span class=\"string\">'*'</span> <span class=\"string\">test.ping</span> <span class=\"bullet\">-i</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4）<code>salt-ssh</code>命令参数<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-r, –raw, –raw-shell <span class=\"comment\"># 直接使用shell命令</span></span><br><span class=\"line\">–priv <span class=\"comment\">#指定SSH私有密钥文件</span></span><br><span class=\"line\">–roster <span class=\"comment\">#定义使用哪个roster系统，如果定义了一个后端数据库，扫描方式，或者用户自定义的的roster系统，默认的就是/etc/salt/roster文件</span></span><br><span class=\"line\">–roster-file <span class=\"comment\">#指定roster文件</span></span><br><span class=\"line\">–refresh, –refresh-<span class=\"keyword\">cache</span> <span class=\"comment\">#刷新cache，如果target的grains改变会自动刷新</span></span><br><span class=\"line\">–<span class=\"keyword\">max</span>-procs <span class=\"comment\">#指定进程数，默认为25</span></span><br><span class=\"line\">-i, –<span class=\"keyword\">ignore</span>-host-<span class=\"keyword\">keys</span> <span class=\"comment\">#当ssh连接时，忽略keys</span></span><br><span class=\"line\">–passwd <span class=\"comment\">#指定默认密码</span></span><br><span class=\"line\">–<span class=\"keyword\">key</span>-deploy <span class=\"comment\">#配置keys 设置这个参数对于所有minions用来部署ssh-key认证，</span></span><br><span class=\"line\"> 这个参和–passwd结合起来使用会使初始化部署很快很方便。当调用<span class=\"keyword\">master</span>模块时，并加上参数 –<span class=\"keyword\">key</span>-deploy 即可在minions生成<span class=\"keyword\">keys</span>，下次开始就不使用密码</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>salt-ssh</code>执行命令<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-ssh</span> <span class=\"string\">'*'</span> <span class=\"bullet\">-r</span> <span class=\"string\">\"uptime\"</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span><span class=\"bullet\">---------</span></span><br><span class=\"line\"><span class=\"attr\">    retcode:</span></span><br><span class=\"line\">        <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">    stderr:</span></span><br><span class=\"line\"><span class=\"attr\">    stdout:</span></span><br><span class=\"line\">        <span class=\"string\">root@192.168.1.31's</span> <span class=\"attr\">password:</span> </span><br><span class=\"line\">         <span class=\"number\">10</span><span class=\"string\">:06:08</span> <span class=\"string\">up</span> <span class=\"number\">1</span> <span class=\"string\">day,</span> <span class=\"number\">17</span><span class=\"string\">:05,</span>  <span class=\"number\">2</span> <span class=\"string\">users,</span>  <span class=\"string\">load</span> <span class=\"attr\">average:</span> <span class=\"number\">0.00</span><span class=\"string\">,</span> <span class=\"number\">0.01</span><span class=\"string\">,</span> <span class=\"number\">0.05</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span><span class=\"bullet\">---------</span></span><br><span class=\"line\"><span class=\"attr\">    retcode:</span></span><br><span class=\"line\">        <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">    stderr:</span></span><br><span class=\"line\"><span class=\"attr\">    stdout:</span></span><br><span class=\"line\">        <span class=\"string\">root@192.168.1.32's</span> <span class=\"attr\">password:</span> </span><br><span class=\"line\">         <span class=\"number\">10</span><span class=\"string\">:06:08</span> <span class=\"string\">up</span> <span class=\"number\">1</span> <span class=\"string\">day,</span> <span class=\"number\">17</span><span class=\"string\">:16,</span>  <span class=\"number\">2</span> <span class=\"string\">users,</span>  <span class=\"string\">load</span> <span class=\"attr\">average:</span> <span class=\"number\">0.03</span><span class=\"string\">,</span> <span class=\"number\">0.06</span><span class=\"string\">,</span> <span class=\"number\">0.06</span></span><br></pre></td></tr></table></figure></p>\n<p>6）<code>salt-ssh</code>执行状态模块<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt-ssh <span class=\"emphasis\">'*'</span> state.sls modules.haproxy.service saltenv=prod</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-install</span></span><br><span class=\"line\"><span class=\"code\">    Function: pkg.installed</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: All specified packages are already installed</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:48.541019</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 10161.705 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-config</span></span><br><span class=\"line\"><span class=\"code\">    Function: file.managed</span></span><br><span class=\"line\"><span class=\"code\">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:59.020659</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 54.263 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-service</span></span><br><span class=\"line\"><span class=\"code\">    Function: service.running</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: The service haproxy is already running</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:59.079110</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 128.052 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion02</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 3</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     3</span><br><span class=\"line\">Total run time:  10.344 s</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-install</span></span><br><span class=\"line\"><span class=\"code\">    Function: pkg.installed</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: All specified packages are already installed</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:00.561015</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 2862.018 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-config</span></span><br><span class=\"line\"><span class=\"code\">    Function: file.managed</span></span><br><span class=\"line\"><span class=\"code\">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:03.905713</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 220.443 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-service</span></span><br><span class=\"line\"><span class=\"code\">    Function: service.running</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: The service haproxy is already running</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:04.135607</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 230.231 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 3</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     3</span><br><span class=\"line\">Total run time:   3.313 s</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Roster说明\"><a href=\"#Roster说明\" class=\"headerlink\" title=\"Roster说明\"></a>Roster说明</h2><blockquote>\n<p><code>salt-ssh</code>需要一个名单系统来确定哪些执行目标，<code>Salt</code>的<code>0.17.0</code>版本中<code>salt-ssh</code>引入<code>roste</code>r系统<br><code>roster</code>系统编译成了一个数据结构，包含了<code>targets</code>，这些<code>targets</code>是一个目标系统主机列表和或如连接到这些<code>targets</code>。</p>\n</blockquote>\n<p>配置文件说明：<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># target的信息</span></span><br><span class=\"line\"><span class=\"symbol\">    host:</span>        <span class=\"meta\"># 远端主机的ip地址或者dns域名</span></span><br><span class=\"line\"><span class=\"symbol\">    user:</span>        <span class=\"meta\"># 登录的用户</span></span><br><span class=\"line\"><span class=\"symbol\">    passwd:</span>      <span class=\"meta\"># 用户密码,如果不使用此选项，则默认使用秘钥方式</span></span><br><span class=\"line\"><span class=\"meta\"># 可选的部分</span></span><br><span class=\"line\"><span class=\"symbol\">    port:</span>        <span class=\"meta\">#ssh端口</span></span><br><span class=\"line\"><span class=\"symbol\">    sudo:</span>        <span class=\"meta\">#可以通过sudo</span></span><br><span class=\"line\"><span class=\"symbol\">    tty:</span>         <span class=\"meta\"># 如果设置了sudo，设置这个参数为true</span></span><br><span class=\"line\"><span class=\"symbol\">    priv:</span>        <span class=\"meta\"># ssh秘钥的文件路径</span></span><br><span class=\"line\"><span class=\"symbol\">    timeout:</span>     <span class=\"meta\"># 当建立链接时等待响应时间的秒数</span></span><br><span class=\"line\"><span class=\"symbol\">    minion_opts:</span> <span class=\"meta\"># minion的位置路径</span></span><br><span class=\"line\"><span class=\"symbol\">    thin_dir:</span>    <span class=\"meta\"># target系统的存储目录，默认是/tmp/salt-&lt;hash&gt;</span></span><br><span class=\"line\"><span class=\"symbol\">    cmd_umask:</span>   <span class=\"meta\"># 使用salt-call命令的umask值</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"salt-ssh-介绍\"><a href=\"#salt-ssh-介绍\" class=\"headerlink\" title=\"salt-ssh 介绍\"></a>salt-ssh 介绍</h2><p><a href=\"https://docs.saltstack.com/en/latest/topics/ssh/index.html\" target=\"_blank\" rel=\"noopener\">参考官档</a></p>\n<blockquote>\n<p><code>salt-ssh</code>是 <code>0.17.0</code> 新引入的一个功能，不需要minion对客户端进行管理，也可以不需要<code>master</code>；<code>salt-ssh</code>也支持<code>salt</code>大部分的功能：比如<code>grains</code>,<code>modules</code>,<code>state</code>等；<code>salt-ssh</code>没有使用<code>ZeroMQ</code>的通信架构，执行是串行模式</p>\n</blockquote>\n<h2 id=\"salt-ssh执行原理\"><a href=\"#salt-ssh执行原理\" class=\"headerlink\" title=\"salt-ssh执行原理\"></a>salt-ssh执行原理</h2><blockquote>\n<ul>\n<li><code>salt-ssh</code>是在<code>salt</code>基础上打了一个<code>python</code>包上传到客户端的默认<code>tmp</code>目录下, 在客户端上面解压并执行返回结果,最后删除<code>tmp</code>上传的临时文件。</li>\n<li><code>salt-minion</code>方法是<code>salt-mater</code>先执行语法验证，验证通过后发送到<code>minion</code>，<code>minion</code>收到<code>Msater</code>的状态文件默认保存在<code>/var/cache/salt/minion</code></li>\n<li><code>salt-ssh</code>和<code>salt-minion</code>可以共存，<code>salt-minion</code>不依赖于<code>ssh</code>服务</li>\n</ul>\n</blockquote>\n<h2 id=\"安装配置\"><a href=\"#安装配置\" class=\"headerlink\" title=\"安装配置\"></a>安装配置</h2><p>1）安装<code>salt-ssh</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-ssh</span><br></pre></td></tr></table></figure></p>\n<p>2）修改<code>roster</code>文件，配置需要管理的机器<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">vim</span> <span class=\"string\">/etc/salt/roster</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span></span><br><span class=\"line\"><span class=\"attr\">  user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  passwd:</span> <span class=\"number\">123456</span></span><br><span class=\"line\"><span class=\"attr\">  port:</span> <span class=\"number\">22</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"><span class=\"attr\">  user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  passwd:</span> <span class=\"number\">123456</span></span><br><span class=\"line\"><span class=\"attr\">  port:</span> <span class=\"number\">22</span></span><br></pre></td></tr></table></figure></p>\n<p>3）管理测试 (说明，如果第一次需要输入<code>yes或no</code>进行<code>ssh</code>认证，可以加<code>-i</code>参数自动认证)<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-ssh</span> <span class=\"string\">'*'</span> <span class=\"string\">test.ping</span> <span class=\"bullet\">-i</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4）<code>salt-ssh</code>命令参数<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-r, –raw, –raw-shell <span class=\"comment\"># 直接使用shell命令</span></span><br><span class=\"line\">–priv <span class=\"comment\">#指定SSH私有密钥文件</span></span><br><span class=\"line\">–roster <span class=\"comment\">#定义使用哪个roster系统，如果定义了一个后端数据库，扫描方式，或者用户自定义的的roster系统，默认的就是/etc/salt/roster文件</span></span><br><span class=\"line\">–roster-file <span class=\"comment\">#指定roster文件</span></span><br><span class=\"line\">–refresh, –refresh-<span class=\"keyword\">cache</span> <span class=\"comment\">#刷新cache，如果target的grains改变会自动刷新</span></span><br><span class=\"line\">–<span class=\"keyword\">max</span>-procs <span class=\"comment\">#指定进程数，默认为25</span></span><br><span class=\"line\">-i, –<span class=\"keyword\">ignore</span>-host-<span class=\"keyword\">keys</span> <span class=\"comment\">#当ssh连接时，忽略keys</span></span><br><span class=\"line\">–passwd <span class=\"comment\">#指定默认密码</span></span><br><span class=\"line\">–<span class=\"keyword\">key</span>-deploy <span class=\"comment\">#配置keys 设置这个参数对于所有minions用来部署ssh-key认证，</span></span><br><span class=\"line\"> 这个参和–passwd结合起来使用会使初始化部署很快很方便。当调用<span class=\"keyword\">master</span>模块时，并加上参数 –<span class=\"keyword\">key</span>-deploy 即可在minions生成<span class=\"keyword\">keys</span>，下次开始就不使用密码</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>salt-ssh</code>执行命令<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-ssh</span> <span class=\"string\">'*'</span> <span class=\"bullet\">-r</span> <span class=\"string\">\"uptime\"</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span><span class=\"bullet\">---------</span></span><br><span class=\"line\"><span class=\"attr\">    retcode:</span></span><br><span class=\"line\">        <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">    stderr:</span></span><br><span class=\"line\"><span class=\"attr\">    stdout:</span></span><br><span class=\"line\">        <span class=\"string\">root@192.168.1.31's</span> <span class=\"attr\">password:</span> </span><br><span class=\"line\">         <span class=\"number\">10</span><span class=\"string\">:06:08</span> <span class=\"string\">up</span> <span class=\"number\">1</span> <span class=\"string\">day,</span> <span class=\"number\">17</span><span class=\"string\">:05,</span>  <span class=\"number\">2</span> <span class=\"string\">users,</span>  <span class=\"string\">load</span> <span class=\"attr\">average:</span> <span class=\"number\">0.00</span><span class=\"string\">,</span> <span class=\"number\">0.01</span><span class=\"string\">,</span> <span class=\"number\">0.05</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span><span class=\"bullet\">---------</span></span><br><span class=\"line\"><span class=\"attr\">    retcode:</span></span><br><span class=\"line\">        <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">    stderr:</span></span><br><span class=\"line\"><span class=\"attr\">    stdout:</span></span><br><span class=\"line\">        <span class=\"string\">root@192.168.1.32's</span> <span class=\"attr\">password:</span> </span><br><span class=\"line\">         <span class=\"number\">10</span><span class=\"string\">:06:08</span> <span class=\"string\">up</span> <span class=\"number\">1</span> <span class=\"string\">day,</span> <span class=\"number\">17</span><span class=\"string\">:16,</span>  <span class=\"number\">2</span> <span class=\"string\">users,</span>  <span class=\"string\">load</span> <span class=\"attr\">average:</span> <span class=\"number\">0.03</span><span class=\"string\">,</span> <span class=\"number\">0.06</span><span class=\"string\">,</span> <span class=\"number\">0.06</span></span><br></pre></td></tr></table></figure></p>\n<p>6）<code>salt-ssh</code>执行状态模块<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt-ssh <span class=\"emphasis\">'*'</span> state.sls modules.haproxy.service saltenv=prod</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-install</span></span><br><span class=\"line\"><span class=\"code\">    Function: pkg.installed</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: All specified packages are already installed</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:48.541019</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 10161.705 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-config</span></span><br><span class=\"line\"><span class=\"code\">    Function: file.managed</span></span><br><span class=\"line\"><span class=\"code\">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:59.020659</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 54.263 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-service</span></span><br><span class=\"line\"><span class=\"code\">    Function: service.running</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: The service haproxy is already running</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:09:59.079110</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 128.052 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion02</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 3</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     3</span><br><span class=\"line\">Total run time:  10.344 s</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-install</span></span><br><span class=\"line\"><span class=\"code\">    Function: pkg.installed</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: All specified packages are already installed</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:00.561015</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 2862.018 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-config</span></span><br><span class=\"line\"><span class=\"code\">    Function: file.managed</span></span><br><span class=\"line\"><span class=\"code\">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:03.905713</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 220.443 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: haproxy-service</span></span><br><span class=\"line\"><span class=\"code\">    Function: service.running</span></span><br><span class=\"line\"><span class=\"code\">        Name: haproxy</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: The service haproxy is already running</span></span><br><span class=\"line\"><span class=\"code\">     Started: 10:10:04.135607</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 230.231 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 3</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     3</span><br><span class=\"line\">Total run time:   3.313 s</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Roster说明\"><a href=\"#Roster说明\" class=\"headerlink\" title=\"Roster说明\"></a>Roster说明</h2><blockquote>\n<p><code>salt-ssh</code>需要一个名单系统来确定哪些执行目标，<code>Salt</code>的<code>0.17.0</code>版本中<code>salt-ssh</code>引入<code>roste</code>r系统<br><code>roster</code>系统编译成了一个数据结构，包含了<code>targets</code>，这些<code>targets</code>是一个目标系统主机列表和或如连接到这些<code>targets</code>。</p>\n</blockquote>\n<p>配置文件说明：<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># target的信息</span></span><br><span class=\"line\"><span class=\"symbol\">    host:</span>        <span class=\"meta\"># 远端主机的ip地址或者dns域名</span></span><br><span class=\"line\"><span class=\"symbol\">    user:</span>        <span class=\"meta\"># 登录的用户</span></span><br><span class=\"line\"><span class=\"symbol\">    passwd:</span>      <span class=\"meta\"># 用户密码,如果不使用此选项，则默认使用秘钥方式</span></span><br><span class=\"line\"><span class=\"meta\"># 可选的部分</span></span><br><span class=\"line\"><span class=\"symbol\">    port:</span>        <span class=\"meta\">#ssh端口</span></span><br><span class=\"line\"><span class=\"symbol\">    sudo:</span>        <span class=\"meta\">#可以通过sudo</span></span><br><span class=\"line\"><span class=\"symbol\">    tty:</span>         <span class=\"meta\"># 如果设置了sudo，设置这个参数为true</span></span><br><span class=\"line\"><span class=\"symbol\">    priv:</span>        <span class=\"meta\"># ssh秘钥的文件路径</span></span><br><span class=\"line\"><span class=\"symbol\">    timeout:</span>     <span class=\"meta\"># 当建立链接时等待响应时间的秒数</span></span><br><span class=\"line\"><span class=\"symbol\">    minion_opts:</span> <span class=\"meta\"># minion的位置路径</span></span><br><span class=\"line\"><span class=\"symbol\">    thin_dir:</span>    <span class=\"meta\"># target系统的存储目录，默认是/tmp/salt-&lt;hash&gt;</span></span><br><span class=\"line\"><span class=\"symbol\">    cmd_umask:</span>   <span class=\"meta\"># 使用salt-call命令的umask值</span></span><br></pre></td></tr></table></figure></p>\n"},{"title":"phpRedisAdmin搭建","date":"2019-04-26T08:30:09.000Z","copyright":true,"_content":">在已有的` lnmp` 环境下搭建 `phpRedisAdmin` 由于服务器做了限制，隧道端口转发等都不能使用，导致 `RedisDesktopManager` 管理工具不能使用，只能通过 `phpRedisAdmin`来进行管理了。\n\n1）下载软件\n```\n# git clone https://github.com/ErikDubbelboer/phpRedisAdmin.git\n# cd phpRedisAdmin\n# git clone https://github.com/nrk/predis.git vendor\n```\n2）放置到`web`站点目录\n```\n# cd ..\n# mv phpRedisAdmin /opt/\n# chown apache.apache phpRedisAdmin/ -R\n```\n3）编辑`nginx`配置文件\n```\n# vim phpRedisAdmin.conf\nserver {\n    listen       80;\n    server_name  www.redis.com;\n    autoindex off;\n\n    error_log  logs/redis_error.log error;\n    access_log logs/redis_access.log main;\n\n    location / {\n    root /opt/phpRedisAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpRedisAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n4）配置连接管理，默认连接的是`6379`端口\n```\n# vim /opt/phpRedisAdmin/includes/config.sample.inc.php\n$config = array(\n  'servers' => array(\n    array(\n      'name'   => 'local server', // Optional name.\n      'host'   => '127.0.0.1',\n      'port'   => 6395,\n      'filter' => '*',\n      'scheme' => 'tcp', // Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket\n      'path'   => '', // Optional. Path to unix domain socket. Uses only if 'scheme' => 'unix'. Example: '/var/run/redis/redis.sock'\n      'auth' => 'jieg6uy5Dach0yooxo1l' // Warning: The password is sent in plain-text to the Redis server.\n    ),\n```\n5）`windows`添加`host`然后访问 `http://www.redis.com`\n![](https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n\n","source":"_posts/phpRedisAdmin搭建.md","raw":"---\ntitle: phpRedisAdmin搭建\ndate: 2019-04-26 16:30:09\ntags: Linux运维日常\ncategories: Linux运维日常\ncopyright: true\n---\n>在已有的` lnmp` 环境下搭建 `phpRedisAdmin` 由于服务器做了限制，隧道端口转发等都不能使用，导致 `RedisDesktopManager` 管理工具不能使用，只能通过 `phpRedisAdmin`来进行管理了。\n\n1）下载软件\n```\n# git clone https://github.com/ErikDubbelboer/phpRedisAdmin.git\n# cd phpRedisAdmin\n# git clone https://github.com/nrk/predis.git vendor\n```\n2）放置到`web`站点目录\n```\n# cd ..\n# mv phpRedisAdmin /opt/\n# chown apache.apache phpRedisAdmin/ -R\n```\n3）编辑`nginx`配置文件\n```\n# vim phpRedisAdmin.conf\nserver {\n    listen       80;\n    server_name  www.redis.com;\n    autoindex off;\n\n    error_log  logs/redis_error.log error;\n    access_log logs/redis_access.log main;\n\n    location / {\n    root /opt/phpRedisAdmin;\n        index  index.php index.html index.htm;\n    }\n\n    fastcgi_intercept_errors on;\n    error_page  404             /404.html;\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /opt/phpRedisAdmin$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n\n    location ~ /\\. {\n        deny all;\n        error_page  403             /404.html;\n    }\n}\n```\n4）配置连接管理，默认连接的是`6379`端口\n```\n# vim /opt/phpRedisAdmin/includes/config.sample.inc.php\n$config = array(\n  'servers' => array(\n    array(\n      'name'   => 'local server', // Optional name.\n      'host'   => '127.0.0.1',\n      'port'   => 6395,\n      'filter' => '*',\n      'scheme' => 'tcp', // Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket\n      'path'   => '', // Optional. Path to unix domain socket. Uses only if 'scheme' => 'unix'. Example: '/var/run/redis/redis.sock'\n      'auth' => 'jieg6uy5Dach0yooxo1l' // Warning: The password is sent in plain-text to the Redis server.\n    ),\n```\n5）`windows`添加`host`然后访问 `http://www.redis.com`\n![](https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n\n","slug":"phpRedisAdmin搭建","published":1,"updated":"2019-05-17T13:23:21.439Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4h9000cm83487hh8pkf","content":"<blockquote>\n<p>在已有的<code>lnmp</code> 环境下搭建 <code>phpRedisAdmin</code> 由于服务器做了限制，隧道端口转发等都不能使用，导致 <code>RedisDesktopManager</code> 管理工具不能使用，只能通过 <code>phpRedisAdmin</code>来进行管理了。</p>\n</blockquote>\n<p>1）下载软件<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/ErikDubbelboer/phpRedisAdmin.git</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> <span class=\"built_in\">cd</span> phpRedisAdmin</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/nrk/predis.git vendor</span></span><br></pre></td></tr></table></figure></p>\n<p>2）放置到<code>web</code>站点目录<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># cd ..</span></span><br><span class=\"line\"><span class=\"meta\"># mv phpRedisAdmin /opt/</span></span><br><span class=\"line\"><span class=\"meta\"># chown apache.apache phpRedisAdmin/ -R</span></span><br></pre></td></tr></table></figure></p>\n<p>3）编辑<code>nginx</code>配置文件<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim phpRedisAdmin.conf</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span>  www.redis.com;</span><br><span class=\"line\">    <span class=\"attribute\">autoindex</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">error_log</span>  logs/redis_error.log <span class=\"literal\">error</span>;</span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> logs/redis_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /opt/phpRedisAdmin;</span><br><span class=\"line\">        <span class=\"attribute\">index</span>  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_intercept_errors</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">error_page</span>  <span class=\"number\">404</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ \\.php$</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span>           html;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_pass</span>   <span class=\"number\">127.0.0.1:9000</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_index</span>  index.php;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_param</span>  SCRIPT_FILENAME  /opt/phpRedisAdmin<span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">        <span class=\"attribute\">include</span>        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ /\\.</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">        <span class=\"attribute\">error_page</span>  <span class=\"number\">403</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>4）配置连接管理，默认连接的是<code>6379</code>端口<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /opt/phpRedisAdmin/includes/config.sample.inc.php</span></span><br><span class=\"line\">$config = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">  <span class=\"string\">'servers'</span> =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"keyword\">array</span>(</span><br><span class=\"line\">      <span class=\"string\">'name'</span>   =&gt; <span class=\"string\">'local server'</span>, <span class=\"comment\">// Optional name.</span></span><br><span class=\"line\">      <span class=\"string\">'host'</span>   =&gt; <span class=\"string\">'127.0.0.1'</span>,</span><br><span class=\"line\">      <span class=\"string\">'port'</span>   =&gt; <span class=\"number\">6395</span>,</span><br><span class=\"line\">      <span class=\"string\">'filter'</span> =&gt; <span class=\"string\">'*'</span>,</span><br><span class=\"line\">      <span class=\"string\">'scheme'</span> =&gt; <span class=\"string\">'tcp'</span>, <span class=\"comment\">// Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket</span></span><br><span class=\"line\">      <span class=\"string\">'path'</span>   =&gt; <span class=\"string\">''</span>, <span class=\"comment\">// Optional. Path to unix domain socket. Uses only if 'scheme' =&gt; 'unix'. Example: '/var/run/redis/redis.sock'</span></span><br><span class=\"line\">      <span class=\"string\">'auth'</span> =&gt; <span class=\"string\">'jieg6uy5Dach0yooxo1l'</span> <span class=\"comment\">// Warning: The password is sent in plain-text to the Redis server.</span></span><br><span class=\"line\">    ),</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>windows</code>添加<code>host</code>然后访问 <code>http://www.redis.com</code><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>在已有的<code>lnmp</code> 环境下搭建 <code>phpRedisAdmin</code> 由于服务器做了限制，隧道端口转发等都不能使用，导致 <code>RedisDesktopManager</code> 管理工具不能使用，只能通过 <code>phpRedisAdmin</code>来进行管理了。</p>\n</blockquote>\n<p>1）下载软件<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/ErikDubbelboer/phpRedisAdmin.git</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> <span class=\"built_in\">cd</span> phpRedisAdmin</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git <span class=\"built_in\">clone</span> https://github.com/nrk/predis.git vendor</span></span><br></pre></td></tr></table></figure></p>\n<p>2）放置到<code>web</code>站点目录<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># cd ..</span></span><br><span class=\"line\"><span class=\"meta\"># mv phpRedisAdmin /opt/</span></span><br><span class=\"line\"><span class=\"meta\"># chown apache.apache phpRedisAdmin/ -R</span></span><br></pre></td></tr></table></figure></p>\n<p>3）编辑<code>nginx</code>配置文件<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim phpRedisAdmin.conf</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span>  www.redis.com;</span><br><span class=\"line\">    <span class=\"attribute\">autoindex</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">error_log</span>  logs/redis_error.log <span class=\"literal\">error</span>;</span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> logs/redis_access.log main;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /opt/phpRedisAdmin;</span><br><span class=\"line\">        <span class=\"attribute\">index</span>  index.php index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_intercept_errors</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">error_page</span>  <span class=\"number\">404</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ \\.php$</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span>           html;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_pass</span>   <span class=\"number\">127.0.0.1:9000</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_index</span>  index.php;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_param</span>  SCRIPT_FILENAME  /opt/phpRedisAdmin<span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">        <span class=\"attribute\">include</span>        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ /\\.</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">        <span class=\"attribute\">error_page</span>  <span class=\"number\">403</span>             /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>4）配置连接管理，默认连接的是<code>6379</code>端口<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /opt/phpRedisAdmin/includes/config.sample.inc.php</span></span><br><span class=\"line\">$config = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">  <span class=\"string\">'servers'</span> =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"keyword\">array</span>(</span><br><span class=\"line\">      <span class=\"string\">'name'</span>   =&gt; <span class=\"string\">'local server'</span>, <span class=\"comment\">// Optional name.</span></span><br><span class=\"line\">      <span class=\"string\">'host'</span>   =&gt; <span class=\"string\">'127.0.0.1'</span>,</span><br><span class=\"line\">      <span class=\"string\">'port'</span>   =&gt; <span class=\"number\">6395</span>,</span><br><span class=\"line\">      <span class=\"string\">'filter'</span> =&gt; <span class=\"string\">'*'</span>,</span><br><span class=\"line\">      <span class=\"string\">'scheme'</span> =&gt; <span class=\"string\">'tcp'</span>, <span class=\"comment\">// Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket</span></span><br><span class=\"line\">      <span class=\"string\">'path'</span>   =&gt; <span class=\"string\">''</span>, <span class=\"comment\">// Optional. Path to unix domain socket. Uses only if 'scheme' =&gt; 'unix'. Example: '/var/run/redis/redis.sock'</span></span><br><span class=\"line\">      <span class=\"string\">'auth'</span> =&gt; <span class=\"string\">'jieg6uy5Dach0yooxo1l'</span> <span class=\"comment\">// Warning: The password is sent in plain-text to the Redis server.</span></span><br><span class=\"line\">    ),</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>windows</code>添加<code>host</code>然后访问 <code>http://www.redis.com</code><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n"},{"title":"Ansible  Module","date":"2019-05-27T15:25:22.000Z","copyright":true,"_content":"## Ansible Ad-hoc模式常用模块\nansible-doc 常用命令\n```\n# ansible-doc -h\nUsage: ansible-doc [-l|-F|-s] [options] [-t <plugin type> ] [plugin]\n-j  以json格式显示所有模块信息\n-l  列出所有的模块\n-s  查看模块常用参数\n# 直接跟模块名，显示模块所有信息\n\n[root@ansible ~]# ansible-doc -j\n[root@ansible ~]# ansible-doc -l\n[root@ansible ~]# ansible-doc -l |wc -l   #统计所有模块个数，ansible2.8共计2834个模块\n2834\n```\n### 命令相关的模块\n#### command\n>`ansible`默认的模块,执行命令，注意：shell中的`\"<\"`, `\">\"`, `\"|\"`, `\";\"`, `\"&\"`,`\"$\"`等特殊字符不能在`command`模块中使用，如果需要使用，则用`shell`模块\n\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s command\n\n# 在192.168.1.31服务器上面执行ls命令，默认是在当前用户的家目录/root\n[root@ansible ~]# ansible 192.168.1.31 -a 'ls'\n\n# chdir  先切换工作目录，再执行后面的命令，一般情况下在编译时候使用\n[root@ansible ~]# ansible 192.168.1.31 -a 'chdir=/tmp pwd'\n192.168.1.31 | CHANGED | rc=0 >>\n/tmp\n\n# creates  如果creates的文件存在，则执行后面的操作\n[root@ansible ~]# ansible 192.168.1.31 -a 'creates=/tmp ls /etc/passwd'    #tmp目录存在，则不执行后面的ls命令\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp exists\n[root@ansible ~]# ansible 192.168.1.31 -a 'creates=/tmp11 ls /etc/passwd'    # tmp11文件不存在，则执行后面的ls命令\n192.168.1.31 | CHANGED | rc=0 >>\n/etc/passwd\n\n# removes  和creates相反，如果removes的文件存在，才执行后面的操作\n[root@ansible ~]# ansible 192.168.1.31 -a 'removes=/tmp ls /etc/passwd'    #tmp文件存在，则执行了后面的ls命令\n192.168.1.31 | CHANGED | rc=0 >>\n/etc/passwd\n[root@ansible ~]# ansible 192.168.1.31 -a 'removes=/tmp11 ls /etc/passwd'  #tmp11文件不存在，则没有执行后面的ls命令\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp11 does not exist\n```\n#### shell\n>专门用来执行`shell`命令的模块，和`command`模块一样，参数基本一样，都有`chdir,creates,removes`等参数\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s shell\n\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'mkdir /tmp/test'\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'ls /tmp' \n\n#执行下面这条命令，每次执行都会更新文件的时间戳\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'cd /tmp/test && touch 1.txt && ls' \n192.168.1.31 | CHANGED | rc=0 >>\n1.txt\n\n# 由于有时候不想更新文件的创建时间戳，则如果存在就不执行creates\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'creates=/tmp/test/1.txt cd /tmp/test && touch 1.txt && ls'\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp/test/1.txt exists\n```\n#### script\n>用于在被管理机器上面执行`shell`脚本的模块，脚本无需在被管理机器上面存在\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s script\n\n# 编写shell脚本\n[root@ansible ~]# vim ansible_test.sh \n#!/bin/bash\necho `hostname`\n\n# 在所有被管理机器上执行该脚本\n[root@ansible ~]# ansible all -m script -a '/root/ansible_test.sh'\n192.168.1.32 | CHANGED => {\n    \"changed\": true, \n    \"rc\": 0, \n    \"stderr\": \"Shared connection to 192.168.1.32 closed.\\r\\n\", \n    \"stderr_lines\": [\n        \"Shared connection to 192.168.1.32 closed.\"\n    ], \n    \"stdout\": \"linux.node02.com\\r\\n\", \n    \"stdout_lines\": [\n        \"linux.node02.com\"\n    ]\n}\n......\n```\n### 文件相关的模块\n#### file\n>用于对文件的处理，创建，删除，权限控制等\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s file\npath     #要管理的文件路径\nrecurse  #递归\nstate：\n     directory  #创建目录，如果目标不存在则创建目录及其子目录\n     touch      #创建文件，如果文件存在，则修改文件 属性\n     \n     absent     #删除文件或目录\n     mode       #设置文件或目录权限\n     owner      #设置文件或目录属主信息\n     group      #设置文件或目录属组信息\n     link       #创建软连接，需要和src配合使用\n     hard       #创建硬连接，需要和src配合使用\n\n# 创建目录\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test1 state=directory'\n\n# 创建文件\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=touch'\n\n# 建立软链接（src表示源文件，path表示目标文件）\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'src=/tmp/test1 path=/tmp/test3 state=link'\n\n# 删除文件\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=absent'\n\n# 创建文件时同时设置权限等信息\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test4 state=directory mode=775 owner=root group=root'\n```\n#### copy\n> 用于管理端复制文件到远程主机，并可以设置权限，属组，属主等\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s copy\nsrc      #需要copy的文件的源路径\ndest     #需要copy的文件的目标路径\nbackup   #对copy的文件进行备份\ncontent  #直接在远程主机被管理文件中添加内容，会覆盖原文件内容\nmode     #对copy到远端的文件设置权限\nowner    #对copy到远端的文件设置属主\ngroup    #对copy到远端文件设置属组\n\n\n# 复制文件到远程主机并改名\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh'\n\n# 复制文件到远程主机，并备份远程文件,安装时间信息备份文件（当更新文件内容后，重新copy时用到）\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh backup=yes'\n\n# 直接在远程主机a.sh中添加内容\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh content=\"#!/bin/bash\\n echo `uptime`\"'\n\n# 复制文件到远程主机，并设置权限及属主与属组\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/passwd src=/etc/passwd mode=700 owner=root group=root'\n```\n#### fetch\n>用于从被管理机器上面拉取文件，拉取下来的内容会保留目录结构，一般情况用在收集被管理机器的日志文件等\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s fetch\nsrc      #指定需要从远端机器拉取的文件路径\ndest     #指定从远端机器拉取下来的文件存放路径\n\n# 从被管理机器上拉取cron日志文件，默认会已管理节点地址创建一个目录，并存放在内\n[root@ansible ~]# ansible 192.168.1.31 -m fetch -a 'dest=/tmp src=/var/log/cron'\n\n[root@ansible ~]# tree /tmp/192.168.1.31/\n/tmp/192.168.1.31/\n└── var\n    └── log\n        └── cron\n\n2 directories, 1 file\n```\n### 用户相关的模块\n#### user\n>用于对系统用户的管理，用户的创建、删除、家目录、属组等设置\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s user\nname        #指定用户的名字\nhome        #指定用户的家目录\nuid         #指定用户的uid\ngroup       #指定用户的用户组\ngroups      #指定用户的附加组\npassword    #指定用户的密码\nshell       #指定用户的登录shell\ncreate_home #是否创建用户家目录，默认是yes\nremove      #删除用户时，指定是否删除家目录\nstate：\n      absent    #删除用户\n      \n\n# 创建用户名指定家目录，指定uid及组\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=mysql home=/opt/mysql uid=1002 group=root'\n[root@ansible ~]# ansible 192.168.1.31 -m shell  -a 'id mysql && ls -l /opt'\n192.168.1.31 | CHANGED | rc=0 >>\nuid=1002(mysql) gid=0(root) 组=0(root)\n总用量 0\ndrwx------  3 mysql root 78 5月  27 18:13 mysql\n\n# 创建用户，不创建家目录，并且不能登录\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=apache shell=/bin/nologin uid=1003 create_home=no'\n[root@ansible ~]# ansible 192.168.1.31 -m shell  -a 'id apache && tail -1 /etc/passwd'\n192.168.1.31 | CHANGED | rc=0 >>\nuid=1003(apache) gid=1003(apache) 组=1003(apache)\napache:x:1003:1003::/home/apache:/bin/nologin\n\n# 删除用户\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=apache state=absent'\n\n# 删除用户并删除家目录\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=mysql state=absent remove=yes'\n```\n#### group\n>用于创建组，当创建用户时如果需要指定组，组不存在的话就可以通过`group`先创建组\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s group\nname     #指定组的名字\ngid      #指定组的gid\nstate：\n     absent   #删除组\n     present  #创建组（默认的状态）\n\n# 创建组\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www'\n\n# 创建组并指定gid\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www1 gid=1005'\n\n# 删除组\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www1 state=absent'\n```\n### 软件包相关的模块\n#### yum\n>用于对软件包的管理，下载、安装、卸载、升级等操作\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s yum\nname            #指定要操作的软件包名字\ndownload_dir    #指定下载软件包的存放路径，需要配合download_only一起使用\ndownload_only   #只下载软件包，而不进行安装，和yum --downloadonly一样\nlist:\n    installed   #列出所有已安装的软件包\n    updates     #列出所有可以更新的软件包\n    repos       #列出所有的yum仓库\nstate:   \n    installed, present   #安装软件包(两者任选其一都可以)\n    removed, absent      #卸载软件包\n    latest      #安装最新软件包\n    \n# 列出所有已安装的软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=installed'\n\n# 列出所有可更新的软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=updates'\n\n#列出所有的yum仓库\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=repos'\n\n#只下载软件包并到指定目录下\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd download_only=yes download_dir=/tmp'\n\n#安装软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd state=installed'\n\n#卸载软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd state=removed'\n\n#安装包组，类似yum groupinstall 'Development Tools'\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=\"@Development Tools\" state=installed'\n```\n#### pip\n>用于安装python中的包\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s pip\n\n# 使用pip时，需要保证被管理机器上有python-pip软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=python-pip'\n\n# 安装pip包\n[root@ansible ~]# ansible 192.168.1.31 -m pip -a 'name=flask'\n```\n#### service\n>服务模块，用于对服务进行管理，服务的启动、关闭、开机自启等\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s service\nname       #指定需要管理的服务名\nenabled    #指定是否开机自启动\nstate:     #指定服务状态\n    started    #启动服务\n    stopped    #停止服务\n    restarted  #重启服务\n    reloaded   #重载服务\n\n# 启动服务，并设置开机自启动 \n[root@ansible ~]# ansible 192.168.1.31 -m service -a 'name=crond state=started enabled=yes'\n```\n### 计划任务相关的模块\n#### cron\n>用于指定计划任务，和`crontab -e`一样\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s cron\njob     #指定需要执行的任务\nminute   #分钟\nhour     #小时\nday      #天\nmonth    #月\nweekday  #周\nname     #对计划任务进行描述\nstate:\n    absetn   #删除计划任务\n\n\n# 创建一个计划任务，并描述是干嘛用的\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"name='这是一个测试的计划任务' minute=* hour=* day=* month=* weekday=* job='/bin/bash /root/test.sh'\"\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'crontab -l'\n192.168.1.31 | CHANGED | rc=0 >>\n#Ansible: 这是一个测试的计划任务\n* * * * * /bin/bash /root/test.sh\n\n# 创建一个没有带描述的计划任务\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"job='/bin/sh /root/test.sh'\"\n\n# 删除计划任务\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"name='None' job='/bin/sh /root/test.sh' state=absent\"\n```\n### 系统信息相关的模块\n#### setup\n>用于获取系统信息的一个模块\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s setup\n\n# 查看系统所有信息\n[root@ansible ~]# ansible 192.168.1.31 -m setup\n\n# filter 对系统信息进行过滤\n[root@ansible ~]# ansible 192.168.1.31 -m setup -a 'filter=ansible_all_ipv4_addresses'\n\n# 常用的过滤选项\nansible_all_ipv4_addresses         所有的ipv4地址\nansible_all_ipv6_addresses         所有的ipv6地址\nansible_architecture               系统的架构\nansible_date_time                  系统时间\nansible_default_ipv4               系统的默认ipv4地址\nansible_distribution               系统名称\nansible_distribution_file_variety  系统的家族\nansible_distribution_major_version 系统的版本\nansible_domain                     系统所在的域\nansible_fqdn                       系统的主机名\nansible_hostname                   系统的主机名,简写\nansible_os_family                  系统的家族\nansible_processor_cores            cpu的核数\nansible_processor_count            cpu的颗数\nansible_processor_vcpus            cpu的个数\n```","source":"_posts/Ansible Ad-hoc常用Module.md","raw":"---\ntitle: Ansible  Module \ndate: 2019-05-27 23:25:22\ntags: Ansible\ncategories: Ansible\ncopyright: true\n---\n## Ansible Ad-hoc模式常用模块\nansible-doc 常用命令\n```\n# ansible-doc -h\nUsage: ansible-doc [-l|-F|-s] [options] [-t <plugin type> ] [plugin]\n-j  以json格式显示所有模块信息\n-l  列出所有的模块\n-s  查看模块常用参数\n# 直接跟模块名，显示模块所有信息\n\n[root@ansible ~]# ansible-doc -j\n[root@ansible ~]# ansible-doc -l\n[root@ansible ~]# ansible-doc -l |wc -l   #统计所有模块个数，ansible2.8共计2834个模块\n2834\n```\n### 命令相关的模块\n#### command\n>`ansible`默认的模块,执行命令，注意：shell中的`\"<\"`, `\">\"`, `\"|\"`, `\";\"`, `\"&\"`,`\"$\"`等特殊字符不能在`command`模块中使用，如果需要使用，则用`shell`模块\n\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s command\n\n# 在192.168.1.31服务器上面执行ls命令，默认是在当前用户的家目录/root\n[root@ansible ~]# ansible 192.168.1.31 -a 'ls'\n\n# chdir  先切换工作目录，再执行后面的命令，一般情况下在编译时候使用\n[root@ansible ~]# ansible 192.168.1.31 -a 'chdir=/tmp pwd'\n192.168.1.31 | CHANGED | rc=0 >>\n/tmp\n\n# creates  如果creates的文件存在，则执行后面的操作\n[root@ansible ~]# ansible 192.168.1.31 -a 'creates=/tmp ls /etc/passwd'    #tmp目录存在，则不执行后面的ls命令\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp exists\n[root@ansible ~]# ansible 192.168.1.31 -a 'creates=/tmp11 ls /etc/passwd'    # tmp11文件不存在，则执行后面的ls命令\n192.168.1.31 | CHANGED | rc=0 >>\n/etc/passwd\n\n# removes  和creates相反，如果removes的文件存在，才执行后面的操作\n[root@ansible ~]# ansible 192.168.1.31 -a 'removes=/tmp ls /etc/passwd'    #tmp文件存在，则执行了后面的ls命令\n192.168.1.31 | CHANGED | rc=0 >>\n/etc/passwd\n[root@ansible ~]# ansible 192.168.1.31 -a 'removes=/tmp11 ls /etc/passwd'  #tmp11文件不存在，则没有执行后面的ls命令\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp11 does not exist\n```\n#### shell\n>专门用来执行`shell`命令的模块，和`command`模块一样，参数基本一样，都有`chdir,creates,removes`等参数\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s shell\n\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'mkdir /tmp/test'\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'ls /tmp' \n\n#执行下面这条命令，每次执行都会更新文件的时间戳\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'cd /tmp/test && touch 1.txt && ls' \n192.168.1.31 | CHANGED | rc=0 >>\n1.txt\n\n# 由于有时候不想更新文件的创建时间戳，则如果存在就不执行creates\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'creates=/tmp/test/1.txt cd /tmp/test && touch 1.txt && ls'\n192.168.1.31 | SUCCESS | rc=0 >>\nskipped, since /tmp/test/1.txt exists\n```\n#### script\n>用于在被管理机器上面执行`shell`脚本的模块，脚本无需在被管理机器上面存在\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s script\n\n# 编写shell脚本\n[root@ansible ~]# vim ansible_test.sh \n#!/bin/bash\necho `hostname`\n\n# 在所有被管理机器上执行该脚本\n[root@ansible ~]# ansible all -m script -a '/root/ansible_test.sh'\n192.168.1.32 | CHANGED => {\n    \"changed\": true, \n    \"rc\": 0, \n    \"stderr\": \"Shared connection to 192.168.1.32 closed.\\r\\n\", \n    \"stderr_lines\": [\n        \"Shared connection to 192.168.1.32 closed.\"\n    ], \n    \"stdout\": \"linux.node02.com\\r\\n\", \n    \"stdout_lines\": [\n        \"linux.node02.com\"\n    ]\n}\n......\n```\n### 文件相关的模块\n#### file\n>用于对文件的处理，创建，删除，权限控制等\n\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s file\npath     #要管理的文件路径\nrecurse  #递归\nstate：\n     directory  #创建目录，如果目标不存在则创建目录及其子目录\n     touch      #创建文件，如果文件存在，则修改文件 属性\n     \n     absent     #删除文件或目录\n     mode       #设置文件或目录权限\n     owner      #设置文件或目录属主信息\n     group      #设置文件或目录属组信息\n     link       #创建软连接，需要和src配合使用\n     hard       #创建硬连接，需要和src配合使用\n\n# 创建目录\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test1 state=directory'\n\n# 创建文件\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=touch'\n\n# 建立软链接（src表示源文件，path表示目标文件）\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'src=/tmp/test1 path=/tmp/test3 state=link'\n\n# 删除文件\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=absent'\n\n# 创建文件时同时设置权限等信息\n[root@ansible ~]# ansible 192.168.1.31 -m file -a 'path=/tmp/test4 state=directory mode=775 owner=root group=root'\n```\n#### copy\n> 用于管理端复制文件到远程主机，并可以设置权限，属组，属主等\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s copy\nsrc      #需要copy的文件的源路径\ndest     #需要copy的文件的目标路径\nbackup   #对copy的文件进行备份\ncontent  #直接在远程主机被管理文件中添加内容，会覆盖原文件内容\nmode     #对copy到远端的文件设置权限\nowner    #对copy到远端的文件设置属主\ngroup    #对copy到远端文件设置属组\n\n\n# 复制文件到远程主机并改名\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh'\n\n# 复制文件到远程主机，并备份远程文件,安装时间信息备份文件（当更新文件内容后，重新copy时用到）\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh backup=yes'\n\n# 直接在远程主机a.sh中添加内容\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh content=\"#!/bin/bash\\n echo `uptime`\"'\n\n# 复制文件到远程主机，并设置权限及属主与属组\n[root@ansible ~]# ansible 192.168.1.31 -m copy -a 'dest=/tmp/passwd src=/etc/passwd mode=700 owner=root group=root'\n```\n#### fetch\n>用于从被管理机器上面拉取文件，拉取下来的内容会保留目录结构，一般情况用在收集被管理机器的日志文件等\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s fetch\nsrc      #指定需要从远端机器拉取的文件路径\ndest     #指定从远端机器拉取下来的文件存放路径\n\n# 从被管理机器上拉取cron日志文件，默认会已管理节点地址创建一个目录，并存放在内\n[root@ansible ~]# ansible 192.168.1.31 -m fetch -a 'dest=/tmp src=/var/log/cron'\n\n[root@ansible ~]# tree /tmp/192.168.1.31/\n/tmp/192.168.1.31/\n└── var\n    └── log\n        └── cron\n\n2 directories, 1 file\n```\n### 用户相关的模块\n#### user\n>用于对系统用户的管理，用户的创建、删除、家目录、属组等设置\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s user\nname        #指定用户的名字\nhome        #指定用户的家目录\nuid         #指定用户的uid\ngroup       #指定用户的用户组\ngroups      #指定用户的附加组\npassword    #指定用户的密码\nshell       #指定用户的登录shell\ncreate_home #是否创建用户家目录，默认是yes\nremove      #删除用户时，指定是否删除家目录\nstate：\n      absent    #删除用户\n      \n\n# 创建用户名指定家目录，指定uid及组\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=mysql home=/opt/mysql uid=1002 group=root'\n[root@ansible ~]# ansible 192.168.1.31 -m shell  -a 'id mysql && ls -l /opt'\n192.168.1.31 | CHANGED | rc=0 >>\nuid=1002(mysql) gid=0(root) 组=0(root)\n总用量 0\ndrwx------  3 mysql root 78 5月  27 18:13 mysql\n\n# 创建用户，不创建家目录，并且不能登录\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=apache shell=/bin/nologin uid=1003 create_home=no'\n[root@ansible ~]# ansible 192.168.1.31 -m shell  -a 'id apache && tail -1 /etc/passwd'\n192.168.1.31 | CHANGED | rc=0 >>\nuid=1003(apache) gid=1003(apache) 组=1003(apache)\napache:x:1003:1003::/home/apache:/bin/nologin\n\n# 删除用户\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=apache state=absent'\n\n# 删除用户并删除家目录\n[root@ansible ~]# ansible 192.168.1.31 -m user -a 'name=mysql state=absent remove=yes'\n```\n#### group\n>用于创建组，当创建用户时如果需要指定组，组不存在的话就可以通过`group`先创建组\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s group\nname     #指定组的名字\ngid      #指定组的gid\nstate：\n     absent   #删除组\n     present  #创建组（默认的状态）\n\n# 创建组\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www'\n\n# 创建组并指定gid\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www1 gid=1005'\n\n# 删除组\n[root@ansible ~]# ansible 192.168.1.31 -m group -a 'name=www1 state=absent'\n```\n### 软件包相关的模块\n#### yum\n>用于对软件包的管理，下载、安装、卸载、升级等操作\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s yum\nname            #指定要操作的软件包名字\ndownload_dir    #指定下载软件包的存放路径，需要配合download_only一起使用\ndownload_only   #只下载软件包，而不进行安装，和yum --downloadonly一样\nlist:\n    installed   #列出所有已安装的软件包\n    updates     #列出所有可以更新的软件包\n    repos       #列出所有的yum仓库\nstate:   \n    installed, present   #安装软件包(两者任选其一都可以)\n    removed, absent      #卸载软件包\n    latest      #安装最新软件包\n    \n# 列出所有已安装的软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=installed'\n\n# 列出所有可更新的软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=updates'\n\n#列出所有的yum仓库\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'list=repos'\n\n#只下载软件包并到指定目录下\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd download_only=yes download_dir=/tmp'\n\n#安装软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd state=installed'\n\n#卸载软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=httpd state=removed'\n\n#安装包组，类似yum groupinstall 'Development Tools'\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=\"@Development Tools\" state=installed'\n```\n#### pip\n>用于安装python中的包\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s pip\n\n# 使用pip时，需要保证被管理机器上有python-pip软件包\n[root@ansible ~]# ansible 192.168.1.31 -m yum -a 'name=python-pip'\n\n# 安装pip包\n[root@ansible ~]# ansible 192.168.1.31 -m pip -a 'name=flask'\n```\n#### service\n>服务模块，用于对服务进行管理，服务的启动、关闭、开机自启等\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s service\nname       #指定需要管理的服务名\nenabled    #指定是否开机自启动\nstate:     #指定服务状态\n    started    #启动服务\n    stopped    #停止服务\n    restarted  #重启服务\n    reloaded   #重载服务\n\n# 启动服务，并设置开机自启动 \n[root@ansible ~]# ansible 192.168.1.31 -m service -a 'name=crond state=started enabled=yes'\n```\n### 计划任务相关的模块\n#### cron\n>用于指定计划任务，和`crontab -e`一样\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s cron\njob     #指定需要执行的任务\nminute   #分钟\nhour     #小时\nday      #天\nmonth    #月\nweekday  #周\nname     #对计划任务进行描述\nstate:\n    absetn   #删除计划任务\n\n\n# 创建一个计划任务，并描述是干嘛用的\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"name='这是一个测试的计划任务' minute=* hour=* day=* month=* weekday=* job='/bin/bash /root/test.sh'\"\n[root@ansible ~]# ansible 192.168.1.31 -m shell -a 'crontab -l'\n192.168.1.31 | CHANGED | rc=0 >>\n#Ansible: 这是一个测试的计划任务\n* * * * * /bin/bash /root/test.sh\n\n# 创建一个没有带描述的计划任务\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"job='/bin/sh /root/test.sh'\"\n\n# 删除计划任务\n[root@ansible ~]# ansible 192.168.1.31 -m cron -a \"name='None' job='/bin/sh /root/test.sh' state=absent\"\n```\n### 系统信息相关的模块\n#### setup\n>用于获取系统信息的一个模块\n```\n# 查看模块参数\n[root@ansible ~]# ansible-doc -s setup\n\n# 查看系统所有信息\n[root@ansible ~]# ansible 192.168.1.31 -m setup\n\n# filter 对系统信息进行过滤\n[root@ansible ~]# ansible 192.168.1.31 -m setup -a 'filter=ansible_all_ipv4_addresses'\n\n# 常用的过滤选项\nansible_all_ipv4_addresses         所有的ipv4地址\nansible_all_ipv6_addresses         所有的ipv6地址\nansible_architecture               系统的架构\nansible_date_time                  系统时间\nansible_default_ipv4               系统的默认ipv4地址\nansible_distribution               系统名称\nansible_distribution_file_variety  系统的家族\nansible_distribution_major_version 系统的版本\nansible_domain                     系统所在的域\nansible_fqdn                       系统的主机名\nansible_hostname                   系统的主机名,简写\nansible_os_family                  系统的家族\nansible_processor_cores            cpu的核数\nansible_processor_count            cpu的颗数\nansible_processor_vcpus            cpu的个数\n```","slug":"Ansible Ad-hoc常用Module","published":1,"updated":"2019-05-27T15:31:42.995Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4l5000wm834ee27bzve","content":"<h2 id=\"Ansible-Ad-hoc模式常用模块\"><a href=\"#Ansible-Ad-hoc模式常用模块\" class=\"headerlink\" title=\"Ansible Ad-hoc模式常用模块\"></a>Ansible Ad-hoc模式常用模块</h2><p>ansible-doc 常用命令<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ansible-doc -h</span></span><br><span class=\"line\"><span class=\"symbol\">Usage:</span> ansible-doc [-l<span class=\"params\">|-F|</span>-s] [options] [-t &lt;plugin type&gt; ] [plugin]</span><br><span class=\"line\">-j  以json格式显示所有模块信息</span><br><span class=\"line\">-l  列出所有的模块</span><br><span class=\"line\">-s  查看模块常用参数</span><br><span class=\"line\"><span class=\"comment\"># 直接跟模块名，显示模块所有信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -j</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -l</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -l |wc -l   #统计所有模块个数，ansible2.8共计2834个模块</span></span><br><span class=\"line\"><span class=\"number\">2834</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"命令相关的模块\"><a href=\"#命令相关的模块\" class=\"headerlink\" title=\"命令相关的模块\"></a>命令相关的模块</h3><h4 id=\"command\"><a href=\"#command\" class=\"headerlink\" title=\"command\"></a>command</h4><blockquote>\n<p><code>ansible</code>默认的模块,执行命令，注意：shell中的<code>&quot;&lt;&quot;</code>, <code>&quot;&gt;&quot;</code>, <code>&quot;|&quot;</code>, <code>&quot;;&quot;</code>, <code>&quot;&amp;&quot;</code>,<code>&quot;$&quot;</code>等特殊字符不能在<code>command</code>模块中使用，如果需要使用，则用<code>shell</code>模块</p>\n</blockquote>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看模块参数</span><br><span class=\"line\">[root@ansible ~]# ansible-doc -s command</span><br><span class=\"line\"></span><br><span class=\"line\"># 在<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span>服务器上面执行ls命令，默认是在当前用户的家目录/root</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'ls'</span><br><span class=\"line\"></span><br><span class=\"line\"># chdir  先切换工作目录，再执行后面的命令，一般情况下在编译时候使用</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'chdir=/tmp pwd'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/tmp</span><br><span class=\"line\"></span><br><span class=\"line\"># creates  如果creates的文件存在，则执行后面的操作</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'creates=/tmp ls /etc/passwd'    #tmp目录存在，则不执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp exists</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'creates=/tmp11 ls /etc/passwd'    # tmp11文件不存在，则执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/etc/passwd</span><br><span class=\"line\"></span><br><span class=\"line\"># removes  和creates相反，如果removes的文件存在，才执行后面的操作</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'removes=/tmp ls /etc/passwd'    #tmp文件存在，则执行了后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/etc/passwd</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'removes=/tmp11 ls /etc/passwd'  #tmp11文件不存在，则没有执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp11 does not exist</span><br></pre></td></tr></table></figure>\n<h4 id=\"shell\"><a href=\"#shell\" class=\"headerlink\" title=\"shell\"></a>shell</h4><blockquote>\n<p>专门用来执行<code>shell</code>命令的模块，和<code>command</code>模块一样，参数基本一样，都有<code>chdir,creates,removes</code>等参数</p>\n</blockquote>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看模块参数</span><br><span class=\"line\">[root@ansible ~]# ansible-doc -s shell</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'mkdir /tmp/test'</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'ls /tmp' </span><br><span class=\"line\"></span><br><span class=\"line\">#执行下面这条命令，每次执行都会更新文件的时间戳</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'cd /tmp/test &amp;&amp; <span class=\"section\">touch</span> <span class=\"number\">1.</span>txt &amp;&amp; ls' </span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\"><span class=\"number\">1.</span>txt</span><br><span class=\"line\"></span><br><span class=\"line\"># 由于有时候不想更新文件的创建时间戳，则如果存在就不执行creates</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'creates=/tmp/test/<span class=\"number\">1.</span>txt cd /tmp/test &amp;&amp; <span class=\"section\">touch</span> <span class=\"number\">1.</span>txt &amp;&amp; ls'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp/test/<span class=\"number\">1.</span>txt exists</span><br></pre></td></tr></table></figure>\n<h4 id=\"script\"><a href=\"#script\" class=\"headerlink\" title=\"script\"></a>script</h4><blockquote>\n<p>用于在被管理机器上面执行<code>shell</code>脚本的模块，脚本无需在被管理机器上面存在</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s script</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编写shell脚本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># vim ansible_test.sh </span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> `hostname`</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在所有被管理机器上执行该脚本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible all -m script -a '/root/ansible_test.sh'</span></span><br><span class=\"line\">192.168.1.32 | CHANGED =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">true</span>, </span><br><span class=\"line\">    <span class=\"string\">\"rc\"</span>: 0, </span><br><span class=\"line\">    <span class=\"string\">\"stderr\"</span>: <span class=\"string\">\"Shared connection to 192.168.1.32 closed.\\r\\n\"</span>, </span><br><span class=\"line\">    <span class=\"string\">\"stderr_lines\"</span>: [</span><br><span class=\"line\">        <span class=\"string\">\"Shared connection to 192.168.1.32 closed.\"</span></span><br><span class=\"line\">    ], </span><br><span class=\"line\">    <span class=\"string\">\"stdout\"</span>: <span class=\"string\">\"linux.node02.com\\r\\n\"</span>, </span><br><span class=\"line\">    <span class=\"string\">\"stdout_lines\"</span>: [</span><br><span class=\"line\">        <span class=\"string\">\"linux.node02.com\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">......</span><br></pre></td></tr></table></figure>\n<h3 id=\"文件相关的模块\"><a href=\"#文件相关的模块\" class=\"headerlink\" title=\"文件相关的模块\"></a>文件相关的模块</h3><h4 id=\"file\"><a href=\"#file\" class=\"headerlink\" title=\"file\"></a>file</h4><blockquote>\n<p>用于对文件的处理，创建，删除，权限控制等</p>\n</blockquote>\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s file</span></span><br><span class=\"line\">path     <span class=\"comment\">#要管理的文件路径</span></span><br><span class=\"line\">recurse  <span class=\"comment\">#递归</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>：</span><br><span class=\"line\">     directory  <span class=\"comment\">#创建目录，如果目标不存在则创建目录及其子目录</span></span><br><span class=\"line\">     touch      <span class=\"comment\">#创建文件，如果文件存在，则修改文件 属性</span></span><br><span class=\"line\">     </span><br><span class=\"line\">     absent     <span class=\"comment\">#删除文件或目录</span></span><br><span class=\"line\">     mode       <span class=\"comment\">#设置文件或目录权限</span></span><br><span class=\"line\">     owner      <span class=\"comment\">#设置文件或目录属主信息</span></span><br><span class=\"line\">     group      <span class=\"comment\">#设置文件或目录属组信息</span></span><br><span class=\"line\">     <span class=\"keyword\">link</span>       <span class=\"comment\">#创建软连接，需要和src配合使用</span></span><br><span class=\"line\">     hard       <span class=\"comment\">#创建硬连接，需要和src配合使用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建目录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test1 state=directory'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建文件</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=touch'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 建立软链接（src表示源文件，path表示目标文件）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'src=/tmp/test1 path=/tmp/test3 state=link'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除文件</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=absent'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建文件时同时设置权限等信息</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test4 state=directory mode=775 owner=root group=root'</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"copy\"><a href=\"#copy\" class=\"headerlink\" title=\"copy\"></a>copy</h4><blockquote>\n<p>用于管理端复制文件到远程主机，并可以设置权限，属组，属主等<br><figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s copy</span></span><br><span class=\"line\">src      <span class=\"comment\">#需要copy的文件的源路径</span></span><br><span class=\"line\">dest     <span class=\"comment\">#需要copy的文件的目标路径</span></span><br><span class=\"line\">backup   <span class=\"comment\">#对copy的文件进行备份</span></span><br><span class=\"line\">content  <span class=\"comment\">#直接在远程主机被管理文件中添加内容，会覆盖原文件内容</span></span><br><span class=\"line\">mode     <span class=\"comment\">#对copy到远端的文件设置权限</span></span><br><span class=\"line\">owner    <span class=\"comment\">#对copy到远端的文件设置属主</span></span><br><span class=\"line\">group    <span class=\"comment\">#对copy到远端文件设置属组</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机并改名</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机，并备份远程文件,安装时间信息备份文件（当更新文件内容后，重新copy时用到）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh backup=yes'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 直接在远程主机a.sh中添加内容</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh content=\"#!/bin/bash\\n echo `uptime`\"'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机，并设置权限及属主与属组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/passwd src=/etc/passwd mode=700 owner=root group=root'</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"fetch\"><a href=\"#fetch\" class=\"headerlink\" title=\"fetch\"></a>fetch</h4><blockquote>\n<p>用于从被管理机器上面拉取文件，拉取下来的内容会保留目录结构，一般情况用在收集被管理机器的日志文件等<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s fetch</span></span><br><span class=\"line\">src      <span class=\"comment\">#指定需要从远端机器拉取的文件路径</span></span><br><span class=\"line\">dest     <span class=\"comment\">#指定从远端机器拉取下来的文件存放路径</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从被管理机器上拉取cron日志文件，默认会已管理节点地址创建一个目录，并存放在内</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m fetch -a 'dest=/tmp src=/var/log/cron'</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># tree /tmp/192.168.1.31/</span></span><br><span class=\"line\"><span class=\"regexp\">/tmp/192.168.1.31/</span></span><br><span class=\"line\">└── <span class=\"keyword\">var</span></span><br><span class=\"line\">    └── log</span><br><span class=\"line\">        └── cron</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span> directories, <span class=\"number\">1</span> file</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"用户相关的模块\"><a href=\"#用户相关的模块\" class=\"headerlink\" title=\"用户相关的模块\"></a>用户相关的模块</h3><h4 id=\"user\"><a href=\"#user\" class=\"headerlink\" title=\"user\"></a>user</h4><blockquote>\n<p>用于对系统用户的管理，用户的创建、删除、家目录、属组等设置<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s user</span></span><br><span class=\"line\">name        <span class=\"comment\">#指定用户的名字</span></span><br><span class=\"line\">home        <span class=\"comment\">#指定用户的家目录</span></span><br><span class=\"line\">uid         <span class=\"comment\">#指定用户的uid</span></span><br><span class=\"line\">group       <span class=\"comment\">#指定用户的用户组</span></span><br><span class=\"line\">groups      <span class=\"comment\">#指定用户的附加组</span></span><br><span class=\"line\">password    <span class=\"comment\">#指定用户的密码</span></span><br><span class=\"line\">shell       <span class=\"comment\">#指定用户的登录shell</span></span><br><span class=\"line\">create_home <span class=\"comment\">#是否创建用户家目录，默认是yes</span></span><br><span class=\"line\">remove      <span class=\"comment\">#删除用户时，指定是否删除家目录</span></span><br><span class=\"line\">state：</span><br><span class=\"line\">      absent    <span class=\"comment\">#删除用户</span></span><br><span class=\"line\">      </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建用户名指定家目录，指定uid及组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=mysql home=/opt/mysql uid=1002 group=root'</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell  -a 'id mysql &amp;&amp; ls -l /opt'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\">uid=<span class=\"number\">1002</span>(mysql) gid=<span class=\"number\">0</span>(root) 组=<span class=\"number\">0</span>(root)</span><br><span class=\"line\">总用量 <span class=\"number\">0</span></span><br><span class=\"line\">drwx------  <span class=\"number\">3</span> mysql root <span class=\"number\">78</span> <span class=\"number\">5</span>月  <span class=\"number\">27</span> <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">13</span> mysql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建用户，不创建家目录，并且不能登录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=apache shell=/bin/nologin uid=1003 create_home=no'</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell  -a 'id apache &amp;&amp; tail -1 /etc/passwd'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\">uid=<span class=\"number\">1003</span>(apache) gid=<span class=\"number\">1003</span>(apache) 组=<span class=\"number\">1003</span>(apache)</span><br><span class=\"line\"><span class=\"symbol\">apache:</span><span class=\"symbol\">x:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/apache</span><span class=\"symbol\">:/bin/nologin</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除用户</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=apache state=absent'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除用户并删除家目录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=mysql state=absent remove=yes'</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"group\"><a href=\"#group\" class=\"headerlink\" title=\"group\"></a>group</h4><blockquote>\n<p>用于创建组，当创建用户时如果需要指定组，组不存在的话就可以通过<code>group</code>先创建组<br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s group</span></span><br><span class=\"line\">name     <span class=\"comment\">#指定组的名字</span></span><br><span class=\"line\">gid      <span class=\"comment\">#指定组的gid</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>：</span><br><span class=\"line\">     absent   <span class=\"comment\">#删除组</span></span><br><span class=\"line\">     present  <span class=\"comment\">#创建组（默认的状态）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建组并指定gid</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www1 gid=1005'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www1 state=absent'</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"软件包相关的模块\"><a href=\"#软件包相关的模块\" class=\"headerlink\" title=\"软件包相关的模块\"></a>软件包相关的模块</h3><h4 id=\"yum\"><a href=\"#yum\" class=\"headerlink\" title=\"yum\"></a>yum</h4><blockquote>\n<p>用于对软件包的管理，下载、安装、卸载、升级等操作<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s yum</span></span><br><span class=\"line\">name            <span class=\"meta\">#指定要操作的软件包名字</span></span><br><span class=\"line\">download_dir    <span class=\"meta\">#指定下载软件包的存放路径，需要配合download_only一起使用</span></span><br><span class=\"line\">download_only   <span class=\"meta\">#只下载软件包，而不进行安装，和yum --downloadonly一样</span></span><br><span class=\"line\">list:</span><br><span class=\"line\">    installed   <span class=\"meta\">#列出所有已安装的软件包</span></span><br><span class=\"line\">    updates     <span class=\"meta\">#列出所有可以更新的软件包</span></span><br><span class=\"line\">    repos       <span class=\"meta\">#列出所有的yum仓库</span></span><br><span class=\"line\">state:   </span><br><span class=\"line\">    installed, present   <span class=\"meta\">#安装软件包(两者任选其一都可以)</span></span><br><span class=\"line\">    removed, absent      <span class=\"meta\">#卸载软件包</span></span><br><span class=\"line\">    latest      <span class=\"meta\">#安装最新软件包</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\"># 列出所有已安装的软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=installed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 列出所有可更新的软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=updates'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#列出所有的yum仓库</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=repos'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#只下载软件包并到指定目录下</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd download_only=yes download_dir=/tmp'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd state=installed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#卸载软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd state=removed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装包组，类似yum groupinstall <span class=\"string\">'Development Tools'</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=\"@Development Tools\" state=installed'</span></span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"pip\"><a href=\"#pip\" class=\"headerlink\" title=\"pip\"></a>pip</h4><blockquote>\n<p>用于安装python中的包<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s pip</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 使用pip时，需要保证被管理机器上有python-pip软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=python-pip'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 安装pip包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m pip -a <span class=\"string\">'name=flask'</span></span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"service\"><a href=\"#service\" class=\"headerlink\" title=\"service\"></a>service</h4><blockquote>\n<p>服务模块，用于对服务进行管理，服务的启动、关闭、开机自启等<br><figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s service</span></span><br><span class=\"line\">name       <span class=\"comment\">#指定需要管理的服务名</span></span><br><span class=\"line\">enabled    <span class=\"comment\">#指定是否开机自启动</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>:     <span class=\"comment\">#指定服务状态</span></span><br><span class=\"line\">    started    <span class=\"comment\">#启动服务</span></span><br><span class=\"line\">    stopped    <span class=\"comment\">#停止服务</span></span><br><span class=\"line\">    restarted  <span class=\"comment\">#重启服务</span></span><br><span class=\"line\">    reloaded   <span class=\"comment\">#重载服务</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动服务，并设置开机自启动 </span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m service -a 'name=crond state=started enabled=yes'</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"计划任务相关的模块\"><a href=\"#计划任务相关的模块\" class=\"headerlink\" title=\"计划任务相关的模块\"></a>计划任务相关的模块</h3><h4 id=\"cron\"><a href=\"#cron\" class=\"headerlink\" title=\"cron\"></a>cron</h4><blockquote>\n<p>用于指定计划任务，和<code>crontab -e</code>一样<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s cron</span></span><br><span class=\"line\">job     <span class=\"comment\">#指定需要执行的任务</span></span><br><span class=\"line\">minute   <span class=\"comment\">#分钟</span></span><br><span class=\"line\">hour     <span class=\"comment\">#小时</span></span><br><span class=\"line\">day      <span class=\"comment\">#天</span></span><br><span class=\"line\">month    <span class=\"comment\">#月</span></span><br><span class=\"line\">weekday  <span class=\"comment\">#周</span></span><br><span class=\"line\">name     <span class=\"comment\">#对计划任务进行描述</span></span><br><span class=\"line\"><span class=\"symbol\">state:</span></span><br><span class=\"line\">    absetn   <span class=\"comment\">#删除计划任务</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个计划任务，并描述是干嘛用的</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"name='这是一个测试的计划任务' minute=* hour=* day=* month=* weekday=* job='/bin/bash /root/test.sh'\"</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell -a 'crontab -l'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"comment\">#Ansible: 这是一个测试的计划任务</span></span><br><span class=\"line\">* * * * * <span class=\"regexp\">/bin/bash</span> /root/test.sh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个没有带描述的计划任务</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"job='/bin/sh /root/test.sh'\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除计划任务</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"name='None' job='/bin/sh /root/test.sh' state=absent\"</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"系统信息相关的模块\"><a href=\"#系统信息相关的模块\" class=\"headerlink\" title=\"系统信息相关的模块\"></a>系统信息相关的模块</h3><h4 id=\"setup\"><a href=\"#setup\" class=\"headerlink\" title=\"setup\"></a>setup</h4><blockquote>\n<p>用于获取系统信息的一个模块<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s setup</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 查看系统所有信息</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m setup</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># filter 对系统信息进行过滤</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m setup -a <span class=\"string\">'filter=ansible_all_ipv4_addresses'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 常用的过滤选项</span></span><br><span class=\"line\">ansible_all_ipv4_addresses         所有的ipv4地址</span><br><span class=\"line\">ansible_all_ipv6_addresses         所有的ipv6地址</span><br><span class=\"line\">ansible_architecture               系统的架构</span><br><span class=\"line\">ansible_date_time                  系统时间</span><br><span class=\"line\">ansible_default_ipv4               系统的默认ipv4地址</span><br><span class=\"line\">ansible_distribution               系统名称</span><br><span class=\"line\">ansible_distribution_file_variety  系统的家族</span><br><span class=\"line\">ansible_distribution_major_version 系统的版本</span><br><span class=\"line\">ansible_domain                     系统所在的域</span><br><span class=\"line\">ansible_fqdn                       系统的主机名</span><br><span class=\"line\">ansible_hostname                   系统的主机名,简写</span><br><span class=\"line\">ansible_os_family                  系统的家族</span><br><span class=\"line\">ansible_processor_cores            cpu的核数</span><br><span class=\"line\">ansible_processor_count            cpu的颗数</span><br><span class=\"line\">ansible_processor_vcpus            cpu的个数</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Ansible-Ad-hoc模式常用模块\"><a href=\"#Ansible-Ad-hoc模式常用模块\" class=\"headerlink\" title=\"Ansible Ad-hoc模式常用模块\"></a>Ansible Ad-hoc模式常用模块</h2><p>ansible-doc 常用命令<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ansible-doc -h</span></span><br><span class=\"line\"><span class=\"symbol\">Usage:</span> ansible-doc [-l<span class=\"params\">|-F|</span>-s] [options] [-t &lt;plugin type&gt; ] [plugin]</span><br><span class=\"line\">-j  以json格式显示所有模块信息</span><br><span class=\"line\">-l  列出所有的模块</span><br><span class=\"line\">-s  查看模块常用参数</span><br><span class=\"line\"><span class=\"comment\"># 直接跟模块名，显示模块所有信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -j</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -l</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -l |wc -l   #统计所有模块个数，ansible2.8共计2834个模块</span></span><br><span class=\"line\"><span class=\"number\">2834</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"命令相关的模块\"><a href=\"#命令相关的模块\" class=\"headerlink\" title=\"命令相关的模块\"></a>命令相关的模块</h3><h4 id=\"command\"><a href=\"#command\" class=\"headerlink\" title=\"command\"></a>command</h4><blockquote>\n<p><code>ansible</code>默认的模块,执行命令，注意：shell中的<code>&quot;&lt;&quot;</code>, <code>&quot;&gt;&quot;</code>, <code>&quot;|&quot;</code>, <code>&quot;;&quot;</code>, <code>&quot;&amp;&quot;</code>,<code>&quot;$&quot;</code>等特殊字符不能在<code>command</code>模块中使用，如果需要使用，则用<code>shell</code>模块</p>\n</blockquote>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看模块参数</span><br><span class=\"line\">[root@ansible ~]# ansible-doc -s command</span><br><span class=\"line\"></span><br><span class=\"line\"># 在<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span>服务器上面执行ls命令，默认是在当前用户的家目录/root</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'ls'</span><br><span class=\"line\"></span><br><span class=\"line\"># chdir  先切换工作目录，再执行后面的命令，一般情况下在编译时候使用</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'chdir=/tmp pwd'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/tmp</span><br><span class=\"line\"></span><br><span class=\"line\"># creates  如果creates的文件存在，则执行后面的操作</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'creates=/tmp ls /etc/passwd'    #tmp目录存在，则不执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp exists</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'creates=/tmp11 ls /etc/passwd'    # tmp11文件不存在，则执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/etc/passwd</span><br><span class=\"line\"></span><br><span class=\"line\"># removes  和creates相反，如果removes的文件存在，才执行后面的操作</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'removes=/tmp ls /etc/passwd'    #tmp文件存在，则执行了后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">/etc/passwd</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -a 'removes=/tmp11 ls /etc/passwd'  #tmp11文件不存在，则没有执行后面的ls命令</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp11 does not exist</span><br></pre></td></tr></table></figure>\n<h4 id=\"shell\"><a href=\"#shell\" class=\"headerlink\" title=\"shell\"></a>shell</h4><blockquote>\n<p>专门用来执行<code>shell</code>命令的模块，和<code>command</code>模块一样，参数基本一样，都有<code>chdir,creates,removes</code>等参数</p>\n</blockquote>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看模块参数</span><br><span class=\"line\">[root@ansible ~]# ansible-doc -s shell</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'mkdir /tmp/test'</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'ls /tmp' </span><br><span class=\"line\"></span><br><span class=\"line\">#执行下面这条命令，每次执行都会更新文件的时间戳</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'cd /tmp/test &amp;&amp; <span class=\"section\">touch</span> <span class=\"number\">1.</span>txt &amp;&amp; ls' </span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | CHANGED | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\"><span class=\"number\">1.</span>txt</span><br><span class=\"line\"></span><br><span class=\"line\"># 由于有时候不想更新文件的创建时间戳，则如果存在就不执行creates</span><br><span class=\"line\">[root@ansible ~]# ansible <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> -m shell -a 'creates=/tmp/test/<span class=\"number\">1.</span>txt cd /tmp/test &amp;&amp; <span class=\"section\">touch</span> <span class=\"number\">1.</span>txt &amp;&amp; ls'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> | SUCCESS | rc=<span class=\"number\">0</span> &gt;&gt;</span><br><span class=\"line\">skipped, since /tmp/test/<span class=\"number\">1.</span>txt exists</span><br></pre></td></tr></table></figure>\n<h4 id=\"script\"><a href=\"#script\" class=\"headerlink\" title=\"script\"></a>script</h4><blockquote>\n<p>用于在被管理机器上面执行<code>shell</code>脚本的模块，脚本无需在被管理机器上面存在</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s script</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编写shell脚本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># vim ansible_test.sh </span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> `hostname`</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在所有被管理机器上执行该脚本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible all -m script -a '/root/ansible_test.sh'</span></span><br><span class=\"line\">192.168.1.32 | CHANGED =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">true</span>, </span><br><span class=\"line\">    <span class=\"string\">\"rc\"</span>: 0, </span><br><span class=\"line\">    <span class=\"string\">\"stderr\"</span>: <span class=\"string\">\"Shared connection to 192.168.1.32 closed.\\r\\n\"</span>, </span><br><span class=\"line\">    <span class=\"string\">\"stderr_lines\"</span>: [</span><br><span class=\"line\">        <span class=\"string\">\"Shared connection to 192.168.1.32 closed.\"</span></span><br><span class=\"line\">    ], </span><br><span class=\"line\">    <span class=\"string\">\"stdout\"</span>: <span class=\"string\">\"linux.node02.com\\r\\n\"</span>, </span><br><span class=\"line\">    <span class=\"string\">\"stdout_lines\"</span>: [</span><br><span class=\"line\">        <span class=\"string\">\"linux.node02.com\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">......</span><br></pre></td></tr></table></figure>\n<h3 id=\"文件相关的模块\"><a href=\"#文件相关的模块\" class=\"headerlink\" title=\"文件相关的模块\"></a>文件相关的模块</h3><h4 id=\"file\"><a href=\"#file\" class=\"headerlink\" title=\"file\"></a>file</h4><blockquote>\n<p>用于对文件的处理，创建，删除，权限控制等</p>\n</blockquote>\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s file</span></span><br><span class=\"line\">path     <span class=\"comment\">#要管理的文件路径</span></span><br><span class=\"line\">recurse  <span class=\"comment\">#递归</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>：</span><br><span class=\"line\">     directory  <span class=\"comment\">#创建目录，如果目标不存在则创建目录及其子目录</span></span><br><span class=\"line\">     touch      <span class=\"comment\">#创建文件，如果文件存在，则修改文件 属性</span></span><br><span class=\"line\">     </span><br><span class=\"line\">     absent     <span class=\"comment\">#删除文件或目录</span></span><br><span class=\"line\">     mode       <span class=\"comment\">#设置文件或目录权限</span></span><br><span class=\"line\">     owner      <span class=\"comment\">#设置文件或目录属主信息</span></span><br><span class=\"line\">     group      <span class=\"comment\">#设置文件或目录属组信息</span></span><br><span class=\"line\">     <span class=\"keyword\">link</span>       <span class=\"comment\">#创建软连接，需要和src配合使用</span></span><br><span class=\"line\">     hard       <span class=\"comment\">#创建硬连接，需要和src配合使用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建目录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test1 state=directory'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建文件</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=touch'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 建立软链接（src表示源文件，path表示目标文件）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'src=/tmp/test1 path=/tmp/test3 state=link'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除文件</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test2 state=absent'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建文件时同时设置权限等信息</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m file -a 'path=/tmp/test4 state=directory mode=775 owner=root group=root'</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"copy\"><a href=\"#copy\" class=\"headerlink\" title=\"copy\"></a>copy</h4><blockquote>\n<p>用于管理端复制文件到远程主机，并可以设置权限，属组，属主等<br><figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s copy</span></span><br><span class=\"line\">src      <span class=\"comment\">#需要copy的文件的源路径</span></span><br><span class=\"line\">dest     <span class=\"comment\">#需要copy的文件的目标路径</span></span><br><span class=\"line\">backup   <span class=\"comment\">#对copy的文件进行备份</span></span><br><span class=\"line\">content  <span class=\"comment\">#直接在远程主机被管理文件中添加内容，会覆盖原文件内容</span></span><br><span class=\"line\">mode     <span class=\"comment\">#对copy到远端的文件设置权限</span></span><br><span class=\"line\">owner    <span class=\"comment\">#对copy到远端的文件设置属主</span></span><br><span class=\"line\">group    <span class=\"comment\">#对copy到远端文件设置属组</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机并改名</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机，并备份远程文件,安装时间信息备份文件（当更新文件内容后，重新copy时用到）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh src=/root/ansible_test.sh backup=yes'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 直接在远程主机a.sh中添加内容</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/a.sh content=\"#!/bin/bash\\n echo `uptime`\"'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制文件到远程主机，并设置权限及属主与属组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m copy -a 'dest=/tmp/passwd src=/etc/passwd mode=700 owner=root group=root'</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"fetch\"><a href=\"#fetch\" class=\"headerlink\" title=\"fetch\"></a>fetch</h4><blockquote>\n<p>用于从被管理机器上面拉取文件，拉取下来的内容会保留目录结构，一般情况用在收集被管理机器的日志文件等<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s fetch</span></span><br><span class=\"line\">src      <span class=\"comment\">#指定需要从远端机器拉取的文件路径</span></span><br><span class=\"line\">dest     <span class=\"comment\">#指定从远端机器拉取下来的文件存放路径</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从被管理机器上拉取cron日志文件，默认会已管理节点地址创建一个目录，并存放在内</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m fetch -a 'dest=/tmp src=/var/log/cron'</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># tree /tmp/192.168.1.31/</span></span><br><span class=\"line\"><span class=\"regexp\">/tmp/192.168.1.31/</span></span><br><span class=\"line\">└── <span class=\"keyword\">var</span></span><br><span class=\"line\">    └── log</span><br><span class=\"line\">        └── cron</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span> directories, <span class=\"number\">1</span> file</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"用户相关的模块\"><a href=\"#用户相关的模块\" class=\"headerlink\" title=\"用户相关的模块\"></a>用户相关的模块</h3><h4 id=\"user\"><a href=\"#user\" class=\"headerlink\" title=\"user\"></a>user</h4><blockquote>\n<p>用于对系统用户的管理，用户的创建、删除、家目录、属组等设置<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s user</span></span><br><span class=\"line\">name        <span class=\"comment\">#指定用户的名字</span></span><br><span class=\"line\">home        <span class=\"comment\">#指定用户的家目录</span></span><br><span class=\"line\">uid         <span class=\"comment\">#指定用户的uid</span></span><br><span class=\"line\">group       <span class=\"comment\">#指定用户的用户组</span></span><br><span class=\"line\">groups      <span class=\"comment\">#指定用户的附加组</span></span><br><span class=\"line\">password    <span class=\"comment\">#指定用户的密码</span></span><br><span class=\"line\">shell       <span class=\"comment\">#指定用户的登录shell</span></span><br><span class=\"line\">create_home <span class=\"comment\">#是否创建用户家目录，默认是yes</span></span><br><span class=\"line\">remove      <span class=\"comment\">#删除用户时，指定是否删除家目录</span></span><br><span class=\"line\">state：</span><br><span class=\"line\">      absent    <span class=\"comment\">#删除用户</span></span><br><span class=\"line\">      </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建用户名指定家目录，指定uid及组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=mysql home=/opt/mysql uid=1002 group=root'</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell  -a 'id mysql &amp;&amp; ls -l /opt'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\">uid=<span class=\"number\">1002</span>(mysql) gid=<span class=\"number\">0</span>(root) 组=<span class=\"number\">0</span>(root)</span><br><span class=\"line\">总用量 <span class=\"number\">0</span></span><br><span class=\"line\">drwx------  <span class=\"number\">3</span> mysql root <span class=\"number\">78</span> <span class=\"number\">5</span>月  <span class=\"number\">27</span> <span class=\"number\">18</span><span class=\"symbol\">:</span><span class=\"number\">13</span> mysql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建用户，不创建家目录，并且不能登录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=apache shell=/bin/nologin uid=1003 create_home=no'</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell  -a 'id apache &amp;&amp; tail -1 /etc/passwd'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\">uid=<span class=\"number\">1003</span>(apache) gid=<span class=\"number\">1003</span>(apache) 组=<span class=\"number\">1003</span>(apache)</span><br><span class=\"line\"><span class=\"symbol\">apache:</span><span class=\"symbol\">x:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"number\">1003</span><span class=\"symbol\">:</span><span class=\"symbol\">:/home/apache</span><span class=\"symbol\">:/bin/nologin</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除用户</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=apache state=absent'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除用户并删除家目录</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m user -a 'name=mysql state=absent remove=yes'</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"group\"><a href=\"#group\" class=\"headerlink\" title=\"group\"></a>group</h4><blockquote>\n<p>用于创建组，当创建用户时如果需要指定组，组不存在的话就可以通过<code>group</code>先创建组<br><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s group</span></span><br><span class=\"line\">name     <span class=\"comment\">#指定组的名字</span></span><br><span class=\"line\">gid      <span class=\"comment\">#指定组的gid</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>：</span><br><span class=\"line\">     absent   <span class=\"comment\">#删除组</span></span><br><span class=\"line\">     present  <span class=\"comment\">#创建组（默认的状态）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建组并指定gid</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www1 gid=1005'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m group -a 'name=www1 state=absent'</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"软件包相关的模块\"><a href=\"#软件包相关的模块\" class=\"headerlink\" title=\"软件包相关的模块\"></a>软件包相关的模块</h3><h4 id=\"yum\"><a href=\"#yum\" class=\"headerlink\" title=\"yum\"></a>yum</h4><blockquote>\n<p>用于对软件包的管理，下载、安装、卸载、升级等操作<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s yum</span></span><br><span class=\"line\">name            <span class=\"meta\">#指定要操作的软件包名字</span></span><br><span class=\"line\">download_dir    <span class=\"meta\">#指定下载软件包的存放路径，需要配合download_only一起使用</span></span><br><span class=\"line\">download_only   <span class=\"meta\">#只下载软件包，而不进行安装，和yum --downloadonly一样</span></span><br><span class=\"line\">list:</span><br><span class=\"line\">    installed   <span class=\"meta\">#列出所有已安装的软件包</span></span><br><span class=\"line\">    updates     <span class=\"meta\">#列出所有可以更新的软件包</span></span><br><span class=\"line\">    repos       <span class=\"meta\">#列出所有的yum仓库</span></span><br><span class=\"line\">state:   </span><br><span class=\"line\">    installed, present   <span class=\"meta\">#安装软件包(两者任选其一都可以)</span></span><br><span class=\"line\">    removed, absent      <span class=\"meta\">#卸载软件包</span></span><br><span class=\"line\">    latest      <span class=\"meta\">#安装最新软件包</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\"># 列出所有已安装的软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=installed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 列出所有可更新的软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=updates'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#列出所有的yum仓库</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'list=repos'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#只下载软件包并到指定目录下</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd download_only=yes download_dir=/tmp'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd state=installed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#卸载软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=httpd state=removed'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装包组，类似yum groupinstall <span class=\"string\">'Development Tools'</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=\"@Development Tools\" state=installed'</span></span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"pip\"><a href=\"#pip\" class=\"headerlink\" title=\"pip\"></a>pip</h4><blockquote>\n<p>用于安装python中的包<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s pip</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 使用pip时，需要保证被管理机器上有python-pip软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m yum -a <span class=\"string\">'name=python-pip'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 安装pip包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m pip -a <span class=\"string\">'name=flask'</span></span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"service\"><a href=\"#service\" class=\"headerlink\" title=\"service\"></a>service</h4><blockquote>\n<p>服务模块，用于对服务进行管理，服务的启动、关闭、开机自启等<br><figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s service</span></span><br><span class=\"line\">name       <span class=\"comment\">#指定需要管理的服务名</span></span><br><span class=\"line\">enabled    <span class=\"comment\">#指定是否开机自启动</span></span><br><span class=\"line\"><span class=\"keyword\">state</span>:     <span class=\"comment\">#指定服务状态</span></span><br><span class=\"line\">    started    <span class=\"comment\">#启动服务</span></span><br><span class=\"line\">    stopped    <span class=\"comment\">#停止服务</span></span><br><span class=\"line\">    restarted  <span class=\"comment\">#重启服务</span></span><br><span class=\"line\">    reloaded   <span class=\"comment\">#重载服务</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动服务，并设置开机自启动 </span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m service -a 'name=crond state=started enabled=yes'</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"计划任务相关的模块\"><a href=\"#计划任务相关的模块\" class=\"headerlink\" title=\"计划任务相关的模块\"></a>计划任务相关的模块</h3><h4 id=\"cron\"><a href=\"#cron\" class=\"headerlink\" title=\"cron\"></a>cron</h4><blockquote>\n<p>用于指定计划任务，和<code>crontab -e</code>一样<br><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看模块参数</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible-doc -s cron</span></span><br><span class=\"line\">job     <span class=\"comment\">#指定需要执行的任务</span></span><br><span class=\"line\">minute   <span class=\"comment\">#分钟</span></span><br><span class=\"line\">hour     <span class=\"comment\">#小时</span></span><br><span class=\"line\">day      <span class=\"comment\">#天</span></span><br><span class=\"line\">month    <span class=\"comment\">#月</span></span><br><span class=\"line\">weekday  <span class=\"comment\">#周</span></span><br><span class=\"line\">name     <span class=\"comment\">#对计划任务进行描述</span></span><br><span class=\"line\"><span class=\"symbol\">state:</span></span><br><span class=\"line\">    absetn   <span class=\"comment\">#删除计划任务</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个计划任务，并描述是干嘛用的</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"name='这是一个测试的计划任务' minute=* hour=* day=* month=* weekday=* job='/bin/bash /root/test.sh'\"</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m shell -a 'crontab -l'</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | CHANGED | rc=0 &gt;</span>&gt;</span><br><span class=\"line\"><span class=\"comment\">#Ansible: 这是一个测试的计划任务</span></span><br><span class=\"line\">* * * * * <span class=\"regexp\">/bin/bash</span> /root/test.sh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个没有带描述的计划任务</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"job='/bin/sh /root/test.sh'\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除计划任务</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 192.168.1.31 -m cron -a \"name='None' job='/bin/sh /root/test.sh' state=absent\"</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"系统信息相关的模块\"><a href=\"#系统信息相关的模块\" class=\"headerlink\" title=\"系统信息相关的模块\"></a>系统信息相关的模块</h3><h4 id=\"setup\"><a href=\"#setup\" class=\"headerlink\" title=\"setup\"></a>setup</h4><blockquote>\n<p>用于获取系统信息的一个模块<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 查看模块参数</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible-doc -s setup</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 查看系统所有信息</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m setup</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># filter 对系统信息进行过滤</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># ansible 192.168.1.31 -m setup -a <span class=\"string\">'filter=ansible_all_ipv4_addresses'</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 常用的过滤选项</span></span><br><span class=\"line\">ansible_all_ipv4_addresses         所有的ipv4地址</span><br><span class=\"line\">ansible_all_ipv6_addresses         所有的ipv6地址</span><br><span class=\"line\">ansible_architecture               系统的架构</span><br><span class=\"line\">ansible_date_time                  系统时间</span><br><span class=\"line\">ansible_default_ipv4               系统的默认ipv4地址</span><br><span class=\"line\">ansible_distribution               系统名称</span><br><span class=\"line\">ansible_distribution_file_variety  系统的家族</span><br><span class=\"line\">ansible_distribution_major_version 系统的版本</span><br><span class=\"line\">ansible_domain                     系统所在的域</span><br><span class=\"line\">ansible_fqdn                       系统的主机名</span><br><span class=\"line\">ansible_hostname                   系统的主机名,简写</span><br><span class=\"line\">ansible_os_family                  系统的家族</span><br><span class=\"line\">ansible_processor_cores            cpu的核数</span><br><span class=\"line\">ansible_processor_count            cpu的颗数</span><br><span class=\"line\">ansible_processor_vcpus            cpu的个数</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n"},{"title":"Ansible快速入门","date":"2019-05-26T14:35:22.000Z","copyright":true,"_content":"## 介绍\n>`Ansible`是一款简单的运维自动化工具，只需要使用`ssh`协议连接就可以来进行系统管理，自动化执行命令，部署等任务。\n\n**Ansible的特点**\n>1、ansible不需要单独安装客户端，也不需要启动任何服务\n>2、ansible是python中的一套完整的自动化执行任务模块\n>3、ansible playbook 采用yaml配置，对于自动化任务执行过一目了然\n\n**Ansible组成结构**\n- Ansible\n  是`Ansible`的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。\n- Ansible Playbook\n  任务剧本（又称任务集），编排定义`Ansible`任务集的配置文件，由`Ansible`顺序依次执行，`yaml`格式。\n- Inventory\n  `Ansible`管理主机的清单，默认是`/etc/ansible/hosts`文件。\n- Modules\n  `Ansible`执行命令的功能模块，`Ansible2.3`版本为止，共有`1039`个模块。还可以自定义模块。\n- Plugins\n  插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。\n- API\n  提供给第三方程序调用的应用程序编程接口。\n\n\n## 环境准备\n|      IP      |  系统   |      主机名      |      描述       |\n| :----------: | :-----: | :--------------: | :-------------: |\n| 192.168.1.30 | CentOS7 |     ansible      | ansible管理节点 |\n| 192.168.1.31 | CentOS7 | linux.node01.com |   被管理节点1   |\n| 192.168.1.32 | CentOS7 | linux.node02.com |   被管理节点2   |\n| 192.168.1.33 | CentOS7 | linux.node03.com |   被管理节点3   |\n| 192.168.1.36 | CentOS6 | linux.node06.com |   被管理节点6   |\n\n## Ansible安装\n1）配置`epel`源\n```\n[root@ansible ~]# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n[root@ansible ~]# yum clean all\n[root@ansible ~]# yum makecache\n```\n2）安装`ansible`\n```\n[root@ansible ~]# yum -y install ansible\n\n# 查看ansible版本\n[root@ansible ~]# ansible --version\nansible 2.8.0\n  config file = /etc/ansible/ansible.cfg\n  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']\n  ansible python module location = /usr/lib/python2.7/site-packages/ansible\n  executable location = /usr/bin/ansible\n  python version = 2.7.5 (default, Aug  4 2017, 00:39:18) [GCC 4.8.5 20150623 (Red Hat 4.8.5-16)]\n```\n## Ansible Inventory文件\n[Inventory中文文档](http://www.ansible.com.cn/docs/intro_inventory.html)\n>`Inventory`文件通常用于定义要管理的主机的认证信息，例如`ssh`登录用户名、密码以及`key`相关信息。可以同时操作一个组的多台主机，组与主机组之间的关系都是通过`inventory`文件配置。配置文件路径为：`/etc/ansible/hosts`\n### 基于密码连接\n```\n[root@ansible ~]# vim /etc/ansible/hosts\n# 方法一 主机+端口+密码\n[webserver]\n192.168.1.31 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.32 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.33 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.36 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n\n\n# 方法二 主机+端口+密码\n[webserver]\n192.168.1.3[1:3] ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n\n\n# 方法二 主机+端口+密码\n[webserver]\n192.168.1.3[1:3]\n[webserver:vars]\nansible_ssh_pass=\"123456\"\n```\n### 基于秘钥连接\n>基于秘钥连接需要先创建公钥和私钥，并发送给被管理机器\n\n1）生成公私钥\n```\n[root@ansible ~]# ssh-keygen\n[root@ansible ~]# for i in {1,2,3,6}; do ssh-copy-id -i 192.168.1.3$i ; done\n```\n2）配置连接\n```\n[root@ansible ~]# vim /etc/ansible/hosts\n# 方法一 主机+端口+密钥\n[webserver]\n192.168.1.31:22\n192.168.1.32\n192.168.1.33\n192.168.1.36\n\n# 方法一 别名主机+端口+密钥\n[webserver]\nnode1 ansible_ssh_host=192.168.1.31 ansible_ssh_port=22\nnode2 ansible_ssh_host=192.168.1.32 ansible_ssh_port=22\nnode3 ansible_ssh_host=192.168.1.33 ansible_ssh_port=22\nnode6 ansible_ssh_host=192.168.1.36 ansible_ssh_port=22\n```\n### 主机组的使用\n```\n# 主机组变量名+主机+密码\n[apache]\n192.168.1.36\n192.168.1.33\n[apache.vars]\nansible_ssh_pass='123456'\n\n# 主机组变量名+主机+密钥\n[nginx]\n192.168.1.3[1:2]\n\n# 定义多个组，把一个组当另外一个组的组员\n[webserver:children]  #webserver组包括两个子组：apache nginx\napache\nnginx\n```\n### 临时指定inventory\n1）先编辑一个主机定义清单\n```\n[root@ansible ~]# vim /etc/dockers\n[dockers]\n192.168.1.31 ansible_ssh_pass='123456'\n192.168.1.32\n192.168.1.33\n```\n2）在执行命令是指定`inventory`\n```\n[root@ansible ~]# ansible dockers -m ping -i /etc/dockers -o \n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.31 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n```\n### Inventory内置参数\n![ansible inventory内置参数](https://upload-images.jianshu.io/upload_images/11763553-f523aa19ae811b0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n## Ansible Ad-Hoc\n[Ad-Hoc中文文档](http://www.ansible.com.cn/docs/intro_adhoc.html)\n>ad hoc —— 临时的，在`ansible`中是指需要快速执行，并且不需要保存的命令。说白了就是执行简单的命令——一条命令。对于复杂的命令则为`playbook`，类似于`saltstack`的`state sls`状态文件。\n\n### ansible命令格式\n1）常用命令参数\n```\n[root@ansible ~]# ansible -h\nUsage: ansible <host-pattern> [options]\n-a MODULE_ARGS   #模块参数\n-C, --check  #检查语法\n-f FORKS #并发\n--list-hosts #列出主机列表\n-m MODULE_NAME #模块名字\n-o 使用精简的输出\n```\n2）示例\n```\n[root@ansible ~]# ansible webserver -m shell -a 'uptime' -o\n192.168.1.36 | CHANGED | rc=0 | (stdout)  13:46:14 up 1 day,  9:20,  4 users,  load average: 0.00, 0.00, 0.00\n192.168.1.33 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:51,  3 users,  load average: 0.00, 0.01, 0.05\n192.168.1.31 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:50,  3 users,  load average: 0.00, 0.01, 0.05\n192.168.1.32 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:59,  3 users,  load average: 0.00, 0.01, 0.05\n```\n3）命令说明\n![ansible command](https://upload-images.jianshu.io/upload_images/11763553-fcd0f5d6e3bfca0b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n### host-pattern格式\n目标`target`主机，主机组匹配方式\n#### 主机的匹配\n```\n#  一台目标主机\n[root@ansible ~]# ansible 192.168.1.31 -m ping\n\n# 多台目标主机\n[root@ansible ~]# ansible 192.168.1.31,192.168.1.32 -m ping\n\n# 所有目标主机\n[root@ansible ~]# ansible all -m ping\n```\n#### 组的匹配\n```\n# 组的配置信息如下：这里定义了一个nginx组和一个apache组\n[root@ansible ~]# ansible nginx --list\n  hosts (2):\n    192.168.1.31\n    192.168.1.32\n[root@ansible ~]# ansible apache --list\n  hosts (3):\n    192.168.1.36\n    192.168.1.33\n    192.168.1.32\n\n# 一个组的所有主机匹配\n[root@ansible ~]# ansible apache -m ping\n\n# 匹配apache组中有，但是nginx组中没有的所有主机\n[root@ansible ~]# ansible 'apache:!nginx' -m ping -o\n192.168.1.36 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n\n# 匹配apache组和nginx组中都有的机器（并集）\n[root@ansible ~]# ansible 'apache:&nginx' -m ping -o\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n\n# 匹配apache组nginx组两个组所有的机器（并集）；等于ansible apache,nginx -m ping\n[root@ansible ~]# ansible 'apache:nginx' -m ping -o\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.31 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.36 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n```\n\n\n","source":"_posts/Ansible快速入门.md","raw":"---\ntitle: Ansible快速入门\ndate: 2019-05-26 22:35:22\ntags: Ansible\ncategories: Ansible\ncopyright: true\n---\n## 介绍\n>`Ansible`是一款简单的运维自动化工具，只需要使用`ssh`协议连接就可以来进行系统管理，自动化执行命令，部署等任务。\n\n**Ansible的特点**\n>1、ansible不需要单独安装客户端，也不需要启动任何服务\n>2、ansible是python中的一套完整的自动化执行任务模块\n>3、ansible playbook 采用yaml配置，对于自动化任务执行过一目了然\n\n**Ansible组成结构**\n- Ansible\n  是`Ansible`的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。\n- Ansible Playbook\n  任务剧本（又称任务集），编排定义`Ansible`任务集的配置文件，由`Ansible`顺序依次执行，`yaml`格式。\n- Inventory\n  `Ansible`管理主机的清单，默认是`/etc/ansible/hosts`文件。\n- Modules\n  `Ansible`执行命令的功能模块，`Ansible2.3`版本为止，共有`1039`个模块。还可以自定义模块。\n- Plugins\n  插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。\n- API\n  提供给第三方程序调用的应用程序编程接口。\n\n\n## 环境准备\n|      IP      |  系统   |      主机名      |      描述       |\n| :----------: | :-----: | :--------------: | :-------------: |\n| 192.168.1.30 | CentOS7 |     ansible      | ansible管理节点 |\n| 192.168.1.31 | CentOS7 | linux.node01.com |   被管理节点1   |\n| 192.168.1.32 | CentOS7 | linux.node02.com |   被管理节点2   |\n| 192.168.1.33 | CentOS7 | linux.node03.com |   被管理节点3   |\n| 192.168.1.36 | CentOS6 | linux.node06.com |   被管理节点6   |\n\n## Ansible安装\n1）配置`epel`源\n```\n[root@ansible ~]# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n[root@ansible ~]# yum clean all\n[root@ansible ~]# yum makecache\n```\n2）安装`ansible`\n```\n[root@ansible ~]# yum -y install ansible\n\n# 查看ansible版本\n[root@ansible ~]# ansible --version\nansible 2.8.0\n  config file = /etc/ansible/ansible.cfg\n  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']\n  ansible python module location = /usr/lib/python2.7/site-packages/ansible\n  executable location = /usr/bin/ansible\n  python version = 2.7.5 (default, Aug  4 2017, 00:39:18) [GCC 4.8.5 20150623 (Red Hat 4.8.5-16)]\n```\n## Ansible Inventory文件\n[Inventory中文文档](http://www.ansible.com.cn/docs/intro_inventory.html)\n>`Inventory`文件通常用于定义要管理的主机的认证信息，例如`ssh`登录用户名、密码以及`key`相关信息。可以同时操作一个组的多台主机，组与主机组之间的关系都是通过`inventory`文件配置。配置文件路径为：`/etc/ansible/hosts`\n### 基于密码连接\n```\n[root@ansible ~]# vim /etc/ansible/hosts\n# 方法一 主机+端口+密码\n[webserver]\n192.168.1.31 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.32 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.33 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n192.168.1.36 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n\n\n# 方法二 主机+端口+密码\n[webserver]\n192.168.1.3[1:3] ansible_ssh_user=root ansible_ssh_pass=\"123456\"\n\n\n# 方法二 主机+端口+密码\n[webserver]\n192.168.1.3[1:3]\n[webserver:vars]\nansible_ssh_pass=\"123456\"\n```\n### 基于秘钥连接\n>基于秘钥连接需要先创建公钥和私钥，并发送给被管理机器\n\n1）生成公私钥\n```\n[root@ansible ~]# ssh-keygen\n[root@ansible ~]# for i in {1,2,3,6}; do ssh-copy-id -i 192.168.1.3$i ; done\n```\n2）配置连接\n```\n[root@ansible ~]# vim /etc/ansible/hosts\n# 方法一 主机+端口+密钥\n[webserver]\n192.168.1.31:22\n192.168.1.32\n192.168.1.33\n192.168.1.36\n\n# 方法一 别名主机+端口+密钥\n[webserver]\nnode1 ansible_ssh_host=192.168.1.31 ansible_ssh_port=22\nnode2 ansible_ssh_host=192.168.1.32 ansible_ssh_port=22\nnode3 ansible_ssh_host=192.168.1.33 ansible_ssh_port=22\nnode6 ansible_ssh_host=192.168.1.36 ansible_ssh_port=22\n```\n### 主机组的使用\n```\n# 主机组变量名+主机+密码\n[apache]\n192.168.1.36\n192.168.1.33\n[apache.vars]\nansible_ssh_pass='123456'\n\n# 主机组变量名+主机+密钥\n[nginx]\n192.168.1.3[1:2]\n\n# 定义多个组，把一个组当另外一个组的组员\n[webserver:children]  #webserver组包括两个子组：apache nginx\napache\nnginx\n```\n### 临时指定inventory\n1）先编辑一个主机定义清单\n```\n[root@ansible ~]# vim /etc/dockers\n[dockers]\n192.168.1.31 ansible_ssh_pass='123456'\n192.168.1.32\n192.168.1.33\n```\n2）在执行命令是指定`inventory`\n```\n[root@ansible ~]# ansible dockers -m ping -i /etc/dockers -o \n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.31 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n```\n### Inventory内置参数\n![ansible inventory内置参数](https://upload-images.jianshu.io/upload_images/11763553-f523aa19ae811b0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n## Ansible Ad-Hoc\n[Ad-Hoc中文文档](http://www.ansible.com.cn/docs/intro_adhoc.html)\n>ad hoc —— 临时的，在`ansible`中是指需要快速执行，并且不需要保存的命令。说白了就是执行简单的命令——一条命令。对于复杂的命令则为`playbook`，类似于`saltstack`的`state sls`状态文件。\n\n### ansible命令格式\n1）常用命令参数\n```\n[root@ansible ~]# ansible -h\nUsage: ansible <host-pattern> [options]\n-a MODULE_ARGS   #模块参数\n-C, --check  #检查语法\n-f FORKS #并发\n--list-hosts #列出主机列表\n-m MODULE_NAME #模块名字\n-o 使用精简的输出\n```\n2）示例\n```\n[root@ansible ~]# ansible webserver -m shell -a 'uptime' -o\n192.168.1.36 | CHANGED | rc=0 | (stdout)  13:46:14 up 1 day,  9:20,  4 users,  load average: 0.00, 0.00, 0.00\n192.168.1.33 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:51,  3 users,  load average: 0.00, 0.01, 0.05\n192.168.1.31 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:50,  3 users,  load average: 0.00, 0.01, 0.05\n192.168.1.32 | CHANGED | rc=0 | (stdout)  21:26:33 up 1 day,  8:59,  3 users,  load average: 0.00, 0.01, 0.05\n```\n3）命令说明\n![ansible command](https://upload-images.jianshu.io/upload_images/11763553-fcd0f5d6e3bfca0b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n### host-pattern格式\n目标`target`主机，主机组匹配方式\n#### 主机的匹配\n```\n#  一台目标主机\n[root@ansible ~]# ansible 192.168.1.31 -m ping\n\n# 多台目标主机\n[root@ansible ~]# ansible 192.168.1.31,192.168.1.32 -m ping\n\n# 所有目标主机\n[root@ansible ~]# ansible all -m ping\n```\n#### 组的匹配\n```\n# 组的配置信息如下：这里定义了一个nginx组和一个apache组\n[root@ansible ~]# ansible nginx --list\n  hosts (2):\n    192.168.1.31\n    192.168.1.32\n[root@ansible ~]# ansible apache --list\n  hosts (3):\n    192.168.1.36\n    192.168.1.33\n    192.168.1.32\n\n# 一个组的所有主机匹配\n[root@ansible ~]# ansible apache -m ping\n\n# 匹配apache组中有，但是nginx组中没有的所有主机\n[root@ansible ~]# ansible 'apache:!nginx' -m ping -o\n192.168.1.36 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n\n# 匹配apache组和nginx组中都有的机器（并集）\n[root@ansible ~]# ansible 'apache:&nginx' -m ping -o\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n\n# 匹配apache组nginx组两个组所有的机器（并集）；等于ansible apache,nginx -m ping\n[root@ansible ~]# ansible 'apache:nginx' -m ping -o\n192.168.1.32 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.31 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.33 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n192.168.1.36 | SUCCESS => {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": false, \"ping\": \"pong\"}\n```\n\n\n","slug":"Ansible快速入门","published":1,"updated":"2019-05-27T15:31:42.995Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4l7000ym834v8mxjoy6","content":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><blockquote>\n<p><code>Ansible</code>是一款简单的运维自动化工具，只需要使用<code>ssh</code>协议连接就可以来进行系统管理，自动化执行命令，部署等任务。</p>\n</blockquote>\n<p><strong>Ansible的特点</strong></p>\n<blockquote>\n<p>1、ansible不需要单独安装客户端，也不需要启动任何服务<br>2、ansible是python中的一套完整的自动化执行任务模块<br>3、ansible playbook 采用yaml配置，对于自动化任务执行过一目了然</p>\n</blockquote>\n<p><strong>Ansible组成结构</strong></p>\n<ul>\n<li>Ansible<br>是<code>Ansible</code>的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。</li>\n<li>Ansible Playbook<br>任务剧本（又称任务集），编排定义<code>Ansible</code>任务集的配置文件，由<code>Ansible</code>顺序依次执行，<code>yaml</code>格式。</li>\n<li>Inventory<br><code>Ansible</code>管理主机的清单，默认是<code>/etc/ansible/hosts</code>文件。</li>\n<li>Modules<br><code>Ansible</code>执行命令的功能模块，<code>Ansible2.3</code>版本为止，共有<code>1039</code>个模块。还可以自定义模块。</li>\n<li>Plugins<br>插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。</li>\n<li>API<br>提供给第三方程序调用的应用程序编程接口。</li>\n</ul>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><table>\n<thead>\n<tr>\n<th style=\"text-align:center\">IP</th>\n<th style=\"text-align:center\">系统</th>\n<th style=\"text-align:center\">主机名</th>\n<th style=\"text-align:center\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">192.168.1.30</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">ansible</td>\n<td style=\"text-align:center\">ansible管理节点</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.31</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node01.com</td>\n<td style=\"text-align:center\">被管理节点1</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.32</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node02.com</td>\n<td style=\"text-align:center\">被管理节点2</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.33</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node03.com</td>\n<td style=\"text-align:center\">被管理节点3</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.36</td>\n<td style=\"text-align:center\">CentOS6</td>\n<td style=\"text-align:center\">linux.node06.com</td>\n<td style=\"text-align:center\">被管理节点6</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Ansible安装\"><a href=\"#Ansible安装\" class=\"headerlink\" title=\"Ansible安装\"></a>Ansible安装</h2><p>1）配置<code>epel</code>源<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># yum clean all</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># yum makecache</span></span><br></pre></td></tr></table></figure></p>\n<p>2）安装<code>ansible</code><br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]<span class=\"comment\"># yum -y install ansible</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看ansible版本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible --version</span></span><br><span class=\"line\">ansible <span class=\"number\">2.8</span><span class=\"number\">.0</span></span><br><span class=\"line\">  config file = /etc/ansible/ansible.cfg</span><br><span class=\"line\">  configured module search path = [<span class=\"string\">u'/root/.ansible/plugins/modules'</span>, <span class=\"string\">u'/usr/share/ansible/plugins/modules'</span>]</span><br><span class=\"line\">  ansible python module location = /usr/lib/python2<span class=\"number\">.7</span>/site-packages/ansible</span><br><span class=\"line\">  executable location = /usr/bin/ansible</span><br><span class=\"line\">  python version = <span class=\"number\">2.7</span><span class=\"number\">.5</span> (default, Aug  <span class=\"number\">4</span> <span class=\"number\">2017</span>, <span class=\"number\">00</span>:<span class=\"number\">39</span>:<span class=\"number\">18</span>) [GCC <span class=\"number\">4.8</span><span class=\"number\">.5</span> <span class=\"number\">20150623</span> (Red Hat <span class=\"number\">4.8</span><span class=\"number\">.5</span><span class=\"number\">-16</span>)]</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Ansible-Inventory文件\"><a href=\"#Ansible-Inventory文件\" class=\"headerlink\" title=\"Ansible Inventory文件\"></a>Ansible Inventory文件</h2><p><a href=\"http://www.ansible.com.cn/docs/intro_inventory.html\" target=\"_blank\" rel=\"noopener\">Inventory中文文档</a></p>\n<blockquote>\n<p><code>Inventory</code>文件通常用于定义要管理的主机的认证信息，例如<code>ssh</code>登录用户名、密码以及<code>key</code>相关信息。可以同时操作一个组的多台主机，组与主机组之间的关系都是通过<code>inventory</code>文件配置。配置文件路径为：<code>/etc/ansible/hosts</code></p>\n</blockquote>\n<h3 id=\"基于密码连接\"><a href=\"#基于密码连接\" class=\"headerlink\" title=\"基于密码连接\"></a>基于密码连接</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"comment\"># 方法一 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.31 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.32 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.33 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.36 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法二 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.3[1:3] <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法二 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.3[1:3]</span><br><span class=\"line\">[webserver:vars]</span><br><span class=\"line\"><span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"基于秘钥连接\"><a href=\"#基于秘钥连接\" class=\"headerlink\" title=\"基于秘钥连接\"></a>基于秘钥连接</h3><blockquote>\n<p>基于秘钥连接需要先创建公钥和私钥，并发送给被管理机器</p>\n</blockquote>\n<p>1）生成公私钥<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ssh-keygen</span><br><span class=\"line\">[root@ansible ~]# for i in &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">6</span>&#125;; do ssh-copy-id -i <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.3</span>$i ; done</span><br></pre></td></tr></table></figure></p>\n<p>2）配置连接<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"comment\"># 方法一 主机+端口+密钥</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.31:22</span><br><span class=\"line\">192.168.1.32</span><br><span class=\"line\">192.168.1.33</span><br><span class=\"line\">192.168.1.36</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法一 别名主机+端口+密钥</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">node1 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.31 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node2 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.32 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node3 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.33 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node6 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.36 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"主机组的使用\"><a href=\"#主机组的使用\" class=\"headerlink\" title=\"主机组的使用\"></a>主机组的使用</h3><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 主机组变量名+主机+密码</span></span><br><span class=\"line\">[<span class=\"meta\">apache</span>]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.36</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br><span class=\"line\">[<span class=\"meta\">apache.vars</span>]</span><br><span class=\"line\">ansible_ssh_pass=<span class=\"string\">'123456'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 主机组变量名+主机+密钥</span></span><br><span class=\"line\">[<span class=\"meta\">nginx</span>]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.3</span>[<span class=\"number\">1</span>:<span class=\"number\">2</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 定义多个组，把一个组当另外一个组的组员</span></span><br><span class=\"line\">[<span class=\"meta\">webserver:children</span>]  <span class=\"meta\">#webserver组包括两个子组：apache nginx</span></span><br><span class=\"line\">apache</span><br><span class=\"line\">nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"临时指定inventory\"><a href=\"#临时指定inventory\" class=\"headerlink\" title=\"临时指定inventory\"></a>临时指定inventory</h3><p>1）先编辑一个主机定义清单<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/dockers</span><br><span class=\"line\">[dockers]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> ansible_ssh_pass='<span class=\"number\">123456</span>'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br></pre></td></tr></table></figure></p>\n<p>2）在执行命令是指定<code>inventory</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ansible dockers -m<span class=\"built_in\"> ping </span>-i /etc/dockers -o </span><br><span class=\"line\">192.168.1.33 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\">192.168.1.32 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\">192.168.1.31 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Inventory内置参数\"><a href=\"#Inventory内置参数\" class=\"headerlink\" title=\"Inventory内置参数\"></a>Inventory内置参数</h3><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-f523aa19ae811b0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"ansible inventory内置参数\"></p>\n<h2 id=\"Ansible-Ad-Hoc\"><a href=\"#Ansible-Ad-Hoc\" class=\"headerlink\" title=\"Ansible Ad-Hoc\"></a>Ansible Ad-Hoc</h2><p><a href=\"http://www.ansible.com.cn/docs/intro_adhoc.html\" target=\"_blank\" rel=\"noopener\">Ad-Hoc中文文档</a></p>\n<blockquote>\n<p>ad hoc —— 临时的，在<code>ansible</code>中是指需要快速执行，并且不需要保存的命令。说白了就是执行简单的命令——一条命令。对于复杂的命令则为<code>playbook</code>，类似于<code>saltstack</code>的<code>state sls</code>状态文件。</p>\n</blockquote>\n<h3 id=\"ansible命令格式\"><a href=\"#ansible命令格式\" class=\"headerlink\" title=\"ansible命令格式\"></a>ansible命令格式</h3><p>1）常用命令参数<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ansible -h</span><br><span class=\"line\">Usage: ansible &lt;host-pattern&gt; [options]</span><br><span class=\"line\">-<span class=\"ruby\">a MODULE_ARGS   <span class=\"comment\">#模块参数</span></span></span><br><span class=\"line\"><span class=\"ruby\">-C, --check  <span class=\"comment\">#检查语法</span></span></span><br><span class=\"line\"><span class=\"ruby\">-f FORKS <span class=\"comment\">#并发</span></span></span><br><span class=\"line\"><span class=\"ruby\">--list-hosts <span class=\"comment\">#列出主机列表</span></span></span><br><span class=\"line\"><span class=\"ruby\">-m MODULE_NAME <span class=\"comment\">#模块名字</span></span></span><br><span class=\"line\"><span class=\"ruby\">-o 使用精简的输出</span></span><br></pre></td></tr></table></figure></p>\n<p>2）示例<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"meta\">@ansible</span> ~]<span class=\"comment\"># ansible webserver -m shell -a 'uptime' -o</span></span><br><span class=\"line\">192.168.1.36 |<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  13:46:14 up 1 day,  9:20,  4 users,  load average: 0.00, 0.00, 0.00</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.33 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:51,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.31 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:50,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.32 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:59,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br></pre></td></tr></table></figure></p>\n<p>3）命令说明<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-fcd0f5d6e3bfca0b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"ansible command\"></p>\n<h3 id=\"host-pattern格式\"><a href=\"#host-pattern格式\" class=\"headerlink\" title=\"host-pattern格式\"></a>host-pattern格式</h3><p>目标<code>target</code>主机，主机组匹配方式</p>\n<h4 id=\"主机的匹配\"><a href=\"#主机的匹配\" class=\"headerlink\" title=\"主机的匹配\"></a>主机的匹配</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  一台目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible 192.168.1.31 -m ping</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 多台目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible 192.168.1.31,192.168.1.32 -m ping</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 所有目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible all -m ping</span><br></pre></td></tr></table></figure>\n<h4 id=\"组的匹配\"><a href=\"#组的匹配\" class=\"headerlink\" title=\"组的匹配\"></a>组的匹配</h4><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 组的配置信息如下：这里定义了一个nginx组和一个apache组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible nginx --list</span></span><br><span class=\"line\">  hosts (<span class=\"number\">2</span>)<span class=\"symbol\">:</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible apache --list</span></span><br><span class=\"line\">  hosts (<span class=\"number\">3</span>)<span class=\"symbol\">:</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.36</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.33</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 一个组的所有主机匹配</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible apache -m ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组中有，但是nginx组中没有的所有主机</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:!nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组和nginx组中都有的机器（并集）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:&amp;nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组nginx组两个组所有的机器（并集）；等于ansible apache,nginx -m ping</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><blockquote>\n<p><code>Ansible</code>是一款简单的运维自动化工具，只需要使用<code>ssh</code>协议连接就可以来进行系统管理，自动化执行命令，部署等任务。</p>\n</blockquote>\n<p><strong>Ansible的特点</strong></p>\n<blockquote>\n<p>1、ansible不需要单独安装客户端，也不需要启动任何服务<br>2、ansible是python中的一套完整的自动化执行任务模块<br>3、ansible playbook 采用yaml配置，对于自动化任务执行过一目了然</p>\n</blockquote>\n<p><strong>Ansible组成结构</strong></p>\n<ul>\n<li>Ansible<br>是<code>Ansible</code>的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。</li>\n<li>Ansible Playbook<br>任务剧本（又称任务集），编排定义<code>Ansible</code>任务集的配置文件，由<code>Ansible</code>顺序依次执行，<code>yaml</code>格式。</li>\n<li>Inventory<br><code>Ansible</code>管理主机的清单，默认是<code>/etc/ansible/hosts</code>文件。</li>\n<li>Modules<br><code>Ansible</code>执行命令的功能模块，<code>Ansible2.3</code>版本为止，共有<code>1039</code>个模块。还可以自定义模块。</li>\n<li>Plugins<br>插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。</li>\n<li>API<br>提供给第三方程序调用的应用程序编程接口。</li>\n</ul>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><table>\n<thead>\n<tr>\n<th style=\"text-align:center\">IP</th>\n<th style=\"text-align:center\">系统</th>\n<th style=\"text-align:center\">主机名</th>\n<th style=\"text-align:center\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">192.168.1.30</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">ansible</td>\n<td style=\"text-align:center\">ansible管理节点</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.31</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node01.com</td>\n<td style=\"text-align:center\">被管理节点1</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.32</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node02.com</td>\n<td style=\"text-align:center\">被管理节点2</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.33</td>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">linux.node03.com</td>\n<td style=\"text-align:center\">被管理节点3</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">192.168.1.36</td>\n<td style=\"text-align:center\">CentOS6</td>\n<td style=\"text-align:center\">linux.node06.com</td>\n<td style=\"text-align:center\">被管理节点6</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Ansible安装\"><a href=\"#Ansible安装\" class=\"headerlink\" title=\"Ansible安装\"></a>Ansible安装</h2><p>1）配置<code>epel</code>源<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># yum clean all</span></span><br><span class=\"line\">[root<span class=\"symbol\">@ansible</span> ~]<span class=\"meta\"># yum makecache</span></span><br></pre></td></tr></table></figure></p>\n<p>2）安装<code>ansible</code><br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]<span class=\"comment\"># yum -y install ansible</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看ansible版本</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible --version</span></span><br><span class=\"line\">ansible <span class=\"number\">2.8</span><span class=\"number\">.0</span></span><br><span class=\"line\">  config file = /etc/ansible/ansible.cfg</span><br><span class=\"line\">  configured module search path = [<span class=\"string\">u'/root/.ansible/plugins/modules'</span>, <span class=\"string\">u'/usr/share/ansible/plugins/modules'</span>]</span><br><span class=\"line\">  ansible python module location = /usr/lib/python2<span class=\"number\">.7</span>/site-packages/ansible</span><br><span class=\"line\">  executable location = /usr/bin/ansible</span><br><span class=\"line\">  python version = <span class=\"number\">2.7</span><span class=\"number\">.5</span> (default, Aug  <span class=\"number\">4</span> <span class=\"number\">2017</span>, <span class=\"number\">00</span>:<span class=\"number\">39</span>:<span class=\"number\">18</span>) [GCC <span class=\"number\">4.8</span><span class=\"number\">.5</span> <span class=\"number\">20150623</span> (Red Hat <span class=\"number\">4.8</span><span class=\"number\">.5</span><span class=\"number\">-16</span>)]</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Ansible-Inventory文件\"><a href=\"#Ansible-Inventory文件\" class=\"headerlink\" title=\"Ansible Inventory文件\"></a>Ansible Inventory文件</h2><p><a href=\"http://www.ansible.com.cn/docs/intro_inventory.html\" target=\"_blank\" rel=\"noopener\">Inventory中文文档</a></p>\n<blockquote>\n<p><code>Inventory</code>文件通常用于定义要管理的主机的认证信息，例如<code>ssh</code>登录用户名、密码以及<code>key</code>相关信息。可以同时操作一个组的多台主机，组与主机组之间的关系都是通过<code>inventory</code>文件配置。配置文件路径为：<code>/etc/ansible/hosts</code></p>\n</blockquote>\n<h3 id=\"基于密码连接\"><a href=\"#基于密码连接\" class=\"headerlink\" title=\"基于密码连接\"></a>基于密码连接</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"comment\"># 方法一 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.31 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.32 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.33 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">192.168.1.36 <span class=\"attribute\">ansible_ssh_port</span>=22 <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法二 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.3[1:3] <span class=\"attribute\">ansible_ssh_user</span>=root <span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法二 主机+端口+密码</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.3[1:3]</span><br><span class=\"line\">[webserver:vars]</span><br><span class=\"line\"><span class=\"attribute\">ansible_ssh_pass</span>=<span class=\"string\">\"123456\"</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"基于秘钥连接\"><a href=\"#基于秘钥连接\" class=\"headerlink\" title=\"基于秘钥连接\"></a>基于秘钥连接</h3><blockquote>\n<p>基于秘钥连接需要先创建公钥和私钥，并发送给被管理机器</p>\n</blockquote>\n<p>1）生成公私钥<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ssh-keygen</span><br><span class=\"line\">[root@ansible ~]# for i in &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">6</span>&#125;; do ssh-copy-id -i <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.3</span>$i ; done</span><br></pre></td></tr></table></figure></p>\n<p>2）配置连接<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"comment\"># 方法一 主机+端口+密钥</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">192.168.1.31:22</span><br><span class=\"line\">192.168.1.32</span><br><span class=\"line\">192.168.1.33</span><br><span class=\"line\">192.168.1.36</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法一 别名主机+端口+密钥</span></span><br><span class=\"line\">[webserver]</span><br><span class=\"line\">node1 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.31 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node2 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.32 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node3 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.33 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br><span class=\"line\">node6 <span class=\"attribute\">ansible_ssh_host</span>=192.168.1.36 <span class=\"attribute\">ansible_ssh_port</span>=22</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"主机组的使用\"><a href=\"#主机组的使用\" class=\"headerlink\" title=\"主机组的使用\"></a>主机组的使用</h3><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 主机组变量名+主机+密码</span></span><br><span class=\"line\">[<span class=\"meta\">apache</span>]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.36</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br><span class=\"line\">[<span class=\"meta\">apache.vars</span>]</span><br><span class=\"line\">ansible_ssh_pass=<span class=\"string\">'123456'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 主机组变量名+主机+密钥</span></span><br><span class=\"line\">[<span class=\"meta\">nginx</span>]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.3</span>[<span class=\"number\">1</span>:<span class=\"number\">2</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 定义多个组，把一个组当另外一个组的组员</span></span><br><span class=\"line\">[<span class=\"meta\">webserver:children</span>]  <span class=\"meta\">#webserver组包括两个子组：apache nginx</span></span><br><span class=\"line\">apache</span><br><span class=\"line\">nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"临时指定inventory\"><a href=\"#临时指定inventory\" class=\"headerlink\" title=\"临时指定inventory\"></a>临时指定inventory</h3><p>1）先编辑一个主机定义清单<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# vim /etc/dockers</span><br><span class=\"line\">[dockers]</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.31</span> ansible_ssh_pass='<span class=\"number\">123456</span>'</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span></span><br></pre></td></tr></table></figure></p>\n<p>2）在执行命令是指定<code>inventory</code><br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ansible dockers -m<span class=\"built_in\"> ping </span>-i /etc/dockers -o </span><br><span class=\"line\">192.168.1.33 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\">192.168.1.32 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\">192.168.1.31 | SUCCESS =&gt; &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Inventory内置参数\"><a href=\"#Inventory内置参数\" class=\"headerlink\" title=\"Inventory内置参数\"></a>Inventory内置参数</h3><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-f523aa19ae811b0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"ansible inventory内置参数\"></p>\n<h2 id=\"Ansible-Ad-Hoc\"><a href=\"#Ansible-Ad-Hoc\" class=\"headerlink\" title=\"Ansible Ad-Hoc\"></a>Ansible Ad-Hoc</h2><p><a href=\"http://www.ansible.com.cn/docs/intro_adhoc.html\" target=\"_blank\" rel=\"noopener\">Ad-Hoc中文文档</a></p>\n<blockquote>\n<p>ad hoc —— 临时的，在<code>ansible</code>中是指需要快速执行，并且不需要保存的命令。说白了就是执行简单的命令——一条命令。对于复杂的命令则为<code>playbook</code>，类似于<code>saltstack</code>的<code>state sls</code>状态文件。</p>\n</blockquote>\n<h3 id=\"ansible命令格式\"><a href=\"#ansible命令格式\" class=\"headerlink\" title=\"ansible命令格式\"></a>ansible命令格式</h3><p>1）常用命令参数<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ansible ~]# ansible -h</span><br><span class=\"line\">Usage: ansible &lt;host-pattern&gt; [options]</span><br><span class=\"line\">-<span class=\"ruby\">a MODULE_ARGS   <span class=\"comment\">#模块参数</span></span></span><br><span class=\"line\"><span class=\"ruby\">-C, --check  <span class=\"comment\">#检查语法</span></span></span><br><span class=\"line\"><span class=\"ruby\">-f FORKS <span class=\"comment\">#并发</span></span></span><br><span class=\"line\"><span class=\"ruby\">--list-hosts <span class=\"comment\">#列出主机列表</span></span></span><br><span class=\"line\"><span class=\"ruby\">-m MODULE_NAME <span class=\"comment\">#模块名字</span></span></span><br><span class=\"line\"><span class=\"ruby\">-o 使用精简的输出</span></span><br></pre></td></tr></table></figure></p>\n<p>2）示例<br><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"meta\">@ansible</span> ~]<span class=\"comment\"># ansible webserver -m shell -a 'uptime' -o</span></span><br><span class=\"line\">192.168.1.36 |<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  13:46:14 up 1 day,  9:20,  4 users,  load average: 0.00, 0.00, 0.00</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.33 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:51,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.31 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:50,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class=\"line\"><span class=\"string\">192.168.1.32 </span>|<span class=\"string\"> CHANGED </span>|<span class=\"string\"> rc=0 </span>|<span class=\"string\"> (stdout)  21:26:33 up 1 day,  8:59,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br></pre></td></tr></table></figure></p>\n<p>3）命令说明<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-fcd0f5d6e3bfca0b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"ansible command\"></p>\n<h3 id=\"host-pattern格式\"><a href=\"#host-pattern格式\" class=\"headerlink\" title=\"host-pattern格式\"></a>host-pattern格式</h3><p>目标<code>target</code>主机，主机组匹配方式</p>\n<h4 id=\"主机的匹配\"><a href=\"#主机的匹配\" class=\"headerlink\" title=\"主机的匹配\"></a>主机的匹配</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  一台目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible 192.168.1.31 -m ping</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 多台目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible 192.168.1.31,192.168.1.32 -m ping</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 所有目标主机</span></span><br><span class=\"line\">[root@ansible ~]# ansible all -m ping</span><br></pre></td></tr></table></figure>\n<h4 id=\"组的匹配\"><a href=\"#组的匹配\" class=\"headerlink\" title=\"组的匹配\"></a>组的匹配</h4><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 组的配置信息如下：这里定义了一个nginx组和一个apache组</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible nginx --list</span></span><br><span class=\"line\">  hosts (<span class=\"number\">2</span>)<span class=\"symbol\">:</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.31</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible apache --list</span></span><br><span class=\"line\">  hosts (<span class=\"number\">3</span>)<span class=\"symbol\">:</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.36</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.33</span></span><br><span class=\"line\">    <span class=\"number\">192.168</span>.<span class=\"number\">1.32</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 一个组的所有主机匹配</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible apache -m ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组中有，但是nginx组中没有的所有主机</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:!nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组和nginx组中都有的机器（并集）</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:&amp;nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 匹配apache组nginx组两个组所有的机器（并集）；等于ansible apache,nginx -m ping</span></span><br><span class=\"line\">[root@ansible ~]<span class=\"comment\"># ansible 'apache:nginx' -m ping -o</span></span><br><span class=\"line\"><span class=\"meta\">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.31 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br><span class=\"line\"><span class=\"meta\">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class=\"string\">\"ansible_facts\"</span>: &#123;<span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span>&#125;, <span class=\"string\">\"changed\"</span>: false, <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span>&#125;</span><br></pre></td></tr></table></figure>\n"},{"title":"saltstack数据系统","date":"2019-05-17T09:31:05.000Z","copyright":true,"_content":"## 数据系统Grains\n>1、`Grains`是`SaltStack`收集的有关底层管理系统的静态信息。包括操作系统版本、域名、IP地址、内存、内核、CPU、操作系统类型以及许多其他系统属性。`Minion` 收集的信息，可以作为`Master`端匹配目标。\n>2、如果需要自定义`grains`，需要添加到`Salt Minion`的`/etc/salt/grains`文件中（配置文件中定义的默认路径），也可以直接写在配置文件`/etc/salt/minion`中\n\n[Grains官方文档](https://docs.saltstack.com/en/latest/topics/grains/)\n1）资产管理，信息查询\n```\n#列出所有可用的grains状态模块\n[root@salt-master ~]# salt '*' grains.ls\n#打印所有状态信息\n[root@salt-master ~]# salt '*' grains.items\n#列出每台minion的本地IP地址\n[root@salt-master ~]# salt '*' grains.item fqdn_ip4\n#列出每台minion的操作系统\n[root@salt-master ~]# salt '*' grains.item os\n```\n2）用于匹配\n```\n[root@salt-master ~]# salt -G 'os:CentOS' test.ping\n[root@salt-master ~]# salt -G 'localhost:salt-minion01' test.ping\n```\n3）`minion`自定义`grains`\n```\n#1.修改配置文件，自定义grains\n[root@salt-minion01 ~]# vim /etc/salt/minion\ngrains:\n  roles:\n    - webserver\n    - memcache\n  ipaddr:\n    - 192.168.1.32\n\n#2.重启minion\n[root@salt-minion01 ~]# systemctl restart salt-minion\n\n#3.master上测试\n[root@salt-master ~]# salt -G 'ipaddr:192.168.1.32' test.ping \nsalt-minion01:\n    True\n```\n4）`Grains`优先级问题\n```\n1、Grains默认核心信息\n2、自定义写在/etc/salt/grains文件中的\n3、自定义写在/etc/salt/minion文件中的\n```\n## 数据系统Pillar\n>`Pillar`是动态的，`Pillar`存储在`master`上，提供给`minion`。\n>`Pillar`主要记录一些加密信息，可以确保这些敏感数据不被其他`minion`看到。比如：软件版本号、用户名密码等。存储格式都是`YAML`格式\n\n1）在`Master`端定义`Pillar`\n```\n[root@salt-master ~]# vim /etc/salt/master\npillar_roots:\n  base:\n    - /srv/pillar\n\n[root@salt-master ~]# mkdir /srv/pillar\n[root@salt-master ~]# cat /srv/pillar/zabbix.sls \nZabbix_Server: 192.168.1.11\nZabbix_Name: zabbix.examp.com\n```\n2）编写`TopFile`指定`Minion`端可以使用\n```\n[root@salt-master ~]# cat /srv/pillar/top.sls \nbase:\n  'salt-minion01':\n    - zabbix\n```\n3）刷新`Pillar`\n```\n[root@salt-master ~]# salt '*' saltutil.refresh_pillar\n```\n4）获取对应`pillar`值\n```\n[root@salt-master ~]# salt '*' pillar.items\nsalt-minion01:\n    ----------\n    Zabbix_Name:\n        zabbix.examp.com\n    Zabbix_Server:\n        192.168.1.11\nsalt-minion03:\n    ----------\nsalt-minion02:\n    ----------\n\n#获取指定的key\n[root@salt-master ~]# salt 'salt-minion01' pillar.item Zabbix_Server\nsalt-minion01:\n    ----------\n    Zabbix_Server:\n        192.168.1.11\n```\n>说明：如果`Master`更新了新的数值，需要刷新`Pillar`到`Minion`才可以获取\n\n>`Pirrar`与`Grains`对比\n```\n类型     数据采集方式   应用场景                   定义位置\nGrains   静态         minion启动时收集  数据查询  目标选择  配置管理   minion\nPillar   动态         master进行自定义  目标选择  配置管理  敏感数据   master\n```","source":"_posts/saltstack数据系统.md","raw":"---\ntitle: saltstack数据系统\ndate: 2019-05-17 17:31:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## 数据系统Grains\n>1、`Grains`是`SaltStack`收集的有关底层管理系统的静态信息。包括操作系统版本、域名、IP地址、内存、内核、CPU、操作系统类型以及许多其他系统属性。`Minion` 收集的信息，可以作为`Master`端匹配目标。\n>2、如果需要自定义`grains`，需要添加到`Salt Minion`的`/etc/salt/grains`文件中（配置文件中定义的默认路径），也可以直接写在配置文件`/etc/salt/minion`中\n\n[Grains官方文档](https://docs.saltstack.com/en/latest/topics/grains/)\n1）资产管理，信息查询\n```\n#列出所有可用的grains状态模块\n[root@salt-master ~]# salt '*' grains.ls\n#打印所有状态信息\n[root@salt-master ~]# salt '*' grains.items\n#列出每台minion的本地IP地址\n[root@salt-master ~]# salt '*' grains.item fqdn_ip4\n#列出每台minion的操作系统\n[root@salt-master ~]# salt '*' grains.item os\n```\n2）用于匹配\n```\n[root@salt-master ~]# salt -G 'os:CentOS' test.ping\n[root@salt-master ~]# salt -G 'localhost:salt-minion01' test.ping\n```\n3）`minion`自定义`grains`\n```\n#1.修改配置文件，自定义grains\n[root@salt-minion01 ~]# vim /etc/salt/minion\ngrains:\n  roles:\n    - webserver\n    - memcache\n  ipaddr:\n    - 192.168.1.32\n\n#2.重启minion\n[root@salt-minion01 ~]# systemctl restart salt-minion\n\n#3.master上测试\n[root@salt-master ~]# salt -G 'ipaddr:192.168.1.32' test.ping \nsalt-minion01:\n    True\n```\n4）`Grains`优先级问题\n```\n1、Grains默认核心信息\n2、自定义写在/etc/salt/grains文件中的\n3、自定义写在/etc/salt/minion文件中的\n```\n## 数据系统Pillar\n>`Pillar`是动态的，`Pillar`存储在`master`上，提供给`minion`。\n>`Pillar`主要记录一些加密信息，可以确保这些敏感数据不被其他`minion`看到。比如：软件版本号、用户名密码等。存储格式都是`YAML`格式\n\n1）在`Master`端定义`Pillar`\n```\n[root@salt-master ~]# vim /etc/salt/master\npillar_roots:\n  base:\n    - /srv/pillar\n\n[root@salt-master ~]# mkdir /srv/pillar\n[root@salt-master ~]# cat /srv/pillar/zabbix.sls \nZabbix_Server: 192.168.1.11\nZabbix_Name: zabbix.examp.com\n```\n2）编写`TopFile`指定`Minion`端可以使用\n```\n[root@salt-master ~]# cat /srv/pillar/top.sls \nbase:\n  'salt-minion01':\n    - zabbix\n```\n3）刷新`Pillar`\n```\n[root@salt-master ~]# salt '*' saltutil.refresh_pillar\n```\n4）获取对应`pillar`值\n```\n[root@salt-master ~]# salt '*' pillar.items\nsalt-minion01:\n    ----------\n    Zabbix_Name:\n        zabbix.examp.com\n    Zabbix_Server:\n        192.168.1.11\nsalt-minion03:\n    ----------\nsalt-minion02:\n    ----------\n\n#获取指定的key\n[root@salt-master ~]# salt 'salt-minion01' pillar.item Zabbix_Server\nsalt-minion01:\n    ----------\n    Zabbix_Server:\n        192.168.1.11\n```\n>说明：如果`Master`更新了新的数值，需要刷新`Pillar`到`Minion`才可以获取\n\n>`Pirrar`与`Grains`对比\n```\n类型     数据采集方式   应用场景                   定义位置\nGrains   静态         minion启动时收集  数据查询  目标选择  配置管理   minion\nPillar   动态         master进行自定义  目标选择  配置管理  敏感数据   master\n```","slug":"saltstack数据系统","published":1,"updated":"2019-05-17T13:23:21.439Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4la0012m8343j6wlfxz","content":"<h2 id=\"数据系统Grains\"><a href=\"#数据系统Grains\" class=\"headerlink\" title=\"数据系统Grains\"></a>数据系统Grains</h2><blockquote>\n<p>1、<code>Grains</code>是<code>SaltStack</code>收集的有关底层管理系统的静态信息。包括操作系统版本、域名、IP地址、内存、内核、CPU、操作系统类型以及许多其他系统属性。<code>Minion</code> 收集的信息，可以作为<code>Master</code>端匹配目标。<br>2、如果需要自定义<code>grains</code>，需要添加到<code>Salt Minion</code>的<code>/etc/salt/grains</code>文件中（配置文件中定义的默认路径），也可以直接写在配置文件<code>/etc/salt/minion</code>中</p>\n</blockquote>\n<p><a href=\"https://docs.saltstack.com/en/latest/topics/grains/\" target=\"_blank\" rel=\"noopener\">Grains官方文档</a><br>1）资产管理，信息查询<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#列出所有可用的grains状态模块</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.ls</span></span><br><span class=\"line\"><span class=\"meta\">#打印所有状态信息</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.items</span></span><br><span class=\"line\"><span class=\"meta\">#列出每台minion的本地IP地址</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.item fqdn_ip4</span></span><br><span class=\"line\"><span class=\"meta\">#列出每台minion的操作系统</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.item os</span></span><br></pre></td></tr></table></figure></p>\n<p>2）用于匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'os:CentOS'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'localhost:salt-minion01'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>minion</code>自定义<code>grains</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#1.修改配置文件，自定义grains</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># vim /etc/salt/minion</span></span><br><span class=\"line\">grains:</span><br><span class=\"line\">  roles:</span><br><span class=\"line\">    - webserver</span><br><span class=\"line\">    - memcache</span><br><span class=\"line\">  ipaddr:</span><br><span class=\"line\">    - <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#2.重启minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl restart salt-minion</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#3.master上测试</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'ipaddr:192.168.1.32'</span> test.ping </span></span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4）<code>Grains</code>优先级问题<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、Grains默认核心信息</span><br><span class=\"line\"><span class=\"number\">2</span>、自定义写在/etc/salt/grains文件中的</span><br><span class=\"line\"><span class=\"number\">3</span>、自定义写在/etc/salt/minion文件中的</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"数据系统Pillar\"><a href=\"#数据系统Pillar\" class=\"headerlink\" title=\"数据系统Pillar\"></a>数据系统Pillar</h2><blockquote>\n<p><code>Pillar</code>是动态的，<code>Pillar</code>存储在<code>master</code>上，提供给<code>minion</code>。<br><code>Pillar</code>主要记录一些加密信息，可以确保这些敏感数据不被其他<code>minion</code>看到。比如：软件版本号、用户名密码等。存储格式都是<code>YAML</code>格式</p>\n</blockquote>\n<p>1）在<code>Master</code>端定义<code>Pillar</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">pillar_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/pillar</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/pillar</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/pillar/zabbix.sls </span><br><span class=\"line\">Zabbix_Server: <span class=\"number\">192.168</span>.<span class=\"number\">1.11</span></span><br><span class=\"line\">Zabbix_Name: zabbix.examp.com</span><br></pre></td></tr></table></figure></p>\n<p>2）编写<code>TopFile</code>指定<code>Minion</code>端可以使用<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">root@salt-master ~</span>]<span class=\"meta\"># cat /srv/pillar/top.sls </span></span><br><span class=\"line\"><span class=\"keyword\">base</span>:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion01'</span>:</span><br><span class=\"line\">    - zabbix</span><br></pre></td></tr></table></figure></p>\n<p>3）刷新<code>Pillar</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> saltutil.refresh_pillar</span></span><br></pre></td></tr></table></figure></p>\n<p>4）获取对应<code>pillar</code>值<br><figure class=\"highlight moonscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> pillar.items</span><br><span class=\"line\">salt-<span class=\"name\">minion01</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">    <span class=\"name\">Zabbix_Name</span>:</span><br><span class=\"line\">        zabbix.examp.com</span><br><span class=\"line\">    <span class=\"name\">Zabbix_Server</span>:</span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.11</span></span><br><span class=\"line\">salt-<span class=\"name\">minion03</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">salt-<span class=\"name\">minion02</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\"></span><br><span class=\"line\">#获取指定的key</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'salt-minion01'</span> pillar.item Zabbix_Server</span><br><span class=\"line\">salt-<span class=\"name\">minion01</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">    <span class=\"name\">Zabbix_Server</span>:</span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.11</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>说明：如果<code>Master</code>更新了新的数值，需要刷新<code>Pillar</code>到<code>Minion</code>才可以获取</p>\n</blockquote>\n<blockquote>\n<p><code>Pirrar</code>与<code>Grains</code>对比<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">类型     数据采集方式   应用场景                   定义位置</span><br><span class=\"line\">Grains   静态         minion启动时收集  数据查询  目标选择  配置管理   minion</span><br><span class=\"line\">Pillar   动态         <span class=\"literal\">master</span>进行自定义  目标选择  配置管理  敏感数据   <span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"数据系统Grains\"><a href=\"#数据系统Grains\" class=\"headerlink\" title=\"数据系统Grains\"></a>数据系统Grains</h2><blockquote>\n<p>1、<code>Grains</code>是<code>SaltStack</code>收集的有关底层管理系统的静态信息。包括操作系统版本、域名、IP地址、内存、内核、CPU、操作系统类型以及许多其他系统属性。<code>Minion</code> 收集的信息，可以作为<code>Master</code>端匹配目标。<br>2、如果需要自定义<code>grains</code>，需要添加到<code>Salt Minion</code>的<code>/etc/salt/grains</code>文件中（配置文件中定义的默认路径），也可以直接写在配置文件<code>/etc/salt/minion</code>中</p>\n</blockquote>\n<p><a href=\"https://docs.saltstack.com/en/latest/topics/grains/\" target=\"_blank\" rel=\"noopener\">Grains官方文档</a><br>1）资产管理，信息查询<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#列出所有可用的grains状态模块</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.ls</span></span><br><span class=\"line\"><span class=\"meta\">#打印所有状态信息</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.items</span></span><br><span class=\"line\"><span class=\"meta\">#列出每台minion的本地IP地址</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.item fqdn_ip4</span></span><br><span class=\"line\"><span class=\"meta\">#列出每台minion的操作系统</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> grains.item os</span></span><br></pre></td></tr></table></figure></p>\n<p>2）用于匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'os:CentOS'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'localhost:salt-minion01'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>3）<code>minion</code>自定义<code>grains</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#1.修改配置文件，自定义grains</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># vim /etc/salt/minion</span></span><br><span class=\"line\">grains:</span><br><span class=\"line\">  roles:</span><br><span class=\"line\">    - webserver</span><br><span class=\"line\">    - memcache</span><br><span class=\"line\">  ipaddr:</span><br><span class=\"line\">    - <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#2.重启minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl restart salt-minion</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#3.master上测试</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'ipaddr:192.168.1.32'</span> test.ping </span></span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4）<code>Grains</code>优先级问题<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、Grains默认核心信息</span><br><span class=\"line\"><span class=\"number\">2</span>、自定义写在/etc/salt/grains文件中的</span><br><span class=\"line\"><span class=\"number\">3</span>、自定义写在/etc/salt/minion文件中的</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"数据系统Pillar\"><a href=\"#数据系统Pillar\" class=\"headerlink\" title=\"数据系统Pillar\"></a>数据系统Pillar</h2><blockquote>\n<p><code>Pillar</code>是动态的，<code>Pillar</code>存储在<code>master</code>上，提供给<code>minion</code>。<br><code>Pillar</code>主要记录一些加密信息，可以确保这些敏感数据不被其他<code>minion</code>看到。比如：软件版本号、用户名密码等。存储格式都是<code>YAML</code>格式</p>\n</blockquote>\n<p>1）在<code>Master</code>端定义<code>Pillar</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">pillar_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/pillar</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/pillar</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/pillar/zabbix.sls </span><br><span class=\"line\">Zabbix_Server: <span class=\"number\">192.168</span>.<span class=\"number\">1.11</span></span><br><span class=\"line\">Zabbix_Name: zabbix.examp.com</span><br></pre></td></tr></table></figure></p>\n<p>2）编写<code>TopFile</code>指定<code>Minion</code>端可以使用<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">root@salt-master ~</span>]<span class=\"meta\"># cat /srv/pillar/top.sls </span></span><br><span class=\"line\"><span class=\"keyword\">base</span>:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion01'</span>:</span><br><span class=\"line\">    - zabbix</span><br></pre></td></tr></table></figure></p>\n<p>3）刷新<code>Pillar</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> saltutil.refresh_pillar</span></span><br></pre></td></tr></table></figure></p>\n<p>4）获取对应<code>pillar</code>值<br><figure class=\"highlight moonscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> pillar.items</span><br><span class=\"line\">salt-<span class=\"name\">minion01</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">    <span class=\"name\">Zabbix_Name</span>:</span><br><span class=\"line\">        zabbix.examp.com</span><br><span class=\"line\">    <span class=\"name\">Zabbix_Server</span>:</span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.11</span></span><br><span class=\"line\">salt-<span class=\"name\">minion03</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">salt-<span class=\"name\">minion02</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\"></span><br><span class=\"line\">#获取指定的key</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'salt-minion01'</span> pillar.item Zabbix_Server</span><br><span class=\"line\">salt-<span class=\"name\">minion01</span>:</span><br><span class=\"line\">    <span class=\"comment\">----------</span></span><br><span class=\"line\">    <span class=\"name\">Zabbix_Server</span>:</span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.11</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>说明：如果<code>Master</code>更新了新的数值，需要刷新<code>Pillar</code>到<code>Minion</code>才可以获取</p>\n</blockquote>\n<blockquote>\n<p><code>Pirrar</code>与<code>Grains</code>对比<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">类型     数据采集方式   应用场景                   定义位置</span><br><span class=\"line\">Grains   静态         minion启动时收集  数据查询  目标选择  配置管理   minion</span><br><span class=\"line\">Pillar   动态         <span class=\"literal\">master</span>进行自定义  目标选择  配置管理  敏感数据   <span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n"},{"title":"saltstack状态判断unless与onlyif","date":"2019-05-17T07:43:05.000Z","copyright":true,"_content":">很多时候我们在编写`state` 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的`unless`和`onlyif`。\n\n## unless\n`unless`示例：需求创建`/tmp/unless.txt`文件，存在则不创建，不存在则创建\n```\n[root@salt-master ~]# cat /srv/salt/prod/unless.sls \ntest-unless:\n  cmd.run:\n    - name: touch /tmp/unless.txt\n    - unless: test -f /tmp/unless.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: Command \"touch /tmp/unless.txt\" run\n     Started: 15:10:51.522319\n    Duration: 31.822 ms\n     Changes:   \n              ----------\n              pid:\n                  6538\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  31.822 ms\n#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: unless condition is true\n     Started: 15:11:40.819789\n    Duration: 10.477 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  10.477 ms\n#第二次执行，可以看到该文件已经存在，并没有再次创建\n```\n>通过上面的小案例可以看出，当`unless`返回为真则不执行，当`unless`返回为假才执行。\n\n## onlyif\n> `onlyif`正好和`unless`相反，当`onlyif`返回为真执行，当`onlyif`返回为假不执行\n\n`onlyif`示例：需求，当`/tmp/onlyif.txt`文件存在，则创建`/tmp/onlyif`目录，不存在，则不创建`/tmp/onlyif`目录\n```\n[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls \ntest-onlyif:\n  cmd.run:\n    - name: mkdir /tmp/onlyif\n    - onlyif: test -f /tmp/onlyif.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: onlyif condition is false\n     Started: 15:34:56.460583\n    Duration: 9.612 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:   9.612 ms\n\n#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行\n[root@salt-master ~]# salt 'salt-minion01' cmd.run \"touch /tmp/onlyif.txt\"\nsalt-minion01:\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: Command \"mkdir /tmp/onlyif\" run\n     Started: 15:38:07.712492\n    Duration: 14.646 ms\n     Changes:   \n              ----------\n              pid:\n                  6871\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  14.646 ms\n\n#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录\n```\n## Redis主从架构案例\n说明：该案例在`prod`环境配置\n![redis主从环境](https://upload-images.jianshu.io/upload_images/11763553-bc3bd43a55d275ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir -p /srv/salt/prod/redis/files/\n```\n3）编写`state sls`状态文件\n```\n#初始化redis（安装和基本配置）\n[root@salt-master ~]# cat /srv/salt/prod/redis/init.sls \nredis-install:\n  pkg.installed:\n    - name: redis\n\nredis-config:\n  file.managed:\n    - name: /etc/redis.conf\n    - source: salt://redis/files/redis.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      BIND: {{ grains['fqdn_ip4'][0] }}\n      PORT: 6379\n      DAEMONIZA: 'yes'\n    - require:\n      - pkg: redis-install\n\nredis-service:\n  service.running:\n    - name: redis\n    - enable: True\n    - watch:\n      - file: redis-config\n\n\n#master直接引入 init\n[root@salt-master ~]# cat /srv/salt/prod/redis/master.sls \ninclude:\n  - redis.init\n\n\n#slave引入init 并配置主从信息\n[root@salt-master ~]# cat /srv/salt/prod/redis/slave.sls \ninclude:\n  - redis.init\n\n#配置主从\nslave-config:\n  cmd.run:\n    - name: redis-cli -h 192.168.1.34 slaveof 192.168.1.33 6379\n    - unless: redis-cli -h 192.168.1.34 info |grep role:slave\n    - require:\n      - service: redis-service\n\n说明：\nunless：返回为真则不执行，反之为假则执行\n```\n4）配置文件准备\n```\n[root@salt-master ~]# grep \"^[a-Z]\" /etc/redis.conf  >>/srv/salt/prod/redis/files/redis.conf\n[root@salt-master ~]# cat /srv/salt/prod/redis/files/redis.conf \n#这里使用jinja\nbind {{ BIND }}\nprotected-mode yes\n#这里使用jinja\nport {{ PORT }}\ntcp-backlog 511\ntimeout 0\ntcp-keepalive 300\n#这里使用jinja\ndaemonize {{ DAEMONIZA }}\nsupervised no\npidfile /var/run/redis_6379.pid\nloglevel notice\nlogfile /var/log/redis/redis.log\ndatabases 16\nsave 900 1\nsave 300 10\nsave 60 10000\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename dump.rdb\ndir /var/lib/redis\nslave-serve-stale-data yes\nslave-read-only yes\nrepl-diskless-sync no\nrepl-diskless-sync-delay 5\nrepl-disable-tcp-nodelay no\nslave-priority 100\nappendonly no\nappendfilename \"appendonly.aof\"\nappendfsync everysec\nno-appendfsync-on-rewrite no\nauto-aof-rewrite-percentage 100\nauto-aof-rewrite-min-size 64mb\naof-load-truncated yes\nlua-time-limit 5000\nslowlog-log-slower-than 10000\nslowlog-max-len 128\nlatency-monitor-threshold 0\nnotify-keyspace-events \"\"\nhash-max-ziplist-entries 512\nhash-max-ziplist-value 64\nlist-max-ziplist-size -2\nlist-compress-depth 0\nset-max-intset-entries 512\nzset-max-ziplist-entries 128\nzset-max-ziplist-value 64\nhll-sparse-max-bytes 3000\nactiverehashing yes\nclient-output-buffer-limit normal 0 0 0\nclient-output-buffer-limit slave 256mb 64mb 60\nclient-output-buffer-limit pubsub 32mb 8mb 60\nhz 10\naof-rewrite-incremental-fsync yes\n```\n5）`top file`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  'salt-minion02':\n    - redis.master\n  'salt-minion03':\n    - redis.slave\n```\n6）整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/prod/redis/\n/srv/salt/prod/redis/\n├── files\n│   └── redis.conf\n├── init.sls\n├── master.sls\n└── slave.sls\n\n1 directory, 4 files\n```\n7）`top file`高级状态执行\n```\n#先测试下看下状态文件是否编写正确，再正式执行\n[root@salt-master ~]# salt '*' state.highstate test=True\n[root@salt-master ~]# salt '*' state.highstate\n```\n","source":"_posts/saltstack状态判断unless与onlyif.md","raw":"---\ntitle: saltstack状态判断unless与onlyif\ndate: 2019-05-17 15:43:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n>很多时候我们在编写`state` 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的`unless`和`onlyif`。\n\n## unless\n`unless`示例：需求创建`/tmp/unless.txt`文件，存在则不创建，不存在则创建\n```\n[root@salt-master ~]# cat /srv/salt/prod/unless.sls \ntest-unless:\n  cmd.run:\n    - name: touch /tmp/unless.txt\n    - unless: test -f /tmp/unless.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: Command \"touch /tmp/unless.txt\" run\n     Started: 15:10:51.522319\n    Duration: 31.822 ms\n     Changes:   \n              ----------\n              pid:\n                  6538\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  31.822 ms\n#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls unless saltenv=prod\nsalt-minion01:\n----------\n          ID: test-unless\n    Function: cmd.run\n        Name: touch /tmp/unless.txt\n      Result: True\n     Comment: unless condition is true\n     Started: 15:11:40.819789\n    Duration: 10.477 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  10.477 ms\n#第二次执行，可以看到该文件已经存在，并没有再次创建\n```\n>通过上面的小案例可以看出，当`unless`返回为真则不执行，当`unless`返回为假才执行。\n\n## onlyif\n> `onlyif`正好和`unless`相反，当`onlyif`返回为真执行，当`onlyif`返回为假不执行\n\n`onlyif`示例：需求，当`/tmp/onlyif.txt`文件存在，则创建`/tmp/onlyif`目录，不存在，则不创建`/tmp/onlyif`目录\n```\n[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls \ntest-onlyif:\n  cmd.run:\n    - name: mkdir /tmp/onlyif\n    - onlyif: test -f /tmp/onlyif.txt\n\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: onlyif condition is false\n     Started: 15:34:56.460583\n    Duration: 9.612 ms\n     Changes:   \n\nSummary for salt-minion01\n------------\nSucceeded: 1\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:   9.612 ms\n\n#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行\n[root@salt-master ~]# salt 'salt-minion01' cmd.run \"touch /tmp/onlyif.txt\"\nsalt-minion01:\n[root@salt-master ~]# salt 'salt-minion01' state.sls onlyif saltenv=prod\nsalt-minion01:\n----------\n          ID: test-onlyif\n    Function: cmd.run\n        Name: mkdir /tmp/onlyif\n      Result: True\n     Comment: Command \"mkdir /tmp/onlyif\" run\n     Started: 15:38:07.712492\n    Duration: 14.646 ms\n     Changes:   \n              ----------\n              pid:\n                  6871\n              retcode:\n                  0\n              stderr:\n              stdout:\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  14.646 ms\n\n#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录\n```\n## Redis主从架构案例\n说明：该案例在`prod`环境配置\n![redis主从环境](https://upload-images.jianshu.io/upload_images/11763553-bc3bd43a55d275ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir -p /srv/salt/prod/redis/files/\n```\n3）编写`state sls`状态文件\n```\n#初始化redis（安装和基本配置）\n[root@salt-master ~]# cat /srv/salt/prod/redis/init.sls \nredis-install:\n  pkg.installed:\n    - name: redis\n\nredis-config:\n  file.managed:\n    - name: /etc/redis.conf\n    - source: salt://redis/files/redis.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      BIND: {{ grains['fqdn_ip4'][0] }}\n      PORT: 6379\n      DAEMONIZA: 'yes'\n    - require:\n      - pkg: redis-install\n\nredis-service:\n  service.running:\n    - name: redis\n    - enable: True\n    - watch:\n      - file: redis-config\n\n\n#master直接引入 init\n[root@salt-master ~]# cat /srv/salt/prod/redis/master.sls \ninclude:\n  - redis.init\n\n\n#slave引入init 并配置主从信息\n[root@salt-master ~]# cat /srv/salt/prod/redis/slave.sls \ninclude:\n  - redis.init\n\n#配置主从\nslave-config:\n  cmd.run:\n    - name: redis-cli -h 192.168.1.34 slaveof 192.168.1.33 6379\n    - unless: redis-cli -h 192.168.1.34 info |grep role:slave\n    - require:\n      - service: redis-service\n\n说明：\nunless：返回为真则不执行，反之为假则执行\n```\n4）配置文件准备\n```\n[root@salt-master ~]# grep \"^[a-Z]\" /etc/redis.conf  >>/srv/salt/prod/redis/files/redis.conf\n[root@salt-master ~]# cat /srv/salt/prod/redis/files/redis.conf \n#这里使用jinja\nbind {{ BIND }}\nprotected-mode yes\n#这里使用jinja\nport {{ PORT }}\ntcp-backlog 511\ntimeout 0\ntcp-keepalive 300\n#这里使用jinja\ndaemonize {{ DAEMONIZA }}\nsupervised no\npidfile /var/run/redis_6379.pid\nloglevel notice\nlogfile /var/log/redis/redis.log\ndatabases 16\nsave 900 1\nsave 300 10\nsave 60 10000\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename dump.rdb\ndir /var/lib/redis\nslave-serve-stale-data yes\nslave-read-only yes\nrepl-diskless-sync no\nrepl-diskless-sync-delay 5\nrepl-disable-tcp-nodelay no\nslave-priority 100\nappendonly no\nappendfilename \"appendonly.aof\"\nappendfsync everysec\nno-appendfsync-on-rewrite no\nauto-aof-rewrite-percentage 100\nauto-aof-rewrite-min-size 64mb\naof-load-truncated yes\nlua-time-limit 5000\nslowlog-log-slower-than 10000\nslowlog-max-len 128\nlatency-monitor-threshold 0\nnotify-keyspace-events \"\"\nhash-max-ziplist-entries 512\nhash-max-ziplist-value 64\nlist-max-ziplist-size -2\nlist-compress-depth 0\nset-max-intset-entries 512\nzset-max-ziplist-entries 128\nzset-max-ziplist-value 64\nhll-sparse-max-bytes 3000\nactiverehashing yes\nclient-output-buffer-limit normal 0 0 0\nclient-output-buffer-limit slave 256mb 64mb 60\nclient-output-buffer-limit pubsub 32mb 8mb 60\nhz 10\naof-rewrite-incremental-fsync yes\n```\n5）`top file`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  'salt-minion02':\n    - redis.master\n  'salt-minion03':\n    - redis.slave\n```\n6）整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/prod/redis/\n/srv/salt/prod/redis/\n├── files\n│   └── redis.conf\n├── init.sls\n├── master.sls\n└── slave.sls\n\n1 directory, 4 files\n```\n7）`top file`高级状态执行\n```\n#先测试下看下状态文件是否编写正确，再正式执行\n[root@salt-master ~]# salt '*' state.highstate test=True\n[root@salt-master ~]# salt '*' state.highstate\n```\n","slug":"saltstack状态判断unless与onlyif","published":1,"updated":"2019-05-17T13:23:21.440Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4lb0014m834mdjpubox","content":"<blockquote>\n<p>很多时候我们在编写<code>state</code> 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的<code>unless</code>和<code>onlyif</code>。</p>\n</blockquote>\n<h2 id=\"unless\"><a href=\"#unless\" class=\"headerlink\" title=\"unless\"></a>unless</h2><p><code>unless</code>示例：需求创建<code>/tmp/unless.txt</code>文件，存在则不创建，不存在则创建<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/unless.sls </span><br><span class=\"line\">test-unless:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">    - unless: test -f /tmp/unless.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"touch /tmp/unless.txt\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:10:51.522319</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 31.822 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6538</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  31.822 ms</span><br><span class=\"line\">#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: unless condition is true</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:11:40.819789</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 10.477 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  10.477 ms</span><br><span class=\"line\">#第二次执行，可以看到该文件已经存在，并没有再次创建</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>通过上面的小案例可以看出，当<code>unless</code>返回为真则不执行，当<code>unless</code>返回为假才执行。</p>\n</blockquote>\n<h2 id=\"onlyif\"><a href=\"#onlyif\" class=\"headerlink\" title=\"onlyif\"></a>onlyif</h2><blockquote>\n<p><code>onlyif</code>正好和<code>unless</code>相反，当<code>onlyif</code>返回为真执行，当<code>onlyif</code>返回为假不执行</p>\n</blockquote>\n<p><code>onlyif</code>示例：需求，当<code>/tmp/onlyif.txt</code>文件存在，则创建<code>/tmp/onlyif</code>目录，不存在，则不创建<code>/tmp/onlyif</code>目录<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls </span><br><span class=\"line\">test-onlyif:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">    - onlyif: test -f /tmp/onlyif.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: onlyif condition is false</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:34:56.460583</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 9.612 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:   9.612 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> cmd.run \"touch /tmp/onlyif.txt\"</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"mkdir /tmp/onlyif\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:38:07.712492</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 14.646 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6871</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  14.646 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Redis主从架构案例\"><a href=\"#Redis主从架构案例\" class=\"headerlink\" title=\"Redis主从架构案例\"></a>Redis主从架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-bc3bd43a55d275ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"redis主从环境\"></p>\n<p>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/prod/redis/files/</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>state sls</code>状态文件<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#初始化redis（安装和基本配置）</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/init.sls</span> </span><br><span class=\"line\"><span class=\"attr\">redis-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://redis/files/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      BIND:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">      DAEMONIZA:</span> <span class=\"string\">'yes'</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">redis-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">redis-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#master直接引入 init</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/master.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#slave引入init 并配置主从信息</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/slave.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置主从</span></span><br><span class=\"line\"><span class=\"attr\">slave-config:</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">slaveof</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">info</span> <span class=\"string\">|grep</span> <span class=\"attr\">role:slave</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - service:</span> <span class=\"string\">redis-service</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">说明：</span></span><br><span class=\"line\"><span class=\"string\">unless：返回为真则不执行，反之为假则执行</span></span><br></pre></td></tr></table></figure></p>\n<p>4）配置文件准备<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">grep</span> <span class=\"string\">\"^[a-Z]\"</span> /etc/redis.<span class=\"keyword\">conf</span>  &gt;&gt;/srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span> </span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">bind &#123;&#123; BIND &#125;&#125;</span><br><span class=\"line\">protected-<span class=\"keyword\">mode</span> yes</span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">port &#123;&#123; PORT &#125;&#125;</span><br><span class=\"line\">tcp-backlog <span class=\"number\">511</span></span><br><span class=\"line\">timeout <span class=\"number\">0</span></span><br><span class=\"line\">tcp-keepalive <span class=\"number\">300</span></span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">daemonize &#123;&#123; DAEMONIZA &#125;&#125;</span><br><span class=\"line\">supervised <span class=\"keyword\">no</span></span><br><span class=\"line\">pidfile /var/run/redis_6379.pid</span><br><span class=\"line\">loglevel notice</span><br><span class=\"line\">logfile /var/<span class=\"built_in\">log</span>/redis/redis.<span class=\"built_in\">log</span></span><br><span class=\"line\">databases <span class=\"number\">16</span></span><br><span class=\"line\">save <span class=\"number\">900</span> <span class=\"number\">1</span></span><br><span class=\"line\">save <span class=\"number\">300</span> <span class=\"number\">10</span></span><br><span class=\"line\">save <span class=\"number\">60</span> <span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"keyword\">stop</span>-writes-<span class=\"keyword\">on</span>-bgsave-error yes</span><br><span class=\"line\">rdbcompression yes</span><br><span class=\"line\">rdbchecksum yes</span><br><span class=\"line\">dbfilename dump.rdb</span><br><span class=\"line\">dir /var/lib/redis</span><br><span class=\"line\">slave-serve-stale-data yes</span><br><span class=\"line\">slave-<span class=\"keyword\">read</span>-<span class=\"keyword\">only</span> yes</span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span> <span class=\"keyword\">no</span></span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span>-delay <span class=\"number\">5</span></span><br><span class=\"line\">repl-disable-tcp-nodelay <span class=\"keyword\">no</span></span><br><span class=\"line\">slave-priority <span class=\"number\">100</span></span><br><span class=\"line\">appendonly <span class=\"keyword\">no</span></span><br><span class=\"line\">appendfilename <span class=\"string\">\"appendonly.aof\"</span></span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"><span class=\"keyword\">no</span>-appendfsync-<span class=\"keyword\">on</span>-rewrite <span class=\"keyword\">no</span></span><br><span class=\"line\">auto-aof-rewrite-percentage <span class=\"number\">100</span></span><br><span class=\"line\">auto-aof-rewrite-<span class=\"built_in\">min</span>-size <span class=\"number\">64</span>mb</span><br><span class=\"line\">aof-load-truncated yes</span><br><span class=\"line\"><span class=\"keyword\">lua</span>-time-limit <span class=\"number\">5000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">log</span>-slower-than <span class=\"number\">10000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">max</span>-<span class=\"built_in\">len</span> <span class=\"number\">128</span></span><br><span class=\"line\">latency-monitor-threshold <span class=\"number\">0</span></span><br><span class=\"line\">notify-keyspace-events <span class=\"string\">\"\"</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">512</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-<span class=\"built_in\">max</span>-ziplist-size -<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-compress-depth <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">set</span>-<span class=\"built_in\">max</span>-intset-entries <span class=\"number\">512</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">128</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\">hll-sparse-<span class=\"built_in\">max</span>-bytes <span class=\"number\">3000</span></span><br><span class=\"line\">activerehashing yes</span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit <span class=\"keyword\">normal</span> <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">0</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit slave <span class=\"number\">256</span>mb <span class=\"number\">64</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit pubsub <span class=\"number\">32</span>mb <span class=\"number\">8</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">hz <span class=\"number\">10</span></span><br><span class=\"line\">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>top file</code>文件编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  'salt-minion02':</span><br><span class=\"line\">    - redis.<span class=\"literal\">master</span></span><br><span class=\"line\">  'salt-minion03':</span><br><span class=\"line\">    - redis.<span class=\"literal\">slave</span></span><br></pre></td></tr></table></figure></p>\n<p>6）整体<code>state</code>文件查看<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /srv/salt/prod/redis/</span><br><span class=\"line\">/srv/salt/prod/redis/</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── redis.conf</span><br><span class=\"line\">├── init.sls</span><br><span class=\"line\">├── <span class=\"literal\">master</span>.sls</span><br><span class=\"line\">└── <span class=\"literal\">slave</span>.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">4</span> files</span><br></pre></td></tr></table></figure></p>\n<p>7）<code>top file</code>高级状态执行<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#先测试下看下状态文件是否编写正确，再正式执行</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate <span class=\"attr\">test=</span><span class=\"literal\">True</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>很多时候我们在编写<code>state</code> 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的<code>unless</code>和<code>onlyif</code>。</p>\n</blockquote>\n<h2 id=\"unless\"><a href=\"#unless\" class=\"headerlink\" title=\"unless\"></a>unless</h2><p><code>unless</code>示例：需求创建<code>/tmp/unless.txt</code>文件，存在则不创建，不存在则创建<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/unless.sls </span><br><span class=\"line\">test-unless:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">    - unless: test -f /tmp/unless.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"touch /tmp/unless.txt\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:10:51.522319</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 31.822 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6538</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  31.822 ms</span><br><span class=\"line\">#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-unless</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: touch /tmp/unless.txt</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: unless condition is true</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:11:40.819789</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 10.477 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  10.477 ms</span><br><span class=\"line\">#第二次执行，可以看到该文件已经存在，并没有再次创建</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>通过上面的小案例可以看出，当<code>unless</code>返回为真则不执行，当<code>unless</code>返回为假才执行。</p>\n</blockquote>\n<h2 id=\"onlyif\"><a href=\"#onlyif\" class=\"headerlink\" title=\"onlyif\"></a>onlyif</h2><blockquote>\n<p><code>onlyif</code>正好和<code>unless</code>相反，当<code>onlyif</code>返回为真执行，当<code>onlyif</code>返回为假不执行</p>\n</blockquote>\n<p><code>onlyif</code>示例：需求，当<code>/tmp/onlyif.txt</code>文件存在，则创建<code>/tmp/onlyif</code>目录，不存在，则不创建<code>/tmp/onlyif</code>目录<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls </span><br><span class=\"line\">test-onlyif:</span><br><span class=\"line\"><span class=\"code\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"code\">    - name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">    - onlyif: test -f /tmp/onlyif.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: onlyif condition is false</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:34:56.460583</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 9.612 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:   9.612 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> cmd.run \"touch /tmp/onlyif.txt\"</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"emphasis\">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">----------</span><br><span class=\"line\"><span class=\"code\">          ID: test-onlyif</span></span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: mkdir /tmp/onlyif</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"mkdir /tmp/onlyif\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 15:38:07.712492</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 14.646 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  6871</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  14.646 ms</span><br><span class=\"line\"></span><br><span class=\"line\">#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Redis主从架构案例\"><a href=\"#Redis主从架构案例\" class=\"headerlink\" title=\"Redis主从架构案例\"></a>Redis主从架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-bc3bd43a55d275ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"redis主从环境\"></p>\n<p>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/prod/redis/files/</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>state sls</code>状态文件<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#初始化redis（安装和基本配置）</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/init.sls</span> </span><br><span class=\"line\"><span class=\"attr\">redis-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://redis/files/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      BIND:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">      DAEMONIZA:</span> <span class=\"string\">'yes'</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">redis-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">redis-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">redis-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#master直接引入 init</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/master.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#slave引入init 并配置主从信息</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/redis/slave.sls</span> </span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">redis.init</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置主从</span></span><br><span class=\"line\"><span class=\"attr\">slave-config:</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">slaveof</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.33</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">redis-cli</span> <span class=\"bullet\">-h</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.34</span> <span class=\"string\">info</span> <span class=\"string\">|grep</span> <span class=\"attr\">role:slave</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - service:</span> <span class=\"string\">redis-service</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">说明：</span></span><br><span class=\"line\"><span class=\"string\">unless：返回为真则不执行，反之为假则执行</span></span><br></pre></td></tr></table></figure></p>\n<p>4）配置文件准备<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">grep</span> <span class=\"string\">\"^[a-Z]\"</span> /etc/redis.<span class=\"keyword\">conf</span>  &gt;&gt;/srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/redis/<span class=\"keyword\">files</span>/redis.<span class=\"keyword\">conf</span> </span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">bind &#123;&#123; BIND &#125;&#125;</span><br><span class=\"line\">protected-<span class=\"keyword\">mode</span> yes</span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">port &#123;&#123; PORT &#125;&#125;</span><br><span class=\"line\">tcp-backlog <span class=\"number\">511</span></span><br><span class=\"line\">timeout <span class=\"number\">0</span></span><br><span class=\"line\">tcp-keepalive <span class=\"number\">300</span></span><br><span class=\"line\">#这里使用jinja</span><br><span class=\"line\">daemonize &#123;&#123; DAEMONIZA &#125;&#125;</span><br><span class=\"line\">supervised <span class=\"keyword\">no</span></span><br><span class=\"line\">pidfile /var/run/redis_6379.pid</span><br><span class=\"line\">loglevel notice</span><br><span class=\"line\">logfile /var/<span class=\"built_in\">log</span>/redis/redis.<span class=\"built_in\">log</span></span><br><span class=\"line\">databases <span class=\"number\">16</span></span><br><span class=\"line\">save <span class=\"number\">900</span> <span class=\"number\">1</span></span><br><span class=\"line\">save <span class=\"number\">300</span> <span class=\"number\">10</span></span><br><span class=\"line\">save <span class=\"number\">60</span> <span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"keyword\">stop</span>-writes-<span class=\"keyword\">on</span>-bgsave-error yes</span><br><span class=\"line\">rdbcompression yes</span><br><span class=\"line\">rdbchecksum yes</span><br><span class=\"line\">dbfilename dump.rdb</span><br><span class=\"line\">dir /var/lib/redis</span><br><span class=\"line\">slave-serve-stale-data yes</span><br><span class=\"line\">slave-<span class=\"keyword\">read</span>-<span class=\"keyword\">only</span> yes</span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span> <span class=\"keyword\">no</span></span><br><span class=\"line\">repl-diskless-<span class=\"keyword\">sync</span>-delay <span class=\"number\">5</span></span><br><span class=\"line\">repl-disable-tcp-nodelay <span class=\"keyword\">no</span></span><br><span class=\"line\">slave-priority <span class=\"number\">100</span></span><br><span class=\"line\">appendonly <span class=\"keyword\">no</span></span><br><span class=\"line\">appendfilename <span class=\"string\">\"appendonly.aof\"</span></span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"><span class=\"keyword\">no</span>-appendfsync-<span class=\"keyword\">on</span>-rewrite <span class=\"keyword\">no</span></span><br><span class=\"line\">auto-aof-rewrite-percentage <span class=\"number\">100</span></span><br><span class=\"line\">auto-aof-rewrite-<span class=\"built_in\">min</span>-size <span class=\"number\">64</span>mb</span><br><span class=\"line\">aof-load-truncated yes</span><br><span class=\"line\"><span class=\"keyword\">lua</span>-time-limit <span class=\"number\">5000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">log</span>-slower-than <span class=\"number\">10000</span></span><br><span class=\"line\">slowlog-<span class=\"built_in\">max</span>-<span class=\"built_in\">len</span> <span class=\"number\">128</span></span><br><span class=\"line\">latency-monitor-threshold <span class=\"number\">0</span></span><br><span class=\"line\">notify-keyspace-events <span class=\"string\">\"\"</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">512</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-<span class=\"built_in\">max</span>-ziplist-size -<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"keyword\">list</span>-compress-depth <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">set</span>-<span class=\"built_in\">max</span>-intset-entries <span class=\"number\">512</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">128</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-value <span class=\"number\">64</span></span><br><span class=\"line\">hll-sparse-<span class=\"built_in\">max</span>-bytes <span class=\"number\">3000</span></span><br><span class=\"line\">activerehashing yes</span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit <span class=\"keyword\">normal</span> <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">0</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit slave <span class=\"number\">256</span>mb <span class=\"number\">64</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">client-output-<span class=\"keyword\">buffer</span>-limit pubsub <span class=\"number\">32</span>mb <span class=\"number\">8</span>mb <span class=\"number\">60</span></span><br><span class=\"line\">hz <span class=\"number\">10</span></span><br><span class=\"line\">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure></p>\n<p>5）<code>top file</code>文件编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  'salt-minion02':</span><br><span class=\"line\">    - redis.<span class=\"literal\">master</span></span><br><span class=\"line\">  'salt-minion03':</span><br><span class=\"line\">    - redis.<span class=\"literal\">slave</span></span><br></pre></td></tr></table></figure></p>\n<p>6）整体<code>state</code>文件查看<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /srv/salt/prod/redis/</span><br><span class=\"line\">/srv/salt/prod/redis/</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── redis.conf</span><br><span class=\"line\">├── init.sls</span><br><span class=\"line\">├── <span class=\"literal\">master</span>.sls</span><br><span class=\"line\">└── <span class=\"literal\">slave</span>.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">4</span> files</span><br></pre></td></tr></table></figure></p>\n<p>7）<code>top file</code>高级状态执行<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#先测试下看下状态文件是否编写正确，再正式执行</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate <span class=\"attr\">test=</span><span class=\"literal\">True</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.highstate</span><br></pre></td></tr></table></figure></p>\n"},{"_content":"安装完`Saltstack`后可以立即执行`shell`命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：http://docs.saltstack.cn/topics/tutorials/modules.html\n```\n[root@salt-master ~]# salt '*' cmd.run \"uptime\"\nsalt-minion01:\n     15:23:08 up 1 day, 58 min,  2 users,  load average: 0.00, 0.03, 0.08\nsalt-minion02:\n     15:23:08 up 21:38,  2 users,  load average: 0.00, 0.04, 0.10\nsalt-minion03:\n     15:23:08 up 21:36,  2 users,  load average: 0.00, 0.04, 0.10\n```\n\n## Salt命令的结构语法\n```\nsalt '<target>' <function> [arguments]\n```\n\n![](https://upload-images.jianshu.io/upload_images/11763553-e5e69a972680590f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n## 目标主机Target\n![](https://upload-images.jianshu.io/upload_images/11763553-e3ed49a6c6b6633f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n1、通配符匹配\n```\n[root@salt-master ~]# salt '*' test.ping\n[root@salt-master ~]# salt 'salt-minion01' test.ping\n[root@salt-master ~]# salt '*01' test.ping\n[root@salt-master ~]# salt 'salt-minion0[1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0[!1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0?' test.ping\n```\n2、列表匹配\n```\n[root@salt-master ~]# salt -L 'salt-minion01,salt-minion02' test.ping\n```\n3、正则匹配\n```\n[root@salt-master ~]# salt -E '^salt' test.ping\n[root@salt-master ~]# salt -E '^salt.*2$' test.ping\n```\n4、IP匹配\n```\n[root@salt-master ~]# salt -S '192.168.1.32' test.ping\n[root@salt-master ~]# salt -S '192.168.1.0/24' test.ping\n```\n5、复合匹配\n```\n[root@salt-master ~]# salt -C 'G@os:CentOS and S@192.168.1.32' test.ping\n```\n6、分组匹配\n```\n[root@salt-master ~]# vim /etc/salt/master\nnodegroups:\n  webserver: 'salt-minion01,salt-minion02'\n  dbserver: 'salt-minion03\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# salt -N 'webserver' test.ping\n[root@salt-master ~]# salt -N 'dbserver' test.ping\n```\n7、Grains匹配\n```\n[root@salt-master ~]# salt -G 'os:CentOS' test.ping\n[root@salt-master ~]# salt -G 'localhost:salt-minion02' test.ping\n```\n> 说明：上面这些匹配方式在`top.sls`文件中同样适用。\n## 模块Module\n![](https://upload-images.jianshu.io/upload_images/11763553-18184de0fb7156aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n> `test`模块多用于测试\n`user`模块用于用户管理\n`cmd`模块可以执行任意`shell`命令\n`pkg`模块用于软件包管理\n`file`模块多用于配置\n`service`模块用于服务管理\n\n[所有模块列表](http://docs.saltstack.cn/ref/modules/all/index.html)\n\n**test模块**\n```\n模块名：test\n功能：用于测试\n[root@salt-master ~]# salt '*' test.ping\n```\n**user模块**\n```\n参考：http://docs.saltstack.cn/ref/modules/all/salt.modules.useradd.html#module-salt.modules.useradd\n# salt '*' user.add name <uid> <gid> <groups> <home> <shell>\n[root@salt-master ~]# salt '*' user.add testuser\n```\n**cmd模块**\n```\n模块名：cmd\n功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）\n#查看所有minion内存和磁盘使用情况\n[root@salt-master ~]# salt '*' cmd.run \"free -m\"\n[root@salt-master ~]# salt '*' cmd.run \"df -h\"\n```\n**pkg模块**\n```\n模块名：pkg\n功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）\n\n#安装\n[root@salt-master ~]# salt '*' pkg.install \"vsftpd\" \n#卸载\n[root@salt-master ~]# salt '*' pkg.remove \"vsftpd\"\n#安装最新版本\n[root@salt-master ~]# salt '*' pkg.latest_version \"vsftpd\"\n#更新软件包\n[root@salt-master ~]# salt '*' pkg.upgrade \"vsftpd\"\n\n#查看帮助手册\n[root@salt-master ~]# salt '*' pkg\n```\n**file模块**\n```\n模块名：file\n功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验\n\n#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法\n[root@salt-master ~]# salt '*' file.get_sum /etc/passwd md5\n\n#修改所有minion主机/etc/passwd文件的属组、用户权限、等价于chown root:root /etc/passwd\n[root@salt-master ~]# salt '*' file.chown /etc/passwd root root\n\n#获取所有minion主机/etc/passwd的stats信息\n[root@salt-master ~]# salt '*' file.stats /etc/passwd\n\n#获取所有minion主机/etc/passwd的权限mode,如755,644\n[root@salt-master ~]# salt '*' file.get_mode /etc/passwd\n\n#修改所有minion主机/etc/passwd的权限mode为0644\n[root@salt-master ~]# salt '*' file.set_mode /etc/passwd 0644\n\n#在所有minion主机创建/opt/test目录\n[root@salt-master ~]# salt '*' file.mkdir /opt/test\n\n#在所有minion主机穿件/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.touch /tmp/test.conf\n\n#将所有minion主机/tmp/test.conf文件追加内容'maxclient 100'\n[root@salt-master ~]# salt '*' file.append /tmp/test.conf 'maxclient 100'\n\n#删除所有minion主机的/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.remove /tmp/test.conf\n```\n**service模块**\n```\n模块名：service\n功能：被控主机程序包服务管理\n\n#开启（enable）禁用（disable）\nsalt '*' service.enable <service name>\nsalt '*' service.disabled <service name>\n\n#reload、restart、start、stop、status操作\nsalt '*' service.reload <service name>\nsalt '*' service.restart <service name>\nsalt '*' service.start <service name>\nsalt '*' service.stop <service name>\nsalt '*' service.status <service name>\n```\n\n\n\n\n\n","source":"_posts/saltstack远程执行.md","raw":"安装完`Saltstack`后可以立即执行`shell`命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：http://docs.saltstack.cn/topics/tutorials/modules.html\n```\n[root@salt-master ~]# salt '*' cmd.run \"uptime\"\nsalt-minion01:\n     15:23:08 up 1 day, 58 min,  2 users,  load average: 0.00, 0.03, 0.08\nsalt-minion02:\n     15:23:08 up 21:38,  2 users,  load average: 0.00, 0.04, 0.10\nsalt-minion03:\n     15:23:08 up 21:36,  2 users,  load average: 0.00, 0.04, 0.10\n```\n\n## Salt命令的结构语法\n```\nsalt '<target>' <function> [arguments]\n```\n\n![](https://upload-images.jianshu.io/upload_images/11763553-e5e69a972680590f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n## 目标主机Target\n![](https://upload-images.jianshu.io/upload_images/11763553-e3ed49a6c6b6633f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n1、通配符匹配\n```\n[root@salt-master ~]# salt '*' test.ping\n[root@salt-master ~]# salt 'salt-minion01' test.ping\n[root@salt-master ~]# salt '*01' test.ping\n[root@salt-master ~]# salt 'salt-minion0[1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0[!1|2]' test.ping\n[root@salt-master ~]# salt 'salt-minion0?' test.ping\n```\n2、列表匹配\n```\n[root@salt-master ~]# salt -L 'salt-minion01,salt-minion02' test.ping\n```\n3、正则匹配\n```\n[root@salt-master ~]# salt -E '^salt' test.ping\n[root@salt-master ~]# salt -E '^salt.*2$' test.ping\n```\n4、IP匹配\n```\n[root@salt-master ~]# salt -S '192.168.1.32' test.ping\n[root@salt-master ~]# salt -S '192.168.1.0/24' test.ping\n```\n5、复合匹配\n```\n[root@salt-master ~]# salt -C 'G@os:CentOS and S@192.168.1.32' test.ping\n```\n6、分组匹配\n```\n[root@salt-master ~]# vim /etc/salt/master\nnodegroups:\n  webserver: 'salt-minion01,salt-minion02'\n  dbserver: 'salt-minion03\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# salt -N 'webserver' test.ping\n[root@salt-master ~]# salt -N 'dbserver' test.ping\n```\n7、Grains匹配\n```\n[root@salt-master ~]# salt -G 'os:CentOS' test.ping\n[root@salt-master ~]# salt -G 'localhost:salt-minion02' test.ping\n```\n> 说明：上面这些匹配方式在`top.sls`文件中同样适用。\n## 模块Module\n![](https://upload-images.jianshu.io/upload_images/11763553-18184de0fb7156aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n> `test`模块多用于测试\n`user`模块用于用户管理\n`cmd`模块可以执行任意`shell`命令\n`pkg`模块用于软件包管理\n`file`模块多用于配置\n`service`模块用于服务管理\n\n[所有模块列表](http://docs.saltstack.cn/ref/modules/all/index.html)\n\n**test模块**\n```\n模块名：test\n功能：用于测试\n[root@salt-master ~]# salt '*' test.ping\n```\n**user模块**\n```\n参考：http://docs.saltstack.cn/ref/modules/all/salt.modules.useradd.html#module-salt.modules.useradd\n# salt '*' user.add name <uid> <gid> <groups> <home> <shell>\n[root@salt-master ~]# salt '*' user.add testuser\n```\n**cmd模块**\n```\n模块名：cmd\n功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）\n#查看所有minion内存和磁盘使用情况\n[root@salt-master ~]# salt '*' cmd.run \"free -m\"\n[root@salt-master ~]# salt '*' cmd.run \"df -h\"\n```\n**pkg模块**\n```\n模块名：pkg\n功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）\n\n#安装\n[root@salt-master ~]# salt '*' pkg.install \"vsftpd\" \n#卸载\n[root@salt-master ~]# salt '*' pkg.remove \"vsftpd\"\n#安装最新版本\n[root@salt-master ~]# salt '*' pkg.latest_version \"vsftpd\"\n#更新软件包\n[root@salt-master ~]# salt '*' pkg.upgrade \"vsftpd\"\n\n#查看帮助手册\n[root@salt-master ~]# salt '*' pkg\n```\n**file模块**\n```\n模块名：file\n功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验\n\n#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法\n[root@salt-master ~]# salt '*' file.get_sum /etc/passwd md5\n\n#修改所有minion主机/etc/passwd文件的属组、用户权限、等价于chown root:root /etc/passwd\n[root@salt-master ~]# salt '*' file.chown /etc/passwd root root\n\n#获取所有minion主机/etc/passwd的stats信息\n[root@salt-master ~]# salt '*' file.stats /etc/passwd\n\n#获取所有minion主机/etc/passwd的权限mode,如755,644\n[root@salt-master ~]# salt '*' file.get_mode /etc/passwd\n\n#修改所有minion主机/etc/passwd的权限mode为0644\n[root@salt-master ~]# salt '*' file.set_mode /etc/passwd 0644\n\n#在所有minion主机创建/opt/test目录\n[root@salt-master ~]# salt '*' file.mkdir /opt/test\n\n#在所有minion主机穿件/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.touch /tmp/test.conf\n\n#将所有minion主机/tmp/test.conf文件追加内容'maxclient 100'\n[root@salt-master ~]# salt '*' file.append /tmp/test.conf 'maxclient 100'\n\n#删除所有minion主机的/tmp/test.conf文件\n[root@salt-master ~]# salt '*' file.remove /tmp/test.conf\n```\n**service模块**\n```\n模块名：service\n功能：被控主机程序包服务管理\n\n#开启（enable）禁用（disable）\nsalt '*' service.enable <service name>\nsalt '*' service.disabled <service name>\n\n#reload、restart、start、stop、status操作\nsalt '*' service.reload <service name>\nsalt '*' service.restart <service name>\nsalt '*' service.start <service name>\nsalt '*' service.stop <service name>\nsalt '*' service.status <service name>\n```\n\n\n\n\n\n","slug":"saltstack远程执行","published":1,"date":"2019-05-28T13:19:13.931Z","updated":"2019-05-28T13:19:13.931Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4lc0016m834a8lvd88b","content":"<p>安装完<code>Saltstack</code>后可以立即执行<code>shell</code>命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：<a href=\"http://docs.saltstack.cn/topics/tutorials/modules.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/tutorials/modules.html</a><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># salt '*' cmd.run \"uptime\"</span></span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">     15:23:08 up 1 day, 58 min,  2 users,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.03</span>, <span class=\"number\">0.08</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion02:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">38</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion03:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">36</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Salt命令的结构语法\"><a href=\"#Salt命令的结构语法\" class=\"headerlink\" title=\"Salt命令的结构语法\"></a>Salt命令的结构语法</h2><figure class=\"highlight matlab\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">salt <span class=\"string\">'&lt;target&gt;'</span> &lt;<span class=\"function\"><span class=\"keyword\">function</span>&gt; <span class=\"params\">[arguments]</span></span></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-e5e69a972680590f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<h2 id=\"目标主机Target\"><a href=\"#目标主机Target\" class=\"headerlink\" title=\"目标主机Target\"></a>目标主机Target</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-e3ed49a6c6b6633f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt><br>1、通配符匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[!1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0?'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -L <span class=\"string\">'salt-minion01,salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>3、正则匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt.*2$'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>4、IP匹配<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span>' test.ping</span><br><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>5、复合匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -C 'G@os:CentOS <span class=\"keyword\">and</span> S@<span class=\"number\">192.168</span>.<span class=\"number\">1.32</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>6、分组匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">nodegroups:</span><br><span class=\"line\">  webserver: 'salt-minion01,salt-minion02'</span><br><span class=\"line\">  dbserver: 'salt-minion03</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'webserver' test.ping</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'dbserver' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>7、Grains匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'os:CentOS'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'localhost:salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>说明：上面这些匹配方式在<code>top.sls</code>文件中同样适用。</p>\n</blockquote>\n<h2 id=\"模块Module\"><a href=\"#模块Module\" class=\"headerlink\" title=\"模块Module\"></a>模块Module</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-18184de0fb7156aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<blockquote>\n<p><code>test</code>模块多用于测试<br><code>user</code>模块用于用户管理<br><code>cmd</code>模块可以执行任意<code>shell</code>命令<br><code>pkg</code>模块用于软件包管理<br><code>file</code>模块多用于配置<br><code>service</code>模块用于服务管理</p>\n</blockquote>\n<p><a href=\"http://docs.saltstack.cn/ref/modules/all/index.html\" target=\"_blank\" rel=\"noopener\">所有模块列表</a></p>\n<p><strong>test模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：test</span><br><span class=\"line\">功能：用于测试</span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>user模块</strong><br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">参考：http://docs.saltstack.<span class=\"keyword\">cn</span>/ref/modules/<span class=\"keyword\">all</span>/salt.modules.useradd.html#module-salt.modules.useradd</span><br><span class=\"line\"># salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> name <span class=\"symbol\">&lt;uid&gt;</span> <span class=\"symbol\">&lt;gid&gt;</span> <span class=\"symbol\">&lt;groups&gt;</span> <span class=\"symbol\">&lt;home&gt;</span> <span class=\"symbol\">&lt;shell&gt;</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> testuser</span><br></pre></td></tr></table></figure></p>\n<p><strong>cmd模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：cmd</span><br><span class=\"line\">功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）</span><br><span class=\"line\"><span class=\"meta\">#查看所有minion内存和磁盘使用情况</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"free -m\"</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"df -h\"</span></span></span><br></pre></td></tr></table></figure></p>\n<p><strong>pkg模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：pkg</span><br><span class=\"line\">功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.install <span class=\"string\">\"vsftpd\"</span> </span></span><br><span class=\"line\"><span class=\"meta\">#卸载</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.remove <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#安装最新版本</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.latest_version <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#更新软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.upgrade <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#查看帮助手册</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>file模块</strong><br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：<span class=\"keyword\">file</span></span><br><span class=\"line\">功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验</span><br><span class=\"line\"></span><br><span class=\"line\">#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_sum <span class=\"regexp\">/etc/</span>passwd md5</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd文件的属组、用户权限、等价于chown root:root <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.chown <span class=\"regexp\">/etc/</span>passwd root root</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的stats信息</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.stats <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode,如<span class=\"number\">755</span>,<span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_mode <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode为<span class=\"number\">0644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.set_mode <span class=\"regexp\">/etc/</span>passwd <span class=\"number\">0644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机创建<span class=\"regexp\">/opt/</span>test目录</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.mkdir <span class=\"regexp\">/opt/</span>test</span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机穿件<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.touch <span class=\"regexp\">/tmp/</span>test.conf</span><br><span class=\"line\"></span><br><span class=\"line\">#将所有minion主机<span class=\"regexp\">/tmp/</span>test.conf文件追加内容<span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.<span class=\"keyword\">append</span> <span class=\"regexp\">/tmp/</span>test.conf <span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\"></span><br><span class=\"line\">#删除所有minion主机的<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.remove <span class=\"regexp\">/tmp/</span>test.conf</span><br></pre></td></tr></table></figure></p>\n<p><strong>service模块</strong><br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：service</span><br><span class=\"line\">功能：被控主机程序包服务管理</span><br><span class=\"line\"></span><br><span class=\"line\">#开启（enable）禁用（disable）</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.enable</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.disabled</span> &lt;service name&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">#reload、restart、start、stop、status操作</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.reload</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.restart</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.start</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.stop</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.status</span> &lt;service name&gt;</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<p>安装完<code>Saltstack</code>后可以立即执行<code>shell</code>命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：<a href=\"http://docs.saltstack.cn/topics/tutorials/modules.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/tutorials/modules.html</a><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># salt '*' cmd.run \"uptime\"</span></span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">     15:23:08 up 1 day, 58 min,  2 users,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.03</span>, <span class=\"number\">0.08</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion02:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">38</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br><span class=\"line\"><span class=\"keyword\">salt</span>-minion03:</span><br><span class=\"line\">     <span class=\"number\">15</span>:<span class=\"number\">23</span>:<span class=\"number\">08</span> up <span class=\"number\">21</span>:<span class=\"number\">36</span>,  <span class=\"number\">2</span> <span class=\"keyword\">users</span>,  <span class=\"keyword\">load</span> average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.10</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Salt命令的结构语法\"><a href=\"#Salt命令的结构语法\" class=\"headerlink\" title=\"Salt命令的结构语法\"></a>Salt命令的结构语法</h2><figure class=\"highlight matlab\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">salt <span class=\"string\">'&lt;target&gt;'</span> &lt;<span class=\"function\"><span class=\"keyword\">function</span>&gt; <span class=\"params\">[arguments]</span></span></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-e5e69a972680590f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<h2 id=\"目标主机Target\"><a href=\"#目标主机Target\" class=\"headerlink\" title=\"目标主机Target\"></a>目标主机Target</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-e3ed49a6c6b6633f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt><br>1、通配符匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*01'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0[!1|2]'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion0?'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -L <span class=\"string\">'salt-minion01,salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>3、正则匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -E <span class=\"string\">'^salt.*2$'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p>4、IP匹配<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.32</span>' test.ping</span><br><span class=\"line\">[root@salt-master ~]# salt -S '<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>5、复合匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -C 'G@os:CentOS <span class=\"keyword\">and</span> S@<span class=\"number\">192.168</span>.<span class=\"number\">1.32</span>' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>6、分组匹配<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">nodegroups:</span><br><span class=\"line\">  webserver: 'salt-minion01,salt-minion02'</span><br><span class=\"line\">  dbserver: 'salt-minion03</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'webserver' test.ping</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> -N 'dbserver' test.ping</span><br></pre></td></tr></table></figure></p>\n<p>7、Grains匹配<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'os:CentOS'</span> test.ping</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt -G <span class=\"string\">'localhost:salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>说明：上面这些匹配方式在<code>top.sls</code>文件中同样适用。</p>\n</blockquote>\n<h2 id=\"模块Module\"><a href=\"#模块Module\" class=\"headerlink\" title=\"模块Module\"></a>模块Module</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-18184de0fb7156aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<blockquote>\n<p><code>test</code>模块多用于测试<br><code>user</code>模块用于用户管理<br><code>cmd</code>模块可以执行任意<code>shell</code>命令<br><code>pkg</code>模块用于软件包管理<br><code>file</code>模块多用于配置<br><code>service</code>模块用于服务管理</p>\n</blockquote>\n<p><a href=\"http://docs.saltstack.cn/ref/modules/all/index.html\" target=\"_blank\" rel=\"noopener\">所有模块列表</a></p>\n<p><strong>test模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：test</span><br><span class=\"line\">功能：用于测试</span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> test.ping</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>user模块</strong><br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">参考：http://docs.saltstack.<span class=\"keyword\">cn</span>/ref/modules/<span class=\"keyword\">all</span>/salt.modules.useradd.html#module-salt.modules.useradd</span><br><span class=\"line\"># salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> name <span class=\"symbol\">&lt;uid&gt;</span> <span class=\"symbol\">&lt;gid&gt;</span> <span class=\"symbol\">&lt;groups&gt;</span> <span class=\"symbol\">&lt;home&gt;</span> <span class=\"symbol\">&lt;shell&gt;</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> user.<span class=\"built_in\">add</span> testuser</span><br></pre></td></tr></table></figure></p>\n<p><strong>cmd模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：cmd</span><br><span class=\"line\">功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）</span><br><span class=\"line\"><span class=\"meta\">#查看所有minion内存和磁盘使用情况</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"free -m\"</span></span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"df -h\"</span></span></span><br></pre></td></tr></table></figure></p>\n<p><strong>pkg模块</strong><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：pkg</span><br><span class=\"line\">功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#安装</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.install <span class=\"string\">\"vsftpd\"</span> </span></span><br><span class=\"line\"><span class=\"meta\">#卸载</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.remove <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#安装最新版本</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.latest_version <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#更新软件包</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg.upgrade <span class=\"string\">\"vsftpd\"</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#查看帮助手册</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> pkg</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>file模块</strong><br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：<span class=\"keyword\">file</span></span><br><span class=\"line\">功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验</span><br><span class=\"line\"></span><br><span class=\"line\">#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_sum <span class=\"regexp\">/etc/</span>passwd md5</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd文件的属组、用户权限、等价于chown root:root <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.chown <span class=\"regexp\">/etc/</span>passwd root root</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的stats信息</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.stats <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#获取所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode,如<span class=\"number\">755</span>,<span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.get_mode <span class=\"regexp\">/etc/</span>passwd</span><br><span class=\"line\"></span><br><span class=\"line\">#修改所有minion主机<span class=\"regexp\">/etc/</span>passwd的权限mode为<span class=\"number\">0644</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.set_mode <span class=\"regexp\">/etc/</span>passwd <span class=\"number\">0644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机创建<span class=\"regexp\">/opt/</span>test目录</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.mkdir <span class=\"regexp\">/opt/</span>test</span><br><span class=\"line\"></span><br><span class=\"line\">#在所有minion主机穿件<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.touch <span class=\"regexp\">/tmp/</span>test.conf</span><br><span class=\"line\"></span><br><span class=\"line\">#将所有minion主机<span class=\"regexp\">/tmp/</span>test.conf文件追加内容<span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.<span class=\"keyword\">append</span> <span class=\"regexp\">/tmp/</span>test.conf <span class=\"string\">'maxclient 100'</span></span><br><span class=\"line\"></span><br><span class=\"line\">#删除所有minion主机的<span class=\"regexp\">/tmp/</span>test.conf文件</span><br><span class=\"line\">[root@salt-master ~]# salt <span class=\"string\">'*'</span> <span class=\"keyword\">file</span>.remove <span class=\"regexp\">/tmp/</span>test.conf</span><br></pre></td></tr></table></figure></p>\n<p><strong>service模块</strong><br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模块名：service</span><br><span class=\"line\">功能：被控主机程序包服务管理</span><br><span class=\"line\"></span><br><span class=\"line\">#开启（enable）禁用（disable）</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.enable</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.disabled</span> &lt;service name&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">#reload、restart、start、stop、status操作</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.reload</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.restart</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.start</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.stop</span> &lt;service name&gt;</span><br><span class=\"line\">salt <span class=\"string\">'*'</span> service<span class=\"selector-class\">.status</span> &lt;service name&gt;</span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack接口salt-api","date":"2019-05-20T14:04:05.000Z","copyright":true,"_content":"## 介绍\n[参考官档](https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html)\n[参考官档](https://www.unixhot.com/docs/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html#a-rest-api-for-salt)\n>`SaltStack`官方提供有`REST API`格式的`salt-api`项目，将使`salt`与第三方系统集成变得更加简单。\n\n## salt-api安装配置\n1）在`salt-master`上进行安装\n```\n[root@salt-master ~]# yum -y install salt-api\n```\n2）自签名证书，生产环境可以购买（说明：如果没有`salt-call`命令，装上`salt-minion`即可，依赖于该包）\n```\n[root@salt-master ~]# salt-call --local tls.create_self_signed_cert\nlocal:\n    Created Private Key: \"/etc/pki/tls/certs/localhost.key.\" Created Certificate: \"/etc/pki/tls/certs/localhost.crt.\"\n```\n3）打开`include`加载子配置文件，方便管理\n```\n[root@salt-master ~]# vim /etc/salt/master\ndefault_include: master.d/*.conf\n```\n4）配置`api`配置文件，将上面生成的证书写到配置文件\n```\n[root@salt-master ~]# vim /etc/salt/master.d/api.conf\nrest_cherrypy:\n  host: 192.168.1.30\n  port: 8000\n  ssl_crt: /etc/pki/tls/certs/localhost.crt\n  ssl_key: /etc/pki/tls/certs/localhost.key\n```\n5）创建认证用户，并设置密码\n```\n[root@salt-master ~]# useradd -M -s /sbin/nologin saltapi\n[root@salt-master ~]# echo 'saltapi' | passwd --stdin saltapi\n```\n6）创建认证配置文件\n```\n[root@salt-master ~]# vim /etc/salt/master.d/auth.conf\nexternal_auth:\n  pam:\n    saltapi:\n      - .*\n      - '@wheel'\n      - '@runner'\n      - '@jobs'\n```\n7）重启`salt-master`和启动`salt-api`\n```\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# systemctl start salt-api\n```\n8）查看`salt-api`监听端口\n```\n[root@salt-master ~]# netstat -anlutp |grep 8000\ntcp        0      0 192.168.1.30:8000       0.0.0.0:*               LISTEN      10904/python        \ntcp        0      0 192.168.1.30:53414      192.168.1.30:8000       TIME_WAIT   - \n```\n9）验证`login`登录，获取`token`字符串\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/login \\\n>     -H 'Accept: application/x-yaml' \\\n>     -d username=saltapi \\\n>     -d password=saltapi \\\n>     -d eauth=pam\nreturn:\n- eauth: pam\n  expire: 1558663247.869537\n  perms:\n  - .*\n  - '@wheel'\n  - '@runner'\n  - '@jobs'\n  start: 1558620047.869536\n  token: e8330f642a3addd853c723d63844d29a12de9484\n  user: saltapi\n```\n10）通过`api`执行`test.ping`测试连通性\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\\\n>     -d client=local \\\n>     -d tgt='*' \\\n>     -d fun=test.ping\nreturn:\n- salt-minion01: true\n  salt-minion02: true\n  salt-minion03: true\n  salt-minion04: true\n```\n11）通过`api`执行`cmd.run`\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\\\n>     -d client=local \\\n>     -d tgt='*' \\\n>     -d fun='cmd.run' -d arg='uptime'\nreturn:\n- salt-minion01: ' 22:10:25 up 46 min,  1 user,  load average: 0.00, 0.01, 0.05'\n  salt-minion02: ' 22:10:25 up 7 min,  0 users,  load average: 0.00, 0.18, 0.15'\n  salt-minion03: ' 22:10:25 up 7 min,  0 users,  load average: 0.06, 0.33, 0.26'\n  salt-minion04: ' 22:10:25 up 7 min,  0 users,  load average: 0.01, 0.21, 0.16'\n```\n12）通过`api`获取`grains`信息`\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/minions/salt-minion01 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\nreturn:\n- salt-minion01:\n    SSDs: []\n    biosreleasedate: 05/19/2017\n    biosversion: '6.00'\n    cpu_flags:\n    - fpu\n    - vme\n    - de\n    - pse\n    - tsc\n.....\n```\n13）使用`json`格式\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/minions/salt-minion01 \\\n>     -H 'Accept: application/json' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\n{\"return\": [{\"salt-minion01\": {\"biosversion\": \"6.00\", \"kernel\": \"Linux\", \"domain\": \"\", \"uid\": 0, \"zmqversion\": \"4.1.4\", \"kernelrelease\": \"3.10.0-693.el7.x86_64\", \"selinux\": {\"enforced\": \"Disabled\", \"enabled\": false}, \"serialnumber\": \"VMware-56 4d 9e a0 21 56 90 87-cd 89 69 32 13 94 17 44\", \"pid\": 1449, \"fqdns\": [], \"ip_interfaces\": {\"lo\": [\"127.0.0.1\", \"::1\"], \"virbr0\": [\"192.168.122.1\"], \"virbr0-nic\": [], \"ens33\": [\"192.168.1.31\", \"192.168.1.100\", \"fe80::20c:29ff:fe94:1744\"]}, \"groupname\": \"root\", \"fqdn_ip6\": [\"fe80::20c:29ff:fe94:1744\"],\n.......\n```\n\n## 总结\n>`salt-api`必须使用`https`，生产环境建议使用可信证书\n>当`salt-api`服务重启后原`token`失效\n\n","source":"_posts/saltstack接口salt-api.md","raw":"---\ntitle: saltstack接口salt-api\ndate: 2019-05-20 22:04:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## 介绍\n[参考官档](https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html)\n[参考官档](https://www.unixhot.com/docs/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html#a-rest-api-for-salt)\n>`SaltStack`官方提供有`REST API`格式的`salt-api`项目，将使`salt`与第三方系统集成变得更加简单。\n\n## salt-api安装配置\n1）在`salt-master`上进行安装\n```\n[root@salt-master ~]# yum -y install salt-api\n```\n2）自签名证书，生产环境可以购买（说明：如果没有`salt-call`命令，装上`salt-minion`即可，依赖于该包）\n```\n[root@salt-master ~]# salt-call --local tls.create_self_signed_cert\nlocal:\n    Created Private Key: \"/etc/pki/tls/certs/localhost.key.\" Created Certificate: \"/etc/pki/tls/certs/localhost.crt.\"\n```\n3）打开`include`加载子配置文件，方便管理\n```\n[root@salt-master ~]# vim /etc/salt/master\ndefault_include: master.d/*.conf\n```\n4）配置`api`配置文件，将上面生成的证书写到配置文件\n```\n[root@salt-master ~]# vim /etc/salt/master.d/api.conf\nrest_cherrypy:\n  host: 192.168.1.30\n  port: 8000\n  ssl_crt: /etc/pki/tls/certs/localhost.crt\n  ssl_key: /etc/pki/tls/certs/localhost.key\n```\n5）创建认证用户，并设置密码\n```\n[root@salt-master ~]# useradd -M -s /sbin/nologin saltapi\n[root@salt-master ~]# echo 'saltapi' | passwd --stdin saltapi\n```\n6）创建认证配置文件\n```\n[root@salt-master ~]# vim /etc/salt/master.d/auth.conf\nexternal_auth:\n  pam:\n    saltapi:\n      - .*\n      - '@wheel'\n      - '@runner'\n      - '@jobs'\n```\n7）重启`salt-master`和启动`salt-api`\n```\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# systemctl start salt-api\n```\n8）查看`salt-api`监听端口\n```\n[root@salt-master ~]# netstat -anlutp |grep 8000\ntcp        0      0 192.168.1.30:8000       0.0.0.0:*               LISTEN      10904/python        \ntcp        0      0 192.168.1.30:53414      192.168.1.30:8000       TIME_WAIT   - \n```\n9）验证`login`登录，获取`token`字符串\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/login \\\n>     -H 'Accept: application/x-yaml' \\\n>     -d username=saltapi \\\n>     -d password=saltapi \\\n>     -d eauth=pam\nreturn:\n- eauth: pam\n  expire: 1558663247.869537\n  perms:\n  - .*\n  - '@wheel'\n  - '@runner'\n  - '@jobs'\n  start: 1558620047.869536\n  token: e8330f642a3addd853c723d63844d29a12de9484\n  user: saltapi\n```\n10）通过`api`执行`test.ping`测试连通性\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\\\n>     -d client=local \\\n>     -d tgt='*' \\\n>     -d fun=test.ping\nreturn:\n- salt-minion01: true\n  salt-minion02: true\n  salt-minion03: true\n  salt-minion04: true\n```\n11）通过`api`执行`cmd.run`\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\\\n>     -d client=local \\\n>     -d tgt='*' \\\n>     -d fun='cmd.run' -d arg='uptime'\nreturn:\n- salt-minion01: ' 22:10:25 up 46 min,  1 user,  load average: 0.00, 0.01, 0.05'\n  salt-minion02: ' 22:10:25 up 7 min,  0 users,  load average: 0.00, 0.18, 0.15'\n  salt-minion03: ' 22:10:25 up 7 min,  0 users,  load average: 0.06, 0.33, 0.26'\n  salt-minion04: ' 22:10:25 up 7 min,  0 users,  load average: 0.01, 0.21, 0.16'\n```\n12）通过`api`获取`grains`信息`\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/minions/salt-minion01 \\\n>     -H 'Accept: application/x-yaml' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\nreturn:\n- salt-minion01:\n    SSDs: []\n    biosreleasedate: 05/19/2017\n    biosversion: '6.00'\n    cpu_flags:\n    - fpu\n    - vme\n    - de\n    - pse\n    - tsc\n.....\n```\n13）使用`json`格式\n```\n[root@salt-master ~]# curl -sSk https://192.168.1.30:8000/minions/salt-minion01 \\\n>     -H 'Accept: application/json' \\\n>     -H 'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'\n{\"return\": [{\"salt-minion01\": {\"biosversion\": \"6.00\", \"kernel\": \"Linux\", \"domain\": \"\", \"uid\": 0, \"zmqversion\": \"4.1.4\", \"kernelrelease\": \"3.10.0-693.el7.x86_64\", \"selinux\": {\"enforced\": \"Disabled\", \"enabled\": false}, \"serialnumber\": \"VMware-56 4d 9e a0 21 56 90 87-cd 89 69 32 13 94 17 44\", \"pid\": 1449, \"fqdns\": [], \"ip_interfaces\": {\"lo\": [\"127.0.0.1\", \"::1\"], \"virbr0\": [\"192.168.122.1\"], \"virbr0-nic\": [], \"ens33\": [\"192.168.1.31\", \"192.168.1.100\", \"fe80::20c:29ff:fe94:1744\"]}, \"groupname\": \"root\", \"fqdn_ip6\": [\"fe80::20c:29ff:fe94:1744\"],\n.......\n```\n\n## 总结\n>`salt-api`必须使用`https`，生产环境建议使用可信证书\n>当`salt-api`服务重启后原`token`失效\n\n","slug":"saltstack接口salt-api","published":1,"updated":"2019-05-23T15:15:21.768Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4le001am8340evu4z9h","content":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p><a href=\"https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html\" target=\"_blank\" rel=\"noopener\">参考官档</a><br><a href=\"https://www.unixhot.com/docs/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html#a-rest-api-for-salt\" target=\"_blank\" rel=\"noopener\">参考官档</a></p>\n<blockquote>\n<p><code>SaltStack</code>官方提供有<code>REST API</code>格式的<code>salt-api</code>项目，将使<code>salt</code>与第三方系统集成变得更加简单。</p>\n</blockquote>\n<h2 id=\"salt-api安装配置\"><a href=\"#salt-api安装配置\" class=\"headerlink\" title=\"salt-api安装配置\"></a>salt-api安装配置</h2><p>1）在<code>salt-master</code>上进行安装<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-api</span><br></pre></td></tr></table></figure></p>\n<p>2）自签名证书，生产环境可以购买（说明：如果没有<code>salt-call</code>命令，装上<code>salt-minion</code>即可，依赖于该包）<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt-call --local tls.create_self_signed_cert</span></span><br><span class=\"line\"><span class=\"keyword\">local</span>:</span><br><span class=\"line\">    Created Private Key: <span class=\"string\">\"/etc/pki/tls/certs/localhost.key.\"</span> Created Certificate: <span class=\"string\">\"/etc/pki/tls/certs/localhost.crt.\"</span></span><br></pre></td></tr></table></figure></p>\n<p>3）打开<code>include</code>加载子配置文件，方便管理<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">default_include: <span class=\"literal\">master</span>.d/*.conf</span><br></pre></td></tr></table></figure></p>\n<p>4）配置<code>api</code>配置文件，将上面生成的证书写到配置文件<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master.d/api.conf</span></span><br><span class=\"line\"><span class=\"symbol\">rest_cherrypy:</span></span><br><span class=\"line\"><span class=\"symbol\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.30</span></span><br><span class=\"line\"><span class=\"symbol\">  port:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"symbol\">  ssl_crt:</span> <span class=\"meta-keyword\">/etc/</span>pki<span class=\"meta-keyword\">/tls/</span>certs/localhost.crt</span><br><span class=\"line\"><span class=\"symbol\">  ssl_key:</span> <span class=\"meta-keyword\">/etc/</span>pki<span class=\"meta-keyword\">/tls/</span>certs/localhost.key</span><br></pre></td></tr></table></figure></p>\n<p>5）创建认证用户，并设置密码<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# useradd</span> -M -s /sbin/nologin saltapi</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> 'saltapi' | passwd --stdin saltapi</span><br></pre></td></tr></table></figure></p>\n<p>6）创建认证配置文件<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# vim /etc/salt/master.d/auth.conf</span><br><span class=\"line\">external_auth:</span><br><span class=\"line\">  pam:</span><br><span class=\"line\">    saltapi:</span><br><span class=\"line\">      -<span class=\"ruby\"> .*</span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@wheel'</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@runner'</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@jobs'</span></span></span><br></pre></td></tr></table></figure></p>\n<p>7）重启<code>salt-master</code>和启动<code>salt-api</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-api</span><br></pre></td></tr></table></figure></p>\n<p>8）查看<code>salt-api</code>监听端口<br><figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# netstat -anlutp |grep <span class=\"number\">8000</span></span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">8000</span>       <span class=\"number\">0.0</span><span class=\"meta\">.0</span><span class=\"meta\">.0</span>:*               LISTEN      <span class=\"number\">10904</span>/python        </span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">53414</span>      <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">8000</span>       TIME_WAIT   -</span><br></pre></td></tr></table></figure></p>\n<p>9）验证<code>login</code>登录，获取<code>token</code>字符串<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># curl -sSk https://192.168.1.30:8000/login \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d username=saltapi <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d password=saltapi <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d eauth=pam</span><br><span class=\"line\">return:</span><br><span class=\"line\">- eauth: pam</span><br><span class=\"line\">  expire: <span class=\"number\">1558663247.869537</span></span><br><span class=\"line\">  perms:</span><br><span class=\"line\">  - .*</span><br><span class=\"line\">  - <span class=\"string\">'@wheel'</span></span><br><span class=\"line\">  - <span class=\"string\">'@runner'</span></span><br><span class=\"line\">  - <span class=\"string\">'@jobs'</span></span><br><span class=\"line\">  start: <span class=\"number\">1558620047.869536</span></span><br><span class=\"line\">  token: e8330f642a3addd853c723d63844d29a12de9484</span><br><span class=\"line\">  user: saltapi</span><br></pre></td></tr></table></figure></p>\n<p>10）通过<code>api</code>执行<code>test.ping</code>测试连通性<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# curl -sSk https:<span class=\"comment\">//192.168.1.30:8000 \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> \\</span><br><span class=\"line\">&gt;     -H <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\\</span><br><span class=\"line\">&gt;     -d client=local \\</span><br><span class=\"line\">&gt;     -d tgt=<span class=\"string\">'*'</span> \\</span><br><span class=\"line\">&gt;     -d <span class=\"function\"><span class=\"keyword\">fun</span>=test.ping</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>:</span><br><span class=\"line\">- salt-minion01: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion02: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion03: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion04: <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></p>\n<p>11）通过<code>api</code>执行<code>cmd.run</code><br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# curl -sSk https:<span class=\"comment\">//192.168.1.30:8000 \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> \\</span><br><span class=\"line\">&gt;     -H <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\\</span><br><span class=\"line\">&gt;     -d client=local \\</span><br><span class=\"line\">&gt;     -d tgt=<span class=\"string\">'*'</span> \\</span><br><span class=\"line\">&gt;     -d <span class=\"function\"><span class=\"keyword\">fun</span>='cmd.run' -d arg='uptime'</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>:</span><br><span class=\"line\">- salt-minion01: <span class=\"string\">' 22:10:25 up 46 min,  1 user,  load average: 0.00, 0.01, 0.05'</span></span><br><span class=\"line\">  salt-minion02: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.00, 0.18, 0.15'</span></span><br><span class=\"line\">  salt-minion03: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.06, 0.33, 0.26'</span></span><br><span class=\"line\">  salt-minion04: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.01, 0.21, 0.16'</span></span><br></pre></td></tr></table></figure></p>\n<p>12）通过<code>api</code>获取<code>grains</code>信息`<br><figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master <span class=\"symbol\">~]# curl -sSk https</span>:<span class=\"comment\">//192.168.1.30:8000/minions/salt-minion01 \\</span></span><br><span class=\"line\">&gt;     -H 'Accept: application/x-yaml' \\</span><br><span class=\"line\">&gt;     -H 'X-Auth-Token: e<span class=\"number\">8330</span>f642a3addd853c723d<span class=\"number\">6384</span>4d29a12de<span class=\"number\">9484</span>'</span><br><span class=\"line\">return:</span><br><span class=\"line\">- salt-minion01:</span><br><span class=\"line\">    SSDs: []</span><br><span class=\"line\">    biosreleasedate: <span class=\"number\">05</span>/<span class=\"number\">19</span>/<span class=\"number\">2017</span></span><br><span class=\"line\">    biosversion: '6.00'</span><br><span class=\"line\">    cpu_flags:</span><br><span class=\"line\">    - fpu</span><br><span class=\"line\">    - vme</span><br><span class=\"line\">    - de</span><br><span class=\"line\">    - pse</span><br><span class=\"line\">    - tsc</span><br><span class=\"line\">.....</span><br></pre></td></tr></table></figure></p>\n<p>13）使用<code>json</code>格式<br><figure class=\"highlight prolog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# curl -sSk https://<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.30</span>:<span class=\"number\">8000</span>/minions/salt-minion01 \\</span><br><span class=\"line\">&gt;     -<span class=\"symbol\">H</span> <span class=\"string\">'Accept: application/json'</span> \\</span><br><span class=\"line\">&gt;     -<span class=\"symbol\">H</span> <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span></span><br><span class=\"line\">&#123;<span class=\"string\">\"return\"</span>: [&#123;<span class=\"string\">\"salt-minion01\"</span>: &#123;<span class=\"string\">\"biosversion\"</span>: <span class=\"string\">\"6.00\"</span>, <span class=\"string\">\"kernel\"</span>: <span class=\"string\">\"Linux\"</span>, <span class=\"string\">\"domain\"</span>: <span class=\"string\">\"\"</span>, <span class=\"string\">\"uid\"</span>: <span class=\"number\">0</span>, <span class=\"string\">\"zmqversion\"</span>: <span class=\"string\">\"4.1.4\"</span>, <span class=\"string\">\"kernelrelease\"</span>: <span class=\"string\">\"3.10.0-693.el7.x86_64\"</span>, <span class=\"string\">\"selinux\"</span>: &#123;<span class=\"string\">\"enforced\"</span>: <span class=\"string\">\"Disabled\"</span>, <span class=\"string\">\"enabled\"</span>: false&#125;, <span class=\"string\">\"serialnumber\"</span>: <span class=\"string\">\"VMware-56 4d 9e a0 21 56 90 87-cd 89 69 32 13 94 17 44\"</span>, <span class=\"string\">\"pid\"</span>: <span class=\"number\">1449</span>, <span class=\"string\">\"fqdns\"</span>: [], <span class=\"string\">\"ip_interfaces\"</span>: &#123;<span class=\"string\">\"lo\"</span>: [<span class=\"string\">\"127.0.0.1\"</span>, <span class=\"string\">\"::1\"</span>], <span class=\"string\">\"virbr0\"</span>: [<span class=\"string\">\"192.168.122.1\"</span>], <span class=\"string\">\"virbr0-nic\"</span>: [], <span class=\"string\">\"ens33\"</span>: [<span class=\"string\">\"192.168.1.31\"</span>, <span class=\"string\">\"192.168.1.100\"</span>, <span class=\"string\">\"fe80::20c:29ff:fe94:1744\"</span>]&#125;, <span class=\"string\">\"groupname\"</span>: <span class=\"string\">\"root\"</span>, <span class=\"string\">\"fqdn_ip6\"</span>: [<span class=\"string\">\"fe80::20c:29ff:fe94:1744\"</span>],</span><br><span class=\"line\">.......</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><blockquote>\n<p><code>salt-api</code>必须使用<code>https</code>，生产环境建议使用可信证书<br>当<code>salt-api</code>服务重启后原<code>token</code>失效</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p><a href=\"https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html\" target=\"_blank\" rel=\"noopener\">参考官档</a><br><a href=\"https://www.unixhot.com/docs/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html#a-rest-api-for-salt\" target=\"_blank\" rel=\"noopener\">参考官档</a></p>\n<blockquote>\n<p><code>SaltStack</code>官方提供有<code>REST API</code>格式的<code>salt-api</code>项目，将使<code>salt</code>与第三方系统集成变得更加简单。</p>\n</blockquote>\n<h2 id=\"salt-api安装配置\"><a href=\"#salt-api安装配置\" class=\"headerlink\" title=\"salt-api安装配置\"></a>salt-api安装配置</h2><p>1）在<code>salt-master</code>上进行安装<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-api</span><br></pre></td></tr></table></figure></p>\n<p>2）自签名证书，生产环境可以购买（说明：如果没有<code>salt-call</code>命令，装上<code>salt-minion</code>即可，依赖于该包）<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt-call --local tls.create_self_signed_cert</span></span><br><span class=\"line\"><span class=\"keyword\">local</span>:</span><br><span class=\"line\">    Created Private Key: <span class=\"string\">\"/etc/pki/tls/certs/localhost.key.\"</span> Created Certificate: <span class=\"string\">\"/etc/pki/tls/certs/localhost.crt.\"</span></span><br></pre></td></tr></table></figure></p>\n<p>3）打开<code>include</code>加载子配置文件，方便管理<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">default_include: <span class=\"literal\">master</span>.d/*.conf</span><br></pre></td></tr></table></figure></p>\n<p>4）配置<code>api</code>配置文件，将上面生成的证书写到配置文件<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master.d/api.conf</span></span><br><span class=\"line\"><span class=\"symbol\">rest_cherrypy:</span></span><br><span class=\"line\"><span class=\"symbol\">  host:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.30</span></span><br><span class=\"line\"><span class=\"symbol\">  port:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"symbol\">  ssl_crt:</span> <span class=\"meta-keyword\">/etc/</span>pki<span class=\"meta-keyword\">/tls/</span>certs/localhost.crt</span><br><span class=\"line\"><span class=\"symbol\">  ssl_key:</span> <span class=\"meta-keyword\">/etc/</span>pki<span class=\"meta-keyword\">/tls/</span>certs/localhost.key</span><br></pre></td></tr></table></figure></p>\n<p>5）创建认证用户，并设置密码<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# useradd</span> -M -s /sbin/nologin saltapi</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> 'saltapi' | passwd --stdin saltapi</span><br></pre></td></tr></table></figure></p>\n<p>6）创建认证配置文件<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# vim /etc/salt/master.d/auth.conf</span><br><span class=\"line\">external_auth:</span><br><span class=\"line\">  pam:</span><br><span class=\"line\">    saltapi:</span><br><span class=\"line\">      -<span class=\"ruby\"> .*</span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@wheel'</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@runner'</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - <span class=\"string\">'@jobs'</span></span></span><br></pre></td></tr></table></figure></p>\n<p>7）重启<code>salt-master</code>和启动<code>salt-api</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-api</span><br></pre></td></tr></table></figure></p>\n<p>8）查看<code>salt-api</code>监听端口<br><figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# netstat -anlutp |grep <span class=\"number\">8000</span></span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">8000</span>       <span class=\"number\">0.0</span><span class=\"meta\">.0</span><span class=\"meta\">.0</span>:*               LISTEN      <span class=\"number\">10904</span>/python        </span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">53414</span>      <span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>:<span class=\"number\">8000</span>       TIME_WAIT   -</span><br></pre></td></tr></table></figure></p>\n<p>9）验证<code>login</code>登录，获取<code>token</code>字符串<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># curl -sSk https://192.168.1.30:8000/login \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d username=saltapi <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d password=saltapi <span class=\"string\">\\</span></span><br><span class=\"line\">&gt;     -d eauth=pam</span><br><span class=\"line\">return:</span><br><span class=\"line\">- eauth: pam</span><br><span class=\"line\">  expire: <span class=\"number\">1558663247.869537</span></span><br><span class=\"line\">  perms:</span><br><span class=\"line\">  - .*</span><br><span class=\"line\">  - <span class=\"string\">'@wheel'</span></span><br><span class=\"line\">  - <span class=\"string\">'@runner'</span></span><br><span class=\"line\">  - <span class=\"string\">'@jobs'</span></span><br><span class=\"line\">  start: <span class=\"number\">1558620047.869536</span></span><br><span class=\"line\">  token: e8330f642a3addd853c723d63844d29a12de9484</span><br><span class=\"line\">  user: saltapi</span><br></pre></td></tr></table></figure></p>\n<p>10）通过<code>api</code>执行<code>test.ping</code>测试连通性<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# curl -sSk https:<span class=\"comment\">//192.168.1.30:8000 \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> \\</span><br><span class=\"line\">&gt;     -H <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\\</span><br><span class=\"line\">&gt;     -d client=local \\</span><br><span class=\"line\">&gt;     -d tgt=<span class=\"string\">'*'</span> \\</span><br><span class=\"line\">&gt;     -d <span class=\"function\"><span class=\"keyword\">fun</span>=test.ping</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>:</span><br><span class=\"line\">- salt-minion01: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion02: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion03: <span class=\"literal\">true</span></span><br><span class=\"line\">  salt-minion04: <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></p>\n<p>11）通过<code>api</code>执行<code>cmd.run</code><br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# curl -sSk https:<span class=\"comment\">//192.168.1.30:8000 \\</span></span><br><span class=\"line\">&gt;     -H <span class=\"string\">'Accept: application/x-yaml'</span> \\</span><br><span class=\"line\">&gt;     -H <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\\</span><br><span class=\"line\">&gt;     -d client=local \\</span><br><span class=\"line\">&gt;     -d tgt=<span class=\"string\">'*'</span> \\</span><br><span class=\"line\">&gt;     -d <span class=\"function\"><span class=\"keyword\">fun</span>='cmd.run' -d arg='uptime'</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>:</span><br><span class=\"line\">- salt-minion01: <span class=\"string\">' 22:10:25 up 46 min,  1 user,  load average: 0.00, 0.01, 0.05'</span></span><br><span class=\"line\">  salt-minion02: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.00, 0.18, 0.15'</span></span><br><span class=\"line\">  salt-minion03: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.06, 0.33, 0.26'</span></span><br><span class=\"line\">  salt-minion04: <span class=\"string\">' 22:10:25 up 7 min,  0 users,  load average: 0.01, 0.21, 0.16'</span></span><br></pre></td></tr></table></figure></p>\n<p>12）通过<code>api</code>获取<code>grains</code>信息`<br><figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master <span class=\"symbol\">~]# curl -sSk https</span>:<span class=\"comment\">//192.168.1.30:8000/minions/salt-minion01 \\</span></span><br><span class=\"line\">&gt;     -H 'Accept: application/x-yaml' \\</span><br><span class=\"line\">&gt;     -H 'X-Auth-Token: e<span class=\"number\">8330</span>f642a3addd853c723d<span class=\"number\">6384</span>4d29a12de<span class=\"number\">9484</span>'</span><br><span class=\"line\">return:</span><br><span class=\"line\">- salt-minion01:</span><br><span class=\"line\">    SSDs: []</span><br><span class=\"line\">    biosreleasedate: <span class=\"number\">05</span>/<span class=\"number\">19</span>/<span class=\"number\">2017</span></span><br><span class=\"line\">    biosversion: '6.00'</span><br><span class=\"line\">    cpu_flags:</span><br><span class=\"line\">    - fpu</span><br><span class=\"line\">    - vme</span><br><span class=\"line\">    - de</span><br><span class=\"line\">    - pse</span><br><span class=\"line\">    - tsc</span><br><span class=\"line\">.....</span><br></pre></td></tr></table></figure></p>\n<p>13）使用<code>json</code>格式<br><figure class=\"highlight prolog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# curl -sSk https://<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.30</span>:<span class=\"number\">8000</span>/minions/salt-minion01 \\</span><br><span class=\"line\">&gt;     -<span class=\"symbol\">H</span> <span class=\"string\">'Accept: application/json'</span> \\</span><br><span class=\"line\">&gt;     -<span class=\"symbol\">H</span> <span class=\"string\">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span></span><br><span class=\"line\">&#123;<span class=\"string\">\"return\"</span>: [&#123;<span class=\"string\">\"salt-minion01\"</span>: &#123;<span class=\"string\">\"biosversion\"</span>: <span class=\"string\">\"6.00\"</span>, <span class=\"string\">\"kernel\"</span>: <span class=\"string\">\"Linux\"</span>, <span class=\"string\">\"domain\"</span>: <span class=\"string\">\"\"</span>, <span class=\"string\">\"uid\"</span>: <span class=\"number\">0</span>, <span class=\"string\">\"zmqversion\"</span>: <span class=\"string\">\"4.1.4\"</span>, <span class=\"string\">\"kernelrelease\"</span>: <span class=\"string\">\"3.10.0-693.el7.x86_64\"</span>, <span class=\"string\">\"selinux\"</span>: &#123;<span class=\"string\">\"enforced\"</span>: <span class=\"string\">\"Disabled\"</span>, <span class=\"string\">\"enabled\"</span>: false&#125;, <span class=\"string\">\"serialnumber\"</span>: <span class=\"string\">\"VMware-56 4d 9e a0 21 56 90 87-cd 89 69 32 13 94 17 44\"</span>, <span class=\"string\">\"pid\"</span>: <span class=\"number\">1449</span>, <span class=\"string\">\"fqdns\"</span>: [], <span class=\"string\">\"ip_interfaces\"</span>: &#123;<span class=\"string\">\"lo\"</span>: [<span class=\"string\">\"127.0.0.1\"</span>, <span class=\"string\">\"::1\"</span>], <span class=\"string\">\"virbr0\"</span>: [<span class=\"string\">\"192.168.122.1\"</span>], <span class=\"string\">\"virbr0-nic\"</span>: [], <span class=\"string\">\"ens33\"</span>: [<span class=\"string\">\"192.168.1.31\"</span>, <span class=\"string\">\"192.168.1.100\"</span>, <span class=\"string\">\"fe80::20c:29ff:fe94:1744\"</span>]&#125;, <span class=\"string\">\"groupname\"</span>: <span class=\"string\">\"root\"</span>, <span class=\"string\">\"fqdn_ip6\"</span>: [<span class=\"string\">\"fe80::20c:29ff:fe94:1744\"</span>],</span><br><span class=\"line\">.......</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><blockquote>\n<p><code>salt-api</code>必须使用<code>https</code>，生产环境建议使用可信证书<br>当<code>salt-api</code>服务重启后原<code>token</code>失效</p>\n</blockquote>\n"},{"title":"saltstack基本入门","date":"2019-05-13T07:47:05.000Z","copyright":true,"_content":"## saltstack介绍\n<div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n**主要功能**\n远程执行\n配置管理\n[Stalstack官方文档](http://docs.saltstack.cn/)\n## Saltstack原理\n>`Salt`使用`server-agent`通信模型，服务端组件被称为`Salt master`，`agent`被称为`Salt minion`\n`Salt master`主要负责向`Salt minions`发送命令，然后聚合并显示这些命令的结果。一个`Salt master`可以管理多个`minion`系统\n`Salt server`与`Salt minion`通信的连接由`Salt minion`发起，这也意味着`Salt minion`上不需要打开任何传入端口（从而减少攻击）。`Salt server`使用端口`4505`和`4506`，必须打开端口才能接收到访问连接\n\n![通信示例图](https://upload-images.jianshu.io/upload_images/11763553-2ead569e18094825.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n- **Publisher** （端口4505）所有`Salt minions`都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。\n- **Request Server** （端口4506）`Salt minios`根据需要连接到请求服务器，将结果发送给`Salt master`，并安全地获取请求的文件或特定`minion`相关的数据值（称为`Salt pillar`）。连接到这个端口的连接在`Salt master`和`Salt minion`之间是1:1（不是异步）。\n\n```\n[root@salt-master ~]# lsof -i:4505\nCOMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nsalt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)\nsalt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505->salt-minion03:37240 (ESTABLISHED)\nsalt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505->salt-minion01:47804 (ESTABLISHED)\nsalt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505->salt-minion02:58594 (ESTABLISHED)\n```\n\n## 快速安装\n1.1 配置 yum 仓库\n```\n# 使用官方自带yum\n[root@salt-master ~]# yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm\n# 或者使用阿里云的yum（建议使用阿里云的，速度快一点）\n[root@salt-master ~]# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n[root@salt-master ~]# sed -i \"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\" /etc/yum.repos.d/salt-latest.repo\n[root@salt-master ~]# yum clean all\n[root@salt-master ~]# yum makecache\n```\n1.2 安装Master，并启动服务\n```\n[root@salt-master ~]# yum -y install salt-master\n[root@salt-master ~]# systemctl enable salt-master\n[root@salt-master ~]# systemctl start salt-master\n```\n1.3 安装 Salt-Minion 指向 Salt-Master 网络地址\n```\n[root@salt-minion01 ~]# yum -y install salt-minion\n# 可以使用主机名，也可以使用IP地址\n[root@salt-minion01 ~]# cp /etc/salt/minion{,.back}\n[root@salt-minion01 ~]# sed -i '/#master: /c\\master: salt-master' /etc/salt/minion\n[root@salt-minion01 ~]# systemctl enable salt-minion\n[root@salt-minion01 ~]# systemctl start salt-minion\n```\n##  SaltStack认证方式\n![master与minion之间的架构关系图](https://upload-images.jianshu.io/upload_images/11763553-51113b6686102c1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n<div class=\"note success\"><p> `Salt` 的数据传输是通过 `AES` 加密，`Master` 和 `Minion` 之前在通信之前，需要进行认证。\n`Salt` 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  `minion` 在第一次启动时候，会在 `/etc/salt/pki/minion/` 下自动生成 `minion.pem(private key)` 和 `minion.pub(public key) `, 然后将 `minion.pub` 发送给 `master `\n2. `master` 在第一次启动时，会在 `/etc/salt/pki/master/` 下自动生成 `master.pem` 和 `master.pub` ；并且会接收到 `minion` 的 `public key` , 通过 `salt-key` 命令接收 `minion public key`， 会在 `master` 的 `/etc/salt/pki/master/minions` 目录下存放以 `minion id` 命令的 `public key` ；验证成功后同时 `minion` 会保存一份 `master public key` 在 minion的 `/etc/salt/pki/minion/minion_master.pub`里。</p></div>\n\n**Salt认证原理总结**\n> `minion`将自己的公钥发送给`master`\n`master`认证后再将自己的公钥也发送给`minion`端\n\n**Master端认证示例**\n根据上面提到的认证原理，先看下未认证前的`master`和`minion`的`pki`目录\n```\n# master上查看\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   │   └── salt-minion01\n│   └── minions_rejected\n└── minion\n\n# minion上查看\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion.pem\n    └── minion.pub\n```\n`salt-key`命令解释：\n```\n[root@salt-master ~]# salt-key -L \nAccepted Keys:        #已经接受的key\nDenied Keys:          #拒绝的key\nUnaccepted Keys:      #未加入的key\nRejected Keys:        #吊销的key\n\n#常用参数\n-L  #查看KEY状态\n-A  #允许所有\n-D  #删除所有\n-a  #认证指定的key\n-d  #删除指定的key\n-r  #注销掉指定key（该状态为未被认证）\n\n#配置master自动接受请求认证(master上配置 /etc/salt/master)\nauto_accept: True\n```\n`salt-key`认证\n```\n#列出当前所有的key\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nDenied Keys:\nUnaccepted Keys:\nsalt-minion01\nRejected Keys:\n\n#添加指定minion的key\n[root@salt-master ~]# salt-key -a salt-minion01 -y\nThe following keys are going to be accepted:\nUnaccepted Keys:\nsalt-minion01\nKey for minion salt-minion01 accepted.\n#添加所有minion的key\n[root@salt-master ~]# salt-key -A -y\n\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nsalt-minion01\nDenied Keys:\nUnaccepted Keys:\nRejected Keys:\n```\n上面认证完成后再次查看`master`和`minion`的`pki`目录\n```\n# master上\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   │   └── salt-minion01\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   └── minions_rejected\n└── minion\n\n# minion上\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion_master.pub\n    ├── minion.pem\n    └── minion.pub\n```\n## Saltstack远程执行\n>远程执行是 `Saltstack` 的核心功能之一。主要使用 `salt` 模块批量给选定的 `minion` 端执行相应的命令，并获得返回结果。\n\n1、判断 `salt` 的 `minion` 主机是否存活\n```\n[root@salt-master ~]# salt '*' test.ping\nsalt-minion02:\n    True\nsalt-minion03:\n    True\nsalt-minion01:\n    True\n\n# salt saltstack自带的一个命令\n# * 表示目标主机，这里表示所有目标主机\n# test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法\n```\n2、`saltstack`使用 `cmd.run`模块远程执行shell命令\n```\n#在指定目标minion节点运行uptime命令\n[root@salt-master ~]# salt 'salt-minion02' cmd.run 'uptime'\nsalt-minion02:\n     18:13:08 up 28 min,  2 users,  load average: 0.00, 0.04, 0.13\n```\n## Saltstack配置管理\n<div class=\"note success\"><p>`Salt` 通过`State`模块来进行文件的管理；通过`YAML`语法来描述，后缀是`.sls`的文件</p></div>1、了解 `YAML` 参考：http://docs.saltstack.cn/topics/yaml/index.html\n```\nremove vim:\n  pkg.removed:\n    - name: vim\n```\n- 带有ID和每个函数调用的行都以冒号（:)结束。\n- 每个函数调用在ID下面缩进两个空格。\n- 参数作为列表传递给每个函数。\n- 每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。\n- 如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。\n- 如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格\n\n2、配置`sals` ,定义环境   [参考文档](https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md)\n```\n# 定义环境目录\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n# 创建上面定义的目录\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n# 重启服务\n[root@salt-master ~]# systemctl restart salt-master\n```\n3、编写第一个`sls`文件\n```\n# 在base环境下编写第一个安装apache的sls文件\n[root@salt-master ~]# cd /srv/salt/base/\n[root@salt-master base]# cat apache.sls \napache-install:\n  pkg.installed:\n    - name: httpd\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n# 在dev环境下编写一个安装ftp的sls文件\n[root@salt-master base]# cd /srv/salt/dev/\n[root@salt-master dev]# cat vsftpd.sls \nvsftpd-install:\n  pkg.installed:\n    - name: vsftpd\n\nvsftpd-service:\n  service.running:\n    - name: vsftpd\n    - enable: True\n```\n4、使用`salt`命令的`state`状态模块让`minion`应用配置\n```\n# 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）\n[root@salt-master ~]# salt '*' state.sls apache\n\n# 让所有的minion都安装vsftpd（saltenv指定环境）\n[root@salt-master ~]# salt '*' state.sls vsftpd saltenv=dev\n```\n5、使用`salt`的高级状态使不同主机应用不同的配置\n```\n# topfile入口文件只能放在base环境\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nbase:\n  'salt-minion01':\n    - apache\n  'salt-minion03':\n    - apache\ndev:\n  'salt-minion02':\n    - vsftpd\n  'salt-minion03':\n    - vsftpd\n```\n6、使用`salt`命令执行高级状态，会将`top.sls`当做入口文件，进行调用\n```\n# 将高级状态应用到所有主机\n[root@salt-master ~]# salt '*' state.highstate\n```\n## Saltstack常用配置\n1、**Salt Master配置**\n`Salt Master`端的配置文件`/etc/salt/master`，常用配置如下：\n```\ninterface: \t//指定bind 的地址(默认为0.0.0.0)\npublish_port: //指定发布端口(默认为4505)\nret_port: //指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)\nuser: //指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)\ntimeout: //指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)\nkeep_jobs: //minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)\njob_cache: //master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)\nfile_recv : //是否允许minion传送文件到master 上(默认是Flase)\nfile_roots: //指定file server目录,  默认为:\n    file_roots:    \n       base:    \n        - /srv/salt     \npillar_roots : //指定pillar 目录,  默认为:\n    pillar_roots:     \n      base:     \n        - /srv/pillar     \nlog_level: //日志级别\n支持的日志级别有'garbage', 'trace', 'debug', info', 'warning', 'error', ‘critical ’ ( 默认为’warning’)\n```\n2、`Salt Minion`端的配置文件`/etc/salt/minion`，常用配置如下：\n```\nmaster: //指定master 主机(默认为salt)\nmaster_port: //指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)\nid: //指定本minion的标识, salt内部使用id作为标识(默认为主机名)\nuser: //指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)\ncache_jobs : //minion是否缓存执行结果(默认为False)\nbackup_mode: //在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效\nproviders : //指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5\nrenderer: //指定配置管理系统中的渲染器(默认值为:yaml_jinja )\nfile_client : //指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)\nloglevel: //指定日志级别(默认为warning)\ntcp_keepalive : //minion 是否与master 保持keepalive 检查, zeromq3(默认为True)\n```\n","source":"_posts/saltstack基本入门.md","raw":"---\ntitle: saltstack基本入门\ndate: 2019-05-13 15:47:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## saltstack介绍\n<div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n**主要功能**\n远程执行\n配置管理\n[Stalstack官方文档](http://docs.saltstack.cn/)\n## Saltstack原理\n>`Salt`使用`server-agent`通信模型，服务端组件被称为`Salt master`，`agent`被称为`Salt minion`\n`Salt master`主要负责向`Salt minions`发送命令，然后聚合并显示这些命令的结果。一个`Salt master`可以管理多个`minion`系统\n`Salt server`与`Salt minion`通信的连接由`Salt minion`发起，这也意味着`Salt minion`上不需要打开任何传入端口（从而减少攻击）。`Salt server`使用端口`4505`和`4506`，必须打开端口才能接收到访问连接\n\n![通信示例图](https://upload-images.jianshu.io/upload_images/11763553-2ead569e18094825.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n- **Publisher** （端口4505）所有`Salt minions`都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。\n- **Request Server** （端口4506）`Salt minios`根据需要连接到请求服务器，将结果发送给`Salt master`，并安全地获取请求的文件或特定`minion`相关的数据值（称为`Salt pillar`）。连接到这个端口的连接在`Salt master`和`Salt minion`之间是1:1（不是异步）。\n\n```\n[root@salt-master ~]# lsof -i:4505\nCOMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nsalt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)\nsalt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505->salt-minion03:37240 (ESTABLISHED)\nsalt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505->salt-minion01:47804 (ESTABLISHED)\nsalt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505->salt-minion02:58594 (ESTABLISHED)\n```\n\n## 快速安装\n1.1 配置 yum 仓库\n```\n# 使用官方自带yum\n[root@salt-master ~]# yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm\n# 或者使用阿里云的yum（建议使用阿里云的，速度快一点）\n[root@salt-master ~]# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n[root@salt-master ~]# sed -i \"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\" /etc/yum.repos.d/salt-latest.repo\n[root@salt-master ~]# yum clean all\n[root@salt-master ~]# yum makecache\n```\n1.2 安装Master，并启动服务\n```\n[root@salt-master ~]# yum -y install salt-master\n[root@salt-master ~]# systemctl enable salt-master\n[root@salt-master ~]# systemctl start salt-master\n```\n1.3 安装 Salt-Minion 指向 Salt-Master 网络地址\n```\n[root@salt-minion01 ~]# yum -y install salt-minion\n# 可以使用主机名，也可以使用IP地址\n[root@salt-minion01 ~]# cp /etc/salt/minion{,.back}\n[root@salt-minion01 ~]# sed -i '/#master: /c\\master: salt-master' /etc/salt/minion\n[root@salt-minion01 ~]# systemctl enable salt-minion\n[root@salt-minion01 ~]# systemctl start salt-minion\n```\n##  SaltStack认证方式\n![master与minion之间的架构关系图](https://upload-images.jianshu.io/upload_images/11763553-51113b6686102c1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n<div class=\"note success\"><p> `Salt` 的数据传输是通过 `AES` 加密，`Master` 和 `Minion` 之前在通信之前，需要进行认证。\n`Salt` 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  `minion` 在第一次启动时候，会在 `/etc/salt/pki/minion/` 下自动生成 `minion.pem(private key)` 和 `minion.pub(public key) `, 然后将 `minion.pub` 发送给 `master `\n2. `master` 在第一次启动时，会在 `/etc/salt/pki/master/` 下自动生成 `master.pem` 和 `master.pub` ；并且会接收到 `minion` 的 `public key` , 通过 `salt-key` 命令接收 `minion public key`， 会在 `master` 的 `/etc/salt/pki/master/minions` 目录下存放以 `minion id` 命令的 `public key` ；验证成功后同时 `minion` 会保存一份 `master public key` 在 minion的 `/etc/salt/pki/minion/minion_master.pub`里。</p></div>\n\n**Salt认证原理总结**\n> `minion`将自己的公钥发送给`master`\n`master`认证后再将自己的公钥也发送给`minion`端\n\n**Master端认证示例**\n根据上面提到的认证原理，先看下未认证前的`master`和`minion`的`pki`目录\n```\n# master上查看\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   │   └── salt-minion01\n│   └── minions_rejected\n└── minion\n\n# minion上查看\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion.pem\n    └── minion.pub\n```\n`salt-key`命令解释：\n```\n[root@salt-master ~]# salt-key -L \nAccepted Keys:        #已经接受的key\nDenied Keys:          #拒绝的key\nUnaccepted Keys:      #未加入的key\nRejected Keys:        #吊销的key\n\n#常用参数\n-L  #查看KEY状态\n-A  #允许所有\n-D  #删除所有\n-a  #认证指定的key\n-d  #删除指定的key\n-r  #注销掉指定key（该状态为未被认证）\n\n#配置master自动接受请求认证(master上配置 /etc/salt/master)\nauto_accept: True\n```\n`salt-key`认证\n```\n#列出当前所有的key\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nDenied Keys:\nUnaccepted Keys:\nsalt-minion01\nRejected Keys:\n\n#添加指定minion的key\n[root@salt-master ~]# salt-key -a salt-minion01 -y\nThe following keys are going to be accepted:\nUnaccepted Keys:\nsalt-minion01\nKey for minion salt-minion01 accepted.\n#添加所有minion的key\n[root@salt-master ~]# salt-key -A -y\n\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nsalt-minion01\nDenied Keys:\nUnaccepted Keys:\nRejected Keys:\n```\n上面认证完成后再次查看`master`和`minion`的`pki`目录\n```\n# master上\n[root@salt-master ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n│   ├── master.pem\n│   ├── master.pub\n│   ├── minions\n│   │   └── salt-minion01\n│   ├── minions_autosign\n│   ├── minions_denied\n│   ├── minions_pre\n│   └── minions_rejected\n└── minion\n\n# minion上\n[root@salt-minion01 ~]# tree /etc/salt/pki/\n/etc/salt/pki/\n├── master\n└── minion\n    ├── minion_master.pub\n    ├── minion.pem\n    └── minion.pub\n```\n## Saltstack远程执行\n>远程执行是 `Saltstack` 的核心功能之一。主要使用 `salt` 模块批量给选定的 `minion` 端执行相应的命令，并获得返回结果。\n\n1、判断 `salt` 的 `minion` 主机是否存活\n```\n[root@salt-master ~]# salt '*' test.ping\nsalt-minion02:\n    True\nsalt-minion03:\n    True\nsalt-minion01:\n    True\n\n# salt saltstack自带的一个命令\n# * 表示目标主机，这里表示所有目标主机\n# test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法\n```\n2、`saltstack`使用 `cmd.run`模块远程执行shell命令\n```\n#在指定目标minion节点运行uptime命令\n[root@salt-master ~]# salt 'salt-minion02' cmd.run 'uptime'\nsalt-minion02:\n     18:13:08 up 28 min,  2 users,  load average: 0.00, 0.04, 0.13\n```\n## Saltstack配置管理\n<div class=\"note success\"><p>`Salt` 通过`State`模块来进行文件的管理；通过`YAML`语法来描述，后缀是`.sls`的文件</p></div>1、了解 `YAML` 参考：http://docs.saltstack.cn/topics/yaml/index.html\n```\nremove vim:\n  pkg.removed:\n    - name: vim\n```\n- 带有ID和每个函数调用的行都以冒号（:)结束。\n- 每个函数调用在ID下面缩进两个空格。\n- 参数作为列表传递给每个函数。\n- 每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。\n- 如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。\n- 如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格\n\n2、配置`sals` ,定义环境   [参考文档](https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md)\n```\n# 定义环境目录\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n# 创建上面定义的目录\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n# 重启服务\n[root@salt-master ~]# systemctl restart salt-master\n```\n3、编写第一个`sls`文件\n```\n# 在base环境下编写第一个安装apache的sls文件\n[root@salt-master ~]# cd /srv/salt/base/\n[root@salt-master base]# cat apache.sls \napache-install:\n  pkg.installed:\n    - name: httpd\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n# 在dev环境下编写一个安装ftp的sls文件\n[root@salt-master base]# cd /srv/salt/dev/\n[root@salt-master dev]# cat vsftpd.sls \nvsftpd-install:\n  pkg.installed:\n    - name: vsftpd\n\nvsftpd-service:\n  service.running:\n    - name: vsftpd\n    - enable: True\n```\n4、使用`salt`命令的`state`状态模块让`minion`应用配置\n```\n# 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）\n[root@salt-master ~]# salt '*' state.sls apache\n\n# 让所有的minion都安装vsftpd（saltenv指定环境）\n[root@salt-master ~]# salt '*' state.sls vsftpd saltenv=dev\n```\n5、使用`salt`的高级状态使不同主机应用不同的配置\n```\n# topfile入口文件只能放在base环境\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nbase:\n  'salt-minion01':\n    - apache\n  'salt-minion03':\n    - apache\ndev:\n  'salt-minion02':\n    - vsftpd\n  'salt-minion03':\n    - vsftpd\n```\n6、使用`salt`命令执行高级状态，会将`top.sls`当做入口文件，进行调用\n```\n# 将高级状态应用到所有主机\n[root@salt-master ~]# salt '*' state.highstate\n```\n## Saltstack常用配置\n1、**Salt Master配置**\n`Salt Master`端的配置文件`/etc/salt/master`，常用配置如下：\n```\ninterface: \t//指定bind 的地址(默认为0.0.0.0)\npublish_port: //指定发布端口(默认为4505)\nret_port: //指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)\nuser: //指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)\ntimeout: //指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)\nkeep_jobs: //minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)\njob_cache: //master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)\nfile_recv : //是否允许minion传送文件到master 上(默认是Flase)\nfile_roots: //指定file server目录,  默认为:\n    file_roots:    \n       base:    \n        - /srv/salt     \npillar_roots : //指定pillar 目录,  默认为:\n    pillar_roots:     \n      base:     \n        - /srv/pillar     \nlog_level: //日志级别\n支持的日志级别有'garbage', 'trace', 'debug', info', 'warning', 'error', ‘critical ’ ( 默认为’warning’)\n```\n2、`Salt Minion`端的配置文件`/etc/salt/minion`，常用配置如下：\n```\nmaster: //指定master 主机(默认为salt)\nmaster_port: //指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)\nid: //指定本minion的标识, salt内部使用id作为标识(默认为主机名)\nuser: //指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)\ncache_jobs : //minion是否缓存执行结果(默认为False)\nbackup_mode: //在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效\nproviders : //指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5\nrenderer: //指定配置管理系统中的渲染器(默认值为:yaml_jinja )\nfile_client : //指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)\nloglevel: //指定日志级别(默认为warning)\ntcp_keepalive : //minion 是否与master 保持keepalive 检查, zeromq3(默认为True)\n```\n","slug":"saltstack基本入门","published":1,"updated":"2019-05-14T12:43:10.857Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4mm001jm834havret7u","content":"<h2 id=\"saltstack介绍\"><a href=\"#saltstack介绍\" class=\"headerlink\" title=\"saltstack介绍\"></a>saltstack介绍</h2><div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n<p><strong>主要功能</strong><br>远程执行<br>配置管理<br><a href=\"http://docs.saltstack.cn/\" target=\"_blank\" rel=\"noopener\">Stalstack官方文档</a></p>\n<h2 id=\"Saltstack原理\"><a href=\"#Saltstack原理\" class=\"headerlink\" title=\"Saltstack原理\"></a>Saltstack原理</h2><blockquote>\n<p><code>Salt</code>使用<code>server-agent</code>通信模型，服务端组件被称为<code>Salt master</code>，<code>agent</code>被称为<code>Salt minion</code><br><code>Salt master</code>主要负责向<code>Salt minions</code>发送命令，然后聚合并显示这些命令的结果。一个<code>Salt master</code>可以管理多个<code>minion</code>系统<br><code>Salt server</code>与<code>Salt minion</code>通信的连接由<code>Salt minion</code>发起，这也意味着<code>Salt minion</code>上不需要打开任何传入端口（从而减少攻击）。<code>Salt server</code>使用端口<code>4505</code>和<code>4506</code>，必须打开端口才能接收到访问连接</p>\n</blockquote>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-2ead569e18094825.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"通信示例图\"></p>\n<ul>\n<li><strong>Publisher</strong> （端口4505）所有<code>Salt minions</code>都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。</li>\n<li><strong>Request Server</strong> （端口4506）<code>Salt minios</code>根据需要连接到请求服务器，将结果发送给<code>Salt master</code>，并安全地获取请求的文件或特定<code>minion</code>相关的数据值（称为<code>Salt pillar</code>）。连接到这个端口的连接在<code>Salt master</code>和<code>Salt minion</code>之间是1:1（不是异步）。</li>\n</ul>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# lsof -i:4505</span><br><span class=\"line\">COMMAND     PID<span class=\"built_in\"> USER </span>  FD  <span class=\"built_in\"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">salt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)</span><br><span class=\"line\">salt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505-&gt;salt-minion03:37240 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505-&gt;salt-minion01:47804 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505-&gt;salt-minion02:58594 (ESTABLISHED)</span><br></pre></td></tr></table></figure>\n<h2 id=\"快速安装\"><a href=\"#快速安装\" class=\"headerlink\" title=\"快速安装\"></a>快速安装</h2><p>1.1 配置 yum 仓库<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用官方自带yum</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm</span><br><span class=\"line\"><span class=\"comment\"># 或者使用阿里云的yum（建议使用阿里云的，速度快一点）</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class=\"number\">2</span>.el7.noarch.rpm</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# sed</span> -i <span class=\"string\">\"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> clean all</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> makecache</span><br></pre></td></tr></table></figure></p>\n<p>1.2 安装Master，并启动服务<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> enable salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>1.3 安装 Salt-Minion 指向 Salt-Master 网络地址<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># yum -y install salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># 可以使用主机名，也可以使用IP地址</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># sed -i <span class=\"string\">'/#master: /c\\master: salt-master'</span> /etc/salt/minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl enable salt-minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"SaltStack认证方式\"><a href=\"#SaltStack认证方式\" class=\"headerlink\" title=\"SaltStack认证方式\"></a>SaltStack认证方式</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-51113b6686102c1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"master与minion之间的架构关系图\"></p>\n<div class=\"note success\"><p> <code>Salt</code> 的数据传输是通过 <code>AES</code> 加密，<code>Master</code> 和 <code>Minion</code> 之前在通信之前，需要进行认证。<br><code>Salt</code> 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  <code>minion</code> 在第一次启动时候，会在 <code>/etc/salt/pki/minion/</code> 下自动生成 <code>minion.pem(private key)</code> 和 <code>minion.pub(public key)</code>, 然后将 <code>minion.pub</code> 发送给 <code>master</code><br>2. <code>master</code> 在第一次启动时，会在 <code>/etc/salt/pki/master/</code> 下自动生成 <code>master.pem</code> 和 <code>master.pub</code> ；并且会接收到 <code>minion</code> 的 <code>public key</code> , 通过 <code>salt-key</code> 命令接收 <code>minion public key</code>， 会在 <code>master</code> 的 <code>/etc/salt/pki/master/minions</code> 目录下存放以 <code>minion id</code> 命令的 <code>public key</code> ；验证成功后同时 <code>minion</code> 会保存一份 <code>master public key</code> 在 minion的 <code>/etc/salt/pki/minion/minion_master.pub</code>里。</p></div>\n\n<p><strong>Salt认证原理总结</strong></p>\n<blockquote>\n<p><code>minion</code>将自己的公钥发送给<code>master</code><br><code>master</code>认证后再将自己的公钥也发送给<code>minion</code>端</p>\n</blockquote>\n<p><strong>Master端认证示例</strong><br>根据上面提到的认证原理，先看下未认证前的<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上查看</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上查看</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>命令解释：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-key</span> <span class=\"bullet\">-L</span> </span><br><span class=\"line\"><span class=\"string\">Accepted</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#已经接受的key</span></span><br><span class=\"line\"><span class=\"string\">Denied</span> <span class=\"attr\">Keys:</span>          <span class=\"comment\">#拒绝的key</span></span><br><span class=\"line\"><span class=\"string\">Unaccepted</span> <span class=\"attr\">Keys:</span>      <span class=\"comment\">#未加入的key</span></span><br><span class=\"line\"><span class=\"string\">Rejected</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#吊销的key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#常用参数</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">L</span>  <span class=\"comment\">#查看KEY状态</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">A</span>  <span class=\"comment\">#允许所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">D</span>  <span class=\"comment\">#删除所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">a</span>  <span class=\"comment\">#认证指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">d</span>  <span class=\"comment\">#删除指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">r</span>  <span class=\"comment\">#注销掉指定key（该状态为未被认证）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置master自动接受请求认证(master上配置 /etc/salt/master)</span></span><br><span class=\"line\"><span class=\"attr\">auto_accept:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>认证<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#列出当前所有的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加指定minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -a salt-minion01 -y</span><br><span class=\"line\">The following keys are going to be accepted:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Key for minion salt-minion01 accepted.</span><br><span class=\"line\"><span class=\"comment\">#添加所有minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -A -y</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">Rejected Keys:</span><br></pre></td></tr></table></figure></p>\n<p>上面认证完成后再次查看<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion_master.pub</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack远程执行\"><a href=\"#Saltstack远程执行\" class=\"headerlink\" title=\"Saltstack远程执行\"></a>Saltstack远程执行</h2><blockquote>\n<p>远程执行是 <code>Saltstack</code> 的核心功能之一。主要使用 <code>salt</code> 模块批量给选定的 <code>minion</code> 端执行相应的命令，并获得返回结果。</p>\n</blockquote>\n<p>1、判断 <code>salt</code> 的 <code>minion</code> 主机是否存活<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt</span> <span class=\"string\">'*'</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion03:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># salt saltstack自带的一个命令</span></span><br><span class=\"line\"><span class=\"comment\"># * 表示目标主机，这里表示所有目标主机</span></span><br><span class=\"line\"><span class=\"comment\"># test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法</span></span><br></pre></td></tr></table></figure></p>\n<p>2、<code>saltstack</code>使用 <code>cmd.run</code>模块远程执行shell命令<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#在指定目标minion节点运行uptime命令</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion02'</span> cmd.run <span class=\"string\">'uptime'</span></span></span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">     <span class=\"number\">18</span>:<span class=\"number\">13</span>:<span class=\"number\">08</span> up <span class=\"number\">28</span> min,  <span class=\"number\">2</span> users,  load average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.13</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack配置管理\"><a href=\"#Saltstack配置管理\" class=\"headerlink\" title=\"Saltstack配置管理\"></a>Saltstack配置管理</h2><p><div class=\"note success\"><p><code>Salt</code> 通过<code>State</code>模块来进行文件的管理；通过<code>YAML</code>语法来描述，后缀是<code>.sls</code>的文件</p></div>1、了解 <code>YAML</code> 参考：<a href=\"http://docs.saltstack.cn/topics/yaml/index.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/yaml/index.html</a><br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">remove <span class=\"string\">vim:</span></span><br><span class=\"line\">  pkg.<span class=\"string\">removed:</span></span><br><span class=\"line\">    - <span class=\"string\">name:</span> vim</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>带有ID和每个函数调用的行都以冒号（:)结束。</li>\n<li>每个函数调用在ID下面缩进两个空格。</li>\n<li>参数作为列表传递给每个函数。</li>\n<li>每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。</li>\n<li>如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。</li>\n<li>如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格</li>\n</ul>\n<p>2、配置<code>sals</code> ,定义环境   <a href=\"https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md\" target=\"_blank\" rel=\"noopener\">参考文档</a><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义环境目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">file_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/salt/base</span><br><span class=\"line\">  dev:</span><br><span class=\"line\">    - /srv/salt/dev</span><br><span class=\"line\">  prod:</span><br><span class=\"line\">    - /srv/salt/prod</span><br><span class=\"line\"><span class=\"comment\"># 创建上面定义的目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\"><span class=\"comment\"># 重启服务</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>3、编写第一个<code>sls</code>文件<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在base环境下编写第一个安装apache的sls文件</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cd /srv/salt/base/</span></span><br><span class=\"line\">[root@salt-master base]<span class=\"comment\"># cat apache.sls </span></span><br><span class=\"line\">apache-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在dev环境下编写一个安装ftp的sls文件</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> base]<span class=\"comment\"># cd /srv/salt/dev/</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> dev]<span class=\"comment\"># cat vsftpd.sls </span></span><br><span class=\"line\">vsftpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\"></span><br><span class=\"line\">vsftpd-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4、使用<code>salt</code>命令的<code>state</code>状态模块让<code>minion</code>应用配置<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls apache</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装vsftpd（saltenv指定环境）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls vsftpd saltenv=dev</span></span><br></pre></td></tr></table></figure></p>\n<p>5、使用<code>salt</code>的高级状态使不同主机应用不同的配置<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># topfile入口文件只能放在base环境</span></span><br><span class=\"line\">[<span class=\"meta\">root@salt-master ~</span>]<span class=\"meta\"># cat /srv/salt/base/top.sls </span></span><br><span class=\"line\"><span class=\"keyword\">base</span>:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion01'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">dev:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion02'</span>:</span><br><span class=\"line\">    - vsftpd</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - vsftpd</span><br></pre></td></tr></table></figure></p>\n<p>6、使用<code>salt</code>命令执行高级状态，会将<code>top.sls</code>当做入口文件，进行调用<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 将高级状态应用到所有主机</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack常用配置\"><a href=\"#Saltstack常用配置\" class=\"headerlink\" title=\"Saltstack常用配置\"></a>Saltstack常用配置</h2><p>1、<strong>Salt Master配置</strong><br><code>Salt Master</code>端的配置文件<code>/etc/salt/master</code>，常用配置如下：<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">interface</span>: \t<span class=\"comment\">//指定bind 的地址(默认为0.0.0.0)</span></span><br><span class=\"line\"><span class=\"attribute\">publish_port</span>: <span class=\"comment\">//指定发布端口(默认为4505)</span></span><br><span class=\"line\"><span class=\"attribute\">ret_port</span>: <span class=\"comment\">//指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"attribute\">user</span>: <span class=\"comment\">//指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)</span></span><br><span class=\"line\"><span class=\"attribute\">timeout</span>: <span class=\"comment\">//指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)</span></span><br><span class=\"line\"><span class=\"attribute\">keep_jobs</span>: <span class=\"comment\">//minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)</span></span><br><span class=\"line\"><span class=\"attribute\">job_cache</span>: <span class=\"comment\">//master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)</span></span><br><span class=\"line\"><span class=\"attribute\">file_recv </span>: <span class=\"comment\">//是否允许minion传送文件到master 上(默认是Flase)</span></span><br><span class=\"line\"><span class=\"attribute\">file_roots</span>: <span class=\"comment\">//指定file server目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">file_roots</span>:    </span><br><span class=\"line\">       <span class=\"attribute\">base</span>:    </span><br><span class=\"line\">        - /srv/salt     </span><br><span class=\"line\"><span class=\"attribute\">pillar_roots </span>: <span class=\"comment\">//指定pillar 目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">pillar_roots</span>:     </span><br><span class=\"line\">      <span class=\"attribute\">base</span>:     </span><br><span class=\"line\">        - /srv/pillar     </span><br><span class=\"line\"><span class=\"attribute\">log_level</span>: <span class=\"comment\">//日志级别</span></span><br><span class=\"line\">支持的日志级别有<span class=\"string\">'garbage'</span>, <span class=\"string\">'trace'</span>, <span class=\"string\">'debug'</span>, info<span class=\"string\">', '</span>warning<span class=\"string\">', '</span>error', ‘critical ’ ( 默认为’warning’)</span><br></pre></td></tr></table></figure></p>\n<p>2、<code>Salt Minion</code>端的配置文件<code>/etc/salt/minion</code>，常用配置如下：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">master:</span> <span class=\"comment\">//指定master 主机(默认为salt)</span></span><br><span class=\"line\"><span class=\"string\">master_port:</span> <span class=\"comment\">//指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"string\">id:</span> <span class=\"comment\">//指定本minion的标识, salt内部使用id作为标识(默认为主机名)</span></span><br><span class=\"line\"><span class=\"string\">user:</span> <span class=\"comment\">//指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)</span></span><br><span class=\"line\"><span class=\"string\">cache_jobs :</span> <span class=\"comment\">//minion是否缓存执行结果(默认为False)</span></span><br><span class=\"line\"><span class=\"string\">backup_mode:</span> <span class=\"comment\">//在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效</span></span><br><span class=\"line\"><span class=\"string\">providers :</span> <span class=\"comment\">//指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5</span></span><br><span class=\"line\"><span class=\"string\">renderer:</span> <span class=\"comment\">//指定配置管理系统中的渲染器(默认值为:yaml_jinja )</span></span><br><span class=\"line\"><span class=\"string\">file_client :</span> <span class=\"comment\">//指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)</span></span><br><span class=\"line\"><span class=\"string\">loglevel:</span> <span class=\"comment\">//指定日志级别(默认为warning)</span></span><br><span class=\"line\"><span class=\"string\">tcp_keepalive :</span> <span class=\"comment\">//minion 是否与master 保持keepalive 检查, zeromq3(默认为True)</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"saltstack介绍\"><a href=\"#saltstack介绍\" class=\"headerlink\" title=\"saltstack介绍\"></a>saltstack介绍</h2><div class=\"note success\"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div>\n\n<p><strong>主要功能</strong><br>远程执行<br>配置管理<br><a href=\"http://docs.saltstack.cn/\" target=\"_blank\" rel=\"noopener\">Stalstack官方文档</a></p>\n<h2 id=\"Saltstack原理\"><a href=\"#Saltstack原理\" class=\"headerlink\" title=\"Saltstack原理\"></a>Saltstack原理</h2><blockquote>\n<p><code>Salt</code>使用<code>server-agent</code>通信模型，服务端组件被称为<code>Salt master</code>，<code>agent</code>被称为<code>Salt minion</code><br><code>Salt master</code>主要负责向<code>Salt minions</code>发送命令，然后聚合并显示这些命令的结果。一个<code>Salt master</code>可以管理多个<code>minion</code>系统<br><code>Salt server</code>与<code>Salt minion</code>通信的连接由<code>Salt minion</code>发起，这也意味着<code>Salt minion</code>上不需要打开任何传入端口（从而减少攻击）。<code>Salt server</code>使用端口<code>4505</code>和<code>4506</code>，必须打开端口才能接收到访问连接</p>\n</blockquote>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-2ead569e18094825.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"通信示例图\"></p>\n<ul>\n<li><strong>Publisher</strong> （端口4505）所有<code>Salt minions</code>都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。</li>\n<li><strong>Request Server</strong> （端口4506）<code>Salt minios</code>根据需要连接到请求服务器，将结果发送给<code>Salt master</code>，并安全地获取请求的文件或特定<code>minion</code>相关的数据值（称为<code>Salt pillar</code>）。连接到这个端口的连接在<code>Salt master</code>和<code>Salt minion</code>之间是1:1（不是异步）。</li>\n</ul>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# lsof -i:4505</span><br><span class=\"line\">COMMAND     PID<span class=\"built_in\"> USER </span>  FD  <span class=\"built_in\"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">salt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)</span><br><span class=\"line\">salt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505-&gt;salt-minion03:37240 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505-&gt;salt-minion01:47804 (ESTABLISHED)</span><br><span class=\"line\">salt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505-&gt;salt-minion02:58594 (ESTABLISHED)</span><br></pre></td></tr></table></figure>\n<h2 id=\"快速安装\"><a href=\"#快速安装\" class=\"headerlink\" title=\"快速安装\"></a>快速安装</h2><p>1.1 配置 yum 仓库<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用官方自带yum</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm</span><br><span class=\"line\"><span class=\"comment\"># 或者使用阿里云的yum（建议使用阿里云的，速度快一点）</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class=\"number\">2</span>.el7.noarch.rpm</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# sed</span> -i <span class=\"string\">\"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> clean all</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> makecache</span><br></pre></td></tr></table></figure></p>\n<p>1.2 安装Master，并启动服务<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> enable salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>1.3 安装 Salt-Minion 指向 Salt-Master 网络地址<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># yum -y install salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># 可以使用主机名，也可以使用IP地址</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># sed -i <span class=\"string\">'/#master: /c\\master: salt-master'</span> /etc/salt/minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl enable salt-minion</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-minion01 ~]<span class=\"meta\"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"SaltStack认证方式\"><a href=\"#SaltStack认证方式\" class=\"headerlink\" title=\"SaltStack认证方式\"></a>SaltStack认证方式</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-51113b6686102c1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"master与minion之间的架构关系图\"></p>\n<div class=\"note success\"><p> <code>Salt</code> 的数据传输是通过 <code>AES</code> 加密，<code>Master</code> 和 <code>Minion</code> 之前在通信之前，需要进行认证。<br><code>Salt</code> 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class=\"note success\"><p>1.  <code>minion</code> 在第一次启动时候，会在 <code>/etc/salt/pki/minion/</code> 下自动生成 <code>minion.pem(private key)</code> 和 <code>minion.pub(public key)</code>, 然后将 <code>minion.pub</code> 发送给 <code>master</code><br>2. <code>master</code> 在第一次启动时，会在 <code>/etc/salt/pki/master/</code> 下自动生成 <code>master.pem</code> 和 <code>master.pub</code> ；并且会接收到 <code>minion</code> 的 <code>public key</code> , 通过 <code>salt-key</code> 命令接收 <code>minion public key</code>， 会在 <code>master</code> 的 <code>/etc/salt/pki/master/minions</code> 目录下存放以 <code>minion id</code> 命令的 <code>public key</code> ；验证成功后同时 <code>minion</code> 会保存一份 <code>master public key</code> 在 minion的 <code>/etc/salt/pki/minion/minion_master.pub</code>里。</p></div>\n\n<p><strong>Salt认证原理总结</strong></p>\n<blockquote>\n<p><code>minion</code>将自己的公钥发送给<code>master</code><br><code>master</code>认证后再将自己的公钥也发送给<code>minion</code>端</p>\n</blockquote>\n<p><strong>Master端认证示例</strong><br>根据上面提到的认证原理，先看下未认证前的<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上查看</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上查看</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>命令解释：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt-key</span> <span class=\"bullet\">-L</span> </span><br><span class=\"line\"><span class=\"string\">Accepted</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#已经接受的key</span></span><br><span class=\"line\"><span class=\"string\">Denied</span> <span class=\"attr\">Keys:</span>          <span class=\"comment\">#拒绝的key</span></span><br><span class=\"line\"><span class=\"string\">Unaccepted</span> <span class=\"attr\">Keys:</span>      <span class=\"comment\">#未加入的key</span></span><br><span class=\"line\"><span class=\"string\">Rejected</span> <span class=\"attr\">Keys:</span>        <span class=\"comment\">#吊销的key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#常用参数</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">L</span>  <span class=\"comment\">#查看KEY状态</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">A</span>  <span class=\"comment\">#允许所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">D</span>  <span class=\"comment\">#删除所有</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">a</span>  <span class=\"comment\">#认证指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">d</span>  <span class=\"comment\">#删除指定的key</span></span><br><span class=\"line\"><span class=\"bullet\">-</span><span class=\"string\">r</span>  <span class=\"comment\">#注销掉指定key（该状态为未被认证）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置master自动接受请求认证(master上配置 /etc/salt/master)</span></span><br><span class=\"line\"><span class=\"attr\">auto_accept:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p><code>salt-key</code>认证<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#列出当前所有的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加指定minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -a salt-minion01 -y</span><br><span class=\"line\">The following keys are going to be accepted:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Key for minion salt-minion01 accepted.</span><br><span class=\"line\"><span class=\"comment\">#添加所有minion的key</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -A -y</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">Rejected Keys:</span><br></pre></td></tr></table></figure></p>\n<p>上面认证完成后再次查看<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master上</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /etc/salt/pki/</span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pem</span><br><span class=\"line\">│   ├── <span class=\"literal\">master</span>.pub</span><br><span class=\"line\">│   ├── minions</span><br><span class=\"line\">│   │   └── salt-minion01</span><br><span class=\"line\">│   ├── minions_autosign</span><br><span class=\"line\">│   ├── minions_denied</span><br><span class=\"line\">│   ├── minions_pre</span><br><span class=\"line\">│   └── minions_rejected</span><br><span class=\"line\">└── minion</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># minion上</span></span><br><span class=\"line\">[root@salt-minion01 ~]<span class=\"comment\"># tree /etc/salt/pki/</span></span><br><span class=\"line\">/etc/salt/pki/</span><br><span class=\"line\">├── <span class=\"literal\">master</span></span><br><span class=\"line\">└── minion</span><br><span class=\"line\">    ├── minion_master.pub</span><br><span class=\"line\">    ├── minion.pem</span><br><span class=\"line\">    └── minion.pub</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack远程执行\"><a href=\"#Saltstack远程执行\" class=\"headerlink\" title=\"Saltstack远程执行\"></a>Saltstack远程执行</h2><blockquote>\n<p>远程执行是 <code>Saltstack</code> 的核心功能之一。主要使用 <code>salt</code> 模块批量给选定的 <code>minion</code> 端执行相应的命令，并获得返回结果。</p>\n</blockquote>\n<p>1、判断 <code>salt</code> 的 <code>minion</code> 主机是否存活<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">salt</span> <span class=\"string\">'*'</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion03:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt-minion01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># salt saltstack自带的一个命令</span></span><br><span class=\"line\"><span class=\"comment\"># * 表示目标主机，这里表示所有目标主机</span></span><br><span class=\"line\"><span class=\"comment\"># test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法</span></span><br></pre></td></tr></table></figure></p>\n<p>2、<code>saltstack</code>使用 <code>cmd.run</code>模块远程执行shell命令<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#在指定目标minion节点运行uptime命令</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'salt-minion02'</span> cmd.run <span class=\"string\">'uptime'</span></span></span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">     <span class=\"number\">18</span>:<span class=\"number\">13</span>:<span class=\"number\">08</span> up <span class=\"number\">28</span> min,  <span class=\"number\">2</span> users,  load average: <span class=\"number\">0.00</span>, <span class=\"number\">0.04</span>, <span class=\"number\">0.13</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack配置管理\"><a href=\"#Saltstack配置管理\" class=\"headerlink\" title=\"Saltstack配置管理\"></a>Saltstack配置管理</h2><p><div class=\"note success\"><p><code>Salt</code> 通过<code>State</code>模块来进行文件的管理；通过<code>YAML</code>语法来描述，后缀是<code>.sls</code>的文件</p></div>1、了解 <code>YAML</code> 参考：<a href=\"http://docs.saltstack.cn/topics/yaml/index.html\" target=\"_blank\" rel=\"noopener\">http://docs.saltstack.cn/topics/yaml/index.html</a><br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">remove <span class=\"string\">vim:</span></span><br><span class=\"line\">  pkg.<span class=\"string\">removed:</span></span><br><span class=\"line\">    - <span class=\"string\">name:</span> vim</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>带有ID和每个函数调用的行都以冒号（:)结束。</li>\n<li>每个函数调用在ID下面缩进两个空格。</li>\n<li>参数作为列表传递给每个函数。</li>\n<li>每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。</li>\n<li>如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。</li>\n<li>如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格</li>\n</ul>\n<p>2、配置<code>sals</code> ,定义环境   <a href=\"https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md\" target=\"_blank\" rel=\"noopener\">参考文档</a><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义环境目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">file_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/salt/base</span><br><span class=\"line\">  dev:</span><br><span class=\"line\">    - /srv/salt/dev</span><br><span class=\"line\">  prod:</span><br><span class=\"line\">    - /srv/salt/prod</span><br><span class=\"line\"><span class=\"comment\"># 创建上面定义的目录</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\"><span class=\"comment\"># 重启服务</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>3、编写第一个<code>sls</code>文件<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在base环境下编写第一个安装apache的sls文件</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cd /srv/salt/base/</span></span><br><span class=\"line\">[root@salt-master base]<span class=\"comment\"># cat apache.sls </span></span><br><span class=\"line\">apache-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在dev环境下编写一个安装ftp的sls文件</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> base]<span class=\"comment\"># cd /srv/salt/dev/</span></span><br><span class=\"line\">[root@<span class=\"keyword\">salt</span>-<span class=\"keyword\">master</span> dev]<span class=\"comment\"># cat vsftpd.sls </span></span><br><span class=\"line\">vsftpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\"></span><br><span class=\"line\">vsftpd-service:</span><br><span class=\"line\">  service.running:</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: vsftpd</span><br><span class=\"line\">    - <span class=\"keyword\">enable</span>: <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<p>4、使用<code>salt</code>命令的<code>state</code>状态模块让<code>minion</code>应用配置<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls apache</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># 让所有的minion都安装vsftpd（saltenv指定环境）</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls vsftpd saltenv=dev</span></span><br></pre></td></tr></table></figure></p>\n<p>5、使用<code>salt</code>的高级状态使不同主机应用不同的配置<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># topfile入口文件只能放在base环境</span></span><br><span class=\"line\">[<span class=\"meta\">root@salt-master ~</span>]<span class=\"meta\"># cat /srv/salt/base/top.sls </span></span><br><span class=\"line\"><span class=\"keyword\">base</span>:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion01'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - apache</span><br><span class=\"line\">dev:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion02'</span>:</span><br><span class=\"line\">    - vsftpd</span><br><span class=\"line\">  <span class=\"string\">'salt-minion03'</span>:</span><br><span class=\"line\">    - vsftpd</span><br></pre></td></tr></table></figure></p>\n<p>6、使用<code>salt</code>命令执行高级状态，会将<code>top.sls</code>当做入口文件，进行调用<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 将高级状态应用到所有主机</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Saltstack常用配置\"><a href=\"#Saltstack常用配置\" class=\"headerlink\" title=\"Saltstack常用配置\"></a>Saltstack常用配置</h2><p>1、<strong>Salt Master配置</strong><br><code>Salt Master</code>端的配置文件<code>/etc/salt/master</code>，常用配置如下：<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">interface</span>: \t<span class=\"comment\">//指定bind 的地址(默认为0.0.0.0)</span></span><br><span class=\"line\"><span class=\"attribute\">publish_port</span>: <span class=\"comment\">//指定发布端口(默认为4505)</span></span><br><span class=\"line\"><span class=\"attribute\">ret_port</span>: <span class=\"comment\">//指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"attribute\">user</span>: <span class=\"comment\">//指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)</span></span><br><span class=\"line\"><span class=\"attribute\">timeout</span>: <span class=\"comment\">//指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)</span></span><br><span class=\"line\"><span class=\"attribute\">keep_jobs</span>: <span class=\"comment\">//minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)</span></span><br><span class=\"line\"><span class=\"attribute\">job_cache</span>: <span class=\"comment\">//master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)</span></span><br><span class=\"line\"><span class=\"attribute\">file_recv </span>: <span class=\"comment\">//是否允许minion传送文件到master 上(默认是Flase)</span></span><br><span class=\"line\"><span class=\"attribute\">file_roots</span>: <span class=\"comment\">//指定file server目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">file_roots</span>:    </span><br><span class=\"line\">       <span class=\"attribute\">base</span>:    </span><br><span class=\"line\">        - /srv/salt     </span><br><span class=\"line\"><span class=\"attribute\">pillar_roots </span>: <span class=\"comment\">//指定pillar 目录,  默认为:</span></span><br><span class=\"line\">    <span class=\"attribute\">pillar_roots</span>:     </span><br><span class=\"line\">      <span class=\"attribute\">base</span>:     </span><br><span class=\"line\">        - /srv/pillar     </span><br><span class=\"line\"><span class=\"attribute\">log_level</span>: <span class=\"comment\">//日志级别</span></span><br><span class=\"line\">支持的日志级别有<span class=\"string\">'garbage'</span>, <span class=\"string\">'trace'</span>, <span class=\"string\">'debug'</span>, info<span class=\"string\">', '</span>warning<span class=\"string\">', '</span>error', ‘critical ’ ( 默认为’warning’)</span><br></pre></td></tr></table></figure></p>\n<p>2、<code>Salt Minion</code>端的配置文件<code>/etc/salt/minion</code>，常用配置如下：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">master:</span> <span class=\"comment\">//指定master 主机(默认为salt)</span></span><br><span class=\"line\"><span class=\"string\">master_port:</span> <span class=\"comment\">//指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)</span></span><br><span class=\"line\"><span class=\"string\">id:</span> <span class=\"comment\">//指定本minion的标识, salt内部使用id作为标识(默认为主机名)</span></span><br><span class=\"line\"><span class=\"string\">user:</span> <span class=\"comment\">//指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)</span></span><br><span class=\"line\"><span class=\"string\">cache_jobs :</span> <span class=\"comment\">//minion是否缓存执行结果(默认为False)</span></span><br><span class=\"line\"><span class=\"string\">backup_mode:</span> <span class=\"comment\">//在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效</span></span><br><span class=\"line\"><span class=\"string\">providers :</span> <span class=\"comment\">//指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5</span></span><br><span class=\"line\"><span class=\"string\">renderer:</span> <span class=\"comment\">//指定配置管理系统中的渲染器(默认值为:yaml_jinja )</span></span><br><span class=\"line\"><span class=\"string\">file_client :</span> <span class=\"comment\">//指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)</span></span><br><span class=\"line\"><span class=\"string\">loglevel:</span> <span class=\"comment\">//指定日志级别(默认为warning)</span></span><br><span class=\"line\"><span class=\"string\">tcp_keepalive :</span> <span class=\"comment\">//minion 是否与master 保持keepalive 检查, zeromq3(默认为True)</span></span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack配置管理","date":"2019-05-15T15:42:05.000Z","copyright":true,"_content":"## Saltstack状态模块\n>远程执行模块的执行是过程式，而状态是对`minion`的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述`minion`的状态描述。\n它的和兴是写`sls(Salt State file)`文件，`sls`文件默认格式为`YAML`格式，并默认使用`jinja`模板，`jinja`是根据`django`的模板语言发展而来的语言，简单并强大，支持`for if `等循环语句。`salt state`主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。\n\n```\nmysql-install:   #ID声明，必须唯一\n  pkg.installed:   #state状态声明\n    - pkgs:   #选项声明\n      - mariadb:   #选项列表\n      - mariadb-server\n\n说明：\n一个ID只能出现一次\n一个ID下相同模块只能使用一次\n一个ID下不可以使用多个不同模块\n```\n模块帮助手册\n```\n#列出所有状态模块\n[root@salt-master ~]# salt '*' sys.list_modules\n#查看指定模块的所有方法\n[root@salt-master ~]# salt '*' sys.list_state_functions pkg\n#查看指定模块的使用方法\n[root@salt-master ~]# salt '*' sys.state_doc pkg\n#查看指定模块的指定方法的用法\n[root@salt-master ~]# salt '*' sys.state_doc pkg.installed\n```\n### pkg软件模块\n[pkg模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html)\n`pkg.installed` 软件安装\n```\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql: \">=5.4.16\"    #指定安装版本\n      - php-pdo\n      - php-cli\n```\n指定安装最新版本的软件\n```\nphp-install:\n  pkg.latest:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n```\n### file文件模块\n[file模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html)\n`file.managed` 下发文件，确保文件存在\n```\n[root@salt-master ~]# mkdir /srv/salt/base/files\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/base/files/\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\n说明：\n- name: 表示存放目的地址\n- source: 表示这个文件来自哪里（说明这个文件得提前准备）\n\n或者这样写，直接已目的地址命令ID，这样ID也表示目的地址\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\n/etc/httpd/conf/httpd.conf:\n  file.managed:\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n```\n```\n小示例：\n[root@salt-master ~]# cat /srv/salt/base/test.sls\n/tmp/passwd_back:\n  file.managed:\n    - source: salt://files/passwd\n    - user: root\n    - group: root\n    - mode: 644\n[root@salt-master ~]# cp /etc/passwd /srv/salt/base/files/\n[root@salt-master ~]# salt '*' state.sls test\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /tmp/passwd_back\"\nsalt-minion03:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion02:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion01:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\n```\n`file.directory` 建立目录\n```\n[root@salt-master ~]# cat /srv/salt/base/directory.sls\n/tmp/saltdir:\n  file.directory:\n    - user: root\n    - group: root\n    - mode: 755\n    - makedirs: True   #如果上一级目录不存在自动创建；类似（mkdir -p）\n\n[root@salt-master ~]# salt '*' state.sls directory\n[root@salt-master ~]# salt '*' cmd.run \"ls -d /tmp/saltdir\"\nsalt-minion03:\n    /tmp/saltdir\nsalt-minion02:\n    /tmp/saltdir\nsalt-minion01:\n    /tmp/saltdir\n```\n`file.recurse` 下发整个目录\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd_conf_dir.sls\nhttpd_conf_dir:\n  file.recurse:\n    - name: /etc/httpd/conf.d\n    - source: salt://files/conf.d\n    - file_mode: 600    #文件权限\n    - dir_mode: 755    #目录权限\n    - include_empty: True   #同步空目录\n    - clean: True    #使用后minion与master保持一致\n\n[root@salt-master ~]# rsync -avh /etc/httpd/conf.d /srv/salt/base/files/\n```\n`file.symlink` 建立软链接\n```\n[root@salt-master ~]# cat /srv/salt/base/target_link.sls\n/etc/grub.cfg:\n  file.symlink:\n    - target: /etc/grub2.cfg\n\n[root@salt-master ~]# salt '*' state.sls target_link\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /etc/grub.cfg\"\nsalt-minion03:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion01:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion02:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\n```\n### service服务模块\n[service模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html)\n```\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:\n  service.running:\n    - name: httpd   #服务名称\n    - enable: True    #开机自启动\n    - reload: True    #允许重载配置文件，不写则是restart\n\n或者这样写\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:   #即表示ID，又表示服务名\n  service.running:\n    - enable: True\n    - reload: True\n```\n\n## 高级状态模块\n>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 `top file`\n来进行管理。可以通过正则，`grain`模块，或分组名，来进行匹配，再下一级是要执行的`state`文件\n\n可以将我们的配置需求转换为`YAML`并在`Top file`文件中表示：\n\n![](https://upload-images.jianshu.io/upload_images/11763553-9098e5814f51b40c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n`Top file`示例\n```\nbase:\n  '*': #通过正则去匹配所有minion\n    - app.nginx\n\n  webserver: #定义的分组名称\n    - match: nodegroup\n    - app.cron\n\n  'os:centos':  #通过grains模块匹配\n    - match: grains\n    - nginx \n```\n`Top file` 高级状态的执行\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## LAMP架构案例\n说明：该案例在`prod`环境配置\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir /srv/salt/prod/{httpd,php,mysql,files}\n```\n3）配置文件准备及测试文件准备\n```\n[root@salt-master ~]# cp /etc/my.cnf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/php.ini  /srv/salt/prod/files/\n[root@salt-master ~]# echo \"<h1>LAMP html</h1>\" >>/srv/salt/prod/files/index.html\n[root@salt-master ~]# echo \"<?php phpinfo(); ?>\" >> /srv/salt/prod/files/index.php\n```\n4）编写`state sls`状态文件\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n\n#测试文件\n[root@salt-master ~]# cat /srv/salt/prod/testfile.sls\n/var/www/html/index.html:\n  file.managed:\n    - source: salt://files/index.html\n\n/var/www/html/index.php:\n  file.managed:\n    - source: salt://files/index.php\n```\n6）`topfile`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - httpd.init\n    - php.init\n    - mysql.init\n    - testfile\n```\n7）部署`LAMP`整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n```\n8）执行`topfile`\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## States状态依赖\n通过上面的`lamp`可以看出已经可以使用`state`模块来定义`minion`的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用`requisites`来进行控制\n>关系说明：\n1、`require` 我依赖某个状态，我依赖谁\n2、`require_in` 我被某个状态依赖，谁依赖我\n3、`watch` 我关注某个状态，当状态发生改变，进行`restart`或者`reload`操作\n4、`watch_in` 我被某个状态关注\n5、`include` 我引用谁\n\n1）修改上面`lamp`状态间依赖关系\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: apache-install   #表示上面apache-install执行成功，才能执行apache-config\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n    - require:\n      - file: apache-config\n    - watch:\n      - file: apache-config\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n    - reqiure_in:\n      - file: php-config\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: mariadb-install\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n    - reload: True\n    - require:\n      - file: mariadb-config\n    - watch:\n      - file: mariadb-config\n```\n2）修改引用关系后`include`\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── lamp.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n\n[root@salt-master ~]# cat /srv/salt/prod/lamp.sls\ninclude:\n  - httpd.init\n  - php.init\n  - mysql.init\n  - testfile\n\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - lamp\n```\n3）编写`SLS`技巧\n>1、按照状态分类，如果单独使用，清晰明了\n2、按照服务分类，可以被其它`SLS`引用\n\n## Jinja模板使用\n>配置文件一般灵活多变，比如配置`apache`的`IP`地址或者端口`PORT`等，则可以动态传值。\n[Jinja官档](http://docs.jinkan.org/docs/jinja2/)\n[salt jinja官档](https://docs.saltstack.com/en/latest/topics/jinja/index.html)\n\n`Jinja2` 模板包含变量和表达式，变量用 &#123;&#123; ... &#125;&#125; 包围，表达式用 &#123;&#37; ... &#37;&#125; 包围。变量使用示例：\n```\n[root@salt-master ~]# cat /srv/salt/base/var.sls \n{% set var= 'hello world!' %}\ntest_var:\n  cmd.run:\n    - name: echo \"测试变量 {{ var }}\"\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls var\nsalt-minion01:\n----------\n          ID: test_var\n    Function: cmd.run\n        Name: echo \"测试变量 hello world!\"\n      Result: True\n     Comment: Command \"echo \"测试变量 hello world!\"\" run\n     Started: 14:50:58.302424\n    Duration: 12.358 ms\n     Changes:   \n              ----------\n              pid:\n                  22510\n              retcode:\n                  0\n              stderr:\n              stdout:\n                  测试变量 hello world!\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  12.358 ms\n```\n`jinja2` 常用变量\n1、字符串类型\n```\n{% set var = 'test' %}  #定义变量\n{{ var }}  #调用变量\n```\n2、列表类型\n```\n{% set list = ['one', 'two', 'three'] %}\n{{ list[1] }}  #获取变量的第一个值\n```\n3、字典类型\n```\n{% set dict = {'key1':'value1', 'key2':'value2'} %}\n{{ dict['key1'] }}  #获取'key1'的值\n```\n示例1：`Saltstack`使用`jinja`模块配置`apache`监听端口\n```\n#1.告诉file状态模块，需要使用jinja\n    - template: jinja\n#2.列出参数列表\n    - defaults:\n      PORT: 8000\n#3.配置文件引用jinja模板\n{{ PORT }}\n\n# 配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n\n# 修改httpd.conf配置文件引用变量\nListen {{ PORT }}\n```\n示例2：使用`grinas` 方式进行赋值\n```\n#配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n      IPADDR: {{ grains['fqdn_ip4'][0] }}\n\n# 修改httpd.conf配置文件引用变量\nListen {{ IPADDR }}:{{ PORT }}\n```\n示例3：通过`jinja+grains`根据系统不同安装`apache`\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd.sls\n#根据grains获取的值判别系统后安装软件\nhttpd-install:\n  pkg.installed:\n{% if grains['os'] == 'CentOS' %}\n    - name: httpd\n{% elif grains['OS'] == 'Debin' %}\n    - name: apache2\n{% endif %}\n```\n\n\n","source":"_posts/saltstack配置管理.md","raw":"---\ntitle: saltstack配置管理\ndate: 2019-05-15 23:42:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## Saltstack状态模块\n>远程执行模块的执行是过程式，而状态是对`minion`的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述`minion`的状态描述。\n它的和兴是写`sls(Salt State file)`文件，`sls`文件默认格式为`YAML`格式，并默认使用`jinja`模板，`jinja`是根据`django`的模板语言发展而来的语言，简单并强大，支持`for if `等循环语句。`salt state`主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。\n\n```\nmysql-install:   #ID声明，必须唯一\n  pkg.installed:   #state状态声明\n    - pkgs:   #选项声明\n      - mariadb:   #选项列表\n      - mariadb-server\n\n说明：\n一个ID只能出现一次\n一个ID下相同模块只能使用一次\n一个ID下不可以使用多个不同模块\n```\n模块帮助手册\n```\n#列出所有状态模块\n[root@salt-master ~]# salt '*' sys.list_modules\n#查看指定模块的所有方法\n[root@salt-master ~]# salt '*' sys.list_state_functions pkg\n#查看指定模块的使用方法\n[root@salt-master ~]# salt '*' sys.state_doc pkg\n#查看指定模块的指定方法的用法\n[root@salt-master ~]# salt '*' sys.state_doc pkg.installed\n```\n### pkg软件模块\n[pkg模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html)\n`pkg.installed` 软件安装\n```\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql: \">=5.4.16\"    #指定安装版本\n      - php-pdo\n      - php-cli\n```\n指定安装最新版本的软件\n```\nphp-install:\n  pkg.latest:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n```\n### file文件模块\n[file模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html)\n`file.managed` 下发文件，确保文件存在\n```\n[root@salt-master ~]# mkdir /srv/salt/base/files\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/base/files/\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\n说明：\n- name: 表示存放目的地址\n- source: 表示这个文件来自哪里（说明这个文件得提前准备）\n\n或者这样写，直接已目的地址命令ID，这样ID也表示目的地址\n[root@salt-master ~]# cat /srv/salt/base/apache_conf.sls\n/etc/httpd/conf/httpd.conf:\n  file.managed:\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n```\n```\n小示例：\n[root@salt-master ~]# cat /srv/salt/base/test.sls\n/tmp/passwd_back:\n  file.managed:\n    - source: salt://files/passwd\n    - user: root\n    - group: root\n    - mode: 644\n[root@salt-master ~]# cp /etc/passwd /srv/salt/base/files/\n[root@salt-master ~]# salt '*' state.sls test\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /tmp/passwd_back\"\nsalt-minion03:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion02:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\nsalt-minion01:\n    -rw-r--r-- 1 root root 2098 May 15 16:21 /tmp/passwd_back\n```\n`file.directory` 建立目录\n```\n[root@salt-master ~]# cat /srv/salt/base/directory.sls\n/tmp/saltdir:\n  file.directory:\n    - user: root\n    - group: root\n    - mode: 755\n    - makedirs: True   #如果上一级目录不存在自动创建；类似（mkdir -p）\n\n[root@salt-master ~]# salt '*' state.sls directory\n[root@salt-master ~]# salt '*' cmd.run \"ls -d /tmp/saltdir\"\nsalt-minion03:\n    /tmp/saltdir\nsalt-minion02:\n    /tmp/saltdir\nsalt-minion01:\n    /tmp/saltdir\n```\n`file.recurse` 下发整个目录\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd_conf_dir.sls\nhttpd_conf_dir:\n  file.recurse:\n    - name: /etc/httpd/conf.d\n    - source: salt://files/conf.d\n    - file_mode: 600    #文件权限\n    - dir_mode: 755    #目录权限\n    - include_empty: True   #同步空目录\n    - clean: True    #使用后minion与master保持一致\n\n[root@salt-master ~]# rsync -avh /etc/httpd/conf.d /srv/salt/base/files/\n```\n`file.symlink` 建立软链接\n```\n[root@salt-master ~]# cat /srv/salt/base/target_link.sls\n/etc/grub.cfg:\n  file.symlink:\n    - target: /etc/grub2.cfg\n\n[root@salt-master ~]# salt '*' state.sls target_link\n[root@salt-master ~]# salt '*' cmd.run \"ls -l /etc/grub.cfg\"\nsalt-minion03:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion01:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\nsalt-minion02:\n    lrwxrwxrwx 1 root root 14 May 15 16:42 /etc/grub.cfg -> /etc/grub2.cfg\n```\n### service服务模块\n[service模块官档](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html)\n```\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:\n  service.running:\n    - name: httpd   #服务名称\n    - enable: True    #开机自启动\n    - reload: True    #允许重载配置文件，不写则是restart\n\n或者这样写\n[root@salt-master ~]# cat /srv/salt/base/service_httpd.sls\nhttpd:   #即表示ID，又表示服务名\n  service.running:\n    - enable: True\n    - reload: True\n```\n\n## 高级状态模块\n>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 `top file`\n来进行管理。可以通过正则，`grain`模块，或分组名，来进行匹配，再下一级是要执行的`state`文件\n\n可以将我们的配置需求转换为`YAML`并在`Top file`文件中表示：\n\n![](https://upload-images.jianshu.io/upload_images/11763553-9098e5814f51b40c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n`Top file`示例\n```\nbase:\n  '*': #通过正则去匹配所有minion\n    - app.nginx\n\n  webserver: #定义的分组名称\n    - match: nodegroup\n    - app.cron\n\n  'os:centos':  #通过grains模块匹配\n    - match: grains\n    - nginx \n```\n`Top file` 高级状态的执行\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## LAMP架构案例\n说明：该案例在`prod`环境配置\n1）环境准备，定义`file_roots`环境\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  dev:\n    - /srv/salt/dev\n  prod:\n    - /srv/salt/prod\n```\n2）创建对应环境目录\n```\n[root@salt-master ~]# mkdir -p /srv/salt/{base,dev,prod}\n[root@salt-master ~]# mkdir /srv/salt/prod/{httpd,php,mysql,files}\n```\n3）配置文件准备及测试文件准备\n```\n[root@salt-master ~]# cp /etc/my.cnf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/httpd/conf/httpd.conf /srv/salt/prod/files/\n[root@salt-master ~]# cp /etc/php.ini  /srv/salt/prod/files/\n[root@salt-master ~]# echo \"<h1>LAMP html</h1>\" >>/srv/salt/prod/files/index.html\n[root@salt-master ~]# echo \"<?php phpinfo(); ?>\" >> /srv/salt/prod/files/index.php\n```\n4）编写`state sls`状态文件\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n\n#测试文件\n[root@salt-master ~]# cat /srv/salt/prod/testfile.sls\n/var/www/html/index.html:\n  file.managed:\n    - source: salt://files/index.html\n\n/var/www/html/index.php:\n  file.managed:\n    - source: salt://files/index.php\n```\n6）`topfile`文件编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - httpd.init\n    - php.init\n    - mysql.init\n    - testfile\n```\n7）部署`LAMP`整体`state`文件查看\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n```\n8）执行`topfile`\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n## States状态依赖\n通过上面的`lamp`可以看出已经可以使用`state`模块来定义`minion`的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用`requisites`来进行控制\n>关系说明：\n1、`require` 我依赖某个状态，我依赖谁\n2、`require_in` 我被某个状态依赖，谁依赖我\n3、`watch` 我关注某个状态，当状态发生改变，进行`restart`或者`reload`操作\n4、`watch_in` 我被某个状态关注\n5、`include` 我引用谁\n\n1）修改上面`lamp`状态间依赖关系\n```\n#httpd\n[root@salt-master ~]# cat /srv/salt/prod/httpd/init.sls\napache-install:\n  pkg.installed:\n    - pkgs:\n      - httpd\n      - httpd-tools\n\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: apache-install   #表示上面apache-install执行成功，才能执行apache-config\n\napache-service:\n  service.running:\n    - name: httpd\n    - enable: True\n    - require:\n      - file: apache-config\n    - watch:\n      - file: apache-config\n\n#php\n[root@salt-master ~]# cat /srv/salt/prod/php/init.sls\nphp-install:\n  pkg.installed:\n    - pkgs:\n      - php\n      - php-mysql\n      - php-pdo\n      - php-cli\n    - reqiure_in:\n      - file: php-config\n\nphp-config:\n  file.managed:\n    - name: /etc/php.ini\n    - source: salt://files/php.ini\n    - user: root\n    - group: root\n    - mode: 644\n\n#mysql\n[root@salt-master ~]# cat /srv/salt/prod/mysql/init.sls\nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: mariadb-install\n\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n    - reload: True\n    - require:\n      - file: mariadb-config\n    - watch:\n      - file: mariadb-config\n```\n2）修改引用关系后`include`\n```\n[root@salt-master ~]# tree /srv/salt/\n/srv/salt/\n├── base\n│   └── top.sls\n├── dev\n└── prod\n    ├── files\n    │   ├── httpd.conf\n    │   ├── index.html\n    │   ├── index.php\n    │   ├── my.cnf\n    │   └── php.ini\n    ├── httpd\n    │   └── init.sls\n    ├── lamp.sls\n    ├── mysql\n    │   └── init.sls\n    ├── php\n    │   └── init.sls\n    └── testfile.sls\n\n[root@salt-master ~]# cat /srv/salt/prod/lamp.sls\ninclude:\n  - httpd.init\n  - php.init\n  - mysql.init\n  - testfile\n\n[root@salt-master ~]# cat /srv/salt/base/top.sls\nprod:\n  'salt-minion*':\n    - lamp\n```\n3）编写`SLS`技巧\n>1、按照状态分类，如果单独使用，清晰明了\n2、按照服务分类，可以被其它`SLS`引用\n\n## Jinja模板使用\n>配置文件一般灵活多变，比如配置`apache`的`IP`地址或者端口`PORT`等，则可以动态传值。\n[Jinja官档](http://docs.jinkan.org/docs/jinja2/)\n[salt jinja官档](https://docs.saltstack.com/en/latest/topics/jinja/index.html)\n\n`Jinja2` 模板包含变量和表达式，变量用 &#123;&#123; ... &#125;&#125; 包围，表达式用 &#123;&#37; ... &#37;&#125; 包围。变量使用示例：\n```\n[root@salt-master ~]# cat /srv/salt/base/var.sls \n{% set var= 'hello world!' %}\ntest_var:\n  cmd.run:\n    - name: echo \"测试变量 {{ var }}\"\n\n[root@salt-master ~]# salt 'salt-minion01' state.sls var\nsalt-minion01:\n----------\n          ID: test_var\n    Function: cmd.run\n        Name: echo \"测试变量 hello world!\"\n      Result: True\n     Comment: Command \"echo \"测试变量 hello world!\"\" run\n     Started: 14:50:58.302424\n    Duration: 12.358 ms\n     Changes:   \n              ----------\n              pid:\n                  22510\n              retcode:\n                  0\n              stderr:\n              stdout:\n                  测试变量 hello world!\n\nSummary for salt-minion01\n------------\nSucceeded: 1 (changed=1)\nFailed:    0\n------------\nTotal states run:     1\nTotal run time:  12.358 ms\n```\n`jinja2` 常用变量\n1、字符串类型\n```\n{% set var = 'test' %}  #定义变量\n{{ var }}  #调用变量\n```\n2、列表类型\n```\n{% set list = ['one', 'two', 'three'] %}\n{{ list[1] }}  #获取变量的第一个值\n```\n3、字典类型\n```\n{% set dict = {'key1':'value1', 'key2':'value2'} %}\n{{ dict['key1'] }}  #获取'key1'的值\n```\n示例1：`Saltstack`使用`jinja`模块配置`apache`监听端口\n```\n#1.告诉file状态模块，需要使用jinja\n    - template: jinja\n#2.列出参数列表\n    - defaults:\n      PORT: 8000\n#3.配置文件引用jinja模板\n{{ PORT }}\n\n# 配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n\n# 修改httpd.conf配置文件引用变量\nListen {{ PORT }}\n```\n示例2：使用`grinas` 方式进行赋值\n```\n#配置示例\napache-config:\n  file.managed:\n    - name: /etc/httpd/conf/httpd.conf\n    - source: salt://files/httpd.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - template: jinja\n    - defaults:\n      PORT: 8000\n      IPADDR: {{ grains['fqdn_ip4'][0] }}\n\n# 修改httpd.conf配置文件引用变量\nListen {{ IPADDR }}:{{ PORT }}\n```\n示例3：通过`jinja+grains`根据系统不同安装`apache`\n```\n[root@salt-master ~]# cat /srv/salt/base/httpd.sls\n#根据grains获取的值判别系统后安装软件\nhttpd-install:\n  pkg.installed:\n{% if grains['os'] == 'CentOS' %}\n    - name: httpd\n{% elif grains['OS'] == 'Debin' %}\n    - name: apache2\n{% endif %}\n```\n\n\n","slug":"saltstack配置管理","published":1,"updated":"2019-05-17T13:23:02.898Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4mn001km834oeqhygfh","content":"<h2 id=\"Saltstack状态模块\"><a href=\"#Saltstack状态模块\" class=\"headerlink\" title=\"Saltstack状态模块\"></a>Saltstack状态模块</h2><blockquote>\n<p>远程执行模块的执行是过程式，而状态是对<code>minion</code>的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述<code>minion</code>的状态描述。<br>它的和兴是写<code>sls(Salt State file)</code>文件，<code>sls</code>文件默认格式为<code>YAML</code>格式，并默认使用<code>jinja</code>模板，<code>jinja</code>是根据<code>django</code>的模板语言发展而来的语言，简单并强大，支持<code>for if</code>等循环语句。<code>salt state</code>主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql-<span class=\"keyword\">install</span>:   <span class=\"comment\">#ID声明，必须唯一</span></span><br><span class=\"line\">  pkg.installed:   <span class=\"comment\">#state状态声明</span></span><br><span class=\"line\">    - pkgs:   <span class=\"comment\">#选项声明</span></span><br><span class=\"line\">      - mariadb:   <span class=\"comment\">#选项列表</span></span><br><span class=\"line\">      - mariadb-<span class=\"keyword\">server</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>只能出现一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下相同模块只能使用一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下不可以使用多个不同模块</span><br></pre></td></tr></table></figure>\n<p>模块帮助手册<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#列出所有状态模块</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_modules</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的所有方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_state_functions pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的使用方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的指定方法的用法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg.installed</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"pkg软件模块\"><a href=\"#pkg软件模块\" class=\"headerlink\" title=\"pkg软件模块\"></a>pkg软件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html\" target=\"_blank\" rel=\"noopener\">pkg模块官档</a><br><code>pkg.installed</code> 软件安装<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-<span class=\"symbol\">mysql:</span> <span class=\"string\">\"&gt;=5.4.16\"</span>    <span class=\"comment\">#指定安装版本</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<p>指定安装最新版本的软件<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.latest:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-mysql</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"file文件模块\"><a href=\"#file文件模块\" class=\"headerlink\" title=\"file文件模块\"></a>file文件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html\" target=\"_blank\" rel=\"noopener\">file模块官档</a><br><code>file.managed</code> 下发文件，确保文件存在<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"built_in\">mkdir</span> /srv/salt/base/<span class=\"keyword\">files</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cp</span> /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span> /srv/salt/base/<span class=\"keyword\">files</span>/</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">- name: 表示存放目的地址</span><br><span class=\"line\">- <span class=\"keyword\">source</span>: 表示这个文件来自哪里（说明这个文件得提前准备）</span><br><span class=\"line\"></span><br><span class=\"line\">或者这样写，直接已目的地址命令ID，这样ID也表示目的地址</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">/etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span>:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">小示例：</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/test.sls</span><br><span class=\"line\">/tmp/passwd_back:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - source: salt://files/passwd</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/passwd /srv/salt/base/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls test</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -l /tmp/passwd_back\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br></pre></td></tr></table></figure>\n<p><code>file.directory</code> 建立目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/directory.sls</span><br><span class=\"line\">/tmp/saltdir:</span><br><span class=\"line\">  file.directory:</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">755</span></span><br><span class=\"line\">    - makedirs: <span class=\"literal\">True</span>   <span class=\"comment\">#如果上一级目录不存在自动创建；类似（mkdir -p）</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls directory</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -d /tmp/saltdir\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    /tmp/saltdir</span><br></pre></td></tr></table></figure></p>\n<p><code>file.recurse</code> 下发整个目录<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/httpd_conf_dir.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd_conf_dir:</span></span><br><span class=\"line\">  <span class=\"string\">file.recurse:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - file_mode:</span> <span class=\"number\">600</span>    <span class=\"comment\">#文件权限</span></span><br><span class=\"line\"><span class=\"attr\">    - dir_mode:</span> <span class=\"number\">755</span>    <span class=\"comment\">#目录权限</span></span><br><span class=\"line\"><span class=\"attr\">    - include_empty:</span> <span class=\"literal\">True</span>   <span class=\"comment\">#同步空目录</span></span><br><span class=\"line\"><span class=\"attr\">    - clean:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#使用后minion与master保持一致</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">rsync</span> <span class=\"bullet\">-avh</span> <span class=\"string\">/etc/httpd/conf.d</span> <span class=\"string\">/srv/salt/base/files/</span></span><br></pre></td></tr></table></figure></p>\n<p><code>file.symlink</code> 建立软链接<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># cat /srv/salt/base/target_link.sls</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>grub.cfg:</span><br><span class=\"line\">  file.symlink:</span><br><span class=\"line\">    - target: <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls target_link</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"ls -l /etc/grub.cfg\"</span></span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"service服务模块\"><a href=\"#service服务模块\" class=\"headerlink\" title=\"service服务模块\"></a>service服务模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html\" target=\"_blank\" rel=\"noopener\">service模块官档</a><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span>   <span class=\"comment\">#服务名称</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#开机自启动</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#允许重载配置文件，不写则是restart</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">或者这样写</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span>   <span class=\"comment\">#即表示ID，又表示服务名</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"高级状态模块\"><a href=\"#高级状态模块\" class=\"headerlink\" title=\"高级状态模块\"></a>高级状态模块</h2><blockquote>\n<p>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 <code>top file</code><br>来进行管理。可以通过正则，<code>grain</code>模块，或分组名，来进行匹配，再下一级是要执行的<code>state</code>文件</p>\n</blockquote>\n<p>可以将我们的配置需求转换为<code>YAML</code>并在<code>Top file</code>文件中表示：</p>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-9098e5814f51b40c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<p><code>Top file</code>示例<br><figure class=\"highlight rsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base:</span><br><span class=\"line\">  <span class=\"string\">'*'</span>: <span class=\"meta\">#通过正则去匹配所有minion</span></span><br><span class=\"line\">    - app.nginx</span><br><span class=\"line\"></span><br><span class=\"line\">  webserver: <span class=\"meta\">#定义的分组名称</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: nodegroup</span><br><span class=\"line\">    - app.cron</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">'os:centos'</span>:  <span class=\"meta\">#通过grains模块匹配</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: grains</span><br><span class=\"line\">    - nginx</span><br></pre></td></tr></table></figure></p>\n<p><code>Top file</code> 高级状态的执行<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"LAMP架构案例\"><a href=\"#LAMP架构案例\" class=\"headerlink\" title=\"LAMP架构案例\"></a>LAMP架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/salt/prod/&#123;httpd,php,mysql,files&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）配置文件准备及测试文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/my.cnf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/httpd/conf/httpd.conf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/php.ini  /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;h1&gt;LAMP html&lt;/h1&gt;\"</span> &gt;&gt;/srv/salt/prod/files/index.html</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;?php phpinfo(); ?&gt;\"</span> &gt;&gt; /srv/salt/prod/files/index.php</span><br></pre></td></tr></table></figure></p>\n<p>4）编写<code>state sls</code>状态文件<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#httpd</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/httpd/init.sls</span><br><span class=\"line\">apache-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - httpd</span><br><span class=\"line\">      - httpd-tools</span><br><span class=\"line\"></span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: httpd</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#php</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/php/init.sls</span><br><span class=\"line\">php-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - php</span><br><span class=\"line\">      - php-mysql</span><br><span class=\"line\">      - php-pdo</span><br><span class=\"line\">      - php-cli</span><br><span class=\"line\"></span><br><span class=\"line\">php-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/php.ini</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/php.ini</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#mysql</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/mysql/init.sls</span><br><span class=\"line\">mariadb-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - mariadb-server</span><br><span class=\"line\">      - mariadb</span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: mariadb</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#测试文件</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/testfile.sls</span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.htm<span class=\"variable\">l:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.html</span><br><span class=\"line\"></span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.php:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.php</span><br></pre></td></tr></table></figure></p>\n<p>6）<code>topfile</code>文件编写<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - testfile</span><br></pre></td></tr></table></figure></p>\n<p>7）部署<code>LAMP</code>整体<code>state</code>文件查看<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">    │   ├── httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.html</span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.php</span><br><span class=\"line\">    │   ├── my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    └── testfile.sls</span><br></pre></td></tr></table></figure></p>\n<p>8）执行<code>topfile</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"States状态依赖\"><a href=\"#States状态依赖\" class=\"headerlink\" title=\"States状态依赖\"></a>States状态依赖</h2><p>通过上面的<code>lamp</code>可以看出已经可以使用<code>state</code>模块来定义<code>minion</code>的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用<code>requisites</code>来进行控制</p>\n<blockquote>\n<p>关系说明：<br>1、<code>require</code> 我依赖某个状态，我依赖谁<br>2、<code>require_in</code> 我被某个状态依赖，谁依赖我<br>3、<code>watch</code> 我关注某个状态，当状态发生改变，进行<code>restart</code>或者<code>reload</code>操作<br>4、<code>watch_in</code> 我被某个状态关注<br>5、<code>include</code> 我引用谁</p>\n</blockquote>\n<p>1）修改上面<code>lamp</code>状态间依赖关系<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#httpd</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/httpd/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">apache-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd-tools</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">apache-install</span>   <span class=\"comment\">#表示上面apache-install执行成功，才能执行apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/php/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">php-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-mysql</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-pdo</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-cli</span></span><br><span class=\"line\"><span class=\"attr\">    - reqiure_in:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">php-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#mysql</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/mysql/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb-server</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br></pre></td></tr></table></figure></p>\n<p>2）修改引用关系后<code>include</code><br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── files</span><br><span class=\"line\">    │   ├── httpd.conf</span><br><span class=\"line\">    │   ├── index.html</span><br><span class=\"line\">    │   ├── index.php</span><br><span class=\"line\">    │   ├── my.cnf</span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── lamp.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    └── testfile.sls</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/prod/lamp.sls</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - testfile</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - lamp</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>SLS</code>技巧</p>\n<blockquote>\n<p>1、按照状态分类，如果单独使用，清晰明了<br>2、按照服务分类，可以被其它<code>SLS</code>引用</p>\n</blockquote>\n<h2 id=\"Jinja模板使用\"><a href=\"#Jinja模板使用\" class=\"headerlink\" title=\"Jinja模板使用\"></a>Jinja模板使用</h2><blockquote>\n<p>配置文件一般灵活多变，比如配置<code>apache</code>的<code>IP</code>地址或者端口<code>PORT</code>等，则可以动态传值。<br><a href=\"http://docs.jinkan.org/docs/jinja2/\" target=\"_blank\" rel=\"noopener\">Jinja官档</a><br><a href=\"https://docs.saltstack.com/en/latest/topics/jinja/index.html\" target=\"_blank\" rel=\"noopener\">salt jinja官档</a></p>\n</blockquote>\n<p><code>Jinja2</code> 模板包含变量和表达式，变量用 &#123;&#123; … &#125;&#125; 包围，表达式用 &#123;&#37; … &#37;&#125; 包围。变量使用示例：<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/base/var.sls </span><br><span class=\"line\">&#123;% set var= <span class=\"emphasis\">'hello world!'</span> %&#125;</span><br><span class=\"line\">test<span class=\"emphasis\">_var:</span></span><br><span class=\"line\"><span class=\"emphasis\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"emphasis\">    - name: echo \"测试变量 &#123;&#123; var &#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"emphasis\"></span></span><br><span class=\"line\"><span class=\"emphasis\">[root@salt-master ~]# salt 'salt-minion01' state.sls var</span></span><br><span class=\"line\"><span class=\"emphasis\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"emphasis\">----------</span></span><br><span class=\"line\"><span class=\"emphasis\">          ID: test_</span>var</span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: echo \"测试变量 hello world!\"</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"echo \"测试变量 hello world!\"\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 14:50:58.302424</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 12.358 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  22510</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"><span class=\"code\">                  测试变量 hello world!</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  12.358 ms</span><br></pre></td></tr></table></figure></p>\n<p><code>jinja2</code> 常用变量<br>1、字符串类型<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> <span class=\"keyword\">var</span> = <span class=\"string\">'test'</span> %&#125;  <span class=\"meta\">#定义变量</span></span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">var</span> &#125;&#125;  <span class=\"meta\">#调用变量</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表类型<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% set <span class=\"keyword\">list</span> = [<span class=\"string\">'one'</span>, <span class=\"string\">'two'</span>, <span class=\"string\">'three'</span>] %&#125;</span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">list</span>[<span class=\"number\">1</span>] &#125;&#125;  <span class=\"comment\">#获取变量的第一个值</span></span><br></pre></td></tr></table></figure></p>\n<p>3、字典类型<br><figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> dict <span class=\"comment\">= &#123;</span><span class=\"comment\">'key1'</span><span class=\"comment\">:</span><span class=\"comment\">'value1'</span><span class=\"comment\">,</span> <span class=\"comment\">'key2'</span><span class=\"comment\">:</span><span class=\"comment\">'value2'</span><span class=\"comment\">&#125; %&#125;</span></span><br><span class=\"line\">&#123;&#123; dict[<span class=\"string\">'key1'</span>] &#125;&#125;  #获取<span class=\"string\">'key1'</span>的值</span><br></pre></td></tr></table></figure></p>\n<p>示例1：<code>Saltstack</code>使用<code>jinja</code>模块配置<code>apache</code>监听端口<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.告诉file状态模块，需要使用jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"comment\">#2.列出参数列表</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"comment\">#3.配置文件引用jinja模板</span></span><br><span class=\"line\"><span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例2：使用<code>grinas</code> 方式进行赋值<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"attr\">      IPADDR:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">IPADDR</span> <span class=\"string\">&#125;&#125;:&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例3：通过<code>jinja+grains</code>根据系统不同安装<code>apache</code><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cat /srv/salt/base/httpd.sls</span></span><br><span class=\"line\"><span class=\"comment\">#根据grains获取的值判别系统后安装软件</span></span><br><span class=\"line\">httpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">&#123;% <span class=\"keyword\">if</span> grains[<span class=\"string\">'os'</span>] == <span class=\"string\">'CentOS'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">&#123;% elif grains[<span class=\"string\">'OS'</span>] == <span class=\"string\">'Debin'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: apache2</span><br><span class=\"line\">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Saltstack状态模块\"><a href=\"#Saltstack状态模块\" class=\"headerlink\" title=\"Saltstack状态模块\"></a>Saltstack状态模块</h2><blockquote>\n<p>远程执行模块的执行是过程式，而状态是对<code>minion</code>的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述<code>minion</code>的状态描述。<br>它的和兴是写<code>sls(Salt State file)</code>文件，<code>sls</code>文件默认格式为<code>YAML</code>格式，并默认使用<code>jinja</code>模板，<code>jinja</code>是根据<code>django</code>的模板语言发展而来的语言，简单并强大，支持<code>for if</code>等循环语句。<code>salt state</code>主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql-<span class=\"keyword\">install</span>:   <span class=\"comment\">#ID声明，必须唯一</span></span><br><span class=\"line\">  pkg.installed:   <span class=\"comment\">#state状态声明</span></span><br><span class=\"line\">    - pkgs:   <span class=\"comment\">#选项声明</span></span><br><span class=\"line\">      - mariadb:   <span class=\"comment\">#选项列表</span></span><br><span class=\"line\">      - mariadb-<span class=\"keyword\">server</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>只能出现一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下相同模块只能使用一次</span><br><span class=\"line\">一个<span class=\"keyword\">ID</span>下不可以使用多个不同模块</span><br></pre></td></tr></table></figure>\n<p>模块帮助手册<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#列出所有状态模块</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_modules</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的所有方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.list_state_functions pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的使用方法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg</span></span><br><span class=\"line\"><span class=\"meta\">#查看指定模块的指定方法的用法</span></span><br><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> sys.state_doc pkg.installed</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"pkg软件模块\"><a href=\"#pkg软件模块\" class=\"headerlink\" title=\"pkg软件模块\"></a>pkg软件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html\" target=\"_blank\" rel=\"noopener\">pkg模块官档</a><br><code>pkg.installed</code> 软件安装<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-<span class=\"symbol\">mysql:</span> <span class=\"string\">\"&gt;=5.4.16\"</span>    <span class=\"comment\">#指定安装版本</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<p>指定安装最新版本的软件<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php-install:</span><br><span class=\"line\">  pkg.latest:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - php</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-mysql</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-pdo</span></span><br><span class=\"line\"><span class=\"ruby\">      - php-cli</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"file文件模块\"><a href=\"#file文件模块\" class=\"headerlink\" title=\"file文件模块\"></a>file文件模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html\" target=\"_blank\" rel=\"noopener\">file模块官档</a><br><code>file.managed</code> 下发文件，确保文件存在<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# <span class=\"built_in\">mkdir</span> /srv/salt/base/<span class=\"keyword\">files</span></span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cp</span> /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span> /srv/salt/base/<span class=\"keyword\">files</span>/</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">- name: 表示存放目的地址</span><br><span class=\"line\">- <span class=\"keyword\">source</span>: 表示这个文件来自哪里（说明这个文件得提前准备）</span><br><span class=\"line\"></span><br><span class=\"line\">或者这样写，直接已目的地址命令ID，这样ID也表示目的地址</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class=\"line\">/etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span>:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">小示例：</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/test.sls</span><br><span class=\"line\">/tmp/passwd_back:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - source: salt://files/passwd</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">644</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/passwd /srv/salt/base/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls test</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -l /tmp/passwd_back\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    -rw-r--r-- <span class=\"number\">1</span> root root <span class=\"number\">2098</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">21</span> /tmp/passwd_back</span><br></pre></td></tr></table></figure>\n<p><code>file.directory</code> 建立目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/directory.sls</span><br><span class=\"line\">/tmp/saltdir:</span><br><span class=\"line\">  file.directory:</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: <span class=\"number\">755</span></span><br><span class=\"line\">    - makedirs: <span class=\"literal\">True</span>   <span class=\"comment\">#如果上一级目录不存在自动创建；类似（mkdir -p）</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' state.sls directory</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' cmd.run <span class=\"string\">\"ls -d /tmp/saltdir\"</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    /tmp/saltdir</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    /tmp/saltdir</span><br></pre></td></tr></table></figure></p>\n<p><code>file.recurse</code> 下发整个目录<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/httpd_conf_dir.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd_conf_dir:</span></span><br><span class=\"line\">  <span class=\"string\">file.recurse:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - file_mode:</span> <span class=\"number\">600</span>    <span class=\"comment\">#文件权限</span></span><br><span class=\"line\"><span class=\"attr\">    - dir_mode:</span> <span class=\"number\">755</span>    <span class=\"comment\">#目录权限</span></span><br><span class=\"line\"><span class=\"attr\">    - include_empty:</span> <span class=\"literal\">True</span>   <span class=\"comment\">#同步空目录</span></span><br><span class=\"line\"><span class=\"attr\">    - clean:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#使用后minion与master保持一致</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">rsync</span> <span class=\"bullet\">-avh</span> <span class=\"string\">/etc/httpd/conf.d</span> <span class=\"string\">/srv/salt/base/files/</span></span><br></pre></td></tr></table></figure></p>\n<p><code>file.symlink</code> 建立软链接<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># cat /srv/salt/base/target_link.sls</span></span><br><span class=\"line\"><span class=\"meta-keyword\">/etc/</span>grub.cfg:</span><br><span class=\"line\">  file.symlink:</span><br><span class=\"line\">    - target: <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.sls target_link</span></span><br><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> cmd.run <span class=\"string\">\"ls -l /etc/grub.cfg\"</span></span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    lrwxrwxrwx <span class=\"number\">1</span> root root <span class=\"number\">14</span> May <span class=\"number\">15</span> <span class=\"number\">16</span>:<span class=\"number\">42</span> <span class=\"meta-keyword\">/etc/</span>grub.cfg -&gt; <span class=\"meta-keyword\">/etc/</span>grub2.cfg</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"service服务模块\"><a href=\"#service服务模块\" class=\"headerlink\" title=\"service服务模块\"></a>service服务模块</h3><p><a href=\"https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html\" target=\"_blank\" rel=\"noopener\">service模块官档</a><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span>   <span class=\"comment\">#服务名称</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#开机自启动</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span>    <span class=\"comment\">#允许重载配置文件，不写则是restart</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">或者这样写</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/base/service_httpd.sls</span></span><br><span class=\"line\"><span class=\"attr\">httpd:</span>   <span class=\"comment\">#即表示ID，又表示服务名</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"高级状态模块\"><a href=\"#高级状态模块\" class=\"headerlink\" title=\"高级状态模块\"></a>高级状态模块</h2><blockquote>\n<p>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 <code>top file</code><br>来进行管理。可以通过正则，<code>grain</code>模块，或分组名，来进行匹配，再下一级是要执行的<code>state</code>文件</p>\n</blockquote>\n<p>可以将我们的配置需求转换为<code>YAML</code>并在<code>Top file</code>文件中表示：</p>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-9098e5814f51b40c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt></p>\n<p><code>Top file</code>示例<br><figure class=\"highlight rsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base:</span><br><span class=\"line\">  <span class=\"string\">'*'</span>: <span class=\"meta\">#通过正则去匹配所有minion</span></span><br><span class=\"line\">    - app.nginx</span><br><span class=\"line\"></span><br><span class=\"line\">  webserver: <span class=\"meta\">#定义的分组名称</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: nodegroup</span><br><span class=\"line\">    - app.cron</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">'os:centos'</span>:  <span class=\"meta\">#通过grains模块匹配</span></span><br><span class=\"line\">    - <span class=\"built_in\">match</span>: grains</span><br><span class=\"line\">    - nginx</span><br></pre></td></tr></table></figure></p>\n<p><code>Top file</code> 高级状态的执行<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"LAMP架构案例\"><a href=\"#LAMP架构案例\" class=\"headerlink\" title=\"LAMP架构案例\"></a>LAMP架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br>1）环境准备，定义<code>file_roots</code>环境<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># vim /etc/salt/master</span></span><br><span class=\"line\"><span class=\"symbol\">file_roots:</span></span><br><span class=\"line\"><span class=\"symbol\">  base:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/base</span><br><span class=\"line\"><span class=\"symbol\">  dev:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/dev</span><br><span class=\"line\"><span class=\"symbol\">  prod:</span></span><br><span class=\"line\">    - <span class=\"meta-keyword\">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p>\n<p>2）创建对应环境目录<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/salt/prod/&#123;httpd,php,mysql,files&#125;</span><br></pre></td></tr></table></figure></p>\n<p>3）配置文件准备及测试文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/my.cnf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/httpd/conf/httpd.conf /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cp</span> /etc/php.ini  /srv/salt/prod/files/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;h1&gt;LAMP html&lt;/h1&gt;\"</span> &gt;&gt;/srv/salt/prod/files/index.html</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# echo</span> <span class=\"string\">\"&lt;?php phpinfo(); ?&gt;\"</span> &gt;&gt; /srv/salt/prod/files/index.php</span><br></pre></td></tr></table></figure></p>\n<p>4）编写<code>state sls</code>状态文件<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#httpd</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/httpd/init.sls</span><br><span class=\"line\">apache-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - httpd</span><br><span class=\"line\">      - httpd-tools</span><br><span class=\"line\"></span><br><span class=\"line\">apache-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/httpd/<span class=\"keyword\">conf</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">apache-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: httpd</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#php</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/php/init.sls</span><br><span class=\"line\">php-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - php</span><br><span class=\"line\">      - php-mysql</span><br><span class=\"line\">      - php-pdo</span><br><span class=\"line\">      - php-cli</span><br><span class=\"line\"></span><br><span class=\"line\">php-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/php.ini</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/php.ini</span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">#mysql</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/mysql/init.sls</span><br><span class=\"line\">mariadb-instal<span class=\"variable\">l:</span></span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkg<span class=\"variable\">s:</span></span><br><span class=\"line\">      - mariadb-server</span><br><span class=\"line\">      - mariadb</span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-confi<span class=\"variable\">g:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - name: /etc/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - <span class=\"keyword\">mode</span>: <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\">mariadb-service:</span><br><span class=\"line\">  service.runnin<span class=\"variable\">g:</span></span><br><span class=\"line\">    - name: mariadb</span><br><span class=\"line\">    - enable: True</span><br><span class=\"line\"></span><br><span class=\"line\">#测试文件</span><br><span class=\"line\">[root@salt-master ~]# <span class=\"keyword\">cat</span> /srv/salt/prod/testfile.sls</span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.htm<span class=\"variable\">l:</span></span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.html</span><br><span class=\"line\"></span><br><span class=\"line\">/var/www/html/<span class=\"built_in\">index</span>.php:</span><br><span class=\"line\">  <span class=\"keyword\">file</span>.managed:</span><br><span class=\"line\">    - <span class=\"keyword\">source</span>: <span class=\"keyword\">sal</span><span class=\"variable\">t:</span>//<span class=\"keyword\">files</span>/<span class=\"built_in\">index</span>.php</span><br></pre></td></tr></table></figure></p>\n<p>6）<code>topfile</code>文件编写<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">    - testfile</span><br></pre></td></tr></table></figure></p>\n<p>7）部署<code>LAMP</code>整体<code>state</code>文件查看<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">    │   ├── httpd.<span class=\"keyword\">conf</span></span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.html</span><br><span class=\"line\">    │   ├── <span class=\"built_in\">index</span>.php</span><br><span class=\"line\">    │   ├── my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── init.sls</span><br><span class=\"line\">    └── testfile.sls</span><br></pre></td></tr></table></figure></p>\n<p>8）执行<code>topfile</code><br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"States状态依赖\"><a href=\"#States状态依赖\" class=\"headerlink\" title=\"States状态依赖\"></a>States状态依赖</h2><p>通过上面的<code>lamp</code>可以看出已经可以使用<code>state</code>模块来定义<code>minion</code>的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用<code>requisites</code>来进行控制</p>\n<blockquote>\n<p>关系说明：<br>1、<code>require</code> 我依赖某个状态，我依赖谁<br>2、<code>require_in</code> 我被某个状态依赖，谁依赖我<br>3、<code>watch</code> 我关注某个状态，当状态发生改变，进行<code>restart</code>或者<code>reload</code>操作<br>4、<code>watch_in</code> 我被某个状态关注<br>5、<code>include</code> 我引用谁</p>\n</blockquote>\n<p>1）修改上面<code>lamp</code>状态间依赖关系<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#httpd</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/httpd/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">apache-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">httpd-tools</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">apache-install</span>   <span class=\"comment\">#表示上面apache-install执行成功，才能执行apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apache-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">apache-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/php/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">php-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-mysql</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-pdo</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">php-cli</span></span><br><span class=\"line\"><span class=\"attr\">    - reqiure_in:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">php-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#mysql</span></span><br><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/mysql/init.sls</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-install:</span></span><br><span class=\"line\">  <span class=\"string\">pkg.installed:</span></span><br><span class=\"line\"><span class=\"attr\">    - pkgs:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb-server</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">mariadb-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br></pre></td></tr></table></figure></p>\n<p>2）修改引用关系后<code>include</code><br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# tree /srv/salt/</span><br><span class=\"line\">/srv/salt/</span><br><span class=\"line\">├── base</span><br><span class=\"line\">│   └── top.sls</span><br><span class=\"line\">├── dev</span><br><span class=\"line\">└── prod</span><br><span class=\"line\">    ├── files</span><br><span class=\"line\">    │   ├── httpd.conf</span><br><span class=\"line\">    │   ├── index.html</span><br><span class=\"line\">    │   ├── index.php</span><br><span class=\"line\">    │   ├── my.cnf</span><br><span class=\"line\">    │   └── php.ini</span><br><span class=\"line\">    ├── httpd</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── lamp.sls</span><br><span class=\"line\">    ├── mysql</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    ├── php</span><br><span class=\"line\">    │   └── <span class=\"keyword\">init</span>.sls</span><br><span class=\"line\">    └── testfile.sls</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/prod/lamp.sls</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - httpd.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - php.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - mysql.<span class=\"keyword\">init</span></span><br><span class=\"line\">  - testfile</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"symbol\">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">'salt-minion*'</span>:</span><br><span class=\"line\">    - lamp</span><br></pre></td></tr></table></figure></p>\n<p>3）编写<code>SLS</code>技巧</p>\n<blockquote>\n<p>1、按照状态分类，如果单独使用，清晰明了<br>2、按照服务分类，可以被其它<code>SLS</code>引用</p>\n</blockquote>\n<h2 id=\"Jinja模板使用\"><a href=\"#Jinja模板使用\" class=\"headerlink\" title=\"Jinja模板使用\"></a>Jinja模板使用</h2><blockquote>\n<p>配置文件一般灵活多变，比如配置<code>apache</code>的<code>IP</code>地址或者端口<code>PORT</code>等，则可以动态传值。<br><a href=\"http://docs.jinkan.org/docs/jinja2/\" target=\"_blank\" rel=\"noopener\">Jinja官档</a><br><a href=\"https://docs.saltstack.com/en/latest/topics/jinja/index.html\" target=\"_blank\" rel=\"noopener\">salt jinja官档</a></p>\n</blockquote>\n<p><code>Jinja2</code> 模板包含变量和表达式，变量用 &#123;&#123; … &#125;&#125; 包围，表达式用 &#123;&#37; … &#37;&#125; 包围。变量使用示例：<br><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/base/var.sls </span><br><span class=\"line\">&#123;% set var= <span class=\"emphasis\">'hello world!'</span> %&#125;</span><br><span class=\"line\">test<span class=\"emphasis\">_var:</span></span><br><span class=\"line\"><span class=\"emphasis\">  cmd.run:</span></span><br><span class=\"line\"><span class=\"emphasis\">    - name: echo \"测试变量 &#123;&#123; var &#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"emphasis\"></span></span><br><span class=\"line\"><span class=\"emphasis\">[root@salt-master ~]# salt 'salt-minion01' state.sls var</span></span><br><span class=\"line\"><span class=\"emphasis\">salt-minion01:</span></span><br><span class=\"line\"><span class=\"emphasis\">----------</span></span><br><span class=\"line\"><span class=\"emphasis\">          ID: test_</span>var</span><br><span class=\"line\"><span class=\"code\">    Function: cmd.run</span></span><br><span class=\"line\"><span class=\"code\">        Name: echo \"测试变量 hello world!\"</span></span><br><span class=\"line\"><span class=\"code\">      Result: True</span></span><br><span class=\"line\"><span class=\"code\">     Comment: Command \"echo \"测试变量 hello world!\"\" run</span></span><br><span class=\"line\"><span class=\"code\">     Started: 14:50:58.302424</span></span><br><span class=\"line\"><span class=\"code\">    Duration: 12.358 ms</span></span><br><span class=\"line\"><span class=\"code\">     Changes:   </span></span><br><span class=\"line\"><span class=\"code\">              ----------</span></span><br><span class=\"line\"><span class=\"code\">              pid:</span></span><br><span class=\"line\"><span class=\"code\">                  22510</span></span><br><span class=\"line\"><span class=\"code\">              retcode:</span></span><br><span class=\"line\"><span class=\"code\">                  0</span></span><br><span class=\"line\"><span class=\"code\">              stderr:</span></span><br><span class=\"line\"><span class=\"code\">              stdout:</span></span><br><span class=\"line\"><span class=\"code\">                  测试变量 hello world!</span></span><br><span class=\"line\"></span><br><span class=\"line\">Summary for salt-minion01</span><br><span class=\"line\">------------</span><br><span class=\"line\">Succeeded: 1 (changed=1)</span><br><span class=\"line\">Failed:    0</span><br><span class=\"line\">------------</span><br><span class=\"line\">Total states run:     1</span><br><span class=\"line\">Total run time:  12.358 ms</span><br></pre></td></tr></table></figure></p>\n<p><code>jinja2</code> 常用变量<br>1、字符串类型<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> <span class=\"keyword\">var</span> = <span class=\"string\">'test'</span> %&#125;  <span class=\"meta\">#定义变量</span></span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">var</span> &#125;&#125;  <span class=\"meta\">#调用变量</span></span><br></pre></td></tr></table></figure></p>\n<p>2、列表类型<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% set <span class=\"keyword\">list</span> = [<span class=\"string\">'one'</span>, <span class=\"string\">'two'</span>, <span class=\"string\">'three'</span>] %&#125;</span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">list</span>[<span class=\"number\">1</span>] &#125;&#125;  <span class=\"comment\">#获取变量的第一个值</span></span><br></pre></td></tr></table></figure></p>\n<p>3、字典类型<br><figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">set</span> dict <span class=\"comment\">= &#123;</span><span class=\"comment\">'key1'</span><span class=\"comment\">:</span><span class=\"comment\">'value1'</span><span class=\"comment\">,</span> <span class=\"comment\">'key2'</span><span class=\"comment\">:</span><span class=\"comment\">'value2'</span><span class=\"comment\">&#125; %&#125;</span></span><br><span class=\"line\">&#123;&#123; dict[<span class=\"string\">'key1'</span>] &#125;&#125;  #获取<span class=\"string\">'key1'</span>的值</span><br></pre></td></tr></table></figure></p>\n<p>示例1：<code>Saltstack</code>使用<code>jinja</code>模块配置<code>apache</code>监听端口<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.告诉file状态模块，需要使用jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"comment\">#2.列出参数列表</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"comment\">#3.配置文件引用jinja模板</span></span><br><span class=\"line\"><span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例2：使用<code>grinas</code> 方式进行赋值<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#配置示例</span></span><br><span class=\"line\"><span class=\"attr\">apache-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/httpd/conf/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://files/httpd.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"attr\">      IPADDR:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改httpd.conf配置文件引用变量</span></span><br><span class=\"line\"><span class=\"string\">Listen</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">IPADDR</span> <span class=\"string\">&#125;&#125;:&#123;&#123;</span> <span class=\"string\">PORT</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>示例3：通过<code>jinja+grains</code>根据系统不同安装<code>apache</code><br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"comment\"># cat /srv/salt/base/httpd.sls</span></span><br><span class=\"line\"><span class=\"comment\">#根据grains获取的值判别系统后安装软件</span></span><br><span class=\"line\">httpd-<span class=\"keyword\">install</span>:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">&#123;% <span class=\"keyword\">if</span> grains[<span class=\"string\">'os'</span>] == <span class=\"string\">'CentOS'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: httpd</span><br><span class=\"line\">&#123;% elif grains[<span class=\"string\">'OS'</span>] == <span class=\"string\">'Debin'</span> %&#125;</span><br><span class=\"line\">    - <span class=\"keyword\">name</span>: apache2</span><br><span class=\"line\">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>\n"},{"title":"saltstack项目实战","date":"2019-05-21T07:43:05.000Z","copyright":true,"_content":"## 项目架构规划\n>后端web服务器使用`Nginx+Php`作为站点，通过`HAproxy`做负载均衡，`Keepalived`做高可用\n\n![架构规划图](https://upload-images.jianshu.io/upload_images/11763553-aee6d08ef5f58560.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n## 项目环境准备\n![环境准备](https://upload-images.jianshu.io/upload_images/11763553-44de6c7b5f253784.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n**说明：** 关闭防火墙、`selinux`、时间同步等\n`host`绑定\n```\n[root@salt-master ~]# cat /etc/hosts\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.1.30\tsalt-master\n192.168.1.31\tsalt-minion01\n192.168.1.32\tsalt-minion02\n192.168.1.33\tsalt-minion03\n192.168.1.34\tsalt-minion04\n\n[root@salt-master ~]# for i in `seq 4`; do scp /etc/hosts 192.168.1.3$i:/etc/hosts ; done\n```\n### 软件安装\n[参考地址](https://www.cnblogs.com/yanjieli/p/10864648.html)\n1）`Master`上软件安装\n```\n[root@salt-master ~]# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n[root@salt-master ~]# sed -i \"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\" /etc/yum.repos.d/salt-latest.repo\n[root@salt-master ~]# yum -y install salt-master\n[root@salt-master ~]# systemctl enable salt-master\n[root@salt-master ~]# systemctl start salt-master\n```\n2）`Minion`上软件安装并配置\n```\n# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n# yum -y install salt-minion\n# cp /etc/salt/minion{,.back}\n# sed -i '/#master: /c\\master: salt-master' /etc/salt/minion\n# systemctl enable salt-minion\n# systemctl start salt-minion\n```\n### Master上认证\n```\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nDenied Keys:\nUnaccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nRejected Keys:\n\n[root@salt-master ~]# salt-key -A -y\nThe following keys are going to be accepted:\nUnaccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nKey for minion salt-minion01 accepted.\nKey for minion salt-minion02 accepted.\nKey for minion salt-minion03 accepted.\nKey for minion salt-minion04 accepted.\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nDenied Keys:\nUnaccepted Keys:\nRejected Keys:\n\n[root@salt-master ~]# salt '*' test.ping\nsalt-minion01:\n    True\nsalt-minion02:\n    True\nsalt-minion03:\n    True\nsalt-minion04:\n    True\n```\n## Master上state编写\n### state环境设置\n>说明：该案例在`prod`环境下配置，在`prod`下面创建了一个`modules`的目录，所有的安装配置都放在这个目录下面了，里面分别又对应创建了对应的软件目录，每个软件目录下面的`files`目录用来存放的是软件包或者配置文件模板\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  test:\n    - /srv/salt/test\n  prod:\n    - /srv/salt/prod\n  dev:\n    - /srv/salt/dev\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# mkdir -p /srv/salt/{base,test,prod,dev}\n\n[root@salt-master ~]# mkdir -p /srv/salt/prod/modules/{nginx,php,mysql,haproxy,keepalived,lnmp}/files\n[root@salt-master ~]# mkdir /srv/salt/prod/modules/user\n[root@salt-master ~]# tree /srv/salt/prod/modules/\n/srv/salt/prod/modules/\n├── haproxy\n│   └── files\n├── keepalived\n│   └── files\n├── lnmp\n│   └── files\n├── mysql\n│   └── files\n├── nginx\n│   └── files\n├── php\n│   └── files\n└── user\n\n13 directories, 0 files\n```\n### sls文件编写\n#### pkg基础包\n安装源码编译所需要用到的基础软件包\n```\n[root@salt-master ~]# cat /srv/salt/prod/modules/pkg.sls \npkg-install:\n  pkg.installed:\n    - pkgs:\n      - gcc\n      - gcc-c++\n      - make\n      - autoconf\n      - glibc\n      - glibc-devel\n      - glib2\n      - glib2-devel\n      - pcre\n      - pcre-devel\n      - zlib\n      - zlib-devel\n      - openssl\n      - openssl-devel\n      - libpng\n      - libpng-devel\n      - freetype\n      - freetype-devel\n      - libxml2\n      - libxml2-devel\n      - bzip2\n      - bzip2-devel\n      - ncurses\n      - curl\n      - gdbm-devel\n      - libXpm-devel\n      - libX11-devel\n      - gd-devel\n      - gmp-devel\n      - readline-devel\n      - libxslt-devel\n      - expat-devel\n      - xmlrpc-c\n      - xmlrpc-c-devel\n```\n#### useradd\n创建网站运行用户\n```\n[root@salt-master ~]# cat /srv/salt/prod/modules/user/www.sls \nwww-user-group:\n  group.present:\n    - name: www\n    - gid: 2000\n\n  user.present:\n    - name: www\n    - fullname: www\n    - shell: /sbin/nologin\n    - uid: 2000\n    - gid: 2000\n    - unless: id www\n```\n#### nginx\n1）软件包准备，及配置文件模板，启动文件模板\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/nginx/\n[root@salt-master nginx]# tree \n.\n├── files\n│   ├── nginx-1.12.2.tar.gz\n│   ├── nginx-1.16.0.tar.gz\n│   ├── nginx.conf.template\n│   └── nginx.service.template\n├── install.sls\n└── service.sls\n\n1 directory, 6 files\n```\n2）`install.sls` \n```\n[root@salt-master nginx]# cat install.sls \n{% set nginx_version = \"1.16.0\"%}\ninclude:\n  - modules.pkg\n  - modules.user.www\n\nnginx-install:\n  file.managed:\n    - name: /usr/local/src/nginx-{{ nginx_version }}.tar.gz\n    - source: salt://modules/nginx/files/nginx-{{ nginx_version }}.tar.gz\n    - user: root\n    - group: root\n    - mode: 644\n\n  cmd.run:\n    - name: cd /usr/local/src/ && tar xf nginx-{{ nginx_version }}.tar.gz && cd nginx-{{ nginx_version }} && ./configure --prefix=/usr/local/nginx-{{ nginx_version }} --user=root --group=root --with-http_ssl_module --with-stream --with-http_stub_status_module --with-file-aio --with-http_gzip_static_module && make && make install && ln -s /usr/local/nginx-{{ nginx_version }} /usr/local/nginx\n    - unless: test -d /usr/local/nginx-{{ nginx_version }} && test -L /usr/local/nginx\n    - require:\n      - file: nginx-install\n      - pkg: pkg-install\n```\n3）`service.sls`\n```\n[root@salt-master nginx]# cat service.sls \n#引入nginx安装sls\ninclude:\n  - modules.nginx.install\n\n#添加systemctl\nnginx-init:\n  file.managed:\n    - name: /usr/lib/systemd/system/nginx.service\n    - source: salt://modules/nginx/files/nginx.service.template\n    - user: root\n    - group: root\n    - mode: 755\n    - unless: test -f /usr/lib/systemd/system/nginx.service\n  cmd.run:\n    - name: systemctl daemon-reload\n    - require:\n      - file: nginx-init\n\n#配置文件\n/usr/local/nginx/conf/nginx.conf:\n  file.managed:\n    - source: salt://modules/nginx/files/nginx.conf.template\n    - user: root\n    - group: root\n    - mode: 644\n\n#启动nginx\nnginx-service:\n  file.directory:\n    - name: /usr/local/nginx/conf/conf.d\n    - user: root\n    - group: root\n    - mode: 755\n    - require:\n      - cmd: nginx-install\n  service.running:\n    - name: nginx\n    - enable: True\n    - reload: True\n    - require:\n      - cmd: nginx-init\n    - watch:\n      - file: /usr/local/nginx/conf/nginx.conf\n      - file: nginx-service\n```\n#### php\n1）软件包准备，及配置文件模板，启动文件模板\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/php/\n[root@salt-master php]# tree\n.\n├── files\n│   ├── php-5.6.40.tar.gz\n│   ├── php-fpm.conf.template\n│   ├── php-fpm.service.template\n│   ├── php-fpm.template\n│   └── php.ini.template\n├── install.sls\n└── service.sls\n\n1 directory, 7 files\n```\n2）`install.sls`\n```\n[root@salt-master php]# cat install.sls \n{% set php_version = \"5.6.40\" %}\ninclude:\n  - modules.pkg\n\nphp-install:\n  file.managed:\n    - name: /usr/local/src/php-{{ php_version }}.tar.gz\n    - source: salt://modules/php/files/php-{{ php_version }}.tar.gz\n    - user: root\n    - group: root\n    - mode: 644\n\n  cmd.run:\n    - name: cd /usr/local/src/ && tar xf php-{{ php_version }}.tar.gz && cd php-{{ php_version }} && ./configure --prefix=/usr/local/php-{{ php_version }} --with-curl --with-freetype-dir --with-gd --with-gettext --with-iconv-dir --with-jpeg-dir --with-kerberos --with-libdir=lib64 --with-libxml-dir --with-mysql --with-mysqli --with-openssl --with-pcre-regex --with-pdo-mysql --with-dpo-sqlite --with-pear --with-png-dir --with-openssl --with-xmlrpc --with-xsl --with-zlib --enable-fpm --enable-bcmath --enable-libxml --enable-inline-optimization --enable-gd-native-ttf --enable-mbregex --enable-mbstring --enable-opcache --enable-pcntl --enable-shmop --enable-soap --enable-sockets --enable-sysvsem --enable-xml --enable-zip && make && make install && ln -s /usr/local/php-{{ php_version }} /usr/local/php\n    - unless: test -d /usr/local/php-{{ php_version }} && test -L /usr/local/php\n    - require:\n      - file: php-install\n      - pkg: pkg-install\n```\n3）`service.sls`\n```\n[root@salt-master php]# cat service.sls \n#引入php安装的sls\ninclude:\n  - modules.php.install\n\n#php-ini配置文件配置\nphp-ini:\n  file.managed:\n    - name: /usr/local/php/etc/php.ini\n    - source: salt://modules/php/files/php.ini.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n  cmd.run:\n    - name: ln -s /usr/local/php/etc/php.ini /etc/php.ini\n    - unless: test -L /etc/php.ini\n    - require:\n      - file: php-ini\n\n#php-fpm配置文件配置\nphp-fpm:\n  file.managed:\n    - name: /usr/local/php/etc/php-fpm.conf\n    - source: salt://modules/php/files/php-fpm.conf.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n  cmd.run:\n    - name: ln -s /usr/local/php/etc/php-fpm.conf /etc/php-fpm.conf\n    - unless: test -L /etc/php-fpm.conf\n    - require:\n      - file: php-fpm\n\n#加入system启动\nphp-systemd:\n  file.managed:\n    - name: /usr/lib/systemd/system/php-fpm.service\n    - source: salt://modules/php/files/php-fpm.service.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n\n#加入/etc/init.d/启动\nphp-init:\n  file.managed:\n    - name: /etc/init.d/php-fpm\n    - source: salt://modules/php/files/php-fpm.template\n    - user: root\n    - group: root\n    - mode: 755\n    - require:\n      - cmd: php-install\n\n#启动php-fpm\nphp-service:\n  service.running:\n    - name: php-fpm\n    - enable: True\n    - require:\n      - file: php-systemd\n    - watch:\n      - file: php-fpm\n      - file: php-ini\n```\n#### mysql\n1）配置文件模板准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/mysql/\n[root@salt-master mysql]# tree\n.\n├── files\n│   └── my.cnf\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master mysql]# cat install.sls \nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n```\n3）`service.sls`\n```\n[root@salt-master mysql]# cat service.sls \n#引入mysql安装的sls\ninclude:\n  - modules.mysql.install\n\n#my.cnf配置文件\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://modules/mysql/files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: mariadb-install\n\n#启动mariadb\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n    - watch:\n      - file: mariadb-config\n    - require:\n      - pkg: mariadb-install\n      - file: mariadb-config\n```\n#### lnmp\n1）准备测试文件`php info` 和`nginx`虚拟主机配置文件\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/lnmp/\n[root@salt-master lnmp]# tree\n.\n├── files\n│   ├── index.php\n│   └── www.conf\n└── www.sls\n\n1 directory, 3 files\n```\n2）`www.sls`\n```\n[root@salt-master lnmp]# cat www.sls \n#引入nginx、php、mysql的安装\ninclude:\n  - modules.nginx.service\n  - modules.php.service\n  - modules.mysql.service\n\n#虚拟主机web站点目录创建\nweb-www:\n  file.directory:\n    - name: /opt/www\n    - user: www\n    - group: www\n    - mode: 755\n\n#虚拟主机配置文件配置\nweb-www-conf:\n  file.managed:\n    - name: /usr/local/nginx/conf/conf.d/www.conf\n    - source: salt://modules/lnmp/files/www.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - file: web-www\n    - watch_in:\n      - service: nginx-service\n    - template: jinja\n    - defaults:\n      PORT: 80\n      IPADDR: {{ grains['fqdn_ip4'][0] }}\n\n#phpinfo测试文件准备\nweb-index:\n  file.managed:\n    - name: /opt/www/index.php\n    - source: salt://modules/lnmp/files/index.php\n    - user: www\n    - group: www\n    - mode: 644\n```\n#### 测试lnmp是否OK\n1）`Top file`编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n```\n2）执行高级状态\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n3）访问测试\n![http://192.168.1.31](https://upload-images.jianshu.io/upload_images/11763553-8408fa3d53913156.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n![http://192.168.1.32](https://upload-images.jianshu.io/upload_images/11763553-2a3378a0836eb128.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n#### haproxy\n1）配置文件准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/haproxy/\n[root@salt-master haproxy]# tree\n.\n├── files\n│   └── haproxy.cfg\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master haproxy]# cat install.sls \nhaproxy-install:\n  pkg.installed:\n    - name: haproxy\n```\n3）`service.sls`\n```\n[root@salt-master haproxy]# cat service.sls \n#引入haproxy安装的sls\ninclude:\n  - modules.haproxy.install\n\n#配置文件\nhaproxy-config:\n  file.managed:\n    - name: /etc/haproxy/haproxy.cfg\n    - source: salt://modules/haproxy/files/haproxy.cfg\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: haproxy-install\n\n#启动haproxy\nhaproxy-service:\n  service.running:\n    - name: haproxy\n    - enable: True\n    - require:\n      - pkg: haproxy-install\n      - file: haproxy-config\n    - watch:\n      - file: haproxy-config\n```\n#### keepalived\n1）配置文件准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/keepalived/\n[root@salt-master keepalived]# tree\n.\n├── files\n│   └── keepalived.conf\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master keepalived]# cat install.sls \nkeepalived-install:\n  pkg.installed:\n    - name: keepalived\n```\n3）`service.sls`\n```\n[root@salt-master keepalived]# cat service.sls \n#引入keepalived安装的sls\ninclude:\n  - modules.keepalived.install\n\n#keepalived配置文件\nkeepalived-config:\n  file.managed:\n    - name: /etc/keepalived/keepalived.conf\n    - source: salt://modules/keepalived/files/keepalived.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: keepalived-install\n    - template: jinja\n    - defaults:\n{% if grains['fqdn'] == \"salt-minion01\" %}\n      ROUTER_ID: saltstack01\n      STATE: MASTER\n      PRIORITY: 150\n{% elif grains['fqdn'] == \"salt-minion02\" %}\n      ROUTER_ID: saltstack02\n      STATE: BACKUP\n      PRIORITY: 100\n{% endif %}\n\n#启动keepalived\nkeepalived-service:\n  service.running:\n    - name: keepalived\n    - enable: True\n    - require:\n      - pkg: keepalived-install\n      - file: keepalived-config\n    - watch:\n      - file: keepalived-config\n```\n### 整体部署\n1）top file 编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n\n  \"salt-minion0[1-2]\":\n    - modules.haproxy.service\n    - modules.keepalived.service\n```\n2）高级状态执行\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n3）测试\n访问`192.168.1.31`和`192.168.1.32`的状态页\n![http://192.168.1.31:1314/status](https://upload-images.jianshu.io/upload_images/11763553-dbb464867bd87a4c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n![http://192.168.1.32:1314/status](https://upload-images.jianshu.io/upload_images/11763553-259e918d1d42933d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n访问VIP`192.168.1.100`\n![http://192.168.1.100](https://upload-images.jianshu.io/upload_images/11763553-94dfbc9d07974a44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n通过上面测试可看到可以成功访问`lnmp`站点，并且`haproxy`也`ok`。访问所有四台服务器都可以得到`phpinfo`页面，而在生产环境中，我们只是对外提供`vip`即可。\n## 项目总结\n1）整体环境查看\n```\n[root@salt-master ~]# tree /srv/salt/prod/modules/\n/srv/salt/prod/modules/\n├── haproxy\n│   ├── files\n│   │   └── haproxy.cfg\n│   ├── install.sls\n│   └── service.sls\n├── keepalived\n│   ├── files\n│   │   └── keepalived.conf\n│   ├── install.sls\n│   └── service.sls\n├── lnmp\n│   ├── files\n│   │   ├── index.php\n│   │   └── www.conf\n│   └── www.sls\n├── mysql\n│   ├── files\n│   │   └── my.cnf\n│   ├── install.sls\n│   └── service.sls\n├── nginx\n│   ├── files\n│   │   ├── nginx-1.12.2.tar.gz\n│   │   ├── nginx-1.16.0.tar.gz\n│   │   ├── nginx.conf.template\n│   │   └── nginx.service.template\n│   ├── install.sls\n│   └── service.sls\n├── php\n│   ├── files\n│   │   ├── php-5.6.40.tar.gz\n│   │   ├── php-fpm.conf.template\n│   │   ├── php-fpm.service.template\n│   │   ├── php-fpm.template\n│   │   └── php.ini.template\n│   ├── install.sls\n│   └── service.sls\n├── pkg.sls\n└── user\n    └── www.sls\n\n13 directories, 27 files\n```\n2）如果需要在某台服务器上面单独部署某一部分，参考以下写法：\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \n#部署lnmp及haproxy+keepalived\nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n\n  \"salt-minion0[1-2]\":\n    - modules.haproxy.service\n    - modules.keepalived.service\n\n#单实例操作说明：\nprod:\n  \"salt-minion04\":\n    - modules.nginx.service\t#单独安装nginx时\n    - modules.mysql.service     #单独安装mysql时\n    - modules.php.service       #单独安装php时\n    - modules.keepalived.service  #单独安装keepalived时\n    - modules.haproxy.service   #单独安装haproxy时\n\n  \"salt-minion03\":\n    - modules.lnmp.www     #单独部署lnmp环境时\n```\n","source":"_posts/saltstack项目实战.md","raw":"---\ntitle: saltstack项目实战\ndate: 2019-05-21 15:43:05\ntags: Saltstack\ncategories: Saltstack\ncopyright: true\n---\n## 项目架构规划\n>后端web服务器使用`Nginx+Php`作为站点，通过`HAproxy`做负载均衡，`Keepalived`做高可用\n\n![架构规划图](https://upload-images.jianshu.io/upload_images/11763553-aee6d08ef5f58560.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n## 项目环境准备\n![环境准备](https://upload-images.jianshu.io/upload_images/11763553-44de6c7b5f253784.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n**说明：** 关闭防火墙、`selinux`、时间同步等\n`host`绑定\n```\n[root@salt-master ~]# cat /etc/hosts\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.1.30\tsalt-master\n192.168.1.31\tsalt-minion01\n192.168.1.32\tsalt-minion02\n192.168.1.33\tsalt-minion03\n192.168.1.34\tsalt-minion04\n\n[root@salt-master ~]# for i in `seq 4`; do scp /etc/hosts 192.168.1.3$i:/etc/hosts ; done\n```\n### 软件安装\n[参考地址](https://www.cnblogs.com/yanjieli/p/10864648.html)\n1）`Master`上软件安装\n```\n[root@salt-master ~]# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n[root@salt-master ~]# sed -i \"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\" /etc/yum.repos.d/salt-latest.repo\n[root@salt-master ~]# yum -y install salt-master\n[root@salt-master ~]# systemctl enable salt-master\n[root@salt-master ~]# systemctl start salt-master\n```\n2）`Minion`上软件安装并配置\n```\n# yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm\n# yum -y install salt-minion\n# cp /etc/salt/minion{,.back}\n# sed -i '/#master: /c\\master: salt-master' /etc/salt/minion\n# systemctl enable salt-minion\n# systemctl start salt-minion\n```\n### Master上认证\n```\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nDenied Keys:\nUnaccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nRejected Keys:\n\n[root@salt-master ~]# salt-key -A -y\nThe following keys are going to be accepted:\nUnaccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nKey for minion salt-minion01 accepted.\nKey for minion salt-minion02 accepted.\nKey for minion salt-minion03 accepted.\nKey for minion salt-minion04 accepted.\n[root@salt-master ~]# salt-key -L \nAccepted Keys:\nsalt-minion01\nsalt-minion02\nsalt-minion03\nsalt-minion04\nDenied Keys:\nUnaccepted Keys:\nRejected Keys:\n\n[root@salt-master ~]# salt '*' test.ping\nsalt-minion01:\n    True\nsalt-minion02:\n    True\nsalt-minion03:\n    True\nsalt-minion04:\n    True\n```\n## Master上state编写\n### state环境设置\n>说明：该案例在`prod`环境下配置，在`prod`下面创建了一个`modules`的目录，所有的安装配置都放在这个目录下面了，里面分别又对应创建了对应的软件目录，每个软件目录下面的`files`目录用来存放的是软件包或者配置文件模板\n```\n[root@salt-master ~]# vim /etc/salt/master\nfile_roots:\n  base:\n    - /srv/salt/base\n  test:\n    - /srv/salt/test\n  prod:\n    - /srv/salt/prod\n  dev:\n    - /srv/salt/dev\n[root@salt-master ~]# systemctl restart salt-master\n[root@salt-master ~]# mkdir -p /srv/salt/{base,test,prod,dev}\n\n[root@salt-master ~]# mkdir -p /srv/salt/prod/modules/{nginx,php,mysql,haproxy,keepalived,lnmp}/files\n[root@salt-master ~]# mkdir /srv/salt/prod/modules/user\n[root@salt-master ~]# tree /srv/salt/prod/modules/\n/srv/salt/prod/modules/\n├── haproxy\n│   └── files\n├── keepalived\n│   └── files\n├── lnmp\n│   └── files\n├── mysql\n│   └── files\n├── nginx\n│   └── files\n├── php\n│   └── files\n└── user\n\n13 directories, 0 files\n```\n### sls文件编写\n#### pkg基础包\n安装源码编译所需要用到的基础软件包\n```\n[root@salt-master ~]# cat /srv/salt/prod/modules/pkg.sls \npkg-install:\n  pkg.installed:\n    - pkgs:\n      - gcc\n      - gcc-c++\n      - make\n      - autoconf\n      - glibc\n      - glibc-devel\n      - glib2\n      - glib2-devel\n      - pcre\n      - pcre-devel\n      - zlib\n      - zlib-devel\n      - openssl\n      - openssl-devel\n      - libpng\n      - libpng-devel\n      - freetype\n      - freetype-devel\n      - libxml2\n      - libxml2-devel\n      - bzip2\n      - bzip2-devel\n      - ncurses\n      - curl\n      - gdbm-devel\n      - libXpm-devel\n      - libX11-devel\n      - gd-devel\n      - gmp-devel\n      - readline-devel\n      - libxslt-devel\n      - expat-devel\n      - xmlrpc-c\n      - xmlrpc-c-devel\n```\n#### useradd\n创建网站运行用户\n```\n[root@salt-master ~]# cat /srv/salt/prod/modules/user/www.sls \nwww-user-group:\n  group.present:\n    - name: www\n    - gid: 2000\n\n  user.present:\n    - name: www\n    - fullname: www\n    - shell: /sbin/nologin\n    - uid: 2000\n    - gid: 2000\n    - unless: id www\n```\n#### nginx\n1）软件包准备，及配置文件模板，启动文件模板\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/nginx/\n[root@salt-master nginx]# tree \n.\n├── files\n│   ├── nginx-1.12.2.tar.gz\n│   ├── nginx-1.16.0.tar.gz\n│   ├── nginx.conf.template\n│   └── nginx.service.template\n├── install.sls\n└── service.sls\n\n1 directory, 6 files\n```\n2）`install.sls` \n```\n[root@salt-master nginx]# cat install.sls \n{% set nginx_version = \"1.16.0\"%}\ninclude:\n  - modules.pkg\n  - modules.user.www\n\nnginx-install:\n  file.managed:\n    - name: /usr/local/src/nginx-{{ nginx_version }}.tar.gz\n    - source: salt://modules/nginx/files/nginx-{{ nginx_version }}.tar.gz\n    - user: root\n    - group: root\n    - mode: 644\n\n  cmd.run:\n    - name: cd /usr/local/src/ && tar xf nginx-{{ nginx_version }}.tar.gz && cd nginx-{{ nginx_version }} && ./configure --prefix=/usr/local/nginx-{{ nginx_version }} --user=root --group=root --with-http_ssl_module --with-stream --with-http_stub_status_module --with-file-aio --with-http_gzip_static_module && make && make install && ln -s /usr/local/nginx-{{ nginx_version }} /usr/local/nginx\n    - unless: test -d /usr/local/nginx-{{ nginx_version }} && test -L /usr/local/nginx\n    - require:\n      - file: nginx-install\n      - pkg: pkg-install\n```\n3）`service.sls`\n```\n[root@salt-master nginx]# cat service.sls \n#引入nginx安装sls\ninclude:\n  - modules.nginx.install\n\n#添加systemctl\nnginx-init:\n  file.managed:\n    - name: /usr/lib/systemd/system/nginx.service\n    - source: salt://modules/nginx/files/nginx.service.template\n    - user: root\n    - group: root\n    - mode: 755\n    - unless: test -f /usr/lib/systemd/system/nginx.service\n  cmd.run:\n    - name: systemctl daemon-reload\n    - require:\n      - file: nginx-init\n\n#配置文件\n/usr/local/nginx/conf/nginx.conf:\n  file.managed:\n    - source: salt://modules/nginx/files/nginx.conf.template\n    - user: root\n    - group: root\n    - mode: 644\n\n#启动nginx\nnginx-service:\n  file.directory:\n    - name: /usr/local/nginx/conf/conf.d\n    - user: root\n    - group: root\n    - mode: 755\n    - require:\n      - cmd: nginx-install\n  service.running:\n    - name: nginx\n    - enable: True\n    - reload: True\n    - require:\n      - cmd: nginx-init\n    - watch:\n      - file: /usr/local/nginx/conf/nginx.conf\n      - file: nginx-service\n```\n#### php\n1）软件包准备，及配置文件模板，启动文件模板\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/php/\n[root@salt-master php]# tree\n.\n├── files\n│   ├── php-5.6.40.tar.gz\n│   ├── php-fpm.conf.template\n│   ├── php-fpm.service.template\n│   ├── php-fpm.template\n│   └── php.ini.template\n├── install.sls\n└── service.sls\n\n1 directory, 7 files\n```\n2）`install.sls`\n```\n[root@salt-master php]# cat install.sls \n{% set php_version = \"5.6.40\" %}\ninclude:\n  - modules.pkg\n\nphp-install:\n  file.managed:\n    - name: /usr/local/src/php-{{ php_version }}.tar.gz\n    - source: salt://modules/php/files/php-{{ php_version }}.tar.gz\n    - user: root\n    - group: root\n    - mode: 644\n\n  cmd.run:\n    - name: cd /usr/local/src/ && tar xf php-{{ php_version }}.tar.gz && cd php-{{ php_version }} && ./configure --prefix=/usr/local/php-{{ php_version }} --with-curl --with-freetype-dir --with-gd --with-gettext --with-iconv-dir --with-jpeg-dir --with-kerberos --with-libdir=lib64 --with-libxml-dir --with-mysql --with-mysqli --with-openssl --with-pcre-regex --with-pdo-mysql --with-dpo-sqlite --with-pear --with-png-dir --with-openssl --with-xmlrpc --with-xsl --with-zlib --enable-fpm --enable-bcmath --enable-libxml --enable-inline-optimization --enable-gd-native-ttf --enable-mbregex --enable-mbstring --enable-opcache --enable-pcntl --enable-shmop --enable-soap --enable-sockets --enable-sysvsem --enable-xml --enable-zip && make && make install && ln -s /usr/local/php-{{ php_version }} /usr/local/php\n    - unless: test -d /usr/local/php-{{ php_version }} && test -L /usr/local/php\n    - require:\n      - file: php-install\n      - pkg: pkg-install\n```\n3）`service.sls`\n```\n[root@salt-master php]# cat service.sls \n#引入php安装的sls\ninclude:\n  - modules.php.install\n\n#php-ini配置文件配置\nphp-ini:\n  file.managed:\n    - name: /usr/local/php/etc/php.ini\n    - source: salt://modules/php/files/php.ini.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n  cmd.run:\n    - name: ln -s /usr/local/php/etc/php.ini /etc/php.ini\n    - unless: test -L /etc/php.ini\n    - require:\n      - file: php-ini\n\n#php-fpm配置文件配置\nphp-fpm:\n  file.managed:\n    - name: /usr/local/php/etc/php-fpm.conf\n    - source: salt://modules/php/files/php-fpm.conf.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n  cmd.run:\n    - name: ln -s /usr/local/php/etc/php-fpm.conf /etc/php-fpm.conf\n    - unless: test -L /etc/php-fpm.conf\n    - require:\n      - file: php-fpm\n\n#加入system启动\nphp-systemd:\n  file.managed:\n    - name: /usr/lib/systemd/system/php-fpm.service\n    - source: salt://modules/php/files/php-fpm.service.template\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - cmd: php-install\n\n#加入/etc/init.d/启动\nphp-init:\n  file.managed:\n    - name: /etc/init.d/php-fpm\n    - source: salt://modules/php/files/php-fpm.template\n    - user: root\n    - group: root\n    - mode: 755\n    - require:\n      - cmd: php-install\n\n#启动php-fpm\nphp-service:\n  service.running:\n    - name: php-fpm\n    - enable: True\n    - require:\n      - file: php-systemd\n    - watch:\n      - file: php-fpm\n      - file: php-ini\n```\n#### mysql\n1）配置文件模板准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/mysql/\n[root@salt-master mysql]# tree\n.\n├── files\n│   └── my.cnf\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master mysql]# cat install.sls \nmariadb-install:\n  pkg.installed:\n    - pkgs:\n      - mariadb-server\n      - mariadb\n```\n3）`service.sls`\n```\n[root@salt-master mysql]# cat service.sls \n#引入mysql安装的sls\ninclude:\n  - modules.mysql.install\n\n#my.cnf配置文件\nmariadb-config:\n  file.managed:\n    - name: /etc/my.cnf\n    - source: salt://modules/mysql/files/my.cnf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: mariadb-install\n\n#启动mariadb\nmariadb-service:\n  service.running:\n    - name: mariadb\n    - enable: True\n    - watch:\n      - file: mariadb-config\n    - require:\n      - pkg: mariadb-install\n      - file: mariadb-config\n```\n#### lnmp\n1）准备测试文件`php info` 和`nginx`虚拟主机配置文件\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/lnmp/\n[root@salt-master lnmp]# tree\n.\n├── files\n│   ├── index.php\n│   └── www.conf\n└── www.sls\n\n1 directory, 3 files\n```\n2）`www.sls`\n```\n[root@salt-master lnmp]# cat www.sls \n#引入nginx、php、mysql的安装\ninclude:\n  - modules.nginx.service\n  - modules.php.service\n  - modules.mysql.service\n\n#虚拟主机web站点目录创建\nweb-www:\n  file.directory:\n    - name: /opt/www\n    - user: www\n    - group: www\n    - mode: 755\n\n#虚拟主机配置文件配置\nweb-www-conf:\n  file.managed:\n    - name: /usr/local/nginx/conf/conf.d/www.conf\n    - source: salt://modules/lnmp/files/www.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - file: web-www\n    - watch_in:\n      - service: nginx-service\n    - template: jinja\n    - defaults:\n      PORT: 80\n      IPADDR: {{ grains['fqdn_ip4'][0] }}\n\n#phpinfo测试文件准备\nweb-index:\n  file.managed:\n    - name: /opt/www/index.php\n    - source: salt://modules/lnmp/files/index.php\n    - user: www\n    - group: www\n    - mode: 644\n```\n#### 测试lnmp是否OK\n1）`Top file`编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n```\n2）执行高级状态\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n3）访问测试\n![http://192.168.1.31](https://upload-images.jianshu.io/upload_images/11763553-8408fa3d53913156.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n![http://192.168.1.32](https://upload-images.jianshu.io/upload_images/11763553-2a3378a0836eb128.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n#### haproxy\n1）配置文件准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/haproxy/\n[root@salt-master haproxy]# tree\n.\n├── files\n│   └── haproxy.cfg\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master haproxy]# cat install.sls \nhaproxy-install:\n  pkg.installed:\n    - name: haproxy\n```\n3）`service.sls`\n```\n[root@salt-master haproxy]# cat service.sls \n#引入haproxy安装的sls\ninclude:\n  - modules.haproxy.install\n\n#配置文件\nhaproxy-config:\n  file.managed:\n    - name: /etc/haproxy/haproxy.cfg\n    - source: salt://modules/haproxy/files/haproxy.cfg\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: haproxy-install\n\n#启动haproxy\nhaproxy-service:\n  service.running:\n    - name: haproxy\n    - enable: True\n    - require:\n      - pkg: haproxy-install\n      - file: haproxy-config\n    - watch:\n      - file: haproxy-config\n```\n#### keepalived\n1）配置文件准备\n```\n[root@salt-master ~]# cd /srv/salt/prod/modules/keepalived/\n[root@salt-master keepalived]# tree\n.\n├── files\n│   └── keepalived.conf\n├── install.sls\n└── service.sls\n\n1 directory, 3 files\n```\n2）`install.sls`\n```\n[root@salt-master keepalived]# cat install.sls \nkeepalived-install:\n  pkg.installed:\n    - name: keepalived\n```\n3）`service.sls`\n```\n[root@salt-master keepalived]# cat service.sls \n#引入keepalived安装的sls\ninclude:\n  - modules.keepalived.install\n\n#keepalived配置文件\nkeepalived-config:\n  file.managed:\n    - name: /etc/keepalived/keepalived.conf\n    - source: salt://modules/keepalived/files/keepalived.conf\n    - user: root\n    - group: root\n    - mode: 644\n    - require:\n      - pkg: keepalived-install\n    - template: jinja\n    - defaults:\n{% if grains['fqdn'] == \"salt-minion01\" %}\n      ROUTER_ID: saltstack01\n      STATE: MASTER\n      PRIORITY: 150\n{% elif grains['fqdn'] == \"salt-minion02\" %}\n      ROUTER_ID: saltstack02\n      STATE: BACKUP\n      PRIORITY: 100\n{% endif %}\n\n#启动keepalived\nkeepalived-service:\n  service.running:\n    - name: keepalived\n    - enable: True\n    - require:\n      - pkg: keepalived-install\n      - file: keepalived-config\n    - watch:\n      - file: keepalived-config\n```\n### 整体部署\n1）top file 编写\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n\n  \"salt-minion0[1-2]\":\n    - modules.haproxy.service\n    - modules.keepalived.service\n```\n2）高级状态执行\n```\n[root@salt-master ~]# salt '*' state.highstate\n```\n3）测试\n访问`192.168.1.31`和`192.168.1.32`的状态页\n![http://192.168.1.31:1314/status](https://upload-images.jianshu.io/upload_images/11763553-dbb464867bd87a4c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n![http://192.168.1.32:1314/status](https://upload-images.jianshu.io/upload_images/11763553-259e918d1d42933d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n访问VIP`192.168.1.100`\n![http://192.168.1.100](https://upload-images.jianshu.io/upload_images/11763553-94dfbc9d07974a44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n通过上面测试可看到可以成功访问`lnmp`站点，并且`haproxy`也`ok`。访问所有四台服务器都可以得到`phpinfo`页面，而在生产环境中，我们只是对外提供`vip`即可。\n## 项目总结\n1）整体环境查看\n```\n[root@salt-master ~]# tree /srv/salt/prod/modules/\n/srv/salt/prod/modules/\n├── haproxy\n│   ├── files\n│   │   └── haproxy.cfg\n│   ├── install.sls\n│   └── service.sls\n├── keepalived\n│   ├── files\n│   │   └── keepalived.conf\n│   ├── install.sls\n│   └── service.sls\n├── lnmp\n│   ├── files\n│   │   ├── index.php\n│   │   └── www.conf\n│   └── www.sls\n├── mysql\n│   ├── files\n│   │   └── my.cnf\n│   ├── install.sls\n│   └── service.sls\n├── nginx\n│   ├── files\n│   │   ├── nginx-1.12.2.tar.gz\n│   │   ├── nginx-1.16.0.tar.gz\n│   │   ├── nginx.conf.template\n│   │   └── nginx.service.template\n│   ├── install.sls\n│   └── service.sls\n├── php\n│   ├── files\n│   │   ├── php-5.6.40.tar.gz\n│   │   ├── php-fpm.conf.template\n│   │   ├── php-fpm.service.template\n│   │   ├── php-fpm.template\n│   │   └── php.ini.template\n│   ├── install.sls\n│   └── service.sls\n├── pkg.sls\n└── user\n    └── www.sls\n\n13 directories, 27 files\n```\n2）如果需要在某台服务器上面单独部署某一部分，参考以下写法：\n```\n[root@salt-master ~]# cat /srv/salt/base/top.sls \n#部署lnmp及haproxy+keepalived\nprod:\n  \"salt-minion0[3-4]\":\n    - modules.lnmp.www\n\n  \"salt-minion0[1-2]\":\n    - modules.haproxy.service\n    - modules.keepalived.service\n\n#单实例操作说明：\nprod:\n  \"salt-minion04\":\n    - modules.nginx.service\t#单独安装nginx时\n    - modules.mysql.service     #单独安装mysql时\n    - modules.php.service       #单独安装php时\n    - modules.keepalived.service  #单独安装keepalived时\n    - modules.haproxy.service   #单独安装haproxy时\n\n  \"salt-minion03\":\n    - modules.lnmp.www     #单独部署lnmp环境时\n```\n","slug":"saltstack项目实战","published":1,"updated":"2019-05-22T13:07:59.031Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjw7tv4o2001pm834ztarus9j","content":"<h2 id=\"项目架构规划\"><a href=\"#项目架构规划\" class=\"headerlink\" title=\"项目架构规划\"></a>项目架构规划</h2><blockquote>\n<p>后端web服务器使用<code>Nginx+Php</code>作为站点，通过<code>HAproxy</code>做负载均衡，<code>Keepalived</code>做高可用</p>\n</blockquote>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-aee6d08ef5f58560.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"架构规划图\"></p>\n<h2 id=\"项目环境准备\"><a href=\"#项目环境准备\" class=\"headerlink\" title=\"项目环境准备\"></a>项目环境准备</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-44de6c7b5f253784.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"环境准备\"></p>\n<p><strong>说明：</strong> 关闭防火墙、<code>selinux</code>、时间同步等<br><code>host</code>绑定<br><figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /etc/hosts</span><br><span class=\"line\"><span class=\"number\">127.0</span><span class=\"meta\">.0</span><span class=\"meta\">.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class=\"line\">::<span class=\"number\">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>\tsalt-master</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.31</span>\tsalt-minion01</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.32</span>\tsalt-minion02</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.33</span>\tsalt-minion03</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.34</span>\tsalt-minion04</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# for i <span class=\"keyword\">in</span> <span class=\"string\">`seq 4`</span><span class=\"comment\">; do scp /etc/hosts 192.168.1.3$i:/etc/hosts ; done</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"软件安装\"><a href=\"#软件安装\" class=\"headerlink\" title=\"软件安装\"></a>软件安装</h3><p><a href=\"https://www.cnblogs.com/yanjieli/p/10864648.html\" target=\"_blank\" rel=\"noopener\">参考地址</a><br>1）<code>Master</code>上软件安装<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class=\"number\">2</span>.el7.noarch.rpm</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# sed</span> -i <span class=\"string\">\"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> enable salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>2）<code>Minion</code>上软件安装并配置<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm</span></span><br><span class=\"line\"><span class=\"meta\"># yum -y install salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class=\"line\"><span class=\"meta\"># sed -i '/#master: /c\\master: salt-master' /etc/salt/minion</span></span><br><span class=\"line\"><span class=\"meta\"># systemctl enable salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Master上认证\"><a href=\"#Master上认证\" class=\"headerlink\" title=\"Master上认证\"></a>Master上认证</h3><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -A -y</span><br><span class=\"line\">The following keys are going to be accepted:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Key for minion salt-minion01 accepted.</span><br><span class=\"line\">Key for minion salt-minion02 accepted.</span><br><span class=\"line\">Key for minion salt-minion03 accepted.</span><br><span class=\"line\">Key for minion salt-minion04 accepted.</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' test.ping</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion04:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Master上state编写\"><a href=\"#Master上state编写\" class=\"headerlink\" title=\"Master上state编写\"></a>Master上state编写</h2><h3 id=\"state环境设置\"><a href=\"#state环境设置\" class=\"headerlink\" title=\"state环境设置\"></a>state环境设置</h3><blockquote>\n<p>说明：该案例在<code>prod</code>环境下配置，在<code>prod</code>下面创建了一个<code>modules</code>的目录，所有的安装配置都放在这个目录下面了，里面分别又对应创建了对应的软件目录，每个软件目录下面的<code>files</code>目录用来存放的是软件包或者配置文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">file_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/salt/base</span><br><span class=\"line\">  test:</span><br><span class=\"line\">    - /srv/salt/test</span><br><span class=\"line\">  prod:</span><br><span class=\"line\">    - /srv/salt/prod</span><br><span class=\"line\">  dev:</span><br><span class=\"line\">    - /srv/salt/dev</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,test,prod,dev&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/prod/modules/&#123;nginx,php,mysql,haproxy,keepalived,lnmp&#125;/files</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/salt/prod/modules/user</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /srv/salt/prod/modules/</span><br><span class=\"line\">/srv/salt/prod/modules/</span><br><span class=\"line\">├── haproxy</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── keepalived</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── lnmp</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── mysql</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── nginx</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── php</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">└── user</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">13</span> directories, <span class=\"number\">0</span> files</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"sls文件编写\"><a href=\"#sls文件编写\" class=\"headerlink\" title=\"sls文件编写\"></a>sls文件编写</h3><h4 id=\"pkg基础包\"><a href=\"#pkg基础包\" class=\"headerlink\" title=\"pkg基础包\"></a>pkg基础包</h4><p>安装源码编译所需要用到的基础软件包<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/modules/pkg.sls </span><br><span class=\"line\">pkg-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - gcc</span></span><br><span class=\"line\"><span class=\"ruby\">      - gcc-c++</span></span><br><span class=\"line\"><span class=\"ruby\">      - make</span></span><br><span class=\"line\"><span class=\"ruby\">      - autoconf</span></span><br><span class=\"line\"><span class=\"ruby\">      - glibc</span></span><br><span class=\"line\"><span class=\"ruby\">      - glibc-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - glib2</span></span><br><span class=\"line\"><span class=\"ruby\">      - glib2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - pcre</span></span><br><span class=\"line\"><span class=\"ruby\">      - pcre-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - zlib</span></span><br><span class=\"line\"><span class=\"ruby\">      - zlib-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - openssl</span></span><br><span class=\"line\"><span class=\"ruby\">      - openssl-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libpng</span></span><br><span class=\"line\"><span class=\"ruby\">      - libpng-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - freetype</span></span><br><span class=\"line\"><span class=\"ruby\">      - freetype-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxml2</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxml2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - bzip2</span></span><br><span class=\"line\"><span class=\"ruby\">      - bzip2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - ncurses</span></span><br><span class=\"line\"><span class=\"ruby\">      - curl</span></span><br><span class=\"line\"><span class=\"ruby\">      - gdbm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libXpm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libX11-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - gd-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - gmp-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - readline-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxslt-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - expat-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - xmlrpc-c</span></span><br><span class=\"line\"><span class=\"ruby\">      - xmlrpc-c-devel</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"useradd\"><a href=\"#useradd\" class=\"headerlink\" title=\"useradd\"></a>useradd</h4><p>创建网站运行用户<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/modules/user/www.sls</span> </span><br><span class=\"line\"><span class=\"attr\">www-user-group:</span></span><br><span class=\"line\">  <span class=\"string\">group.present:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - gid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">user.present:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - fullname:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - shell:</span> <span class=\"string\">/sbin/nologin</span></span><br><span class=\"line\"><span class=\"attr\">    - uid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"><span class=\"attr\">    - gid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">id</span> <span class=\"string\">www</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"nginx\"><a href=\"#nginx\" class=\"headerlink\" title=\"nginx\"></a>nginx</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/nginx/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">nginx</span>]<span class=\"comment\"># tree </span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── nginx-<span class=\"number\">1.12</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\">│   ├── nginx-<span class=\"number\">1.16</span>.<span class=\"number\">0</span>.tar.gz</span><br><span class=\"line\">│   ├── nginx.conf.template</span><br><span class=\"line\">│   └── nginx.service.template</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">6</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master nginx]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">&#123;% <span class=\"keyword\">set</span> nginx_<span class=\"keyword\">version</span> = <span class=\"string\">\"1.16.0\"</span>%&#125;</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - modules.pkg</span><br><span class=\"line\">  - modules.user.www</span><br><span class=\"line\"></span><br><span class=\"line\">nginx-install:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - name: <span class=\"string\">/usr/local/src/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - source: salt:<span class=\"string\">//modules/nginx/files/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: 644</span><br><span class=\"line\"></span><br><span class=\"line\">  cmd.run:</span><br><span class=\"line\">    - name: <span class=\"keyword\">cd</span> <span class=\"string\">/usr/local/src/</span> &amp;&amp; tar xf nginx-&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span> &amp;&amp; <span class=\"keyword\">cd</span> nginx-&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; <span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"params\">--user=root</span> <span class=\"params\">--group=root</span> <span class=\"params\">--with-http_ssl_module</span> <span class=\"params\">--with-stream</span> <span class=\"params\">--with-http_stub_status_module</span> <span class=\"params\">--with-file-aio</span> <span class=\"params\">--with-http_gzip_static_module</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class=\"string\">/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"string\">/usr/local/nginx</span></span><br><span class=\"line\">    - unless: test -d <span class=\"string\">/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; test -L <span class=\"string\">/usr/local/nginx</span></span><br><span class=\"line\">    - require:</span><br><span class=\"line\">      - file: nginx-install</span><br><span class=\"line\">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">nginx]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入nginx安装sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.nginx.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加systemctl</span></span><br><span class=\"line\"><span class=\"attr\">nginx-init:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/lib/systemd/system/nginx.service</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/nginx/files/nginx.service.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-f</span> <span class=\"string\">/usr/lib/systemd/system/nginx.service</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">systemctl</span> <span class=\"string\">daemon-reload</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">nginx-init</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置文件</span></span><br><span class=\"line\"><span class=\"string\">/usr/local/nginx/conf/nginx.conf:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/nginx/files/nginx.conf.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动nginx</span></span><br><span class=\"line\"><span class=\"attr\">nginx-service:</span></span><br><span class=\"line\">  <span class=\"string\">file.directory:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/nginx/conf/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">nginx-install</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">nginx-init</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">/usr/local/nginx/conf/nginx.conf</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">nginx-service</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"php\"><a href=\"#php\" class=\"headerlink\" title=\"php\"></a>php</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/php/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">php</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── php-<span class=\"number\">5.6</span>.<span class=\"number\">40</span>.tar.gz</span><br><span class=\"line\">│   ├── php-fpm.conf.template</span><br><span class=\"line\">│   ├── php-fpm.service.template</span><br><span class=\"line\">│   ├── php-fpm.template</span><br><span class=\"line\">│   └── php.ini.template</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">7</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master php]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">&#123;% <span class=\"keyword\">set</span> php_<span class=\"keyword\">version</span> = <span class=\"string\">\"5.6.40\"</span> %&#125;</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - modules.pkg</span><br><span class=\"line\"></span><br><span class=\"line\">php-install:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - name: <span class=\"string\">/usr/local/src/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - source: salt:<span class=\"string\">//modules/php/files/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: 644</span><br><span class=\"line\"></span><br><span class=\"line\">  cmd.run:</span><br><span class=\"line\">    - name: <span class=\"keyword\">cd</span> <span class=\"string\">/usr/local/src/</span> &amp;&amp; tar xf php-&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span> &amp;&amp; <span class=\"keyword\">cd</span> php-&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; <span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"params\">--with-curl</span> <span class=\"params\">--with-freetype-dir</span> <span class=\"params\">--with-gd</span> <span class=\"params\">--with-gettext</span> <span class=\"params\">--with-iconv-dir</span> <span class=\"params\">--with-jpeg-dir</span> <span class=\"params\">--with-kerberos</span> <span class=\"params\">--with-libdir=lib64</span> <span class=\"params\">--with-libxml-dir</span> <span class=\"params\">--with-mysql</span> <span class=\"params\">--with-mysqli</span> <span class=\"params\">--with-openssl</span> <span class=\"params\">--with-pcre-regex</span> <span class=\"params\">--with-pdo-mysql</span> <span class=\"params\">--with-dpo-sqlite</span> <span class=\"params\">--with-pear</span> <span class=\"params\">--with-png-dir</span> <span class=\"params\">--with-openssl</span> <span class=\"params\">--with-xmlrpc</span> <span class=\"params\">--with-xsl</span> <span class=\"params\">--with-zlib</span> <span class=\"params\">--enable-fpm</span> <span class=\"params\">--enable-bcmath</span> <span class=\"params\">--enable-libxml</span> <span class=\"params\">--enable-inline-optimization</span> <span class=\"params\">--enable-gd-native-ttf</span> <span class=\"params\">--enable-mbregex</span> <span class=\"params\">--enable-mbstring</span> <span class=\"params\">--enable-opcache</span> <span class=\"params\">--enable-pcntl</span> <span class=\"params\">--enable-shmop</span> <span class=\"params\">--enable-soap</span> <span class=\"params\">--enable-sockets</span> <span class=\"params\">--enable-sysvsem</span> <span class=\"params\">--enable-xml</span> <span class=\"params\">--enable-zip</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class=\"string\">/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"string\">/usr/local/php</span></span><br><span class=\"line\">    - unless: test -d <span class=\"string\">/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; test -L <span class=\"string\">/usr/local/php</span></span><br><span class=\"line\">    - require:</span><br><span class=\"line\">      - file: php-install</span><br><span class=\"line\">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">php]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入php安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.php.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php-ini配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">php-ini:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/php/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php.ini.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ln</span> <span class=\"bullet\">-s</span> <span class=\"string\">/usr/local/php/etc/php.ini</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-L</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-ini</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php-fpm配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">php-fpm:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/php/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.conf.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ln</span> <span class=\"bullet\">-s</span> <span class=\"string\">/usr/local/php/etc/php-fpm.conf</span> <span class=\"string\">/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-L</span> <span class=\"string\">/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#加入system启动</span></span><br><span class=\"line\"><span class=\"attr\">php-systemd:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/lib/systemd/system/php-fpm.service</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.service.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#加入/etc/init.d/启动</span></span><br><span class=\"line\"><span class=\"attr\">php-init:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/init.d/php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">php-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-systemd</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-ini</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"mysql\"><a href=\"#mysql\" class=\"headerlink\" title=\"mysql\"></a>mysql</h4><p>1）配置文件模板准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/mysql/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">mysql</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── my.cnf</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">mysql</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">mariadb-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkgs:</span><br><span class=\"line\">      - mariadb-server</span><br><span class=\"line\">      - mariadb</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">mysql]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入mysql安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.mysql.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#my.cnf配置文件</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/mysql/files/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动mariadb</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"lnmp\"><a href=\"#lnmp\" class=\"headerlink\" title=\"lnmp\"></a>lnmp</h4><p>1）准备测试文件<code>php info</code> 和<code>nginx</code>虚拟主机配置文件<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/lnmp/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">lnmp</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── index.php</span><br><span class=\"line\">│   └── www.conf</span><br><span class=\"line\">└── www.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>www.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">lnmp]#</span> <span class=\"string\">cat</span> <span class=\"string\">www.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入nginx、php、mysql的安装</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.nginx.service</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.php.service</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.mysql.service</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#虚拟主机web站点目录创建</span></span><br><span class=\"line\"><span class=\"attr\">web-www:</span></span><br><span class=\"line\">  <span class=\"string\">file.directory:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/opt/www</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#虚拟主机配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">web-www-conf:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/nginx/conf/conf.d/www.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/lnmp/files/www.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">web-www</span></span><br><span class=\"line\"><span class=\"attr\">    - watch_in:</span></span><br><span class=\"line\"><span class=\"attr\">      - service:</span> <span class=\"string\">nginx-service</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">      IPADDR:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#phpinfo测试文件准备</span></span><br><span class=\"line\"><span class=\"attr\">web-index:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/opt/www/index.php</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/lnmp/files/index.php</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"测试lnmp是否OK\"><a href=\"#测试lnmp是否OK\" class=\"headerlink\" title=\"测试lnmp是否OK\"></a>测试lnmp是否OK</h4><p>1）<code>Top file</code>编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br></pre></td></tr></table></figure></p>\n<p>2）执行高级状态<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<p>3）访问测试<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-8408fa3d53913156.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"http://192.168.1.31\"><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-2a3378a0836eb128.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"http://192.168.1.32\"></p>\n<h4 id=\"haproxy\"><a href=\"#haproxy\" class=\"headerlink\" title=\"haproxy\"></a>haproxy</h4><p>1）配置文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/haproxy/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">haproxy</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── haproxy.cfg</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">haproxy</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">haproxy-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - name: haproxy</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">haproxy]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入haproxy安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.haproxy.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置文件</span></span><br><span class=\"line\"><span class=\"attr\">haproxy-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/haproxy/files/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">haproxy-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动haproxy</span></span><br><span class=\"line\"><span class=\"attr\">haproxy-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">haproxy</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">haproxy-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">haproxy-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">haproxy-config</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"keepalived\"><a href=\"#keepalived\" class=\"headerlink\" title=\"keepalived\"></a>keepalived</h4><p>1）配置文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/keepalived/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">keepalived</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── keepalived.conf</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">keepalived</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">keepalived-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - name: keepalived</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">keepalived]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入keepalived安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.keepalived.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#keepalived配置文件</span></span><br><span class=\"line\"><span class=\"attr\">keepalived-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/keepalived/keepalived.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/keepalived/files/keepalived.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">keepalived-install</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">if</span> <span class=\"string\">grains['fqdn']</span> <span class=\"string\">==</span> <span class=\"string\">\"salt-minion01\"</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      ROUTER_ID:</span> <span class=\"string\">saltstack01</span></span><br><span class=\"line\"><span class=\"attr\">      STATE:</span> <span class=\"string\">MASTER</span></span><br><span class=\"line\"><span class=\"attr\">      PRIORITY:</span> <span class=\"number\">150</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">elif</span> <span class=\"string\">grains['fqdn']</span> <span class=\"string\">==</span> <span class=\"string\">\"salt-minion02\"</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      ROUTER_ID:</span> <span class=\"string\">saltstack02</span></span><br><span class=\"line\"><span class=\"attr\">      STATE:</span> <span class=\"string\">BACKUP</span></span><br><span class=\"line\"><span class=\"attr\">      PRIORITY:</span> <span class=\"number\">100</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">endif</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动keepalived</span></span><br><span class=\"line\"><span class=\"attr\">keepalived-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">keepalived</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">keepalived-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">keepalived-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">keepalived-config</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"整体部署\"><a href=\"#整体部署\" class=\"headerlink\" title=\"整体部署\"></a>整体部署</h3><p>1）top file 编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[1-2]\"</span>:</span><br><span class=\"line\">    - modules.haproxy.service</span><br><span class=\"line\">    - modules.keepalived.service</span><br></pre></td></tr></table></figure></p>\n<p>2）高级状态执行<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<p>3）测试<br>访问<code>192.168.1.31</code>和<code>192.168.1.32</code>的状态页<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-dbb464867bd87a4c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"http://192.168.1.31:1314/status\"><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-259e918d1d42933d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"http://192.168.1.32:1314/status\"><br>访问VIP<code>192.168.1.100</code><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-94dfbc9d07974a44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"http://192.168.1.100\"></p>\n<p>通过上面测试可看到可以成功访问<code>lnmp</code>站点，并且<code>haproxy</code>也<code>ok</code>。访问所有四台服务器都可以得到<code>phpinfo</code>页面，而在生产环境中，我们只是对外提供<code>vip</code>即可。</p>\n<h2 id=\"项目总结\"><a href=\"#项目总结\" class=\"headerlink\" title=\"项目总结\"></a>项目总结</h2><p>1）整体环境查看<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# tree /srv/salt/prod/modules/</span><br><span class=\"line\">/srv/salt/prod/modules/</span><br><span class=\"line\">├── haproxy</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── haproxy.cfg</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── keepalived</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── keepalived.<span class=\"keyword\">conf</span></span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── lnmp</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── <span class=\"built_in\">index</span>.php</span><br><span class=\"line\">│   │   └── www.<span class=\"keyword\">conf</span></span><br><span class=\"line\">│   └── www.sls</span><br><span class=\"line\">├── mysql</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── nginx</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── nginx-<span class=\"number\">1.12</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\">│   │   ├── nginx-<span class=\"number\">1.16</span>.<span class=\"number\">0</span>.tar.gz</span><br><span class=\"line\">│   │   ├── nginx.<span class=\"keyword\">conf</span>.template</span><br><span class=\"line\">│   │   └── nginx.service.template</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── php</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── php-<span class=\"number\">5.6</span>.<span class=\"number\">40</span>.tar.gz</span><br><span class=\"line\">│   │   ├── php-fpm.<span class=\"keyword\">conf</span>.template</span><br><span class=\"line\">│   │   ├── php-fpm.service.template</span><br><span class=\"line\">│   │   ├── php-fpm.template</span><br><span class=\"line\">│   │   └── php.ini.template</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── pkg.sls</span><br><span class=\"line\">└── user</span><br><span class=\"line\">    └── www.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">13</span> directories, <span class=\"number\">27</span> <span class=\"keyword\">files</span></span><br></pre></td></tr></table></figure></p>\n<p>2）如果需要在某台服务器上面单独部署某一部分，参考以下写法：<br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># cat /srv/salt/base/top.sls </span></span><br><span class=\"line\"><span class=\"meta\">#部署lnmp及haproxy+keepalived</span></span><br><span class=\"line\"><span class=\"symbol\">prod:</span></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[1-2]\"</span>:</span><br><span class=\"line\">    - modules.haproxy.service</span><br><span class=\"line\">    - modules.keepalived.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#单实例操作说明：</span></span><br><span class=\"line\"><span class=\"symbol\">prod:</span></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion04\"</span>:</span><br><span class=\"line\">    - modules.nginx.service\t<span class=\"meta\">#单独安装nginx时</span></span><br><span class=\"line\">    - modules.mysql.service     <span class=\"meta\">#单独安装mysql时</span></span><br><span class=\"line\">    - modules.php.service       <span class=\"meta\">#单独安装php时</span></span><br><span class=\"line\">    - modules.keepalived.service  <span class=\"meta\">#单独安装keepalived时</span></span><br><span class=\"line\">    - modules.haproxy.service   <span class=\"meta\">#单独安装haproxy时</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion03\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www     <span class=\"meta\">#单独部署lnmp环境时</span></span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"项目架构规划\"><a href=\"#项目架构规划\" class=\"headerlink\" title=\"项目架构规划\"></a>项目架构规划</h2><blockquote>\n<p>后端web服务器使用<code>Nginx+Php</code>作为站点，通过<code>HAproxy</code>做负载均衡，<code>Keepalived</code>做高可用</p>\n</blockquote>\n<p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-aee6d08ef5f58560.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"架构规划图\"></p>\n<h2 id=\"项目环境准备\"><a href=\"#项目环境准备\" class=\"headerlink\" title=\"项目环境准备\"></a>项目环境准备</h2><p><img src=\"https://upload-images.jianshu.io/upload_images/11763553-44de6c7b5f253784.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"环境准备\"></p>\n<p><strong>说明：</strong> 关闭防火墙、<code>selinux</code>、时间同步等<br><code>host</code>绑定<br><figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /etc/hosts</span><br><span class=\"line\"><span class=\"number\">127.0</span><span class=\"meta\">.0</span><span class=\"meta\">.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class=\"line\">::<span class=\"number\">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.30</span>\tsalt-master</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.31</span>\tsalt-minion01</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.32</span>\tsalt-minion02</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.33</span>\tsalt-minion03</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"meta\">.1</span><span class=\"meta\">.34</span>\tsalt-minion04</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-master ~]# for i <span class=\"keyword\">in</span> <span class=\"string\">`seq 4`</span><span class=\"comment\">; do scp /etc/hosts 192.168.1.3$i:/etc/hosts ; done</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"软件安装\"><a href=\"#软件安装\" class=\"headerlink\" title=\"软件安装\"></a>软件安装</h3><p><a href=\"https://www.cnblogs.com/yanjieli/p/10864648.html\" target=\"_blank\" rel=\"noopener\">参考地址</a><br>1）<code>Master</code>上软件安装<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class=\"number\">2</span>.el7.noarch.rpm</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# sed</span> -i <span class=\"string\">\"s/repo.saltstack.com/mirrors.aliyun.com\\/saltstack/g\"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# yum</span> -y install salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> enable salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> <span class=\"literal\">start</span> salt-<span class=\"literal\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>2）<code>Minion</code>上软件安装并配置<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm</span></span><br><span class=\"line\"><span class=\"meta\"># yum -y install salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class=\"line\"><span class=\"meta\"># sed -i '/#master: /c\\master: salt-master' /etc/salt/minion</span></span><br><span class=\"line\"><span class=\"meta\"># systemctl enable salt-minion</span></span><br><span class=\"line\"><span class=\"meta\"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Master上认证\"><a href=\"#Master上认证\" class=\"headerlink\" title=\"Master上认证\"></a>Master上认证</h3><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -A -y</span><br><span class=\"line\">The following keys are going to be accepted:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Key for minion salt-minion01 accepted.</span><br><span class=\"line\">Key for minion salt-minion02 accepted.</span><br><span class=\"line\">Key for minion salt-minion03 accepted.</span><br><span class=\"line\">Key for minion salt-minion04 accepted.</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt-key</span> -L </span><br><span class=\"line\">Accepted Keys:</span><br><span class=\"line\">salt-minion01</span><br><span class=\"line\">salt-minion02</span><br><span class=\"line\">salt-minion03</span><br><span class=\"line\">salt-minion04</span><br><span class=\"line\">Denied Keys:</span><br><span class=\"line\">Unaccepted Keys:</span><br><span class=\"line\">Rejected Keys:</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# salt</span> '*' test.ping</span><br><span class=\"line\">salt-minion01:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion02:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion03:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\">salt-minion04:</span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Master上state编写\"><a href=\"#Master上state编写\" class=\"headerlink\" title=\"Master上state编写\"></a>Master上state编写</h2><h3 id=\"state环境设置\"><a href=\"#state环境设置\" class=\"headerlink\" title=\"state环境设置\"></a>state环境设置</h3><blockquote>\n<p>说明：该案例在<code>prod</code>环境下配置，在<code>prod</code>下面创建了一个<code>modules</code>的目录，所有的安装配置都放在这个目录下面了，里面分别又对应创建了对应的软件目录，每个软件目录下面的<code>files</code>目录用来存放的是软件包或者配置文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# vim</span> /etc/salt/<span class=\"literal\">master</span></span><br><span class=\"line\">file_roots:</span><br><span class=\"line\">  base:</span><br><span class=\"line\">    - /srv/salt/base</span><br><span class=\"line\">  test:</span><br><span class=\"line\">    - /srv/salt/test</span><br><span class=\"line\">  prod:</span><br><span class=\"line\">    - /srv/salt/prod</span><br><span class=\"line\">  dev:</span><br><span class=\"line\">    - /srv/salt/dev</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# systemctl</span> restart salt-<span class=\"literal\">master</span></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/&#123;base,test,prod,dev&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> -p /srv/salt/prod/modules/&#123;nginx,php,mysql,haproxy,keepalived,lnmp&#125;/files</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# mkdir</span> /srv/salt/prod/modules/user</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# tree</span> /srv/salt/prod/modules/</span><br><span class=\"line\">/srv/salt/prod/modules/</span><br><span class=\"line\">├── haproxy</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── keepalived</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── lnmp</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── mysql</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── nginx</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">├── php</span><br><span class=\"line\">│   └── files</span><br><span class=\"line\">└── user</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">13</span> directories, <span class=\"number\">0</span> files</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"sls文件编写\"><a href=\"#sls文件编写\" class=\"headerlink\" title=\"sls文件编写\"></a>sls文件编写</h3><h4 id=\"pkg基础包\"><a href=\"#pkg基础包\" class=\"headerlink\" title=\"pkg基础包\"></a>pkg基础包</h4><p>安装源码编译所需要用到的基础软件包<br><figure class=\"highlight haml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# cat /srv/salt/prod/modules/pkg.sls </span><br><span class=\"line\">pkg-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    -<span class=\"ruby\"> <span class=\"symbol\">pkgs:</span></span></span><br><span class=\"line\"><span class=\"ruby\">      - gcc</span></span><br><span class=\"line\"><span class=\"ruby\">      - gcc-c++</span></span><br><span class=\"line\"><span class=\"ruby\">      - make</span></span><br><span class=\"line\"><span class=\"ruby\">      - autoconf</span></span><br><span class=\"line\"><span class=\"ruby\">      - glibc</span></span><br><span class=\"line\"><span class=\"ruby\">      - glibc-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - glib2</span></span><br><span class=\"line\"><span class=\"ruby\">      - glib2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - pcre</span></span><br><span class=\"line\"><span class=\"ruby\">      - pcre-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - zlib</span></span><br><span class=\"line\"><span class=\"ruby\">      - zlib-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - openssl</span></span><br><span class=\"line\"><span class=\"ruby\">      - openssl-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libpng</span></span><br><span class=\"line\"><span class=\"ruby\">      - libpng-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - freetype</span></span><br><span class=\"line\"><span class=\"ruby\">      - freetype-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxml2</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxml2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - bzip2</span></span><br><span class=\"line\"><span class=\"ruby\">      - bzip2-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - ncurses</span></span><br><span class=\"line\"><span class=\"ruby\">      - curl</span></span><br><span class=\"line\"><span class=\"ruby\">      - gdbm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libXpm-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libX11-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - gd-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - gmp-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - readline-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - libxslt-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - expat-devel</span></span><br><span class=\"line\"><span class=\"ruby\">      - xmlrpc-c</span></span><br><span class=\"line\"><span class=\"ruby\">      - xmlrpc-c-devel</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"useradd\"><a href=\"#useradd\" class=\"headerlink\" title=\"useradd\"></a>useradd</h4><p>创建网站运行用户<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">~]#</span> <span class=\"string\">cat</span> <span class=\"string\">/srv/salt/prod/modules/user/www.sls</span> </span><br><span class=\"line\"><span class=\"attr\">www-user-group:</span></span><br><span class=\"line\">  <span class=\"string\">group.present:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - gid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">user.present:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - fullname:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - shell:</span> <span class=\"string\">/sbin/nologin</span></span><br><span class=\"line\"><span class=\"attr\">    - uid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"><span class=\"attr\">    - gid:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">id</span> <span class=\"string\">www</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"nginx\"><a href=\"#nginx\" class=\"headerlink\" title=\"nginx\"></a>nginx</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/nginx/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">nginx</span>]<span class=\"comment\"># tree </span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── nginx-<span class=\"number\">1.12</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\">│   ├── nginx-<span class=\"number\">1.16</span>.<span class=\"number\">0</span>.tar.gz</span><br><span class=\"line\">│   ├── nginx.conf.template</span><br><span class=\"line\">│   └── nginx.service.template</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">6</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master nginx]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">&#123;% <span class=\"keyword\">set</span> nginx_<span class=\"keyword\">version</span> = <span class=\"string\">\"1.16.0\"</span>%&#125;</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - modules.pkg</span><br><span class=\"line\">  - modules.user.www</span><br><span class=\"line\"></span><br><span class=\"line\">nginx-install:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - name: <span class=\"string\">/usr/local/src/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - source: salt:<span class=\"string\">//modules/nginx/files/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: 644</span><br><span class=\"line\"></span><br><span class=\"line\">  cmd.run:</span><br><span class=\"line\">    - name: <span class=\"keyword\">cd</span> <span class=\"string\">/usr/local/src/</span> &amp;&amp; tar xf nginx-&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span> &amp;&amp; <span class=\"keyword\">cd</span> nginx-&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; <span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"params\">--user=root</span> <span class=\"params\">--group=root</span> <span class=\"params\">--with-http_ssl_module</span> <span class=\"params\">--with-stream</span> <span class=\"params\">--with-http_stub_status_module</span> <span class=\"params\">--with-file-aio</span> <span class=\"params\">--with-http_gzip_static_module</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class=\"string\">/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"string\">/usr/local/nginx</span></span><br><span class=\"line\">    - unless: test -d <span class=\"string\">/usr/local/nginx-</span>&#123;&#123; nginx_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; test -L <span class=\"string\">/usr/local/nginx</span></span><br><span class=\"line\">    - require:</span><br><span class=\"line\">      - file: nginx-install</span><br><span class=\"line\">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">nginx]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入nginx安装sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.nginx.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加systemctl</span></span><br><span class=\"line\"><span class=\"attr\">nginx-init:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/lib/systemd/system/nginx.service</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/nginx/files/nginx.service.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-f</span> <span class=\"string\">/usr/lib/systemd/system/nginx.service</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">systemctl</span> <span class=\"string\">daemon-reload</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">nginx-init</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置文件</span></span><br><span class=\"line\"><span class=\"string\">/usr/local/nginx/conf/nginx.conf:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/nginx/files/nginx.conf.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动nginx</span></span><br><span class=\"line\"><span class=\"attr\">nginx-service:</span></span><br><span class=\"line\">  <span class=\"string\">file.directory:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/nginx/conf/conf.d</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">nginx-install</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - reload:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">nginx-init</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">/usr/local/nginx/conf/nginx.conf</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">nginx-service</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"php\"><a href=\"#php\" class=\"headerlink\" title=\"php\"></a>php</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/php/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">php</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── php-<span class=\"number\">5.6</span>.<span class=\"number\">40</span>.tar.gz</span><br><span class=\"line\">│   ├── php-fpm.conf.template</span><br><span class=\"line\">│   ├── php-fpm.service.template</span><br><span class=\"line\">│   ├── php-fpm.template</span><br><span class=\"line\">│   └── php.ini.template</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">7</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master php]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">&#123;% <span class=\"keyword\">set</span> php_<span class=\"keyword\">version</span> = <span class=\"string\">\"5.6.40\"</span> %&#125;</span><br><span class=\"line\">include:</span><br><span class=\"line\">  - modules.pkg</span><br><span class=\"line\"></span><br><span class=\"line\">php-install:</span><br><span class=\"line\">  file.managed:</span><br><span class=\"line\">    - name: <span class=\"string\">/usr/local/src/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - source: salt:<span class=\"string\">//modules/php/files/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span></span><br><span class=\"line\">    - user: root</span><br><span class=\"line\">    - group: root</span><br><span class=\"line\">    - mode: 644</span><br><span class=\"line\"></span><br><span class=\"line\">  cmd.run:</span><br><span class=\"line\">    - name: <span class=\"keyword\">cd</span> <span class=\"string\">/usr/local/src/</span> &amp;&amp; tar xf php-&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125;<span class=\"string\">.tar.gz</span> &amp;&amp; <span class=\"keyword\">cd</span> php-&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; <span class=\"string\">./configure</span> <span class=\"params\">--prefix=/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"params\">--with-curl</span> <span class=\"params\">--with-freetype-dir</span> <span class=\"params\">--with-gd</span> <span class=\"params\">--with-gettext</span> <span class=\"params\">--with-iconv-dir</span> <span class=\"params\">--with-jpeg-dir</span> <span class=\"params\">--with-kerberos</span> <span class=\"params\">--with-libdir=lib64</span> <span class=\"params\">--with-libxml-dir</span> <span class=\"params\">--with-mysql</span> <span class=\"params\">--with-mysqli</span> <span class=\"params\">--with-openssl</span> <span class=\"params\">--with-pcre-regex</span> <span class=\"params\">--with-pdo-mysql</span> <span class=\"params\">--with-dpo-sqlite</span> <span class=\"params\">--with-pear</span> <span class=\"params\">--with-png-dir</span> <span class=\"params\">--with-openssl</span> <span class=\"params\">--with-xmlrpc</span> <span class=\"params\">--with-xsl</span> <span class=\"params\">--with-zlib</span> <span class=\"params\">--enable-fpm</span> <span class=\"params\">--enable-bcmath</span> <span class=\"params\">--enable-libxml</span> <span class=\"params\">--enable-inline-optimization</span> <span class=\"params\">--enable-gd-native-ttf</span> <span class=\"params\">--enable-mbregex</span> <span class=\"params\">--enable-mbstring</span> <span class=\"params\">--enable-opcache</span> <span class=\"params\">--enable-pcntl</span> <span class=\"params\">--enable-shmop</span> <span class=\"params\">--enable-soap</span> <span class=\"params\">--enable-sockets</span> <span class=\"params\">--enable-sysvsem</span> <span class=\"params\">--enable-xml</span> <span class=\"params\">--enable-zip</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class=\"string\">/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; <span class=\"string\">/usr/local/php</span></span><br><span class=\"line\">    - unless: test -d <span class=\"string\">/usr/local/php-</span>&#123;&#123; php_<span class=\"keyword\">version</span> &#125;&#125; &amp;&amp; test -L <span class=\"string\">/usr/local/php</span></span><br><span class=\"line\">    - require:</span><br><span class=\"line\">      - file: php-install</span><br><span class=\"line\">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">php]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入php安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.php.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php-ini配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">php-ini:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/php/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php.ini.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ln</span> <span class=\"bullet\">-s</span> <span class=\"string\">/usr/local/php/etc/php.ini</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-L</span> <span class=\"string\">/etc/php.ini</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-ini</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#php-fpm配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">php-fpm:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/php/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.conf.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\">  <span class=\"string\">cmd.run:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ln</span> <span class=\"bullet\">-s</span> <span class=\"string\">/usr/local/php/etc/php-fpm.conf</span> <span class=\"string\">/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - unless:</span> <span class=\"string\">test</span> <span class=\"bullet\">-L</span> <span class=\"string\">/etc/php-fpm.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#加入system启动</span></span><br><span class=\"line\"><span class=\"attr\">php-systemd:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/lib/systemd/system/php-fpm.service</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.service.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#加入/etc/init.d/启动</span></span><br><span class=\"line\"><span class=\"attr\">php-init:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/init.d/php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/php/files/php-fpm.template</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - cmd:</span> <span class=\"string\">php-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">php-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-systemd</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-fpm</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">php-ini</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"mysql\"><a href=\"#mysql\" class=\"headerlink\" title=\"mysql\"></a>mysql</h4><p>1）配置文件模板准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/mysql/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">mysql</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── my.cnf</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">mysql</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">mariadb-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - pkgs:</span><br><span class=\"line\">      - mariadb-server</span><br><span class=\"line\">      - mariadb</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">mysql]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入mysql安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.mysql.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#my.cnf配置文件</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/mysql/files/my.cnf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动mariadb</span></span><br><span class=\"line\"><span class=\"attr\">mariadb-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">mariadb</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">mariadb-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">mariadb-config</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"lnmp\"><a href=\"#lnmp\" class=\"headerlink\" title=\"lnmp\"></a>lnmp</h4><p>1）准备测试文件<code>php info</code> 和<code>nginx</code>虚拟主机配置文件<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/lnmp/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">lnmp</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   ├── index.php</span><br><span class=\"line\">│   └── www.conf</span><br><span class=\"line\">└── www.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>www.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">lnmp]#</span> <span class=\"string\">cat</span> <span class=\"string\">www.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入nginx、php、mysql的安装</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.nginx.service</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.php.service</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.mysql.service</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#虚拟主机web站点目录创建</span></span><br><span class=\"line\"><span class=\"attr\">web-www:</span></span><br><span class=\"line\">  <span class=\"string\">file.directory:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/opt/www</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">755</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#虚拟主机配置文件配置</span></span><br><span class=\"line\"><span class=\"attr\">web-www-conf:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/usr/local/nginx/conf/conf.d/www.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/lnmp/files/www.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">web-www</span></span><br><span class=\"line\"><span class=\"attr\">    - watch_in:</span></span><br><span class=\"line\"><span class=\"attr\">      - service:</span> <span class=\"string\">nginx-service</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"attr\">      PORT:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">      IPADDR:</span> <span class=\"string\">&#123;&#123;</span> <span class=\"string\">grains['fqdn_ip4'][0]</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#phpinfo测试文件准备</span></span><br><span class=\"line\"><span class=\"attr\">web-index:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/opt/www/index.php</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/lnmp/files/index.php</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">www</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"测试lnmp是否OK\"><a href=\"#测试lnmp是否OK\" class=\"headerlink\" title=\"测试lnmp是否OK\"></a>测试lnmp是否OK</h4><p>1）<code>Top file</code>编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br></pre></td></tr></table></figure></p>\n<p>2）执行高级状态<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<p>3）访问测试<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-8408fa3d53913156.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"http://192.168.1.31\"><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-2a3378a0836eb128.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"http://192.168.1.32\"></p>\n<h4 id=\"haproxy\"><a href=\"#haproxy\" class=\"headerlink\" title=\"haproxy\"></a>haproxy</h4><p>1）配置文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/haproxy/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">haproxy</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── haproxy.cfg</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">haproxy</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">haproxy-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - name: haproxy</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">haproxy]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入haproxy安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.haproxy.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置文件</span></span><br><span class=\"line\"><span class=\"attr\">haproxy-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/haproxy/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/haproxy/files/haproxy.cfg</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">haproxy-install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动haproxy</span></span><br><span class=\"line\"><span class=\"attr\">haproxy-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">haproxy</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">haproxy-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">haproxy-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">haproxy-config</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"keepalived\"><a href=\"#keepalived\" class=\"headerlink\" title=\"keepalived\"></a>keepalived</h4><p>1）配置文件准备<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cd</span> /srv/salt/prod/modules/keepalived/</span><br><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">keepalived</span>]<span class=\"comment\"># tree</span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── files</span><br><span class=\"line\">│   └── keepalived.conf</span><br><span class=\"line\">├── install.sls</span><br><span class=\"line\">└── service.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span> directory, <span class=\"number\">3</span> files</span><br></pre></td></tr></table></figure></p>\n<p>2）<code>install.sls</code><br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">keepalived</span>]<span class=\"comment\"># cat install.sls </span></span><br><span class=\"line\">keepalived-install:</span><br><span class=\"line\">  pkg.installed:</span><br><span class=\"line\">    - name: keepalived</span><br></pre></td></tr></table></figure></p>\n<p>3）<code>service.sls</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[root@salt-master</span> <span class=\"string\">keepalived]#</span> <span class=\"string\">cat</span> <span class=\"string\">service.sls</span> </span><br><span class=\"line\"><span class=\"comment\">#引入keepalived安装的sls</span></span><br><span class=\"line\"><span class=\"attr\">include:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">modules.keepalived.install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#keepalived配置文件</span></span><br><span class=\"line\"><span class=\"attr\">keepalived-config:</span></span><br><span class=\"line\">  <span class=\"string\">file.managed:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">/etc/keepalived/keepalived.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - source:</span> <span class=\"attr\">salt://modules/keepalived/files/keepalived.conf</span></span><br><span class=\"line\"><span class=\"attr\">    - user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - group:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">    - mode:</span> <span class=\"number\">644</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">keepalived-install</span></span><br><span class=\"line\"><span class=\"attr\">    - template:</span> <span class=\"string\">jinja</span></span><br><span class=\"line\"><span class=\"attr\">    - defaults:</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">if</span> <span class=\"string\">grains['fqdn']</span> <span class=\"string\">==</span> <span class=\"string\">\"salt-minion01\"</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      ROUTER_ID:</span> <span class=\"string\">saltstack01</span></span><br><span class=\"line\"><span class=\"attr\">      STATE:</span> <span class=\"string\">MASTER</span></span><br><span class=\"line\"><span class=\"attr\">      PRIORITY:</span> <span class=\"number\">150</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">elif</span> <span class=\"string\">grains['fqdn']</span> <span class=\"string\">==</span> <span class=\"string\">\"salt-minion02\"</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      ROUTER_ID:</span> <span class=\"string\">saltstack02</span></span><br><span class=\"line\"><span class=\"attr\">      STATE:</span> <span class=\"string\">BACKUP</span></span><br><span class=\"line\"><span class=\"attr\">      PRIORITY:</span> <span class=\"number\">100</span></span><br><span class=\"line\"><span class=\"string\">&#123;%</span> <span class=\"string\">endif</span> <span class=\"string\">%&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动keepalived</span></span><br><span class=\"line\"><span class=\"attr\">keepalived-service:</span></span><br><span class=\"line\">  <span class=\"string\">service.running:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">keepalived</span></span><br><span class=\"line\"><span class=\"attr\">    - enable:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">    - require:</span></span><br><span class=\"line\"><span class=\"attr\">      - pkg:</span> <span class=\"string\">keepalived-install</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">keepalived-config</span></span><br><span class=\"line\"><span class=\"attr\">    - watch:</span></span><br><span class=\"line\"><span class=\"attr\">      - file:</span> <span class=\"string\">keepalived-config</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"整体部署\"><a href=\"#整体部署\" class=\"headerlink\" title=\"整体部署\"></a>整体部署</h3><p>1）top file 编写<br><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-<span class=\"keyword\">master</span> <span class=\"title\">~]# cat</span> /srv/salt/base/top.sls </span><br><span class=\"line\">prod:</span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[1-2]\"</span>:</span><br><span class=\"line\">    - modules.haproxy.service</span><br><span class=\"line\">    - modules.keepalived.service</span><br></pre></td></tr></table></figure></p>\n<p>2）高级状态执行<br><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@salt</span>-master ~]<span class=\"meta\"># salt <span class=\"string\">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p>\n<p>3）测试<br>访问<code>192.168.1.31</code>和<code>192.168.1.32</code>的状态页<br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-dbb464867bd87a4c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"http://192.168.1.31:1314/status\"><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-259e918d1d42933d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"http://192.168.1.32:1314/status\"><br>访问VIP<code>192.168.1.100</code><br><img src=\"https://upload-images.jianshu.io/upload_images/11763553-94dfbc9d07974a44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"http://192.168.1.100\"></p>\n<p>通过上面测试可看到可以成功访问<code>lnmp</code>站点，并且<code>haproxy</code>也<code>ok</code>。访问所有四台服务器都可以得到<code>phpinfo</code>页面，而在生产环境中，我们只是对外提供<code>vip</code>即可。</p>\n<h2 id=\"项目总结\"><a href=\"#项目总结\" class=\"headerlink\" title=\"项目总结\"></a>项目总结</h2><p>1）整体环境查看<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]# tree /srv/salt/prod/modules/</span><br><span class=\"line\">/srv/salt/prod/modules/</span><br><span class=\"line\">├── haproxy</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── haproxy.cfg</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── keepalived</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── keepalived.<span class=\"keyword\">conf</span></span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── lnmp</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── <span class=\"built_in\">index</span>.php</span><br><span class=\"line\">│   │   └── www.<span class=\"keyword\">conf</span></span><br><span class=\"line\">│   └── www.sls</span><br><span class=\"line\">├── mysql</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   └── my.<span class=\"keyword\">cnf</span></span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── nginx</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── nginx-<span class=\"number\">1.12</span>.<span class=\"number\">2</span>.tar.gz</span><br><span class=\"line\">│   │   ├── nginx-<span class=\"number\">1.16</span>.<span class=\"number\">0</span>.tar.gz</span><br><span class=\"line\">│   │   ├── nginx.<span class=\"keyword\">conf</span>.template</span><br><span class=\"line\">│   │   └── nginx.service.template</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── php</span><br><span class=\"line\">│   ├── <span class=\"keyword\">files</span></span><br><span class=\"line\">│   │   ├── php-<span class=\"number\">5.6</span>.<span class=\"number\">40</span>.tar.gz</span><br><span class=\"line\">│   │   ├── php-fpm.<span class=\"keyword\">conf</span>.template</span><br><span class=\"line\">│   │   ├── php-fpm.service.template</span><br><span class=\"line\">│   │   ├── php-fpm.template</span><br><span class=\"line\">│   │   └── php.ini.template</span><br><span class=\"line\">│   ├── install.sls</span><br><span class=\"line\">│   └── service.sls</span><br><span class=\"line\">├── pkg.sls</span><br><span class=\"line\">└── user</span><br><span class=\"line\">    └── www.sls</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">13</span> directories, <span class=\"number\">27</span> <span class=\"keyword\">files</span></span><br></pre></td></tr></table></figure></p>\n<p>2）如果需要在某台服务器上面单独部署某一部分，参考以下写法：<br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@salt-master ~]<span class=\"meta\"># cat /srv/salt/base/top.sls </span></span><br><span class=\"line\"><span class=\"meta\">#部署lnmp及haproxy+keepalived</span></span><br><span class=\"line\"><span class=\"symbol\">prod:</span></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[3-4]\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion0[1-2]\"</span>:</span><br><span class=\"line\">    - modules.haproxy.service</span><br><span class=\"line\">    - modules.keepalived.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#单实例操作说明：</span></span><br><span class=\"line\"><span class=\"symbol\">prod:</span></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion04\"</span>:</span><br><span class=\"line\">    - modules.nginx.service\t<span class=\"meta\">#单独安装nginx时</span></span><br><span class=\"line\">    - modules.mysql.service     <span class=\"meta\">#单独安装mysql时</span></span><br><span class=\"line\">    - modules.php.service       <span class=\"meta\">#单独安装php时</span></span><br><span class=\"line\">    - modules.keepalived.service  <span class=\"meta\">#单独安装keepalived时</span></span><br><span class=\"line\">    - modules.haproxy.service   <span class=\"meta\">#单独安装haproxy时</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">\"salt-minion03\"</span>:</span><br><span class=\"line\">    - modules.lnmp.www     <span class=\"meta\">#单独部署lnmp环境时</span></span><br></pre></td></tr></table></figure></p>\n"}],"PostAsset":[{"_id":"source/_posts/phpMyAdmin搭建/4.png","slug":"4.png","post":"cjw7tv4h50006m834634a9u9u","modified":1,"renderable":0},{"_id":"source/_posts/phpMyAdmin搭建/6.png","slug":"6.png","post":"cjw7tv4h50006m834634a9u9u","modified":1,"renderable":0}],"PostCategory":[{"post_id":"cjw7tv4gw0000m834osow5vqu","category_id":"cjw7tv4h10002m834nnfgyznc","_id":"cjw7tv4h9000dm834eau3d2br"},{"post_id":"cjw7tv4h00001m834c2zgpj8v","category_id":"cjw7tv4h60007m834u0so38rx","_id":"cjw7tv4hb000jm834j67h6kbj"},{"post_id":"cjw7tv4h30004m834o7msvchn","category_id":"cjw7tv4ha000fm834nwpnixyf","_id":"cjw7tv4hh000om834g00x1hbr"},{"post_id":"cjw7tv4h40005m834skaps1lj","category_id":"cjw7tv4ha000fm834nwpnixyf","_id":"cjw7tv4hi000rm8340jj0egun"},{"post_id":"cjw7tv4h50006m834634a9u9u","category_id":"cjw7tv4ha000fm834nwpnixyf","_id":"cjw7tv4hi000sm834ax4bbstq"},{"post_id":"cjw7tv4h7000am834b061rzcy","category_id":"cjw7tv4hh000qm834nq8dr4q6","_id":"cjw7tv4hi000um8344n97wv1g"},{"post_id":"cjw7tv4h9000cm83487hh8pkf","category_id":"cjw7tv4ha000fm834nwpnixyf","_id":"cjw7tv4hi000vm834kjepul7z"},{"post_id":"cjw7tv4la0012m8343j6wlfxz","category_id":"cjw7tv4hh000qm834nq8dr4q6","_id":"cjw7tv4lf001bm834ynvw6kne"},{"post_id":"cjw7tv4lb0014m834mdjpubox","category_id":"cjw7tv4hh000qm834nq8dr4q6","_id":"cjw7tv4lf001dm834jzwlwg95"},{"post_id":"cjw7tv4l5000wm834ee27bzve","category_id":"cjw7tv4l90010m8348686vmk5","_id":"cjw7tv4lg001fm834oj2kvyfk"},{"post_id":"cjw7tv4le001am8340evu4z9h","category_id":"cjw7tv4hh000qm834nq8dr4q6","_id":"cjw7tv4lg001hm834xnrbkyzz"},{"post_id":"cjw7tv4l7000ym834v8mxjoy6","category_id":"cjw7tv4l90010m8348686vmk5","_id":"cjw7tv4lg001im834ghq0tu6h"},{"post_id":"cjw7tv4mm001jm834havret7u","category_id":"cjw7tv4hh000qm834nq8dr4q6","_id":"cjw7tv4mo001nm8343tu9sjda"},{"post_id":"cjw7tv4mn001km834oeqhygfh","category_id":"cjw7tv4hh000qm834nq8dr4q6","_id":"cjw7tv4mp001om834blm9xne0"},{"post_id":"cjw7tv4o2001pm834ztarus9j","category_id":"cjw7tv4hh000qm834nq8dr4q6","_id":"cjw7tv4o5001rm8343rrimrwd"}],"PostTag":[{"post_id":"cjw7tv4h40005m834skaps1lj","tag_id":"cjw7tv4h30003m834bfwojxo0","_id":"cjw7tv4h70009m8343h4gerj1"},{"post_id":"cjw7tv4gw0000m834osow5vqu","tag_id":"cjw7tv4h30003m834bfwojxo0","_id":"cjw7tv4h9000bm834wid5z1ut"},{"post_id":"cjw7tv4h50006m834634a9u9u","tag_id":"cjw7tv4h30003m834bfwojxo0","_id":"cjw7tv4ha000gm83407jcyovz"},{"post_id":"cjw7tv4h00001m834c2zgpj8v","tag_id":"cjw7tv4h30003m834bfwojxo0","_id":"cjw7tv4hb000hm834272tivjx"},{"post_id":"cjw7tv4h9000cm83487hh8pkf","tag_id":"cjw7tv4h30003m834bfwojxo0","_id":"cjw7tv4hb000lm834a2i2hwcz"},{"post_id":"cjw7tv4h30004m834o7msvchn","tag_id":"cjw7tv4h30003m834bfwojxo0","_id":"cjw7tv4hg000mm834hu77z41c"},{"post_id":"cjw7tv4h7000am834b061rzcy","tag_id":"cjw7tv4hb000im83439ubqkwg","_id":"cjw7tv4hh000pm834nnuob8nl"},{"post_id":"cjw7tv4la0012m8343j6wlfxz","tag_id":"cjw7tv4hb000im83439ubqkwg","_id":"cjw7tv4lc0015m8342dycctka"},{"post_id":"cjw7tv4lb0014m834mdjpubox","tag_id":"cjw7tv4hb000im83439ubqkwg","_id":"cjw7tv4le0019m834o03ijklw"},{"post_id":"cjw7tv4l5000wm834ee27bzve","tag_id":"cjw7tv4l90011m8347s7r1em2","_id":"cjw7tv4lf001cm834ddt8ksp3"},{"post_id":"cjw7tv4le001am8340evu4z9h","tag_id":"cjw7tv4hb000im83439ubqkwg","_id":"cjw7tv4lf001em834dbnflx5k"},{"post_id":"cjw7tv4l7000ym834v8mxjoy6","tag_id":"cjw7tv4l90011m8347s7r1em2","_id":"cjw7tv4lg001gm834kjfzlg2o"},{"post_id":"cjw7tv4mm001jm834havret7u","tag_id":"cjw7tv4hb000im83439ubqkwg","_id":"cjw7tv4mo001lm834c59z2zfw"},{"post_id":"cjw7tv4mn001km834oeqhygfh","tag_id":"cjw7tv4hb000im83439ubqkwg","_id":"cjw7tv4mo001mm834hvtk273b"},{"post_id":"cjw7tv4o2001pm834ztarus9j","tag_id":"cjw7tv4hb000im83439ubqkwg","_id":"cjw7tv4o4001qm8343nap142y"}],"Tag":[{"name":"Linux运维日常","_id":"cjw7tv4h30003m834bfwojxo0"},{"name":"Saltstack","_id":"cjw7tv4hb000im83439ubqkwg"},{"name":"Ansible","_id":"cjw7tv4l90011m8347s7r1em2"}]}}