<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>不羁</title>
  
  <subtitle>别来无恙</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://leeyj.coding.me/"/>
  <updated>2019-05-26T15:12:40.818Z</updated>
  <id>https://leeyj.coding.me/</id>
  
  <author>
    <name>Leeyj</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Ansible快速入门</title>
    <link href="https://leeyj.coding.me/2019/05/26/Ansible%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>https://leeyj.coding.me/2019/05/26/Ansible快速入门/</id>
    <published>2019-05-26T14:35:22.000Z</published>
    <updated>2019-05-26T15:12:40.818Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote><p><code>Ansible</code>是一款简单的运维自动化工具，只需要使用<code>ssh</code>协议连接就可以来进行系统管理，自动化执行命令，部署等任务。</p></blockquote><p><strong>Ansible的特点</strong></p><blockquote><p>1、ansible不需要单独安装客户端，也不需要启动任何服务<br>2、ansible是python中的一套完整的自动化执行任务模块<br>3、ansible playbook 采用yaml配置，对于自动化任务执行过一目了然</p></blockquote><p><strong>Ansible组成结构</strong></p><ul><li>Ansible<br>是<code>Ansible</code>的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。</li><li>Ansible Playbook<br>任务剧本（又称任务集），编排定义<code>Ansible</code>任务集的配置文件，由<code>Ansible</code>顺序依次执行，<code>yaml</code>格式。</li><li>Inventory<br><code>Ansible</code>管理主机的清单，默认是<code>/etc/ansible/hosts</code>文件。</li><li>Modules<br><code>Ansible</code>执行命令的功能模块，<code>Ansible2.3</code>版本为止，共有<code>1039</code>个模块。还可以自定义模块。</li><li>Plugins<br>插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。</li><li>API<br>提供给第三方程序调用的应用程序编程接口。</li></ul><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><table><thead><tr><th style="text-align:center">IP</th><th style="text-align:center">系统</th><th style="text-align:center">主机名</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">192.168.1.30</td><td style="text-align:center">CentOS7</td><td style="text-align:center">ansible</td><td style="text-align:center">ansible管理节点</td></tr><tr><td style="text-align:center">192.168.1.31</td><td style="text-align:center">CentOS7</td><td style="text-align:center">linux.node01.com</td><td style="text-align:center">被管理节点1</td></tr><tr><td style="text-align:center">192.168.1.32</td><td style="text-align:center">CentOS7</td><td style="text-align:center">linux.node02.com</td><td style="text-align:center">被管理节点2</td></tr><tr><td style="text-align:center">192.168.1.33</td><td style="text-align:center">CentOS7</td><td style="text-align:center">linux.node03.com</td><td style="text-align:center">被管理节点3</td></tr><tr><td style="text-align:center">192.168.1.36</td><td style="text-align:center">CentOS6</td><td style="text-align:center">linux.node06.com</td><td style="text-align:center">被管理节点6</td></tr></tbody></table><h2 id="Ansible安装"><a href="#Ansible安装" class="headerlink" title="Ansible安装"></a>Ansible安装</h2><p>1）配置<code>epel</code>源<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># yum clean all</span></span><br><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># yum makecache</span></span><br></pre></td></tr></table></figure></p><p>2）安装<code>ansible</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># yum -y install ansible</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ansible版本</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible --version</span></span><br><span class="line">ansible <span class="number">2.8</span><span class="number">.0</span></span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [<span class="string">u'/root/.ansible/plugins/modules'</span>, <span class="string">u'/usr/share/ansible/plugins/modules'</span>]</span><br><span class="line">  ansible python module location = /usr/lib/python2<span class="number">.7</span>/site-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = <span class="number">2.7</span><span class="number">.5</span> (default, Aug  <span class="number">4</span> <span class="number">2017</span>, <span class="number">00</span>:<span class="number">39</span>:<span class="number">18</span>) [GCC <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-16</span>)]</span><br></pre></td></tr></table></figure></p><h2 id="Ansible-Inventory文件"><a href="#Ansible-Inventory文件" class="headerlink" title="Ansible Inventory文件"></a>Ansible Inventory文件</h2><p><a href="http://www.ansible.com.cn/docs/intro_inventory.html" target="_blank" rel="noopener">Inventory中文文档</a></p><blockquote><p><code>Inventory</code>文件通常用于定义要管理的主机的认证信息，例如<code>ssh</code>登录用户名、密码以及<code>key</code>相关信息。可以同时操作一个组的多台主机，组与主机组之间的关系都是通过<code>inventory</code>文件配置。配置文件路径为：<code>/etc/ansible/hosts</code></p></blockquote><h3 id="基于密码连接"><a href="#基于密码连接" class="headerlink" title="基于密码连接"></a>基于密码连接</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class="line"><span class="comment"># 方法一 主机+端口+密码</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.31 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line">192.168.1.32 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line">192.168.1.33 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line">192.168.1.36 <span class="attribute">ansible_ssh_port</span>=22 <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二 主机+端口+密码</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.3[1:3] <span class="attribute">ansible_ssh_user</span>=root <span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二 主机+端口+密码</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.3[1:3]</span><br><span class="line">[webserver:vars]</span><br><span class="line"><span class="attribute">ansible_ssh_pass</span>=<span class="string">"123456"</span></span><br></pre></td></tr></table></figure><h3 id="基于秘钥连接"><a href="#基于秘钥连接" class="headerlink" title="基于秘钥连接"></a>基于秘钥连接</h3><blockquote><p>基于秘钥连接需要先创建公钥和私钥，并发送给被管理机器</p></blockquote><p>1）生成公私钥<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# ssh-keygen</span><br><span class="line">[root@ansible ~]# for i in &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>&#125;; do ssh-copy-id -i <span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span>$i ; done</span><br></pre></td></tr></table></figure></p><p>2）配置连接<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# vim /etc/ansible/hosts</span><br><span class="line"><span class="comment"># 方法一 主机+端口+密钥</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.31:22</span><br><span class="line">192.168.1.32</span><br><span class="line">192.168.1.33</span><br><span class="line">192.168.1.36</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法一 别名主机+端口+密钥</span></span><br><span class="line">[webserver]</span><br><span class="line">node1 <span class="attribute">ansible_ssh_host</span>=192.168.1.31 <span class="attribute">ansible_ssh_port</span>=22</span><br><span class="line">node2 <span class="attribute">ansible_ssh_host</span>=192.168.1.32 <span class="attribute">ansible_ssh_port</span>=22</span><br><span class="line">node3 <span class="attribute">ansible_ssh_host</span>=192.168.1.33 <span class="attribute">ansible_ssh_port</span>=22</span><br><span class="line">node6 <span class="attribute">ansible_ssh_host</span>=192.168.1.36 <span class="attribute">ansible_ssh_port</span>=22</span><br></pre></td></tr></table></figure></p><h3 id="主机组的使用"><a href="#主机组的使用" class="headerlink" title="主机组的使用"></a>主机组的使用</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 主机组变量名+主机+密码</span></span><br><span class="line">[<span class="meta">apache</span>]</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.36</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span></span><br><span class="line">[<span class="meta">apache.vars</span>]</span><br><span class="line">ansible_ssh_pass=<span class="string">'123456'</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 主机组变量名+主机+密钥</span></span><br><span class="line">[<span class="meta">nginx</span>]</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span>[<span class="number">1</span>:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta"># 定义多个组，把一个组当另外一个组的组员</span></span><br><span class="line">[<span class="meta">webserver:children</span>]  <span class="meta">#webserver组包括两个子组：apache nginx</span></span><br><span class="line">apache</span><br><span class="line">nginx</span><br></pre></td></tr></table></figure><h3 id="临时指定inventory"><a href="#临时指定inventory" class="headerlink" title="临时指定inventory"></a>临时指定inventory</h3><p>1）先编辑一个主机定义清单<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# vim /etc/dockers</span><br><span class="line">[dockers]</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span> ansible_ssh_pass='<span class="number">123456</span>'</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span></span><br></pre></td></tr></table></figure></p><p>2）在执行命令是指定<code>inventory</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# ansible dockers -m<span class="built_in"> ping </span>-i /etc/dockers -o </span><br><span class="line">192.168.1.33 | SUCCESS =&gt; &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: <span class="literal">false</span>, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line">192.168.1.32 | SUCCESS =&gt; &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: <span class="literal">false</span>, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line">192.168.1.31 | SUCCESS =&gt; &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: <span class="literal">false</span>, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br></pre></td></tr></table></figure></p><h3 id="Inventory内置参数"><a href="#Inventory内置参数" class="headerlink" title="Inventory内置参数"></a>Inventory内置参数</h3><p><img src="https://upload-images.jianshu.io/upload_images/11763553-f523aa19ae811b0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ansible inventory内置参数"></p><h2 id="Ansible-Ad-Hoc"><a href="#Ansible-Ad-Hoc" class="headerlink" title="Ansible Ad-Hoc"></a>Ansible Ad-Hoc</h2><p><a href="http://www.ansible.com.cn/docs/intro_adhoc.html" target="_blank" rel="noopener">Ad-Hoc中文文档</a></p><blockquote><p>ad hoc —— 临时的，在<code>ansible</code>中是指需要快速执行，并且不需要保存的命令。说白了就是执行简单的命令——一条命令。对于复杂的命令则为<code>playbook</code>，类似于<code>saltstack</code>的<code>state sls</code>状态文件。</p></blockquote><h3 id="ansible命令格式"><a href="#ansible命令格式" class="headerlink" title="ansible命令格式"></a>ansible命令格式</h3><p>1）常用命令参数<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# ansible -h</span><br><span class="line">Usage: ansible &lt;host-pattern&gt; [options]</span><br><span class="line">-<span class="ruby">a MODULE_ARGS   <span class="comment">#模块参数</span></span></span><br><span class="line"><span class="ruby">-C, --check  <span class="comment">#检查语法</span></span></span><br><span class="line"><span class="ruby">-f FORKS <span class="comment">#并发</span></span></span><br><span class="line"><span class="ruby">--list-hosts <span class="comment">#列出主机列表</span></span></span><br><span class="line"><span class="ruby">-m MODULE_NAME <span class="comment">#模块名字</span></span></span><br><span class="line"><span class="ruby">-o 使用精简的输出</span></span><br></pre></td></tr></table></figure></p><p>2）示例<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@ansible</span> ~]<span class="comment"># ansible webserver -m shell -a 'uptime' -o</span></span><br><span class="line">192.168.1.36 |<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  13:46:14 up 1 day,  9:20,  4 users,  load average: 0.00, 0.00, 0.00</span></span><br><span class="line"><span class="string">192.168.1.33 </span>|<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  21:26:33 up 1 day,  8:51,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class="line"><span class="string">192.168.1.31 </span>|<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  21:26:33 up 1 day,  8:50,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br><span class="line"><span class="string">192.168.1.32 </span>|<span class="string"> CHANGED </span>|<span class="string"> rc=0 </span>|<span class="string"> (stdout)  21:26:33 up 1 day,  8:59,  3 users,  load average: 0.00, 0.01, 0.05</span></span><br></pre></td></tr></table></figure></p><p>3）命令说明<br><img src="https://upload-images.jianshu.io/upload_images/11763553-3c9c5b01fb881cd8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ansible command"></p><h3 id="host-pattern格式"><a href="#host-pattern格式" class="headerlink" title="host-pattern格式"></a>host-pattern格式</h3><p>目标<code>target</code>主机，主机组匹配方式</p><h4 id="主机的匹配"><a href="#主机的匹配" class="headerlink" title="主机的匹配"></a>主机的匹配</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  一台目标主机</span></span><br><span class="line">[root@ansible ~]# ansible 192.168.1.31 -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多台目标主机</span></span><br><span class="line">[root@ansible ~]# ansible 192.168.1.31,192.168.1.32 -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有目标主机</span></span><br><span class="line">[root@ansible ~]# ansible all -m ping</span><br></pre></td></tr></table></figure><h4 id="组的匹配"><a href="#组的匹配" class="headerlink" title="组的匹配"></a>组的匹配</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 组的配置信息如下：这里定义了一个nginx组和一个apache组</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible nginx --list</span></span><br><span class="line">  hosts (<span class="number">2</span>)<span class="symbol">:</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.31</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.32</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible apache --list</span></span><br><span class="line">  hosts (<span class="number">3</span>)<span class="symbol">:</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.36</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.33</span></span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.32</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一个组的所有主机匹配</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible apache -m ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配apache组中有，但是nginx组中没有的所有主机</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 'apache:!nginx' -m ping -o</span></span><br><span class="line"><span class="meta">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配apache组和nginx组中都有的机器（并集）</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 'apache:&amp;nginx' -m ping -o</span></span><br><span class="line"><span class="meta">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配apache组nginx组两个组所有的机器（并集）；等于ansible apache,nginx -m ping</span></span><br><span class="line">[root@ansible ~]<span class="comment"># ansible 'apache:nginx' -m ping -o</span></span><br><span class="line"><span class="meta">192.168.1.32 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.31 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.33 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br><span class="line"><span class="meta">192.168.1.36 | SUCCESS =&gt;</span> &#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span>&#125;, <span class="string">"changed"</span>: false, <span class="string">"ping"</span>: <span class="string">"pong"</span>&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;Ansible&lt;/code&gt;是一款简单的运维自动化工具，只需要使用&lt;code&gt;ssh&lt;/code&gt;协议
      
    
    </summary>
    
      <category term="Ansible" scheme="https://leeyj.coding.me/categories/Ansible/"/>
    
    
      <category term="Ansible" scheme="https://leeyj.coding.me/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>linux保存history到日志文件</title>
    <link href="https://leeyj.coding.me/2019/05/22/linux%E4%BF%9D%E5%AD%98history%E5%88%B0%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6/"/>
    <id>https://leeyj.coding.me/2019/05/22/linux保存history到日志文件/</id>
    <published>2019-05-22T08:30:09.000Z</published>
    <updated>2019-05-22T13:07:59.030Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑<code>/etc/bashrc</code>文件记录历史命令到日志文件下面，并已登录来源<code>IP</code>，登录用户名，登录时间命名日志文件名字</p></blockquote><h5 id="查看默认的history"><a href="#查看默认的history" class="headerlink" title="查看默认的history"></a>查看默认的history</h5><p><img src="https://upload-images.jianshu.io/upload_images/11763553-a2f73d6c0783224d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="默认的history"></p><h5 id="编辑-etc-bashrc"><a href="#编辑-etc-bashrc" class="headerlink" title="编辑/etc/bashrc"></a>编辑/etc/bashrc</h5><p>编辑<code>/etc/bashrc</code>文件，加入以下内容，也可以放在<code>/etc/profile</code>文件里<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/bashrc</span></span><br><span class="line">USER_IP=$(<span class="built_in">echo</span> -e <span class="string">"\033[31m\033[1m`who -u am i 2&gt;/dev/null| awk '&#123;print <span class="variable">$NF</span>&#125;'|sed -e 's/[()]//g'`\033[0m"</span>)</span><br><span class="line">IP=$(who -u am i 2&gt;/dev/null| awk <span class="string">'&#123;print $NF&#125;'</span>|sed -e <span class="string">'s/[()]//g'</span>)</span><br><span class="line">USER=$(whoami)</span><br><span class="line">USER_NAME=`<span class="built_in">echo</span> -e <span class="string">"\033[36m\033[1m<span class="variable">$(whoami)</span> \033[0m"</span>`</span><br><span class="line">HISTFILESIZE=100000</span><br><span class="line">HISTSIZE=4096</span><br><span class="line">HISTTIMEFORMAT=<span class="string">"%F %T  <span class="variable">$USER_IP</span>  <span class="variable">$USER_NAME</span>  "</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$USER_IP</span>"</span> = <span class="string">""</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   USER_IP=`hostname`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d /var/<span class="built_in">log</span>/<span class="built_in">history</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   mkdir /var/<span class="built_in">log</span>/<span class="built_in">history</span></span><br><span class="line">   chmod 777 /var/<span class="built_in">log</span>/<span class="built_in">history</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    mkdir /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span></span><br><span class="line">    chmod 300 /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">DT=`date <span class="string">"+%Y%m%d_%H%M"</span>`</span><br><span class="line"><span class="built_in">export</span> HISTFILE=<span class="string">"/var/log/history/<span class="variable">$&#123;LOGNAME&#125;</span>/<span class="variable">$&#123;DT&#125;</span>_<span class="variable">$&#123;USER&#125;</span>_<span class="variable">$&#123;IP&#125;</span>"</span></span><br><span class="line">chmod 600 /var/<span class="built_in">log</span>/<span class="built_in">history</span>/<span class="variable">$&#123;LOGNAME&#125;</span>/* 2&gt;/dev/null</span><br></pre></td></tr></table></figure></p><p>退出重新登录再次查看<br><img src="https://upload-images.jianshu.io/upload_images/11763553-dad4faed53395912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>查看前面保留的历史记录日志<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# <span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/</span><br><span class="line">总用量 <span class="number">0</span></span><br><span class="line">d-wx------. <span class="number">2</span> root root <span class="number">6</span> <span class="number">5</span>月  <span class="number">22</span> <span class="number">14</span>:<span class="number">27</span> root</span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# <span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/root/</span><br><span class="line">总用量 <span class="number">4</span></span><br><span class="line">-rw-------. <span class="number">1</span> root root <span class="number">123</span> <span class="number">5</span>月  <span class="number">22</span> <span class="number">14</span>:<span class="number">29</span> <span class="number">20190522</span>_1427_root_192.<span class="number">168.1</span>.<span class="number">123</span></span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/root/<span class="number">20190522</span>_1427_root_192.<span class="number">168.1</span>.<span class="number">123</span> </span><br><span class="line">#<span class="number">1558506461</span></span><br><span class="line"><span class="keyword">ls</span></span><br><span class="line">#<span class="number">1558506467</span></span><br><span class="line"><span class="keyword">history</span></span><br><span class="line">#<span class="number">1558506519</span></span><br><span class="line"><span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/</span><br><span class="line">#<span class="number">1558506571</span></span><br><span class="line"><span class="keyword">ll</span> /var/<span class="built_in">log</span>/<span class="keyword">history</span>/root/</span><br><span class="line">#<span class="number">1558506574</span></span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;在linux下面，为了保证服务器安全，通常会记录所敲命令的历史记录，但是记录为1000条，并且退出重新登录后，之前的变会没有了，通过编辑&lt;code&gt;/etc/bashrc&lt;/code&gt;文件记录历史命令到日志文件下面，并已登录来源&lt;code&gt;IP&lt;/
      
    
    </summary>
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/categories/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/tags/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>saltstack项目实战</title>
    <link href="https://leeyj.coding.me/2019/05/21/saltstack%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/"/>
    <id>https://leeyj.coding.me/2019/05/21/saltstack项目实战/</id>
    <published>2019-05-21T07:43:05.000Z</published>
    <updated>2019-05-22T13:07:59.031Z</updated>
    
    <content type="html"><![CDATA[<h2 id="项目架构规划"><a href="#项目架构规划" class="headerlink" title="项目架构规划"></a>项目架构规划</h2><blockquote><p>后端web服务器使用<code>Nginx+Php</code>作为站点，通过<code>HAproxy</code>做负载均衡，<code>Keepalived</code>做高可用</p></blockquote><p><img src="https://upload-images.jianshu.io/upload_images/11763553-aee6d08ef5f58560.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="架构规划图"></p><h2 id="项目环境准备"><a href="#项目环境准备" class="headerlink" title="项目环境准备"></a>项目环境准备</h2><p><img src="https://upload-images.jianshu.io/upload_images/11763553-44de6c7b5f253784.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="环境准备"></p><p><strong>说明：</strong> 关闭防火墙、<code>selinux</code>、时间同步等<br><code>host</code>绑定<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /etc/hosts</span><br><span class="line"><span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>salt-master</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.31</span>salt-minion01</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.32</span>salt-minion02</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.33</span>salt-minion03</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.34</span>salt-minion04</span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# for i <span class="keyword">in</span> <span class="string">`seq 4`</span><span class="comment">; do scp /etc/hosts 192.168.1.3$i:/etc/hosts ; done</span></span><br></pre></td></tr></table></figure></p><h3 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h3><p><a href="https://www.cnblogs.com/yanjieli/p/10864648.html" target="_blank" rel="noopener">参考地址</a><br>1）<code>Master</code>上软件安装<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class="number">2</span>.el7.noarch.rpm</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# sed</span> -i <span class="string">"s/repo.saltstack.com/mirrors.aliyun.com\/saltstack/g"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> enable salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> <span class="literal">start</span> salt-<span class="literal">master</span></span><br></pre></td></tr></table></figure></p><p>2）<code>Minion</code>上软件安装并配置<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># yum -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-2.el7.noarch.rpm</span></span><br><span class="line"><span class="meta"># yum -y install salt-minion</span></span><br><span class="line"><span class="meta"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class="line"><span class="meta"># sed -i '/#master: /c\master: salt-master' /etc/salt/minion</span></span><br><span class="line"><span class="meta"># systemctl enable salt-minion</span></span><br><span class="line"><span class="meta"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p><h3 id="Master上认证"><a href="#Master上认证" class="headerlink" title="Master上认证"></a>Master上认证</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -L </span><br><span class="line">Accepted Keys:</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">salt-minion02</span><br><span class="line">salt-minion03</span><br><span class="line">salt-minion04</span><br><span class="line">Rejected Keys:</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -A -y</span><br><span class="line">The following keys are going to be accepted:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">salt-minion02</span><br><span class="line">salt-minion03</span><br><span class="line">salt-minion04</span><br><span class="line">Key for minion salt-minion01 accepted.</span><br><span class="line">Key for minion salt-minion02 accepted.</span><br><span class="line">Key for minion salt-minion03 accepted.</span><br><span class="line">Key for minion salt-minion04 accepted.</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -L </span><br><span class="line">Accepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">salt-minion02</span><br><span class="line">salt-minion03</span><br><span class="line">salt-minion04</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">Rejected Keys:</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' test.ping</span><br><span class="line">salt-minion01:</span><br><span class="line">    <span class="literal">True</span></span><br><span class="line">salt-minion02:</span><br><span class="line">    <span class="literal">True</span></span><br><span class="line">salt-minion03:</span><br><span class="line">    <span class="literal">True</span></span><br><span class="line">salt-minion04:</span><br><span class="line">    <span class="literal">True</span></span><br></pre></td></tr></table></figure><h2 id="Master上state编写"><a href="#Master上state编写" class="headerlink" title="Master上state编写"></a>Master上state编写</h2><h3 id="state环境设置"><a href="#state环境设置" class="headerlink" title="state环境设置"></a>state环境设置</h3><blockquote><p>说明：该案例在<code>prod</code>环境下配置，在<code>prod</code>下面创建了一个<code>modules</code>的目录，所有的安装配置都放在这个目录下面了，里面分别又对应创建了对应的软件目录，每个软件目录下面的<code>files</code>目录用来存放的是软件包或者配置文件模板<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">file_roots:</span><br><span class="line">  base:</span><br><span class="line">    - /srv/salt/base</span><br><span class="line">  test:</span><br><span class="line">    - /srv/salt/test</span><br><span class="line">  prod:</span><br><span class="line">    - /srv/salt/prod</span><br><span class="line">  dev:</span><br><span class="line">    - /srv/salt/dev</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/&#123;base,test,prod,dev&#125;</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/prod/modules/&#123;nginx,php,mysql,haproxy,keepalived,lnmp&#125;/files</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> /srv/salt/prod/modules/user</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# tree</span> /srv/salt/prod/modules/</span><br><span class="line">/srv/salt/prod/modules/</span><br><span class="line">├── haproxy</span><br><span class="line">│   └── files</span><br><span class="line">├── keepalived</span><br><span class="line">│   └── files</span><br><span class="line">├── lnmp</span><br><span class="line">│   └── files</span><br><span class="line">├── mysql</span><br><span class="line">│   └── files</span><br><span class="line">├── nginx</span><br><span class="line">│   └── files</span><br><span class="line">├── php</span><br><span class="line">│   └── files</span><br><span class="line">└── user</span><br><span class="line"></span><br><span class="line"><span class="number">13</span> directories, <span class="number">0</span> files</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="sls文件编写"><a href="#sls文件编写" class="headerlink" title="sls文件编写"></a>sls文件编写</h3><h4 id="pkg基础包"><a href="#pkg基础包" class="headerlink" title="pkg基础包"></a>pkg基础包</h4><p>安装源码编译所需要用到的基础软件包<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /srv/salt/prod/modules/pkg.sls </span><br><span class="line">pkg-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    -<span class="ruby"> <span class="symbol">pkgs:</span></span></span><br><span class="line"><span class="ruby">      - gcc</span></span><br><span class="line"><span class="ruby">      - gcc-c++</span></span><br><span class="line"><span class="ruby">      - make</span></span><br><span class="line"><span class="ruby">      - autoconf</span></span><br><span class="line"><span class="ruby">      - glibc</span></span><br><span class="line"><span class="ruby">      - glibc-devel</span></span><br><span class="line"><span class="ruby">      - glib2</span></span><br><span class="line"><span class="ruby">      - glib2-devel</span></span><br><span class="line"><span class="ruby">      - pcre</span></span><br><span class="line"><span class="ruby">      - pcre-devel</span></span><br><span class="line"><span class="ruby">      - zlib</span></span><br><span class="line"><span class="ruby">      - zlib-devel</span></span><br><span class="line"><span class="ruby">      - openssl</span></span><br><span class="line"><span class="ruby">      - openssl-devel</span></span><br><span class="line"><span class="ruby">      - libpng</span></span><br><span class="line"><span class="ruby">      - libpng-devel</span></span><br><span class="line"><span class="ruby">      - freetype</span></span><br><span class="line"><span class="ruby">      - freetype-devel</span></span><br><span class="line"><span class="ruby">      - libxml2</span></span><br><span class="line"><span class="ruby">      - libxml2-devel</span></span><br><span class="line"><span class="ruby">      - bzip2</span></span><br><span class="line"><span class="ruby">      - bzip2-devel</span></span><br><span class="line"><span class="ruby">      - ncurses</span></span><br><span class="line"><span class="ruby">      - curl</span></span><br><span class="line"><span class="ruby">      - gdbm-devel</span></span><br><span class="line"><span class="ruby">      - libXpm-devel</span></span><br><span class="line"><span class="ruby">      - libX11-devel</span></span><br><span class="line"><span class="ruby">      - gd-devel</span></span><br><span class="line"><span class="ruby">      - gmp-devel</span></span><br><span class="line"><span class="ruby">      - readline-devel</span></span><br><span class="line"><span class="ruby">      - libxslt-devel</span></span><br><span class="line"><span class="ruby">      - expat-devel</span></span><br><span class="line"><span class="ruby">      - xmlrpc-c</span></span><br><span class="line"><span class="ruby">      - xmlrpc-c-devel</span></span><br></pre></td></tr></table></figure></p><h4 id="useradd"><a href="#useradd" class="headerlink" title="useradd"></a>useradd</h4><p>创建网站运行用户<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/modules/user/www.sls</span> </span><br><span class="line"><span class="attr">www-user-group:</span></span><br><span class="line">  <span class="string">group.present:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - gid:</span> <span class="number">2000</span></span><br><span class="line"></span><br><span class="line">  <span class="string">user.present:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - fullname:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - shell:</span> <span class="string">/sbin/nologin</span></span><br><span class="line"><span class="attr">    - uid:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">    - gid:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">id</span> <span class="string">www</span></span><br></pre></td></tr></table></figure></p><h4 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/nginx/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">nginx</span>]<span class="comment"># tree </span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── nginx-<span class="number">1.12</span>.<span class="number">2</span>.tar.gz</span><br><span class="line">│   ├── nginx-<span class="number">1.16</span>.<span class="number">0</span>.tar.gz</span><br><span class="line">│   ├── nginx.conf.template</span><br><span class="line">│   └── nginx.service.template</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">6</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master nginx]<span class="comment"># cat install.sls </span></span><br><span class="line">&#123;% <span class="keyword">set</span> nginx_<span class="keyword">version</span> = <span class="string">"1.16.0"</span>%&#125;</span><br><span class="line">include:</span><br><span class="line">  - modules.pkg</span><br><span class="line">  - modules.user.www</span><br><span class="line"></span><br><span class="line">nginx-install:</span><br><span class="line">  file.managed:</span><br><span class="line">    - name: <span class="string">/usr/local/src/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - source: salt:<span class="string">//modules/nginx/files/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - mode: 644</span><br><span class="line"></span><br><span class="line">  cmd.run:</span><br><span class="line">    - name: <span class="keyword">cd</span> <span class="string">/usr/local/src/</span> &amp;&amp; tar xf nginx-&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span> &amp;&amp; <span class="keyword">cd</span> nginx-&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; &amp;&amp; <span class="string">./configure</span> <span class="params">--prefix=/usr/local/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; <span class="params">--user=root</span> <span class="params">--group=root</span> <span class="params">--with-http_ssl_module</span> <span class="params">--with-stream</span> <span class="params">--with-http_stub_status_module</span> <span class="params">--with-file-aio</span> <span class="params">--with-http_gzip_static_module</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class="string">/usr/local/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; <span class="string">/usr/local/nginx</span></span><br><span class="line">    - unless: test -d <span class="string">/usr/local/nginx-</span>&#123;&#123; nginx_<span class="keyword">version</span> &#125;&#125; &amp;&amp; test -L <span class="string">/usr/local/nginx</span></span><br><span class="line">    - require:</span><br><span class="line">      - file: nginx-install</span><br><span class="line">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">nginx]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入nginx安装sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.nginx.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#添加systemctl</span></span><br><span class="line"><span class="attr">nginx-init:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/lib/systemd/system/nginx.service</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/nginx/files/nginx.service.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">test</span> <span class="bullet">-f</span> <span class="string">/usr/lib/systemd/system/nginx.service</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">nginx-init</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件</span></span><br><span class="line"><span class="string">/usr/local/nginx/conf/nginx.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/nginx/files/nginx.conf.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动nginx</span></span><br><span class="line"><span class="attr">nginx-service:</span></span><br><span class="line">  <span class="string">file.directory:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/nginx/conf/conf.d</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">nginx-install</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - reload:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">nginx-init</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">/usr/local/nginx/conf/nginx.conf</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">nginx-service</span></span><br></pre></td></tr></table></figure></p><h4 id="php"><a href="#php" class="headerlink" title="php"></a>php</h4><p>1）软件包准备，及配置文件模板，启动文件模板<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/php/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">php</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── php-<span class="number">5.6</span>.<span class="number">40</span>.tar.gz</span><br><span class="line">│   ├── php-fpm.conf.template</span><br><span class="line">│   ├── php-fpm.service.template</span><br><span class="line">│   ├── php-fpm.template</span><br><span class="line">│   └── php.ini.template</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">7</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master php]<span class="comment"># cat install.sls </span></span><br><span class="line">&#123;% <span class="keyword">set</span> php_<span class="keyword">version</span> = <span class="string">"5.6.40"</span> %&#125;</span><br><span class="line">include:</span><br><span class="line">  - modules.pkg</span><br><span class="line"></span><br><span class="line">php-install:</span><br><span class="line">  file.managed:</span><br><span class="line">    - name: <span class="string">/usr/local/src/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - source: salt:<span class="string">//modules/php/files/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - mode: 644</span><br><span class="line"></span><br><span class="line">  cmd.run:</span><br><span class="line">    - name: <span class="keyword">cd</span> <span class="string">/usr/local/src/</span> &amp;&amp; tar xf php-&#123;&#123; php_<span class="keyword">version</span> &#125;&#125;<span class="string">.tar.gz</span> &amp;&amp; <span class="keyword">cd</span> php-&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; &amp;&amp; <span class="string">./configure</span> <span class="params">--prefix=/usr/local/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; <span class="params">--with-curl</span> <span class="params">--with-freetype-dir</span> <span class="params">--with-gd</span> <span class="params">--with-gettext</span> <span class="params">--with-iconv-dir</span> <span class="params">--with-jpeg-dir</span> <span class="params">--with-kerberos</span> <span class="params">--with-libdir=lib64</span> <span class="params">--with-libxml-dir</span> <span class="params">--with-mysql</span> <span class="params">--with-mysqli</span> <span class="params">--with-openssl</span> <span class="params">--with-pcre-regex</span> <span class="params">--with-pdo-mysql</span> <span class="params">--with-dpo-sqlite</span> <span class="params">--with-pear</span> <span class="params">--with-png-dir</span> <span class="params">--with-openssl</span> <span class="params">--with-xmlrpc</span> <span class="params">--with-xsl</span> <span class="params">--with-zlib</span> <span class="params">--enable-fpm</span> <span class="params">--enable-bcmath</span> <span class="params">--enable-libxml</span> <span class="params">--enable-inline-optimization</span> <span class="params">--enable-gd-native-ttf</span> <span class="params">--enable-mbregex</span> <span class="params">--enable-mbstring</span> <span class="params">--enable-opcache</span> <span class="params">--enable-pcntl</span> <span class="params">--enable-shmop</span> <span class="params">--enable-soap</span> <span class="params">--enable-sockets</span> <span class="params">--enable-sysvsem</span> <span class="params">--enable-xml</span> <span class="params">--enable-zip</span> &amp;&amp; make &amp;&amp; make install &amp;&amp; ln -s <span class="string">/usr/local/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; <span class="string">/usr/local/php</span></span><br><span class="line">    - unless: test -d <span class="string">/usr/local/php-</span>&#123;&#123; php_<span class="keyword">version</span> &#125;&#125; &amp;&amp; test -L <span class="string">/usr/local/php</span></span><br><span class="line">    - require:</span><br><span class="line">      - file: php-install</span><br><span class="line">      - pkg: pkg-install</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">php]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入php安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.php.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#php-ini配置文件配置</span></span><br><span class="line"><span class="attr">php-ini:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/php/etc/php.ini</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php.ini.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ln</span> <span class="bullet">-s</span> <span class="string">/usr/local/php/etc/php.ini</span> <span class="string">/etc/php.ini</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">test</span> <span class="bullet">-L</span> <span class="string">/etc/php.ini</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-ini</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#php-fpm配置文件配置</span></span><br><span class="line"><span class="attr">php-fpm:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/php/etc/php-fpm.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php-fpm.conf.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ln</span> <span class="bullet">-s</span> <span class="string">/usr/local/php/etc/php-fpm.conf</span> <span class="string">/etc/php-fpm.conf</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">test</span> <span class="bullet">-L</span> <span class="string">/etc/php-fpm.conf</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-fpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#加入system启动</span></span><br><span class="line"><span class="attr">php-systemd:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/lib/systemd/system/php-fpm.service</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php-fpm.service.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#加入/etc/init.d/启动</span></span><br><span class="line"><span class="attr">php-init:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/init.d/php-fpm</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/php/files/php-fpm.template</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动php-fpm</span></span><br><span class="line"><span class="attr">php-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-systemd</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-ini</span></span><br></pre></td></tr></table></figure></p><h4 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h4><p>1）配置文件模板准备<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/mysql/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">mysql</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   └── my.cnf</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">mysql</span>]<span class="comment"># cat install.sls </span></span><br><span class="line">mariadb-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - pkgs:</span><br><span class="line">      - mariadb-server</span><br><span class="line">      - mariadb</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">mysql]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入mysql安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.mysql.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#my.cnf配置文件</span></span><br><span class="line"><span class="attr">mariadb-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/my.cnf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/mysql/files/my.cnf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">mariadb-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动mariadb</span></span><br><span class="line"><span class="attr">mariadb-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">mariadb</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">mariadb-config</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">mariadb-install</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">mariadb-config</span></span><br></pre></td></tr></table></figure></p><h4 id="lnmp"><a href="#lnmp" class="headerlink" title="lnmp"></a>lnmp</h4><p>1）准备测试文件<code>php info</code> 和<code>nginx</code>虚拟主机配置文件<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/lnmp/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">lnmp</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   ├── index.php</span><br><span class="line">│   └── www.conf</span><br><span class="line">└── www.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>www.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">lnmp]#</span> <span class="string">cat</span> <span class="string">www.sls</span> </span><br><span class="line"><span class="comment">#引入nginx、php、mysql的安装</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.nginx.service</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.php.service</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.mysql.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#虚拟主机web站点目录创建</span></span><br><span class="line"><span class="attr">web-www:</span></span><br><span class="line">  <span class="string">file.directory:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/opt/www</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#虚拟主机配置文件配置</span></span><br><span class="line"><span class="attr">web-www-conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/usr/local/nginx/conf/conf.d/www.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/lnmp/files/www.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">web-www</span></span><br><span class="line"><span class="attr">    - watch_in:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="attr">      PORT:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      IPADDR:</span> <span class="string">&#123;&#123;</span> <span class="string">grains['fqdn_ip4'][0]</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#phpinfo测试文件准备</span></span><br><span class="line"><span class="attr">web-index:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/opt/www/index.php</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/lnmp/files/index.php</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br></pre></td></tr></table></figure></p><h4 id="测试lnmp是否OK"><a href="#测试lnmp是否OK" class="headerlink" title="测试lnmp是否OK"></a>测试lnmp是否OK</h4><p>1）<code>Top file</code>编写<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/top.sls </span><br><span class="line">prod:</span><br><span class="line">  <span class="string">"salt-minion0[3-4]"</span>:</span><br><span class="line">    - modules.lnmp.www</span><br></pre></td></tr></table></figure></p><p>2）执行高级状态<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><p>3）访问测试<br><img src="https://upload-images.jianshu.io/upload_images/11763553-8408fa3d53913156.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="http://192.168.1.31"><br><img src="https://upload-images.jianshu.io/upload_images/11763553-2a3378a0836eb128.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="http://192.168.1.32"></p><h4 id="haproxy"><a href="#haproxy" class="headerlink" title="haproxy"></a>haproxy</h4><p>1）配置文件准备<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/haproxy/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">haproxy</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   └── haproxy.cfg</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">haproxy</span>]<span class="comment"># cat install.sls </span></span><br><span class="line">haproxy-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - name: haproxy</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">haproxy]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入haproxy安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.haproxy.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件</span></span><br><span class="line"><span class="attr">haproxy-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/haproxy/files/haproxy.cfg</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">haproxy-install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动haproxy</span></span><br><span class="line"><span class="attr">haproxy-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">haproxy</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">haproxy-install</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">haproxy-config</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">haproxy-config</span></span><br></pre></td></tr></table></figure></p><h4 id="keepalived"><a href="#keepalived" class="headerlink" title="keepalived"></a>keepalived</h4><p>1）配置文件准备<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cd</span> /srv/salt/prod/modules/keepalived/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   └── keepalived.conf</span><br><span class="line">├── install.sls</span><br><span class="line">└── service.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">3</span> files</span><br></pre></td></tr></table></figure></p><p>2）<code>install.sls</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment"># cat install.sls </span></span><br><span class="line">keepalived-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - name: keepalived</span><br></pre></td></tr></table></figure></p><p>3）<code>service.sls</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">keepalived]#</span> <span class="string">cat</span> <span class="string">service.sls</span> </span><br><span class="line"><span class="comment">#引入keepalived安装的sls</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">modules.keepalived.install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#keepalived配置文件</span></span><br><span class="line"><span class="attr">keepalived-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/keepalived/keepalived.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://modules/keepalived/files/keepalived.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">keepalived-install</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">if</span> <span class="string">grains['fqdn']</span> <span class="string">==</span> <span class="string">"salt-minion01"</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="attr">      ROUTER_ID:</span> <span class="string">saltstack01</span></span><br><span class="line"><span class="attr">      STATE:</span> <span class="string">MASTER</span></span><br><span class="line"><span class="attr">      PRIORITY:</span> <span class="number">150</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">elif</span> <span class="string">grains['fqdn']</span> <span class="string">==</span> <span class="string">"salt-minion02"</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="attr">      ROUTER_ID:</span> <span class="string">saltstack02</span></span><br><span class="line"><span class="attr">      STATE:</span> <span class="string">BACKUP</span></span><br><span class="line"><span class="attr">      PRIORITY:</span> <span class="number">100</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">endif</span> <span class="string">%&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动keepalived</span></span><br><span class="line"><span class="attr">keepalived-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">keepalived</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">keepalived-install</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">keepalived-config</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">keepalived-config</span></span><br></pre></td></tr></table></figure></p><h3 id="整体部署"><a href="#整体部署" class="headerlink" title="整体部署"></a>整体部署</h3><p>1）top file 编写<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/top.sls </span><br><span class="line">prod:</span><br><span class="line">  <span class="string">"salt-minion0[3-4]"</span>:</span><br><span class="line">    - modules.lnmp.www</span><br><span class="line"></span><br><span class="line">  <span class="string">"salt-minion0[1-2]"</span>:</span><br><span class="line">    - modules.haproxy.service</span><br><span class="line">    - modules.keepalived.service</span><br></pre></td></tr></table></figure></p><p>2）高级状态执行<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><p>3）测试<br>访问<code>192.168.1.31</code>和<code>192.168.1.32</code>的状态页<br><img src="https://upload-images.jianshu.io/upload_images/11763553-dbb464867bd87a4c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="http://192.168.1.31:1314/status"><br><img src="https://upload-images.jianshu.io/upload_images/11763553-259e918d1d42933d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="http://192.168.1.32:1314/status"><br>访问VIP<code>192.168.1.100</code><br><img src="https://upload-images.jianshu.io/upload_images/11763553-94dfbc9d07974a44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="http://192.168.1.100"></p><p>通过上面测试可看到可以成功访问<code>lnmp</code>站点，并且<code>haproxy</code>也<code>ok</code>。访问所有四台服务器都可以得到<code>phpinfo</code>页面，而在生产环境中，我们只是对外提供<code>vip</code>即可。</p><h2 id="项目总结"><a href="#项目总结" class="headerlink" title="项目总结"></a>项目总结</h2><p>1）整体环境查看<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# tree /srv/salt/prod/modules/</span><br><span class="line">/srv/salt/prod/modules/</span><br><span class="line">├── haproxy</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   └── haproxy.cfg</span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── keepalived</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   └── keepalived.<span class="keyword">conf</span></span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── lnmp</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   ├── <span class="built_in">index</span>.php</span><br><span class="line">│   │   └── www.<span class="keyword">conf</span></span><br><span class="line">│   └── www.sls</span><br><span class="line">├── mysql</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   └── my.<span class="keyword">cnf</span></span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── nginx</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   ├── nginx-<span class="number">1.12</span>.<span class="number">2</span>.tar.gz</span><br><span class="line">│   │   ├── nginx-<span class="number">1.16</span>.<span class="number">0</span>.tar.gz</span><br><span class="line">│   │   ├── nginx.<span class="keyword">conf</span>.template</span><br><span class="line">│   │   └── nginx.service.template</span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── php</span><br><span class="line">│   ├── <span class="keyword">files</span></span><br><span class="line">│   │   ├── php-<span class="number">5.6</span>.<span class="number">40</span>.tar.gz</span><br><span class="line">│   │   ├── php-fpm.<span class="keyword">conf</span>.template</span><br><span class="line">│   │   ├── php-fpm.service.template</span><br><span class="line">│   │   ├── php-fpm.template</span><br><span class="line">│   │   └── php.ini.template</span><br><span class="line">│   ├── install.sls</span><br><span class="line">│   └── service.sls</span><br><span class="line">├── pkg.sls</span><br><span class="line">└── user</span><br><span class="line">    └── www.sls</span><br><span class="line"></span><br><span class="line"><span class="number">13</span> directories, <span class="number">27</span> <span class="keyword">files</span></span><br></pre></td></tr></table></figure></p><p>2）如果需要在某台服务器上面单独部署某一部分，参考以下写法：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># cat /srv/salt/base/top.sls </span></span><br><span class="line"><span class="meta">#部署lnmp及haproxy+keepalived</span></span><br><span class="line"><span class="symbol">prod:</span></span><br><span class="line">  <span class="string">"salt-minion0[3-4]"</span>:</span><br><span class="line">    - modules.lnmp.www</span><br><span class="line"></span><br><span class="line">  <span class="string">"salt-minion0[1-2]"</span>:</span><br><span class="line">    - modules.haproxy.service</span><br><span class="line">    - modules.keepalived.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#单实例操作说明：</span></span><br><span class="line"><span class="symbol">prod:</span></span><br><span class="line">  <span class="string">"salt-minion04"</span>:</span><br><span class="line">    - modules.nginx.service<span class="meta">#单独安装nginx时</span></span><br><span class="line">    - modules.mysql.service     <span class="meta">#单独安装mysql时</span></span><br><span class="line">    - modules.php.service       <span class="meta">#单独安装php时</span></span><br><span class="line">    - modules.keepalived.service  <span class="meta">#单独安装keepalived时</span></span><br><span class="line">    - modules.haproxy.service   <span class="meta">#单独安装haproxy时</span></span><br><span class="line"></span><br><span class="line">  <span class="string">"salt-minion03"</span>:</span><br><span class="line">    - modules.lnmp.www     <span class="meta">#单独部署lnmp环境时</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;项目架构规划&quot;&gt;&lt;a href=&quot;#项目架构规划&quot; class=&quot;headerlink&quot; title=&quot;项目架构规划&quot;&gt;&lt;/a&gt;项目架构规划&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;后端web服务器使用&lt;code&gt;Nginx+Php&lt;/code&gt;作为站点，通过&lt;c
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack接口salt-api</title>
    <link href="https://leeyj.coding.me/2019/05/20/saltstack%E6%8E%A5%E5%8F%A3salt-api/"/>
    <id>https://leeyj.coding.me/2019/05/20/saltstack接口salt-api/</id>
    <published>2019-05-20T14:04:05.000Z</published>
    <updated>2019-05-23T15:15:21.768Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><a href="https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html" target="_blank" rel="noopener">参考官档</a><br><a href="https://www.unixhot.com/docs/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html#a-rest-api-for-salt" target="_blank" rel="noopener">参考官档</a></p><blockquote><p><code>SaltStack</code>官方提供有<code>REST API</code>格式的<code>salt-api</code>项目，将使<code>salt</code>与第三方系统集成变得更加简单。</p></blockquote><h2 id="salt-api安装配置"><a href="#salt-api安装配置" class="headerlink" title="salt-api安装配置"></a>salt-api安装配置</h2><p>1）在<code>salt-master</code>上进行安装<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install salt-api</span><br></pre></td></tr></table></figure></p><p>2）自签名证书，生产环境可以购买（说明：如果没有<code>salt-call</code>命令，装上<code>salt-minion</code>即可，依赖于该包）<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt-call --local tls.create_self_signed_cert</span></span><br><span class="line"><span class="keyword">local</span>:</span><br><span class="line">    Created Private Key: <span class="string">"/etc/pki/tls/certs/localhost.key."</span> Created Certificate: <span class="string">"/etc/pki/tls/certs/localhost.crt."</span></span><br></pre></td></tr></table></figure></p><p>3）打开<code>include</code>加载子配置文件，方便管理<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">default_include: <span class="literal">master</span>.d/*.conf</span><br></pre></td></tr></table></figure></p><p>4）配置<code>api</code>配置文件，将上面生成的证书写到配置文件<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># vim /etc/salt/master.d/api.conf</span></span><br><span class="line"><span class="symbol">rest_cherrypy:</span></span><br><span class="line"><span class="symbol">  host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.30</span></span><br><span class="line"><span class="symbol">  port:</span> <span class="number">8000</span></span><br><span class="line"><span class="symbol">  ssl_crt:</span> <span class="meta-keyword">/etc/</span>pki<span class="meta-keyword">/tls/</span>certs/localhost.crt</span><br><span class="line"><span class="symbol">  ssl_key:</span> <span class="meta-keyword">/etc/</span>pki<span class="meta-keyword">/tls/</span>certs/localhost.key</span><br></pre></td></tr></table></figure></p><p>5）创建认证用户，并设置密码<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# useradd</span> -M -s /sbin/nologin saltapi</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# echo</span> 'saltapi' | passwd --stdin saltapi</span><br></pre></td></tr></table></figure></p><p>6）创建认证配置文件<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# vim /etc/salt/master.d/auth.conf</span><br><span class="line">external_auth:</span><br><span class="line">  pam:</span><br><span class="line">    saltapi:</span><br><span class="line">      -<span class="ruby"> .*</span></span><br><span class="line"><span class="ruby">      - <span class="string">'@wheel'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'@runner'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'@jobs'</span></span></span><br></pre></td></tr></table></figure></p><p>7）重启<code>salt-master</code>和启动<code>salt-api</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> <span class="literal">start</span> salt-api</span><br></pre></td></tr></table></figure></p><p>8）查看<code>salt-api</code>监听端口<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# netstat -anlutp |grep <span class="number">8000</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>:<span class="number">8000</span>       <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*               LISTEN      <span class="number">10904</span>/python        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>:<span class="number">53414</span>      <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.30</span>:<span class="number">8000</span>       TIME_WAIT   -</span><br></pre></td></tr></table></figure></p><p>9）验证<code>login</code>登录，获取<code>token</code>字符串<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="comment"># curl -sSk https://192.168.1.30:8000/login \</span></span><br><span class="line">&gt;     -H <span class="string">'Accept: application/x-yaml'</span> <span class="string">\</span></span><br><span class="line">&gt;     -d username=saltapi <span class="string">\</span></span><br><span class="line">&gt;     -d password=saltapi <span class="string">\</span></span><br><span class="line">&gt;     -d eauth=pam</span><br><span class="line">return:</span><br><span class="line">- eauth: pam</span><br><span class="line">  expire: <span class="number">1558663247.869537</span></span><br><span class="line">  perms:</span><br><span class="line">  - .*</span><br><span class="line">  - <span class="string">'@wheel'</span></span><br><span class="line">  - <span class="string">'@runner'</span></span><br><span class="line">  - <span class="string">'@jobs'</span></span><br><span class="line">  start: <span class="number">1558620047.869536</span></span><br><span class="line">  token: e8330f642a3addd853c723d63844d29a12de9484</span><br><span class="line">  user: saltapi</span><br></pre></td></tr></table></figure></p><p>10）通过<code>api</code>执行<code>test.ping</code>测试连通性<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>salt-master ~]# curl -sSk https:<span class="comment">//192.168.1.30:8000 \</span></span><br><span class="line">&gt;     -H <span class="string">'Accept: application/x-yaml'</span> \</span><br><span class="line">&gt;     -H <span class="string">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\</span><br><span class="line">&gt;     -d client=local \</span><br><span class="line">&gt;     -d tgt=<span class="string">'*'</span> \</span><br><span class="line">&gt;     -d <span class="function"><span class="keyword">fun</span>=test.ping</span></span><br><span class="line"><span class="keyword">return</span>:</span><br><span class="line">- salt-minion01: <span class="literal">true</span></span><br><span class="line">  salt-minion02: <span class="literal">true</span></span><br><span class="line">  salt-minion03: <span class="literal">true</span></span><br><span class="line">  salt-minion04: <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><p>11）通过<code>api</code>执行<code>cmd.run</code><br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>salt-master ~]# curl -sSk https:<span class="comment">//192.168.1.30:8000 \</span></span><br><span class="line">&gt;     -H <span class="string">'Accept: application/x-yaml'</span> \</span><br><span class="line">&gt;     -H <span class="string">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span>\</span><br><span class="line">&gt;     -d client=local \</span><br><span class="line">&gt;     -d tgt=<span class="string">'*'</span> \</span><br><span class="line">&gt;     -d <span class="function"><span class="keyword">fun</span>='cmd.run' -d arg='uptime'</span></span><br><span class="line"><span class="keyword">return</span>:</span><br><span class="line">- salt-minion01: <span class="string">' 22:10:25 up 46 min,  1 user,  load average: 0.00, 0.01, 0.05'</span></span><br><span class="line">  salt-minion02: <span class="string">' 22:10:25 up 7 min,  0 users,  load average: 0.00, 0.18, 0.15'</span></span><br><span class="line">  salt-minion03: <span class="string">' 22:10:25 up 7 min,  0 users,  load average: 0.06, 0.33, 0.26'</span></span><br><span class="line">  salt-minion04: <span class="string">' 22:10:25 up 7 min,  0 users,  load average: 0.01, 0.21, 0.16'</span></span><br></pre></td></tr></table></figure></p><p>12）通过<code>api</code>获取<code>grains</code>信息`<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master <span class="symbol">~]# curl -sSk https</span>:<span class="comment">//192.168.1.30:8000/minions/salt-minion01 \</span></span><br><span class="line">&gt;     -H 'Accept: application/x-yaml' \</span><br><span class="line">&gt;     -H 'X-Auth-Token: e<span class="number">8330</span>f642a3addd853c723d<span class="number">6384</span>4d29a12de<span class="number">9484</span>'</span><br><span class="line">return:</span><br><span class="line">- salt-minion01:</span><br><span class="line">    SSDs: []</span><br><span class="line">    biosreleasedate: <span class="number">05</span>/<span class="number">19</span>/<span class="number">2017</span></span><br><span class="line">    biosversion: '6.00'</span><br><span class="line">    cpu_flags:</span><br><span class="line">    - fpu</span><br><span class="line">    - vme</span><br><span class="line">    - de</span><br><span class="line">    - pse</span><br><span class="line">    - tsc</span><br><span class="line">.....</span><br></pre></td></tr></table></figure></p><p>13）使用<code>json</code>格式<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# curl -sSk https://<span class="number">192.168</span><span class="number">.1</span><span class="number">.30</span>:<span class="number">8000</span>/minions/salt-minion01 \</span><br><span class="line">&gt;     -<span class="symbol">H</span> <span class="string">'Accept: application/json'</span> \</span><br><span class="line">&gt;     -<span class="symbol">H</span> <span class="string">'X-Auth-Token: e8330f642a3addd853c723d63844d29a12de9484'</span></span><br><span class="line">&#123;<span class="string">"return"</span>: [&#123;<span class="string">"salt-minion01"</span>: &#123;<span class="string">"biosversion"</span>: <span class="string">"6.00"</span>, <span class="string">"kernel"</span>: <span class="string">"Linux"</span>, <span class="string">"domain"</span>: <span class="string">""</span>, <span class="string">"uid"</span>: <span class="number">0</span>, <span class="string">"zmqversion"</span>: <span class="string">"4.1.4"</span>, <span class="string">"kernelrelease"</span>: <span class="string">"3.10.0-693.el7.x86_64"</span>, <span class="string">"selinux"</span>: &#123;<span class="string">"enforced"</span>: <span class="string">"Disabled"</span>, <span class="string">"enabled"</span>: false&#125;, <span class="string">"serialnumber"</span>: <span class="string">"VMware-56 4d 9e a0 21 56 90 87-cd 89 69 32 13 94 17 44"</span>, <span class="string">"pid"</span>: <span class="number">1449</span>, <span class="string">"fqdns"</span>: [], <span class="string">"ip_interfaces"</span>: &#123;<span class="string">"lo"</span>: [<span class="string">"127.0.0.1"</span>, <span class="string">"::1"</span>], <span class="string">"virbr0"</span>: [<span class="string">"192.168.122.1"</span>], <span class="string">"virbr0-nic"</span>: [], <span class="string">"ens33"</span>: [<span class="string">"192.168.1.31"</span>, <span class="string">"192.168.1.100"</span>, <span class="string">"fe80::20c:29ff:fe94:1744"</span>]&#125;, <span class="string">"groupname"</span>: <span class="string">"root"</span>, <span class="string">"fqdn_ip6"</span>: [<span class="string">"fe80::20c:29ff:fe94:1744"</span>],</span><br><span class="line">.......</span><br></pre></td></tr></table></figure></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p><code>salt-api</code>必须使用<code>https</code>，生产环境建议使用可信证书<br>当<code>salt-api</code>服务重启后原<code>token</code>失效</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://docs.saltstack.com/en/latest/ref/netapi/all/salt.neta
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack使用salt-ssh</title>
    <link href="https://leeyj.coding.me/2019/05/20/saltstack%E4%BD%BF%E7%94%A8salt-ssh/"/>
    <id>https://leeyj.coding.me/2019/05/20/saltstack使用salt-ssh/</id>
    <published>2019-05-20T01:43:05.000Z</published>
    <updated>2019-05-23T12:29:57.764Z</updated>
    
    <content type="html"><![CDATA[<h2 id="salt-ssh-介绍"><a href="#salt-ssh-介绍" class="headerlink" title="salt-ssh 介绍"></a>salt-ssh 介绍</h2><p><a href="https://docs.saltstack.com/en/latest/topics/ssh/index.html" target="_blank" rel="noopener">参考官档</a></p><blockquote><p><code>salt-ssh</code>是 <code>0.17.0</code> 新引入的一个功能，不需要minion对客户端进行管理，也可以不需要<code>master</code>；<code>salt-ssh</code>也支持<code>salt</code>大部分的功能：比如<code>grains</code>,<code>modules</code>,<code>state</code>等；<code>salt-ssh</code>没有使用<code>ZeroMQ</code>的通信架构，执行是串行模式</p></blockquote><h2 id="salt-ssh执行原理"><a href="#salt-ssh执行原理" class="headerlink" title="salt-ssh执行原理"></a>salt-ssh执行原理</h2><blockquote><ul><li><code>salt-ssh</code>是在<code>salt</code>基础上打了一个<code>python</code>包上传到客户端的默认<code>tmp</code>目录下, 在客户端上面解压并执行返回结果,最后删除<code>tmp</code>上传的临时文件。</li><li><code>salt-minion</code>方法是<code>salt-mater</code>先执行语法验证，验证通过后发送到<code>minion</code>，<code>minion</code>收到<code>Msater</code>的状态文件默认保存在<code>/var/cache/salt/minion</code></li><li><code>salt-ssh</code>和<code>salt-minion</code>可以共存，<code>salt-minion</code>不依赖于<code>ssh</code>服务</li></ul></blockquote><h2 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h2><p>1）安装<code>salt-ssh</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install salt-ssh</span><br></pre></td></tr></table></figure></p><p>2）修改<code>roster</code>文件，配置需要管理的机器<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">/etc/salt/roster</span></span><br><span class="line"><span class="attr">salt-minion01:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.31</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  passwd:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">22</span></span><br><span class="line"></span><br><span class="line"><span class="attr">salt-minion02:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  passwd:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">22</span></span><br></pre></td></tr></table></figure></p><p>3）管理测试 (说明，如果第一次需要输入<code>yes或no</code>进行<code>ssh</code>认证，可以加<code>-i</code>参数自动认证)<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">salt-ssh</span> <span class="string">'*'</span> <span class="string">test.ping</span> <span class="bullet">-i</span></span><br><span class="line"><span class="attr">salt-minion01:</span></span><br><span class="line">    <span class="literal">True</span></span><br><span class="line"><span class="attr">salt-minion02:</span></span><br><span class="line">    <span class="literal">True</span></span><br></pre></td></tr></table></figure></p><p>4）<code>salt-ssh</code>命令参数<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-r, –raw, –raw-shell <span class="comment"># 直接使用shell命令</span></span><br><span class="line">–priv <span class="comment">#指定SSH私有密钥文件</span></span><br><span class="line">–roster <span class="comment">#定义使用哪个roster系统，如果定义了一个后端数据库，扫描方式，或者用户自定义的的roster系统，默认的就是/etc/salt/roster文件</span></span><br><span class="line">–roster-file <span class="comment">#指定roster文件</span></span><br><span class="line">–refresh, –refresh-<span class="keyword">cache</span> <span class="comment">#刷新cache，如果target的grains改变会自动刷新</span></span><br><span class="line">–<span class="keyword">max</span>-procs <span class="comment">#指定进程数，默认为25</span></span><br><span class="line">-i, –<span class="keyword">ignore</span>-host-<span class="keyword">keys</span> <span class="comment">#当ssh连接时，忽略keys</span></span><br><span class="line">–passwd <span class="comment">#指定默认密码</span></span><br><span class="line">–<span class="keyword">key</span>-deploy <span class="comment">#配置keys 设置这个参数对于所有minions用来部署ssh-key认证，</span></span><br><span class="line"> 这个参和–passwd结合起来使用会使初始化部署很快很方便。当调用<span class="keyword">master</span>模块时，并加上参数 –<span class="keyword">key</span>-deploy 即可在minions生成<span class="keyword">keys</span>，下次开始就不使用密码</span><br></pre></td></tr></table></figure></p><p>5）<code>salt-ssh</code>执行命令<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">salt-ssh</span> <span class="string">'*'</span> <span class="bullet">-r</span> <span class="string">"uptime"</span></span><br><span class="line"><span class="attr">salt-minion01:</span></span><br><span class="line"><span class="bullet">    -</span><span class="bullet">---------</span></span><br><span class="line"><span class="attr">    retcode:</span></span><br><span class="line">        <span class="number">0</span></span><br><span class="line"><span class="attr">    stderr:</span></span><br><span class="line"><span class="attr">    stdout:</span></span><br><span class="line">        <span class="string">root@192.168.1.31's</span> <span class="attr">password:</span> </span><br><span class="line">         <span class="number">10</span><span class="string">:06:08</span> <span class="string">up</span> <span class="number">1</span> <span class="string">day,</span> <span class="number">17</span><span class="string">:05,</span>  <span class="number">2</span> <span class="string">users,</span>  <span class="string">load</span> <span class="attr">average:</span> <span class="number">0.00</span><span class="string">,</span> <span class="number">0.01</span><span class="string">,</span> <span class="number">0.05</span></span><br><span class="line"><span class="attr">salt-minion02:</span></span><br><span class="line"><span class="bullet">    -</span><span class="bullet">---------</span></span><br><span class="line"><span class="attr">    retcode:</span></span><br><span class="line">        <span class="number">0</span></span><br><span class="line"><span class="attr">    stderr:</span></span><br><span class="line"><span class="attr">    stdout:</span></span><br><span class="line">        <span class="string">root@192.168.1.32's</span> <span class="attr">password:</span> </span><br><span class="line">         <span class="number">10</span><span class="string">:06:08</span> <span class="string">up</span> <span class="number">1</span> <span class="string">day,</span> <span class="number">17</span><span class="string">:16,</span>  <span class="number">2</span> <span class="string">users,</span>  <span class="string">load</span> <span class="attr">average:</span> <span class="number">0.03</span><span class="string">,</span> <span class="number">0.06</span><span class="string">,</span> <span class="number">0.06</span></span><br></pre></td></tr></table></figure></p><p>6）<code>salt-ssh</code>执行状态模块<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# salt-ssh <span class="emphasis">'*'</span> state.sls modules.haproxy.service saltenv=prod</span><br><span class="line">salt-minion02:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-install</span></span><br><span class="line"><span class="code">    Function: pkg.installed</span></span><br><span class="line"><span class="code">        Name: haproxy</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: All specified packages are already installed</span></span><br><span class="line"><span class="code">     Started: 10:09:48.541019</span></span><br><span class="line"><span class="code">    Duration: 10161.705 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-config</span></span><br><span class="line"><span class="code">    Function: file.managed</span></span><br><span class="line"><span class="code">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class="line"><span class="code">     Started: 10:09:59.020659</span></span><br><span class="line"><span class="code">    Duration: 54.263 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-service</span></span><br><span class="line"><span class="code">    Function: service.running</span></span><br><span class="line"><span class="code">        Name: haproxy</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: The service haproxy is already running</span></span><br><span class="line"><span class="code">     Started: 10:09:59.079110</span></span><br><span class="line"><span class="code">    Duration: 128.052 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion02</span><br><span class="line">------------</span><br><span class="line">Succeeded: 3</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     3</span><br><span class="line">Total run time:  10.344 s</span><br><span class="line">salt-minion01:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-install</span></span><br><span class="line"><span class="code">    Function: pkg.installed</span></span><br><span class="line"><span class="code">        Name: haproxy</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: All specified packages are already installed</span></span><br><span class="line"><span class="code">     Started: 10:10:00.561015</span></span><br><span class="line"><span class="code">    Duration: 2862.018 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-config</span></span><br><span class="line"><span class="code">    Function: file.managed</span></span><br><span class="line"><span class="code">        Name: /etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: File /etc/haproxy/haproxy.cfg is in the correct state</span></span><br><span class="line"><span class="code">     Started: 10:10:03.905713</span></span><br><span class="line"><span class="code">    Duration: 220.443 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: haproxy-service</span></span><br><span class="line"><span class="code">    Function: service.running</span></span><br><span class="line"><span class="code">        Name: haproxy</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: The service haproxy is already running</span></span><br><span class="line"><span class="code">     Started: 10:10:04.135607</span></span><br><span class="line"><span class="code">    Duration: 230.231 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 3</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     3</span><br><span class="line">Total run time:   3.313 s</span><br></pre></td></tr></table></figure></p><h2 id="Roster说明"><a href="#Roster说明" class="headerlink" title="Roster说明"></a>Roster说明</h2><blockquote><p><code>salt-ssh</code>需要一个名单系统来确定哪些执行目标，<code>Salt</code>的<code>0.17.0</code>版本中<code>salt-ssh</code>引入<code>roste</code>r系统<br><code>roster</code>系统编译成了一个数据结构，包含了<code>targets</code>，这些<code>targets</code>是一个目标系统主机列表和或如连接到这些<code>targets</code>。</p></blockquote><p>配置文件说明：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># target的信息</span></span><br><span class="line"><span class="symbol">    host:</span>        <span class="meta"># 远端主机的ip地址或者dns域名</span></span><br><span class="line"><span class="symbol">    user:</span>        <span class="meta"># 登录的用户</span></span><br><span class="line"><span class="symbol">    passwd:</span>      <span class="meta"># 用户密码,如果不使用此选项，则默认使用秘钥方式</span></span><br><span class="line"><span class="meta"># 可选的部分</span></span><br><span class="line"><span class="symbol">    port:</span>        <span class="meta">#ssh端口</span></span><br><span class="line"><span class="symbol">    sudo:</span>        <span class="meta">#可以通过sudo</span></span><br><span class="line"><span class="symbol">    tty:</span>         <span class="meta"># 如果设置了sudo，设置这个参数为true</span></span><br><span class="line"><span class="symbol">    priv:</span>        <span class="meta"># ssh秘钥的文件路径</span></span><br><span class="line"><span class="symbol">    timeout:</span>     <span class="meta"># 当建立链接时等待响应时间的秒数</span></span><br><span class="line"><span class="symbol">    minion_opts:</span> <span class="meta"># minion的位置路径</span></span><br><span class="line"><span class="symbol">    thin_dir:</span>    <span class="meta"># target系统的存储目录，默认是/tmp/salt-&lt;hash&gt;</span></span><br><span class="line"><span class="symbol">    cmd_umask:</span>   <span class="meta"># 使用salt-call命令的umask值</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;salt-ssh-介绍&quot;&gt;&lt;a href=&quot;#salt-ssh-介绍&quot; class=&quot;headerlink&quot; title=&quot;salt-ssh 介绍&quot;&gt;&lt;/a&gt;salt-ssh 介绍&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://docs.saltstack.co
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack数据系统</title>
    <link href="https://leeyj.coding.me/2019/05/17/saltstack%E6%95%B0%E6%8D%AE%E7%B3%BB%E7%BB%9F/"/>
    <id>https://leeyj.coding.me/2019/05/17/saltstack数据系统/</id>
    <published>2019-05-17T09:31:05.000Z</published>
    <updated>2019-05-17T13:23:21.439Z</updated>
    
    <content type="html"><![CDATA[<h2 id="数据系统Grains"><a href="#数据系统Grains" class="headerlink" title="数据系统Grains"></a>数据系统Grains</h2><blockquote><p>1、<code>Grains</code>是<code>SaltStack</code>收集的有关底层管理系统的静态信息。包括操作系统版本、域名、IP地址、内存、内核、CPU、操作系统类型以及许多其他系统属性。<code>Minion</code> 收集的信息，可以作为<code>Master</code>端匹配目标。<br>2、如果需要自定义<code>grains</code>，需要添加到<code>Salt Minion</code>的<code>/etc/salt/grains</code>文件中（配置文件中定义的默认路径），也可以直接写在配置文件<code>/etc/salt/minion</code>中</p></blockquote><p><a href="https://docs.saltstack.com/en/latest/topics/grains/" target="_blank" rel="noopener">Grains官方文档</a><br>1）资产管理，信息查询<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#列出所有可用的grains状态模块</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> grains.ls</span></span><br><span class="line"><span class="meta">#打印所有状态信息</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> grains.items</span></span><br><span class="line"><span class="meta">#列出每台minion的本地IP地址</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> grains.item fqdn_ip4</span></span><br><span class="line"><span class="meta">#列出每台minion的操作系统</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> grains.item os</span></span><br></pre></td></tr></table></figure></p><p>2）用于匹配<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -G <span class="string">'os:CentOS'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -G <span class="string">'localhost:salt-minion01'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><p>3）<code>minion</code>自定义<code>grains</code><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#1.修改配置文件，自定义grains</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># vim /etc/salt/minion</span></span><br><span class="line">grains:</span><br><span class="line">  roles:</span><br><span class="line">    - webserver</span><br><span class="line">    - memcache</span><br><span class="line">  ipaddr:</span><br><span class="line">    - <span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#2.重启minion</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># systemctl restart salt-minion</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#3.master上测试</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -G <span class="string">'ipaddr:192.168.1.32'</span> test.ping </span></span><br><span class="line">salt-minion01:</span><br><span class="line">    <span class="literal">True</span></span><br></pre></td></tr></table></figure></p><p>4）<code>Grains</code>优先级问题<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、Grains默认核心信息</span><br><span class="line"><span class="number">2</span>、自定义写在/etc/salt/grains文件中的</span><br><span class="line"><span class="number">3</span>、自定义写在/etc/salt/minion文件中的</span><br></pre></td></tr></table></figure></p><h2 id="数据系统Pillar"><a href="#数据系统Pillar" class="headerlink" title="数据系统Pillar"></a>数据系统Pillar</h2><blockquote><p><code>Pillar</code>是动态的，<code>Pillar</code>存储在<code>master</code>上，提供给<code>minion</code>。<br><code>Pillar</code>主要记录一些加密信息，可以确保这些敏感数据不被其他<code>minion</code>看到。比如：软件版本号、用户名密码等。存储格式都是<code>YAML</code>格式</p></blockquote><p>1）在<code>Master</code>端定义<code>Pillar</code><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">pillar_roots:</span><br><span class="line">  base:</span><br><span class="line">    - /srv/pillar</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> /srv/pillar</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/pillar/zabbix.sls </span><br><span class="line">Zabbix_Server: <span class="number">192.168</span>.<span class="number">1.11</span></span><br><span class="line">Zabbix_Name: zabbix.examp.com</span><br></pre></td></tr></table></figure></p><p>2）编写<code>TopFile</code>指定<code>Minion</code>端可以使用<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@salt-master ~</span>]<span class="meta"># cat /srv/pillar/top.sls </span></span><br><span class="line"><span class="keyword">base</span>:</span><br><span class="line">  <span class="string">'salt-minion01'</span>:</span><br><span class="line">    - zabbix</span><br></pre></td></tr></table></figure></p><p>3）刷新<code>Pillar</code><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> saltutil.refresh_pillar</span></span><br></pre></td></tr></table></figure></p><p>4）获取对应<code>pillar</code>值<br><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> pillar.items</span><br><span class="line">salt-<span class="name">minion01</span>:</span><br><span class="line">    <span class="comment">----------</span></span><br><span class="line">    <span class="name">Zabbix_Name</span>:</span><br><span class="line">        zabbix.examp.com</span><br><span class="line">    <span class="name">Zabbix_Server</span>:</span><br><span class="line">        <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span></span><br><span class="line">salt-<span class="name">minion03</span>:</span><br><span class="line">    <span class="comment">----------</span></span><br><span class="line">salt-<span class="name">minion02</span>:</span><br><span class="line">    <span class="comment">----------</span></span><br><span class="line"></span><br><span class="line">#获取指定的key</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'salt-minion01'</span> pillar.item Zabbix_Server</span><br><span class="line">salt-<span class="name">minion01</span>:</span><br><span class="line">    <span class="comment">----------</span></span><br><span class="line">    <span class="name">Zabbix_Server</span>:</span><br><span class="line">        <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span></span><br></pre></td></tr></table></figure></p><blockquote><p>说明：如果<code>Master</code>更新了新的数值，需要刷新<code>Pillar</code>到<code>Minion</code>才可以获取</p></blockquote><blockquote><p><code>Pirrar</code>与<code>Grains</code>对比<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">类型     数据采集方式   应用场景                   定义位置</span><br><span class="line">Grains   静态         minion启动时收集  数据查询  目标选择  配置管理   minion</span><br><span class="line">Pillar   动态         <span class="literal">master</span>进行自定义  目标选择  配置管理  敏感数据   <span class="literal">master</span></span><br></pre></td></tr></table></figure></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;数据系统Grains&quot;&gt;&lt;a href=&quot;#数据系统Grains&quot; class=&quot;headerlink&quot; title=&quot;数据系统Grains&quot;&gt;&lt;/a&gt;数据系统Grains&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;1、&lt;code&gt;Grains&lt;/code&gt;是&lt;co
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack状态判断unless与onlyif</title>
    <link href="https://leeyj.coding.me/2019/05/17/saltstack%E7%8A%B6%E6%80%81%E5%88%A4%E6%96%ADunless%E4%B8%8Eonlyif/"/>
    <id>https://leeyj.coding.me/2019/05/17/saltstack状态判断unless与onlyif/</id>
    <published>2019-05-17T07:43:05.000Z</published>
    <updated>2019-05-17T13:23:21.440Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>很多时候我们在编写<code>state</code> 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的<code>unless</code>和<code>onlyif</code>。</p></blockquote><h2 id="unless"><a href="#unless" class="headerlink" title="unless"></a>unless</h2><p><code>unless</code>示例：需求创建<code>/tmp/unless.txt</code>文件，存在则不创建，不存在则创建<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /srv/salt/prod/unless.sls </span><br><span class="line">test-unless:</span><br><span class="line"><span class="code">  cmd.run:</span></span><br><span class="line"><span class="code">    - name: touch /tmp/unless.txt</span></span><br><span class="line"><span class="code">    - unless: test -f /tmp/unless.txt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# salt <span class="emphasis">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class="line">salt-minion01:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: test-unless</span></span><br><span class="line"><span class="code">    Function: cmd.run</span></span><br><span class="line"><span class="code">        Name: touch /tmp/unless.txt</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: Command "touch /tmp/unless.txt" run</span></span><br><span class="line"><span class="code">     Started: 15:10:51.522319</span></span><br><span class="line"><span class="code">    Duration: 31.822 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"><span class="code">              ----------</span></span><br><span class="line"><span class="code">              pid:</span></span><br><span class="line"><span class="code">                  6538</span></span><br><span class="line"><span class="code">              retcode:</span></span><br><span class="line"><span class="code">                  0</span></span><br><span class="line"><span class="code">              stderr:</span></span><br><span class="line"><span class="code">              stdout:</span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 1 (changed=1)</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     1</span><br><span class="line">Total run time:  31.822 ms</span><br><span class="line">#上面第一次执行，可以看到发生了一次更改，创建了 /tmp/unless.txt文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# salt <span class="emphasis">'salt-minion01'</span> state.sls unless saltenv=prod</span><br><span class="line">salt-minion01:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: test-unless</span></span><br><span class="line"><span class="code">    Function: cmd.run</span></span><br><span class="line"><span class="code">        Name: touch /tmp/unless.txt</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: unless condition is true</span></span><br><span class="line"><span class="code">     Started: 15:11:40.819789</span></span><br><span class="line"><span class="code">    Duration: 10.477 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 1</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     1</span><br><span class="line">Total run time:  10.477 ms</span><br><span class="line">#第二次执行，可以看到该文件已经存在，并没有再次创建</span><br></pre></td></tr></table></figure></p><blockquote><p>通过上面的小案例可以看出，当<code>unless</code>返回为真则不执行，当<code>unless</code>返回为假才执行。</p></blockquote><h2 id="onlyif"><a href="#onlyif" class="headerlink" title="onlyif"></a>onlyif</h2><blockquote><p><code>onlyif</code>正好和<code>unless</code>相反，当<code>onlyif</code>返回为真执行，当<code>onlyif</code>返回为假不执行</p></blockquote><p><code>onlyif</code>示例：需求，当<code>/tmp/onlyif.txt</code>文件存在，则创建<code>/tmp/onlyif</code>目录，不存在，则不创建<code>/tmp/onlyif</code>目录<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /srv/salt/prod/onlyif.sls </span><br><span class="line">test-onlyif:</span><br><span class="line"><span class="code">  cmd.run:</span></span><br><span class="line"><span class="code">    - name: mkdir /tmp/onlyif</span></span><br><span class="line"><span class="code">    - onlyif: test -f /tmp/onlyif.txt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@salt-master ~]# salt <span class="emphasis">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class="line">salt-minion01:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: test-onlyif</span></span><br><span class="line"><span class="code">    Function: cmd.run</span></span><br><span class="line"><span class="code">        Name: mkdir /tmp/onlyif</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: onlyif condition is false</span></span><br><span class="line"><span class="code">     Started: 15:34:56.460583</span></span><br><span class="line"><span class="code">    Duration: 9.612 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 1</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     1</span><br><span class="line">Total run time:   9.612 ms</span><br><span class="line"></span><br><span class="line">#通过上面可以看到，由于/tmp/onlyif.txt文件不存在，并没有创建；手动创建一个/tmp/onlyif.txt文件再次执行</span><br><span class="line">[root@salt-master ~]# salt <span class="emphasis">'salt-minion01'</span> cmd.run "touch /tmp/onlyif.txt"</span><br><span class="line">salt-minion01:</span><br><span class="line">[root@salt-master ~]# salt <span class="emphasis">'salt-minion01'</span> state.sls onlyif saltenv=prod</span><br><span class="line">salt-minion01:</span><br><span class="line">----------</span><br><span class="line"><span class="code">          ID: test-onlyif</span></span><br><span class="line"><span class="code">    Function: cmd.run</span></span><br><span class="line"><span class="code">        Name: mkdir /tmp/onlyif</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: Command "mkdir /tmp/onlyif" run</span></span><br><span class="line"><span class="code">     Started: 15:38:07.712492</span></span><br><span class="line"><span class="code">    Duration: 14.646 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"><span class="code">              ----------</span></span><br><span class="line"><span class="code">              pid:</span></span><br><span class="line"><span class="code">                  6871</span></span><br><span class="line"><span class="code">              retcode:</span></span><br><span class="line"><span class="code">                  0</span></span><br><span class="line"><span class="code">              stderr:</span></span><br><span class="line"><span class="code">              stdout:</span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 1 (changed=1)</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     1</span><br><span class="line">Total run time:  14.646 ms</span><br><span class="line"></span><br><span class="line">#可以看到上面我们手动创建了一个/tmp/onlyif.txt文件后再次执行，则发生了改变，在/tmp/创建了onlyif目录</span><br></pre></td></tr></table></figure></p><h2 id="Redis主从架构案例"><a href="#Redis主从架构案例" class="headerlink" title="Redis主从架构案例"></a>Redis主从架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br><img src="https://upload-images.jianshu.io/upload_images/11763553-bc3bd43a55d275ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="redis主从环境"></p><p>1）环境准备，定义<code>file_roots</code>环境<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># vim /etc/salt/master</span></span><br><span class="line"><span class="symbol">file_roots:</span></span><br><span class="line"><span class="symbol">  base:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/base</span><br><span class="line"><span class="symbol">  dev:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/dev</span><br><span class="line"><span class="symbol">  prod:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p><p>2）创建对应环境目录<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/prod/redis/files/</span><br></pre></td></tr></table></figure></p><p>3）编写<code>state sls</code>状态文件<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#初始化redis（安装和基本配置）</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/redis/init.sls</span> </span><br><span class="line"><span class="attr">redis-install:</span></span><br><span class="line">  <span class="string">pkg.installed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line"><span class="attr">redis-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/redis.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://redis/files/redis.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="attr">      BIND:</span> <span class="string">&#123;&#123;</span> <span class="string">grains['fqdn_ip4'][0]</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">      PORT:</span> <span class="number">6379</span></span><br><span class="line"><span class="attr">      DAEMONIZA:</span> <span class="string">'yes'</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">redis-install</span></span><br><span class="line"></span><br><span class="line"><span class="attr">redis-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">redis-config</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#master直接引入 init</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/redis/master.sls</span> </span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">redis.init</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#slave引入init 并配置主从信息</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/redis/slave.sls</span> </span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">redis.init</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置主从</span></span><br><span class="line"><span class="attr">slave-config:</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">redis-cli</span> <span class="bullet">-h</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.34</span> <span class="string">slaveof</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.33</span> <span class="number">6379</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">redis-cli</span> <span class="bullet">-h</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.34</span> <span class="string">info</span> <span class="string">|grep</span> <span class="attr">role:slave</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">redis-service</span></span><br><span class="line"></span><br><span class="line"><span class="string">说明：</span></span><br><span class="line"><span class="string">unless：返回为真则不执行，反之为假则执行</span></span><br></pre></td></tr></table></figure></p><p>4）配置文件准备<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# <span class="keyword">grep</span> <span class="string">"^[a-Z]"</span> /etc/redis.<span class="keyword">conf</span>  &gt;&gt;/srv/salt/prod/redis/<span class="keyword">files</span>/redis.<span class="keyword">conf</span></span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/prod/redis/<span class="keyword">files</span>/redis.<span class="keyword">conf</span> </span><br><span class="line">#这里使用jinja</span><br><span class="line">bind &#123;&#123; BIND &#125;&#125;</span><br><span class="line">protected-<span class="keyword">mode</span> yes</span><br><span class="line">#这里使用jinja</span><br><span class="line">port &#123;&#123; PORT &#125;&#125;</span><br><span class="line">tcp-backlog <span class="number">511</span></span><br><span class="line">timeout <span class="number">0</span></span><br><span class="line">tcp-keepalive <span class="number">300</span></span><br><span class="line">#这里使用jinja</span><br><span class="line">daemonize &#123;&#123; DAEMONIZA &#125;&#125;</span><br><span class="line">supervised <span class="keyword">no</span></span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis.<span class="built_in">log</span></span><br><span class="line">databases <span class="number">16</span></span><br><span class="line">save <span class="number">900</span> <span class="number">1</span></span><br><span class="line">save <span class="number">300</span> <span class="number">10</span></span><br><span class="line">save <span class="number">60</span> <span class="number">10000</span></span><br><span class="line"><span class="keyword">stop</span>-writes-<span class="keyword">on</span>-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /var/lib/redis</span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line">slave-<span class="keyword">read</span>-<span class="keyword">only</span> yes</span><br><span class="line">repl-diskless-<span class="keyword">sync</span> <span class="keyword">no</span></span><br><span class="line">repl-diskless-<span class="keyword">sync</span>-delay <span class="number">5</span></span><br><span class="line">repl-disable-tcp-nodelay <span class="keyword">no</span></span><br><span class="line">slave-priority <span class="number">100</span></span><br><span class="line">appendonly <span class="keyword">no</span></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="keyword">no</span>-appendfsync-<span class="keyword">on</span>-rewrite <span class="keyword">no</span></span><br><span class="line">auto-aof-rewrite-percentage <span class="number">100</span></span><br><span class="line">auto-aof-rewrite-<span class="built_in">min</span>-size <span class="number">64</span>mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line"><span class="keyword">lua</span>-time-limit <span class="number">5000</span></span><br><span class="line">slowlog-<span class="built_in">log</span>-slower-than <span class="number">10000</span></span><br><span class="line">slowlog-<span class="built_in">max</span>-<span class="built_in">len</span> <span class="number">128</span></span><br><span class="line">latency-monitor-threshold <span class="number">0</span></span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br><span class="line">hash-<span class="built_in">max</span>-ziplist-entries <span class="number">512</span></span><br><span class="line">hash-<span class="built_in">max</span>-ziplist-value <span class="number">64</span></span><br><span class="line"><span class="keyword">list</span>-<span class="built_in">max</span>-ziplist-size -<span class="number">2</span></span><br><span class="line"><span class="keyword">list</span>-compress-depth <span class="number">0</span></span><br><span class="line"><span class="keyword">set</span>-<span class="built_in">max</span>-intset-entries <span class="number">512</span></span><br><span class="line">zset-<span class="built_in">max</span>-ziplist-entries <span class="number">128</span></span><br><span class="line">zset-<span class="built_in">max</span>-ziplist-value <span class="number">64</span></span><br><span class="line">hll-sparse-<span class="built_in">max</span>-bytes <span class="number">3000</span></span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-<span class="keyword">buffer</span>-limit <span class="keyword">normal</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">client-output-<span class="keyword">buffer</span>-limit slave <span class="number">256</span>mb <span class="number">64</span>mb <span class="number">60</span></span><br><span class="line">client-output-<span class="keyword">buffer</span>-limit pubsub <span class="number">32</span>mb <span class="number">8</span>mb <span class="number">60</span></span><br><span class="line">hz <span class="number">10</span></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure></p><p>5）<code>top file</code>文件编写<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/top.sls </span><br><span class="line">prod:</span><br><span class="line">  'salt-minion02':</span><br><span class="line">    - redis.<span class="literal">master</span></span><br><span class="line">  'salt-minion03':</span><br><span class="line">    - redis.<span class="literal">slave</span></span><br></pre></td></tr></table></figure></p><p>6）整体<code>state</code>文件查看<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# tree</span> /srv/salt/prod/redis/</span><br><span class="line">/srv/salt/prod/redis/</span><br><span class="line">├── files</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── init.sls</span><br><span class="line">├── <span class="literal">master</span>.sls</span><br><span class="line">└── <span class="literal">slave</span>.sls</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">4</span> files</span><br></pre></td></tr></table></figure></p><p>7）<code>top file</code>高级状态执行<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先测试下看下状态文件是否编写正确，再正式执行</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' state.highstate <span class="attr">test=</span><span class="literal">True</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' state.highstate</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;很多时候我们在编写&lt;code&gt;state&lt;/code&gt; 文件时候需要进行判断，判断该目录或文件是否存在，判断该配置是否已经已添加，然后根据判断结果再决定命令或动作是否执行，这时候就需要用到了状态判断的&lt;code&gt;unless&lt;/code&gt;和&lt;cod
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack配置管理</title>
    <link href="https://leeyj.coding.me/2019/05/15/saltstack%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/"/>
    <id>https://leeyj.coding.me/2019/05/15/saltstack配置管理/</id>
    <published>2019-05-15T15:42:05.000Z</published>
    <updated>2019-05-17T13:23:02.898Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Saltstack状态模块"><a href="#Saltstack状态模块" class="headerlink" title="Saltstack状态模块"></a>Saltstack状态模块</h2><blockquote><p>远程执行模块的执行是过程式，而状态是对<code>minion</code>的一种描述和定义，管理人员不需要关系部署任务如何完成的，只需要描述<code>minion</code>的状态描述。<br>它的和兴是写<code>sls(Salt State file)</code>文件，<code>sls</code>文件默认格式为<code>YAML</code>格式，并默认使用<code>jinja</code>模板，<code>jinja</code>是根据<code>django</code>的模板语言发展而来的语言，简单并强大，支持<code>for if</code>等循环语句。<code>salt state</code>主要用来描述系统，服务，配置文件的状态，常常被称为配置管理。</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql-<span class="keyword">install</span>:   <span class="comment">#ID声明，必须唯一</span></span><br><span class="line">  pkg.installed:   <span class="comment">#state状态声明</span></span><br><span class="line">    - pkgs:   <span class="comment">#选项声明</span></span><br><span class="line">      - mariadb:   <span class="comment">#选项列表</span></span><br><span class="line">      - mariadb-<span class="keyword">server</span></span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line">一个<span class="keyword">ID</span>只能出现一次</span><br><span class="line">一个<span class="keyword">ID</span>下相同模块只能使用一次</span><br><span class="line">一个<span class="keyword">ID</span>下不可以使用多个不同模块</span><br></pre></td></tr></table></figure><p>模块帮助手册<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#列出所有状态模块</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> sys.list_modules</span></span><br><span class="line"><span class="meta">#查看指定模块的所有方法</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> sys.list_state_functions pkg</span></span><br><span class="line"><span class="meta">#查看指定模块的使用方法</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> sys.state_doc pkg</span></span><br><span class="line"><span class="meta">#查看指定模块的指定方法的用法</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> sys.state_doc pkg.installed</span></span><br></pre></td></tr></table></figure></p><h3 id="pkg软件模块"><a href="#pkg软件模块" class="headerlink" title="pkg软件模块"></a>pkg软件模块</h3><p><a href="https://docs.saltstack.com/en/latest/ref/states/all/salt.states.pkg.html" target="_blank" rel="noopener">pkg模块官档</a><br><code>pkg.installed</code> 软件安装<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">php-install:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    -<span class="ruby"> <span class="symbol">pkgs:</span></span></span><br><span class="line"><span class="ruby">      - php</span></span><br><span class="line"><span class="ruby">      - php-<span class="symbol">mysql:</span> <span class="string">"&gt;=5.4.16"</span>    <span class="comment">#指定安装版本</span></span></span><br><span class="line"><span class="ruby">      - php-pdo</span></span><br><span class="line"><span class="ruby">      - php-cli</span></span><br></pre></td></tr></table></figure></p><p>指定安装最新版本的软件<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">php-install:</span><br><span class="line">  pkg.latest:</span><br><span class="line">    -<span class="ruby"> <span class="symbol">pkgs:</span></span></span><br><span class="line"><span class="ruby">      - php</span></span><br><span class="line"><span class="ruby">      - php-mysql</span></span><br><span class="line"><span class="ruby">      - php-pdo</span></span><br><span class="line"><span class="ruby">      - php-cli</span></span><br></pre></td></tr></table></figure></p><h3 id="file文件模块"><a href="#file文件模块" class="headerlink" title="file文件模块"></a>file文件模块</h3><p><a href="https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html" target="_blank" rel="noopener">file模块官档</a><br><code>file.managed</code> 下发文件，确保文件存在<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# <span class="built_in">mkdir</span> /srv/salt/base/<span class="keyword">files</span></span><br><span class="line">[root@salt-master ~]# <span class="keyword">cp</span> /etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span> /srv/salt/base/<span class="keyword">files</span>/</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class="line">apache-confi<span class="variable">g:</span></span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - name: /etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - <span class="keyword">mode</span>: <span class="number">644</span></span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line">- name: 表示存放目的地址</span><br><span class="line">- <span class="keyword">source</span>: 表示这个文件来自哪里（说明这个文件得提前准备）</span><br><span class="line"></span><br><span class="line">或者这样写，直接已目的地址命令ID，这样ID也表示目的地址</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/base/apache_conf.sls</span><br><span class="line">/etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span>:</span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - <span class="keyword">mode</span>: <span class="number">644</span></span><br></pre></td></tr></table></figure></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">小示例：</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/test.sls</span><br><span class="line">/tmp/passwd_back:</span><br><span class="line">  file.managed:</span><br><span class="line">    - source: salt://files/passwd</span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - mode: <span class="number">644</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cp</span> /etc/passwd /srv/salt/base/files/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' state.sls test</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' cmd.run <span class="string">"ls -l /tmp/passwd_back"</span></span><br><span class="line">salt-minion03:</span><br><span class="line">    -rw-r--r-- <span class="number">1</span> root root <span class="number">2098</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">21</span> /tmp/passwd_back</span><br><span class="line">salt-minion02:</span><br><span class="line">    -rw-r--r-- <span class="number">1</span> root root <span class="number">2098</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">21</span> /tmp/passwd_back</span><br><span class="line">salt-minion01:</span><br><span class="line">    -rw-r--r-- <span class="number">1</span> root root <span class="number">2098</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">21</span> /tmp/passwd_back</span><br></pre></td></tr></table></figure><p><code>file.directory</code> 建立目录<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cat</span> /srv/salt/base/directory.sls</span><br><span class="line">/tmp/saltdir:</span><br><span class="line">  file.directory:</span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - mode: <span class="number">755</span></span><br><span class="line">    - makedirs: <span class="literal">True</span>   <span class="comment">#如果上一级目录不存在自动创建；类似（mkdir -p）</span></span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' state.sls directory</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> '*' cmd.run <span class="string">"ls -d /tmp/saltdir"</span></span><br><span class="line">salt-minion03:</span><br><span class="line">    /tmp/saltdir</span><br><span class="line">salt-minion02:</span><br><span class="line">    /tmp/saltdir</span><br><span class="line">salt-minion01:</span><br><span class="line">    /tmp/saltdir</span><br></pre></td></tr></table></figure></p><p><code>file.recurse</code> 下发整个目录<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/base/httpd_conf_dir.sls</span></span><br><span class="line"><span class="attr">httpd_conf_dir:</span></span><br><span class="line">  <span class="string">file.recurse:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/httpd/conf.d</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/conf.d</span></span><br><span class="line"><span class="attr">    - file_mode:</span> <span class="number">600</span>    <span class="comment">#文件权限</span></span><br><span class="line"><span class="attr">    - dir_mode:</span> <span class="number">755</span>    <span class="comment">#目录权限</span></span><br><span class="line"><span class="attr">    - include_empty:</span> <span class="literal">True</span>   <span class="comment">#同步空目录</span></span><br><span class="line"><span class="attr">    - clean:</span> <span class="literal">True</span>    <span class="comment">#使用后minion与master保持一致</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">rsync</span> <span class="bullet">-avh</span> <span class="string">/etc/httpd/conf.d</span> <span class="string">/srv/salt/base/files/</span></span><br></pre></td></tr></table></figure></p><p><code>file.symlink</code> 建立软链接<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># cat /srv/salt/base/target_link.sls</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>grub.cfg:</span><br><span class="line">  file.symlink:</span><br><span class="line">    - target: <span class="meta-keyword">/etc/</span>grub2.cfg</span><br><span class="line"></span><br><span class="line">[root@salt-master ~]<span class="meta"># salt <span class="string">'*'</span> state.sls target_link</span></span><br><span class="line">[root@salt-master ~]<span class="meta"># salt <span class="string">'*'</span> cmd.run <span class="string">"ls -l /etc/grub.cfg"</span></span></span><br><span class="line">salt-minion03:</span><br><span class="line">    lrwxrwxrwx <span class="number">1</span> root root <span class="number">14</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">42</span> <span class="meta-keyword">/etc/</span>grub.cfg -&gt; <span class="meta-keyword">/etc/</span>grub2.cfg</span><br><span class="line">salt-minion01:</span><br><span class="line">    lrwxrwxrwx <span class="number">1</span> root root <span class="number">14</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">42</span> <span class="meta-keyword">/etc/</span>grub.cfg -&gt; <span class="meta-keyword">/etc/</span>grub2.cfg</span><br><span class="line">salt-minion02:</span><br><span class="line">    lrwxrwxrwx <span class="number">1</span> root root <span class="number">14</span> May <span class="number">15</span> <span class="number">16</span>:<span class="number">42</span> <span class="meta-keyword">/etc/</span>grub.cfg -&gt; <span class="meta-keyword">/etc/</span>grub2.cfg</span><br></pre></td></tr></table></figure></p><h3 id="service服务模块"><a href="#service服务模块" class="headerlink" title="service服务模块"></a>service服务模块</h3><p><a href="https://docs.saltstack.com/en/latest/ref/states/all/salt.states.service.html" target="_blank" rel="noopener">service模块官档</a><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/base/service_httpd.sls</span></span><br><span class="line"><span class="attr">httpd:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">httpd</span>   <span class="comment">#服务名称</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span>    <span class="comment">#开机自启动</span></span><br><span class="line"><span class="attr">    - reload:</span> <span class="literal">True</span>    <span class="comment">#允许重载配置文件，不写则是restart</span></span><br><span class="line"></span><br><span class="line"><span class="string">或者这样写</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/base/service_httpd.sls</span></span><br><span class="line"><span class="attr">httpd:</span>   <span class="comment">#即表示ID，又表示服务名</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - reload:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure></p><h2 id="高级状态模块"><a href="#高级状态模块" class="headerlink" title="高级状态模块"></a>高级状态模块</h2><blockquote><p>当我们想要不同的主机应用不同的配置，那么可以使用高级状态管理 <code>top file</code><br>来进行管理。可以通过正则，<code>grain</code>模块，或分组名，来进行匹配，再下一级是要执行的<code>state</code>文件</p></blockquote><p>可以将我们的配置需求转换为<code>YAML</code>并在<code>Top file</code>文件中表示：</p><p><img src="https://upload-images.jianshu.io/upload_images/11763553-9098e5814f51b40c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p><p><code>Top file</code>示例<br><figure class="highlight rsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">base:</span><br><span class="line">  <span class="string">'*'</span>: <span class="meta">#通过正则去匹配所有minion</span></span><br><span class="line">    - app.nginx</span><br><span class="line"></span><br><span class="line">  webserver: <span class="meta">#定义的分组名称</span></span><br><span class="line">    - <span class="built_in">match</span>: nodegroup</span><br><span class="line">    - app.cron</span><br><span class="line"></span><br><span class="line">  <span class="string">'os:centos'</span>:  <span class="meta">#通过grains模块匹配</span></span><br><span class="line">    - <span class="built_in">match</span>: grains</span><br><span class="line">    - nginx</span><br></pre></td></tr></table></figure></p><p><code>Top file</code> 高级状态的执行<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><h2 id="LAMP架构案例"><a href="#LAMP架构案例" class="headerlink" title="LAMP架构案例"></a>LAMP架构案例</h2><p>说明：该案例在<code>prod</code>环境配置<br>1）环境准备，定义<code>file_roots</code>环境<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="meta"># vim /etc/salt/master</span></span><br><span class="line"><span class="symbol">file_roots:</span></span><br><span class="line"><span class="symbol">  base:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/base</span><br><span class="line"><span class="symbol">  dev:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/dev</span><br><span class="line"><span class="symbol">  prod:</span></span><br><span class="line">    - <span class="meta-keyword">/srv/</span>salt/prod</span><br></pre></td></tr></table></figure></p><p>2）创建对应环境目录<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> /srv/salt/prod/&#123;httpd,php,mysql,files&#125;</span><br></pre></td></tr></table></figure></p><p>3）配置文件准备及测试文件准备<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cp</span> /etc/my.cnf /srv/salt/prod/files/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cp</span> /etc/httpd/conf/httpd.conf /srv/salt/prod/files/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# cp</span> /etc/php.ini  /srv/salt/prod/files/</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# echo</span> <span class="string">"&lt;h1&gt;LAMP html&lt;/h1&gt;"</span> &gt;&gt;/srv/salt/prod/files/index.html</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# echo</span> <span class="string">"&lt;?php phpinfo(); ?&gt;"</span> &gt;&gt; /srv/salt/prod/files/index.php</span><br></pre></td></tr></table></figure></p><p>4）编写<code>state sls</code>状态文件<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">#httpd</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/prod/httpd/init.sls</span><br><span class="line">apache-instal<span class="variable">l:</span></span><br><span class="line">  pkg.installed:</span><br><span class="line">    - pkg<span class="variable">s:</span></span><br><span class="line">      - httpd</span><br><span class="line">      - httpd-tools</span><br><span class="line"></span><br><span class="line">apache-confi<span class="variable">g:</span></span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - name: /etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - <span class="keyword">mode</span>: <span class="number">644</span></span><br><span class="line"></span><br><span class="line">apache-service:</span><br><span class="line">  service.runnin<span class="variable">g:</span></span><br><span class="line">    - name: httpd</span><br><span class="line">    - enable: True</span><br><span class="line"></span><br><span class="line">#php</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/prod/php/init.sls</span><br><span class="line">php-instal<span class="variable">l:</span></span><br><span class="line">  pkg.installed:</span><br><span class="line">    - pkg<span class="variable">s:</span></span><br><span class="line">      - php</span><br><span class="line">      - php-mysql</span><br><span class="line">      - php-pdo</span><br><span class="line">      - php-cli</span><br><span class="line"></span><br><span class="line">php-confi<span class="variable">g:</span></span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - name: /etc/php.ini</span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/php.ini</span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - <span class="keyword">mode</span>: <span class="number">644</span></span><br><span class="line"></span><br><span class="line">#mysql</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/prod/mysql/init.sls</span><br><span class="line">mariadb-instal<span class="variable">l:</span></span><br><span class="line">  pkg.installed:</span><br><span class="line">    - pkg<span class="variable">s:</span></span><br><span class="line">      - mariadb-server</span><br><span class="line">      - mariadb</span><br><span class="line"></span><br><span class="line">mariadb-confi<span class="variable">g:</span></span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - name: /etc/my.<span class="keyword">cnf</span></span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/my.<span class="keyword">cnf</span></span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - <span class="keyword">mode</span>: <span class="number">644</span></span><br><span class="line"></span><br><span class="line">mariadb-service:</span><br><span class="line">  service.runnin<span class="variable">g:</span></span><br><span class="line">    - name: mariadb</span><br><span class="line">    - enable: True</span><br><span class="line"></span><br><span class="line">#测试文件</span><br><span class="line">[root@salt-master ~]# <span class="keyword">cat</span> /srv/salt/prod/testfile.sls</span><br><span class="line">/var/www/html/<span class="built_in">index</span>.htm<span class="variable">l:</span></span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/<span class="built_in">index</span>.html</span><br><span class="line"></span><br><span class="line">/var/www/html/<span class="built_in">index</span>.php:</span><br><span class="line">  <span class="keyword">file</span>.managed:</span><br><span class="line">    - <span class="keyword">source</span>: <span class="keyword">sal</span><span class="variable">t:</span>//<span class="keyword">files</span>/<span class="built_in">index</span>.php</span><br></pre></td></tr></table></figure></p><p>6）<code>topfile</code>文件编写<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class="line">prod:</span><br><span class="line">  <span class="string">'salt-minion*'</span>:</span><br><span class="line">    - httpd.<span class="keyword">init</span></span><br><span class="line">    - php.<span class="keyword">init</span></span><br><span class="line">    - mysql.<span class="keyword">init</span></span><br><span class="line">    - testfile</span><br></pre></td></tr></table></figure></p><p>7）部署<code>LAMP</code>整体<code>state</code>文件查看<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# tree /srv/salt/</span><br><span class="line">/srv/salt/</span><br><span class="line">├── base</span><br><span class="line">│   └── top.sls</span><br><span class="line">├── dev</span><br><span class="line">└── prod</span><br><span class="line">    ├── <span class="keyword">files</span></span><br><span class="line">    │   ├── httpd.<span class="keyword">conf</span></span><br><span class="line">    │   ├── <span class="built_in">index</span>.html</span><br><span class="line">    │   ├── <span class="built_in">index</span>.php</span><br><span class="line">    │   ├── my.<span class="keyword">cnf</span></span><br><span class="line">    │   └── php.ini</span><br><span class="line">    ├── httpd</span><br><span class="line">    │   └── init.sls</span><br><span class="line">    ├── mysql</span><br><span class="line">    │   └── init.sls</span><br><span class="line">    ├── php</span><br><span class="line">    │   └── init.sls</span><br><span class="line">    └── testfile.sls</span><br></pre></td></tr></table></figure></p><p>8）执行<code>topfile</code><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><h2 id="States状态依赖"><a href="#States状态依赖" class="headerlink" title="States状态依赖"></a>States状态依赖</h2><p>通过上面的<code>lamp</code>可以看出已经可以使用<code>state</code>模块来定义<code>minion</code>的状态了，但是如果一个主机涉及多个状态，并且状态之间相互关联，在执行顺序上有先后之分，那么必须引用<code>requisites</code>来进行控制</p><blockquote><p>关系说明：<br>1、<code>require</code> 我依赖某个状态，我依赖谁<br>2、<code>require_in</code> 我被某个状态依赖，谁依赖我<br>3、<code>watch</code> 我关注某个状态，当状态发生改变，进行<code>restart</code>或者<code>reload</code>操作<br>4、<code>watch_in</code> 我被某个状态关注<br>5、<code>include</code> 我引用谁</p></blockquote><p>1）修改上面<code>lamp</code>状态间依赖关系<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#httpd</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/httpd/init.sls</span></span><br><span class="line"><span class="attr">apache-install:</span></span><br><span class="line">  <span class="string">pkg.installed:</span></span><br><span class="line"><span class="attr">    - pkgs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd-tools</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apache-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/httpd.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">apache-install</span>   <span class="comment">#表示上面apache-install执行成功，才能执行apache-config</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apache-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">apache-config</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">apache-config</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#php</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/php/init.sls</span></span><br><span class="line"><span class="attr">php-install:</span></span><br><span class="line">  <span class="string">pkg.installed:</span></span><br><span class="line"><span class="attr">    - pkgs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-mysql</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-pdo</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-cli</span></span><br><span class="line"><span class="attr">    - reqiure_in:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-config</span></span><br><span class="line"></span><br><span class="line"><span class="attr">php-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/php.ini</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/php.ini</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mysql</span></span><br><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/srv/salt/prod/mysql/init.sls</span></span><br><span class="line"><span class="attr">mariadb-install:</span></span><br><span class="line">  <span class="string">pkg.installed:</span></span><br><span class="line"><span class="attr">    - pkgs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">mariadb-server</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">mariadb</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mariadb-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/my.cnf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/my.cnf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">mariadb-install</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mariadb-service:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">mariadb</span></span><br><span class="line"><span class="attr">    - enable:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - reload:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">mariadb-config</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">mariadb-config</span></span><br></pre></td></tr></table></figure></p><p>2）修改引用关系后<code>include</code><br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>salt-master ~]# tree /srv/salt/</span><br><span class="line">/srv/salt/</span><br><span class="line">├── base</span><br><span class="line">│   └── top.sls</span><br><span class="line">├── dev</span><br><span class="line">└── prod</span><br><span class="line">    ├── files</span><br><span class="line">    │   ├── httpd.conf</span><br><span class="line">    │   ├── index.html</span><br><span class="line">    │   ├── index.php</span><br><span class="line">    │   ├── my.cnf</span><br><span class="line">    │   └── php.ini</span><br><span class="line">    ├── httpd</span><br><span class="line">    │   └── <span class="keyword">init</span>.sls</span><br><span class="line">    ├── lamp.sls</span><br><span class="line">    ├── mysql</span><br><span class="line">    │   └── <span class="keyword">init</span>.sls</span><br><span class="line">    ├── php</span><br><span class="line">    │   └── <span class="keyword">init</span>.sls</span><br><span class="line">    └── testfile.sls</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>salt-master ~]# cat /srv/salt/prod/lamp.sls</span><br><span class="line">include:</span><br><span class="line">  - httpd.<span class="keyword">init</span></span><br><span class="line">  - php.<span class="keyword">init</span></span><br><span class="line">  - mysql.<span class="keyword">init</span></span><br><span class="line">  - testfile</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>salt-master ~]# cat /srv/salt/base/top.sls</span><br><span class="line">prod:</span><br><span class="line">  <span class="string">'salt-minion*'</span>:</span><br><span class="line">    - lamp</span><br></pre></td></tr></table></figure></p><p>3）编写<code>SLS</code>技巧</p><blockquote><p>1、按照状态分类，如果单独使用，清晰明了<br>2、按照服务分类，可以被其它<code>SLS</code>引用</p></blockquote><h2 id="Jinja模板使用"><a href="#Jinja模板使用" class="headerlink" title="Jinja模板使用"></a>Jinja模板使用</h2><blockquote><p>配置文件一般灵活多变，比如配置<code>apache</code>的<code>IP</code>地址或者端口<code>PORT</code>等，则可以动态传值。<br><a href="http://docs.jinkan.org/docs/jinja2/" target="_blank" rel="noopener">Jinja官档</a><br><a href="https://docs.saltstack.com/en/latest/topics/jinja/index.html" target="_blank" rel="noopener">salt jinja官档</a></p></blockquote><p><code>Jinja2</code> 模板包含变量和表达式，变量用 &#123;&#123; … &#125;&#125; 包围，表达式用 &#123;&#37; … &#37;&#125; 包围。变量使用示例：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# cat /srv/salt/base/var.sls </span><br><span class="line">&#123;% set var= <span class="emphasis">'hello world!'</span> %&#125;</span><br><span class="line">test<span class="emphasis">_var:</span></span><br><span class="line"><span class="emphasis">  cmd.run:</span></span><br><span class="line"><span class="emphasis">    - name: echo "测试变量 &#123;&#123; var &#125;&#125;"</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">[root@salt-master ~]# salt 'salt-minion01' state.sls var</span></span><br><span class="line"><span class="emphasis">salt-minion01:</span></span><br><span class="line"><span class="emphasis">----------</span></span><br><span class="line"><span class="emphasis">          ID: test_</span>var</span><br><span class="line"><span class="code">    Function: cmd.run</span></span><br><span class="line"><span class="code">        Name: echo "测试变量 hello world!"</span></span><br><span class="line"><span class="code">      Result: True</span></span><br><span class="line"><span class="code">     Comment: Command "echo "测试变量 hello world!"" run</span></span><br><span class="line"><span class="code">     Started: 14:50:58.302424</span></span><br><span class="line"><span class="code">    Duration: 12.358 ms</span></span><br><span class="line"><span class="code">     Changes:   </span></span><br><span class="line"><span class="code">              ----------</span></span><br><span class="line"><span class="code">              pid:</span></span><br><span class="line"><span class="code">                  22510</span></span><br><span class="line"><span class="code">              retcode:</span></span><br><span class="line"><span class="code">                  0</span></span><br><span class="line"><span class="code">              stderr:</span></span><br><span class="line"><span class="code">              stdout:</span></span><br><span class="line"><span class="code">                  测试变量 hello world!</span></span><br><span class="line"></span><br><span class="line">Summary for salt-minion01</span><br><span class="line">------------</span><br><span class="line">Succeeded: 1 (changed=1)</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     1</span><br><span class="line">Total run time:  12.358 ms</span><br></pre></td></tr></table></figure></p><p><code>jinja2</code> 常用变量<br>1、字符串类型<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">set</span> <span class="keyword">var</span> = <span class="string">'test'</span> %&#125;  <span class="meta">#定义变量</span></span><br><span class="line">&#123;&#123; <span class="keyword">var</span> &#125;&#125;  <span class="meta">#调用变量</span></span><br></pre></td></tr></table></figure></p><p>2、列表类型<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set <span class="keyword">list</span> = [<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>] %&#125;</span><br><span class="line">&#123;&#123; <span class="keyword">list</span>[<span class="number">1</span>] &#125;&#125;  <span class="comment">#获取变量的第一个值</span></span><br></pre></td></tr></table></figure></p><p>3、字典类型<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">set</span> dict <span class="comment">= &#123;</span><span class="comment">'key1'</span><span class="comment">:</span><span class="comment">'value1'</span><span class="comment">,</span> <span class="comment">'key2'</span><span class="comment">:</span><span class="comment">'value2'</span><span class="comment">&#125; %&#125;</span></span><br><span class="line">&#123;&#123; dict[<span class="string">'key1'</span>] &#125;&#125;  #获取<span class="string">'key1'</span>的值</span><br></pre></td></tr></table></figure></p><p>示例1：<code>Saltstack</code>使用<code>jinja</code>模块配置<code>apache</code>监听端口<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.告诉file状态模块，需要使用jinja</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="comment">#2.列出参数列表</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="attr">      PORT:</span> <span class="number">8000</span></span><br><span class="line"><span class="comment">#3.配置文件引用jinja模板</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">PORT</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置示例</span></span><br><span class="line"><span class="attr">apache-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/httpd.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="attr">      PORT:</span> <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改httpd.conf配置文件引用变量</span></span><br><span class="line"><span class="string">Listen</span> <span class="string">&#123;&#123;</span> <span class="string">PORT</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p><p>示例2：使用<code>grinas</code> 方式进行赋值<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置示例</span></span><br><span class="line"><span class="attr">apache-config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/httpd.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - defaults:</span></span><br><span class="line"><span class="attr">      PORT:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">      IPADDR:</span> <span class="string">&#123;&#123;</span> <span class="string">grains['fqdn_ip4'][0]</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改httpd.conf配置文件引用变量</span></span><br><span class="line"><span class="string">Listen</span> <span class="string">&#123;&#123;</span> <span class="string">IPADDR</span> <span class="string">&#125;&#125;:&#123;&#123;</span> <span class="string">PORT</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure></p><p>示例3：通过<code>jinja+grains</code>根据系统不同安装<code>apache</code><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="comment"># cat /srv/salt/base/httpd.sls</span></span><br><span class="line"><span class="comment">#根据grains获取的值判别系统后安装软件</span></span><br><span class="line">httpd-<span class="keyword">install</span>:</span><br><span class="line">  pkg.installed:</span><br><span class="line">&#123;% <span class="keyword">if</span> grains[<span class="string">'os'</span>] == <span class="string">'CentOS'</span> %&#125;</span><br><span class="line">    - <span class="keyword">name</span>: httpd</span><br><span class="line">&#123;% elif grains[<span class="string">'OS'</span>] == <span class="string">'Debin'</span> %&#125;</span><br><span class="line">    - <span class="keyword">name</span>: apache2</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Saltstack状态模块&quot;&gt;&lt;a href=&quot;#Saltstack状态模块&quot; class=&quot;headerlink&quot; title=&quot;Saltstack状态模块&quot;&gt;&lt;/a&gt;Saltstack状态模块&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;远程执行模块的执行是过程式
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack远程执行</title>
    <link href="https://leeyj.coding.me/2019/05/14/saltstack%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C/"/>
    <id>https://leeyj.coding.me/2019/05/14/saltstack远程执行/</id>
    <published>2019-05-14T07:18:05.000Z</published>
    <updated>2019-05-14T12:43:10.857Z</updated>
    
    <content type="html"><![CDATA[<p><div class="note success"><p>安装完<code>Saltstack</code>后可以立即执行<code>shell</code>命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：<a href="http://docs.saltstack.cn/topics/tutorials/modules.html" target="_blank" rel="noopener">http://docs.saltstack.cn/topics/tutorials/modules.html</a></p></div><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]<span class="comment"># salt '*' cmd.run "uptime"</span></span><br><span class="line">salt-minion01:</span><br><span class="line">     15:23:08 up 1 day, 58 min,  2 users,  <span class="keyword">load</span> average: <span class="number">0.00</span>, <span class="number">0.03</span>, <span class="number">0.08</span></span><br><span class="line"><span class="keyword">salt</span>-minion02:</span><br><span class="line">     <span class="number">15</span>:<span class="number">23</span>:<span class="number">08</span> up <span class="number">21</span>:<span class="number">38</span>,  <span class="number">2</span> <span class="keyword">users</span>,  <span class="keyword">load</span> average: <span class="number">0.00</span>, <span class="number">0.04</span>, <span class="number">0.10</span></span><br><span class="line"><span class="keyword">salt</span>-minion03:</span><br><span class="line">     <span class="number">15</span>:<span class="number">23</span>:<span class="number">08</span> up <span class="number">21</span>:<span class="number">36</span>,  <span class="number">2</span> <span class="keyword">users</span>,  <span class="keyword">load</span> average: <span class="number">0.00</span>, <span class="number">0.04</span>, <span class="number">0.10</span></span><br></pre></td></tr></table></figure></p><h2 id="Salt命令的结构语法"><a href="#Salt命令的结构语法" class="headerlink" title="Salt命令的结构语法"></a>Salt命令的结构语法</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'&lt;target&gt;'</span> &lt;<span class="function"><span class="keyword">function</span>&gt; <span class="params">[arguments]</span></span></span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/11763553-e5e69a972680590f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p><h2 id="目标主机Target"><a href="#目标主机Target" class="headerlink" title="目标主机Target"></a>目标主机Target</h2><p><img src="https://upload-images.jianshu.io/upload_images/11763553-e3ed49a6c6b6633f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>1、通配符匹配<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'salt-minion01'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*01'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'salt-minion0[1|2]'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'salt-minion0[!1|2]'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'salt-minion0?'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><p>2、列表匹配<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -L <span class="string">'salt-minion01,salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><p>3、正则匹配<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -E <span class="string">'^salt'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -E <span class="string">'^salt.*2$'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><p>4、IP匹配<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# salt -S '<span class="number">192.168</span><span class="number">.1</span><span class="number">.32</span>' test.ping</span><br><span class="line">[root@salt-master ~]# salt -S '<span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>' test.ping</span><br></pre></td></tr></table></figure></p><p>5、复合匹配<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> -C 'G@os:CentOS <span class="keyword">and</span> S@<span class="number">192.168</span>.<span class="number">1.32</span>' test.ping</span><br></pre></td></tr></table></figure></p><p>6、分组匹配<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">nodegroups:</span><br><span class="line">  webserver: 'salt-minion01,salt-minion02'</span><br><span class="line">  dbserver: 'salt-minion03</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> -N 'webserver' test.ping</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt</span> -N 'dbserver' test.ping</span><br></pre></td></tr></table></figure></p><p>7、Grains匹配<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -G <span class="string">'os:CentOS'</span> test.ping</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt -G <span class="string">'localhost:salt-minion02'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><blockquote><p>说明：上面这些匹配方式在<code>top.sls</code>文件中同样适用。</p></blockquote><h2 id="模块Module"><a href="#模块Module" class="headerlink" title="模块Module"></a>模块Module</h2><p><img src="https://upload-images.jianshu.io/upload_images/11763553-18184de0fb7156aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p><blockquote><p><code>test</code>模块多用于测试<br><code>user</code>模块用于用户管理<br><code>cmd</code>模块可以执行任意<code>shell</code>命令<br><code>pkg</code>模块用于软件包管理<br><code>file</code>模块多用于配置<br><code>service</code>模块用于服务管理</p></blockquote><p><a href="http://docs.saltstack.cn/ref/modules/all/index.html" target="_blank" rel="noopener">所有模块列表</a></p><p><strong>test模块</strong><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">模块名：test</span><br><span class="line">功能：用于测试</span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> test.ping</span></span><br></pre></td></tr></table></figure></p><p><strong>user模块</strong><br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">参考：http://docs.saltstack.<span class="keyword">cn</span>/ref/modules/<span class="keyword">all</span>/salt.modules.useradd.html#module-salt.modules.useradd</span><br><span class="line"># salt <span class="string">'*'</span> user.<span class="built_in">add</span> name <span class="symbol">&lt;uid&gt;</span> <span class="symbol">&lt;gid&gt;</span> <span class="symbol">&lt;groups&gt;</span> <span class="symbol">&lt;home&gt;</span> <span class="symbol">&lt;shell&gt;</span></span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> user.<span class="built_in">add</span> testuser</span><br></pre></td></tr></table></figure></p><p><strong>cmd模块</strong><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">模块名：cmd</span><br><span class="line">功能：实现远程的命令行调用执行（默认具备root操作权限，使用时需评估风险）</span><br><span class="line"><span class="meta">#查看所有minion内存和磁盘使用情况</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> cmd.run <span class="string">"free -m"</span></span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> cmd.run <span class="string">"df -h"</span></span></span><br></pre></td></tr></table></figure></p><p><strong>pkg模块</strong><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">模块名：pkg</span><br><span class="line">功能：软件包状态管理，会根据操作系统不同，选择对应的安装方式（如CentOS系统默认使用yum，Debian系统默认使用apt-get）</span><br><span class="line"></span><br><span class="line"><span class="meta">#安装</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> pkg.install <span class="string">"vsftpd"</span></span></span><br><span class="line"><span class="meta">#卸载</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> pkg.remove <span class="string">"vsftpd"</span></span></span><br><span class="line"><span class="meta">#安装最新版本</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> pkg.latest_version <span class="string">"vsftpd"</span></span></span><br><span class="line"><span class="meta">#更新软件包</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> pkg.upgrade <span class="string">"vsftpd"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#查看帮助手册</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> pkg</span></span><br></pre></td></tr></table></figure></p><p><strong>file模块</strong><br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">模块名：<span class="keyword">file</span></span><br><span class="line">功能：被控主机常见的文件操作，包括文件读写、权限、查找、校验</span><br><span class="line"></span><br><span class="line">#校验所有minion主机文件的加密信息，支持md5、sha1、sha224、shs256、sha384、sha512加密算法</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.get_sum <span class="regexp">/etc/</span>passwd md5</span><br><span class="line"></span><br><span class="line">#修改所有minion主机<span class="regexp">/etc/</span>passwd文件的属组、用户权限、等价于chown root:root <span class="regexp">/etc/</span>passwd</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.chown <span class="regexp">/etc/</span>passwd root root</span><br><span class="line"></span><br><span class="line">#获取所有minion主机<span class="regexp">/etc/</span>passwd的stats信息</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.stats <span class="regexp">/etc/</span>passwd</span><br><span class="line"></span><br><span class="line">#获取所有minion主机<span class="regexp">/etc/</span>passwd的权限mode,如<span class="number">755</span>,<span class="number">644</span></span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.get_mode <span class="regexp">/etc/</span>passwd</span><br><span class="line"></span><br><span class="line">#修改所有minion主机<span class="regexp">/etc/</span>passwd的权限mode为<span class="number">0644</span></span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.set_mode <span class="regexp">/etc/</span>passwd <span class="number">0644</span></span><br><span class="line"></span><br><span class="line">#在所有minion主机创建<span class="regexp">/opt/</span>test目录</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.mkdir <span class="regexp">/opt/</span>test</span><br><span class="line"></span><br><span class="line">#在所有minion主机穿件<span class="regexp">/tmp/</span>test.conf文件</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.touch <span class="regexp">/tmp/</span>test.conf</span><br><span class="line"></span><br><span class="line">#将所有minion主机<span class="regexp">/tmp/</span>test.conf文件追加内容<span class="string">'maxclient 100'</span></span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.<span class="keyword">append</span> <span class="regexp">/tmp/</span>test.conf <span class="string">'maxclient 100'</span></span><br><span class="line"></span><br><span class="line">#删除所有minion主机的<span class="regexp">/tmp/</span>test.conf文件</span><br><span class="line">[root@salt-master ~]# salt <span class="string">'*'</span> <span class="keyword">file</span>.remove <span class="regexp">/tmp/</span>test.conf</span><br></pre></td></tr></table></figure></p><p><strong>service模块</strong><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">模块名：service</span><br><span class="line">功能：被控主机程序包服务管理</span><br><span class="line"></span><br><span class="line">#开启（enable）禁用（disable）</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.enable</span> &lt;service name&gt;</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.disabled</span> &lt;service name&gt;</span><br><span class="line"></span><br><span class="line">#reload、restart、start、stop、status操作</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.reload</span> &lt;service name&gt;</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.restart</span> &lt;service name&gt;</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.start</span> &lt;service name&gt;</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.stop</span> &lt;service name&gt;</span><br><span class="line">salt <span class="string">'*'</span> service<span class="selector-class">.status</span> &lt;service name&gt;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;div class=&quot;note success&quot;&gt;&lt;p&gt;安装完&lt;code&gt;Saltstack&lt;/code&gt;后可以立即执行&lt;code&gt;shell&lt;/code&gt;命令，更新软件包并将文件同时分不到所有受管系统。所有回复都以一致的可配置格式返回。远程执行参考文档：&lt;a href=
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>saltstack基本入门</title>
    <link href="https://leeyj.coding.me/2019/05/13/saltstack%E5%9F%BA%E6%9C%AC%E5%85%A5%E9%97%A8/"/>
    <id>https://leeyj.coding.me/2019/05/13/saltstack基本入门/</id>
    <published>2019-05-13T07:47:05.000Z</published>
    <updated>2019-05-14T12:43:10.857Z</updated>
    
    <content type="html"><![CDATA[<h2 id="saltstack介绍"><a href="#saltstack介绍" class="headerlink" title="saltstack介绍"></a>saltstack介绍</h2><div class="note success"><p>Salt，,一种全新的基础设施管理方式，部署轻松，在几分钟内可运行起来，扩展性好，很容易管理上万台服务器，速度够快，服务器之间秒级通讯</p></div><p><strong>主要功能</strong><br>远程执行<br>配置管理<br><a href="http://docs.saltstack.cn/" target="_blank" rel="noopener">Stalstack官方文档</a></p><h2 id="Saltstack原理"><a href="#Saltstack原理" class="headerlink" title="Saltstack原理"></a>Saltstack原理</h2><blockquote><p><code>Salt</code>使用<code>server-agent</code>通信模型，服务端组件被称为<code>Salt master</code>，<code>agent</code>被称为<code>Salt minion</code><br><code>Salt master</code>主要负责向<code>Salt minions</code>发送命令，然后聚合并显示这些命令的结果。一个<code>Salt master</code>可以管理多个<code>minion</code>系统<br><code>Salt server</code>与<code>Salt minion</code>通信的连接由<code>Salt minion</code>发起，这也意味着<code>Salt minion</code>上不需要打开任何传入端口（从而减少攻击）。<code>Salt server</code>使用端口<code>4505</code>和<code>4506</code>，必须打开端口才能接收到访问连接</p></blockquote><p><img src="https://upload-images.jianshu.io/upload_images/11763553-2ead569e18094825.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="通信示例图"></p><ul><li><strong>Publisher</strong> （端口4505）所有<code>Salt minions</code>都需要建立一个持续连接到他们收听消息的发布者端口。命令是通过此端口异步发送给所有连接，这使命令可以在大量系统上同时执行。</li><li><strong>Request Server</strong> （端口4506）<code>Salt minios</code>根据需要连接到请求服务器，将结果发送给<code>Salt master</code>，并安全地获取请求的文件或特定<code>minion</code>相关的数据值（称为<code>Salt pillar</code>）。连接到这个端口的连接在<code>Salt master</code>和<code>Salt minion</code>之间是1:1（不是异步）。</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-master ~]# lsof -i:4505</span><br><span class="line">COMMAND     PID<span class="built_in"> USER </span>  FD  <span class="built_in"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class="line">salt-mast 81121 root   16u  IPv4 304019      0t0  TCP *:4505 (LISTEN)</span><br><span class="line">salt-mast 81121 root   18u  IPv4 304082      0t0  TCP salt-master:4505-&gt;salt-minion03:37240 (ESTABLISHED)</span><br><span class="line">salt-mast 81121 root   19u  IPv4 307610      0t0  TCP salt-master:4505-&gt;salt-minion01:47804 (ESTABLISHED)</span><br><span class="line">salt-mast 81121 root   20u  IPv4 307611      0t0  TCP salt-master:4505-&gt;salt-minion02:58594 (ESTABLISHED)</span><br></pre></td></tr></table></figure><h2 id="快速安装"><a href="#快速安装" class="headerlink" title="快速安装"></a>快速安装</h2><p>1.1 配置 yum 仓库<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用官方自带yum</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> install https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm</span><br><span class="line"><span class="comment"># 或者使用阿里云的yum（建议使用阿里云的，速度快一点）</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install https://mirrors.aliyun.com/saltstack/yum/redhat/salt-repo-latest-<span class="number">2</span>.el7.noarch.rpm</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# sed</span> -i <span class="string">"s/repo.saltstack.com/mirrors.aliyun.com\/saltstack/g"</span> /etc/yum.repos.d/salt-latest.repo</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> clean all</span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> makecache</span><br></pre></td></tr></table></figure></p><p>1.2 安装Master，并启动服务<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# yum</span> -y install salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> enable salt-<span class="literal">master</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> <span class="literal">start</span> salt-<span class="literal">master</span></span><br></pre></td></tr></table></figure></p><p>1.3 安装 Salt-Minion 指向 Salt-Master 网络地址<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># yum -y install salt-minion</span></span><br><span class="line"><span class="meta"># 可以使用主机名，也可以使用IP地址</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># cp /etc/salt/minion&#123;,.back&#125;</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># sed -i <span class="string">'/#master: /c\master: salt-master'</span> /etc/salt/minion</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># systemctl enable salt-minion</span></span><br><span class="line">[root<span class="symbol">@salt</span>-minion01 ~]<span class="meta"># systemctl start salt-minion</span></span><br></pre></td></tr></table></figure></p><h2 id="SaltStack认证方式"><a href="#SaltStack认证方式" class="headerlink" title="SaltStack认证方式"></a>SaltStack认证方式</h2><p><img src="https://upload-images.jianshu.io/upload_images/11763553-51113b6686102c1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="master与minion之间的架构关系图"></p><div class="note success"><p> <code>Salt</code> 的数据传输是通过 <code>AES</code> 加密，<code>Master</code> 和 <code>Minion</code> 之前在通信之前，需要进行认证。<br><code>Salt</code> 通过认证的方式保证安全性，完成一次认证后，Master 就可以控制 Minion 来完成各项工作了。</p></div><div class="note success"><p>1.  <code>minion</code> 在第一次启动时候，会在 <code>/etc/salt/pki/minion/</code> 下自动生成 <code>minion.pem(private key)</code> 和 <code>minion.pub(public key)</code>, 然后将 <code>minion.pub</code> 发送给 <code>master</code><br>2. <code>master</code> 在第一次启动时，会在 <code>/etc/salt/pki/master/</code> 下自动生成 <code>master.pem</code> 和 <code>master.pub</code> ；并且会接收到 <code>minion</code> 的 <code>public key</code> , 通过 <code>salt-key</code> 命令接收 <code>minion public key</code>， 会在 <code>master</code> 的 <code>/etc/salt/pki/master/minions</code> 目录下存放以 <code>minion id</code> 命令的 <code>public key</code> ；验证成功后同时 <code>minion</code> 会保存一份 <code>master public key</code> 在 minion的 <code>/etc/salt/pki/minion/minion_master.pub</code>里。</p></div><p><strong>Salt认证原理总结</strong></p><blockquote><p><code>minion</code>将自己的公钥发送给<code>master</code><br><code>master</code>认证后再将自己的公钥也发送给<code>minion</code>端</p></blockquote><p><strong>Master端认证示例</strong><br>根据上面提到的认证原理，先看下未认证前的<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master上查看</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# tree</span> /etc/salt/pki/</span><br><span class="line">/etc/salt/pki/</span><br><span class="line">├── <span class="literal">master</span></span><br><span class="line">│   ├── <span class="literal">master</span>.pem</span><br><span class="line">│   ├── <span class="literal">master</span>.pub</span><br><span class="line">│   ├── minions</span><br><span class="line">│   ├── minions_autosign</span><br><span class="line">│   ├── minions_denied</span><br><span class="line">│   ├── minions_pre</span><br><span class="line">│   │   └── salt-minion01</span><br><span class="line">│   └── minions_rejected</span><br><span class="line">└── minion</span><br><span class="line"></span><br><span class="line"><span class="comment"># minion上查看</span></span><br><span class="line">[root@salt-minion01 ~]<span class="comment"># tree /etc/salt/pki/</span></span><br><span class="line">/etc/salt/pki/</span><br><span class="line">├── <span class="literal">master</span></span><br><span class="line">└── minion</span><br><span class="line">    ├── minion.pem</span><br><span class="line">    └── minion.pub</span><br></pre></td></tr></table></figure></p><p><code>salt-key</code>命令解释：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">salt-key</span> <span class="bullet">-L</span> </span><br><span class="line"><span class="string">Accepted</span> <span class="attr">Keys:</span>        <span class="comment">#已经接受的key</span></span><br><span class="line"><span class="string">Denied</span> <span class="attr">Keys:</span>          <span class="comment">#拒绝的key</span></span><br><span class="line"><span class="string">Unaccepted</span> <span class="attr">Keys:</span>      <span class="comment">#未加入的key</span></span><br><span class="line"><span class="string">Rejected</span> <span class="attr">Keys:</span>        <span class="comment">#吊销的key</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#常用参数</span></span><br><span class="line"><span class="bullet">-</span><span class="string">L</span>  <span class="comment">#查看KEY状态</span></span><br><span class="line"><span class="bullet">-</span><span class="string">A</span>  <span class="comment">#允许所有</span></span><br><span class="line"><span class="bullet">-</span><span class="string">D</span>  <span class="comment">#删除所有</span></span><br><span class="line"><span class="bullet">-</span><span class="string">a</span>  <span class="comment">#认证指定的key</span></span><br><span class="line"><span class="bullet">-</span><span class="string">d</span>  <span class="comment">#删除指定的key</span></span><br><span class="line"><span class="bullet">-</span><span class="string">r</span>  <span class="comment">#注销掉指定key（该状态为未被认证）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置master自动接受请求认证(master上配置 /etc/salt/master)</span></span><br><span class="line"><span class="attr">auto_accept:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure></p><p><code>salt-key</code>认证<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列出当前所有的key</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -L </span><br><span class="line">Accepted Keys:</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">Rejected Keys:</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加指定minion的key</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -a salt-minion01 -y</span><br><span class="line">The following keys are going to be accepted:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">Key for minion salt-minion01 accepted.</span><br><span class="line"><span class="comment">#添加所有minion的key</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -A -y</span><br><span class="line"></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# salt-key</span> -L </span><br><span class="line">Accepted Keys:</span><br><span class="line">salt-minion01</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">Rejected Keys:</span><br></pre></td></tr></table></figure></p><p>上面认证完成后再次查看<code>master</code>和<code>minion</code>的<code>pki</code>目录<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master上</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# tree</span> /etc/salt/pki/</span><br><span class="line">/etc/salt/pki/</span><br><span class="line">├── <span class="literal">master</span></span><br><span class="line">│   ├── <span class="literal">master</span>.pem</span><br><span class="line">│   ├── <span class="literal">master</span>.pub</span><br><span class="line">│   ├── minions</span><br><span class="line">│   │   └── salt-minion01</span><br><span class="line">│   ├── minions_autosign</span><br><span class="line">│   ├── minions_denied</span><br><span class="line">│   ├── minions_pre</span><br><span class="line">│   └── minions_rejected</span><br><span class="line">└── minion</span><br><span class="line"></span><br><span class="line"><span class="comment"># minion上</span></span><br><span class="line">[root@salt-minion01 ~]<span class="comment"># tree /etc/salt/pki/</span></span><br><span class="line">/etc/salt/pki/</span><br><span class="line">├── <span class="literal">master</span></span><br><span class="line">└── minion</span><br><span class="line">    ├── minion_master.pub</span><br><span class="line">    ├── minion.pem</span><br><span class="line">    └── minion.pub</span><br></pre></td></tr></table></figure></p><h2 id="Saltstack远程执行"><a href="#Saltstack远程执行" class="headerlink" title="Saltstack远程执行"></a>Saltstack远程执行</h2><blockquote><p>远程执行是 <code>Saltstack</code> 的核心功能之一。主要使用 <code>salt</code> 模块批量给选定的 <code>minion</code> 端执行相应的命令，并获得返回结果。</p></blockquote><p>1、判断 <code>salt</code> 的 <code>minion</code> 主机是否存活<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@salt-master</span> <span class="string">~]#</span> <span class="string">salt</span> <span class="string">'*'</span> <span class="string">test.ping</span></span><br><span class="line"><span class="attr">salt-minion02:</span></span><br><span class="line">    <span class="literal">True</span></span><br><span class="line"><span class="attr">salt-minion03:</span></span><br><span class="line">    <span class="literal">True</span></span><br><span class="line"><span class="attr">salt-minion01:</span></span><br><span class="line">    <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># salt saltstack自带的一个命令</span></span><br><span class="line"><span class="comment"># * 表示目标主机，这里表示所有目标主机</span></span><br><span class="line"><span class="comment"># test.ping test是saltstack中的一个模块，ping则是这个模块下面的一个方法</span></span><br></pre></td></tr></table></figure></p><p>2、<code>saltstack</code>使用 <code>cmd.run</code>模块远程执行shell命令<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#在指定目标minion节点运行uptime命令</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'salt-minion02'</span> cmd.run <span class="string">'uptime'</span></span></span><br><span class="line">salt-minion02:</span><br><span class="line">     <span class="number">18</span>:<span class="number">13</span>:<span class="number">08</span> up <span class="number">28</span> min,  <span class="number">2</span> users,  load average: <span class="number">0.00</span>, <span class="number">0.04</span>, <span class="number">0.13</span></span><br></pre></td></tr></table></figure></p><h2 id="Saltstack配置管理"><a href="#Saltstack配置管理" class="headerlink" title="Saltstack配置管理"></a>Saltstack配置管理</h2><p><div class="note success"><p><code>Salt</code> 通过<code>State</code>模块来进行文件的管理；通过<code>YAML</code>语法来描述，后缀是<code>.sls</code>的文件</p></div>1、了解 <code>YAML</code> 参考：<a href="http://docs.saltstack.cn/topics/yaml/index.html" target="_blank" rel="noopener">http://docs.saltstack.cn/topics/yaml/index.html</a><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">remove <span class="string">vim:</span></span><br><span class="line">  pkg.<span class="string">removed:</span></span><br><span class="line">    - <span class="string">name:</span> vim</span><br></pre></td></tr></table></figure></p><ul><li>带有ID和每个函数调用的行都以冒号（:)结束。</li><li>每个函数调用在ID下面缩进两个空格。</li><li>参数作为列表传递给每个函数。</li><li>每行包含函数参数的行都以两个空格缩进开头，然后是连字符，然后是一个额外的空格。</li><li>如果参数采用单个值，则名称和值位于由冒号和空格分隔的同一行中。</li><li>如果一个参数需要一个列表，则列表从下一行开始，并缩进两个空格</li></ul><p>2、配置<code>sals</code> ,定义环境   <a href="https://github.com/watermelonbig/SaltStack-Chinese-ManualBook/blob/master/chapter02/02-3.Configuration-Management-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86.md" target="_blank" rel="noopener">参考文档</a><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义环境目录</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# vim</span> /etc/salt/<span class="literal">master</span></span><br><span class="line">file_roots:</span><br><span class="line">  base:</span><br><span class="line">    - /srv/salt/base</span><br><span class="line">  dev:</span><br><span class="line">    - /srv/salt/dev</span><br><span class="line">  prod:</span><br><span class="line">    - /srv/salt/prod</span><br><span class="line"><span class="comment"># 创建上面定义的目录</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# mkdir</span> -p /srv/salt/&#123;base,dev,prod&#125;</span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">[root@salt-<span class="keyword">master</span> <span class="title">~]# systemctl</span> restart salt-<span class="literal">master</span></span><br></pre></td></tr></table></figure></p><p>3、编写第一个<code>sls</code>文件<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在base环境下编写第一个安装apache的sls文件</span></span><br><span class="line">[root@salt-master ~]<span class="comment"># cd /srv/salt/base/</span></span><br><span class="line">[root@salt-master base]<span class="comment"># cat apache.sls </span></span><br><span class="line">apache-<span class="keyword">install</span>:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - <span class="keyword">name</span>: httpd</span><br><span class="line"></span><br><span class="line">apache-service:</span><br><span class="line">  service.running:</span><br><span class="line">    - <span class="keyword">name</span>: httpd</span><br><span class="line">    - <span class="keyword">enable</span>: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在dev环境下编写一个安装ftp的sls文件</span></span><br><span class="line">[root@<span class="keyword">salt</span>-<span class="keyword">master</span> base]<span class="comment"># cd /srv/salt/dev/</span></span><br><span class="line">[root@<span class="keyword">salt</span>-<span class="keyword">master</span> dev]<span class="comment"># cat vsftpd.sls </span></span><br><span class="line">vsftpd-<span class="keyword">install</span>:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - <span class="keyword">name</span>: vsftpd</span><br><span class="line"></span><br><span class="line">vsftpd-service:</span><br><span class="line">  service.running:</span><br><span class="line">    - <span class="keyword">name</span>: vsftpd</span><br><span class="line">    - <span class="keyword">enable</span>: <span class="literal">True</span></span><br></pre></td></tr></table></figure></p><p>4、使用<code>salt</code>命令的<code>state</code>状态模块让<code>minion</code>应用配置<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 让所有的minion都安装apache（由于salt默认的环境就是base，所以可以直接在后面指定调用的apache.sls文件，不要后缀sls）</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.sls apache</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 让所有的minion都安装vsftpd（saltenv指定环境）</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.sls vsftpd saltenv=dev</span></span><br></pre></td></tr></table></figure></p><p>5、使用<code>salt</code>的高级状态使不同主机应用不同的配置<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># topfile入口文件只能放在base环境</span></span><br><span class="line">[<span class="meta">root@salt-master ~</span>]<span class="meta"># cat /srv/salt/base/top.sls </span></span><br><span class="line"><span class="keyword">base</span>:</span><br><span class="line">  <span class="string">'salt-minion01'</span>:</span><br><span class="line">    - apache</span><br><span class="line">  <span class="string">'salt-minion03'</span>:</span><br><span class="line">    - apache</span><br><span class="line">dev:</span><br><span class="line">  <span class="string">'salt-minion02'</span>:</span><br><span class="line">    - vsftpd</span><br><span class="line">  <span class="string">'salt-minion03'</span>:</span><br><span class="line">    - vsftpd</span><br></pre></td></tr></table></figure></p><p>6、使用<code>salt</code>命令执行高级状态，会将<code>top.sls</code>当做入口文件，进行调用<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 将高级状态应用到所有主机</span></span><br><span class="line">[root<span class="symbol">@salt</span>-master ~]<span class="meta"># salt <span class="string">'*'</span> state.highstate</span></span><br></pre></td></tr></table></figure></p><h2 id="Saltstack常用配置"><a href="#Saltstack常用配置" class="headerlink" title="Saltstack常用配置"></a>Saltstack常用配置</h2><p>1、<strong>Salt Master配置</strong><br><code>Salt Master</code>端的配置文件<code>/etc/salt/master</code>，常用配置如下：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">interface</span>: <span class="comment">//指定bind 的地址(默认为0.0.0.0)</span></span><br><span class="line"><span class="attribute">publish_port</span>: <span class="comment">//指定发布端口(默认为4505)</span></span><br><span class="line"><span class="attribute">ret_port</span>: <span class="comment">//指定结果返回端口,  与minion配置文件中的master_port对应(默认为4506)</span></span><br><span class="line"><span class="attribute">user</span>: <span class="comment">//指定master进程的运行用户,如果调整, 则需要调整部分目录的权限(默认为root)</span></span><br><span class="line"><span class="attribute">timeout</span>: <span class="comment">//指定timeout时间,  如果minion规模庞大或网络状况不好,建议增大该值(默认5s)</span></span><br><span class="line"><span class="attribute">keep_jobs</span>: <span class="comment">//minion执行结果返回master, master会缓存到本地的cachedir目录,该参数指定缓存多长时间,可查看之间执行结果会占用磁盘空间(默认为24h)</span></span><br><span class="line"><span class="attribute">job_cache</span>: <span class="comment">//master是否缓存执行结果,如果规模庞大(超过5000台),建议使用其他方式来存储jobs,关闭本选项(默认为True)</span></span><br><span class="line"><span class="attribute">file_recv </span>: <span class="comment">//是否允许minion传送文件到master 上(默认是Flase)</span></span><br><span class="line"><span class="attribute">file_roots</span>: <span class="comment">//指定file server目录,  默认为:</span></span><br><span class="line">    <span class="attribute">file_roots</span>:    </span><br><span class="line">       <span class="attribute">base</span>:    </span><br><span class="line">        - /srv/salt     </span><br><span class="line"><span class="attribute">pillar_roots </span>: <span class="comment">//指定pillar 目录,  默认为:</span></span><br><span class="line">    <span class="attribute">pillar_roots</span>:     </span><br><span class="line">      <span class="attribute">base</span>:     </span><br><span class="line">        - /srv/pillar     </span><br><span class="line"><span class="attribute">log_level</span>: <span class="comment">//日志级别</span></span><br><span class="line">支持的日志级别有<span class="string">'garbage'</span>, <span class="string">'trace'</span>, <span class="string">'debug'</span>, info<span class="string">', '</span>warning<span class="string">', '</span>error', ‘critical ’ ( 默认为’warning’)</span><br></pre></td></tr></table></figure></p><p>2、<code>Salt Minion</code>端的配置文件<code>/etc/salt/minion</code>，常用配置如下：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">master:</span> <span class="comment">//指定master 主机(默认为salt)</span></span><br><span class="line"><span class="string">master_port:</span> <span class="comment">//指定认证和执行结果发送到master的哪个端口,  与master配置文件中的ret_port对应(默认为4506)</span></span><br><span class="line"><span class="string">id:</span> <span class="comment">//指定本minion的标识, salt内部使用id作为标识(默认为主机名)</span></span><br><span class="line"><span class="string">user:</span> <span class="comment">//指定运行minion的用户.由于安装包,启动服务等操作需要特权用户, 推荐使用root( 默认为root)</span></span><br><span class="line"><span class="string">cache_jobs :</span> <span class="comment">//minion是否缓存执行结果(默认为False)</span></span><br><span class="line"><span class="string">backup_mode:</span> <span class="comment">//在文件操作(file.managed 或file.recurse) 时,  如果文件发送变更,指定备份目录.当前有效</span></span><br><span class="line"><span class="string">providers :</span> <span class="comment">//指定模块对应的providers, 如在RHEL系列中, pkg对应的providers 是yumpkg5</span></span><br><span class="line"><span class="string">renderer:</span> <span class="comment">//指定配置管理系统中的渲染器(默认值为:yaml_jinja )</span></span><br><span class="line"><span class="string">file_client :</span> <span class="comment">//指定file clinet 默认去哪里(remote 或local) 寻找文件(默认值为remote)</span></span><br><span class="line"><span class="string">loglevel:</span> <span class="comment">//指定日志级别(默认为warning)</span></span><br><span class="line"><span class="string">tcp_keepalive :</span> <span class="comment">//minion 是否与master 保持keepalive 检查, zeromq3(默认为True)</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;saltstack介绍&quot;&gt;&lt;a href=&quot;#saltstack介绍&quot; class=&quot;headerlink&quot; title=&quot;saltstack介绍&quot;&gt;&lt;/a&gt;saltstack介绍&lt;/h2&gt;&lt;div class=&quot;note success&quot;&gt;&lt;p&gt;Salt，,一种
      
    
    </summary>
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/categories/Saltstack/"/>
    
    
      <category term="Saltstack" scheme="https://leeyj.coding.me/tags/Saltstack/"/>
    
  </entry>
  
  <entry>
    <title>linux下解压windows上压缩rar包</title>
    <link href="https://leeyj.coding.me/2019/04/30/linux%E4%B8%8B%E8%A7%A3%E5%8E%8Bwindows%E4%B8%8A%E5%8E%8B%E7%BC%A9rar%E5%8C%85/"/>
    <id>https://leeyj.coding.me/2019/04/30/linux下解压windows上压缩rar包/</id>
    <published>2019-04-30T05:48:55.000Z</published>
    <updated>2019-04-30T06:15:10.476Z</updated>
    
    <content type="html"><![CDATA[<h5 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h5><p><code># wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz</code></p><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># tar xvzf rarlinux-3.8.0.tar.gz</span></span><br><span class="line"><span class="meta"># cd rar</span></span><br><span class="line"><span class="meta"># make </span></span><br><span class="line"><span class="meta"># make install</span></span><br></pre></td></tr></table></figure><h5 id="rar命令语法"><a href="#rar命令语法" class="headerlink" title="rar命令语法"></a>rar命令语法</h5><p>将 /etc 目录压缩为 etc.rar 命令为：\<br><code># rar a etc.rar /etc</code>\<br>将 etc.rar 解压 命令为：\<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">rar</span> <span class="selector-tag">x</span> <span class="selector-tag">etc</span><span class="selector-class">.rar</span></span><br><span class="line"><span class="selector-tag">unrar</span> <span class="selector-tag">-e</span> <span class="selector-tag">etc</span><span class="selector-class">.rar</span></span><br></pre></td></tr></table></figure></p><h5 id="rar帮助手册"><a href="#rar帮助手册" class="headerlink" title="rar帮助手册"></a>rar帮助手册</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># rar</span></span><br><span class="line"></span><br><span class="line">RAR 3.80   Copyright (c) 1993-2008 Alexander Roshal   16 Sep 2008</span><br><span class="line">Shareware version         Type RAR -? for help</span><br><span class="line"></span><br><span class="line">Usage:     rar <span class="xml"><span class="tag">&lt;<span class="name">command</span>&gt;</span></span> -<span class="xml"><span class="tag">&lt;<span class="name">switch</span> <span class="attr">1</span>&gt;</span></span> -<span class="xml"><span class="tag">&lt;<span class="name">switch</span> <span class="attr">N</span>&gt;</span></span> <span class="xml"><span class="tag">&lt;<span class="name">archive</span>&gt;</span></span> <span class="xml"><span class="tag">&lt;<span class="name">files...</span>&gt;</span></span></span><br><span class="line"><span class="code">               &lt;@listfiles...&gt; &lt;path_to_extract\&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">Commands</span>&gt;</span></span></span><br><span class="line">  a             Add files to archive</span><br><span class="line">  c             Add archive comment</span><br><span class="line">  cf            Add files comment</span><br><span class="line">  ch            Change archive parameters</span><br><span class="line">  cw            Write archive comment to file</span><br><span class="line">  d             Delete files from archive</span><br><span class="line">  e             Extract files to current directory</span><br><span class="line">  f             Freshen files in archive</span><br><span class="line">  i[par]=<span class="xml"><span class="tag">&lt;<span class="name">str</span>&gt;</span></span>  Find string in archives</span><br><span class="line">  k             Lock archive</span><br><span class="line">  l[t,b]        List archive [technical, bare]</span><br><span class="line">  m[f]          Move to archive [files only]</span><br><span class="line">  p             Print file to stdout</span><br><span class="line">  r             Repair archive</span><br><span class="line">  rc            Reconstruct missing volumes</span><br><span class="line">  rn            Rename archived files</span><br><span class="line">  rr[N]         Add data recovery record</span><br><span class="line">  rv[N]         Create recovery volumes</span><br><span class="line">  s[name|-]     Convert archive to or from SFX</span><br><span class="line">  t             Test archive files</span><br><span class="line">  u             Update files in archive</span><br><span class="line">  v[t,b]        Verbosely list archive [technical,bare]</span><br><span class="line">  x             Extract files with full path</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">Switches</span>&gt;</span></span></span><br><span class="line">  -             Stop switches scanning</span><br><span class="line">  ad            Append archive name to destination path</span><br><span class="line">  ag[format]    Generate archive name using the current date</span><br><span class="line">  ap<span class="xml"><span class="tag">&lt;<span class="name">path</span>&gt;</span></span>      Set path inside archive</span><br><span class="line">  as            Synchronize archive contents</span><br><span class="line">  av            Put authenticity verification (registered versions only)</span><br><span class="line">  av-           Disable authenticity verification check</span><br><span class="line">  c-            Disable comments show</span><br><span class="line">  cfg-          Disable read configuration</span><br><span class="line">  cl            Convert names to lower case</span><br><span class="line">  cu            Convert names to upper case</span><br><span class="line">  df            Delete files after archiving</span><br><span class="line">  dh            Open shared files</span><br><span class="line">  ds            Disable name sort for solid archive</span><br><span class="line">  dw            Wipe files after archiving</span><br><span class="line">  e[+]<span class="xml"><span class="tag">&lt;<span class="name">attr</span>&gt;</span></span>    Set file exclude and include attributes</span><br><span class="line">  ed            Do not add empty directories</span><br><span class="line">  en            Do not put 'end of archive' block</span><br><span class="line">  ep            Exclude paths from names</span><br><span class="line">  ep1           Exclude base directory from names</span><br><span class="line">  ep3           Expand paths to full including the drive letter</span><br><span class="line">  f             Freshen files</span><br><span class="line">  hp[password]  Encrypt both file data and headers</span><br><span class="line">  id[c,d,p,q]   Disable messages</span><br><span class="line">  ierr          Send all messages to stderr</span><br><span class="line">  ilog[name]    Log errors to file (registered versions only)</span><br><span class="line">  inul          Disable all messages</span><br><span class="line">  isnd          Enable sound</span><br><span class="line">  k             Lock archive</span><br><span class="line">  kb            Keep broken extracted files</span><br><span class="line">  m<span class="xml"><span class="tag">&lt;<span class="name">0..5</span>&gt;</span></span>       Set compression level (0-store...3-default...5-maximal)</span><br><span class="line">  mc<span class="xml"><span class="tag">&lt;<span class="name">par</span>&gt;</span></span>       Set advanced compression parameters</span><br><span class="line">  md<span class="xml"><span class="tag">&lt;<span class="name">size</span>&gt;</span></span>      Dictionary size in KB (64,128,256,512,1024,2048,4096 or A-G)</span><br><span class="line">  ms[ext;ext]   Specify file types to store</span><br><span class="line">  n<span class="xml"><span class="tag">&lt;<span class="name">file</span>&gt;</span></span>       Include only specified file</span><br><span class="line">  n@            Read file names to include from stdin</span><br><span class="line">  n@<span class="xml"><span class="tag">&lt;<span class="name">list</span>&gt;</span></span>      Include files in specified list file</span><br><span class="line">  o[+|-]        Set the overwrite mode</span><br><span class="line">  ol            Save symbolic links as the link instead of the file</span><br><span class="line">  or            Rename files automatically</span><br><span class="line">  ow            Save or restore file owner and group</span><br><span class="line">  p[password]   Set password</span><br><span class="line">  p-            Do not query password</span><br><span class="line">  r             Recurse subdirectories</span><br><span class="line">  r0            Recurse subdirectories for wildcard names only</span><br><span class="line">  rr[N]         Add data recovery record</span><br><span class="line">  rv[N]         Create recovery volumes</span><br><span class="line">  s[<span class="xml"><span class="tag">&lt;<span class="name">N</span>&gt;</span></span>,v[-],e] Create solid archive</span><br><span class="line">  s-            Disable solid archiving</span><br><span class="line">  sc<span class="xml"><span class="tag">&lt;<span class="name">chr</span>&gt;</span></span>[obj]  Specify the character set</span><br><span class="line">  sfx[name]     Create SFX archive</span><br><span class="line">  si[name]      Read data from standard input (stdin)</span><br><span class="line">  sl<span class="xml"><span class="tag">&lt;<span class="name">size</span>&gt;</span></span>      Process files with size less than specified</span><br><span class="line">  sm<span class="xml"><span class="tag">&lt;<span class="name">size</span>&gt;</span></span>      Process files with size more than specified</span><br><span class="line">  t             Test files after archiving</span><br><span class="line">  ta<span class="xml"><span class="tag">&lt;<span class="name">date</span>&gt;</span></span>      Process files modified after <span class="xml"><span class="tag">&lt;<span class="name">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class="line">  tb<span class="xml"><span class="tag">&lt;<span class="name">date</span>&gt;</span></span>      Process files modified before <span class="xml"><span class="tag">&lt;<span class="name">date</span>&gt;</span></span> in YYYYMMDDHHMMSS format</span><br><span class="line">  tk            Keep original archive time</span><br><span class="line">  tl            Set archive time to latest file</span><br><span class="line">  tn<span class="xml"><span class="tag">&lt;<span class="name">time</span>&gt;</span></span>      Process files newer than <span class="xml"><span class="tag">&lt;<span class="name">time</span>&gt;</span></span></span><br><span class="line">  to<span class="xml"><span class="tag">&lt;<span class="name">time</span>&gt;</span></span>      Process files older than <span class="xml"><span class="tag">&lt;<span class="name">time</span>&gt;</span></span></span><br><span class="line">  ts<span class="xml"><span class="tag">&lt;<span class="name">m,c,a</span>&gt;</span></span>[N]  Save or restore file time (modification, creation, access)</span><br><span class="line">  u             Update files</span><br><span class="line">  v             Create volumes with size autodetection or list all volumes</span><br><span class="line">  v<span class="xml"><span class="tag">&lt;<span class="name">size</span>&gt;</span></span>[k,b]  Create volumes with size=<span class="xml"><span class="tag">&lt;<span class="name">size</span>&gt;</span></span><span class="emphasis">*1000 [*</span>1024, *1]</span><br><span class="line">  ver[n]        File version control</span><br><span class="line">  vn            Use the old style volume naming scheme</span><br><span class="line">  vp            Pause before each volume</span><br><span class="line">  w<span class="xml"><span class="tag">&lt;<span class="name">path</span>&gt;</span></span>       Assign work directory</span><br><span class="line">  x<span class="xml"><span class="tag">&lt;<span class="name">file</span>&gt;</span></span>       Exclude specified file</span><br><span class="line">  x@            Read file names to exclude from stdin</span><br><span class="line">  x@<span class="xml"><span class="tag">&lt;<span class="name">list</span>&gt;</span></span>      Exclude files in specified list file</span><br><span class="line">  y             Assume Yes on all queries</span><br><span class="line">  z[file]       Read archive comment from file</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h5 id=&quot;下载&quot;&gt;&lt;a href=&quot;#下载&quot; class=&quot;headerlink&quot; title=&quot;下载&quot;&gt;&lt;/a&gt;下载&lt;/h5&gt;&lt;p&gt;&lt;code&gt;# wget  http://www.rarlab.com/rar/rarlinux-3.8.0.tar.gz&lt;/code&gt;&lt;/
      
    
    </summary>
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/categories/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/tags/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>phpRedisAdmin搭建</title>
    <link href="https://leeyj.coding.me/2019/04/26/phpRedisAdmin%E6%90%AD%E5%BB%BA/"/>
    <id>https://leeyj.coding.me/2019/04/26/phpRedisAdmin搭建/</id>
    <published>2019-04-26T08:30:09.000Z</published>
    <updated>2019-05-17T13:23:21.439Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在已有的<code>lnmp</code> 环境下搭建 <code>phpRedisAdmin</code> 由于服务器做了限制，隧道端口转发等都不能使用，导致 <code>RedisDesktopManager</code> 管理工具不能使用，只能通过 <code>phpRedisAdmin</code>来进行管理了。</p></blockquote><p>1）下载软件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/ErikDubbelboer/phpRedisAdmin.git</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> phpRedisAdmin</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/nrk/predis.git vendor</span></span><br></pre></td></tr></table></figure></p><p>2）放置到<code>web</code>站点目录<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># cd ..</span></span><br><span class="line"><span class="meta"># mv phpRedisAdmin /opt/</span></span><br><span class="line"><span class="meta"># chown apache.apache phpRedisAdmin/ -R</span></span><br></pre></td></tr></table></figure></p><p>3）编辑<code>nginx</code>配置文件<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim phpRedisAdmin.conf</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  www.redis.com;</span><br><span class="line">    <span class="attribute">autoindex</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">error_log</span>  logs/redis_error.log <span class="literal">error</span>;</span><br><span class="line">    <span class="attribute">access_log</span> logs/redis_access.log main;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> /opt/phpRedisAdmin;</span><br><span class="line">        <span class="attribute">index</span>  index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">fastcgi_intercept_errors</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">error_page</span>  <span class="number">404</span>             /<span class="number">404</span>.html;</span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="attribute">root</span>           html;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span>   <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">        <span class="attribute">fastcgi_index</span>  index.php;</span><br><span class="line">        <span class="attribute">fastcgi_param</span>  SCRIPT_FILENAME  /opt/phpRedisAdmin<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="attribute">include</span>        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /\.</span> &#123;</span><br><span class="line">        <span class="attribute">deny</span> all;</span><br><span class="line">        <span class="attribute">error_page</span>  <span class="number">403</span>             /<span class="number">404</span>.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>4）配置连接管理，默认连接的是<code>6379</code>端口<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /opt/phpRedisAdmin/includes/config.sample.inc.php</span></span><br><span class="line">$config = <span class="keyword">array</span>(</span><br><span class="line">  <span class="string">'servers'</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">    <span class="keyword">array</span>(</span><br><span class="line">      <span class="string">'name'</span>   =&gt; <span class="string">'local server'</span>, <span class="comment">// Optional name.</span></span><br><span class="line">      <span class="string">'host'</span>   =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">      <span class="string">'port'</span>   =&gt; <span class="number">6395</span>,</span><br><span class="line">      <span class="string">'filter'</span> =&gt; <span class="string">'*'</span>,</span><br><span class="line">      <span class="string">'scheme'</span> =&gt; <span class="string">'tcp'</span>, <span class="comment">// Optional. Connection scheme. 'tcp' - for TCP connection, 'unix' - for connection by unix domain socket</span></span><br><span class="line">      <span class="string">'path'</span>   =&gt; <span class="string">''</span>, <span class="comment">// Optional. Path to unix domain socket. Uses only if 'scheme' =&gt; 'unix'. Example: '/var/run/redis/redis.sock'</span></span><br><span class="line">      <span class="string">'auth'</span> =&gt; <span class="string">'jieg6uy5Dach0yooxo1l'</span> <span class="comment">// Warning: The password is sent in plain-text to the Redis server.</span></span><br><span class="line">    ),</span><br></pre></td></tr></table></figure></p><p>5）<code>windows</code>添加<code>host</code>然后访问 <code>http://www.redis.com</code><br><img src="https://upload-images.jianshu.io/upload_images/11763553-53b72098e4fac4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;在已有的&lt;code&gt;lnmp&lt;/code&gt; 环境下搭建 &lt;code&gt;phpRedisAdmin&lt;/code&gt; 由于服务器做了限制，隧道端口转发等都不能使用，导致 &lt;code&gt;RedisDesktopManager&lt;/code&gt; 管理工具不能使用，只
      
    
    </summary>
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/categories/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/tags/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>phpMyAdmin搭建</title>
    <link href="https://leeyj.coding.me/2019/04/26/phpMyAdmin%E6%90%AD%E5%BB%BA/"/>
    <id>https://leeyj.coding.me/2019/04/26/phpMyAdmin搭建/</id>
    <published>2019-04-26T07:30:09.000Z</published>
    <updated>2019-05-17T13:23:21.439Z</updated>
    
    <content type="html"><![CDATA[<h5 id="在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。"><a href="#在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。" class="headerlink" title="在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。"></a>在已有的 lnmp 环境下搭建 phpMyAdmin。 由于服务器做了限制，隧道端口转发等都不能使用，导致 Navicat 管理工具不能使用，只能通过 phpMyAdmin 来进行管理了。</h5><ul><li><p>下载phpMyAdmin<br>官网地址：<a href="https://www.phpmyadmin.net/" target="_blank" rel="noopener">https://www.phpmyadmin.net/</a></p></li><li><p>上传到服务器进行安装</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># unzip phpMyAdmin-4.8.5-all-languages.zip</span><br><span class="line"># mv phpMyAdmin-4.8.5-all-languages /opt/phpMyAdmin</span><br><span class="line"># chown apache. /opt/phpMyAdmin</span><br></pre></td></tr></table></figure></li><li><p>编辑配置文件 config.default.php</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># vim /opt/phpMyAdmin/libraries/config.default.php</span></span><br><span class="line">$cfg[<span class="string">'Servers'</span>][<span class="symbol">$i</span>][<span class="string">'host'</span>] = '130.39.113.45';</span><br><span class="line">$cfg[<span class="string">'Servers'</span>][<span class="symbol">$i</span>][<span class="string">'port'</span>] = '3306';</span><br><span class="line">$cfg[<span class="string">'Servers'</span>][<span class="symbol">$i</span>][<span class="string">'socket'</span>] = 'socket';</span><br><span class="line">$cfg[<span class="string">'Servers'</span>][<span class="symbol">$i</span>][<span class="string">'user'</span>] = 'tj_court';</span><br><span class="line">$cfg[<span class="string">'Servers'</span>][<span class="symbol">$i</span>][<span class="string">'password'</span>] = 'AigheiguSh4eesh0eey8';</span><br></pre></td></tr></table></figure></li><li><p>配置nginx站点</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># vim phpMyAdmin.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  www.phpadmin.com;</span><br><span class="line">    autoindex off;</span><br><span class="line"></span><br><span class="line">    error_log  logs/phpadmin_error.log error;</span><br><span class="line">    access_log logs/phpadmin_access.log main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">    root /opt/phpMyAdmin;</span><br><span class="line">        index  index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fastcgi_intercept_errors on;</span><br><span class="line">    error_page  404             /404.html;</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root           html;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  /opt/phpMyAdmin$fastcgi_script_name;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ /\. &#123;</span><br><span class="line">        deny all;</span><br><span class="line">        error_page  403             /404.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置完成后启动nginx访问配置的域名进行连接<br><img src="/2019/04/26/phpMyAdmin搭建/4.png" alt><br><img src="/2019/04/26/phpMyAdmin搭建/6.png" alt></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h5 id=&quot;在已有的-lnmp-环境下搭建-phpMyAdmin。-由于服务器做了限制，隧道端口转发等都不能使用，导致-Navicat-管理工具不能使用，只能通过-phpMyAdmin-来进行管理了。&quot;&gt;&lt;a href=&quot;#在已有的-lnmp-环境下搭建-phpMyAdmin
      
    
    </summary>
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/categories/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/tags/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>MySQL自动备份脚本</title>
    <link href="https://leeyj.coding.me/2019/04/24/MySQL%E8%87%AA%E5%8A%A8%E5%A4%87%E4%BB%BD%E8%84%9A%E6%9C%AC/"/>
    <id>https://leeyj.coding.me/2019/04/24/MySQL自动备份脚本/</id>
    <published>2019-04-24T09:56:56.000Z</published>
    <updated>2019-05-17T13:23:21.438Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>通过 shell 脚本定时备份数据库，并定时清理</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#Desc:本地数据库备份脚本</span><br><span class="line">#Date:2017-12-24</span><br><span class="line">#by:Lee-YJ</span><br><span class="line">#运行脚本前先创建一个备份用户，并授予权限</span><br><span class="line">#mysql&gt; grant select,insert,lock tables,show view,trigger  on *.* to back@"127.0.0.1" identified by "oodaeh7phoe1iboh7Jua";</span><br><span class="line">#mysql&gt; flush privileges;</span><br><span class="line"></span><br><span class="line">mysqluser=back                    #用于数据库备份的用户名</span><br><span class="line">mysqlpassw=oodaeh7phoe1iboh7Jua   #用户密码</span><br><span class="line">mysqlhost=127.0.0.1               #连接数据库的host</span><br><span class="line">bakpath=/opt/data/Back/DBbak          #备份数据库存放的路径</span><br><span class="line"></span><br><span class="line">bakdate=`date '+%Y%m%d'`</span><br><span class="line">baktime=`date '+%H%M'`</span><br><span class="line"></span><br><span class="line">#----------------------------获取mysql中的数据库名---------------------------------</span><br><span class="line">/usr/bin/mysql -u$mysqluser -h $mysqlhost -p$mysqlpassw -e "show databases;"|grep -v Database|grep -v information_schema |grep -v performance_schema|grep -v mysql|grep -v test &gt; /tmp/DBname</span><br><span class="line"></span><br><span class="line">#----------------------------数据库备份--mysqldump备份------------------------------</span><br><span class="line"></span><br><span class="line">if [ ! -d "$bakpath" ];then</span><br><span class="line">    mkdir -p $bakpath</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">cd $bakpath</span><br><span class="line"></span><br><span class="line">if [ ! -d "$bakdate" ];then</span><br><span class="line">    mkdir $bakdate</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">cd $bakdate</span><br><span class="line"></span><br><span class="line">echo "------------------------$bakdate$baktime-------------------------------------" &gt;&gt; $bakpath/DBbak.log</span><br><span class="line">for DBname in `cat /tmp/DBname`;do</span><br><span class="line">    if [ ! -d "$DBname" ];then</span><br><span class="line">        mkdir $DBname</span><br><span class="line">    fi</span><br><span class="line">    /usr/bin/mysqldump --routines --triggers -u$mysqluser -h $mysqlhost -p$mysqlpassw $DBname  &gt; $DBname/$baktime\.sql</span><br><span class="line">    if [ $? = 0 ];then</span><br><span class="line">        echo "$DBname Back OK!" &gt;&gt; $bakpath/DBbak.log</span><br><span class="line">    else</span><br><span class="line">        echo "$DBname Back ERROR!" &gt;&gt; $bakpath/DBbak.log</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">echo "" &gt;&gt; $bakpath/DBbak.log </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#----------------------------删除5天之前的数据备份，并随机保留一份--------------------------------</span><br><span class="line">shopt -s extglob</span><br><span class="line">olddate=`date '+%Y%m%d' -d "-6 days"`</span><br><span class="line">cd $bakpath/$olddate</span><br><span class="line">for deldbname in `ls $bakpath/$olddate`;do</span><br><span class="line">    cd $deldbname</span><br><span class="line">    file=`ls| sort -R | head -n1`</span><br><span class="line">    rm -f !($file)</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [ ! -d "$bakpath/Oldest" ];then</span><br><span class="line">    mkdir -p $bakpath/Oldest</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">mv $bakpath/$olddate $bakpath/Oldest/</span><br><span class="line"></span><br><span class="line">rm -f /tmp/DBname</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;通过 shell 脚本定时备份数据库，并定时清理&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;li
      
    
    </summary>
    
      <category term="Shell" scheme="https://leeyj.coding.me/categories/Shell/"/>
    
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/tags/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>ftp虚拟用户</title>
    <link href="https://leeyj.coding.me/2019/04/23/ftp%E8%99%9A%E6%8B%9F%E7%94%A8%E6%88%B7/"/>
    <id>https://leeyj.coding.me/2019/04/23/ftp虚拟用户/</id>
    <published>2019-04-23T14:30:00.000Z</published>
    <updated>2019-04-23T14:37:22.762Z</updated>
    
    <content type="html"><![CDATA[<h3 id="需求："><a href="#需求：" class="headerlink" title="需求："></a>需求：</h3><p>进（账户）\<br>username: ftpComeSsbq\<br>password: ftp<em>come</em>#@UkieO9\<br>上传文件的目录：/opt/ftp/come</p><p>出（账户）\<br>username: ftpOutSsbq\<br>password: ftp<em>out</em>#@45oUkie\<br>上床文件的目录：/opt/ftp/out</p><h3 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h3><p>1 安装软件<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># yum -y install vsftpd</span></span><br></pre></td></tr></table></figure></p><p>2 创建相应的ftp数据目录<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">mkdir</span> -p /opt/ftp/&#123;come,<span class="keyword">out</span>&#125;</span><br></pre></td></tr></table></figure></p><p>3 创建一个用户提供给虚拟用户使用<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># useradd -s /sbin/nologin virtual</span></span><br></pre></td></tr></table></figure></p><p>4 将ftp数据目录设置成virtual用户<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chown virtual. /opt/ftp/ -R</span></span><br><span class="line"><span class="comment"># ll /opt/ftp/</span></span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>virtual virtual<span class="number"> 4096 </span>Apr<span class="number"> 17 </span>12:07 come</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>virtual virtual<span class="number"> 4096 </span>Apr<span class="number"> 17 </span>12:07 out</span><br></pre></td></tr></table></figure></p><p>5 创建虚拟帐号与密码的文本文件(一行账号，一行密码, 注意不要有多余的空格)<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/vsftpd/logins.txt</span></span><br><span class="line">ftpComeSsbq</span><br><span class="line">ftp_come<span class="number">_</span><span class="comment">#<span class="doctag">@UkieO</span>9</span></span><br><span class="line">ftpOutSsbq</span><br><span class="line">ftp_out<span class="number">_</span><span class="comment">#@45oUkie</span></span><br></pre></td></tr></table></figure></p><p>6 将创建好的密码文件txt格式转换db格式<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># db_load -T -t hash -f <span class="regexp">/etc/</span>vsftpd<span class="regexp">/logins.txt /</span>etc<span class="regexp">/vsftpd/</span>login.db</span><br></pre></td></tr></table></figure></p><p>7 定义db文件的权限<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># chmod 600 /etc/vsftpd/login.db</span></span><br></pre></td></tr></table></figure></p><p>8 定义pam认证文件<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/pam.d/ftp</span></span><br><span class="line">auth  required  <span class="regexp">/lib64/</span>security<span class="regexp">/pam_userdb.so  db=/</span>etc<span class="regexp">/vsftpd/</span>login</span><br><span class="line">account  required  <span class="regexp">/lib64/</span>security<span class="regexp">/pam_userdb.so  db=/</span>etc<span class="regexp">/vsftpd/</span>login</span><br></pre></td></tr></table></figure></p><p>9 配置vsftpd主配置文件<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cp /etc/vsftpd/vsftpd.conf&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># vim /etc/vsftpd/vsftpd.conf</span></span><br><span class="line"><span class="comment">#禁止匿名登录FTP服务器</span></span><br><span class="line"><span class="attr">anonymous_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="comment">#允许本地用户登录FTP服务器</span></span><br><span class="line"><span class="attr">local_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="comment">#可以上传(全局控制) </span></span><br><span class="line"><span class="attr">write_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="comment">#匿名用户可以上传</span></span><br><span class="line"><span class="attr">anon_upload_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="comment">#匿名用户可以建目录</span></span><br><span class="line"><span class="attr">anon_mkdir_write_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="comment">#匿名用户修改删除</span></span><br><span class="line"><span class="attr">anon_other_write_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="comment">#全部用户被限制在主目录</span></span><br><span class="line"><span class="attr">chroot_local_user</span>=<span class="literal">YES</span></span><br><span class="line"><span class="comment">#将所有用户看成虚拟用户guest</span></span><br><span class="line"><span class="attr">guest_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="comment">#指定虚拟用户，也就是将guest用户映射到virtual用户</span></span><br><span class="line"><span class="attr">guest_username</span>=virtual</span><br><span class="line"><span class="comment">#指定为独立服务</span></span><br><span class="line"><span class="attr">listen</span>=<span class="literal">YES</span></span><br><span class="line"><span class="comment">#指定监听的端口</span></span><br><span class="line"><span class="attr">listen_port</span>=<span class="number">21</span></span><br><span class="line"><span class="comment">#开启被动模式</span></span><br><span class="line"><span class="attr">pasv_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="comment">#FTP服务器公网IP</span></span><br><span class="line"><span class="attr">pasv_address</span>=<span class="number">120.79</span>.<span class="number">93.66</span></span><br><span class="line"><span class="comment">#设置被动模式下，建立数据传输可使用port范围的最小值</span></span><br><span class="line"><span class="attr">pasv_min_port</span>=<span class="number">10000</span></span><br><span class="line"><span class="comment">#设置被动模式下，建立数据传输可使用port范围的最大值</span></span><br><span class="line"><span class="attr">pasv_max_port</span>=<span class="number">10088</span></span><br><span class="line"><span class="comment">#是否允许匿名用户下载全局可读的文件</span></span><br><span class="line"><span class="attr">anon_world_readable_only</span>=<span class="literal">NO</span></span><br><span class="line"><span class="comment">#指定虚拟用户配置文件的路径</span></span><br><span class="line"><span class="attr">user_config_dir</span>=/etc/vsftpd/user_conf</span><br></pre></td></tr></table></figure></p><p>10 创建上面配置文件中指定的子配置文件目录 user_conf<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># mkdir /etc/vsftpd/user_conf</span></span><br></pre></td></tr></table></figure></p><p>11 定义 ftpComeSsbq 用户的配置文件<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/vsftpd/user_conf/ftpComeSsbq</span></span><br><span class="line"><span class="attr">write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">anon_world_readable_only</span>=<span class="literal">no</span></span><br><span class="line"><span class="attr">anon_upload_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">anon_mkdir_write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">anon_other_write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">local_root</span>=/opt/ftp/come</span><br></pre></td></tr></table></figure></p><p>12 定义 ftpOutSsbq 用户的配置文件<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/vsftpd/user_conf/ftpOutSsbq</span></span><br><span class="line"><span class="attr">write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">anon_world_readable_only</span>=<span class="literal">no</span></span><br><span class="line"><span class="attr">anon_upload_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">anon_mkdir_write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">anon_other_write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">local_root</span>=/opt/ftp/out</span><br></pre></td></tr></table></figure></p><p>13 启动vsftpd<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># service vsftpd start</span></span><br></pre></td></tr></table></figure></p><p>14 测试<br>…</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;需求：&quot;&gt;&lt;a href=&quot;#需求：&quot; class=&quot;headerlink&quot; title=&quot;需求：&quot;&gt;&lt;/a&gt;需求：&lt;/h3&gt;&lt;p&gt;进（账户）\&lt;br&gt;username: ftpComeSsbq\&lt;br&gt;password: ftp&lt;em&gt;come&lt;/em&gt;#@Uk
      
    
    </summary>
    
      <category term="Linux" scheme="https://leeyj.coding.me/categories/Linux/"/>
    
    
      <category term="Linux运维日常" scheme="https://leeyj.coding.me/tags/Linux%E8%BF%90%E7%BB%B4%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
</feed>
